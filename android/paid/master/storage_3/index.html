<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=description content="An Android Developer."><link href=https://blog.yorek.xyz/about-me/android/paid/master/storage_3/ rel=canonical><meta name=author content="Yorek Liu"><meta name=lang:clipboard.copy content=复制><meta name=lang:clipboard.copied content=已复制><meta name=lang:search.language content=ja><meta name=lang:search.pipeline.stopwords content=True><meta name=lang:search.pipeline.trimmer content=True><meta name=lang:search.result.none content=没有找到符合条件的结果><meta name=lang:search.result.one content="找到 1 个符合条件的结果"><meta name=lang:search.result.other content="# 个符合条件的结果"><meta name=lang:search.tokenizer content=[\uff0c\u3002]+><link rel="shortcut icon" href=../../../../assets/images/favicon.ico><meta name=generator content="mkdocs-1.0.4, mkdocs-material-4.6.0"><title>14 | 存储优化（下）：数据库SQLite的使用和优化</title><link rel=stylesheet href=../../../../assets/stylesheets/application.1b62728e.css><link rel=stylesheet href=../../../../assets/stylesheets/application-palette.a8b3c06d.css><meta name=theme-color content=#2196f3><script src=../../../../assets/javascripts/modernizr.268332fc.js></script><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style><link rel=stylesheet href=../../../../assets/fonts/material-icons.css><script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-155096376-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=blue> <svg class=md-svg> <defs> </defs> </svg> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay data-md-component=overlay for=__drawer></label> <a href=#sqlite tabindex=1 class=md-skip> 跳转至 </a> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid"> <div class=md-flex> <div class="md-flex__cell md-flex__cell--shrink"> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo"> <i class=md-icon>code</i> </a> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--menu md-header-nav__button" for=__drawer></label> </div> <div class="md-flex__cell md-flex__cell--stretch"> <div class="md-flex__ellipsis md-header-nav__title" data-md-component=title> <span class=md-header-nav__topic> Yorek's </span> <span class=md-header-nav__topic> 14 | 存储优化（下）：数据库SQLite的使用和优化 </span> </div> </div> <div class="md-flex__cell md-flex__cell--shrink"> <label class="md-icon md-icon--search md-header-nav__button" for=__search></label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=query data-md-state=active> <label class="md-icon md-search__icon" for=__search></label> <button type=reset class="md-icon md-search__icon" data-md-component=reset tabindex=-1> &#xE5CD; </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=result> <div class=md-search-result__meta> 键入以开始搜索 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container> <nav class="md-tabs md-tabs--active" data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../../3rd-library/3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main role=main> <div class="md-main__inner md-grid" data-md-component=container> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" data-md-level=0> <label class="md-nav__title md-nav__title--site" for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo"> <i class=md-icon>code</i> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../.. title=Home class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2 type=checkbox id=nav-2 checked> <label class=md-nav__link for=nav-2> Android </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-2> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-1 type=checkbox id=nav-2-1> <label class=md-nav__link for=nav-2-1> 三方库源码解析 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-1> 三方库源码解析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../3rd-library/3rd-library-source-code/ title=Android三方库源码分析 class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/okhttp/ title=OkHttp3源码解析 class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/retrofit/ title=Retrofit2源码解析 class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/rxjava&rxandroid/ title="RxJava2 & RxAndroid源码解析" class=md-nav__link> RxJava2 & RxAndroid源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide1/ title="Glide v4 源码解析（一）" class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide2/ title="Glide v4 源码解析（二）" class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide3/ title="Glide v4 源码解析（三）" class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide4/ title="Glide v4 源码解析（四）" class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide5/ title="Glide v4 源码解析（五）" class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide6/ title="Glide v4 源码解析（六）" class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide7/ title="Glide v4 源码解析（七）" class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/eventbus/ title=EventBus源码解析 class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/leakcanary/ title=LeakCanary2源码解析 class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/permissiondispatcher/ title=PermissionDispatcher源码解析 class=md-nav__link> PermissionDispatcher源码解析 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-2 type=checkbox id=nav-2-2> <label class=md-nav__link for=nav-2-2> Framework系列 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-2> Framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../framework/Android四大组件(1)/ title=Activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(2)/ title=Service class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(3)/ title=Broadcasts class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../../framework/Android四大组件(4)/ title="Content Providers与Fragment" class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../../framework/IPC机制/ title=IPC机制 class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/View的事件体系/ title=View的事件体系 class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../../framework/View的绘制原理/ title=View的绘制原理 class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../../framework/RemoteViews/ title=RemoteViews class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../../framework/Drawable/ title=Android中的Drawable资源 class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android动画/ title=Android动画 class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../../framework/Window与WindowManager/ title=Window与WindowManager class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../../framework/四大组件启动过程/ title=四大组件启动过程 class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android消息机制/ title=Android消息机制 class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android线程与线程池/ title=Android线程与线程池 class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../../framework/Bitmap的缓存与加载/ title=Bitmap的缓存与加载 class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../../framework/JNI与NDK/ title=JNI与NDK编程简介 class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../../framework/性能优化/ title=Android性能优化 class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder1-mediaservice/ title=Binder深入理解——以MediaService为例 class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder2/ title=Binder深入理解——罗老师系列 class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3 type=checkbox id=nav-2-3 checked> <label class=md-nav__link for=nav-2-3> 付费知识归档 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-3> 付费知识归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-1 type=checkbox id=nav-2-3-1> <label class=md-nav__link for=nav-2-3-1> 某圈问题索引 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-1> 某圈问题索引 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zsxq/zsxq_index/ title=某圈问题索引 class=md-nav__link> 某圈问题索引 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week1-synchronized/ title=理解Java中synchronized关键词 class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week2-service/ title=理解Service class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../zsxq/week3-activity/ title=理解Activity的启动模式 class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week4-startActivityForResult/ title=关于startActivityForResult class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../zsxq/week5-view/ title=关于View的知识 class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week6-gradle/ title=关于Gradle的知识 class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week7-serialization/ title=关于序列化的知识 class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week10-classloader/ title=Android中的ClassLoader class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../zsxq/week11-binder/ title=Binder简介 class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week12-retrofit-okhttp/ title=OkHttp和Retrofit的作用以及两者之间的联系 class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week14-jvm-gc/ title=JVM中垃圾回收策略 class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week16-keep-app-alive/ title=进程保活 class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week17-android-components/ title=四大组件的作用以及多进程 class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week20-network-protocol/ title=网络协议 class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week21-mvc&amp;mvp&mvvm/ title=MVC、MVP和MVVM class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../zsxq/week22-android-studio-build/ title="Android Studio build过程" class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week23-load-large-bitmap/ title=大尺寸图片加载问题 class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-3-2 type=checkbox id=nav-2-3-2 checked> <label class=md-nav__link for=nav-2-3-2> Android开发高手课 </label> <nav class=md-nav data-md-component=collapsible data-md-level=3> <label class=md-nav__title for=nav-2-3-2> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ title=Android开发高手课 class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../crash_1/ title="01 | 崩溃优化（上）：关于“崩溃”那些事儿" class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../crash_2/ title="02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？" class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../memory_1/ title="03 | 内存优化（上）：4GB内存时代，再谈内存优化" class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../memory_2/ title="04 | 内存优化（下）：内存优化这件事，应该从哪里着手？" class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../stuck_1/ title="05 | 卡顿优化（上）：你要掌握的卡顿分析方法" class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../stuck_2/ title="06 | 卡顿优化（下）：如何监控应用卡顿？" class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../stuck_3/ title="06补充篇 | 卡顿优化：卡顿现场与卡顿分析" class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../start_1/ title="07 | 启动优化（上）：从启动过程看启动速度优化" class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../start_2/ title="08 | 启动优化（下）：优化启动速度的进阶方法" class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../io_1/ title="09 | I/O优化（上）：开发工程师必备的I/O优化知识" class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../io_2/ title="10 | I/O优化（中）：不同I/O方式的使用场景是什么？" class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../io_3/ title="11 | I/O优化（下）：如何监控线上I/O操作？" class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../storage_1/ title="12 | 存储优化（上）：常见的数据存储方法有哪些？" class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-toggle md-nav__toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 14 | 存储优化（下）：数据库SQLite的使用和优化 </label> <a href=./ title="14 | 存储优化（下）：数据库SQLite的使用和优化" class="md-nav__link md-nav__link--active"> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#sqlite class=md-nav__link> SQLite 的那些事儿 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-orm class=md-nav__link> 1. ORM </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 进程与线程并发 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 多进程并发 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 多线程并发 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3. 查询优化 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 索引优化 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 页大小与缓存大小 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 其他优化 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sqlite_1 class=md-nav__link> SQLite 的其他特性 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 损坏与恢复 </a> </li> <li class=md-nav__item> <a href=#2_1 class=md-nav__link> 2. 加密与安全 </a> </li> <li class=md-nav__item> <a href=#3_1 class=md-nav__link> 3. 全文搜索 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sqlite_2 class=md-nav__link> SQLite 的监控 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1_1 class=md-nav__link> 1. 本地测试 </a> </li> <li class=md-nav__item> <a href=#2_2 class=md-nav__link> 2. 耗时监控 </a> </li> <li class=md-nav__item> <a href=#3_2 class=md-nav__link> 3. 智能监控 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 课后作业 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../network_2/ title="16 | 网络优化（中）：复杂多变的移动网络该如何优化？" class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../network_3/ title="17 | 网络优化（下）：大数据下网络该如何监控？" class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../battery_1/ title="18 | 耗电优化（上）：从电量优化的演进看耗电分析" class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../battery_2/ title="19 | 耗电优化（下）：耗电的优化方法与线上监控" class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../ui_1/ title="20 | UI 优化（上）：UI 渲染的几个关键概念" class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../ui_2/ title="21 | UI 优化（下）：如何优化 UI 渲染？" class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../package_1/ title="22 | 包体积优化（上）：如何减少安装包大小？" class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../package_2/ title="23 | 包体积优化（下）：资源优化的进阶实践" class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../compile/ title="26 | 关于编译，你需要了解什么？" class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../bytecode/ title="27 | 编译插桩的三种方法：AspectJ、ASM、ReDex" class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-2-4 type=checkbox id=nav-2-4> <label class=md-nav__link for=nav-2-4> 日常记录 </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-2-4> 日常记录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../other/android_alias/ title=Android马甲包的那些事儿 class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../../other/Android-Development-Tool/ title=Android神兵利器 class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../../other/android-jenkins/ title="Jenkins for android" class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../../other/FileProvider/ title=FileProvider class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../../other/Android判断导航栏高度/ title=Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../../other/Android图片选择器/ title=Android图片选择器 class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../../other/Android底部导航栏框架/ title=Android原生底部导航栏 class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../../other/Android搜索栏的实现/ title=Android搜索栏的实现 class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../../other/Android暂停音乐播放器的播放/ title=Android暂停酷狗、网易云音乐等音乐播放器的播放 class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../../other/Android滑动返回实践/ title=Android滑动返回实践 class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../../other/Android程序反编译/ title=MacOS下Android程序反编译 class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../../other/Android通讯录快速读取/ title=Android通讯录快速读取 class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../../other/annotation/ title=注解的定义及解析 class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../../other/best_throttle_in_mvvm/ title=这可能是MVVM中最优雅的按键防抖方案 class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../../other/constraintlayout/ title=ConstraintLayout使用大全 class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../../other/dagger2/ title=初学者的Dagger2教程 class=md-nav__link> 初学者的Dagger2教程 </a> </li> <li class=md-nav__item> <a href=../../../other/FAB-Behavior/ title=FloatingActionButton上滑隐藏下滑显示 class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../../other/nestedscrolling/ title=NestedScrolling机制 class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../../other/porterduff/ title=使用Porter-Duff合成数字图像 class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-cache/ title=ListView、RecyclerView缓存策略解析 class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-item-docoration/ title=RecyclerView高级特性——ItemDecoration class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-others/ title=RecyclerView的一些使用细节 class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../../other/RecyclerView-Sort&Delete/ title=RecyclerView高级特性——拖拽排序以及滑动删除 class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../../other/runtime/ title="Android Runtime" class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../../other/RxJava/ title=RxJava操作符大全 class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../../other/soft-keyboard-in-app/ title=App内自定义软键盘 class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../../other/SystemProrities/ title=普通Android程序使用SystemProrities class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../../other/腾讯X5内核入坑指南/ title="腾讯TBS X5浏览器内核入坑指南" class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../../other/琐碎知识点/ title=琐碎知识点 class=md-nav__link> 琐碎知识点 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> Flutter </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-3> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_1/ title=年轻人的第一个Flutter程序(1) class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_2/ title=年轻人的第一个Flutter程序(2) class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_3/ title=年轻人的第一个Flutter程序(3) class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_4/ title=年轻人的第一个Flutter程序(4) class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> LeetCode </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-4> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../leetcode/ title=算法目录 class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_1/ title=数据结构、算法和数据操作 class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_3/ title=高质量的代码 class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_4/ title=解决问题的思路 class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_5/ title=优化时间和空间效率 class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_6/ title=面试中的各项能力 class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/array/ title=Array class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode1-10/ title=LeetCode(1-10) class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode11-20/ title=LeetCode(11-20) class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode21-30/ title=LeetCode(21-30) class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode31-40/ title=LeetCode(31-40) class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode41-50/ title=LeetCode(41-50) class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode51-60/ title=LeetCode(51-60) class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode61-70/ title=LeetCode(61-70) class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode71-80/ title=LeetCode(71-80) class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode81-90/ title=LeetCode(81-90) class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode91-100/ title=LeetCode(91-100) class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode101-110/ title=LeetCode(101-110) class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode111-120/ title=LeetCode(111-120) class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Books </label> <nav class=md-nav data-md-component=collapsible data-md-level=1> <label class=md-nav__title for=nav-5> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-1 type=checkbox id=nav-5-1> <label class=md-nav__link for=nav-5-1> Design Pattern </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-1> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../design-pattern/design-pattern/ title=设计模式概述 class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/design-principle/ title=面向对象的六大原则 class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/singleton/ title=单例模式(Singleton) class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/builder/ title=建造者模式(Builder) class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/prototype/ title=原型模式(Prototype) class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/factory-method/ title="工厂方法模式(Factory method)" class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/abstract-factory/ title="抽象工厂模式(Abstract factory)" class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/proxy/ title=代理模式(Proxy) class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/composite/ title=组合模式(Composite) class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/adapter/ title=适配器模式(Adapter) class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/decorator/ title=装饰模式(Decorator) class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/flyweight/ title=享元模式(Flyweight) class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/facade/ title=外观模式(Facade) class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/bridge/ title=桥接模式(Bridge) class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/strategy/ title=策略模式(Strategy) class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/state/ title=状态模式(State) class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/chain-of-responsibility/ title="责任链模式(Chain of responsibility)" class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/interpreter/ title=解释器模式(Interpreter) class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/command/ title=命令模式(Command) class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/observer/ title=观察者模式(Observer) class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/memento/ title=备忘录模式(Memento) class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/iterator/ title=迭代器模式(Iterator) class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/template-method/ title="模版方法模式(Template method)" class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/visitor/ title=访问者模式(Visitor) class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/mediator/ title=中介者模式(Mediator) class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/confusing-design-pattern/ title=易混淆的设计模式 class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-2 type=checkbox id=nav-5-2> <label class=md-nav__link for=nav-5-2> Effective Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-2> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../effective-java/effective-java/ title="Effective Java概述" class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter1/ title=创建和销毁对象 class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter2/ title=对于所有对象都通用的方法 class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter3/ title=类和接口 class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-3 type=checkbox id=nav-5-3> <label class=md-nav__link for=nav-5-3> JVM </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-3> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../jvm/jvm-content/ title=深入理解Java虚拟机 class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-memory-area-oom/ title=Java内存区域与内存溢出异常 class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-gc/ title=垃圾收集器与内存分配策略 class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-4 type=checkbox id=nav-5-4> <label class=md-nav__link for=nav-5-4> Java </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-4> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../java/generics-java-kotlin/ title=Java&Kotlin在泛型方面的区别 class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-collections/ title=Java集合总结 class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-foundation/ title=Java常见概念 class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-toggle md-nav__toggle" data-md-toggle=nav-5-5 type=checkbox id=nav-5-5> <label class=md-nav__link for=nav-5-5> Refactoring </label> <nav class=md-nav data-md-component=collapsible data-md-level=2> <label class=md-nav__title for=nav-5-5> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../refactoring/refactoring/ title=重构：改善既有代码的设计 class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary"> <label class=md-nav__title for=__toc>目录</label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#sqlite class=md-nav__link> SQLite 的那些事儿 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-orm class=md-nav__link> 1. ORM </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 进程与线程并发 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 多进程并发 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 多线程并发 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3 class=md-nav__link> 3. 查询优化 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 索引优化 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 页大小与缓存大小 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 其他优化 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sqlite_1 class=md-nav__link> SQLite 的其他特性 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 损坏与恢复 </a> </li> <li class=md-nav__item> <a href=#2_1 class=md-nav__link> 2. 加密与安全 </a> </li> <li class=md-nav__item> <a href=#3_1 class=md-nav__link> 3. 全文搜索 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sqlite_2 class=md-nav__link> SQLite 的监控 </a> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1_1 class=md-nav__link> 1. 本地测试 </a> </li> <li class=md-nav__item> <a href=#2_2 class=md-nav__link> 2. 耗时监控 </a> </li> <li class=md-nav__item> <a href=#3_2 class=md-nav__link> 3. 智能监控 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 课后作业 </a> </li> <li class=md-nav__item> <a href=#__comments class="md-nav__link md-nav__link--active"> 评论 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>14 | 存储优化（下）：数据库SQLite的使用和优化</h1> <p>我们先来复习一下前面讲到的存储方法的使用场景：少量的 Key Value 数据可以直接使用 SharedPreferences，稍微复杂一些的数据类型也可以通过序列化成 JSON 或者 Protocol Buffers 保存，并且在开发中获取或者修改数据也很简单。</p> <p>不过这几种方法可以覆盖所有的存储场景吗？数据量在几百上千条这个量级时它们的性能还可以接受，但如果是几万条的微信聊天记录呢？而且如何实现快速地对某几个联系人的数据做增删改查呢？</p> <p>对于大数据的存储场景，我们需要考虑稳定性、性能和 <strong>可扩展性</strong>，这个时候就要轮到今天的“主角”数据库登场了。讲存储优化一定绕不开数据库，而数据库这个主题又非常大，我也知道不少同学学数据库的过程是从入门到放弃。那么考虑到我们大多是从事移动开发的工作，今天我就来讲讲移动端数据库 SQLite 的使用和优化。</p> <h2 id=sqlite>SQLite 的那些事儿<a class=headerlink href=#sqlite title="Permanent link">&para;</a></h2> <p>虽然市面上有很多的数据库，但受限于库体积和存储空间，适合移动端使用的还真不多。当然使用最广泛的还是我们今天的主角 SQLite，但同样还是有一些其他不错的选择，例如创业团队的<a href=https://github.com/realm/realm-java>Realm</a>、Google 的<a href=https://github.com/google/leveldb>LevelDB</a>等。</p> <p>在国内那么多的移动团队中，微信对 SQLite 的研究可以算是最深入的。这其实是业务诉求导向的，用户聊天记录只会在本地保存，一旦出现数据损坏或者丢失，对用户来说都是不可挽回的。另一方面，微信有很大一批的重度用户，他们有几千个联系人、几千个群聊天，曾经做过一个统计，有几百万用户的数据库竟然大于 1GB。对于这批用户，如何保证他们可以正常地使用微信是一个非常大的挑战。</p> <p>所以当时微信专门开展了一个重度用户优化的专项。一开始的时候我们集中在 SQLite 使用上的优化，例如表结构、索引等。但很快就发现由于系统版本的不同，SQLite 的实现也有所差异，经常会出现一些兼容性问题，并且也考虑到加密的诉求，我们决定单独引入自己的 SQLite 版本。</p> <p>“源码在手，天下我有”，从此开启了一条研究数据库的“不归路”。那时我们投入了几个人专门去深入研究 SQLite 的源码，从 SQLite 的 PRAGMA 编译选项、<a href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649286603&idx=1&sn=d243dd27f2c6614631241cd00570e853&chksm=8334c349b4434a5fd81809d656bfad6072f075d098cb5663a85823e94fc2363edd28758ab882&mpshare=1&scene=1&srcid=0609GLAeaGGmI4zCHTc2U9ZX#rd">Cursor 实现优化</a>，到 SQLite 源码的优化，最后打造出从实验室到线上的整个监控体系。</p> <p>在 2017 年，我们开源了内部使用的 SQLite 数据库<a href=https://github.com/Tencent/wcdb/wiki>WCDB</a>。这里多说两句，看一个开源项目是否靠谱，就看这个项目对产品本身有多重要。微信开源坚持内部与外部使用同一个版本，虽然我现在已经离开了微信团队，但还是欢迎有需要的同学使用 WCDB。</p> <p>在开始学习前我要提醒你，SQLite 的优化同样也很难通过一两篇文章就把每个细节都讲清楚。今天的内容我选择了一些比较重要的知识点，并且为你准备了大量的参考资料，遇到陌生或者不懂的地方需要结合参考资料反复学习。</p> <h3 id=1-orm>1. ORM<a class=headerlink href=#1-orm title="Permanent link">&para;</a></h3> <p>坦白说可能很多 BAT 的高级开发工程师都不完全了解 SQLite 的内部机制，也不能正确地写出高效的 SQL 语句。大部分应用为了提高开发效率，会引入 ORM 框架。ORM（Object Relational Mapping）也就是对象关系映射，用面向对象的概念把数据库中表和对象关联起来，可以让我们不用关心数据库底层的实现。</p> <p>Android 中最常用的 ORM 框架有开源<a href=https://github.com/greenrobot/greenDAO>greenDAO</a>和 Google 官方的<a href=https://developer.android.com/training/data-storage/room/ >Room</a>，那使用 ORM 框架会带来什么问题呢？</p> <p>使用 ORM 框架真的非常简单，但是简易性是需要牺牲部分执行效率为代价的，具体的损耗跟 ORM 框架写得好不好很有关系。但可能更大的问题是让很多的开发者的思维固化，最后可能连简单的 SQL 语句都不会写了。</p> <p>那我们的应用是否应该引入 ORM 框架呢？可能程序员天生追求偷懒，为了提高开发效率，应用的确应该引入 ORM 框架。<strong>但是这不能是我们可以不去学习数据库基础知识的理由，只有理解底层的一些机制，我们才能更加得心应手地解决疑难的问题</strong>。</p> <p>考虑到可以更好的与 Android Jetpack 的组件互动，<a href=https://github.com/Tencent/wcdb/wiki/Android-WCDB-%E4%BD%BF%E7%94%A8-Room-ORM-%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A>WCDB 选择 Room 作为 ORM 框架</a>。</p> <h3 id=2>2. 进程与线程并发<a class=headerlink href=#2 title="Permanent link">&para;</a></h3> <p>如果我们在项目中有使用 SQLite，那么下面这个<a href=https://developer.android.com/reference/android/database/sqlite/SQLiteDatabaseLockedException>SQLiteDatabaseLockedException</a>就是经常会出现的一个问题。</p> <div class=codehilite><pre><span></span><span class=n>android</span><span class=p>.</span><span class=na>database</span><span class=p>.</span><span class=na>sqlite</span><span class=p>.</span><span class=na>SQLiteDatabaseLockedException</span><span class=p>:</span> <span class=n>database</span> <span class=n>is</span> <span class=n>locked</span>
  <span class=n>at</span> <span class=n>android</span><span class=p>.</span><span class=na>database</span><span class=p>.</span><span class=na>sqlite</span><span class=p>.</span><span class=na>SQLiteDatabase</span><span class=p>.</span><span class=na>dbopen</span>
  <span class=n>at</span> <span class=n>android</span><span class=p>.</span><span class=na>database</span><span class=p>.</span><span class=na>sqlite</span><span class=p>.</span><span class=na>SQLiteDatabase</span><span class=p>.</span><span class=na>openDatabase</span>
  <span class=n>at</span> <span class=n>android</span><span class=p>.</span><span class=na>database</span><span class=p>.</span><span class=na>sqlite</span><span class=p>.</span><span class=na>SQLiteDatabase</span><span class=p>.</span><span class=na>openDatabase</span>
</pre></div> <p>SQLiteDatabaseLockedException 归根到底是因为并发导致，而 SQLite 的并发有两个维度，一个是多进程并发，一个是多线程并发。下面我们分别来讲一下它们的关键点。</p> <h4 id=_1>多进程并发<a class=headerlink href=#_1 title="Permanent link">&para;</a></h4> <p>SQLite 默认是支持多进程并发操作的，它通过文件锁来控制多进程的并发。SQLite 锁的粒度并没有非常细，它针对的是整个 DB 文件，内部有 5 个状态，具体你可以参考下面的文章。</p> <ul> <li>官方文档：<a href=https://www.sqlite.org/lockingv3.html>SQLite locking</a></li> <li>SQLite 源码分析：<a href=http://huili.github.io/lockandimplement/machining.html>SQLite 锁机制简介</a></li> <li><a href=https://www.cnblogs.com/cchust/p/4761814.html>SQLite 封锁机制</a></li> </ul> <p>简单来说，多进程可以同时获取 SHARED 锁来读取数据，但是只有一个进程可以获取 EXCLUSIVE 锁来写数据库。对于 iOS 来说可能没有多进程访问数据库的场景，可以把 locking_mode 的默认值改为 EXCLUSIVE。</p> <div class=codehilite><pre><span></span><span class=n>PRAGMA</span> <span class=n>locking_mode</span> <span class=o>=</span> <span class=n>EXCLUSIVE</span>
</pre></div> <p>在 EXCLUSIVE 模式下，数据库连接在断开前都不会释放 SQLite 文件的锁，从而避免不必要的冲突，提高数据库访问的速度。</p> <h4 id=_2>多线程并发<a class=headerlink href=#_2 title="Permanent link">&para;</a></h4> <p>相比多进程，多线程的数据库访问可能会更加常见。SQLite 支持多线程并发模式，需要开启下面的配置，当然系统 SQLite 会默认开启多线程<a href=https://sqlite.org/threadsafe.html>Multi-thread 模式</a>。</p> <div class=codehilite><pre><span></span><span class=n>PRAGMA</span> <span class=n>SQLITE_THREADSAFE</span> <span class=o>=</span> <span class=mi>2</span>
</pre></div> <p><strong>跟多进程的锁机制一样，为了实现简单，SQLite 锁的粒度都是数据库文件级别，并没有实现表级甚至行级的锁</strong>。还有需要说明的是，<strong>同一个句柄同一时间只有一个线程在操作</strong>，这个时候我们需要打开连接池 Connection Pool。</p> <p>如果使用 WCDB 在初始化的时候可以指定连接池的大小，在微信中我们设置的大小是 4。</p> <div class=codehilite><pre><span></span><span class=kd>public</span> <span class=kd>static</span> <span class=n>SQLiteDatabase</span> <span class=nf>openDatabase</span> <span class=p>(</span><span class=n>String</span> <span class=n>path</span><span class=p>,</span> 
                    <span class=n>SQLiteDatabase</span><span class=p>.</span><span class=na>CursorFactory</span> <span class=n>factory</span><span class=p>,</span> 
                    <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> 
                    <span class=n>DatabaseErrorHandler</span> <span class=n>errorHandler</span><span class=p>,</span> 
                    <span class=kt>int</span> <span class=n>poolSize</span><span class=p>)</span>
</pre></div> <p>跟多进程类似，多线程可以同时读取数据库数据，但是写数据库依然是互斥的。SQLite 提供了 Busy Retry 的方案，即发生阻塞时会触发 Busy Handler，此时可以让线程休眠一段时间后，重新尝试操作，你可以参考<a href=https://mp.weixin.qq.com/s/8FjDqPtXWWqOInsiV79Chg>《微信 iOS SQLite 源码优化实践》</a>这篇文章。</p> <p>为了进一步提高并发性能，我们还可以打开<a href=https://www.sqlite.org/wal.html>WAL</a>（Write-Ahead Logging）模式。WAL 模式会将修改的数据单独写到一个 WAL 文件中，同时也会引入了 WAL 日志文件锁。通过 WAL 模式读和写可以完全地并发执行，不会互相阻塞。</p> <div class=codehilite><pre><span></span><span class=n>PRAGMA</span> <span class=n>schema</span><span class=p>.</span><span class=na>journal_mode</span> <span class=o>=</span> <span class=n>WAL</span>
</pre></div> <p><strong>但是需要注意的是，写之间是仍然不能并发</strong>。如果出现多个写并发的情况，依然有可能会出现 SQLiteDatabaseLockedException。这个时候我们可以让应用中捕获这个异常，然后等待一段时间再重试。</p> <div class=codehilite><pre><span></span><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>SQLiteDatabaseLockedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>sqliteLockedExceptionTimes</span> <span class=o>&lt;</span> <span class=p>(</span><span class=n>tryTimes</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>try</span> <span class=p>{</span>
            <span class=n>Thread</span><span class=p>.</span><span class=na>sleep</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e1</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>sqliteLockedExceptionTimes</span><span class=o>++</span><span class=err>；</span>
<span class=p>}</span>
</pre></div> <p><strong>总的来说通过连接池与 WAL 模式，我们可以很大程度上增加 SQLite 的读写并发，大大减少由于并发导致的等待耗时，建议大家在应用中可以尝试开启。</strong></p> <h3 id=3>3. 查询优化<a class=headerlink href=#3 title="Permanent link">&para;</a></h3> <p>说到数据库的查询优化，你第一个想到的肯定是建索引，那我就先来讲讲 SQLite 的索引优化。</p> <h4 id=_3>索引优化<a class=headerlink href=#_3 title="Permanent link">&para;</a></h4> <p>正确使用索引在大部分的场景可以大大降低查询速度，微信的数据库优化也是通过索引开始。下面是索引使用非常简单的一个例子，我们先从索引表找到数据对应的 rowid，然后再从原数据表直接通过 rowid 查询结果。</p> <p><img alt=storage_3_1 src=/assets/images/android/master/storage_3_1.gif></p> <p>关于 SQLite 索引的原理网上有很多文章，在这里我推荐一些参考资料给你：</p> <ul> <li><a href=https://www.cnblogs.com/huahuahu/p/sqlite-suo-yin-de-yuan-li-ji-ying-yong.html>SQLite 索引的原理</a></li> <li>官方文档：<a href=https://www.sqlite.org/queryplanner.html#searching>Query Planning</a></li> <li><a href=http://blog.codinglabs.org/articles/theory-of-mysql-index.html>MySQL 索引背后的数据结构及算法原理</a></li> </ul> <p>这里的关键在于如何正确的建立索引，很多时候我们以为已经建立了索引，但事实上并没有真正生效。例如使用了 BETWEEN、LIKE、OR 这些操作符、使用表达式或者 case when 等。更详细的规则可参考官方文档<a href=https://www.sqlite.org/optoverview.html>The SQLite Query Optimizer Overview</a>，下面是一个通过优化转换达到使用索引目的的例子。</p> <div class=codehilite><pre><span></span><span class=o>##</span> <span class=k>BETWEEN</span><span class=err>：</span><span class=n>myfiedl索引无法生效</span>
<span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>mytable</span> <span class=k>WHERE</span> <span class=n>myfield</span> <span class=k>BETWEEN</span> <span class=mi>10</span> <span class=k>and</span> <span class=mi>20</span><span class=p>;</span>
<span class=o>##</span> <span class=err>转换成：</span><span class=n>myfiedl索引可以生效</span>
<span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>mytable</span> <span class=k>WHERE</span> <span class=n>myfield</span> <span class=o>&gt;=</span> <span class=mi>10</span> <span class=k>AND</span> <span class=n>myfield</span> <span class=o>&lt;=</span> <span class=mi>20</span><span class=p>;</span>
</pre></div> <p>建立索引是有代价的，需要一直维护索引表的更新。比如对于一个很小的表来说就没必要建索引；如果一个表经常是执行插入更新操作，那么也需要节制的建立索引。总的来说有几个原则：</p> <ul> <li>建立正确的索引。这里不仅需要确保索引在查询中真正生效，我们还希望可以选择最高效的索引。如果一个表建立太多的索引，那么在查询的时候 SQLite 可能不会选择最好的来执行。</li> <li>单列索引、多列索引与复合索引的选择。索引要综合数据表中不同的查询与排序语句一起考虑，如果查询结果集过大，还是希望可以通过复合索引直接在索引表返回查询结果。索</li> <li>引字段的选择。整型类型索引效率会远高于字符串索引，而对于主键 SQLite 会默认帮我们建立索引，所以主键尽量不要用复杂字段。</li> </ul> <p><strong>总的来说索引优化是 SQLite 优化中最简单同时也是最有效的，但是它并不是简单的建一个索引就可以了，有的时候我们需要进一步调整查询语句甚至是表的结构，这样才能达到最好的效果。</strong></p> <h4 id=_4>页大小与缓存大小<a class=headerlink href=#_4 title="Permanent link">&para;</a></h4> <p>在 I/O 文件系统中，我讲过数据库就像一个小文件系统一样，事实上它内部也有页和缓存的概念。</p> <p>对于 SQLite 的 DB 文件来说，页（page）是最小的存储单位，如下图所示每个表对应的数据在整个 DB 文件中都是通过一个一个的页存储，属于同一个表不同的页以 B 树（B-tree）的方式组织索引，每一个表都是一棵 B 树。</p> <p><img alt=storage_3_2 src=/assets/images/android/master/storage_3_2.png></p> <p>跟文件系统的页缓存（Page Cache）一样，SQLite 会将读过的页缓存起来，用来加快下一次读取速度。页大小默认是 1024Byte，缓存大小默认是 1000 页。更多的编译参数你可以查看官方文档<a href=https://sqlite.org/pragma.html#pragma_journal_mode>PRAGMA Statements</a>。</p> <div class=codehilite><pre><span></span><span class=n>PRAGMA</span> <span class=n>page_size</span> <span class=o>=</span> <span class=mi>1024</span>
<span class=n>PRAGMA</span> <span class=n>cache_size</span> <span class=o>=</span> <span class=mi>1000</span>
</pre></div> <p>每个页永远只存放一个表或者一组索引的数据，即不可能同一个页存放多个表或索引的数据，表在整个 DB 文件的第一个页就是这棵 B 树的根页。继续以上图为例，如果想查询 rowID 为 N+2 的数据，我们首先要从 sqlite_master 查找出 table 的 root page 的位置，然后读取 root page、page4 这两个页，所以一共会需要 3 次 I/O。</p> <p><img alt=storage_3_3 src=/assets/images/android/master/storage_3_3.png></p> <p>从上表可以看到，增大 page size 并不能不断地提升性能，在拐点以后可能还会有副作用。我们可以通过 PRAGMA 改变默认 page size 的大小，也可以再创建 DB 文件的时候进行设置。但是需要注意如果存在老的数据，需要调用 vacuum 对数据表对应的节点重新计算分配大小。</p> <p>在微信的内部测试中，如果使用 4KB 的 page size 性能提升可以在 5%～10%。但是考虑到历史数据的迁移成本，最终还是使用 1024Byte。<strong>所以这里建议大家在新建数据库的时候，就提前选择 4KB 作为默认的 page size 以获得更好的性能。</strong></p> <h4 id=_5>其他优化<a class=headerlink href=#_5 title="Permanent link">&para;</a></h4> <p>关于 SQLite 的使用优化还有很多很多，下面我简单提几个点。</p> <ul> <li>慎用“select*”，需要使用多少列，就选取多少列。</li> <li>正确地使用事务。</li> <li>预编译与参数绑定，缓存被编译后的 SQL 语句。</li> <li>对于 blob 或超大的 Text 列，可能会超出一个页的大小，导致出现超大页。建议将这些列单独拆表，或者放到表字段的后面。</li> <li>定期整理或者清理无用或可删除的数据，例如朋友圈数据库会删除比较久远的数据，如果用户访问到这部分数据，重新从网络拉取即可。</li> </ul> <p>在日常的开发中，我们都应该对这些知识有所了解，再来复习一下上面学到的 SQLite 优化方法。<strong>通过引进 ORM，可以大大的提升我们的开发效率。通过 WAL 模式和连接池，可以提高 SQLite 的并发性能。通过正确的建立索引，可以提升 SQLite 的查询速度。通过调整默认的页大小和缓存大小，可以提升 SQLite 的整体性能。</strong></p> <h2 id=sqlite_1>SQLite 的其他特性<a class=headerlink href=#sqlite_1 title="Permanent link">&para;</a></h2> <p>除了 SQLite 的优化经验，我在微信的工作中还积累了很多使用的经验，下面我挑选了几个比较重要的经验把它分享给你。</p> <h3 id=1>1. 损坏与恢复<a class=headerlink href=#1 title="Permanent link">&para;</a></h3> <p>微信中 SQLite 的损耗率在 1/20000～1/10000 左右，虽然看起来很低，不过意考虑到微信的体量，这个问题还是不容忽视的。特别是如果某些大佬的聊天记录丢失，我们团队都会承受超大的压力。</p> <p>创新是为了解决焦虑，技术都是逼出来的。对于 SQLite 损坏与恢复的研究，可以说是微信投入比较大的一块。关于 SQLite 数据库的损耗与修复，以及微信在这里的优化成果，你可以参考下面这些资料。</p> <ul> <li><a href=https://sqlite.org/howtocorrupt.html>How To Corrupt An SQLite Database File</a></li> <li><a href=https://mp.weixin.qq.com/s/N1tuHTyg3xVfbaSd4du-tw>微信 SQLite 数据库修复实践</a></li> <li><a href=https://mp.weixin.qq.com/s/Ln7kNOn3zx589ACmn5ESQA>微信移动端数据库组件 WCDB 系列（二） — 数据库修复三板斧</a></li> <li><a href=https://github.com/Tencent/wcdb/wiki/Android%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BF%AE%E5%A4%8D>WCDB Android 数据库修复</a></li> </ul> <h3 id=2_1>2. 加密与安全<a class=headerlink href=#2_1 title="Permanent link">&para;</a></h3> <p>数据库的安全主要有两个方面，一个是防注入，一个是加密。防注入可以通过静态安全扫描的方式，而加密一般会使用 SQLCipher 支持。</p> <p>SQLite 的加解密都是以页为单位，默认会使用 AES 算法加密，加 / 解密的耗时跟选用的密钥长度有关。下面是<a href=https://github.com/Tencent/wcdb/wiki/Android-Benchmark>WCDB Android Benchmark</a>的数据，详细的信息请查看链接里的说明，从结论来说对 Create 来说影响会高达到 10 倍。</p> <p><img alt=storage_3_4 src=/assets/images/android/master/storage_3_4.png></p> <p>关于 WCDB 加解密的使用，你可以参考<a href=https://mp.weixin.qq.com/s/NFnYEXSxAaHBqpi7WofSPQ>《微信移动数据库组件 WCDB（四） — Android 特性篇》</a>。</p> <h3 id=3_1>3. 全文搜索<a class=headerlink href=#3_1 title="Permanent link">&para;</a></h3> <p>微信的全文搜索也是一个技术导向的项目，最开始的时候性能并不是很理想，经常会被人“批斗”。经过几个版本的优化迭代，目前看效果还是非常不错的。</p> <p><img alt=storage_3_5 src=/assets/images/android/master/storage_3_5.png></p> <p>关于全文搜索，你可以参考这些资料：</p> <ul> <li><a href=https://sqlite.org/fts3.html>SQLite FTS3 and FTS4 Extensions</a></li> <li><a href=https://mp.weixin.qq.com/s/AhYECT3HVyn1ikB0YQ-UVg>微信全文搜索优化之路</a></li> <li><a href=https://mp.weixin.qq.com/s/GCznwCtjJ2XUszyMcbNz8Q>移动客户端多音字搜索</a></li> </ul> <p><strong>关于 SQLite 的这些特性，我们需要根据自己的项目情况综合考虑。假如某个数据库存储的数据并不重要，这个时候万分之一的数据损坏率我们并不会关心。同样是否需要使用数据库加密，也要根据存储的数据是不是敏感内容。</strong></p> <h2 id=sqlite_2>SQLite 的监控<a class=headerlink href=#sqlite_2 title="Permanent link">&para;</a></h2> <p>首先我想说，正确使用索引，正确使用事务。对于大型项目来说，参与的开发人员可能有几十几百人，开发人员水平参差不齐，很难保证每个人都可以正确而高效地使用 SQLite，所以这次时候需要建立完善的监控体系。</p> <h3 id=1_1>1. 本地测试<a class=headerlink href=#1_1 title="Permanent link">&para;</a></h3> <p>作为一名靠谱的开发工程师，我们每写一个 SQL 语句，都应该先在本地测试。我们可以通过 EXPLAIN QUERY PLAN 测试 SQL 语句的查询计划，是全表扫描还是使用了索引，以及具体使用了哪个索引等。</p> <div class=codehilite><pre><span></span><span class=n>sqlite</span><span class=o>&gt;</span> <span class=k>EXPLAIN</span> <span class=n>QUERY</span> <span class=n>PLAN</span> <span class=k>SELECT</span> <span class=o>*</span> <span class=k>FROM</span> <span class=n>t1</span> <span class=k>WHERE</span> <span class=n>a</span><span class=o>=</span><span class=mi>1</span> <span class=k>AND</span> <span class=n>b</span><span class=o>&gt;</span><span class=mi>2</span><span class=p>;</span>
<span class=n>QUERY</span> <span class=n>PLAN</span>
<span class=o>|</span><span class=c1>--SEARCH TABLE t1 USING INDEX i2 (a=? AND b&gt;?)</span>
</pre></div> <p>关于 SQLite 命令行与 EXPLAIN QUERY PLAN 的使用，可以参考<a href=https://sqlite.org/cli.html>Command Line Shell For SQLite</a>以及<a href=https://sqlite.org/eqp.html>EXPLAIN QUERY PLAN</a>。</p> <h3 id=2_2>2. 耗时监控<a class=headerlink href=#2_2 title="Permanent link">&para;</a></h3> <p>本地测试过于依赖开发人员的自觉性，所以很多时候我们依然需要建立线上大数据的监控。因为微信集成了自己的 SQLite 源码，所以可以非常方便地增加自己想要的监控模块。</p> <p>WCDB 增加了<a href=https://tencent.github.io/wcdb/references/android/reference/com/tencent/wcdb/database/SQLiteTrace.html>SQLiteTrace</a>的监控模块，有以下三个接口：</p> <p><img alt=storage_3_6 src=/assets/images/android/master/storage_3_6.png></p> <p>我们可以通过这些接口监控数据库 busy、损耗以及执行耗时。针对耗时比较长的 SQL 语句，需要进一步检查是 SQL 语句写得不好，还是需要建立索引。</p> <p><img alt=storage_3_7 src=/assets/images/android/master/storage_3_7.png></p> <h3 id=3_2>3. 智能监控<a class=headerlink href=#3_2 title="Permanent link">&para;</a></h3> <p>对于查询结果的监控只是我们监控演进的第二阶段，在这个阶段我们依然需要人工介入分析，而且需要比较有经验的人员负责。</p> <p>我们希望 SQL 语句的分析可以做到智能化，是完全不需要门槛的。微信开源的 Matrix 里面就有一个智能化分析 SQLite 语句的工具：<a href=https://mp.weixin.qq.com/s/laUgOmAcMiZIOfM2sWrQgw>Matrix SQLiteLint – SQLite 使用质量检测</a>。<strong>它根据分析 SQL 语句的语法树，结合我们日常数据库使用的经验，抽象出索引使用不当、select*等六大问题。</strong></p> <p><img alt=storage_3_8 src=/assets/images/android/master/storage_3_8.png></p> <p>可能有同学会感叹为什么微信的人可以想到这样的方式，事实上这个思路在 MySQL 中是非常常见的做法。美团也开源了它们内部的 SQL 优化工具 SQLAdvisor，你可以参考这些资料：</p> <ul> <li><a href=https://tech.meituan.com/2018/05/20/sql-parser-used-in-mtdp.html>SQL 解析在美团的应用</a></li> <li><a href=https://tech.meituan.com/2017/03/09/sqladvisor-pr.html>美团点评 SQL 优化工具 SQLAdvisor 开源</a></li> </ul> <h2 id=_6>总结<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <p>数据库存储是一个开发人员的基本功，清楚 SQLite 的底层机制对我们的工作会有很大的指导意义。</p> <p>掌握了 SQLite 数据库并发的机制，在某些时候我们可以更好地决策应该拆数据表还是拆数据库。新建一个数据库好处是可以隔离其他库并发或者损坏的情况，而坏处是数据库初始化耗时以及更多内存的占用。一般来说，单独的业务都会使用独立数据库，例如专门的下载数据库、朋友圈数据库、聊天数据库。但是数据库也不宜太多，我们可以有一个公共数据库，用来存放一些相对不是太大的数据。</p> <p>在了解 SQLite 数据库损坏的原理和概率以后，我们可以根据数据的重要程度决定是否要引入恢复机制。我还讲了如何实现数据库加密以及对性能的影响，我们可以根据数据的敏感程度决定是否要引入加密。</p> <p>最后我再强调一下，SQLite 优化真的是一个很大的话题，在课后你还需要结合参考资料再进一步反复学习，才能把今天的内容理解透彻。</p> <h2 id=_7>课后作业<a class=headerlink href=#_7 title="Permanent link">&para;</a></h2> <p>在你的应用中是否使用数据库存储呢，使用了哪种数据库？是否使用 ORM？在使用数据库过程中你有哪些疑问或者经验呢？欢迎留言跟我和其他同学一起讨论。</p> <p>如果你的应用也在使用 SQLite 存储，今天的课后练习是尝试接入 WCDB，对比测试系统默认 SQLite 的性能。尝试接入<a href=https://github.com/Tencent/matrix/tree/master/matrix/matrix-android/matrix-sqlite-lint>Matrix SQLiteLint</a>，查看是否存在不合理的 SQLite 使用。</p> <p>除了今天文章中的参考资料，我还给希望进阶的同学准备了下面的资料，欢迎有兴趣的同学继续深入学习。</p> <ul> <li><a href=https://sqlite.org/docs.html>SQLite 官方文档</a></li> <li><a href=http://huili.github.io/sqlite/sqliteintro.html>SQLite 源码分析</a></li> <li><a href=https://github.com/AndroidAdvanceWithGeektime/Chapter14/blob/master/%E5%85%A8%E9%9D%A2%E8%A7%A3%E6%9E%90SQLite.pdf>全面解析 SQLite</a></li> <li>图书《SQLite 权威指南（第 2 版）》</li> </ul> <hr> <div class=md-source-date> <small> 最后更新: 2020年2月13日 </small> </div> <h2 id=__comments>评论</h2> <div id=disqus_thread></div> <script>
    var disqus_config = function () {
      this.page.url = "https://blog.yorek.xyz/about-me/android/paid/master/storage_3/";
      this.page.identifier =
        "/android/paid/master/storage_3/";
    };
    (function() {
      var d = document, s = d.createElement("script");
      s.src = "//yorekliu.disqus.com/embed.js";
      s.setAttribute("data-timestamp", +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid"> <a href=../storage_2/ title="13 | 存储优化（中）：如何优化数据存储？" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i> </div> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 上一页 </span> 13 | 存储优化（中）：如何优化数据存储？ </span> </div> </a> <a href=../network_1/ title="15 | 网络优化（上）：移动开发工程师必备的网络优化知识" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel=next> <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"> <span class=md-flex__ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </span> </div> <div class="md-flex__cell md-flex__cell--shrink"> <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2020 Yorek </div> powered by <a href=https://www.mkdocs.org>MkDocs</a> and <a href=https://squidfunk.github.io/mkdocs-material/ > Material for MkDocs</a> </div> <div class=md-footer-social> <link rel=stylesheet href=../../../../assets/fonts/font-awesome.css> <a href=https://github.com/YorekLiu class="md-footer-social__link fa fa-github"></a> <a href=lyytogether@gmail.com class="md-footer-social__link fa fa-email"></a> </div> </div> </div> </footer> </div> <script src=../../../../assets/javascripts/application.808e90bb.js></script> <script src=../../../../assets/javascripts/lunr/lunr.stemmer.support.js></script> <script src=../../../../assets/javascripts/lunr/tinyseg.js></script> <script src=../../../../assets/javascripts/lunr/lunr.ja.js></script> <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
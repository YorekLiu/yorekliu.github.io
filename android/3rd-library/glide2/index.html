<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An Android Developer."><meta name=author content="Yorek Liu"><link href=https://blog.yorek.xyz/about-me/android/3rd-library/glide2/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.webp><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.5"><title>Glide v4 æºç è§£æï¼ˆäºŒï¼‰ - Yorek's</title><link rel=stylesheet href=../../../assets/stylesheets/main.15aa0b43.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.75751829.min.css><meta name=theme-color content=#ffffff><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=manifest href=../../../manifest.webmanifest crossorigin=use-credentials><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-155096376-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=white data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-glidewith class=md-skip> è·³è½¬è‡³ </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo" aria-label="Yorek's"> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <div class=md-header-nav__topic> <span class=md-ellipsis> Yorek's </span> </div> <div class=md-header-nav__topic> <span class=md-ellipsis> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </span> </div> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=æœç´¢ placeholder=æœç´¢ autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“ </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo" aria-label="Yorek's"> <img src=../../../assets/images/favicon.webp alt=logo> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1 checked> <label class=md-nav__link for=nav-1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1 checked> <label class=md-nav__link for=nav-1-1> ä¸‰æ–¹åº“æºç è§£æ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ä¸‰æ–¹åº“æºç è§£æ data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"></span> ä¸‰æ–¹åº“æºç è§£æ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ class=md-nav__link> Androidä¸‰æ–¹åº“æºç åˆ†æ </a> </li> <li class=md-nav__item> <a href=../matrix/ class=md-nav__link> å¾®ä¿¡APM Matrixè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ class=md-nav__link> Matrix-TraceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-io/ class=md-nav__link> Matrix-IOCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ class=md-nav__link> Matrix-ResourceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLintè§£æ </a> </li> <li class=md-nav__item> <a href=../okhttp/ class=md-nav__link> OkHttp3æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../retrofit/ class=md-nav__link> Retrofit2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../rxjava%26rxandroid/ class=md-nav__link> RxJavaæºç è§£æåŠä½¿ç”¨å®ä¾‹ </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJavaæ“ä½œç¬¦å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../glide1/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸€ï¼‰ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </a> <nav class="md-nav md-nav--secondary" aria-label=ç›®å½•> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> ç›®å½• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-glidewith class=md-nav__link> 1. Glide.with </a> <nav class=md-nav aria-label="1. Glide.with"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-getretrievercontext class=md-nav__link> 1.1 getRetriever(Context) </a> </li> <li class=md-nav__item> <a href=#12-requestmanagerretrieverget class=md-nav__link> 1.2 RequestManagerRetriever.get </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-requestmanagerload class=md-nav__link> 2. RequestManager.load </a> <nav class=md-nav aria-label="2. RequestManager.load"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-requestmanagerasxxx class=md-nav__link> 2.1 RequestManager.asXxx </a> </li> <li class=md-nav__item> <a href=#22-requestbuilderload class=md-nav__link> 2.2 RequestBuilder.load </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-requestbuilderinto class=md-nav__link> 3. RequestBuilder.into </a> <nav class=md-nav aria-label="3. RequestBuilder.into"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-buildrequest class=md-nav__link> 3.1 buildRequest </a> </li> <li class=md-nav__item> <a href=#32-requestmanagertrack class=md-nav__link> 3.2 RequestManager.track </a> </li> <li class=md-nav__item> <a href=#33-engineload class=md-nav__link> 3.3 Engine.load </a> </li> <li class=md-nav__item> <a href=#34-decodejobrun class=md-nav__link> 3.4 DecodeJob.run </a> </li> <li class=md-nav__item> <a href=#35-registry class=md-nav__link> 3.5 Registry </a> </li> <li class=md-nav__item> <a href=#36-resourcecachegenerator class=md-nav__link> 3.6 ResourceCacheGenerator </a> <nav class=md-nav aria-label="3.6 ResourceCacheGenerator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#361-helpergetcachekeys class=md-nav__link> 3.6.1 helper.getCacheKeys </a> </li> <li class=md-nav__item> <a href=#362-dhgetregisteredresourceclasses class=md-nav__link> 3.6.2 DH.getRegisteredResourceClasses </a> </li> <li class=md-nav__item> <a href=#363 class=md-nav__link> 3.6.3 å¯»æ‰¾ç¼“å­˜æ–‡ä»¶å¹¶åŠ è½½ </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#37-datacachegenerator class=md-nav__link> 3.7 DataCacheGenerator </a> </li> <li class=md-nav__item> <a href=#38-sourcegenerator class=md-nav__link> 3.8 SourceGenerator </a> </li> <li class=md-nav__item> <a href=#39-decodejobfetcherreadycallback class=md-nav__link> 3.9 DecodeJob.FetcherReadyCallback </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide3/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide4/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå››ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide5/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆäº”ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide6/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå…­ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide7/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸ƒï¼‰ </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ class=md-nav__link> æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ class=md-nav__link> EventBusæºç è§£æ </a> </li> <li class=md-nav__item> <a href=../leakcanary/ class=md-nav__link> LeakCanary2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ class=md-nav__link> PermissionDispatcheræºç è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayoutä½¿ç”¨å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> åˆå­¦è€…çš„Dagger2æ•™ç¨‹ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2> <label class=md-nav__link for=nav-1-2> Androidå¼€å‘é«˜æ‰‹è¯¾ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Androidå¼€å‘é«˜æ‰‹è¯¾ data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"></span> Androidå¼€å‘é«˜æ‰‹è¯¾ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ class=md-nav__link> Androidå¼€å‘é«˜æ‰‹è¯¾ </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | å´©æºƒä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå…³äºâ€œå´©æºƒâ€é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | å´©æºƒä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šåº”ç”¨å´©æºƒäº†ï¼Œä½ åº”è¯¥å¦‚ä½•å»åˆ†æï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼š4GBå†…å­˜æ—¶ä»£ï¼Œå†è°ˆå†…å­˜ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå†…å­˜ä¼˜åŒ–è¿™ä»¶äº‹ï¼Œåº”è¯¥ä»å“ªé‡Œç€æ‰‹ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä½ è¦æŒæ¡çš„å¡é¡¿åˆ†ææ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§åº”ç”¨å¡é¡¿ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06è¡¥å……ç¯‡ | å¡é¡¿ä¼˜åŒ–ï¼šå¡é¡¿ç°åœºä¸å¡é¡¿åˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»å¯åŠ¨è¿‡ç¨‹çœ‹å¯åŠ¨é€Ÿåº¦ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šä¼˜åŒ–å¯åŠ¨é€Ÿåº¦çš„è¿›é˜¶æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/Oä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„I/Oä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/Oä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šä¸åŒI/Oæ–¹å¼çš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/Oä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§çº¿ä¸ŠI/Oæ“ä½œï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¸¸è§çš„æ•°æ®å­˜å‚¨æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ–æ•°æ®å­˜å‚¨ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šæ•°æ®åº“SQLiteçš„ä½¿ç”¨å’Œä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šç§»åŠ¨å¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„ç½‘ç»œä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¤æ‚å¤šå˜çš„ç§»åŠ¨ç½‘ç»œè¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¤§æ•°æ®ä¸‹ç½‘ç»œè¯¥å¦‚ä½•ç›‘æ§ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | è€—ç”µä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»ç”µé‡ä¼˜åŒ–çš„æ¼”è¿›çœ‹è€—ç”µåˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | è€—ç”µä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šè€—ç”µçš„ä¼˜åŒ–æ–¹æ³•ä¸çº¿ä¸Šç›‘æ§ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šUI æ¸²æŸ“çš„å‡ ä¸ªå…³é”®æ¦‚å¿µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ– UI æ¸²æŸ“ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å‡å°‘å®‰è£…åŒ…å¤§å°ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šèµ„æºä¼˜åŒ–çš„è¿›é˜¶å®è·µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | å…³äºç¼–è¯‘ï¼Œä½ éœ€è¦äº†è§£ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | ç¼–è¯‘æ’æ¡©çš„ä¸‰ç§æ–¹æ³•ï¼šAspectJã€ASMã€ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook æŠ€æœ¯ï¼Œå¤©ä½¿è¿˜æ˜¯é­”é¬¼ï¼Ÿ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <label class=md-nav__link for=nav-1-3> Frameworkç³»åˆ— <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Frameworkç³»åˆ— data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"></span> Frameworkç³»åˆ— </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providersä¸Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPCæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> Viewçš„äº‹ä»¶ä½“ç³» </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> Viewçš„ç»˜åˆ¶åŸç† </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> Androidä¸­çš„Drawableèµ„æº </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> AndroidåŠ¨ç”» </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Windowä¸WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> å››å¤§ç»„ä»¶å¯åŠ¨è¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Androidæ¶ˆæ¯æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Androidçº¿ç¨‹ä¸çº¿ç¨‹æ±  </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmapçš„ç¼“å­˜ä¸åŠ è½½ </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNIä¸NDKç¼–ç¨‹ç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Androidæ€§èƒ½ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ä»¥MediaServiceä¸ºä¾‹ </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ç½—è€å¸ˆç³»åˆ— </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4 type=checkbox id=nav-1-4> <label class=md-nav__link for=nav-1-4> ä»˜è´¹çŸ¥è¯†å½’æ¡£ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ä»˜è´¹çŸ¥è¯†å½’æ¡£ data-md-level=2> <label class=md-nav__title for=nav-1-4> <span class="md-nav__icon md-icon"></span> ä»˜è´¹çŸ¥è¯†å½’æ¡£ </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4-1 type=checkbox id=nav-1-4-1> <label class=md-nav__link for=nav-1-4-1> æŸåœˆé—®é¢˜ç´¢å¼• <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=æŸåœˆé—®é¢˜ç´¢å¼• data-md-level=3> <label class=md-nav__title for=nav-1-4-1> <span class="md-nav__icon md-icon"></span> æŸåœˆé—®é¢˜ç´¢å¼• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ class=md-nav__link> æŸåœˆé—®é¢˜ç´¢å¼• </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> ç†è§£Javaä¸­synchronizedå…³é”®è¯ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> ç†è§£Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> ç†è§£Activityçš„å¯åŠ¨æ¨¡å¼ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> å…³äºstartActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> å…³äºViewçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> å…³äºGradleçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> å…³äºåºåˆ—åŒ–çš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Androidä¸­çš„ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binderç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttpå’ŒRetrofitçš„ä½œç”¨ä»¥åŠä¸¤è€…ä¹‹é—´çš„è”ç³» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVMä¸­åƒåœ¾å›æ”¶ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> è¿›ç¨‹ä¿æ´» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> å››å¤§ç»„ä»¶çš„ä½œç”¨ä»¥åŠå¤šè¿›ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> ç½‘ç»œåè®® </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVCã€MVPå’ŒMVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio buildè¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> å¤§å°ºå¯¸å›¾ç‰‡åŠ è½½é—®é¢˜ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-5 type=checkbox id=nav-1-5> <label class=md-nav__link for=nav-1-5> æ—¥å¸¸è®°å½• <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=æ—¥å¸¸è®°å½• data-md-level=2> <label class=md-nav__title for=nav-1-5> <span class="md-nav__icon md-icon"></span> æ—¥å¸¸è®°å½• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> æ³¨è§£çš„å®šä¹‰åŠè§£æ </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> è¿™å¯èƒ½æ˜¯MVVMä¸­æœ€ä¼˜é›…çš„æŒ‰é”®é˜²æŠ–æ–¹æ¡ˆ </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> æ™®é€šAndroidç¨‹åºä½¿ç”¨SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListViewã€RecyclerViewç¼“å­˜ç­–ç•¥è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerViewçš„ä¸€äº›ä½¿ç”¨ç»†èŠ‚ </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”æ‹–æ‹½æ’åºä»¥åŠæ»‘åŠ¨åˆ é™¤ </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButtonä¸Šæ»‘éšè—ä¸‹æ»‘æ˜¾ç¤º </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrollingæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> ä½¿ç”¨Porter-Duffåˆæˆæ•°å­—å›¾åƒ </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Androidé©¬ç”²åŒ…çš„é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Androidç¥å…µåˆ©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Androidåˆ¤æ–­è™šæ‹ŸæŒ‰é”®(å¯¼èˆªæ )æ˜¾ç¤ºä¸å¦ã€é«˜åº¦ä»¥åŠè·å–å±å¹•å®é™…é«˜åº¦ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Androidå›¾ç‰‡é€‰æ‹©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> AndroidåŸç”Ÿåº•éƒ¨å¯¼èˆªæ  </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Androidæœç´¢æ çš„å®ç° </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Androidæš‚åœé…·ç‹—ã€ç½‘æ˜“äº‘éŸ³ä¹ç­‰éŸ³ä¹æ’­æ”¾å™¨çš„æ’­æ”¾ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Androidæ»‘åŠ¨è¿”å›å®è·µ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOSä¸‹Androidç¨‹åºåç¼–è¯‘ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Androidé€šè®¯å½•å¿«é€Ÿè¯»å– </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> Appå†…è‡ªå®šä¹‰è½¯é”®ç›˜ </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> è…¾è®¯TBS X5æµè§ˆå™¨å†…æ ¸å…¥å‘æŒ‡å— </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> çç¢çŸ¥è¯†ç‚¹ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ class=md-nav__link> ç®—æ³•ç›®å½• </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> æ•°æ®ç»“æ„ã€ç®—æ³•å’Œæ•°æ®æ“ä½œ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> é«˜è´¨é‡çš„ä»£ç  </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> è§£å†³é—®é¢˜çš„æ€è·¯ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> ä¼˜åŒ–æ—¶é—´å’Œç©ºé—´æ•ˆç‡ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> é¢è¯•ä¸­çš„å„é¡¹èƒ½åŠ› </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=nav-4-1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> è®¾è®¡æ¨¡å¼æ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™ </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> å•ä¾‹æ¨¡å¼(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> å»ºé€ è€…æ¨¡å¼(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> åŸå‹æ¨¡å¼(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> å·¥å‚æ–¹æ³•æ¨¡å¼(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> æŠ½è±¡å·¥å‚æ¨¡å¼(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> ä»£ç†æ¨¡å¼(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> ç»„åˆæ¨¡å¼(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> é€‚é…å™¨æ¨¡å¼(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> è£…é¥°æ¨¡å¼(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> äº«å…ƒæ¨¡å¼(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> å¤–è§‚æ¨¡å¼(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> æ¡¥æ¥æ¨¡å¼(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> ç­–ç•¥æ¨¡å¼(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> çŠ¶æ€æ¨¡å¼(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> è´£ä»»é“¾æ¨¡å¼(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> è§£é‡Šå™¨æ¨¡å¼(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> å‘½ä»¤æ¨¡å¼(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> è§‚å¯Ÿè€…æ¨¡å¼(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> å¤‡å¿˜å½•æ¨¡å¼(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> è¿­ä»£å™¨æ¨¡å¼(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> è®¿é—®è€…æ¨¡å¼(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> ä¸­ä»‹è€…æ¨¡å¼(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> æ˜“æ··æ·†çš„è®¾è®¡æ¨¡å¼ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=nav-4-2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Javaæ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> ç±»å’Œæ¥å£ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=nav-4-3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸ </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> ç±»æ–‡ä»¶ç»“æ„ </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=nav-4-4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlinåœ¨æ³›å‹æ–¹é¢çš„åŒºåˆ« </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Javaé›†åˆæ€»ç»“ </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Javaå¸¸è§æ¦‚å¿µ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=nav-4-5> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> é‡æ„ï¼šæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=ç›®å½•> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> ç›®å½• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-glidewith class=md-nav__link> 1. Glide.with </a> <nav class=md-nav aria-label="1. Glide.with"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-getretrievercontext class=md-nav__link> 1.1 getRetriever(Context) </a> </li> <li class=md-nav__item> <a href=#12-requestmanagerretrieverget class=md-nav__link> 1.2 RequestManagerRetriever.get </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-requestmanagerload class=md-nav__link> 2. RequestManager.load </a> <nav class=md-nav aria-label="2. RequestManager.load"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-requestmanagerasxxx class=md-nav__link> 2.1 RequestManager.asXxx </a> </li> <li class=md-nav__item> <a href=#22-requestbuilderload class=md-nav__link> 2.2 RequestBuilder.load </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-requestbuilderinto class=md-nav__link> 3. RequestBuilder.into </a> <nav class=md-nav aria-label="3. RequestBuilder.into"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-buildrequest class=md-nav__link> 3.1 buildRequest </a> </li> <li class=md-nav__item> <a href=#32-requestmanagertrack class=md-nav__link> 3.2 RequestManager.track </a> </li> <li class=md-nav__item> <a href=#33-engineload class=md-nav__link> 3.3 Engine.load </a> </li> <li class=md-nav__item> <a href=#34-decodejobrun class=md-nav__link> 3.4 DecodeJob.run </a> </li> <li class=md-nav__item> <a href=#35-registry class=md-nav__link> 3.5 Registry </a> </li> <li class=md-nav__item> <a href=#36-resourcecachegenerator class=md-nav__link> 3.6 ResourceCacheGenerator </a> <nav class=md-nav aria-label="3.6 ResourceCacheGenerator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#361-helpergetcachekeys class=md-nav__link> 3.6.1 helper.getCacheKeys </a> </li> <li class=md-nav__item> <a href=#362-dhgetregisteredresourceclasses class=md-nav__link> 3.6.2 DH.getRegisteredResourceClasses </a> </li> <li class=md-nav__item> <a href=#363 class=md-nav__link> 3.6.3 å¯»æ‰¾ç¼“å­˜æ–‡ä»¶å¹¶åŠ è½½ </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#37-datacachegenerator class=md-nav__link> 3.7 DataCacheGenerator </a> </li> <li class=md-nav__item> <a href=#38-sourcegenerator class=md-nav__link> 3.8 SourceGenerator </a> </li> <li class=md-nav__item> <a href=#39-decodejobfetcherreadycallback class=md-nav__link> 3.9 DecodeJob.FetcherReadyCallback </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Glide v4 æºç è§£æï¼ˆäºŒï¼‰</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>æœ¬ç³»åˆ—æ–‡ç« å‚è€ƒ3.7.0ç‰ˆæœ¬çš„<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glideæœ€å…¨è§£æ</a>ï¼Œå¹¶æŒ‰æ­¤æ€è·¯ç»“åˆ4.9.0ç‰ˆæœ¬æºç ä»¥åŠä½¿ç”¨æ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚<br> âŸ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> âŸ <a href=https://muyangmin.github.io/glide-docs-cn/ >ä¸­æ–‡æ–‡æ¡£</a><br> âŸ <a href=https://bumptech.github.io/glide/ >è‹±æ–‡æ–‡æ¡£</a>ğŸš€ğŸš€ </p> </div> <div class="admonition note"> <p class=admonition-title>Glideç³»åˆ—æ–‡ç« ç›®å½•</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1â€”â€”Glide v4 çš„åŸºæœ¬ä½¿ç”¨</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2â€”â€”ä»æºç çš„è§’åº¦ç†è§£Glideä¸‰æ­¥çš„æ‰§è¡Œæµç¨‹</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3â€”â€”æ·±å…¥æ¢ç©¶Glideç¼“å­˜æœºåˆ¶</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4â€”â€”RequestBuilderä¸­é«˜çº§ç‚¹çš„APIä»¥åŠTarget</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5â€”â€”Glideå†…ç½®çš„transformä»¥åŠè‡ªå®šä¹‰BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6â€”â€”Glideåˆ©ç”¨AppGlideModuleã€LibraryGlideModuleæ›´æ”¹é»˜è®¤é…ç½®ã€æ‰©å±•GlideåŠŸèƒ½ï¼›GlideAppä¸Glideçš„åŒºåˆ«åœ¨å“ªï¼Ÿ</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7â€”â€”åˆ©ç”¨OkHttpã€è‡ªå®šä¹‰Drawableã€è‡ªå®šä¹‰ViewTargetå®ç°å¸¦è¿›åº¦çš„å›¾ç‰‡åŠ è½½åŠŸèƒ½</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide</a></li> </ul> </div> <hr> <p>æœ¬ç« ä¸»è¦å†…å®¹ä¸ºä»æºç çš„è§’åº¦ç†è§£Glideä¸‰æ­¥çš„æ‰§è¡Œæµç¨‹ã€‚</p> <p>ç”±äºä¸Šä¸€ç« ä¸­æˆ‘ä»¬å·²ç»å¯¼å…¥äº†Glideåº“ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨Android Studioä¸­æŸ¥çœ‹Glideçš„æºç ã€‚ç›¸æ¯”clone GitHubä¸Šçš„æºç ï¼Œä½¿ç”¨Android StudioæŸ¥çœ‹Glideæºç çš„å¥½å¤„æ˜¯ï¼Œè¿™æ˜¯åªè¯»çš„ï¼Œé˜²æ­¢æˆ‘ä»¬è¯¯æ“ä½œã€‚è€Œä¸”è¿˜èƒ½ç›´æ¥ä¸Šåœ¨æºç å¯¹åº”çš„ä¸Šæ–­ç‚¹ï¼ŒçœŸæ˜¯å¤ªæ–¹ä¾¿äº†ã€‚</p> <p>è¿˜æ˜¯ä»¥<code>Glide.with(this).load(URL).into(ivGlide)</code>ä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™èƒŒåéšè—äº†ä»€ä¹ˆç§˜å¯†ã€‚</p> <h2 id=1-glidewith>1. Glide.with<a class=headerlink href=#1-glidewith title="Permanent link">&para;</a></h2> <p><code>Glide.with</code>æœ‰å¾ˆå¤šé‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Glide</span> <span class=kd>implements</span> <span class=n>ComponentCallbacks2</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=nd>@NonNull</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@NonNull</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>activity</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@NonNull</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>activity</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@NonNull</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
    <span class=nd>@Deprecated</span>
    <span class=nd>@NonNull</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>Fragment</span> <span class=n>fragment</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=nd>@NonNull</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªé‡è½½æ–¹æ³•å†…éƒ¨éƒ½é¦–å…ˆè°ƒç”¨<code>getRetriever(@Nullable Context context)</code>æ–¹æ³•è·å–ä¸€ä¸ª<code>RequestManagerRetriever</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶<code>get</code>æ–¹æ³•æ¥è¿”å›<code>RequestManager</code>ã€‚<br> ä¼ å…¥<code>getRetriever</code>çš„å‚æ•°éƒ½æ˜¯<code>Context</code>ï¼Œè€Œ<code>RequestManagerRetriever.get</code>æ–¹æ³•ä¼ å…¥çš„å‚æ•°å„ä¸ç›¸åŒï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šè‚¯å®šå‘ç”Ÿåœ¨<code>get</code>æ–¹æ³•ä¸­ã€‚</p> <p>æˆ‘ä»¬æŠŠ<code>Glide.with</code>æ–¹æ³•é‡Œé¢çš„ä»£ç åˆ†æˆä¸¤éƒ¨åˆ†æ¥åˆ†æã€‚</p> <h3 id=11-getretrievercontext>1.1 getRetriever(Context)<a class=headerlink href=#11-getretrievercontext title="Permanent link">&para;</a></h3> <p><code>getRetriever(Context)</code>æ–¹æ³•ä¼šæ ¹æ®<code>@GlideModule</code>æ³¨è§£çš„ç±»ä»¥åŠ<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­meta-dataé…ç½®çš„<code>GlideModule</code>æ¥åˆ›å»ºä¸€ä¸ª<code>Glide</code>å®ä¾‹ï¼Œç„¶åè¿”å›è¯¥å®ä¾‹çš„<code>requestManagerRetriever</code>ã€‚ </p> <p>æˆ‘ä»¬è·Ÿç€æºç è¿‡ä¸€è¾¹ï¼Œé¦–å…ˆä»<code>getRetriever(Context)</code>å¼€å§‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=n>RequestManagerRetriever</span> <span class=nf>getRetriever</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Context could be null for other reasons (ie the user passes in null), but in practice it will</span>
  <span class=c1>// only occur due to errors with the Fragment lifecycle.</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span>
      <span class=n>context</span><span class=p>,</span>
      <span class=s>&quot;You cannot start a load on a not yet attached View or a Fragment where getActivity() &quot;</span>
          <span class=o>+</span> <span class=s>&quot;returns null (which usually occurs when getActivity() is called before the Fragment &quot;</span>
          <span class=o>+</span> <span class=s>&quot;is attached or after the Fragment is destroyed).&quot;</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>getRequestManagerRetriever</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p>å› å…¥å‚<code>context</code>ä¸º<code>fragment.getActivity()</code>æ—¶ï¼Œ<code>context</code>å¯èƒ½ä¸ºç©ºï¼Œæ‰€ä»¥è¿™é‡Œè¿›è¡Œäº†ä¸€æ¬¡åˆ¤æ–­ã€‚ç„¶åå°±è°ƒç”¨äº†<code>Glide.get(context)</code>åˆ›å»ºäº†ä¸€ä¸ªGlideï¼Œæœ€åå°†<code>requestManagerRetriever</code>è¿”å›å³å¯ã€‚ </p> <p>æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>Glide</code>çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>Glide</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>Glide</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>checkAndInitializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>glide</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkAndInitializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// In the thread running initGlide(), one or more classes may call Glide.get(context).</span>
  <span class=c1>// Without this check, those calls could trigger infinite recursion.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isInitializing</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;You cannot call Glide.get() in registerComponents(),&quot;</span>
        <span class=o>+</span> <span class=s>&quot; use the provided Glide instance instead&quot;</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=n>initializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>initializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=k>new</span> <span class=n>GlideBuilder</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™æ®µä»£ç æ²¡æœ‰ä»€ä¹ˆå¯è¯´çš„ï¼Œä¸‹é¢çœ‹çœ‹<code>initializeGlide</code>æ—¶å¦‚ä½•åˆ›å»º<code>Glide</code>å®ä¾‹çš„ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
  <span class=c1>// å¦‚æœæœ‰é…ç½®@GlideModuleæ³¨è§£ï¼Œé‚£ä¹ˆä¼šåå°„æ„é€ kaptç”Ÿæˆçš„GeneratedAppGlideModuleImplç±»</span>
  <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span> <span class=n>getAnnotationGeneratedGlideModules</span><span class=p>();</span>
  <span class=c1>// å¦‚æœImplå­˜åœ¨ï¼Œä¸”å…è®¸è§£æmanifestæ–‡ä»¶</span>
  <span class=c1>// åˆ™éå†manifestä¸­çš„meta-dataï¼Œè§£æå‡ºæ‰€æœ‰çš„GlideModuleç±»</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>isManifestParsingEnabled</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>).</span><span class=na>parse</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// æ ¹æ®Implçš„é»‘åå•ï¼Œå‰”é™¤manifestä¸­çš„GlideModuleç±»</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span>
        <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>();</span>
    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>excludedModuleClasses</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span> <span class=p>{</span>
        <span class=k>continue</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;AppGlideModule excludes manifest GlideModule: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Discovered GlideModule from manifest: &quot;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// å¦‚æœImplå­˜åœ¨ï¼Œé‚£ä¹ˆè®¾ç½®ä¸ºè¯¥ç±»çš„RequestManagerFactoryï¼› å¦åˆ™ï¼Œè®¾ç½®ä¸ºnull</span>
  <span class=n>RequestManagerRetriever</span><span class=p>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getRequestManagerFactory</span><span class=p>()</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
  <span class=n>builder</span><span class=p>.</span><span class=na>setRequestManagerFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span>
  <span class=c1>// ä¾æ¬¡è°ƒç”¨manifestä¸­GlideModuleç±»çš„applyOptionsæ–¹æ³•ï¼Œå°†é…ç½®å†™åˆ°builderé‡Œ</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>module</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// å†™å…¥Implçš„é…ç½®</span>
  <span class=c1>// ä¹Ÿå°±æ˜¯è¯´Implé…ç½®çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæœ‰å†²çªçš„è¯</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥è°ƒç”¨GlideBuilder.buildæ–¹æ³•åˆ›å»ºGlide</span>
  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
  <span class=c1>// ä¾æ¬¡è°ƒç”¨manifestä¸­GlideModuleç±»çš„registerComponentsæ–¹æ³•ï¼Œæ¥æ›¿æ¢Glideçš„é»˜è®¤é…ç½®</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>module</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// è°ƒç”¨Implä¸­æ›¿æ¢Glideé…ç½®çš„æ–¹æ³•</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸ºGlideå®ç°äº†ComponentCallbacks2æ¥å£</span>
  <span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
  <span class=c1>// ä¿å­˜glideå®ä¾‹åˆ°é™æ€å˜é‡ä¸­</span>
  <span class=n>Glide</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <blockquote> <p><code>applyOptions</code>ã€<code>registerComponents</code>è¿™ä¸¤ä¸ªæ–¹æ³•åé¢ä¼šè¯¦ç»†è®¨è®ºï¼Œè¿™é‡Œåªæ˜¯ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚</p> </blockquote> <p>åœ¨æˆ‘ä»¬æœ¬èŠ‚çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬<code>AndroidManifest</code>å’Œ<code>@GlideModule</code>æ³¨è§£ä¸­éƒ½æ²¡æœ‰è¿›è¡Œè¿‡é…ç½®ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç å¯ä»¥ç®€åŒ–ä¸ºï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥è°ƒç”¨GlideBuilder.buildæ–¹æ³•åˆ›å»ºGlide</span>
  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸ºGlideå®ç°äº†ComponentCallbacks2æ¥å£</span>
  <span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
  <span class=c1>// ä¿å­˜glideå®ä¾‹åˆ°é™æ€å˜é‡ä¸­</span>
  <span class=n>Glide</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>GlideBuilder.build</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=n>Glide</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>...</span>

  <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=p>(</span><span class=n>requestManagerFactory</span><span class=p>);</span>

  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=p>(</span>
      <span class=n>context</span><span class=p>,</span>
      <span class=n>engine</span><span class=p>,</span>
      <span class=n>memoryCache</span><span class=p>,</span>
      <span class=n>bitmapPool</span><span class=p>,</span>
      <span class=n>arrayPool</span><span class=p>,</span>
      <span class=n>requestManagerRetriever</span><span class=p>,</span>
      <span class=n>connectivityMonitorFactory</span><span class=p>,</span>
      <span class=n>logLevel</span><span class=p>,</span>
      <span class=n>defaultRequestOptions</span><span class=p>.</span><span class=na>lock</span><span class=p>(),</span>
      <span class=n>defaultTransitionOptions</span><span class=p>,</span>
      <span class=n>defaultRequestListeners</span><span class=p>,</span>
      <span class=n>isLoggingRequestOriginsEnabled</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œçš„<code>requestManagerRetriever</code>ç›´æ¥è°ƒç”¨äº†æ„é€ å™¨ï¼Œä¸”ä¼ å…¥å‚æ•°å®é™…ä¸Šä¸ºnullï¼Œåœ¨<code>RequestManagerRetriever</code>çš„æ„é€ å™¨æ–¹æ³•ä¸­ä¼šä¸ºæ­¤åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„<code>DEFAULT_FACTORY</code>ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RequestManagerRetriever</span> <span class=kd>implements</span> <span class=n>Handler</span><span class=p>.</span><span class=na>Callback</span> <span class=p>{</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=p>;</span>

  <span class=kd>public</span> <span class=nf>RequestManagerRetriever</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>factory</span> <span class=p>:</span> <span class=n>DEFAULT_FACTORY</span><span class=p>;</span>
    <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>(),</span> <span class=k>this</span> <span class=cm>/* Callback */</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=cm>/**</span>
<span class=cm>   * Used internally to create {@link RequestManager}s.</span>
<span class=cm>   */</span>
  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>RequestManagerFactory</span> <span class=p>{</span>
    <span class=nd>@NonNull</span>
    <span class=n>RequestManager</span> <span class=nf>build</span><span class=p>(</span>
        <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
        <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=p>,</span>
        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=p>,</span>
        <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>DEFAULT_FACTORY</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestManagerFactory</span><span class=p>()</span> <span class=p>{</span>
    <span class=nd>@NonNull</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=p>,</span>
        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=k>new</span> <span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span> <span class=n>lifecycle</span><span class=p>,</span> <span class=n>requestManagerTreeNode</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>};</span>
<span class=p>}</span>
</code></pre></div> <p>ç›®å‰ä¸ºæ­¢ï¼Œ<code>Glide</code><strong>å•ä¾‹å·²ç»è¢«åˆ›å»ºå‡ºæ¥äº†</strong>ï¼Œå…¶<code>requestManagerRetriever</code>ä¼šä½œä¸º<code>getRetriever(Context)</code>çš„è¿”å›å€¼è¿”å›ã€‚</p> <p>æ¥ä¸‹æ¥å›åˆ°<code>Glide.with</code>æ–¹æ³•ä¸­ï¼Œæ¥ç€æ‰§è¡Œçš„æ˜¯<code>RequestManagerRetriever.get</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ ¹æ®å…¥å‚æ˜¯å¯¹ç”Ÿå‘½å‘¨æœŸå¯æ„Ÿçš„ã€‚</p> <h3 id=12-requestmanagerretrieverget>1.2 RequestManagerRetriever.get<a class=headerlink href=#12-requestmanagerretrieverget title="Permanent link">&para;</a></h3> <p><code>RequestManagerRetriever.get</code>æ–¹æ³•ä¸<code>Glide.with</code>ä¸€æ ·ï¼Œä¹Ÿæœ‰å¾ˆå¤šé‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>getApplicationManager</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Either an application context or we&#39;re on a background thread.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Normally pause/resume is taken care of by the fragment we add to the fragment or</span>
        <span class=c1>// activity. However, in this case since the manager attached to the application will not</span>
        <span class=c1>// receive lifecycle events, we must force the manager to start resumed using</span>
        <span class=c1>// ApplicationLifecycle.</span>

        <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.</span>
        <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
        <span class=n>applicationManager</span> <span class=o>=</span>
            <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
                <span class=n>glide</span><span class=p>,</span>
                <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=p>(),</span>
                <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
                <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>applicationManager</span><span class=p>;</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;You cannot start a load on a null Context&quot;</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnMainThread</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Application</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>get</span><span class=p>((</span><span class=n>FragmentActivity</span><span class=p>)</span> <span class=n>context</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Activity</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>get</span><span class=p>((</span><span class=n>Activity</span><span class=p>)</span> <span class=n>context</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>ContextWrapper</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>get</span><span class=p>(((</span><span class=n>ContextWrapper</span><span class=p>)</span> <span class=n>context</span><span class=p>).</span><span class=na>getBaseContext</span><span class=p>());</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>getApplicationManager</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>assertNotDestroyed</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=p>.</span><span class=na>getSupportFragmentManager</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=p>(</span>
        <span class=n>activity</span><span class=p>,</span> <span class=n>fm</span><span class=p>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span>
        <span class=s>&quot;You cannot start a load on a fragment before it is attached or after it is destroyed&quot;</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=p>.</span><span class=na>getChildFragmentManager</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span> <span class=n>fm</span><span class=p>,</span> <span class=n>fragment</span><span class=p>,</span> <span class=n>fragment</span><span class=p>.</span><span class=na>isVisible</span><span class=p>());</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>assertNotDestroyed</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
    <span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=p>.</span><span class=na>getFragmentManager</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>fragmentGet</span><span class=p>(</span>
        <span class=n>activity</span><span class=p>,</span> <span class=n>fm</span><span class=p>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span>
      <span class=s>&quot;Unable to obtain a request manager for a view without a Context&quot;</span><span class=p>);</span>
  <span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=n>findActivity</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>());</span>
  <span class=c1>// The view might be somewhere else, like a service.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>activity</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=c1>// Support Fragments.</span>
  <span class=c1>// Although the user might have non-support Fragments attached to FragmentActivity, searching</span>
  <span class=c1>// for non-support Fragments is so expensive pre O and that should be rare enough that we</span>
  <span class=c1>// prefer to just fall back to the Activity directly.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>activity</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findSupportFragment</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=p>(</span><span class=n>FragmentActivity</span><span class=p>)</span> <span class=n>activity</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>fragment</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>)</span> <span class=p>:</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// Standard Fragments.</span>
  <span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findFragment</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>activity</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>fragment</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨è¿™äº›<code>get</code>æ–¹æ³•ä¸­ï¼Œ<strong>é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯åå°çº¿ç¨‹</strong>ï¼Œå¦‚æœæ˜¯åå°çº¿ç¨‹é‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>getApplicationManager</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>RequestManager</code>ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
<span class=n>applicationManager</span> <span class=o>=</span>
    <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
        <span class=n>glide</span><span class=p>,</span>
        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=p>(),</span>
        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
        <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</code></pre></div> <p>ç”±äºæ­¤å¤„<code>factory</code>æ˜¯<code>DEFAULT_FACTORY</code>ï¼Œæ‰€ä»¥<code>RequestManager</code>å°±æ˜¯ä¸‹é¢çš„å€¼ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span>
        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=p>(),</span>
        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
        <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</code></pre></div> <p><strong>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯åå°çº¿ç¨‹</strong>ï¼Œ<code>get(View)</code>å’Œ<code>get(Context)</code>ä¼šæ ¹æ®æƒ…å†µè°ƒç”¨<code>get(Fragment)</code>æˆ–<code>get(FragmentActivity)</code>ã€‚å…¶ä¸­<code>get(View)</code>ä¸ºäº†æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„<code>Fragment</code>æˆ–fallback <code>Activity</code>ï¼Œå†…éƒ¨æ“ä½œæ¯”è¾ƒå¤šï¼Œå¼€é”€æ¯”è¾ƒå¤§ï¼Œä¸è¦è½»æ˜“ä½¿ç”¨ã€‚</p> <p><code>get(Fragment)</code>å’Œ<code>get(FragmentActivity)</code>æ–¹æ³•éƒ½ä¼šè°ƒç”¨<code>supportFragmentGet</code>æ–¹æ³•ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸åŒï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// FragmentActivity activity</span>
<span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=p>.</span><span class=na>getSupportFragmentManager</span><span class=p>();</span>
<span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span> <span class=n>fm</span><span class=p>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>

<span class=c1>// Fragment fragment</span>
<span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=p>.</span><span class=na>getChildFragmentManager</span><span class=p>();</span>
<span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span> <span class=n>fm</span><span class=p>,</span> <span class=n>fragment</span><span class=p>,</span> <span class=n>fragment</span><span class=p>.</span><span class=na>isVisible</span><span class=p>());</span>
</code></pre></div> <blockquote> <p>Glideä¼šä½¿ç”¨ä¸€ä¸ªåŠ è½½ç›®æ ‡æ‰€åœ¨çš„å®¿ä¸»Activityæˆ–Fragmentçš„å­<code>Fragment</code>æ¥å®‰å…¨ä¿å­˜ä¸€ä¸ª<code>RequestManager</code>ï¼Œè€Œ<code>RequestManager</code>è¢«Glideç”¨æ¥å¼€å§‹ã€åœæ­¢ã€ç®¡ç†Glideè¯·æ±‚ã€‚</p> </blockquote> <p>è€Œ<code>supportFragmentGet</code>å°±æ˜¯åˆ›å»º/è·å–è¿™ä¸ª<code>SupportRequestManagerFragment</code>ï¼Œå¹¶è¿”å›å…¶æŒæœ‰çš„<code>RequestManager</code>çš„æ–¹æ³•ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>supportFragmentGet</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>isParentVisible</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// ğŸŸğŸŸğŸŸè·å–ä¸€ä¸ªSupportRequestManagerFragment</span>
  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span>
      <span class=n>getSupportRequestManagerFragment</span><span class=p>(</span><span class=n>fm</span><span class=p>,</span> <span class=n>parentHint</span><span class=p>,</span> <span class=n>isParentVisible</span><span class=p>);</span>
  <span class=c1>// è·å–é‡Œé¢çš„RequestManagerå¯¹è±¡</span>
  <span class=n>RequestManager</span> <span class=n>requestManager</span> <span class=o>=</span> <span class=n>current</span><span class=p>.</span><span class=na>getRequestManager</span><span class=p>();</span>
  <span class=c1>// è‹¥æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>requestManager</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.</span>
    <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
    <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥</span>
    <span class=n>requestManager</span> <span class=o>=</span>
        <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
            <span class=n>glide</span><span class=p>,</span> <span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>(),</span> <span class=n>current</span><span class=p>.</span><span class=na>getRequestManagerTreeNode</span><span class=p>(),</span> <span class=n>context</span><span class=p>);</span>
    <span class=c1>// è®¾ç½®åˆ°SupportRequestManagerFragmenté‡Œé¢ï¼Œä¸‹æ¬¡å°±ä¸éœ€è¦åˆ›å»ºäº†</span>
    <span class=n>current</span><span class=p>.</span><span class=na>setRequestManager</span><span class=p>(</span><span class=n>requestManager</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>requestManager</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// ğŸŸğŸŸğŸŸçœ‹çœ‹Fragmentæ€ä¹ˆæ‰èƒ½é«˜æ•ˆ</span>
<span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>SupportRequestManagerFragment</span> <span class=nf>getSupportRequestManagerFragment</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isParentVisible</span><span class=p>)</span> <span class=p>{</span>      
  <span class=c1>// å·²ç»æ·»åŠ è¿‡äº†ï¼Œå¯ä»¥ç›´æ¥è¿”å›</span>
  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span>
      <span class=p>(</span><span class=n>SupportRequestManagerFragment</span><span class=p>)</span> <span class=n>fm</span><span class=p>.</span><span class=na>findFragmentByTag</span><span class=p>(</span><span class=n>FRAGMENT_TAG</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// ä»mapä¸­è·å–ï¼Œå–åˆ°ä¹Ÿå¯ä»¥è¿”å›äº†</span>
    <span class=n>current</span> <span class=o>=</span> <span class=n>pendingSupportRequestManagerFragments</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>fm</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªï¼Œæ­¤æ—¶lifecycleé»˜è®¤ä¸ºActivityFragmentLifecycle</span>
      <span class=n>current</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SupportRequestManagerFragment</span><span class=p>();</span>
      <span class=c1>// å¯¹äºfragmentæ¥è¯´ï¼Œæ­¤æ–¹æ³•ä¼šä»¥Activityä¸ºhoståˆ›å»ºå¦å¤–ä¸€ä¸ªSupportRequestManagerFragment</span>
      <span class=c1>// ä½œä¸ºrootRequestManagerFragment</span>
      <span class=c1>// å¹¶ä¼šå°†currentåŠ å…¥åˆ°rootRequestManagerFragmentçš„childRequestManagerFragmentsä¸­</span>
      <span class=c1>// åœ¨RequestManageré€’å½’ç®¡ç†è¯·æ±‚æ—¶ä¼šä½¿ç”¨åˆ°</span>
      <span class=n>current</span><span class=p>.</span><span class=na>setParentFragmentHint</span><span class=p>(</span><span class=n>parentHint</span><span class=p>);</span>
      <span class=c1>// å¦‚æœå½“å‰é¡µé¢æ˜¯å¯è§çš„ï¼Œé‚£ä¹ˆè°ƒç”¨å…¶lifecycleçš„onStartæ–¹æ³•</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>isParentVisible</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>().</span><span class=na>onStart</span><span class=p>();</span>
      <span class=p>}</span>
      <span class=c1>// å°†åˆšåˆ›å»ºçš„fragmentç¼“å­˜èµ·æ¥</span>
      <span class=n>pendingSupportRequestManagerFragments</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>fm</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
      <span class=c1>// å°†fragmentæ·»åŠ åˆ°é¡µé¢ä¸­</span>
      <span class=n>fm</span><span class=p>.</span><span class=na>beginTransaction</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=n>FRAGMENT_TAG</span><span class=p>).</span><span class=na>commitAllowingStateLoss</span><span class=p>();</span>
      <span class=c1>// ä»¥fmä¸ºkeyä»pendingSupportRequestManagerFragmentsä¸­åˆ é™¤</span>
      <span class=n>handler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=p>,</span> <span class=n>fm</span><span class=p>).</span><span class=na>sendToTarget</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>current</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥åœ¨ä¸Šé¢çš„<code>supportFragmentGet</code>æ–¹æ³•ä¸­ï¼ŒæˆåŠŸåˆ›å»ºäº†ä¸€ä¸ª<code>RequestManager</code>å¯¹è±¡ï¼Œç”±äº<code>factory</code>æ˜¯<code>DEFAULT_FACTORY</code>ï¼Œæ‰€ä»¥å°±æ˜¯ä¸‹é¢çš„å€¼ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span>
  <span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>(),</span>          <span class=c1>// ActivityFragmentLifecycle()</span>
  <span class=n>current</span><span class=p>.</span><span class=na>getRequestManagerTreeNode</span><span class=p>(),</span>  <span class=c1>// SupportFragmentRequestManagerTreeNode()</span>
  <span class=n>context</span><span class=p>);</span>
</code></pre></div> <p>å¥½ğŸ‘ğŸ‘ğŸ‘ï¼Œåœ¨ä¸Šä¸€æ­¥ä¸­<code>Glide</code>å•ä¾‹å®Œæˆäº†åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ä¸­æˆåŠŸçš„åˆ›å»ºå¹¶è¿”å›äº†ä¸€ä¸ª<code>RequestManager</code>ã€‚<code>Glide.with</code>å·²ç»åˆ†æå®Œæ¯•ã€‚</p> <h2 id=2-requestmanagerload>2. RequestManager.load<a class=headerlink href=#2-requestmanagerload title="Permanent link">&para;</a></h2> <p><code>RequestManager.load</code>æ–¹æ³•çš„é‡è½½ä¹Ÿå¾ˆå¤šï¼Œä½†è¯¥æ–¹æ³•åªæ˜¯è®¾ç½®äº†ä¸€äº›å€¼è€Œå·²ï¼Œå¹¶æ²¡æœ‰åšä¸€äº›å¾ˆé‡çš„å·¥ä½œã€‚</p> <p>å› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°ç±»æœ‰ç‚¹ç»•ï¼Œæ‰€ä»¥åœ¨æ­£å¼æ¢ç´¢ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç›¸å…³çš„ç±»çš„UMLå›¾ï¼š</p> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/glide-request-options-uml.png> <figcaption>RequestOptionsç›¸å…³UMLå›¾</figcaption> </figure> <p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥<code>RequestBuilder</code>å’Œ<code>RequestOptions</code>éƒ½æ´¾ç”Ÿè‡ªæŠ½è±¡ç±»<code>BaseRequestOptions</code>ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>RequestManager</code>çš„ä¸€äº›æ–¹æ³•ï¼Œå…ˆçœ‹<code>load</code>çš„ä¸€äº›é‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>bitmap</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>drawable</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>drawable</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>string</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Uri</span> <span class=n>uri</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>File</span> <span class=n>file</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@RawRes</span> <span class=nd>@DrawableRes</span> <span class=nd>@Nullable</span> <span class=n>Integer</span> <span class=n>resourceId</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>resourceId</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=nd>@Deprecated</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>URL</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨æ‰€æœ‰çš„<code>RequestManager.load</code>æ–¹æ³•ä¸­éƒ½ä¼šå…ˆè°ƒç”¨<code>asDrawable()</code>æ–¹æ³•å¾—åˆ°ä¸€ä¸ª<code>RequestBuilder</code>å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨<code>RequestBuilder.load</code>æ–¹æ³•ã€‚ </p> <h3 id=21-requestmanagerasxxx>2.1 RequestManager.asXxx<a class=headerlink href=#21-requestmanagerasxxx title="Permanent link">&para;</a></h3> <p><code>asDrawable</code>æ–¹æ³•åŒå…¶ä»–asæ–¹æ³•ï¼ˆ<code>asGif</code>ã€<code>asBitmap</code>ã€<code>asFile</code>ï¼‰ä¸€æ ·ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨<code>RequestManager.as</code>æ–¹æ³•ç”Ÿæˆä¸€ä¸ª<code>RequestBuilder&lt;ResourceType&gt;</code>å¯¹è±¡ï¼Œç„¶åå„ä¸ªasæ–¹æ³•ä¼šé™„åŠ ä¸€äº›ä¸åŒçš„optionsï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>asBitmap</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_BITMAP</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>);</span>
<span class=p>}</span>  

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>asDrawable</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>asFile</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>as</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨<code>RequestBuilder</code>çš„æ„é€ å™¨æ–¹æ³•æ–¹æ³•ä¸­å°†<code>Drawable.class</code>è¿™æ ·çš„å…¥å‚ä¿å­˜åˆ°äº†<code>transcodeClass</code>å˜é‡ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;CheckResult&quot;</span><span class=p>)</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.ConstructorCallsOverridableMethod&quot;</span><span class=p>)</span>
<span class=kd>protected</span> <span class=nf>RequestBuilder</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
    <span class=n>RequestManager</span> <span class=n>requestManager</span><span class=p>,</span>
    <span class=n>Class</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
    <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>requestManager</span> <span class=o>=</span> <span class=n>requestManager</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>transcodeClass</span> <span class=o>=</span> <span class=n>transcodeClass</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>context</span> <span class=o>=</span> <span class=n>context</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>transitionOptions</span> <span class=o>=</span> <span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultTransitionOptions</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
  <span class=k>this</span><span class=p>.</span><span class=na>glideContext</span> <span class=o>=</span> <span class=n>glide</span><span class=p>.</span><span class=na>getGlideContext</span><span class=p>();</span>

  <span class=n>initRequestListeners</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultRequestListeners</span><span class=p>());</span>
  <span class=n>apply</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultRequestOptions</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div> <p>ç„¶åå›åˆ°ä¹‹å‰çš„<code>asGif</code>æ–¹æ³•ä¸­ï¼Œçœ‹çœ‹<code>apply(DECODE_TYPE_BITMAP)</code>å¹²äº†äº›ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// RequestManager</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestOptions</span> <span class=n>DECODE_TYPE_GIF</span> <span class=o>=</span> <span class=n>RequestOptions</span><span class=p>.</span><span class=na>decodeTypeOf</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>lock</span><span class=p>();</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// RequestOptions</span>
<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestOptions</span> <span class=nf>decodeTypeOf</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestOptions</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// BaseRequestOptions</span>
<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>T</span> <span class=nf>decode</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
  <span class=n>fields</span> <span class=o>|=</span> <span class=n>RESOURCE_CLASS</span><span class=p>;</span>
  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>T</span> <span class=nf>apply</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>o</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>apply</span><span class=p>(</span><span class=n>o</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>other</span> <span class=o>=</span> <span class=n>o</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isSet</span><span class=p>(</span><span class=n>other</span><span class=p>.</span><span class=na>fields</span><span class=p>,</span> <span class=n>RESOURCE_CLASS</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>other</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<span class=p>}</span>

<span class=c1>// RequestBuilder</span>
<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>apply</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>requestOptions</span><span class=p>);</span>
  <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>requestOptions</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸éš¾å‘ç°ï¼Œ<code>apply(DECODE_TYPE_BITMAP)</code>å°±æ˜¯å°†<code>BaseRequestOptions.resourceClass</code>è®¾ç½®ä¸ºäº†<code>GifDrawable.class</code>ï¼›å¯¹äº<code>asBitmap()</code>æ¥è¯´ï¼Œ<code>resourceClass</code>ä¸º<code>Bitmap.class</code>ï¼›è€Œå¯¹äº<code>asDrawable()</code>å’Œ<code>asFile()</code>æ¥è¯´ï¼Œ<code>resourceClass</code>æ²¡æœ‰è¿›è¡Œè¿‡è®¾ç½®ï¼Œæ‰€ä»¥ä¸ºé»˜è®¤å€¼<code>Object.class</code>ã€‚</p> <p>ç°åœ¨<code>RequestBuilder</code>å·²ç»ç”±asç³»åˆ—æ–¹æ³•ç”Ÿæˆï¼Œç°åœ¨æ¥ç€ä¼šè°ƒç”¨<code>RequestBuilder.load</code>æ–¹æ³•</p> <h3 id=22-requestbuilderload>2.2 RequestBuilder.load<a class=headerlink href=#22-requestbuilderload title="Permanent link">&para;</a></h3> <p><code>RequestManager.load</code>æ–¹æ³•éƒ½ä¼šè°ƒç”¨å¯¹åº”çš„<code>RequestBuilder.load</code>é‡è½½æ–¹æ³•ï¼›<code>RequestBuilder.load</code>çš„å„ä¸ªæ–¹æ³•åŸºæœ¬ä¸Šéƒ½ä¼šç›´æ¥è½¬å‘ç»™<code>loadGeneric</code>æ–¹æ³•ï¼Œåªæœ‰å°‘æ•°çš„æ–¹æ³•æ‰ä¼šapplyé¢å¤–çš„optionsã€‚</p> <p><code>loadGeneric</code>æ–¹æ³•ä¹Ÿåªæ˜¯ä¿å­˜ä¸€ä¸‹å‚æ•°è€Œå·²ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>bitmap</span><span class=p>)</span>
      <span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>drawable</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>drawable</span><span class=p>)</span>
      <span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Uri</span> <span class=n>uri</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>File</span> <span class=n>file</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@RawRes</span> <span class=nd>@DrawableRes</span> <span class=nd>@Nullable</span> <span class=n>Integer</span> <span class=n>resourceId</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>resourceId</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>signatureOf</span><span class=p>(</span><span class=n>ApplicationVersionSignature</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>context</span><span class=p>)));</span>
<span class=p>}</span>

<span class=nd>@Deprecated</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>URL</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isDiskCacheStrategySet</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isSkipMemoryCacheSet</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span> <span class=cm>/*skipMemoryCache*/</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>loadGeneric</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>model</span> <span class=o>=</span> <span class=n>model</span><span class=p>;</span>
  <span class=n>isModelSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>å¦‚ä¸Šé¢æœ€åçš„æ–¹æ³•<code>loadGeneric</code>ï¼Œè¿™é‡Œåªæ˜¯å°†å‚æ•°ä¿å­˜åœ¨<code>model</code>ä¸­å¹¶è®¾ç½®<code>isModelSet=true</code>å°±å®Œäº†ï¼Œçœ‹æ¥Glideè¿›è¡Œå›¾ç‰‡åŠ è½½çš„æœ€æ ¸å¿ƒçš„æ­¥éª¤åº”è¯¥å°±æ˜¯<code>RequestBuilder.into</code>æ–¹æ³•äº†ã€‚</p> <h2 id=3-requestbuilderinto>3. RequestBuilder.into<a class=headerlink href=#3-requestbuilderinto title="Permanent link">&para;</a></h2> <p>Glideä¸‰æ­¥ä¸­å‰ä¸¤æ­¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼ŒçœŸæ­£ä»¤äººå¤´å¤§çš„ä½ç½®å°±æ˜¯æœ¬èŠ‚è¦æ·±å…¥æ¢ç´¢çš„<code>into</code>æ–¹æ³•äº†ã€‚å› ä¸ºGlideå„ç§é…ç½®ç›¸å½“å¤šï¼Œå„ç§åˆ†æ”¯å…¨éƒ¨åˆ—å‡ºæ¥è¿˜æ˜¯ç›¸å½“ç¹ççš„ï¼Œè€Œä¸”ä¸€æ¬¡æ€§å…¨éƒ¨çœ‹å®Œä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚æ‰€ä»¥æ­¤å¤„åªæ¢ç´¢æœ€åŸºæœ¬çš„æºç ã€‚</p> <p><code>RequestBuilder.into</code>æœ‰å››ä¸ªé‡è½½æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½è°ƒç”¨äº†å‚æ•°æœ€å¤šçš„ä¸€ä¸ªï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>into</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@Synthetic</span>
<span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>into</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>targetListener</span><span class=p>,</span> <span class=cm>/*options=*/</span> <span class=k>this</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>options</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>...</span> <span class=c1>//è§åæ–‡åˆ†è§£</span>
<span class=p>}</span>

<span class=c1>// ğŸ¤šğŸ¤šğŸ¤š è¿™æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸€ä¸ªé‡è½½</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>into</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// sanity check</span>
  <span class=n>Util</span><span class=p>.</span><span class=na>assertMainThread</span><span class=p>();</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>

  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
  <span class=c1>// è‹¥æ²¡æœ‰æŒ‡å®štransformï¼ŒisTransformationSet()ä¸ºfalse</span>
  <span class=c1>// isTransformationAllowed()ä¸€èˆ¬ä¸ºtrueï¼Œé™¤éä¸»åŠ¨è°ƒç”¨äº†dontTransform()æ–¹æ³•</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationSet</span><span class=p>()</span>
      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationAllowed</span><span class=p>()</span>
      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=p>.</span><span class=na>getScaleType</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then</span>
    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous</span>
    <span class=c1>// View&#39;s scale type.</span>
    <span class=c1>//</span>
    <span class=c1>// æ ¹æ®ImageViewçš„ScaleTypeè®¾ç½®ä¸åŒçš„down sampleå’Œtransformé€‰é¡¹</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getScaleType</span><span class=p>())</span> <span class=p>{</span>
      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=p>:</span>
        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterCrop</span><span class=p>();</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=p>:</span>
        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterInside</span><span class=p>();</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=p>:</span>  <span class=c1>// é»˜è®¤å€¼</span>
      <span class=k>case</span> <span class=n>FIT_START</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>FIT_END</span><span class=p>:</span>
        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalFitCenter</span><span class=p>();</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>FIT_XY</span><span class=p>:</span>
        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterInside</span><span class=p>();</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>CENTER</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>MATRIX</span><span class=p>:</span>
      <span class=k>default</span><span class=p>:</span>
        <span class=c1>// Do nothing.</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// è°ƒç”¨ä¸Šé¢çš„é‡è½½æ–¹æ³•</span>
  <span class=k>return</span> <span class=n>into</span><span class=p>(</span>
      <span class=n>glideContext</span><span class=p>.</span><span class=na>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>),</span>
      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span>
      <span class=n>requestOptions</span><span class=p>,</span>
      <span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬çœ‹çœ‹<code>into(ImageView)</code>æ–¹æ³•çš„å®ç°ï¼Œé‡Œé¢ä¼šå…ˆåˆ¤æ–­éœ€ä¸éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œè£åˆ‡ï¼Œç„¶åè°ƒç”¨åˆ«çš„<code>into</code>é‡è½½æ–¹æ³•ã€‚é‡è½½æ–¹æ³•æˆ‘ä»¬ç¨ååœ¨è¯´ï¼Œå…ˆçœ‹çœ‹caseä¸ºé»˜è®¤å€¼<code>FIT_CENTER</code>æ—¶çš„æƒ…å†µï¼š</p> <p>é¦–å…ˆä¼šè°ƒç”¨<code>requestOptions.clone()</code>å¯¹åŸå§‹çš„RequestOptionsè¿›è¡Œå¤åˆ¶ï¼Œå…¶ç›®çš„æºç ä¸­å†™äº†ï¼šå½“ä½¿ç”¨æ­¤RequestOptionsåŠ è½½åˆ°ä¸€ä¸ªViewï¼Œç„¶ååŠ è½½åˆ°å¦å¤–ä¸€ä¸ªç›®æ ‡æ—¶ï¼Œä¸è¦ä¿ç•™åŸºäºä¸Šä¸€ä¸ªViewçš„scale typeæ‰€äº§ç”Ÿçš„transformationã€‚ </p> <p>å¤åˆ¶å®Œæˆä¹‹åï¼Œç„¶åä¼šæ¥ç€è°ƒç”¨<code>optionalFitCenter()</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>T</span> <span class=nf>optionalFitCenter</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>optionalScaleOnlyTransform</span><span class=p>(</span><span class=n>DownsampleStrategy</span><span class=p>.</span><span class=na>FIT_CENTER</span><span class=p>,</span> <span class=k>new</span> <span class=n>FitCenter</span><span class=p>());</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>T</span> <span class=nf>optionalScaleOnlyTransform</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>strategy</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>scaleOnlyTransform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/*isTransformationRequired*/</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>T</span> <span class=nf>scaleOnlyTransform</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>strategy</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>isTransformationRequired</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>BaseRequestOptions</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>isTransformationRequired</span>
        <span class=o>?</span> <span class=n>transform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>)</span> <span class=p>:</span> <span class=n>optionalTransform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>);</span>
  <span class=n>result</span><span class=p>.</span><span class=na>isScaleOnlyOrNoTransform</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=k>return</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>,</span> <span class=s>&quot;CheckResult&quot;</span><span class=p>})</span>
<span class=nd>@NonNull</span>
<span class=kd>final</span> <span class=n>T</span> <span class=nf>optionalTransform</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>downsampleStrategy</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// isAutoCloneEnabledé»˜è®¤ä¸ºfalseï¼Œåªæœ‰åœ¨ä¸»åŠ¨è°ƒç”¨äº†autoClone()æ–¹æ³•ä¹‹åæ‰ä¼šä¸ºtrue</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>optionalTransform</span><span class=p>(</span><span class=n>downsampleStrategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>downsample</span><span class=p>(</span><span class=n>downsampleStrategy</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>transform</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span> <span class=cm>/*isRequired=*/</span> <span class=kc>false</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=n>T</span> <span class=nf>downsample</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>strategy</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>set</span><span class=p>(</span><span class=n>DownsampleStrategy</span><span class=p>.</span><span class=na>OPTION</span><span class=p>,</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>strategy</span><span class=p>));</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@CheckResult</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>set</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Option</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>option</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>value</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>option</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>option</span><span class=p>);</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
  <span class=n>options</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>option</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=n>T</span> <span class=nf>transform</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isRequired</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>transform</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>DrawableTransformation</span> <span class=n>drawableTransformation</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>DrawableTransformation</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=n>transform</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=n>transform</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>drawableTransformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=c1>// TODO: remove BitmapDrawable decoder and this transformation.</span>
  <span class=c1>// Registering as BitmapDrawable is simply an optimization to avoid some iteration and</span>
  <span class=c1>// isAssignableFrom checks when obtaining the transformation later on. It can be removed without</span>
  <span class=c1>// affecting the functionality.</span>
  <span class=n>transform</span><span class=p>(</span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>drawableTransformation</span><span class=p>.</span><span class=na>asBitmapDrawable</span><span class=p>(),</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=n>transform</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>GifDrawableTransformation</span><span class=p>(</span><span class=n>transformation</span><span class=p>),</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>transform</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>isRequired</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>transform</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>transformation</span><span class=p>);</span>
  <span class=n>transformations</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transformation</span><span class=p>);</span>
  <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION</span><span class=p>;</span>
  <span class=n>isTransformationAllowed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION_ALLOWED</span><span class=p>;</span>
  <span class=c1>// Always set to false here. Known scale only transformations will call this method and then</span>
  <span class=c1>// set isScaleOnlyOrNoTransform to true immediately after.</span>
  <span class=n>isScaleOnlyOrNoTransform</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isRequired</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION_REQUIRED</span><span class=p>;</span>
    <span class=n>isTransformationRequired</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™äº›æ“ä½œå®é™…ä¸Šåªæ˜¯å‡ ä¸ªå€¼ä¿å­˜åˆ°<code>BaseRequestOptions</code>å†…éƒ¨çš„ä¸¤ä¸ª<code>CachedHashCodeArrayMap</code>é‡Œé¢ï¼Œå…¶ä¸­é”®å€¼å¯¹ä»¥åŠä¿å­˜åˆ°çš„ä½ç½®å¦‚ä¸‹ï¼š</p> <figcaption>optionalFitCenter()è¿‡ç¨‹ä¿å­˜çš„KV</figcaption> <table> <thead> <tr> <th>ä¿å­˜çš„ä½ç½®</th> <th>K</th> <th>V</th> </tr> </thead> <tbody> <tr> <td>Options.values</td> <td>DownsampleStrategy.OPTION</td> <td>DownsampleStrategy.FitCenter()</td> </tr> <tr> <td>transformations</td> <td>Bitmap.class</td> <td>FitCenter()</td> </tr> <tr> <td>transformations</td> <td>Drawable.class</td> <td>DrawableTransformation(FitCenter(), false)</td> </tr> <tr> <td>transformations</td> <td>BitmapDrawable.class</td> <td>DrawableTransformation(FitCenter(), false).asBitmapDrawable()</td> </tr> <tr> <td>transformations</td> <td>GifDrawable.class</td> <td>GifDrawableTransformation(FitCenter())</td> </tr> </tbody> </table> <p>å°†KVä¿å­˜å¥½äº†ä¹‹åï¼Œå°±å‡†å¤‡è°ƒç”¨æœ€ç»ˆçš„<code>into</code>æ–¹æ³•äº†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¥å‚ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>into</span><span class=p>(</span>
    <span class=n>glideContext</span><span class=p>.</span><span class=na>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>),</span>
    <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span>
    <span class=n>requestOptions</span><span class=p>,</span>
    <span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
</code></pre></div> <p>ç¬¬ä¸€ä¸ªå‚æ•°ç­‰äº<code>(ViewTarget&lt;ImageView, Drawable&gt;) new DrawableImageViewTarget(view)</code>ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// GlideContext</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>X</span><span class=o>&gt;</span> <span class=nf>buildImageViewTarget</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>imageView</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// imageViewTargetFactoryæ˜¯ImageViewTargetFactoryçš„ä¸€ä¸ªå®ä¾‹</span>
  <span class=c1>// transcodeClassåœ¨RequestManager.loadæ–¹æ³•ä¸­ç¡®å®šäº†ï¼Œå°±æ˜¯Drawable.class</span>
  <span class=k>return</span> <span class=n>imageViewTargetFactory</span><span class=p>.</span><span class=na>buildTarget</span><span class=p>(</span><span class=n>imageView</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// ImageViewTargetFactory</span>
<span class=nd>@NonNull</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=nf>buildTarget</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>clazz</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=k>new</span> <span class=n>BitmapImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>clazz</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// è¿”å›çš„æ˜¯(ViewTarget&lt;ImageView, Drawable&gt;) new DrawableImageViewTarget(view);</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=k>new</span> <span class=n>DrawableImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span>
        <span class=s>&quot;Unhandled class: &quot;</span> <span class=o>+</span> <span class=n>clazz</span> <span class=o>+</span> <span class=s>&quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>Executors.mainThreadExecutor()</code>å°±æ˜¯ä¸€ä¸ªä½¿ç”¨MainLooperçš„Handlerï¼Œåœ¨execute Runnableæ—¶ä½¿ç”¨æ­¤Handler postå‡ºå»ã€‚</p> <div class=highlight><pre><span></span><code>  <span class=cm>/** Posts executions to the main thread. */</span>
  <span class=kd>public</span> <span class=kd>static</span> <span class=n>Executor</span> <span class=nf>mainThreadExecutor</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>MAIN_THREAD_EXECUTOR</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>MAIN_THREAD_EXECUTOR</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>Executor</span><span class=p>()</span> <span class=p>{</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>());</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>command</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>handler</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
        <span class=p>}</span>
      <span class=p>};</span>
</code></pre></div> <p>ç°åœ¨æˆ‘ä»¬ç»ˆäºå›åˆ°äº†æœ€ç»ˆçš„<code>load</code>é‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span>
    <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>options</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// sanity check</span>
  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isModelSet</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;You must call #load() before calling #into()&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// åˆ›å»ºäº†ä¸€ä¸ªSingleRequestï¼Œè§åé¢ï¸â›°ï¸â›°ï¸â›°ï¸</span>
  <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>buildRequest</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>targetListener</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>

  <span class=c1>// è¿™é‡Œä¼šåˆ¤æ–­éœ€ä¸éœ€è¦é‡æ–°å¼€å§‹ä»»åŠ¡</span>
  <span class=c1>// å¦‚æœå½“å‰requestå’Œtargetä¸Šä¹‹å‰çš„request previousç›¸ç­‰</span>
  <span class=c1>// ä¸”è®¾ç½®äº†å¿½ç•¥å†…å­˜ç¼“å­˜æˆ–previousè¿˜æ²¡æœ‰å®Œæˆ</span>
  <span class=c1>// é‚£ä¹ˆä¼šè¿›å…¥ifåˆ†æ”¯ï¼Œæ— éœ€è¿›è¡Œä¸€äº›ç›¸å…³è®¾ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¼˜åŒ–</span>
  <span class=n>Request</span> <span class=n>previous</span> <span class=o>=</span> <span class=n>target</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isEquivalentTo</span><span class=p>(</span><span class=n>previous</span><span class=p>)</span>
      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSkipMemoryCacheWithCompletePreviousRequest</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>previous</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>request</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
    <span class=c1>// If the request is completed, beginning again will ensure the result is re-delivered,</span>
    <span class=c1>// triggering RequestListeners and Targets. If the request is failed, beginning again will</span>
    <span class=c1>// restart the request, giving it another chance to complete. If the request is already</span>
    <span class=c1>// running, we can let it continue running without interruption.</span>
    <span class=c1>// å¦‚æœæ­£åœ¨è¿è¡Œï¼Œå°±ä¸ç®¡å®ƒï¼›å¦‚æœå·²ç»å¤±è´¥äº†ï¼Œå°±é‡æ–°å¼€å§‹</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>previous</span><span class=p>).</span><span class=na>isRunning</span><span class=p>())</span> <span class=p>{</span>
      <span class=c1>// Use the previous request rather than the new one to allow for optimizations like skipping</span>
      <span class=c1>// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions</span>
      <span class=c1>// that are done in the individual Request.</span>
      <span class=n>previous</span><span class=p>.</span><span class=na>begin</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>target</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// å¦‚æœä¸èƒ½å¤ç”¨previous</span>
  <span class=c1>// å…ˆæ¸…é™¤targetä¸Šä¹‹å‰çš„Request</span>
  <span class=n>requestManager</span><span class=p>.</span><span class=na>clear</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
  <span class=c1>// å°†Requestä½œä¸ºtagè®¾ç½®åˆ°viewä¸­</span>
  <span class=n>target</span><span class=p>.</span><span class=na>setRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
  <span class=c1>// ğŸ˜·ğŸ˜·ğŸ˜· çœŸæ­£å¼€å§‹ç½‘ç»œå›¾ç‰‡çš„åŠ è½½</span>
  <span class=n>requestManager</span><span class=p>.</span><span class=na>track</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>

  <span class=k>return</span> <span class=n>target</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h3 id=31-buildrequest>3.1 buildRequest<a class=headerlink href=#31-buildrequest title="Permanent link">&para;</a></h3> <p>â›°ï¸â›°ï¸â›°ï¸ è¿™é‡Œè·Ÿè¸ªä¸€ä¸‹<code>buildRequest</code>çš„æµç¨‹ï¼Œçœ‹çœ‹æ˜¯å¦‚ä½•åˆ›å»ºå‡º<code>SingleRequest</code>çš„ã€‚</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>Request</span> <span class=nf>buildRequest</span><span class=p>(</span>
    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>buildRequestRecursive</span><span class=p>(</span>
      <span class=n>target</span><span class=p>,</span>
      <span class=n>targetListener</span><span class=p>,</span>                       <span class=c1>// null</span>
      <span class=cm>/*parentCoordinator=*/</span> <span class=kc>null</span><span class=p>,</span>
      <span class=n>transitionOptions</span><span class=p>,</span>
      <span class=n>requestOptions</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span>         <span class=c1>// Priority.NORMAL</span>
      <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOverrideWidth</span><span class=p>(),</span>    <span class=c1>// UNSET</span>
      <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOverrideHeight</span><span class=p>(),</span>   <span class=c1>// UNSET</span>
      <span class=n>requestOptions</span><span class=p>,</span>
      <span class=n>callbackExecutor</span><span class=p>);</span>                    <span class=c1>// Executors.mainThreadExecutor()</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>Request</span> <span class=nf>buildRequestRecursive</span><span class=p>(</span>
    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestCoordinator</span> <span class=n>parentCoordinator</span><span class=p>,</span>
    <span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?</span> <span class=kd>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>

  <span class=c1>// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span>
  <span class=n>ErrorRequestCoordinator</span> <span class=n>errorRequestCoordinator</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=c1>// errorBuilderä¸ºnull, skip</span>
  <span class=c1>// å› æ­¤errorRequestCoordinatorä¸ºnull</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>errorBuilder</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>errorRequestCoordinator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ErrorRequestCoordinator</span><span class=p>(</span><span class=n>parentCoordinator</span><span class=p>);</span>
    <span class=n>parentCoordinator</span> <span class=o>=</span> <span class=n>errorRequestCoordinator</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// å¦‚ä½•è·å¾—SingleRequest</span>
  <span class=n>Request</span> <span class=n>mainRequest</span> <span class=o>=</span>
      <span class=n>buildThumbnailRequestRecursive</span><span class=p>(</span>
          <span class=n>target</span><span class=p>,</span>
          <span class=n>targetListener</span><span class=p>,</span>       <span class=c1>// null</span>
          <span class=n>parentCoordinator</span><span class=p>,</span>    <span class=c1>// null</span>
          <span class=n>transitionOptions</span><span class=p>,</span>
          <span class=n>priority</span><span class=p>,</span>
          <span class=n>overrideWidth</span><span class=p>,</span>
          <span class=n>overrideHeight</span><span class=p>,</span>
          <span class=n>requestOptions</span><span class=p>,</span>
          <span class=n>callbackExecutor</span><span class=p>);</span>

  <span class=c1>// errorRequestCoordinatorä¸ºnull</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>errorRequestCoordinator</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>mainRequest</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>Request</span> <span class=nf>buildThumbnailRequestRecursive</span><span class=p>(</span>
    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
    <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=nd>@Nullable</span> <span class=n>RequestCoordinator</span> <span class=n>parentCoordinator</span><span class=p>,</span>
    <span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?</span> <span class=kd>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// thumbnailé‡è½½æ–¹æ³•æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œæ‰€ä»¥ä¼šèµ°æœ€åçš„else case</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>thumbnailBuilder</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>thumbSizeMultiplier</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// Base case: no thumbnail.</span>
    <span class=k>return</span> <span class=n>obtainRequest</span><span class=p>(</span>
        <span class=n>target</span><span class=p>,</span>
        <span class=n>targetListener</span><span class=p>,</span>
        <span class=n>requestOptions</span><span class=p>,</span>
        <span class=n>parentCoordinator</span><span class=p>,</span>
        <span class=n>transitionOptions</span><span class=p>,</span>
        <span class=n>priority</span><span class=p>,</span>
        <span class=n>overrideWidth</span><span class=p>,</span>
        <span class=n>overrideHeight</span><span class=p>,</span>
        <span class=n>callbackExecutor</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>Request</span> <span class=nf>obtainRequest</span><span class=p>(</span>
    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
    <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
    <span class=n>RequestCoordinator</span> <span class=n>requestCoordinator</span><span class=p>,</span>
    <span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?</span> <span class=kd>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>SingleRequest</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span>
      <span class=n>context</span><span class=p>,</span>
      <span class=n>glideContext</span><span class=p>,</span>
      <span class=n>model</span><span class=p>,</span>
      <span class=n>transcodeClass</span><span class=p>,</span>
      <span class=n>requestOptions</span><span class=p>,</span>
      <span class=n>overrideWidth</span><span class=p>,</span>
      <span class=n>overrideHeight</span><span class=p>,</span>
      <span class=n>priority</span><span class=p>,</span>
      <span class=n>target</span><span class=p>,</span>
      <span class=n>targetListener</span><span class=p>,</span>
      <span class=n>requestListeners</span><span class=p>,</span>
      <span class=n>requestCoordinator</span><span class=p>,</span>
      <span class=n>glideContext</span><span class=p>.</span><span class=na>getEngine</span><span class=p>(),</span>
      <span class=n>transitionOptions</span><span class=p>.</span><span class=na>getTransitionFactory</span><span class=p>(),</span>
      <span class=n>callbackExecutor</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p><code>SingleRequest</code>çš„åˆå§‹çŠ¶æ€ä¸º<code>Status.PENDING</code>ã€‚</p> <h3 id=32-requestmanagertrack>3.2 RequestManager.track<a class=headerlink href=#32-requestmanagertrack title="Permanent link">&para;</a></h3> <p>ğŸ˜·ğŸ˜·ğŸ˜·ä¸‹é¢å¼€å§‹åˆ†æ<code>RequestManager.track</code>çš„æµç¨‹</p> <div class=highlight><pre><span></span><code><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>track</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Target</span><span class=o>&lt;?&gt;</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>targetTracker</span><span class=p>.</span><span class=na>track</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
  <span class=n>requestTracker</span><span class=p>.</span><span class=na>runRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨è¿™é‡Œé¢ï¼Œ<code>targetTracker</code>æˆå‘˜å˜é‡åœ¨å£°æ˜çš„æ—¶å€™ç›´æ¥åˆå§‹åŒ–ä¸º<code>TargetTracker</code>ç±»çš„æ— å‚æ•°å®ä¾‹ï¼Œè¯¥ç±»çš„ä½œç”¨æ˜¯ä¿å­˜æ‰€æœ‰çš„Targetå¹¶å‘å®ƒä»¬è½¬å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼›<code>requestTracker</code>åœ¨<code>RequestManager</code>çš„æ„é€ å™¨ä¸­ä¼ å…¥äº†<code>new RequestTracker()</code>ï¼Œè¯¥ç±»çš„ä½œç”¨ç®¡ç†æ‰€æœ‰çŠ¶æ€çš„è¯·æ±‚ã€‚</p> <p><code>targetTracker.track(target)</code>å°†targetä¿å­˜åˆ°äº†å†…éƒ¨çš„<code>targets</code>ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>final</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Target</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>targets</span> <span class=o>=</span>
    <span class=n>Collections</span><span class=p>.</span><span class=na>newSetFromMap</span><span class=p>(</span><span class=k>new</span> <span class=n>WeakHashMap</span><span class=o>&lt;</span><span class=n>Target</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>Boolean</span><span class=o>&gt;</span><span class=p>());</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>track</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Target</span><span class=o>&lt;?&gt;</span> <span class=n>target</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>targets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸‹é¢çœ‹çœ‹<code>requestTracker.runRequest(request)</code>å¹²äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm>  * Starts tracking the given request.</span>
<span class=cm>  */</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>runRequest</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>requests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isPaused</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>request</span><span class=p>.</span><span class=na>begin</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>request</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Paused, delaying request&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>pendingRequests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>isPaused</code>é»˜è®¤ä¸ºfalseï¼Œåªæœ‰è°ƒç”¨äº†<code>RequestTracker.pauseRequests</code>æˆ–<code>RequestTracker.pauseAllRequests</code>åæ‰ä¼šä¸ºtrueã€‚<br> å› æ­¤ï¼Œä¸‹é¢ä¼šæ‰§è¡Œ<code>request.begin()</code>æ–¹æ³•ã€‚ä¸Šé¢è¯´åˆ°è¿‡ï¼Œè¿™é‡Œçš„requestå®é™…ä¸Šæ˜¯<code>SingleRequest</code>å¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„<code>begin()</code>æ–¹æ³•ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>begin</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// sanity check</span>
  <span class=n>assertNotCallingCallbacks</span><span class=p>();</span>
  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
  <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
  <span class=c1>// å¦‚æœmodelä¸ºç©ºï¼Œä¼šè°ƒç”¨ç›‘å¬å™¨çš„onLoadFailedå¤„ç†</span>
  <span class=c1>// è‹¥æ— æ³•å¤„ç†ï¼Œåˆ™å±•ç¤ºå¤±è´¥æ—¶çš„å ä½å›¾</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>model</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isValidDimensions</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span> <span class=n>overrideHeight</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>width</span> <span class=o>=</span> <span class=n>overrideWidth</span><span class=p>;</span>
      <span class=n>height</span> <span class=o>=</span> <span class=n>overrideHeight</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=c1>// Only log at more verbose log levels if the user has set a fallback drawable, because</span>
    <span class=c1>// fallback Drawables indicate the user expects null models occasionally.</span>
    <span class=kt>int</span> <span class=n>logLevel</span> <span class=o>=</span> <span class=n>getFallbackDrawable</span><span class=p>()</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Log</span><span class=p>.</span><span class=na>WARN</span> <span class=p>:</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>;</span>
    <span class=n>onLoadFailed</span><span class=p>(</span><span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Received null model&quot;</span><span class=p>),</span> <span class=n>logLevel</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Cannot restart a running request&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// If we&#39;re restarted after we&#39;re complete (usually via something like a notifyDataSetChanged</span>
  <span class=c1>// that starts an identical request into the same Target or View), we can simply use the</span>
  <span class=c1>// resource and size we retrieved the last time around and skip obtaining a new size, starting a</span>
  <span class=c1>// new load etc. This does mean that users who want to restart a load because they expect that</span>
  <span class=c1>// the view size has changed will need to explicitly clear the View or Target before starting</span>
  <span class=c1>// the new load.</span>
  <span class=c1>//</span>
  <span class=c1>// å¦‚æœæˆ‘ä»¬åœ¨è¯·æ±‚å®Œæˆåæƒ³é‡æ–°å¼€å§‹åŠ è½½ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›å·²ç»åŠ è½½å¥½çš„èµ„æº</span>
  <span class=c1>// å¦‚æœç”±äºviewå°ºå¯¸çš„æ”¹å˜ï¼Œæˆ‘ä»¬çš„ç¡®éœ€è¦é‡æ–°æ¥åŠ è½½ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ˜ç¡®åœ°æ¸…é™¤Viewæˆ–Target</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>onResourceReady</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// Restarts for requests that are neither complete nor running can be treated as new requests</span>
  <span class=c1>// and can run again from the beginning.</span>
  <span class=c1>//</span>
  <span class=c1>// è¯·æ±‚å²‚æ²¡æœ‰å®Œæˆä¹Ÿæ²¡æœ‰åœ¨è¿è¡Œï¼Œå°±å½“ä½œæ–°è¯·æ±‚æ¥å¯¹å¾…ã€‚æ­¤æ—¶å¯ä»¥ä»beginningå¼€å§‹è¿è¡Œ</span>

  <span class=c1>// å¦‚æœæŒ‡å®šäº†overrideWidthå’ŒoverrideHeightï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨onSizeReadyæ–¹æ³•</span>
  <span class=c1>// å¦åˆ™ä¼šè·å–ImageViewçš„å®½ã€é«˜ï¼Œç„¶åè°ƒç”¨onSizeReadyæ–¹æ³•</span>
  <span class=c1>// åœ¨è¯¥æ–¹æ³•ä¸­ä¼šåˆ›å»ºå›¾ç‰‡åŠ è½½çš„Jobå¹¶å¼€å§‹æ‰§è¡Œ</span>
  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isValidDimensions</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span> <span class=n>overrideHeight</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>onSizeReady</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span> <span class=n>overrideHeight</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>target</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// æ˜¾ç¤ºåŠ è½½ä¸­çš„å ä½ç¬¦</span>
  <span class=k>if</span> <span class=p>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span>
      <span class=o>&amp;&amp;</span> <span class=n>canNotifyStatusChanged</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>target</span><span class=p>.</span><span class=na>onLoadStarted</span><span class=p>(</span><span class=n>getPlaceholderDrawable</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished run method in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>begin</code>æ–¹æ³•å¯ä»¥åˆ†ä¸ºå‡ ä¸ªå¤§æ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤çš„ç”¨é€”å·²ç»åœ¨ä»£ç ä¸­è¿›è¡Œæ³¨é‡Šäº†ã€‚</p> <p>è·Ÿç€ä»£ç ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<code>model = null</code>æ—¶ï¼Œ<code>onLoadFailed(new GlideException("Received null model"), logLevel);</code>å¹²äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxLogLevel</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
  <span class=n>e</span><span class=p>.</span><span class=na>setOrigin</span><span class=p>(</span><span class=n>requestOrigin</span><span class=p>);</span>
  <span class=kt>int</span> <span class=n>logLevel</span> <span class=o>=</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getLogLevel</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>logLevel</span> <span class=o>&lt;=</span> <span class=n>maxLogLevel</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>,</span> <span class=s>&quot;Load failed for &quot;</span> <span class=o>+</span> <span class=n>model</span> <span class=o>+</span> <span class=s>&quot; with size [&quot;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&quot;x&quot;</span> <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&quot;]&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>logLevel</span> <span class=o>&lt;=</span> <span class=n>Log</span><span class=p>.</span><span class=na>INFO</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>e</span><span class=p>.</span><span class=na>logRootCauses</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// è®¾ç½®çŠ¶æ€ä¸ºStatus.FAILED</span>
  <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>FAILED</span><span class=p>;</span>

  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=c1>//TODO: what if this is a thumbnail request?</span>
    <span class=c1>// å°è¯•è°ƒç”¨å„ä¸ªlistenerçš„onLoadFailedå›è°ƒè¿›è¡Œå¤„ç†</span>
    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=p>:</span> <span class=n>requestListeners</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
            <span class=n>listener</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>isFirstReadyResource</span><span class=p>());</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>isFirstReadyResource</span><span class=p>());</span>

    <span class=c1>// å¦‚æœæ²¡æœ‰ä¸€ä¸ªå›è°ƒèƒ½å¤Ÿå¤„ç†ï¼Œé‚£ä¹ˆæ˜¾ç¤ºå¤±è´¥å ä½ç¬¦</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>setErrorPlaceholder</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// é€šçŸ¥requestCoordinatorï¼Œæ­¤è¯·æ±‚å¤±è´¥</span>
  <span class=n>notifyLoadFailed</span><span class=p>();</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyLoadFailed</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>requestCoordinator</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>requestCoordinator</span><span class=p>.</span><span class=na>onRequestFailed</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>çœ‹ä¸€ä¸‹<code>setErrorPlaceholder</code>ä¸­æ˜¾ç¤ºå¤±è´¥å ä½ç¬¦çš„é€»è¾‘ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setErrorPlaceholder</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>canNotifyStatusChanged</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>Drawable</span> <span class=n>error</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>model</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>error</span> <span class=o>=</span> <span class=n>getFallbackDrawable</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=c1>// Either the model isn&#39;t null, or there was no fallback drawable set.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>error</span> <span class=o>=</span> <span class=n>getErrorDrawable</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=c1>// The model isn&#39;t null, no fallback drawable was set or no error drawable was set.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>error</span> <span class=o>=</span> <span class=n>getPlaceholderDrawable</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=n>target</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œçš„<code>target</code>æ˜¯<code>DrawableImageViewTarget</code>ç±»å‹ï¼Œ<code>onLoadFailed</code>æ–¹æ³•çš„é€»è¾‘å®ç°åœ¨å…¶çˆ¶ç±»<code>ImageViewTarget</code>ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>errorDrawable</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>super</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>errorDrawable</span><span class=p>);</span>
  <span class=n>setResourceInternal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
  <span class=n>setDrawable</span><span class=p>(</span><span class=n>errorDrawable</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setDrawable</span><span class=p>(</span><span class=n>Drawable</span> <span class=n>drawable</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>view</span><span class=p>.</span><span class=na>setImageDrawable</span><span class=p>(</span><span class=n>drawable</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>æ˜¾è€Œæ˜“è§ï¼Œå½“modelä¸ºnullæ—¶ï¼Œå¤±è´¥å ä½ç¬¦çš„æ˜¾ç¤ºé€»è¾‘å¦‚ä¸‹ï¼š</p> <ol> <li>å¦‚æœè®¾ç½®äº†fallbackï¼Œé‚£ä¹ˆæ˜¾ç¤ºfallback</li> <li>å¦åˆ™ï¼Œå¦‚æœè®¾ç½®äº†errorï¼Œé‚£ä¹ˆæ˜¾ç¤ºerror</li> <li>å¦åˆ™ï¼Œå¦‚æœè®¾ç½®äº†placeholderï¼Œé‚£ä¹ˆæ˜¾ç¤ºplaceholder</li> </ol> <blockquote> <p>è¿™ä¹Ÿè¯æ˜äº†<a href=/android/3rd-library/glide1/#21>Glide v4 æºç è§£æï¼ˆä¸€ï¼‰--- å ä½ç¬¦</a>ä¸­ï¼Œå…³äºmodelä¸ºnulléƒ¨åˆ†çš„æµç¨‹æ˜¯æ­£ç¡®çš„ã€‚</p> </blockquote> <p>å›åˆ°<code>SingleRequest.begin()</code>æ–¹æ³•ä¸­ã€‚<br> åˆ¤æ–­å®Œmodelæ˜¯å¦ä¸ºnullåï¼Œä¸‹é¢ä¼šåˆ¤æ–­statusæ˜¯å¦ä¸º<code>Status.COMPLETE</code>ã€‚å¦‚æœæ˜¯ï¼Œä¼šè°ƒç”¨<code>onResourceReady(resource, DataSource.MEMORY_CACHE)</code>å¹¶è¿”å›ã€‚è¯¥æ–¹æ³•æˆ‘ä»¬åé¢ä¹Ÿä¼šé‡åˆ°ï¼Œåé¢åœ¨è¯´ã€‚</p> <p>æ¥ä¸‹æ¥ä¼šè·å–è¦åŠ è½½å›¾ç‰‡çš„sizeå¹¶è°ƒç”¨<code>onSizeReady</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¯¥æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onSizeReady</span><span class=p>(</span><span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;Got onSizeReady in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=c1>// åœ¨SingleRequest.beginæ–¹æ³•ä¸­å·²ç»å°†statusè®¾ç½®ä¸ºWAITING_FOR_SIZEçŠ¶æ€äº†</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=c1>// è®¾ç½®çŠ¶æ€ä¸ºRUNNING</span>
  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>;</span>

  <span class=c1>// å°†åŸå§‹å°ºå¯¸ä¸0ï½1ä¹‹é—´çš„ç³»æ•°ç›¸ä¹˜ï¼Œå–æœ€æ¥è¿‘çš„æ•´æ•°å€¼ï¼Œå¾—åˆ°æ–°çš„å°ºå¯¸</span>
  <span class=kt>float</span> <span class=n>sizeMultiplier</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>getSizeMultiplier</span><span class=p>();</span>
  <span class=k>this</span><span class=p>.</span><span class=na>width</span> <span class=o>=</span> <span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>sizeMultiplier</span><span class=p>);</span>
  <span class=k>this</span><span class=p>.</span><span class=na>height</span> <span class=o>=</span> <span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>height</span><span class=p>,</span> <span class=n>sizeMultiplier</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished setup for calling load in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¹æ®loadé‡Œé¢çš„è¿™äº›å‚æ•°å¼€å§‹åŠ è½½</span>
  <span class=n>loadStatus</span> <span class=o>=</span>
      <span class=n>engine</span><span class=p>.</span><span class=na>load</span><span class=p>(</span>
          <span class=n>glideContext</span><span class=p>,</span>
          <span class=n>model</span><span class=p>,</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
          <span class=k>this</span><span class=p>.</span><span class=na>width</span><span class=p>,</span>
          <span class=k>this</span><span class=p>.</span><span class=na>height</span><span class=p>,</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getResourceClass</span><span class=p>(),</span>
          <span class=n>transcodeClass</span><span class=p>,</span>
          <span class=n>priority</span><span class=p>,</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getTransformations</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationRequired</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>isScaleOnlyOrNoTransform</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOptions</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>isMemoryCacheable</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getUseUnlimitedSourceGeneratorsPool</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getUseAnimationPool</span><span class=p>(),</span>
          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOnlyRetrieveFromCache</span><span class=p>(),</span>
          <span class=k>this</span><span class=p>,</span>
          <span class=n>callbackExecutor</span><span class=p>);</span>

  <span class=c1>// This is a hack that&#39;s only useful for testing right now where loads complete synchronously</span>
  <span class=c1>// even though under any executor running on any thread but the main thread, the load would</span>
  <span class=c1>// have completed asynchronously.</span>
  <span class=c1>//</span>
  <span class=c1>// statusç›®å‰æ˜¾ç„¶æ˜¯RUNNINGçŠ¶æ€ï¼Œæ‰€ä»¥ä¸ä¼šå°†loadStatusè®¾ç½®ä¸ºnull</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished onSizeReady in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <h3 id=33-engineload>3.3 Engine.load<a class=headerlink href=#33-engineload title="Permanent link">&para;</a></h3> <p>ğŸ”¥ğŸ”¥ğŸ”¥ç›®å‰çœ‹æ¥ï¼Œ<code>engine.load</code>å°±æ˜¯å¼€å§‹è¯·æ±‚çš„å…³é”®ä»£ç äº†ã€‚<code>Engine</code>æ˜¯è´Ÿè´£å¼€å§‹åŠ è½½ï¼Œç®¡ç†activeã€cachedçŠ¶æ€èµ„æºçš„ç±»ã€‚åœ¨<code>GlideBuilder.build</code>ä¸­åˆ›å»º<code>Glide</code>æ—¶ï¼Œè‹¥æ²¡æœ‰ä¸»åŠ¨è®¾ç½®engineï¼Œä¼šä½¿ç”¨ä¸‹é¢çš„å‚æ•°è¿›è¡Œåˆ›å»ºï¼š</p> <div class=highlight><pre><span></span><code><span class=k>if</span> <span class=p>(</span><span class=n>sourceExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>sourceExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newSourceExecutor</span><span class=p>();</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=n>diskCacheExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>diskCacheExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newDiskCacheExecutor</span><span class=p>();</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>engine</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>Engine</span><span class=p>(</span>
          <span class=n>memoryCache</span><span class=p>,</span>
          <span class=n>diskCacheFactory</span><span class=p>,</span>
          <span class=n>diskCacheExecutor</span><span class=p>,</span>
          <span class=n>sourceExecutor</span><span class=p>,</span>
          <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newUnlimitedSourceExecutor</span><span class=p>(),</span>
          <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newAnimationExecutor</span><span class=p>(),</span>
          <span class=n>isActiveResourceRetentionAllowed</span> <span class=cm>/* é»˜è®¤ä¸ºfalse */</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p><code>Engine.load</code>æ–¹æ³•ä¸­ä¼šä»¥ä¸€äº›å‚æ•°ä½œä¸ºkeyï¼Œä¾æ¬¡ä»activeçŠ¶æ€ã€cachedçŠ¶æ€å’Œè¿›è¡Œä¸­çš„loadé‡Œå¯»æ‰¾ã€‚è‹¥æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šåˆ›å»ºå¯¹åº”çš„jobå¹¶å¼€å§‹æ‰§è¡Œã€‚<br> æä¾›ç»™ä¸€ä¸ªæˆ–ä»¥ä¸Šè¯·æ±‚ä¸”æ²¡æœ‰è¢«é‡Šæ”¾çš„èµ„æºè¢«ç§°ä¸ºactiveèµ„æºã€‚ä¸€æ—¦æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½é‡Šæ”¾äº†è¯¥èµ„æºï¼Œè¯¥èµ„æºå°±ä¼šè¢«æ”¾å…¥cacheä¸­ã€‚å¦‚æœæœ‰è¯·æ±‚å°†èµ„æºä»cacheä¸­å–å‡ºï¼Œå®ƒä¼šè¢«é‡æ–°æ·»åŠ åˆ°activeèµ„æºä¸­ã€‚å¦‚æœä¸€ä¸ªèµ„æºä»cacheä¸­ç§»é™¤ï¼Œå…¶æœ¬èº«ä¼šè¢«discardï¼Œå…¶å†…éƒ¨æ‹¥æœ‰çš„èµ„æºå°†ä¼šå›æ”¶æˆ–è€…åœ¨å¯èƒ½çš„æƒ…å†µä¸‹é‡ç”¨ã€‚å¹¶æ²¡æœ‰ä¸¥æ ¼è¦æ±‚æ¶ˆè´¹è€…ä¸€å®šè¦é‡Šæ”¾å®ƒä»¬çš„èµ„æºï¼Œæ‰€ä»¥activeèµ„æºä¼šä»¥å¼±å¼•ç”¨çš„æ–¹å¼ä¿æŒã€‚ </p> <p>æ³¨æ„æ–¹æ³•çš„æ³¨é‡Šï¼Œé‡Œé¢æœ‰ä¸Šé¢ä¸¤æ–¹é¢çš„è¯´æ˜ï¼šè¯·æ±‚éµå®ˆçš„æµç¨‹ä»¥åŠactiveçŠ¶æ€èµ„æºçš„è¯´æ˜ã€‚</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm>  * Starts a load for the given arguments.</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;Must be called on the main thread.</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;The flow for any request is as follows:</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;ul&gt;</span>
<span class=cm>  *   &lt;li&gt;Check the current set of actively used resources, return the active resource if present,</span>
<span class=cm>  *       and move any newly inactive resources into the memory cache.</span>
<span class=cm>  *   &lt;li&gt;Check the memory cache and provide the cached resource if present.</span>
<span class=cm>  *   &lt;li&gt;Check the current set of in progress loads and add the cb to the in progress load if one</span>
<span class=cm>  *       is present.</span>
<span class=cm>  *   &lt;li&gt;Start a new load.</span>
<span class=cm>  * &lt;/ul&gt;</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;Active resources are those that have been provided to at least one request and have not yet</span>
<span class=cm>  * been released. Once all consumers of a resource have released that resource, the resource then</span>
<span class=cm>  * goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to</span>
<span class=cm>  * the active resources. If the resource is evicted from the cache, its resources are recycled and</span>
<span class=cm>  * re-used if possible and the resource is discarded. There is no strict requirement that</span>
<span class=cm>  * consumers release their resources so active resources are held weakly.</span>
<span class=cm>  *</span>
<span class=cm>  * @param width The target width in pixels of the desired resource.</span>
<span class=cm>  * @param height The target height in pixels of the desired resource.</span>
<span class=cm>  * @param cb The callback that will be called when the load completes.</span>
<span class=cm>  */</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>load</span><span class=p>(</span>
    <span class=n>GlideContext</span> <span class=n>glideContext</span><span class=p>,</span>
    <span class=n>Object</span> <span class=n>model</span><span class=p>,</span>
    <span class=n>Key</span> <span class=n>signature</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
    <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
    <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span><span class=p>,</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>Transformation</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>transformations</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>isTransformationRequired</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
    <span class=n>Options</span> <span class=n>options</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>useAnimationPool</span><span class=p>,</span>
    <span class=kt>boolean</span> <span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
    <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>,</span>
    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>VERBOSE_IS_LOGGABLE</span> <span class=o>?</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>()</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>

  <span class=c1>// EngineKeyä»¥ä¼ å…¥çš„8ä¸ªå‚æ•°ä½œä¸ºkey</span>
  <span class=n>EngineKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>keyFactory</span><span class=p>.</span><span class=na>buildKey</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>transformations</span><span class=p>,</span>
      <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>

  <span class=c1>// ä»activeèµ„æºä¸­è¿›è¡ŒåŠ è½½ï¼Œç¬¬ä¸€æ¬¡æ˜¾ç„¶å–ä¸åˆ°</span>
  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Loaded resource from active resources&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// ä»å†…å­˜cacheèµ„æºä¸­è¿›è¡ŒåŠ è½½ï¼Œç¬¬ä¸€æ¬¡æ˜¾ç„¶å–ä¸åˆ°</span>
  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Loaded resource from cache&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// ä»æ­£åœ¨è¿›è¡Œçš„jobsä¸­è¿›è¡ŒåŠ è½½ï¼Œç¬¬ä¸€æ¬¡æ˜¾ç„¶å–ä¸åˆ°</span>
  <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>current</span> <span class=o>=</span> <span class=n>jobs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>current</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Added to existing load&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// æ„å»ºå‡ºä¸€ä¸ªEngineJob</span>
  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
      <span class=n>engineJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
          <span class=n>key</span><span class=p>,</span>
          <span class=n>isMemoryCacheable</span><span class=p>,</span>
          <span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
          <span class=n>useAnimationPool</span><span class=p>,</span>
          <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>

  <span class=c1>// æ„å»ºå‡ºä¸€ä¸ªDecodeJobï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£</span>
  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
      <span class=n>decodeJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
          <span class=n>glideContext</span><span class=p>,</span>
          <span class=n>model</span><span class=p>,</span>
          <span class=n>key</span><span class=p>,</span>
          <span class=n>signature</span><span class=p>,</span>
          <span class=n>width</span><span class=p>,</span>
          <span class=n>height</span><span class=p>,</span>
          <span class=n>resourceClass</span><span class=p>,</span>
          <span class=n>transcodeClass</span><span class=p>,</span>
          <span class=n>priority</span><span class=p>,</span>
          <span class=n>diskCacheStrategy</span><span class=p>,</span>
          <span class=n>transformations</span><span class=p>,</span>
          <span class=n>isTransformationRequired</span><span class=p>,</span>
          <span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
          <span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
          <span class=n>options</span><span class=p>,</span>
          <span class=n>engineJob</span><span class=p>);</span>

  <span class=c1>// æ ¹æ®engineJob.onlyRetrieveFromCacheçš„å€¼æ˜¯å¦ä¸ºtrue</span>
  <span class=c1>// å°†engineJobä¿å­˜åˆ°onlyCacheJobsæˆ–è€…jobs HashMapä¸­</span>
  <span class=n>jobs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>

  <span class=c1>// æ·»åŠ èµ„æºåŠ è½½çŠ¶æ€å›è°ƒï¼Œå‚æ•°ä¼šåŒ…è£…æˆResourceCallbackAndExecutorç±»å‹</span>
  <span class=c1>// å¹¶ä¿å­˜åˆ°ResourceCallbacksAndExecutors.callbacksAndExecutorsä¸­</span>
  <span class=n>engineJob</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥å¼€å§‹æ‰§è¡ŒdecodeJobä»»åŠ¡</span>
  <span class=n>engineJob</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Started new load&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨ä¸Šé¢çš„è¿™æ®µä»£ç ä¸­ï¼Œä»å„ä¸ªä½ç½®å–èµ„æºæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œä¸å¤šè¯´äº†ã€‚<br> <code>engineJobFactory</code>ä¸<code>decodeJobFactory</code>ä¸¤ä¸ªFactoryå­˜åœ¨çš„æ„ä¹‰åœ¨äºé‡Œé¢ä½¿ç”¨äº†å¯¹è±¡æ± Pools.Poolã€‚ä»¥<code>DecodeJobFactory</code>ä¸ºä¾‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@VisibleForTesting</span>
<span class=kd>static</span> <span class=kd>class</span> <span class=nc>DecodeJobFactory</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Pools</span><span class=p>.</span><span class=na>Pool</span><span class=o>&lt;</span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>pool</span> <span class=o>=</span>
      <span class=n>FactoryPools</span><span class=p>.</span><span class=na>threadSafe</span><span class=p>(</span><span class=n>JOB_POOL_SIZE</span><span class=p>,</span>
          <span class=k>new</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>Factory</span><span class=o>&lt;</span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;&gt;</span><span class=p>()</span> <span class=p>{</span>
        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>DecodeJob</span><span class=o>&lt;?&gt;</span> <span class=n>create</span><span class=p>()</span> <span class=p>{</span>
          <span class=k>return</span> <span class=k>new</span> <span class=n>DecodeJob</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>pool</span><span class=p>);</span>
        <span class=p>}</span>
      <span class=p>});</span>
  <span class=p>...</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
  <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(...)</span> <span class=p>{</span>
    <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>((</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>pool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>.</span><span class=na>init</span><span class=p>(...);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// FactoryPools.java</span>
<span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>FactoryPools</span> <span class=p>{</span>
  <span class=nd>@NonNull</span>
  <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span> <span class=kd>extends</span> <span class=n>Poolable</span><span class=o>&gt;</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>threadSafe</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>build</span><span class=p>(</span><span class=k>new</span> <span class=n>SynchronizedPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>size</span><span class=p>),</span> <span class=n>factory</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nd>@NonNull</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span> <span class=kd>extends</span> <span class=n>Poolable</span><span class=o>&gt;</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>,</span>
      <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>build</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>factory</span><span class=p>,</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=n>emptyResetter</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=nd>@NonNull</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>,</span>
      <span class=nd>@NonNull</span> <span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resetter</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>FactoryPool</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>factory</span><span class=p>,</span> <span class=n>resetter</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>FactoryPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resetter</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>;</span>

    <span class=n>FactoryPool</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resetter</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>pool</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
      <span class=k>this</span><span class=p>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span><span class=p>;</span>
      <span class=k>this</span><span class=p>.</span><span class=na>resetter</span> <span class=o>=</span> <span class=n>resetter</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>T</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
      <span class=n>T</span> <span class=n>result</span> <span class=o>=</span> <span class=n>pool</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>factory</span><span class=p>.</span><span class=na>create</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
          <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Created new &quot;</span> <span class=o>+</span> <span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
        <span class=p>}</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=k>instanceof</span> <span class=n>Poolable</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>((</span><span class=n>Poolable</span><span class=p>)</span> <span class=n>result</span><span class=p>).</span><span class=na>getVerifier</span><span class=p>().</span><span class=na>setRecycled</span><span class=p>(</span><span class=kc>false</span> <span class=cm>/*isRecycled*/</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>instance</span> <span class=k>instanceof</span> <span class=n>Poolable</span><span class=p>)</span> <span class=p>{</span>
        <span class=p>((</span><span class=n>Poolable</span><span class=p>)</span> <span class=n>instance</span><span class=p>).</span><span class=na>getVerifier</span><span class=p>().</span><span class=na>setRecycled</span><span class=p>(</span><span class=kc>true</span> <span class=cm>/*isRecycled*/</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=n>resetter</span><span class=p>.</span><span class=na>reset</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
      <span class=k>return</span> <span class=n>pool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Pools</span>
<span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Pools</span> <span class=p>{</span>

    <span class=cm>/**</span>
<span class=cm>     * Interface for managing a pool of objects.</span>
<span class=cm>     *</span>
<span class=cm>     * @param &lt;T&gt; The pooled type.</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>

        <span class=cm>/**</span>
<span class=cm>         * @return An instance from the pool if such, null otherwise.</span>
<span class=cm>         */</span>
        <span class=nd>@Nullable</span>
        <span class=n>T</span> <span class=nf>acquire</span><span class=p>();</span>

        <span class=cm>/**</span>
<span class=cm>         * Release an instance to the pool.</span>
<span class=cm>         *</span>
<span class=cm>         * @param instance The instance to release.</span>
<span class=cm>         * @return Whether the instance was put in the pool.</span>
<span class=cm>         *</span>
<span class=cm>         * @throws IllegalStateException If the instance is already in the pool.</span>
<span class=cm>         */</span>
        <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=kd>private</span> <span class=nf>Pools</span><span class=p>()</span> <span class=p>{</span>
        <span class=cm>/* do nothing - hiding constructor */</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * Simple (non-synchronized) pool of objects.</span>
<span class=cm>     *</span>
<span class=cm>     * @param &lt;T&gt; The pooled type.</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>SimplePool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>mPool</span><span class=p>;</span>

        <span class=kd>private</span> <span class=kt>int</span> <span class=n>mPoolSize</span><span class=p>;</span>

        <span class=cm>/**</span>
<span class=cm>         * Creates a new instance.</span>
<span class=cm>         *</span>
<span class=cm>         * @param maxPoolSize The max pool size.</span>
<span class=cm>         *</span>
<span class=cm>         * @throws IllegalArgumentException If the max pool size is less than zero.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=nf>SimplePool</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxPoolSize</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>maxPoolSize</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;The max pool size must be &gt; 0&quot;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=n>mPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>maxPoolSize</span><span class=o>]</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
        <span class=kd>public</span> <span class=n>T</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mPoolSize</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
                <span class=kd>final</span> <span class=kt>int</span> <span class=n>lastPooledIndex</span> <span class=o>=</span> <span class=n>mPoolSize</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
                <span class=n>T</span> <span class=n>instance</span> <span class=o>=</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=n>mPool</span><span class=o>[</span><span class=n>lastPooledIndex</span><span class=o>]</span><span class=p>;</span>
                <span class=n>mPool</span><span class=o>[</span><span class=n>lastPooledIndex</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
                <span class=n>mPoolSize</span><span class=o>--</span><span class=p>;</span>
                <span class=k>return</span> <span class=n>instance</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>isInPool</span><span class=p>(</span><span class=n>instance</span><span class=p>))</span> <span class=p>{</span>
                <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already in the pool!&quot;</span><span class=p>);</span>
            <span class=p>}</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>mPoolSize</span> <span class=o>&lt;</span> <span class=n>mPool</span><span class=p>.</span><span class=na>length</span><span class=p>)</span> <span class=p>{</span>
                <span class=n>mPool</span><span class=o>[</span><span class=n>mPoolSize</span><span class=o>]</span> <span class=o>=</span> <span class=n>instance</span><span class=p>;</span>
                <span class=n>mPoolSize</span><span class=o>++</span><span class=p>;</span>
                <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>

        <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isInPool</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>mPoolSize</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>if</span> <span class=p>(</span><span class=n>mPool</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
                    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
                <span class=p>}</span>
            <span class=p>}</span>
            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * Synchronized) pool of objects.</span>
<span class=cm>     *</span>
<span class=cm>     * @param &lt;T&gt; The pooled type.</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>SynchronizedPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>SimplePool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>mLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=p>();</span>

        <span class=cm>/**</span>
<span class=cm>         * Creates a new instance.</span>
<span class=cm>         *</span>
<span class=cm>         * @param maxPoolSize The max pool size.</span>
<span class=cm>         *</span>
<span class=cm>         * @throws IllegalArgumentException If the max pool size is less than zero.</span>
<span class=cm>         */</span>
        <span class=kd>public</span> <span class=nf>SynchronizedPool</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxPoolSize</span><span class=p>)</span> <span class=p>{</span>
            <span class=kd>super</span><span class=p>(</span><span class=n>maxPoolSize</span><span class=p>);</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>T</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
            <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
            <span class=p>}</span>
        <span class=p>}</span>

        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>element</span><span class=p>)</span> <span class=p>{</span>
            <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>element</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æ¥ç€çœ‹çœ‹<code>engineJob.start(decodeJob)</code>è¿™å¥ä»£ç ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// EngineJob</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>start</span><span class=p>(</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>decodeJob</span> <span class=o>=</span> <span class=n>decodeJob</span><span class=p>;</span>
  <span class=c1>// decodeJob.willDecodeFromCache()è¿”å›true</span>
  <span class=n>GlideExecutor</span> <span class=n>executor</span> <span class=o>=</span> <span class=n>decodeJob</span><span class=p>.</span><span class=na>willDecodeFromCache</span><span class=p>()</span>
      <span class=o>?</span> <span class=n>diskCacheExecutor</span>
      <span class=p>:</span> <span class=n>getActiveSourceExecutor</span><span class=p>();</span>
  <span class=n>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// DecodeJob</span>
<span class=cm>/**</span>
<span class=cm>  * Returns true if this job will attempt to decode a resource from the disk cache, and false if it</span>
<span class=cm>  * will always decode from source.</span>
<span class=cm>  */</span>
<span class=kt>boolean</span> <span class=nf>willDecodeFromCache</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// è¿”å›å€¼ä¸ºStage.RESOURCE_CACHE</span>
  <span class=n>Stage</span> <span class=n>firstStage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>INITIALIZE</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>firstStage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span> <span class=o>||</span> <span class=n>firstStage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>Stage</span> <span class=nf>getNextStage</span><span class=p>(</span><span class=n>Stage</span> <span class=n>current</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// diskCacheStrategyä¸ºDiskCacheStrategy.AUTOMATIC</span>
    <span class=c1>// decodeCachedResource()ä¸ºtrue</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>case</span> <span class=n>INITIALIZE</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedResource</span><span class=p>()</span>
            <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=p>);</span>
      <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedData</span><span class=p>()</span>
            <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>);</span>
      <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=p>:</span>
        <span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
        <span class=k>return</span> <span class=n>onlyRetrieveFromCache</span> <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=p>:</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
      <span class=k>case</span> <span class=n>FINISHED</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=p>;</span>
      <span class=k>default</span><span class=p>:</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></div> <p>æ­¤çŠ¶æ€æœºçš„æ‰€æœ‰çŠ¶æ€å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm>  * Where we&#39;re trying to decode data from.</span>
<span class=cm>  */</span>
<span class=kd>private</span> <span class=kd>enum</span> <span class=n>Stage</span> <span class=p>{</span>
  <span class=cm>/** The initial stage. */</span>
  <span class=n>INITIALIZE</span><span class=p>,</span>
  <span class=cm>/** Decode from a cached resource. */</span>
  <span class=n>RESOURCE_CACHE</span><span class=p>,</span>
  <span class=cm>/** Decode from cached source data. */</span>
  <span class=n>DATA_CACHE</span><span class=p>,</span>
  <span class=cm>/** Decode from retrieved source. */</span>
  <span class=n>SOURCE</span><span class=p>,</span>
  <span class=cm>/** Encoding transformed resources after a successful load. */</span>
  <span class=n>ENCODE</span><span class=p>,</span>
  <span class=cm>/** No more viable stages. */</span>
  <span class=n>FINISHED</span><span class=p>,</span>
<span class=p>}</span>
</code></pre></div> <p>å›åˆ°<code>EngineJob.start</code>æ–¹æ³•ä¸­ï¼Œç”±äº<code>decodeJob.willDecodeFromCache()</code>ä¸ºtrueï¼Œé‚£ä¹ˆå°±ä½¿ç”¨<code>diskCacheExecutor</code>æ¥æ‰§è¡ŒdecodeJobã€‚<br> <code>diskCacheExecutor</code>é»˜è®¤å€¼ä¸º<code>GlideExecutor.newDiskCacheExecutor()</code>ï¼Œè¿™æ˜¯ç±»ä¼¼äºä¸€ä¸ª<code>SingleThreadExecutor</code>çš„çº¿ç¨‹æ± ï¼Œè¿™é‡Œä½¿ç”¨äº†è®¾è®¡æ¨¡å¼ä¸­çš„ä»£ç†æ¨¡å¼ï¼š</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm> * A prioritized {@link ThreadPoolExecutor} for running jobs in Glide.</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>GlideExecutor</span> <span class=kd>implements</span> <span class=n>ExecutorService</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_NAME</span> <span class=o>=</span> <span class=s>&quot;disk-cache&quot;</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>delegate</span><span class=p>;</span>

  <span class=kd>public</span> <span class=kd>static</span> <span class=n>GlideExecutor</span> <span class=nf>newDiskCacheExecutor</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>newDiskCacheExecutor</span><span class=p>(</span>
        <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span><span class=p>,</span>
        <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_NAME</span><span class=p>,</span>
        <span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>public</span> <span class=kd>static</span> <span class=n>GlideExecutor</span> <span class=nf>newDiskCacheExecutor</span><span class=p>(</span>
      <span class=kt>int</span> <span class=n>threadCount</span><span class=p>,</span> <span class=n>String</span> <span class=n>name</span><span class=p>,</span> <span class=n>UncaughtThrowableStrategy</span> <span class=n>uncaughtThrowableStrategy</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>GlideExecutor</span><span class=p>(</span>
        <span class=k>new</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span>
            <span class=n>threadCount</span> <span class=cm>/* corePoolSize */</span><span class=p>,</span>
            <span class=n>threadCount</span> <span class=cm>/* maximumPoolSize */</span><span class=p>,</span>
            <span class=mi>0</span> <span class=cm>/* keepAliveTime */</span><span class=p>,</span>
            <span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span>
            <span class=k>new</span> <span class=n>PriorityBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>(),</span>
            <span class=k>new</span> <span class=n>DefaultThreadFactory</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>uncaughtThrowableStrategy</span><span class=p>,</span> <span class=kc>true</span><span class=p>)));</span>
  <span class=p>}</span>

  <span class=nd>@VisibleForTesting</span>
  <span class=n>GlideExecutor</span><span class=p>(</span><span class=n>ExecutorService</span> <span class=n>delegate</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>delegate</span> <span class=o>=</span> <span class=n>delegate</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>command</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>delegate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nd>@NonNull</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>Future</span><span class=o>&lt;?&gt;</span> <span class=n>submit</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>task</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>delegate</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>task</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>
</code></pre></div> <p>ç°åœ¨ï¼Œ<code>decodeJob</code>å·²ç»æäº¤åˆ°äº†çº¿ç¨‹æ± ä¸­ï¼Œå¾…ä¼šå„¿æˆ‘ä»¬åœ¨çœ‹å­çº¿ç¨‹ä¸­çš„æ‰§è¡Œæƒ…å†µã€‚<br> ç°åœ¨å›åˆ°ä¸»çº¿ç¨‹çš„<code>SingleRequest.begin</code>æ–¹æ³•ä¸­ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„æ˜¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=k>if</span> <span class=p>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span>
    <span class=o>&amp;&amp;</span> <span class=n>canNotifyStatusChanged</span><span class=p>())</span> <span class=p>{</span>
  <span class=n>target</span><span class=p>.</span><span class=na>onLoadStarted</span><span class=p>(</span><span class=n>getPlaceholderDrawable</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div> <p>ç”±äºæ­¤æ—¶<code>status == Status.RUNNING</code>ä¸ºtrueï¼Œç°åœ¨å¼€å§‹å±•ç¤ºplaceholderã€‚</p> <h3 id=34-decodejobrun>3.4 DecodeJob.run<a class=headerlink href=#34-decodejobrun title="Permanent link">&para;</a></h3> <p>æ¥ç€ï¼Œç»§ç»­çœ‹çœ‹<code>decodeJob.run</code>æ–¹æ³•åœ¨çº¿ç¨‹æ± ä¸­çš„æ‰§è¡Œæƒ…å†µï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// This should be much more fine grained, but since Java&#39;s thread pool implementation silently</span>
  <span class=c1>// swallows all otherwise fatal exceptions, this will at least make it obvious to developers</span>
  <span class=c1>// that something is failing.</span>
  <span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSectionFormat</span><span class=p>(</span><span class=s>&quot;DecodeJob#run(model=%s)&quot;</span><span class=p>,</span> <span class=n>model</span><span class=p>);</span>
  <span class=c1>// Methods in the try statement can invalidate currentFetcher, so set a local variable here to</span>
  <span class=c1>// ensure that the fetcher is cleaned up either way.</span>
  <span class=c1>//</span>
  <span class=c1>// currentFetcherç›®å‰ä¸ºnull</span>
  <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>localFetcher</span> <span class=o>=</span> <span class=n>currentFetcher</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>notifyFailed</span><span class=p>();</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=n>runWrapped</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>CallbackException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// If a callback not controlled by Glide throws an exception, we should avoid the Glide</span>
    <span class=c1>// specific debug logic below.</span>
    <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// Catch Throwable and not Exception to handle OOMs. Throwables are swallowed by our</span>
    <span class=c1>// usage of .submit() in GlideExecutor so we&#39;re not silently hiding crashes by doing this. We</span>
    <span class=c1>// are however ensuring that our callbacks are always notified when a load fails. Without this</span>
    <span class=c1>// notification, uncaught throwables never notify the corresponding callbacks, which can cause</span>
    <span class=c1>// loads to silently hang forever, a case that&#39;s especially bad for users using Futures on</span>
    <span class=c1>// background threads.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;DecodeJob threw unexpectedly&quot;</span>
          <span class=o>+</span> <span class=s>&quot;, isCancelled: &quot;</span> <span class=o>+</span> <span class=n>isCancelled</span>
          <span class=o>+</span> <span class=s>&quot;, stage: &quot;</span> <span class=o>+</span> <span class=n>stage</span><span class=p>,</span> <span class=n>t</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// When we&#39;re encoding we&#39;ve already notified our callback and it isn&#39;t safe to do so again.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>!=</span> <span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
      <span class=n>notifyFailed</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=c1>// Keeping track of the fetcher here and calling cleanup is excessively paranoid, we call</span>
    <span class=c1>// close in all cases anyway.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>localFetcher</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>localFetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>é‡Œé¢çœŸæ­£æ‰§è¡Œçš„æ˜¯<code>runWrapped</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runWrapped</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// runReasonåœ¨DecodeJob.initæ–¹æ³•ä¸­è¢«åˆå§‹åŒ–ä¸ºINITIALIZE</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>runReason</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=p>:</span>
      <span class=c1>// INITIALIZEä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¾ç„¶ä¸ºRESOURCE_CACHE</span>
      <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>INITIALIZE</span><span class=p>);</span>
      <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>
      <span class=n>runGenerators</span><span class=p>();</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>...</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=cm>/**</span>
<span class=cm> * è¿”å›ä¸€ä¸ªResourceCacheGenerator</span>
<span class=cm> */</span>
<span class=kd>private</span> <span class=n>DataFetcherGenerator</span> <span class=nf>getNextGenerator</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>stage</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
      <span class=k>return</span> <span class=k>new</span> <span class=n>ResourceCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
    <span class=p>...</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>getNextGenerator()</code>æ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code>ResourceCacheGenerator</code>ï¼Œç„¶åè°ƒç”¨<code>runGenerators()</code>æ–¹æ³•è¿›è¡Œæ‰§è¡Œã€‚</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=p>()</span> <span class=p>{</span>
  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span> <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>reschedule</span><span class=p>();</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
  <span class=k>if</span> <span class=p>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>notifyFailed</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
  <span class=c1>// onDataFetcherReady.</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨è¯¥æ–¹æ³•ä¸­ä¼šä¾æ¬¡è°ƒç”¨å„ä¸ªçŠ¶æ€ç”Ÿæˆçš„<code>DataFetcherGenerator</code>çš„<code>startNext()</code>å°è¯•fetchæ•°æ®ï¼Œç›´åˆ°æœ‰æŸä¸ªçŠ¶æ€çš„<code>DataFetcherGenerator.startNext()</code>æ–¹æ³•å¯ä»¥èƒœä»»ã€‚è‹¥çŠ¶æ€æŠµè¾¾åˆ°äº†<code>Stage.FINISHED</code>æˆ–jobè¢«å–æ¶ˆï¼Œä¸”æ‰€æœ‰çŠ¶æ€çš„<code>DataFetcherGenerator.startNext()</code>éƒ½æ— æ³•æ»¡è¶³æ¡ä»¶ï¼Œåˆ™è°ƒç”¨<code>SingleRequest.onLoadFailed</code>è¿›è¡Œé”™è¯¯å¤„ç†ã€‚ </p> <p>è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ª<code>DataFetcherGenerator</code>ï¼Œä¾æ¬¡æ˜¯ï¼š</p> <ol> <li>ResourceCacheGenerator<br> è·å–é‡‡æ ·åã€transformedåèµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶</li> <li>DataCacheGenerator<br> è·å–åŸå§‹çš„æ²¡æœ‰ä¿®æ”¹è¿‡çš„èµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶</li> <li>SourceGenerator<br> è·å–åŸå§‹æºæ•°æ®</li> </ol> <p>è¿™é‡Œé¢fetchæ•°æ®é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå› ä¸ºæ¶‰åŠåˆ°<code>Registry</code>ç±»ï¼Œè¯¥ç±»æ˜¯ç”¨æ¥ç®¡ç†Glideæ³¨å†Œè¿›æ¥çš„ç”¨æ¥æ‹“å±•æˆ–æ›¿ä»£Glideé»˜è®¤åŠ è½½ã€è§£ç ã€ç¼–ç é€»è¾‘çš„ç»„ä»¶ã€‚åœ¨Glideåˆ›å»ºçš„æ—¶å€™ï¼Œç»å¤§å¤šæ•°ä»£ç éƒ½æ˜¯å¯¹<code>Registry</code>çš„æ“ä½œã€‚</p> <p>æˆ‘ä»¬å…ˆå¤§è‡´è¯´ä¸€ä¸‹<code>Registry</code>ç±»é‡Œé¢å„ä¸ªç»„ä»¶çš„åŠŸèƒ½å§ã€‚</p> <h3 id=35-registry>3.5 Registry<a class=headerlink href=#35-registry title="Permanent link">&para;</a></h3> <p>Glideåœ¨åˆ›å»ºæ—¶ï¼Œä¼šå‘<code>Registry</code>å®ä¾‹ä¸­æ³¨å…¥ç›¸å½“å¤šçš„é…ç½®ï¼Œæ¯ä¸ªé…ç½®éƒ½ä¼šè½¬å‘ç»™å¯¹åº”çš„ä¸€ä¸ªä¸“é—¨çš„ç±»ï¼Œè¿™äº›ä¸“é—¨çš„ç±»æœ‰7ä¸ªã€‚<br> åœ¨è¿™7ä¸ªç±»ä¸­ï¼Œé™¤äº†<code>DataRewinderRegistry</code>å’Œ<code>ImageHeaderParserRegistry</code>å¤–ï¼Œå…¶ä»–çš„Registryéƒ½ä¼šå°†æ³¨å…¥çš„é…ç½®ä¿å­˜åˆ°å†…éƒ¨çš„<code>Entry</code>ç±»ä¸­ã€‚<code>Entry</code>ç±»çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­è¯¥é¡¹é…ç½®èƒ½å¤Ÿæ»¡è¶³æ¡ä»¶ï¼ˆ<code>handles</code>ï¼‰ã€‚<br> <code>handles</code>æ–¹æ³•éƒ½æ˜¯ä»¥<code>isAssignableFrom</code>æ–¹æ³•åˆ¤æ–­ï¼Œä½†è¢«åˆ¤æ–­å‚æ•°æœ‰ä¸€äº›å·®åˆ«ã€‚</p> <p>åœ¨å„ä¸ªRegistryä¸­<code>Entry</code>ç±»çš„<code>hanldes</code>å®ç°å‰ï¼Œå…ˆç†è§£ä¸€ä¸‹è¿™é‡Œé¢å‡ºç°çš„å„ç§classï¼š</p> <ul> <li><code>modelClass</code><br> Glide.with(..).load()ä¸­è¢«loadå‚æ•°çš„ç±»å‹ï¼Œåœ¨å®ä¾‹ä¸­å°±æ˜¯String.class</li> <li><code>dataClass</code><br> æ¯”è¾ƒåŸå§‹çš„æ•°æ®ï¼Œæ ¹æ®<code>ModelLoaderRegistry</code>ä¸­çš„é…ç½®ï¼Œå¯ä»¥å¾—åˆ°æ‰€æœ‰ç”±<code>modelClass</code>æœ‰å¯èƒ½åˆ°è¾¾çš„<code>dataClass</code><br> åŒæ—¶ï¼Œä¸€èµ·æ³¨å…¥çš„<code>ModelLoaderFactory&lt;Model, Data&gt;</code>æ˜¯ä¸€ä¸ªå¯ä»¥åˆ›å»ºå¦‚ä½•ä»<code>modelClass</code>åˆ°<code>dataClass</code>è¿›è¡Œè½¬æ¢çš„<code>ModelLoader&lt;Model, Data&gt;</code>çš„ç±»çš„å·¥å‚ï¼Œå¯ä»¥æ ¹æ®<code>modelClass</code>è·å¾—</li> <li><code>resourceClass</code><br> è§£ç åçš„èµ„æºç±»å‹ï¼Œæ ¹æ®<code>ResourceDecoderRegistry</code>ä¸­çš„é…ç½®ï¼Œå¯ä»¥ç”±<code>dataClass</code>å’Œ<code>resourceClass</code>è·å¾—æ‰€æœ‰<code>registeredResourceClasses</code><br> åŒæ—¶ï¼Œä¸€èµ·æ³¨å…¥çš„<code>ResourceDecoder&lt;Data, Resource&gt;</code>æ˜¯ä¸€ä¸ªå°†<code>dataClass</code>è§£ç æˆ<code>resourceClass</code>çš„ç±»ï¼Œå¯ä»¥ç”±æœ‰å¯èƒ½åˆ°è¾¾çš„<code>dataClass</code>ä»¥åŠ<code>registeredResourceClass</code>è·å¾—</li> <li><code>transcodeClass</code><br> æœ€ç»ˆè¦è½¬æ¢æˆçš„æ•°æ®ç±»å‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Drawable.classï¼›è‹¥GlideåŠ è½½æ˜¯æŒ‡å®šäº†asBitmapã€asGifã€asFileï¼Œé‚£ä¹ˆæ­¤ç±»å‹å°±æ˜¯Bitmap.classã€GifDrawable.classã€File.class<br> è‹¥<code>registeredResourceClass</code>ä¸æ˜¯<code>transcodeClass</code>ç±»å‹ï¼Œåˆ™é€šè¿‡<code>TranscoderRegistry</code>æ³¨å…¥çš„<code>ResourceTranscoder&lt;Resource, T&gt;</code>å¯ä»¥å°†<code>resourceClass</code>è½¬ä¸º<code>transcodeClass</code></li> </ul> <p>ä¸‹é¢æ˜¯5ä¸ªåœ¨å„ä¸ªRegistryä¸­<code>Entry</code>ç±»çš„<code>hanldes</code>å®ç°ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// MultiModelLoaderFactory.Entry</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>;</span>
  <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>modelClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>modelClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>modelClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// EncoderRegistry.Entry</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// ResourceEncoderRegistry.Entry</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=nd>@Synthetic</span>
  <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// ResourceDecoderRegistry.Entry</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>;</span>
  <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>resourceClass</span>
        <span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// TranscoderRegistry.Entry</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>fromClass</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>toClass</span><span class=p>;</span>
  <span class=p>...</span>
  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>fromClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>toClass</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>fromClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>fromClass</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>toClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>toClass</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <blockquote> <p><code>isAssignableFrom</code>åˆ¤æ–­è¯¥ç±»æ˜¯å¦æ˜¯æŸä¸ªç±»çš„çˆ¶ç±»ï¼Œ<code>instanceof</code>åˆ¤æ–­è¯¥å®ä¾‹çš„ç±»æ˜¯å¦æŸä¸ªå®ä¾‹çš„ç±»çš„å­ç±»ã€‚</p> </blockquote> <p>è¿™7ä¸ªRegistryç±»ä½œç”¨å¦‚ä¸‹ï¼š</p> <ol> <li>ModelLoaderRegistry<br> æ„å»º<code>modelClass</code>åˆ°<code>dataClass</code>çš„æ¡¥æ¢<br> <em>load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors).</em></li> <li>ResourceDecoderRegistry<br> <code>dataClass</code>åˆ°<code>resourceClass</code>çš„æ¡¥æ¢<br> <em>to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors).</em></li> <li>EncoderRegistry<br> <em>write Data (InputStreams, FileDescriptors) to Glideâ€™s disk cache</em></li> <li>TranscoderRegistry<br> æ„å»º<code>resourceClass</code>åˆ°<code>transcodeClass</code>çš„æ¡¥æ¢<br> <em>convert Resources (BitmapResource) into other types of Resources (DrawableResource)</em></li> <li>ResourceEncoderRegistry<br> <em>write Resources (BitmapResource, DrawableResource) to Glideâ€™s disk cache.</em></li> <li>DataRewinderRegistry<br> æä¾›å¯¹<code>ByteBuffer.class</code>ã€<code>InputStream.class</code>è¿™ä¸¤ç§dataè¿›è¡Œrewindæ“ä½œçš„èƒ½åŠ›</li> <li>ImageHeaderParserRegistry<br> æä¾›è§£æImageå¤´ä¿¡æ¯çš„èƒ½åŠ›</li> </ol> <blockquote> <ol> <li><code>ModelLoaders</code> to load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors). </li> <li><code>ResourceDecoders</code> to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors). </li> <li><code>Encoders</code> to write Data (InputStreams, FileDescriptors) to Glideâ€™s disk cache. </li> <li><code>ResourceTranscoders</code> to convert Resources (BitmapResource) into other types of Resources (DrawableResource). </li> <li><code>ResourceEncoders</code> to write Resources (BitmapResource, DrawableResource) to Glideâ€™s disk cache. </li> </ol> <p><strong>Anatomy of a load</strong><br> The set of registered components, including both those registered by default in Glide and those registered in Modules are used to define a set of load paths. Each load path is a step by step progression from the the Model provided to <code>load()</code> to the Resource type specified by <code>as()</code>. A load path consists (roughly) of the following steps:<br> 1. Model -&gt; Data (handled by <code>ModelLoader</code>s) 2. Data -&gt; Resource (handled by <code>ResourceDecoder</code>s) 3. Resource -&gt; Transcoded Resource (optional, handled by <code>ResourceTranscoder</code>s).</p> <p><code>Encoder</code>s can write Data to Glideâ€™s disk cache cache before step 2.<br> <code>ResourceEncoder</code>s can write Resourceâ€™s to Glideâ€™s disk cache before step 3.<br> When a request is started, Glide will attempt all available paths from the Model to the requested Resource type. A request will succeed if any load path succeeds. A request will fail only if all available load paths fail. </p> <p><cite><a href=http://bumptech.github.io/glide/doc/configuration.html#registering-components>Configuration - Registering Components</a></cite> </p> </blockquote> <h3 id=36-resourcecachegenerator>3.6 ResourceCacheGenerator<a class=headerlink href=#36-resourcecachegenerator title="Permanent link">&para;</a></h3> <p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•ï¼Œç”±äºæ–¹æ³•è¿™é‡Œé¢æ–¹æ³•è°ƒç”¨å±‚æ¬¡éå¸¸æ·±ï¼Œæ‰€ä»¥å…ˆç›´æ¥å†™ä¸Šæ¯ä¸€æ­¥æ‰§è¡Œçš„ç»“æœï¼Œæœ‰ä¸€ä¸ªå¤§ä½“ä¸Šçš„äº†è§£ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
 <span class=c1>// listé‡Œé¢åªæœ‰ä¸€ä¸ªGlideUrlå¯¹è±¡</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>sourceIds</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getCacheKeys</span><span class=p>();</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>sourceIds</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
   <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
 <span class=p>}</span>
 <span class=c1>// è·å¾—äº†ä¸‰ä¸ªå¯ä»¥åˆ°è¾¾çš„registeredResourceClasses</span>
 <span class=c1>// GifDrawableã€Bitmapã€BitmapDrawable</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceClasses</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>();</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getTranscodeClass</span><span class=p>()))</span> <span class=p>{</span>
     <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
   <span class=p>}</span>
   <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span>
       <span class=s>&quot;Failed to find any load path from &quot;</span> <span class=o>+</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelClass</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot; to &quot;</span>
           <span class=o>+</span> <span class=n>helper</span><span class=p>.</span><span class=na>getTranscodeClass</span><span class=p>());</span>
 <span class=p>}</span>
 <span class=c1>// éå†sourceIdsä¸­çš„æ¯ä¸€ä¸ªkeyã€resourceClassesä¸­æ¯ä¸€ä¸ªclassï¼Œä»¥åŠå…¶ä»–çš„ä¸€äº›å€¼ç»„æˆkey</span>
 <span class=c1>// å°è¯•åœ¨ç£ç›˜ç¼“å­˜ä¸­ä»¥keyæ‰¾åˆ°ç¼“å­˜æ–‡ä»¶</span>
 <span class=k>while</span> <span class=p>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
   <span class=n>resourceClassIndex</span><span class=o>++</span><span class=p>;</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>resourceClassIndex</span> <span class=o>&gt;=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
     <span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
       <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
     <span class=p>}</span>
     <span class=n>resourceClassIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
   <span class=p>}</span>

   <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
   <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=p>);</span>
   <span class=n>Transformation</span><span class=o>&lt;?&gt;</span> <span class=n>transformation</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
   <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops Each iteration is comparatively expensive anyway,</span>
   <span class=c1>// we only run until the first one succeeds, the loop runs for only a limited</span>
   <span class=c1>// number of iterations on the order of 10-20 in the worst case.</span>
   <span class=n>currentKey</span> <span class=o>=</span>
       <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops</span>
           <span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
           <span class=n>sourceId</span><span class=p>,</span>
           <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
           <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
           <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
           <span class=n>transformation</span><span class=p>,</span>
           <span class=n>resourceClass</span><span class=p>,</span>
           <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
   <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>currentKey</span><span class=p>);</span>
   <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ªç¯æ¡ä»¶åˆ™ä¼šä¸ºfalseï¼Œä¹Ÿå°±é€€å‡ºå¾ªç¯äº†</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=p>;</span>
     <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
     <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
   <span class=p>}</span>
 <span class=p>}</span>

 <span class=c1>// æ‰¾æ²¡æ‰¾åˆ°ç¼“å­˜æ–‡ä»¶ï¼Œéƒ½ä¼šæ‰§è¡Œè¿™é‡Œçš„æ–¹æ³•</span>
 <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ï¼ŒhasNextModelLoader()æ–¹æ³•åˆ™ä¼šä¸ºtrueï¼Œå¯ä»¥æ‰§è¡Œå¾ªç¯</span>
 <span class=c1>// æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜æ–‡ä»¶ï¼Œåˆ™ä¸ä¼šè¿›å…¥å¾ªç¯ï¼Œä¼šç›´æ¥è¿”å›false</span>
 <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
 <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
 <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
   <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
   <span class=c1>//  åœ¨å¾ªç¯ä¸­ä¼šä¾æ¬¡åˆ¤æ–­æŸä¸ªModelLoaderèƒ½ä¸èƒ½åŠ è½½æ­¤æ–‡ä»¶</span>
   <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span>
       <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span> <span class=p>{</span>
     <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
     <span class=c1>// å¦‚æœæŸä¸ªModelLoaderå¯ä»¥ï¼Œé‚£ä¹ˆå°±è°ƒç”¨å…¶fetcherè¿›è¡ŒåŠ è½½æ•°æ®</span>
     <span class=c1>// åŠ è½½æˆåŠŸæˆ–å¤±è´¥ä¼šé€šçŸ¥è‡ªèº«</span>
     <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
   <span class=p>}</span>
 <span class=p>}</span>

 <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <h4 id=361-helpergetcachekeys>3.6.1 helper.getCacheKeys<a class=headerlink href=#361-helpergetcachekeys title="Permanent link">&para;</a></h4> <p>æˆ‘ä»¬ä¸€è¡Œè¡Œè§£æè¿™é‡Œé¢çš„ä»£ç ï¼Œå…ˆçœ‹çœ‹<code>helper.getCacheKeys()</code>æ˜¯å¦‚ä½•æŠŠæˆ‘ä»¬ç»•æ™•åï¼ŒæˆåŠŸçš„å°†Stringè½¬æ¢ä¸ºGlideUrlçš„ã€‚</p> <p><strong>DecodeHelper.java</strong> <div class=highlight><pre><span></span><code><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=nf>getCacheKeys</span><span class=p>()</span> <span class=p>{</span>
 <span class=c1>// è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨DataCacheGeneratorä¸­é‡å¤åŠ è½½</span>
 <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCacheKeysSet</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>isCacheKeysSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
   <span class=n>cacheKeys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
   <span class=c1>// å¾—åˆ°å¯ä»¥å¤„ç†è¯¥è¯·æ±‚çš„ModelLoaderçš„LoadData list</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>loadData</span> <span class=o>=</span> <span class=n>getLoadData</span><span class=p>();</span>
   <span class=c1>// å°†æ¯ä¸€ä¸ªloadDataé‡Œçš„sourceKeyä»¥åŠæ¯ä¸€ä¸ªalternateKeysæ·»åŠ åˆ°cacheKeysä¸­</span>
   <span class=c1>// åœ¨æˆ‘ä»¬çš„ä¸‰æ­¥ä¾‹å­ä¸­sourceKeyä¸ºä¸€ä¸ªGlideUrlï¼ŒalternateKeysä¸ºç©º</span>
   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>LoadData</span><span class=o>&lt;?&gt;</span> <span class=n>data</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>);</span>
     <span class=p>}</span>
     <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
       <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>)))</span> <span class=p>{</span>
         <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>));</span>
       <span class=p>}</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>cacheKeys</span><span class=p>;</span>
<span class=p>}</span>

<span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getLoadData</span><span class=p>()</span> <span class=p>{</span>
 <span class=c1>// è¿™é‡Œä¹Ÿä½¿ç”¨äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨é‡å¤åŠ è½½</span>
 <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isLoadDataSet</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>isLoadDataSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
   <span class=n>loadData</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
   <span class=c1>// è·å¾—äº†æ³¨å†Œçš„3ä¸ªModelLoader</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
     <span class=c1>// å¯¹æ¯ä¸ªModelLoaderè°ƒç”¨buildLoadDataï¼Œçœ‹çœ‹å…¶æ˜¯å¦å¯ä»¥æ»¡è¶³æ¡ä»¶</span>
     <span class=c1>// å¦‚æœè¿”å›ä¸ä¸ºnullï¼Œè¯´æ˜æ˜¯å¯ä»¥å¤„ç†çš„ï¼Œé‚£ä¹ˆæ·»åŠ è¿›æ¥</span>
     <span class=n>LoadData</span><span class=o>&lt;?&gt;</span> <span class=n>current</span> <span class=o>=</span>
         <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
       <span class=n>loadData</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=c1>// è¿”å›å¯ä»¥å¤„ç†è¯¥è¯·æ±‚çš„ModelLoaderçš„LoadDataåˆ—è¡¨</span>
 <span class=k>return</span> <span class=n>loadData</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></p> <p>ä¸Šé¢ä»£ç ä¸­æ¯”è¾ƒéº»çƒ¦çš„éƒ¨åˆ†åœ¨<code>glideContext.getRegistry().getModelLoaders(model)</code>ï¼Œåœ¨æ·±å…¥æ¢ç´¢è¯¥æ–¹æ³•çš„ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆçœ‹çœ‹<code>Registry</code>ç±»çš„ç›¸å…³ä»£ç å§ã€‚</p> <p><code>Registry</code>ç±»ä¸­æä¾›äº†å¾ˆå¤šç”¨æ¥æ‹“å±•ã€æ›¿æ¢é»˜è®¤ç»„ä»¶çš„æ–¹æ³•ï¼Œæ ¹æ®ç»„ä»¶åŠŸèƒ½çš„ä¸åŒï¼Œä¼šäº¤ç»™å†…éƒ¨å¾ˆå¤šä¸åŒçš„Registryå¤„ç†ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Registry</span> <span class=p>{</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>ModelLoaderRegistry</span> <span class=n>modelLoaderRegistry</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>EncoderRegistry</span> <span class=n>encoderRegistry</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceDecoderRegistry</span> <span class=n>decoderRegistry</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceEncoderRegistry</span> <span class=n>resourceEncoderRegistry</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>DataRewinderRegistry</span> <span class=n>dataRewinderRegistry</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>TranscoderRegistry</span> <span class=n>transcoderRegistry</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>ImageHeaderParserRegistry</span> <span class=n>imageHeaderParserRegistry</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>æ‹¿é©¬ä¸Šè¦é‡åˆ°çš„<code>modelLoaderRegistry</code>æ¥è¯´ï¼Œç›¸å…³çš„ç®¡ç†ç»„ä»¶çš„ä¸‰ä¸ªæ–¹æ³•ä¸ºï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>append</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
 <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>prepend</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
 <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>replace</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Model</span><span class=p>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
 <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™ä¸‰ä¸ªæ–¹æ³•å®é™…ä¸Šåˆä¼šäº¤ç»™<code>MultiModelLoaderFactory</code>æ¥å¤„ç†ï¼Œè¿™æ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>append</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Model</span><span class=p>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
 <span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>prepend</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Model</span><span class=p>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
 <span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>remove</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>tearDown</span><span class=p>(</span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>));</span>
 <span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p><code>MultiModelLoaderFactory</code>ä¸­ä¼šä½¿ç”¨ä¸€ä¸ª<code>entries</code>çš„listæ¥ä¿å­˜æ‰€æœ‰æ³¨å…¥çš„å†…å®¹ã€‚</p> <p>å‰é¢å·²ç»æåˆ°è¿‡ï¼ŒGlideåœ¨æ„é€ æ—¶ä¼šå¯¹<code>Registry</code>è¿›è¡Œå¤§é‡çš„æ“ä½œã€‚å› ä¸ºæˆ‘ä»¬ç¤ºä¾‹æ˜¯loadçš„<code>String</code>ç±»å‹çš„Urlï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>modelClass</code> ä¸º <code>String.class</code>ï¼Œæ‰€ä»¥<code>Registry</code>ä¸­ç¬¦åˆçš„æ³¨å†Œé¡¹åªæœ‰4ä¸ªï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªbase64æ ¼å¼çš„imgï¼Œç»è¿‡å¤„ç†åå¯ä»¥å˜æˆInputStreamç±»å‹(dataClass)çš„æ•°æ®</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>DataUrlLoader</span><span class=p>.</span><span class=na>StreamFactory</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>())</span>
<span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªuriï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½æ€§éå¸¸å¤šï¼Œå› ä¸ºç½‘ç»œå›¾ç‰‡ã€assetså›¾ç‰‡ã€ç£ç›˜å›¾ç‰‡ç­‰ç­‰éƒ½æ˜¯ä¸€ä¸ªuri</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=p>.</span><span class=na>StreamFactory</span><span class=p>())</span>
<span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°å›¾ç‰‡ã€assetså›¾ç‰‡ï¼Œæ‰€ä»¥å¯ä»¥å¤„ç†æˆParcelFileDescriptor.classç±»å‹çš„æ•°æ®</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=p>.</span><span class=na>FileDescriptorFactory</span><span class=p>())</span>
<span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°å›¾ç‰‡ï¼Œæ‰€ä»¥å¯ä»¥å¤„ç†æˆä¸ºAssetFileDescriptor.classç±»å‹çš„æ•°æ®</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span>
   <span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>AssetFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=p>.</span><span class=na>AssetFileDescriptorFactory</span><span class=p>())</span>
</code></pre></div> <p>äº†è§£äº†è¿™äº›ä¹‹åï¼Œæˆ‘ä»¬å›è¿‡å¤´çœ‹çœ‹<code>Registry.getModelLoaders</code>æ–¹æ³•å¹²äº†å•¥ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// Registry.java</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoaders</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Model</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
   <span class=k>throw</span> <span class=k>new</span> <span class=n>NoModelLoaderAvailableException</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œåªæ˜¯è°ƒç”¨äº†<code>modelLoaderRegistry.getModelLoaders(model)</code>ï¼Œå¦‚æœè¿”å›ç»“æœä¸ä¸ºç©ºåˆ™è¿”å›è¯¥ç»“æœï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¸ªä¸€ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// ModelLoaderRegistry.java</span>
<span class=c1>// getModelLoadersæ–¹æ³•ä¼šè·å–æ‰€æœ‰å£°æ˜å¯ä»¥å¤„ç†Stringç±»å‹çš„ModelLoaderï¼Œå¹¶è°ƒç”¨handlesæ–¹æ³•è¿‡æ»¤æ‰è‚¯å®šä¸èƒ½å¤„ç†çš„</span>
<span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoaders</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>A</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
 <span class=c1>// è¿”å›æ‰€æœ‰æ³¨å†Œè¿‡çš„modelClassä¸ºStringçš„ModelLoaderï¼Œå°±æ˜¯ä¸Šé¢åˆ—å‡ºæ¥çš„å››ä¸ª</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>getModelLoadersForClass</span><span class=p>(</span><span class=n>getClass</span><span class=p>(</span><span class=n>model</span><span class=p>));</span>
 <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
 <span class=kt>boolean</span> <span class=n>isEmpty</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>filteredLoaders</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
 <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>loader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
   <span class=c1>// å¯¹äºæ¯ä¸ªModelLoaderï¼Œçœ‹çœ‹æ˜¯å¦å¯èƒ½å¤„ç†è¿™ç§ç±»å‹çš„æ•°æ®</span>
   <span class=c1>// æ­¤å¤„ä¼šè¿‡æ»¤ç¬¬ä¸€ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„urlä¸ä»¥data:imageå¼€å¤´</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>loader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>isEmpty</span><span class=p>)</span> <span class=p>{</span>
       <span class=n>filteredLoaders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>size</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
       <span class=n>isEmpty</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
     <span class=p>}</span>
     <span class=n>filteredLoaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>loader</span><span class=p>);</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>filteredLoaders</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// è¿”å›æ‰€æœ‰å£°æ˜å¯ä»¥å¤„ç†modelClassä¸ºStringçš„ModelLoader</span>
<span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoadersForClass</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>loaders</span> <span class=o>=</span> <span class=n>cache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>loaders</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>loaders</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>modelClass</span><span class=p>));</span>
   <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>loaders</span><span class=p>);</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>loaders</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬çœ‹çœ‹<code>multiModelLoaderFactory.build(modelClass)</code>æ˜¯å¦‚ä½•è·å–æ‰€æœ‰å£°æ˜å¯ä»¥å¤„ç†modelClassçš„ModelLoaderçš„ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=k>try</span> <span class=p>{</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>loaders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
   <span class=c1>// éå†æ‰€æœ‰æ³¨å†Œè¿›æ¥çš„entry</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
     <span class=c1>// Avoid stack overflow recursively creating model loaders by only creating loaders in</span>
     <span class=c1>// recursive requests if they haven&#39;t been created earlier in the chain. For example:</span>
     <span class=c1>// A Uri loader may translate to another model, which in turn may translate back to a Uri.</span>
     <span class=c1>// The original Uri loader won&#39;t be provided to the intermediate model loader, although</span>
     <span class=c1>// other Uri loaders will be.</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span> <span class=p>{</span>
       <span class=k>continue</span><span class=p>;</span>
     <span class=p>}</span>
     <span class=c1>// æ³¨å†Œè¿‡çš„entryæœ‰å¾ˆå¤šï¼Œä½†æ˜¯entry.modelClassæ˜¯modelClassï¼ˆå³String.classï¼‰çš„åŒç±»æˆ–çˆ¶ç±»çš„å´åªæœ‰å››ä¸ª</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
       <span class=c1>// å¯¹æ¯ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„entryè°ƒç”¨buildæ¥å£ï¼Œè·å–å¯¹åº”çš„ModelLoader</span>
       <span class=n>loaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span><span class=n>build</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
   <span class=k>return</span> <span class=n>loaders</span><span class=p>;</span>
 <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
   <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=kd>private</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span><span class=p>)</span> <span class=p>{</span>
 <span class=k>return</span> <span class=p>(</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=k>this</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œçš„entryçš„æ•°æ®ç»“æ„ä»¥åŠä¿å­˜çš„å€¼æˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°è¿‡ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>entry.factory.build(this)</code>åˆ›å»ºäº†å››ä¸ªä»€ä¹ˆæ ·çš„ModelLoaderï¼š</p> <ul> <li><code>append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</code><br> è¯¥Factoryä¼šåˆ›å»ºä¸€ä¸ªå¤„ç†data scheme(<code>data:[mediatype][;base64],encoded_data</code>, e.g. data:image/gif;base64,R0lGO...lBCBMQiB0UjIQA7)ç±»å‹æ•°æ®çš„<code>DataUrlLoader</code><br> <strong>å£°æ˜å¯èƒ½å¤„ç†ä»¥</strong><code>data:image</code><strong>å¼€å¤´çš„model</strong></li> <li><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> è¯¥Factoryèƒ½å¤Ÿä»Stringä¸­åŠ è½½InputStream<br> <strong>å£°æ˜å¯èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„model</strong></li> <li><code>.append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> è¯¥Factoryèƒ½å¤Ÿä»Stringä¸­åŠ è½½ParcelFileDescriptor<br> <strong>å£°æ˜å¯èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„model</strong></li> <li><code>.append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> è¯¥Factoryèƒ½å¤Ÿä»Stringä¸­åŠ è½½AssetFileDescriptor <br> <strong>å£°æ˜å¯èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„model</strong></li> </ul> <p>æ­¤å¤„çš„å››ä¸ªModelLoaderä¸­ï¼Œ<code>DataUrlLoader.StreamFactory</code>çš„é€»è¾‘éå¸¸æ¸…æ™°æ˜äº†ï¼Œå…¶ä»–ä¸‰ä¸ªæœ‰ç‚¹éº»çƒ¦ã€‚å› ä¸ºå®ƒä»¬éƒ½æ˜¯åˆ›å»ºçš„<code>StringLoader</code>ï¼Œè€Œ<code>StringLoader</code>å†…éƒ¨ä¹Ÿæœ‰ä¸€ä¸ª<code>MultiModelLoader</code>ï¼Œåœ¨Factoryä¸­build <code>StringLoader</code>æ—¶ï¼Œä¼šè°ƒç”¨<code>multiFactory.build</code>åˆ›å»ºä¸€ä¸ªå†…éƒ¨çš„<code>MultiModelLoader</code>ã€‚<br> å› ä¸ºStringå¯èƒ½æŒ‡å‘çš„æ•°æ®å¤ªå¤šäº†ï¼Œæ‰€ä»¥é‡‡å–<code>MultiModelLoader</code>ä¿å­˜æ‰€æœ‰å¯èƒ½çš„<code>ModelLoader</code>ï¼Œåœ¨å¤„ç†æ—¶ä¼šéå†listæ‰¾å‡ºæ‰€æœ‰å¯ä»¥å¤„ç†çš„ã€‚</p> <p>æˆ‘ä»¬çœ‹çœ‹<code>StringLoader.StreamFactory()</code>çš„buildè¿‡ç¨‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm> * Factory for loading {@link InputStream}s from Strings.</span>
<span class=cm> */</span>
<span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>StreamFactory</span> <span class=kd>implements</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=p>{</span>

 <span class=nd>@NonNull</span>
 <span class=nd>@Override</span>
 <span class=kd>public</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span>
     <span class=nd>@NonNull</span> <span class=n>MultiModelLoaderFactory</span> <span class=n>multiFactory</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>return</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>multiFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
 <span class=p>}</span>

 <span class=nd>@Override</span>
 <span class=kd>public</span> <span class=kt>void</span> <span class=nf>teardown</span><span class=p>()</span> <span class=p>{</span>
   <span class=c1>// Do nothing.</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œè°ƒç”¨äº†<code>MultiModelLoaderFactory.build(Class, Class)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„é‡è½½æ–¹æ³•<code>MultiModelLoaderFactory.build(Class)</code>æˆ‘ä»¬åœ¨ä¸Šé¢é‡åˆ°è¿‡ï¼Œä¸¤ä¸ªæ–¹æ³•æœ‰ä¸€äº›å·®åˆ«ï¼Œä¸è¦å¼„æ··æ·†äº†ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span> <span class=cm>/* Uri.class */</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span> <span class=cm>/* InputStream.class */</span><span class=p>)</span> <span class=p>{</span>
 <span class=k>try</span> <span class=p>{</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>loaders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
   <span class=kt>boolean</span> <span class=n>ignoredAnyEntries</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
     <span class=c1>// Avoid stack overflow recursively creating model loaders by only creating loaders in</span>
     <span class=c1>// recursive requests if they haven&#39;t been created earlier in the chain. For example:</span>
     <span class=c1>// A Uri loader may translate to another model, which in turn may translate back to a Uri.</span>
     <span class=c1>// The original Uri loader won&#39;t be provided to the intermediate model loader, although</span>
     <span class=c1>// other Uri loaders will be.</span>
     <span class=c1>//</span>
     <span class=c1>// é˜²æ­¢é€’å½’æ—¶é‡å¤åŠ è½½åˆ°ï¼Œé€ æˆStackOverflow</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>ignoredAnyEntries</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
       <span class=k>continue</span><span class=p>;</span>
     <span class=p>}</span>
     <span class=c1>// âš¡âš¡ï¸âš¡ï¸ å·®åˆ«1ï¼Œè¿™é‡Œä¼šæ£€æŸ¥ä¸¤ä¸ªclass</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
       <span class=n>loaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span><span class=n>build</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
   <span class=c1>// âš¡âš¡ï¸âš¡ï¸ å·®åˆ«2ï¼Œè¿™é‡Œä¼šæ£€æŸ¥loadersçš„æ•°é‡ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>loaders</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>return</span> <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>loaders</span><span class=p>,</span> <span class=n>throwableListPool</span><span class=p>);</span>
   <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>loaders</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>return</span> <span class=n>loaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
     <span class=c1>// Avoid crashing if recursion results in no loaders available. The assertion is supposed to</span>
     <span class=c1>// catch completely unhandled types, recursion may mean a subtype isn&#39;t handled somewhere</span>
     <span class=c1>// down the stack, which is often ok.</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>ignoredAnyEntries</span><span class=p>)</span> <span class=p>{</span>
       <span class=k>return</span> <span class=n>emptyModelLoader</span><span class=p>();</span>
     <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
       <span class=k>throw</span> <span class=k>new</span> <span class=n>NoModelLoaderAvailableException</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
   <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å››ä¸ªæ³¨å†Œé¡¹è°ƒç”¨<code>this.&lt;Model, Data&gt;build(entry)</code>åè¿”å›çš„å€¼ï¼š</p> <p><code>append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</code> - build &rarr; <code>DataUrlLoader</code></p> <p><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(Uri.class, InputStream.class)</code><br> å°†Stringå½“ä½œUriæ¥å¤„ç†ï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºUri.classï¼ŒdataClassä¸ºInputStream.classçš„æ³¨å†Œé¡¹<br> - <code>append(Uri.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;Uri&gt;())</code><br> - build &rarr; <code>DataUrlLoader</code> - <code>append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</code><br> - build &rarr; <code>HttpUriLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(GlideUrl.class, InputStream.class)</code><br> Uriå¯èƒ½æ˜¯ä¸€ä¸ªGlideUrlï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºGlideUrl.classï¼ŒdataClassä¸ºInputStream.classçš„æ³¨å†Œé¡¹ - <code>.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</code><br> - build &rarr; <code>HttpGlideUrlLoader</code> - <code>append(Uri.class, InputStream.class, new AssetUriLoader.StreamFactory(context.getAssets()))</code><br> - build &rarr; <code>AssetUriLoader</code> - <code>append(Uri.class, InputStream.class, new MediaStoreImageThumbLoader.Factory(context))</code><br> - build &rarr; <code>MediaStoreImageThumbLoader</code> - <code>append(Uri.class, InputStream.class, new MediaStoreVideoThumbLoader.Factory(context))</code><br> - build &rarr; <code>MediaStoreVideoThumbLoader</code> - <code>append(Uri.class, InputStream.class, new UriLoader.StreamFactory(contentResolver))</code><br> - build &rarr; <code>UriLoader</code> - <code>append(Uri.class, InputStream.class, new UrlUriLoader.StreamFactory())</code><br> - build &rarr; <code>UrlUriLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(GlideUrl.class, InputStream.class)</code><br> Uriå¯èƒ½æ˜¯ä¸€ä¸ªGlideUrlï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºGlideUrl.classï¼ŒdataClassä¸ºInputStream.classçš„æ³¨å†Œé¡¹ - <code>.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</code><br> - build &rarr; <code>HttpGlideUrlLoader</code> - <code>MultiModelLoader</code></p> <p><code>append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(Uri.class, ParcelFileDescriptor.class)</code><br> å°†Stringå½“ä½œUriæ¥å¤„ç†ï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºUri.classï¼ŒdataClassä¸ºParcelFileDescriptor.classçš„æ³¨å†Œé¡¹<br> - <code>append(Uri.class, ParcelFileDescriptor.class, new AssetUriLoader.FileDescriptorFactory(context.getAssets()))</code><br> - build &rarr; <code>AssetUriLoader</code> - <code>append(Uri.class, ParcelFileDescriptor.class, new UriLoader.FileDescriptorFactory(contentResolver))</code> <br> - build &rarr; <code>UriLoader</code> - <code>MultiModelLoader</code></p> <p><code>append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(Uri.class, AssetFileDescriptor.class)</code><br> å°†Stringå½“ä½œUriæ¥å¤„ç†ï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºUri.classï¼ŒdataClassä¸ºAssetFileDescriptor.classçš„æ³¨å†Œé¡¹<br> - <code>append(Uri.class, AssetFileDescriptor.class, new UriLoader.AssetFileDescriptorFactory(contentResolver))</code><br> - build &rarr; <code>UriLoader</code> - <code>UriLoader</code></p> <p>ä¸Šé¢å°±æ˜¯<code>this.&lt;Model, Data&gt;build(entry)</code>è·å¾—åˆ°çš„4ä¸ªloaderï¼Œç„¶ååœ¨<code>modelLoaderRegistry.getModelLoaders(model)</code>æ–¹æ³•ä¸­è¢«è¿‡æ»¤æ‰ç¬¬ä¸€ä¸ªï¼Œç°åœ¨å°±è¿”å›3.6.1èŠ‚åˆšå¼€å§‹çš„<code>DecodeHelper.getLoadData</code>æ–¹æ³•é‡Œé¢äº†ã€‚</p> <p>åœ¨<code>DecodeHelper.getLoadData</code>æ–¹æ³•ä¸­ä¼šéå†æ¯ä¸ªModelLoaderï¼Œå¹¶è°ƒç”¨å…¶<code>buildLoadData</code>æ–¹æ³•ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åŠ å…¥åˆ°æ•°ç»„ä¸­ã€‚ç”±äºæ­¤å¤„çš„3ä¸ªModelLoaderéƒ½æ˜¯<code>StringLoader</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹<code>StringLoader.buildLoadData</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=nf>buildLoadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>model</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
 <span class=c1>// ç”±äºæˆ‘ä»¬ä¼ å…¥çš„modelæ˜¯ä¸€ä¸ªç½‘ç»œå›¾ç‰‡åœ°å€ï¼Œæ‰€ä»¥uriè‚¯å®šæ˜¯æ­£å¸¸çš„</span>
 <span class=n>Uri</span> <span class=n>uri</span> <span class=o>=</span> <span class=n>parseUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
 <span class=c1>// ä¸‹é¢åˆ¤æ–­uriLoaderæ˜¯å¦æœ‰å¯èƒ½å¤„ç†</span>
 <span class=c1>// å¦‚æœæ²¡æœ‰å¯èƒ½ï¼Œé‚£ä¹ˆè¿”å›null</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>uri</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>uriLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>uri</span><span class=p>))</span> <span class=p>{</span>
   <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
 <span class=p>}</span>
 <span class=c1>// å¦åˆ™è°ƒç”¨uriLoaderçš„buildLoadDataæ–¹æ³•</span>
 <span class=k>return</span> <span class=n>uriLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Nullable</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=n>Uri</span> <span class=nf>parseUri</span><span class=p>(</span><span class=n>String</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>Uri</span> <span class=n>uri</span><span class=p>;</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
   <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
 <span class=c1>// See https://pmd.github.io/pmd-6.0.0/pmd_rules_java_performance.html#simplifystartswith</span>
 <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=sc>&#39;/&#39;</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>uri</span> <span class=o>=</span> <span class=n>toFileUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
 <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
   <span class=n>uri</span> <span class=o>=</span> <span class=n>Uri</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
   <span class=n>String</span> <span class=n>scheme</span> <span class=o>=</span> <span class=n>uri</span><span class=p>.</span><span class=na>getScheme</span><span class=p>();</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>scheme</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>uri</span> <span class=o>=</span> <span class=n>toFileUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>uri</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kd>static</span> <span class=n>Uri</span> <span class=nf>toFileUri</span><span class=p>(</span><span class=n>String</span> <span class=n>path</span><span class=p>)</span> <span class=p>{</span>
 <span class=k>return</span> <span class=n>Uri</span><span class=p>.</span><span class=na>fromFile</span><span class=p>(</span><span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>path</span><span class=p>));</span>
<span class=p>}</span>
</code></pre></div> <p>æ‰€ä»¥é‡ç‚¹å°±åœ¨äº<code>StringLoader.uriLoader</code>äº†ï¼Œè¯¥å‚æ•°æˆ‘ä»¬ä¸Šé¢åˆ†æé€’å½’è¿‡ç¨‹çš„æ—¶å€™åˆ†æåˆ°äº†ï¼Œæ˜¯ä¸€ä¸ª<code>MultiModelLoader</code>å¯¹è±¡ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>class</span> <span class=nc>MultiModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>

 <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>modelLoaders</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;&gt;</span> <span class=n>exceptionListPool</span><span class=p>;</span>

 <span class=n>MultiModelLoader</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>modelLoaders</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;&gt;</span> <span class=n>exceptionListPool</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>this</span><span class=p>.</span><span class=na>modelLoaders</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>;</span>
   <span class=k>this</span><span class=p>.</span><span class=na>exceptionListPool</span> <span class=o>=</span> <span class=n>exceptionListPool</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=nd>@Override</span>
 <span class=kd>public</span> <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=nf>buildLoadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Model</span> <span class=n>model</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>Key</span> <span class=n>sourceKey</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
   <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>fetchers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
   <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>modelLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
       <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
         <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>;</span>
         <span class=n>fetchers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>);</span>
       <span class=p>}</span>
     <span class=p>}</span>
   <span class=p>}</span>
   <span class=k>return</span> <span class=o>!</span><span class=n>fetchers</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>sourceKey</span> <span class=o>!=</span> <span class=kc>null</span>
       <span class=o>?</span> <span class=k>new</span> <span class=n>LoadData</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=k>new</span> <span class=n>MultiFetcher</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>fetchers</span><span class=p>,</span> <span class=n>exceptionListPool</span><span class=p>))</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=nd>@Override</span>
 <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Model</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>modelLoader</span> <span class=p>:</span> <span class=n>modelLoaders</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>modelLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
       <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
     <span class=p>}</span>
   <span class=p>}</span>
   <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>MultiModelLoader</code>ç±»çš„<code>handles</code>æ–¹æ³•å’Œ<code>buildLoadData</code>æ–¹æ³•éƒ½æ¯”è¾ƒæ¸…æ™°æ˜äº†ã€‚ </p> <ul> <li><code>handles</code>æ–¹æ³•æ˜¯åªè¦å†…éƒ¨æœ‰ä¸€ä¸ªModelLoaderæœ‰å¯èƒ½å¤„ç†ï¼Œå°±è¿”å›trueã€‚ </li> <li><code>buildLoadData</code>æ–¹æ³•ä¼šå…ˆè°ƒç”¨<code>hanldes</code>è¿›è¡Œç¬¬ä¸€æ¬¡ç­›é€‰ï¼Œç„¶ååœ¨è°ƒç”¨ModelLoaderçš„<code>buildLoadData</code>æ–¹æ³•ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ä¿å­˜èµ·æ¥ï¼Œæœ€åè¿”å›<code>LoadData&lt;&gt;(sourceKey, new MultiFetcher&lt;&gt;(fetchers, exceptionListPool))</code>å¯¹è±¡ã€‚</li> </ul> <p>æˆ‘ä»¬è¿˜æ˜¯èµ°ä¸€ä¸‹<code>DecodeHelper.getLoadData</code>æ–¹æ³•ä¸­çš„æµç¨‹ï¼Œéå†ä¸€ä¸‹è°ƒç”¨ä¸‰ä¸ª<code>StringLoader</code>çš„<code>buildLoadData</code>æ–¹æ³•ï¼š</p> <p><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>MultiModelLoader</code> - <code>DataUrlLoader</code> å¤„ç†data:imageèµ„æº<br> 1 <em>handles</em>: <strong>false</strong><br> 3 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º*handles* return <strong>false</strong> - <code>HttpUriLoader</code> å¤„ç†httpã€httpsèµ„æº å‚æ•°urlLoader = <code>HttpGlideUrlLoader</code><br> 2 <em>handles</em>: <strong>true</strong><br> 4 <em>buildLoadData</em>: <code>HttpGlideUrlLoader.buildLoadData(GlideUrl)</code> &rarr; <code>LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout))</code> ---&gt; <code>fetchers.add(loadData.fetcher)</code> - <code>AssetUriLoader</code> å¤„ç†file:///android_asset/èµ„æº<br> 5 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º*handles* return <strong>false</strong> - <code>MediaStoreImageThumbLoader</code> å¤„ç†content://media/ä¸”path segmentsä¸­ä¸åŒ…å«videoå­—ç¬¦ä¸²çš„èµ„æº<br> 6 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º*handles* return <strong>false</strong> - <code>MediaStoreVideoThumbLoader</code> å¤„ç†content://media/ä¸”path segmentsä¸­åŒ…å«videoå­—ç¬¦ä¸²çš„èµ„æº<br> 7 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º*handles* return <strong>false</strong> - <code>UriLoader</code> å¤„ç†schemeä¸ºfileã€android.resourceã€contentçš„èµ„æº<br> 8 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º*handles* return <strong>false</strong> - <code>UrlUriLoader</code> å¤„ç†httpã€httpsèµ„æº å‚æ•°urlLoader = <code>HttpGlideUrlLoader</code><br> 9 <em>buildLoadData</em>: <code>HttpGlideUrlLoader.buildLoadData(GlideUrl)</code> ---&gt; <code>LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout))</code> ---&gt; <code>fetchers.add(loadData.fetcher)</code> - å¾—åˆ° <code>LoadData&lt;&gt;(sourceKey, new MultiFetcher&lt;&gt;(fetchers, exceptionListPool))</code></p> <p><code>append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>MultiModelLoader</code> - <code>AssetUriLoader</code> å¤„ç†file:///android_asset/èµ„æº<br> 1 <em>handles</em>: <strong>false</strong><br> - <code>UriLoader</code> å¤„ç†schemeä¸ºfileã€android.resourceã€contentçš„èµ„æº<br> 2 <em>handles</em>: <strong>false</strong><br> - å¾—åˆ° <code>null</code></p> <p><code>append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = - <code>UriLoader</code> å¤„ç†schemeä¸ºfileã€android.resourceã€contentçš„èµ„æº<br> 1 <em>handles</em>: <strong>false</strong><br> - å¾—åˆ° <code>null</code></p> <p>ç”±äº<code>DecodeHelper.getLoadData</code>åªæ·»åŠ ä¸ä¸ºnullçš„<code>LoadData</code>ï¼Œæ‰€ä»¥åªè¿”å›äº†ä¸€ä¸ª<code>StringLoader.StreamFactory()</code>ç”Ÿæˆçš„<code>LoadData</code>ã€‚ </p> <p>è¿”å›åˆ°ä¸Šä¸€ä¸ªæ–¹æ³•<code>DecodeHelper.getCacheKeys</code>ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=nf>getCacheKeys</span><span class=p>()</span> <span class=p>{</span>
 <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCacheKeysSet</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>isCacheKeysSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
   <span class=n>cacheKeys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>loadData</span> <span class=o>=</span> <span class=n>getLoadData</span><span class=p>();</span>
   <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>LoadData</span><span class=o>&lt;?&gt;</span> <span class=n>data</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>);</span>
     <span class=p>}</span>
     <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
       <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>)))</span> <span class=p>{</span>
         <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>));</span>
       <span class=p>}</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>cacheKeys</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>å¾ˆæ˜¾ç„¶ï¼Œè¿”å›çš„listä¸­åªæœ‰ä¸€ä¸ªkeyï¼šä¸Šé¢çš„<code>LoadData</code>çš„<code>sourceKey</code>ï¼Œå³<code>GlideUrl</code>ã€‚</p> <h4 id=362-dhgetregisteredresourceclasses>3.6.2 DH.getRegisteredResourceClasses<a class=headerlink href=#362-dhgetregisteredresourceclasses title="Permanent link">&para;</a></h4> <p>æ¥ç€è¿”å›åˆ°ä¸Šä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æœ¬å°èŠ‚çš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>ResourceCacheGenerator.startNext</code>ä¸­ã€‚<br> æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ä»£ç æ˜¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// ResourceCacheGenerator.startNext</span>
<span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceClasses</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>();</span>

<span class=c1>// DecodeHelper</span>
<span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getRegisteredResourceClasses</span><span class=p>()</span> <span class=p>{</span>
 <span class=k>return</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>()</span>
     <span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œåˆå›åˆ°äº†<code>Registry</code>ç±»ä¸­ï¼Œå¤´ç–¼ã€‚ä½†è¿˜æ˜¯è¦åˆ†æã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getRegisteredResourceClasses</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=c1>// modelClass = String.class</span>
 <span class=c1>// resourceClass é»˜è®¤ä¸º Object.class</span>
 <span class=c1>// transcodeClass = Drawable.class</span>
 <span class=c1>//</span>
 <span class=c1>// é¦–å…ˆå–ç¼“å­˜</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span>
     <span class=n>modelToResourceClassCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>

 <span class=c1>// æœ‰ç¼“å­˜å°±è¿”å›ç¼“å­˜ï¼Œæ²¡æœ‰å°±åŠ è½½ï¼Œç„¶åæ”¾å…¥ç¼“å­˜</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
   <span class=c1>// ä»modelLoaderRegistryä¸­å¯»æ‰¾æ‰€æœ‰modelClassä¸ºStringæˆ–çˆ¶ç±»çš„entryï¼Œå¹¶è¿”å›å…¶dataClass</span>
   <span class=c1>// æ­¤å¤„å¾—åˆ°çš„dataClassesä¸º[InputStream.class, ParcelFileDescriptor.class, AssetFileDescriptor.class]  </span>
   <span class=c1>// å› ä¸ºå››ä¸ªæ³¨å†Œé¡¹ä¸­ï¼Œå‰ä¸¤ä¸ªdataClasséƒ½ä¸ºInputStream.classï¼Œå»é‡æ—¶è‚¯å®šä¼šå»æ‰ä¸€ä¸ª</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>dataClasses</span> <span class=o>=</span> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>getDataClasses</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span> <span class=p>:</span> <span class=n>dataClasses</span><span class=p>)</span> <span class=p>{</span>
       <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥ çœ‹ä¸æ‡‚äº†ï¼Œå…ˆçœ‹çœ‹å¯¹åº”çš„ResourceDecoderRegistryæ•°æ®ç»“æ„å§</span>
       <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>registeredResourceClasses</span> <span class=o>=</span>
           <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
       <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>registeredResourceClass</span> <span class=p>:</span> <span class=n>registeredResourceClasses</span><span class=p>)</span> <span class=p>{</span>
         <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>registeredTranscodeClasses</span> <span class=o>=</span> <span class=n>transcoderRegistry</span>
             <span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
         <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>registeredTranscodeClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>))</span> <span class=p>{</span>
           <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>);</span>
         <span class=p>}</span>
       <span class=p>}</span>
     <span class=p>}</span>
   <span class=n>modelToResourceClassCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span>
       <span class=n>modelClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>result</span><span class=p>));</span>
 <span class=p>}</span>

 <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥ è·å–å®ŒdataClassesåï¼Œä¸‹é¢è¦å¯¹æ¯ä¸€ä¸ªdataClassè°ƒç”¨<code>decoderRegistry.getResourceClasses</code>æ–¹æ³•ã€‚ </p> <p>è¿™é‡Œæ¶‰åŠåˆ°äº†<code>ResourceDecoderRegistry</code>ç±»ï¼ŒåŒæ ·è¯¥ç±»ä¸­çš„æ•°æ®ä¹Ÿæ˜¯Glideåˆ›å»ºæ—¶æ³¨å…¥çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç›¸å…³çš„ä»£ç ã€‚</p> <div class=highlight><pre><span></span><code><span class=c1>// Glide</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>byteBufferBitmapDecoder</span><span class=p>)</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>streamBitmapDecoder</span><span class=p>)</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span>
<span class=n>parcelFileDescriptorVideoDecoder</span><span class=p>)</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>AssetFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>VideoDecoder</span><span class=p>.</span><span class=na>asset</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>UnitBitmapDecoder</span><span class=p>())</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span> <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>byteBufferBitmapDecoder</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>streamBitmapDecoder</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span> <span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>parcelFileDescriptorVideoDecoder</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_GIF</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StreamGifDecoder</span><span class=p>(</span><span class=n>imageHeaderParsers</span><span class=p>,</span> <span class=n>byteBufferGifDecoder</span><span class=p>,</span> <span class=n>arrayPool</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_GIF</span><span class=p>,</span> <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>byteBufferGifDecoder</span><span class=p>)</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>GifDecoder</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>GifFrameResourceDecoder</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>resourceDrawableDecoder</span><span class=p>)</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>ResourceBitmapDecoder</span><span class=p>(</span><span class=n>resourceDrawableDecoder</span><span class=p>,</span> <span class=n>bitmapPool</span><span class=p>))</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>FileDecoder</span><span class=p>())</span>
<span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>UnitDrawableDecoder</span><span class=p>())</span>

<span class=c1>// Registry</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Registry</span> <span class=p>{</span>
 <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_GIF</span> <span class=o>=</span> <span class=s>&quot;Gif&quot;</span><span class=p>;</span>
 <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_BITMAP</span> <span class=o>=</span> <span class=s>&quot;Bitmap&quot;</span><span class=p>;</span>
 <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_BITMAP_DRAWABLE</span> <span class=o>=</span> <span class=s>&quot;BitmapDrawable&quot;</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_PREPEND_ALL</span> <span class=o>=</span> <span class=s>&quot;legacy_prepend_all&quot;</span><span class=p>;</span>
 <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_APPEND_ALL</span> <span class=o>=</span> <span class=s>&quot;legacy_append&quot;</span><span class=p>;</span>

 <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceDecoderRegistry</span> <span class=n>decoderRegistry</span><span class=p>;</span>

 <span class=kd>public</span> <span class=nf>Registry</span><span class=p>()</span> <span class=p>{</span>
   <span class=k>this</span><span class=p>.</span><span class=na>decoderRegistry</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResourceDecoderRegistry</span><span class=p>();</span>
   <span class=n>setResourceDecoderBucketPriorityList</span><span class=p>(</span>
       <span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>BUCKET_GIF</span><span class=p>,</span> <span class=n>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>BUCKET_BITMAP_DRAWABLE</span><span class=p>));</span>
 <span class=p>}</span>

 <span class=nd>@NonNull</span>
 <span class=kd>public</span> <span class=kd>final</span> <span class=n>Registry</span> <span class=nf>setResourceDecoderBucketPriorityList</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>buckets</span><span class=p>)</span> <span class=p>{</span>
   <span class=c1>// See #3296 and https://bugs.openjdk.java.net/browse/JDK-6260652.</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>modifiedBuckets</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>buckets</span><span class=p>.</span><span class=na>size</span><span class=p>());</span>
   <span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buckets</span><span class=p>);</span>
   <span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>BUCKET_PREPEND_ALL</span><span class=p>);</span>
   <span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>BUCKET_APPEND_ALL</span><span class=p>);</span>
   <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>setBucketPriorityList</span><span class=p>(</span><span class=n>modifiedBuckets</span><span class=p>);</span>
   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=nd>@NonNull</span>
 <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>append</span><span class=p>(</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>append</span><span class=p>(</span><span class=n>BUCKET_APPEND_ALL</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>decoder</span><span class=p>);</span>
   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=nd>@NonNull</span>
 <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>append</span><span class=p>(</span>
     <span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span> <span class=n>decoder</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=nd>@NonNull</span>
 <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>prepend</span><span class=p>(</span>
     <span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span> <span class=n>decoder</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// ResourceDecoderRegistry</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourceDecoderRegistry</span> <span class=p>{</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>bucketPriorityList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;&gt;</span> <span class=n>decoders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>

 <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setBucketPriorityList</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>buckets</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>previousBuckets</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>bucketPriorityList</span><span class=p>);</span>
   <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
   <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buckets</span><span class=p>);</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>previousBucket</span> <span class=p>:</span> <span class=n>previousBuckets</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>buckets</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>previousBucket</span><span class=p>))</span> <span class=p>{</span>
       <span class=c1>// Keep any buckets from the previous list that aren&#39;t included here, but but them at the</span>
       <span class=c1>// end.</span>
       <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>previousBucket</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span>

 <span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>append</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>getOrAddEntryList</span><span class=p>(</span><span class=n>bucket</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>decoder</span><span class=p>));</span>
 <span class=p>}</span>

 <span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>prepend</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>getOrAddEntryList</span><span class=p>(</span><span class=n>bucket</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>decoder</span><span class=p>));</span>
 <span class=p>}</span>

 <span class=nd>@NonNull</span>
 <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getOrAddEntryList</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>bucket</span><span class=p>))</span> <span class=p>{</span>
     <span class=c1>// Add this unspecified bucket as a low priority bucket.</span>
     <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>entries</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
     <span class=n>entries</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
     <span class=n>decoders</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span> <span class=n>entries</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=k>return</span> <span class=n>entries</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>ResourceDecoderRegistry</code>å†…éƒ¨ç»´æŒç€ä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§ bucket çš„ listï¼Œä¼˜å…ˆçº§é¡ºåºç”±BUCKETåœ¨<code>bucketPriorityList</code>ä¸­çš„é¡ºåºå†³å®šã€‚<br> åœ¨<code>Registry</code>çš„æ„é€ å™¨ä¸­ï¼Œåˆ›å»º<code>ResourceDecoderRegistry</code>åï¼Œå°±è°ƒç”¨<code>setResourceDecoderBucketPriorityList</code>æ–¹æ³•è°ƒæ•´äº†å…¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§åˆ«ä¸ºï¼š<br> BUCKET_PREPEND_ALL, BUCKET_GIF, BUCKET_BITMAP, BUCKET_BITMAP_DRAWABLE, BUCKET_APPEND_ALLã€‚ </p> <p><code>ResourceDecoderRegistry</code>çš„<code>append</code>æ–¹æ³•å’Œ<code>prepend</code>æ–¹æ³•å°±æ˜¯å‘å¯¹åº”çš„æ¡¶ä¸­å°†entryæ’å…¥åˆ°å°¾éƒ¨æˆ–å¤´éƒ¨ã€‚</p> <p>ä¸‹é¢å°±æ˜¯<code>ResourceDecoderRegistry</code>é‡Œé¢æ•°æ®çš„å›¾ï¼Œdecodersé‡Œé¢çš„æ•°å­—è¡¨ç¤ºçš„Entryä¸ä¸Šé¢æ³¨å†Œä»£ç ä¸­è¡Œæ•°ç›¸å¯¹åº”ï¼š</p> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/glide-resource-decoder-registry-content.png> <figcaption>ResourceDecoderRegistryå†…éƒ¨æ•°æ®æ¨¡å‹</figcaption> </figure> <p>äº†è§£å®Œäº†<code>ResourceDecoderRegistry</code>ä¹‹åï¼Œæˆ‘ä»¬åœ¨å›åˆ°ğŸ”¥ğŸ”¥ğŸ”¥åŸæ¥çš„ä½ç½®ç»§ç»­çœ‹çœ‹<code>decoderRegistry.getResourceClasses</code>æ–¹æ³•å¹²äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=nf>getResourceClasses</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
 <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>bucket</span> <span class=p>:</span> <span class=n>bucketPriorityList</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>entries</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>continue</span><span class=p>;</span>
   <span class=p>}</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>)</span>
         <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>é‚£ä¹ˆï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æ ¹æ®ä¼ å…¥çš„dataClassä»¥åŠresourceClassåœ¨æ¡¶ä¸­ä¾æ¬¡æŒ‰é¡ºåºæŸ¥æ‰¾æ˜ å°„å…³ç³»ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°å°±è¿”å›è¿™æ¡æ˜ å°„å…³ç³»çš„resourceClassã€‚</p> <p>è¿™é‡Œçš„å…¥å‚<code>dataClass inã€€[InputStream.class, ParcelFileDescriptor.class, AssetFileDescriptor.class]</code>, <code>resourceClass = Object.class</code>ã€‚ </p> <p>ä¸Šé¢çš„æ–¹æ³•ä¼šè¿è¡Œä¸‰æ¬¡ï¼Œæ¯ä¸€æ¬¡çš„ç»“æœå¦‚ä¸‹ï¼š</p> <ol> <li>InputStream.class &amp; Object.class<br> æ³¨å†Œè¡¨ç¬¬11ã€3ã€9è¡Œæ‰€å¯¹åº”çš„resourceClass å³<code>GifDrawable.class</code>ã€<code>Bitmap.class</code>ã€<code>BitmapDrawable.class</code></li> <li>ParcelFileDescriptor.class &amp; Object.class<br> æ³¨å†Œè¡¨ç¬¬4ã€10è¡Œæ‰€å¯¹åº”çš„resourceClass å³<code>Bitmap.class</code>ã€<code>BitmapDrawable.class</code></li> <li>AssetFileDescriptor.class &amp; Object.class<br> æ³¨å†Œè¡¨ç¬¬6è¡Œæ‰€å¯¹åº”çš„resourceClass å³<code>Bitmap.class</code></li> </ol> <p>OKï¼Œç¦»çœ‹å®Œè¿™ä¸ªéƒ¨åˆ†çš„ä»£ç æ›´è¿‘äº†ä¸€æ­¥ï¼Œæˆ‘çš„çœ¼ç›å·²ç»å—ä¸äº†äº†:( </p> <p>å›åˆ°<code>Registry.getRegisteredResourceClasses</code>æ–¹æ³•ä¸­ï¼Œä¸‹é¢å°†ä¼šå¯¹æ¯æ¬¡è¿è¡Œè¿”å›çš„resourceClassesæ•°ç»„è¿›è¡Œéå†ï¼Œå¹¶è°ƒç”¨äº†<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// Registry.getRegisteredResourceClasses</span>
<span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span> <span class=p>:</span> <span class=n>dataClasses</span><span class=p>)</span> <span class=p>{</span>
 <span class=c1>// æˆ‘ä»¬åˆšæ‰åˆ†æäº†è¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›å€¼çœ‹ä¸Šé¢çš„åˆ†æ</span>
 <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>registeredResourceClasses</span> <span class=o>=</span>
     <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
 <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>registeredResourceClass</span> <span class=p>:</span> <span class=n>registeredResourceClasses</span><span class=p>)</span> <span class=p>{</span>
   <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥ ç°åœ¨åˆ†æè¿™ä¸ªæ–¹æ³•</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>registeredTranscodeClasses</span> <span class=o>=</span> <span class=n>transcoderRegistry</span>
       <span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>registeredTranscodeClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>))</span> <span class=p>{</span>
     <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>);</span>
   <span class=p>}</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥ ç°åœ¨åˆ†æä¸€ä¸‹<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ã€‚</p> <p>å’Œä¸Šé¢åˆ†æè¿‡çš„ä¸¤ä¸ªRegistryä¸€æ ·ï¼Œ<code>TranscoderRegistry</code>ä¹ŸåŒæ ·æ˜¯åœ¨Glideæ„å»ºçš„æ—¶å€™æ³¨å†Œè¿›æ¥çš„ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// Glide</span>
<span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableTranscoder</span><span class=p>(</span><span class=n>resources</span><span class=p>))</span>
<span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>bitmapBytesTranscoder</span><span class=p>)</span>
<span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>DrawableBytesTranscoder</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>,</span> <span class=n>bitmapBytesTranscoder</span><span class=p>,</span> <span class=n>gifDrawableBytesTranscoder</span><span class=p>))</span>
<span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>gifDrawableBytesTranscoder</span><span class=p>);</span>

<span class=c1>// Registry</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Registry</span> <span class=p>{</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>TranscoderRegistry</span> <span class=n>transcoderRegistry</span><span class=p>;</span>

 <span class=kd>public</span> <span class=nf>Registry</span><span class=p>()</span> <span class=p>{</span>
   <span class=k>this</span><span class=p>.</span><span class=na>transcoderRegistry</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TranscoderRegistry</span><span class=p>();</span>
 <span class=p>}</span>

 <span class=nd>@NonNull</span>
 <span class=kd>public</span> <span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>register</span><span class=p>(</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcoder</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>transcoder</span><span class=p>);</span>
   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>TranscoderRegistry</span> <span class=p>{</span>
 <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>transcoders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>

 <span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>register</span><span class=p>(</span>
     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decodedClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodedClass</span><span class=p>,</span>
     <span class=nd>@NonNull</span> <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>transcoder</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>transcoders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>decodedClass</span><span class=p>,</span> <span class=n>transcodedClass</span><span class=p>,</span> <span class=n>transcoder</span><span class=p>));</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æ³¨å†Œä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ä¿å­˜åˆ°listä¸­å°±å®Œäº‹äº†ã€‚çœ‹çœ‹<code>TranscoderRegistry.getTranscodeClasses</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=nf>getTranscodeClasses</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>transcodeClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
 <span class=c1>// GifDrawable -&gt; Drawable is just the UnitTranscoder, as is GifDrawable -&gt; GifDrawable.</span>
 <span class=c1>// ğŸ”¥è·¯å¾„1</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>transcodeClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>))</span> <span class=p>{</span>
   <span class=n>transcodeClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
   <span class=k>return</span> <span class=n>transcodeClasses</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=c1>// ğŸ”¥è·¯å¾„2</span>
 <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>transcoders</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>))</span> <span class=p>{</span>
     <span class=n>transcodeClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
   <span class=p>}</span>
 <span class=p>}</span>

 <span class=c1>// listæ·»åŠ çš„éƒ½æ˜¯å…¥å‚transcodeClass</span>
 <span class=k>return</span> <span class=n>transcodeClasses</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>æ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯æ ¹æ®resourceClasså’ŒtranscodeClassï¼Œä»è‡ªèº«æˆ–è€…æ³¨å†Œè¡¨çš„â€œmapâ€ä¸­æ‰¾å‡º<code>transcodeClass</code>ã€‚</p> <p>å›åˆ°<code>Registry.getRegisteredResourceClasses</code>æ–¹æ³•ä¸­çš„ç¬¬äºŒå±‚for loopç»§ç»­åˆ†æï¼Œä¸‹é¢å°±æ˜¯å¯¹æ¯ä¸ªresourceClasså¾—åˆ°çš„registeredTranscodeClassesï¼ˆtranscodeClassä¸º<code>Drawable.class</code>ï¼‰</p> <ol> <li>InputStream.class &amp; Object.class<br> resourceClassä¸º</li> <li><code>GifDrawable.class</code><br> è·¯å¾„1 å…è®¸æ·»åŠ resourceClass</li> <li><code>Bitmap.class</code><br> è·¯å¾„2 èµ°Glideæ³¨å…¥ä»£ç ç‰‡æ®µçš„ç¬¬2è¡Œ å…è®¸æ·»åŠ resourceClass</li> <li><code>BitmapDrawable.class</code><br> è·¯å¾„1 å…è®¸æ·»åŠ resourceClass</li> <li>ParcelFileDescriptor.class &amp; Object.class<br> resourceClassä¸º</li> <li><code>Bitmap.class</code><br> è·¯å¾„2 èµ°Glideæ³¨å…¥ä»£ç ç‰‡æ®µçš„ç¬¬2è¡Œ ä½†resourceClasså·²ç»æ·»åŠ è¿‡</li> <li><code>BitmapDrawable.class</code><br> è·¯å¾„1 ä½†resourceClasså·²ç»æ·»åŠ è¿‡</li> <li>AssetFileDescriptor.class &amp; Object.class<br> resourceClassä¸º</li> <li><code>Bitmap.class</code><br> è·¯å¾„2 èµ°Glideæ³¨å…¥ä»£ç ç‰‡æ®µçš„ç¬¬2è¡Œ ä½†resourceClasså·²ç»æ·»åŠ è¿‡</li> </ol> <p>å› æ­¤ï¼Œ<code>Registry.getRegisteredResourceClasses</code>è¿”å›äº†<code>[GifDrawable.classã€Bitmap.classã€BitmapDrawable.class]</code>æ•°ç»„ï¼Œè¯¥æ•°ç»„ä¼šç»è¿‡<code>DecodeHelper</code>è¿”å›åˆ°<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•çš„è°ƒç”¨ä¸­ã€‚</p> <h4 id=363>3.6.3 å¯»æ‰¾ç¼“å­˜æ–‡ä»¶å¹¶åŠ è½½<a class=headerlink href=#363 title="Permanent link">&para;</a></h4> <p>ç»§ç»­å›åˆ°æœ¬å°èŠ‚çš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•ä¸­ã€‚ä¸‹é¢è¦æ‰§è¡Œçš„ä»£ç æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œå¾ªç¯ç»“æŸçš„æ ‡å¿—æ˜¯æ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// éå†sourceIdsä¸­çš„æ¯ä¸€ä¸ªkeyã€resourceClassesä¸­æ¯ä¸€ä¸ªclassï¼Œä»¥åŠå…¶ä»–çš„ä¸€äº›å€¼ç»„æˆkey</span>
<span class=c1>// å°è¯•åœ¨ç£ç›˜ç¼“å­˜ä¸­ä»¥keyæ‰¾åˆ°ç¼“å­˜æ–‡ä»¶</span>
<span class=k>while</span> <span class=p>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
 <span class=n>resourceClassIndex</span><span class=o>++</span><span class=p>;</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>resourceClassIndex</span> <span class=o>&gt;=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
   <span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
     <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
   <span class=p>}</span>
   <span class=n>resourceClassIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
 <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=p>);</span>
 <span class=n>Transformation</span><span class=o>&lt;?&gt;</span> <span class=n>transformation</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
 <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops Each iteration is comparatively expensive anyway,</span>
 <span class=c1>// we only run until the first one succeeds, the loop runs for only a limited</span>
 <span class=c1>// number of iterations on the order of 10-20 in the worst case.</span>
 <span class=n>currentKey</span> <span class=o>=</span>
     <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops</span>
         <span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
         <span class=n>sourceId</span><span class=p>,</span>
         <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
         <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
         <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
         <span class=n>transformation</span><span class=p>,</span>
         <span class=n>resourceClass</span><span class=p>,</span>
         <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
 <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>currentKey</span><span class=p>);</span>
 <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ªç¯æ¡ä»¶åˆ™ä¼šä¸ºfalseï¼Œä¹Ÿå°±é€€å‡ºå¾ªç¯äº†</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=p>;</span>
   <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
   <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
 <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>èµ°åˆ°è¿™é‡Œï¼Œç”±äºæ˜¯åˆæ¬¡åŠ è½½ï¼Œæ‰€ä»¥DiskLruCacheé‡Œé¢è‚¯å®šæ˜¯æ²¡æœ‰ç¼“å­˜çš„ã€‚ </p> <p>æ³¨æ„è¿™é‡Œçš„Keyçš„ç»„æˆï¼Œåœ¨ä¹‹å‰æˆ‘ä»¬æè¿°è¿‡<code>ResourceCacheGenerator</code>çš„ä½œç”¨ï¼šè·å–é‡‡æ ·åã€transformedåèµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶ã€‚åœ¨ç¬¬3èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDownsampleStrategyå’ŒTransformationä¿å­˜åœ¨äº†<code>BaseRequestOptions</code>é‡Œé¢ï¼Œå‰è€…ä¿å­˜åœ¨<code>BaseRequestOptions.Options</code>é‡Œï¼Œåè€…ä¿å­˜åœ¨<code>transformations</code>é‡Œã€‚åœ¨è¿™é‡Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½ä½œä¸ºäº†ç¼“å­˜æ–‡ä»¶çš„Keyï¼Œè¿™ä¹Ÿä¾§é¢éªŒè¯äº†<code>ResourceCacheGenerator</code>çš„ä½œç”¨ã€‚</p> <p>ä½†åœ¨åŠ è½½ä»£ç ä¸ŠåŠ ä¸Šè¯<code>.diskCacheStrategy(DiskCacheStrategy.RESOURCE)</code>ï¼Œå°±å¯ä»¥åˆ°äº†ç¼“å­˜ï¼Œè¿™æ ·å¯ä»¥æ¥ç€ä¸€æ¬¡æ€§æŠŠåé¢çš„æ–¹æ³•ä¹Ÿåˆ†æå®Œï¼Œå…ˆçœ‹çœ‹ä¸‹é¢çš„è¿™ä¸ªæ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
</code></pre></div> <p>å†…éƒ¨è°ƒç”¨äº†<code>Registry.getModelLoaders</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoaders</span><span class=p>(</span><span class=n>File</span> <span class=n>file</span><span class=p>)</span>
   <span class=kd>throws</span> <span class=n>Registry</span><span class=p>.</span><span class=na>NoModelLoaderAvailableException</span> <span class=p>{</span>
 <span class=k>return</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¯¥æ–¹æ³•æˆ‘ä»¬ä¸Šé¢å…·ä½“åˆ†æè¿‡ï¼Œç¨åŠ å›å¿†åæˆ‘ä»¬å¯ä»¥å†™å‡º<code>getModelLoaders(File)</code>æ–¹æ³•çš„è¿‡ç¨‹ï¼š</p> <ol> <li>é¦–å…ˆæ‰¾å‡ºæ³¨å…¥æ—¶ä»¥<code>File.class</code>ä¸ºmodelClassçš„æ³¨å…¥ä»£ç </li> <li>è°ƒç”¨æ‰€æœ‰æ³¨å…¥çš„<code>factory.build</code>æ–¹æ³•å¾—åˆ°<code>ModelLoader</code></li> <li>è¿‡æ»¤æ‰ä¸å¯èƒ½å¤„ç†<code>model</code>çš„<code>ModelLoader</code></li> </ol> <p>è¿™æ ·å¾—åˆ°äº†ä»¥ä¸‹å››ä¸ªModelLoader</p> <ul> <li><code>.append(File.class, ByteBuffer.class, new ByteBufferFileLoader.Factory())</code></li> <li><code>ByteBufferFileLoader</code></li> <li><code>.append(File.class, InputStream.class, new FileLoader.StreamFactory())</code></li> <li><code>FileLoader</code></li> <li><code>.append(File.class, ParcelFileDescriptor.class, new FileLoader.FileDescriptorFactory())</code></li> <li><code>FileLoader</code></li> <li><code>.append(File.class, File.class, UnitModelLoader.Factory.&lt;File&gt;getInstance())</code></li> <li><code>UnitModelLoader</code></li> </ul> <p>æ‰€ä»¥æ­¤æ—¶çš„modelLoaderså€¼ä¸º<code>[ByteBufferFileLoader, FileLoader, FileLoader, UnitModelLoader]</code>ã€‚</p> <p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨æ¯ä¸€ä¸ªModelLoaderå°è¯•åŠ è½½æ•°æ®ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å¤„ç†çš„ModelLoaderï¼š</p> <div class=highlight><pre><span></span><code><span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
 <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
 <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span>
     <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span> <span class=p>{</span>
   <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
   <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
 <span class=p>}</span>
<span class=p>}</span>

<span class=k>return</span> <span class=n>started</span><span class=p>;</span>
</code></pre></div> <p>è¿™å››ä¸ªModelLoaderéƒ½ä¼šè°ƒç”¨<code>buildLoadData</code>æ–¹æ³•åˆ›å»º<code>LoadData</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡é‡è¦çš„æˆå‘˜å˜é‡æ˜¯<code>DataFetcher</code>ï¼›ç„¶åè°ƒç”¨<code>helper.hasLoadPath</code>æ ¹æ®<code>resourceClass</code>å‚æ•°å’Œ<code>transcodeClass</code>å‚æ•°åˆ¤æ–­æ˜¯å¦æœ‰è·¯å¾„è¾¾åˆ°<code>DataFetcher.getDataClass</code>ï¼Œå¦‚æœæœ‰é‚£å°±è°ƒç”¨æ­¤fetcherè¿›è¡ŒloadDataï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p> <p>ä¾‹å­ä¸­ç¬¦åˆæ¡ä»¶çš„<code>ModelLoader</code>ä»¥åŠå…¶<code>fetcher</code>å¦‚ä¸‹ï¼š</p> <ul> <li><code>ByteBufferFileLoader</code><br> fetcher = <code>ByteBufferFetcher(file)</code><br> fetcher.dataClass = <code>ByteBuffer.class</code></li> <li><code>FileLoader</code><br> fetcher = <code>FileFetcher(model, fileOpener)</code><br> fetcher.dataClass = <code>InputStream.class</code></li> <li><code>FileLoader</code><br> fetcher = <code>FileFetcher(model, fileOpener)</code><br> fetcher.dataClass = <code>ParcelFileDescriptor.class</code></li> <li><code>UnitModelLoader</code><br> fetcher = <code>UnitFetcher&lt;&gt;(model)</code><br> fetcher.dataClass = <code>File.class</code></li> </ul> <p>çœ‹ä¸€ä¸‹<code>DecodeHelper.getLoadPath</code>æ–¹æ³•æ˜¯å¦‚ä½•åˆ¤æ–­è·¯å¾„çš„ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// DecodeHelper</span>
<span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=o>?</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>getLoadPath</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=k>return</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getLoadPath</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<span class=p>}</span>

<span class=c1>// Registry</span>
<span class=nd>@Nullable</span>
<span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>getLoadPath</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=c1>// å…ˆå–ç¼“å­˜</span>
 <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span>
     <span class=n>loadPathCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
 <span class=c1>// å¦‚æœå–åˆ°NO_PATHS_SIGNALè¿™æ¡LoadPathï¼Œé‚£ä¹ˆè¿”å›null</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>loadPathCache</span><span class=p>.</span><span class=na>isEmptyLoadPath</span><span class=p>(</span><span class=n>result</span><span class=p>))</span> <span class=p>{</span>
   <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
 <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
   <span class=c1>// å–åˆ°nullï¼Œè¯´æ˜è¿˜æ²¡æœ‰è·å–è¿‡</span>
   <span class=c1>// é‚£ä¹ˆå…ˆè·å–decodePathsï¼Œåœ¨åˆ›å»ºLoadPathå¯¹è±¡å¹¶å­˜å…¥ç¼“å­˜ä¸­</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>decodePaths</span> <span class=o>=</span>
       <span class=n>getDecodePaths</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
   <span class=c1>// It&#39;s possible there is no way to decode or transcode to the desired types from a given</span>
   <span class=c1>// data class.</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>decodePaths</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
     <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
     <span class=n>result</span> <span class=o>=</span>
         <span class=k>new</span> <span class=n>LoadPath</span><span class=o>&lt;&gt;</span><span class=p>(</span>
             <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>decodePaths</span><span class=p>,</span> <span class=n>throwableListPool</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=c1>// å­˜å…¥ç¼“å­˜</span>
   <span class=n>loadPathCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹å‡ºï¼Œ<code>getLoadPath</code>çš„å…³é”®å°±æ˜¯<code>getDecodePaths</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=nf>getDecodePaths</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>decodePaths</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
 <span class=c1>// 1</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;&gt;</span> <span class=n>registeredResourceClasses</span> <span class=o>=</span>
     <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>

 <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>registeredResourceClass</span> <span class=p>:</span> <span class=n>registeredResourceClasses</span><span class=p>)</span> <span class=p>{</span>
   <span class=c1>// 2</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>registeredTranscodeClasses</span> <span class=o>=</span>
       <span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>

   <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>registeredTranscodeClass</span> <span class=p>:</span> <span class=n>registeredTranscodeClasses</span><span class=p>)</span> <span class=p>{</span>
     <span class=c1>// 3</span>
     <span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;&gt;</span> <span class=n>decoders</span> <span class=o>=</span>
         <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getDecoders</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>registeredResourceClass</span><span class=p>);</span>
     <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcoder</span> <span class=o>=</span>
         <span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>registeredTranscodeClass</span><span class=p>);</span>
     <span class=c1>// 4</span>
     <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;</span><span class=p>)</span>
     <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span>
         <span class=k>new</span> <span class=n>DecodePath</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>registeredTranscodeClass</span><span class=p>,</span>
             <span class=n>decoders</span><span class=p>,</span> <span class=n>transcoder</span><span class=p>,</span> <span class=n>throwableListPool</span><span class=p>);</span>
     <span class=n>decodePaths</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>path</span><span class=p>);</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=k>return</span> <span class=n>decodePaths</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>é¦–å…ˆå°±æ˜¯<code>decoderRegistry.getResourceClasses(dataClass, resourceClass)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æˆ‘ä»¬ä¸Šé¢åˆ†æè¿‡ï¼Œä½œç”¨å°±æ˜¯æ ¹æ®ä¼ å…¥çš„dataClassä»¥åŠresourceClassåœ¨Registryä¸­æ‰¾æ˜ å°„å…³ç³»ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°å°±è¿”å›è¿™æ¡æ˜ å°„å…³ç³»çš„resourceClassï¼ˆè¯¥æ–¹æ³•ä¸­dataClassä¸ºä¼ å…¥çš„fetcher.dataClassï¼ŒresourceClasså€¼ä¸ºObject.classï¼‰ã€‚</p> <p>ç„¶åå¯¹äºæ¯ä¸ªè·å–åˆ°çš„registeredResourceClassï¼Œè°ƒç”¨<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¹‹å‰ä¹Ÿè§£æè¿‡ï¼Œå…¶ä½œç”¨æ˜¯æ ¹æ®resourceClasså’ŒtranscodeClassï¼Œä»è‡ªèº«æˆ–è€…æ³¨å†Œè¡¨çš„â€œmapâ€ä¸­æ‰¾å‡ºtranscodeClassï¼ˆå‚æ•°transcodeClassä¸º<code>Drawable.class</code>ï¼‰ã€‚</p> <p>æœ€åï¼Œå¯¹äºæ¯ä¸ªregisteredResourceClasså’ŒregisteredTranscodeClassï¼Œéƒ½ä¼šè·å–å…¶<code>ResourceDecoder</code>å’Œ<code>ResourceTranscoder</code>ï¼Œå¹¶å°†è¿™äº›å‚æ•°ç»„æˆä¸€ä¸ª<code>DecodePath</code>ä¿å­˜åˆ°listï¼Œæœ€åè¿”å›ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™äº›æ–¹æ³•çš„å®ç°ï¼Œæœ€ååœ¨ç»™å‡ºæ¯ä¸€æ­¥çš„æ“ä½œç»“æœã€‚</p> <p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹<code>decoderRegistry.getDecoders</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;&gt;</span> <span class=nf>getDecoders</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
 <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>bucket</span> <span class=p>:</span> <span class=n>bucketPriorityList</span><span class=p>)</span> <span class=p>{</span>
   <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>entries</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>continue</span><span class=p>;</span>
   <span class=p>}</span>
   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>))</span> <span class=p>{</span>
       <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>((</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>decoder</span><span class=p>);</span>
     <span class=p>}</span>
   <span class=p>}</span>
 <span class=p>}</span>
 <span class=c1>// TODO: cache result list.</span>

 <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>è¯¥æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œé‚£å°±æ˜¯éå†æ‰€æœ‰çš„bucketä¸­çš„æ‰€æœ‰entryï¼Œæ‰¾å‡ºæ‰€æœ‰èƒ½å¤„ç†dataClassã€resourceClassçš„entryï¼Œä¿å­˜å…¶decoderã€‚</p> <p>æœ€åçœ‹ä¸€ä¸‹<code>transcoderRegistry.get</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=nf>get</span><span class=p>(</span>
   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodedClass</span><span class=p>)</span> <span class=p>{</span>
 <span class=c1>// For example, there may be a transcoder that can convert a GifDrawable to a Drawable, which</span>
 <span class=c1>// will be caught above. However, if there is no registered transcoder, we can still just use</span>
 <span class=c1>// the UnitTranscoder to return the Drawable because the transcode class (Drawable) is</span>
 <span class=c1>// assignable from the resource class (GifDrawable).</span>
 <span class=k>if</span> <span class=p>(</span><span class=n>transcodedClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>))</span> <span class=p>{</span>
   <span class=k>return</span> <span class=p>(</span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>UnitTranscoder</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
 <span class=p>}</span>
 <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>transcoders</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodedClass</span><span class=p>))</span> <span class=p>{</span>
     <span class=k>return</span> <span class=p>(</span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>transcoder</span><span class=p>;</span>
   <span class=p>}</span>
 <span class=p>}</span>

 <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span>
     <span class=s>&quot;No transcoder registered to transcode from &quot;</span> <span class=o>+</span> <span class=n>resourceClass</span> <span class=o>+</span> <span class=s>&quot; to &quot;</span> <span class=o>+</span> <span class=n>transcodedClass</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¯¥æ–¹æ³•é€»è¾‘å’Œæˆ‘ä»¬ä¹‹å‰è°ˆåˆ°è¿‡çš„<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ç±»ä¼¼ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯å¯¹åº”çš„<code>transcoder</code>å¯¹è±¡ã€‚</p> <p>äº†è§£åˆ°ä¸Šé¢è¿™äº›æ–¹æ³•çš„ä½œç”¨åï¼Œæˆ‘ä»¬åˆ—å‡º<code>Registry.getDecodePaths</code>æ–¹æ³•æ‰§è¡Œçš„æ­¥éª¤ä»¥åŠç»“æœï¼ˆdataClassä¸ºä¸‹é¢çš„fetcher.dataClassï¼ŒresourceClassä¸ºObject.classï¼ŒtranscodeClassä¸ºDrawable.classï¼‰ï¼š</p> <ul> <li><code>ByteBufferFileLoader</code><br> fetcher = <code>ByteBufferFetcher(file)</code><br> fetcher.dataClass = <code>ByteBuffer.class</code><br> 1 registeredResourceClasses = <code>[GifDrawable.class, Bitmap.class, BitmapDrawable.class]</code><br> 2 registeredTranscodeClasses = <code>[[Drawable.class], [Drawable.class], [Drawable.class]]</code><br> 3 decoders = <code>[[ByteBufferGifDecoder], [ByteBufferBitmapDecoder], [BitmapDrawableDecoder]]</code><br> 4 transcoder = <code>[UnitTranscoder, BitmapDrawableTranscoder, UnitTranscoder]</code><br> 5 decodePaths = <code>[DecodePath(ByteBuffer.class, GifDrawable.class, Drawable.class, [ByteBufferGifDecoder], UnitTranscoder), DecodePath(ByteBuffer.class, Bitmap.class, Drawable.class, [ByteBufferBitmapDecoder], BitmapDrawableTranscoder), DecodePath(ByteBuffer.class, BitmapDrawable.class, Drawable.class, [BitmapDrawableDecoder], UnitTranscoder)]</code><br> 6 loadPath = <code>LoadPath(ByteBuffer.class, Object.class, Drawable.class, decodePaths)</code> </li> </ul> <p>åœ¨<code>ByteBufferFileLoader</code>ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°ä¸€ä¸ªä¸€æ¡å¯ä»¥åŠ è½½çš„è·¯å¾„ï¼Œé‚£ä¹ˆå°±è°ƒç”¨æ­¤<code>fetcher.loadData</code>æ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚åŒæ—¶ï¼Œè¯¥æ–¹æ³•<code>ResourceCacheGenerator.startNext</code>è¿”å›trueï¼Œè¿™å°±æ„å‘³ç€<code>DecodeJob</code>æ— éœ€åœ¨å°è¯•å¦å¤–çš„<code>DataFetcherGenerator</code>è¿›è¡ŒåŠ è½½ï¼Œæ•´ä¸ª<code>into</code>è¿‡ç¨‹å·²ç»å¤§è‡´å®Œæˆï¼Œå‰©ä¸‹çš„å°±æ˜¯ç­‰å¾…èµ„æºåŠ è½½å®Œæ¯•åè§¦å‘å›è°ƒå³å¯ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥ç€çœ‹çœ‹<code>loadData.fetcher.loadData(helper.getPriority(), this)</code>è¿™æ¡è¯­å¥å¹²äº†ä»€ä¹ˆï¼Œåœ¨ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ï¼Œè¿™é‡Œçš„fetcheræ˜¯<code>ByteBufferFetcher</code>å¯¹è±¡ï¼Œå…¶loadDataæ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
   <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>ByteBuffer</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
 <span class=n>ByteBuffer</span> <span class=n>result</span><span class=p>;</span>
 <span class=k>try</span> <span class=p>{</span>
   <span class=c1>// è¿™é‡Œçš„fileå°±æ˜¯ç¼“å­˜ä¸‹æ¥çš„source file</span>
   <span class=c1>// è·¯å¾„åœ¨demoä¸­ä¸º /data/data/yorek.demoandtest/cache/image_manager_disk_cache/65a6e0855da59221f073aba07dc6c69206834ef83f60c58062bee458fcac7dde.0</span>
   <span class=n>result</span> <span class=o>=</span> <span class=n>ByteBufferUtil</span><span class=p>.</span><span class=na>fromFile</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
 <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
     <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to obtain ByteBuffer for file&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
   <span class=p>}</span>
   <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
   <span class=k>return</span><span class=p>;</span>
 <span class=p>}</span>

 <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p><code>ByteBufferUtil.fromFile</code>ä½¿ç”¨äº†<code>RandomAccessFile</code>å’Œ<code>FileChannel</code>è¿›è¡Œæ–‡ä»¶æ“ä½œã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œè°ƒç”¨<code>callback.onLoadFailed(e)</code>é€šçŸ¥<code>ResourceCacheGenerator</code>ç±»ï¼Œè¯¥ç±»ä¼šå°†æ“ä½œè½¬å‘ç»™<code>DecodeJob</code>ï¼›<code>callback.onDataReady</code>æ“ä½œç±»ä¼¼ã€‚è¿™æ ·ç¨‹åºå°±å›åˆ°äº†<code>DecodeJob</code>å›è°ƒæ–¹æ³•ä¸­äº†ã€‚</p> <p>æˆ‘ä»¬æš‚æ—¶ä¸ç»§ç»­åˆ†æ<code>DecodeJob</code>çš„å›è°ƒæ–¹æ³•ï¼Œå› ä¸ºåœ¨æœ¬èŠ‚ä¸­ç¼“å­˜æ–‡ä»¶æœ¬æ¥æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥ä¼šäº¤ç»™ä¸‹ä¸€ä¸ª<code>DataFetcherGenerator</code>è¿›è¡Œå°è¯•å¤„ç†ï¼Œæ‰€ä»¥åé¢è‚¯å®šä¹Ÿä¼šé‡åˆ°<code>DecodeJob</code>çš„å›è°ƒæ–¹æ³•ã€‚ </p> <h3 id=37-datacachegenerator>3.7 DataCacheGenerator<a class=headerlink href=#37-datacachegenerator title="Permanent link">&para;</a></h3> <p>ç”±äº<code>Glide-with-load-into</code>ä¸‰æ­¥æ²¡æœ‰åœ¨<code>ResourceCacheGenerator</code>ä¸­è¢«fetchï¼Œæ‰€ä»¥å›åˆ°<code>DecodeJob.runGenerators</code>æ–¹æ³•ä¸­ï¼Œç»§ç»­æ‰§è¡Œwhileå¾ªç¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=p>()</span> <span class=p>{</span>
  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span> <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>reschedule</span><span class=p>();</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
  <span class=k>if</span> <span class=p>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>notifyFailed</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
  <span class=c1>// onDataFetcherReady.</span>
<span class=p>}</span>
</code></pre></div> <p>ç”±äº<code>diskCacheStrategy</code>é»˜è®¤ä¸º<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œå…¶<code>decodeCachedData()</code>è¿”å›trueï¼Œæ‰€ä»¥<code>getNextStage(stage)</code>æ˜¯<code>Stage.DATA_CACHE</code>ã€‚å› æ­¤<code>getNextGenerator()</code>æ–¹æ³•è¿”å›äº†<code>DataCacheGenerator(decodeHelper, this)</code>ã€‚ç„¶ååœ¨whileå¾ªç¯ä¸­ä¼šæ‰§è¡Œå…¶<code>startNext()</code>æ–¹æ³•ã€‚</p> <div class="admonition success"> <p class=admonition-title>Success</p> <p>æœ‰äº†åœ¨<code>ResourceCacheGenerator</code>ä¸­ç¼“å­˜å¥½çš„å¤§é‡å˜é‡ï¼Œ<code>DataCacheGenerator</code>å’Œ<code>SourceGenerator</code>ä»£ç å°±éå¸¸ç®€å•äº†ã€‚</p> </div> <p><code>ResourceCacheGenerator</code>åœ¨æ„é€ çš„æ—¶å€™å°±å°†<code>helper.getCacheKeys()</code>ä¿å­˜äº†èµ·æ¥ï¼Œæˆ‘ä»¬å‰é¢åœ¨è°ˆ<code>ResourceCacheGenerator</code>çš„æ—¶å€™æåˆ°è¿‡ï¼Œ<code>helper.getCacheKeys()</code>é‡‡å–äº†é˜²æ­¢é‡å¤åŠ è½½çš„ç­–ç•¥ã€‚</p> <p>æ„é€ å™¨ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>cacheKeys</span><span class=p>;</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span> <span class=n>helper</span><span class=p>;</span>
<span class=kd>private</span> <span class=kd>final</span> <span class=n>FetcherReadyCallback</span> <span class=n>cb</span><span class=p>;</span>

<span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span> <span class=n>helper</span><span class=p>,</span> <span class=n>FetcherReadyCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getCacheKeys</span><span class=p>(),</span> <span class=n>helper</span><span class=p>,</span> <span class=n>cb</span><span class=p>);</span>
<span class=p>}</span>

<span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>cacheKeys</span><span class=p>,</span> <span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span> <span class=n>helper</span><span class=p>,</span> <span class=n>FetcherReadyCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>cacheKeys</span> <span class=o>=</span> <span class=n>cacheKeys</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>helper</span> <span class=o>=</span> <span class=n>helper</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ç„¶åçœ‹ä¸€ä¸‹å®ƒçš„<code>startNext()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å’Œ<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œç”±äºè·å–çš„æ˜¯åŸå§‹çš„æºæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œçš„keyçš„ç»„æˆéå¸¸ç®€å•ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>while</span> <span class=p>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>cacheKeys</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>cacheKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
    <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times</span>
    <span class=c1>// and the actions it performs are much more expensive than a single allocation.</span>
    <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;</span><span class=p>)</span>
    <span class=n>Key</span> <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>sourceId</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
    <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>originalKey</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=p>;</span>
      <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
      <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
    <span class=n>loadData</span> <span class=o>=</span>
        <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
            <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span> <span class=p>{</span>
      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
      <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>modelLoaderIndex</span> <span class=o>&lt;</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p>ç”±äºæˆ‘ä»¬ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œæœ¬åœ°ç¼“å­˜æ–‡ä»¶è‚¯å®šæ˜¯æ²¡æœ‰çš„ã€‚æˆ‘ä»¬æ¥ç€çœ‹æœ€åä¸€ä¸ª<code>SourceGenerator</code>ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è·å–æ•°æ®çš„ã€‚</p> <h3 id=38-sourcegenerator>3.8 SourceGenerator<a class=headerlink href=#38-sourcegenerator title="Permanent link">&para;</a></h3> <p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œå¦‚æœGlideåœ¨åŠ è½½æ—¶æŒ‡å®šäº†<code>.onlyRetrieveFromCache(true)</code>ï¼Œé‚£ä¹ˆåœ¨<code>DecodeJob.getNextStage(Stage)</code>æ–¹æ³•ä¸­å°±ä¼šè·³è¿‡<code>Stage.SOURCE</code>ç›´æ¥åˆ°è¾¾<code>Stage.FINISHED</code>ã€‚<br> ä¸”å½“ä¸º<code>Stage.SOURCE</code>æ—¶ï¼Œ<code>DecodeJob.runGenerators()</code>æ–¹æ³•ä¼šè°ƒç”¨<code>reschedule()</code>æ–¹æ³•ï¼Œè¿™å°†ä¼šå¯¼è‡´<code>DecodeJob</code>é‡æ–°è¢«æäº¤åˆ°<code>sourceExecutor</code>è¿™ä¸ªçº¿ç¨‹æ± ä¸­ï¼ŒåŒæ—¶runReasonè¢«èµ‹å€¼ä¸º<code>RunReason.SWITCH_TO_SOURCE_SERVICE</code>ã€‚è¯¥çº¿ç¨‹æ± é»˜è®¤å®ç°ä¸º<code>GlideExecutor.newSourceExecutor()</code>:</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MAXIMUM_AUTOMATIC_THREAD_COUNT</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>DEFAULT_SOURCE_EXECUTOR_NAME</span> <span class=o>=</span> <span class=s>&quot;source&quot;</span><span class=p>;</span>

<span class=kd>public</span> <span class=kd>static</span> <span class=n>GlideExecutor</span> <span class=nf>newSourceExecutor</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>newSourceExecutor</span><span class=p>(</span>
      <span class=n>calculateBestThreadCount</span><span class=p>(),</span>
      <span class=n>DEFAULT_SOURCE_EXECUTOR_NAME</span><span class=p>,</span>
      <span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>calculateBestThreadCount</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>bestThreadCount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>bestThreadCount</span> <span class=o>=</span>
        <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>MAXIMUM_AUTOMATIC_THREAD_COUNT</span><span class=p>,</span> <span class=n>RuntimeCompat</span><span class=p>.</span><span class=na>availableProcessors</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>bestThreadCount</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ç”±äº<code>DecodeJob</code>å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œé‚£ä¹ˆç›´æ¥çœ‹<code>run()</code>æ–¹æ³•é‡Œé¢çš„çœŸæ­£å®ç°<code>runWrapped()</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runWrapped</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>runReason</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=k>case</span> <span class=n>SWITCH_TO_SOURCE_SERVICE</span><span class=p>:</span>
      <span class=n>runGenerators</span><span class=p>();</span>
      <span class=k>break</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œè¿˜æ˜¯æ‰§è¡Œäº†<code>runGenerators()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œåœ¨è¿™é‡Œä¼šæ‰§è¡Œ<code>SourceGenerator.startNext()</code>æ–¹æ³•ã€‚ </p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>int</span> <span class=n>loadDataListIndex</span><span class=p>;</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
  <span class=c1>// é¦–æ¬¡è¿è¡ŒdataToCacheä¸ºnull</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=c1>// é¦–æ¬¡è¿è¡ŒsourceCacheGeneratorä¸ºnull</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>

  <span class=c1>// å‡†å¤‡åŠ è½½æ•°æ®</span>
  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=c1>// è¿™é‡Œç›´æ¥è°ƒç”¨äº†DecodeHelper.getLoadData()æ–¹æ³•</span>
  <span class=c1>// è¯¥æ–¹æ³•åœ¨å‰é¢åœ¨ResourceCacheGeneratorä¸­è¢«è°ƒç”¨è¿‡ï¼Œä¸”è¢«ç¼“å­˜äº†ä¸‹æ¥</span>
  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>loadData</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getLoadData</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>loadDataListIndex</span><span class=o>++</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span>
        <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>().</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>())</span>
        <span class=o>||</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>())))</span> <span class=p>{</span>
      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
      <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>loadDataListIndex</span> <span class=o>&lt;</span> <span class=n>helper</span><span class=p>.</span><span class=na>getLoadData</span><span class=p>().</span><span class=na>size</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p><code>helper.getLoadData()</code>çš„å€¼åœ¨<code>ResourceCacheGenerator</code>ä¸­å°±å·²ç»è¢«è·å–å¹¶ç¼“å­˜ä¸‹æ¥äº†ï¼Œè¿™æ˜¯ä¸€ä¸ª<code>MultiModelLoader</code>å¯¹è±¡ç”Ÿæˆçš„<code>LoadData</code>å¯¹è±¡ï¼Œ<code>LoadData</code>å¯¹è±¡é‡Œé¢æœ‰ä¸¤ä¸ªfetcherã€‚è¯¦è§<a href=/android/3rd-library/glide2/#361-helpergetcachekeys>ç¬¬3.6.1èŠ‚çš„æœ«å°¾éƒ¨åˆ†</a></p> <p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šéå†LoadData listï¼Œæ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„LoadDataï¼Œç„¶åè°ƒç”¨<code>loadData.fetcher.loadData</code>åŠ è½½æ•°æ®ã€‚<br> åœ¨loadDataä¸ä¸ºç©ºçš„å‰æä¸‹ï¼Œä¼šåˆ¤æ–­Glideçš„ç¼“å­˜ç­–ç•¥æ˜¯å¦å¯ä»¥ç¼“å­˜æ­¤æ•°æ®æºï¼Œæˆ–è€…æ˜¯å¦æœ‰åŠ è½½è·¯å¾„ã€‚ </p> <p>æˆ‘ä»¬çŸ¥é“ï¼Œé»˜è®¤æƒ…å†µä¸‹Glideçš„ç¼“å­˜ç­–ç•¥æ˜¯<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œå…¶<code>isDataCacheable</code>å®ç°å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDataCacheable</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>loadData.fetcher.getDataSource()</code>è¿”å›äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=nd>@NonNull</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>fetchers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getDataSource</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// MultiFetcherä¸­fetchersæ•°ç»„ä¿å­˜çš„ä¸¤ä¸ªDataFetcheréƒ½æ˜¯HttpUrlFetcher</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>HttpUrlFetcher</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=nd>@NonNull</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æ˜¾ç„¶ï¼ŒGlideçš„ç¼“å­˜ç­–ç•¥æ˜¯å¯ä»¥ç¼“å­˜æ­¤æ•°æ®æºçš„ã€‚æ‰€ä»¥ä¼šè¿›è¡Œæ•°æ®çš„åŠ è½½ã€‚æ¥ç€çœ‹çœ‹<code>MultiFetcher.loadData</code>æ–¹æ³•ã€‚<br> è¿™é‡Œé¦–å…ˆä¼šè°ƒç”¨å†…éƒ¨çš„ç¬¬0ä¸ªDataFetcherè¿›è¡ŒåŠ è½½ï¼ŒåŒæ—¶è®¾ç½®å›è°ƒä¸ºè‡ªå·±ã€‚å½“è¿™ä¸€ä¸ªDataFetcheråŠ è½½å¤±è´¥æ—¶ï¼Œä¼šå°è¯•è°ƒç”¨ä¸‹ä¸€ä¸ªDataFetcherè¿›è¡ŒåŠ è½½ï¼Œå¦‚æœæ²¡æœ‰æ‰€æœ‰çš„DataFetcheréƒ½åŠ è½½å¤±è´¥äº†ï¼Œå°±æŠŠé”™è¯¯æŠ›ç»™ä¸Šä¸€å±‚ï¼›å½“æœ‰DataFetcheråŠ è½½æˆåŠŸæ—¶ï¼Œä¹Ÿä¼šæŠŠè·å–åˆ°çš„æ•°æ®è½¬äº¤ç»™ä¸Šä¸€å±‚ã€‚</p> <div class=highlight><pre><span></span><code><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>fetchers</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kt>int</span> <span class=n>currentIndex</span><span class=p>;</span>
  <span class=kd>private</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>;</span>
  <span class=kd>private</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>;</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span>
      <span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=p>;</span>
    <span class=n>exceptions</span> <span class=o>=</span> <span class=n>throwableListPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
    <span class=n>fetchers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>currentIndex</span><span class=p>).</span><span class=na>loadData</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>

    <span class=c1>// If a race occurred where we cancelled the fetcher in cancel() and then called loadData here</span>
    <span class=c1>// immediately after, make sure that we cancel the newly started fetcher. We don&#39;t bother</span>
    <span class=c1>// checking cancelled before loadData because it&#39;s not required for correctness and would</span>
    <span class=c1>// require an unlikely race to be useful.</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>cancel</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Data</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>startNextOrFail</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>exceptions</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=n>startNextOrFail</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>startNextOrFail</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>currentIndex</span> <span class=o>&lt;</span> <span class=n>fetchers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>currentIndex</span><span class=o>++</span><span class=p>;</span>
      <span class=n>loadData</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span> <span class=n>callback</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>exceptions</span><span class=p>);</span>
      <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Fetch failed&quot;</span><span class=p>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>)));</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œé¢ä¸¤ä¸ªDataFetcheréƒ½æ˜¯å‚æ•°ç›¸åŒçš„<code>HttpUrlFetcher</code>å®ä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹é‡Œé¢å¦‚ä½•ä»ç½‘ç»œåŠ è½½å›¾ç‰‡çš„ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>InputStream</span> <span class=n>result</span> <span class=o>=</span> <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>glideUrl</span><span class=p>.</span><span class=na>toURL</span><span class=p>(),</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>glideUrl</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>());</span>
    <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to load data for url&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Finished http url fetcher fetch in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å¾ˆæ˜¾ç„¶ï¼Œè¿™é‡Œå°†è¯·æ±‚æ“ä½œæ”¾åˆ°äº†<code>loadDataWithRedirects</code>æ–¹æ³•ä¸­ï¼Œç„¶åå°†è¯·æ±‚ç»“æœé€šè¿‡å›è°ƒè¿”å›ä¸Šä¸€å±‚ä¹Ÿå°±æ˜¯<code>MultiFetcher</code>ä¸­ã€‚ </p> <p><code>loadDataWithRedirects</code>ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºé‡å®šå‘çš„æ¬¡æ•°ï¼Œåœ¨æ–¹æ³•å†…éƒ¨é™åˆ¶äº†é‡å®šå‘å‘ç”Ÿçš„æ¬¡æ•°ä¸èƒ½è¶…è¿‡<code>MAXIMUM_REDIRECTS=5</code>æ¬¡ã€‚<br> ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‘ç”Ÿé‡å®šå‘å‰çš„åŸå§‹urlï¼Œç”¨æ¥ä¸å½“å‰urlåˆ¤æ–­ï¼Œæ˜¯ä¸æ˜¯é‡å®šå‘åˆ°è‡ªèº«äº†ã€‚è€Œä¸”å¯ä»¥çœ‹å‡ºï¼ŒGlideåŠ è½½ç½‘ç»œå›¾ç‰‡ä½¿ç”¨çš„æ˜¯<code>HttpUrlConnection</code>ã€‚<br> ç¬¬å››ä¸ªå‚æ•°headersé»˜è®¤ä¸º<code>Headers.DEFAULT</code>ï¼Œå°±æ˜¯ä¸€ä¸ªUser-Agentçš„key-valueå¯¹ã€‚</p> <p>ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>InputStream</span> <span class=nf>loadDataWithRedirects</span><span class=p>(</span><span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=kt>int</span> <span class=n>redirects</span><span class=p>,</span> <span class=n>URL</span> <span class=n>lastUrl</span><span class=p>,</span>
    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headers</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=c1>// æ£€æŸ¥é‡å®šå‘æ¬¡æ•°</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>redirects</span> <span class=o>&gt;=</span> <span class=n>MAXIMUM_REDIRECTS</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;Too many (&gt; &quot;</span> <span class=o>+</span> <span class=n>MAXIMUM_REDIRECTS</span> <span class=o>+</span> <span class=s>&quot;) redirects!&quot;</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// Comparing the URLs using .equals performs additional network I/O and is generally broken.</span>
    <span class=c1>// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=c1>// æ£€æŸ¥æ˜¯ä¸æ˜¯é‡å®šå‘åˆ°è‡ªèº«äº†</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>lastUrl</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>url</span><span class=p>.</span><span class=na>toURI</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>lastUrl</span><span class=p>.</span><span class=na>toURI</span><span class=p>()))</span> <span class=p>{</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;In re-direct loop&quot;</span><span class=p>);</span>

      <span class=p>}</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>URISyntaxException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Do nothing, this is best effort.</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=c1>// connectionFactoryé»˜è®¤æ˜¯DefaultHttpUrlConnectionFactory</span>
  <span class=c1>// å…¶buildæ–¹æ³•å°±æ˜¯è°ƒç”¨äº†url.openConnection()</span>
  <span class=n>urlConnection</span> <span class=o>=</span> <span class=n>connectionFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
  <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=p>:</span> <span class=n>headers</span><span class=p>.</span><span class=na>entrySet</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>urlConnection</span><span class=p>.</span><span class=na>addRequestProperty</span><span class=p>(</span><span class=n>headerEntry</span><span class=p>.</span><span class=na>getKey</span><span class=p>(),</span> <span class=n>headerEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>());</span>
  <span class=p>}</span>
  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setConnectTimeout</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setReadTimeout</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setUseCaches</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setDoInput</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>

  <span class=c1>// Stop the urlConnection instance of HttpUrlConnection from following redirects so that</span>
  <span class=c1>// redirects will be handled by recursive calls to this method, loadDataWithRedirects.</span>
  <span class=c1>// ç¦æ­¢HttpUrlConnectionè‡ªåŠ¨é‡å®šå‘ï¼Œé‡å®šå‘åŠŸèƒ½ç”±æœ¬æ–¹æ³•è‡ªå·±å®ç°</span>
  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setInstanceFollowRedirects</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>

  <span class=c1>// Connect explicitly to avoid errors in decoders if connection fails.</span>
  <span class=n>urlConnection</span><span class=p>.</span><span class=na>connect</span><span class=p>();</span>
  <span class=c1>// Set the stream so that it&#39;s closed in cleanup to avoid resource leaks. See #2352.</span>
  <span class=n>stream</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=kd>final</span> <span class=kt>int</span> <span class=n>statusCode</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=p>.</span><span class=na>getResponseCode</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>isHttpOk</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// statusCode=2xxï¼Œè¯·æ±‚æˆåŠŸ</span>
    <span class=k>return</span> <span class=n>getStreamForSuccessfulRequest</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isHttpRedirect</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// statusCode=3xxï¼Œéœ€è¦é‡å®šå‘</span>
    <span class=n>String</span> <span class=n>redirectUrlString</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=p>.</span><span class=na>getHeaderField</span><span class=p>(</span><span class=s>&quot;Location&quot;</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>redirectUrlString</span><span class=p>))</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;Received empty or null redirect url&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>URL</span> <span class=n>redirectUrl</span> <span class=o>=</span> <span class=k>new</span> <span class=n>URL</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>redirectUrlString</span><span class=p>);</span>
    <span class=c1>// Closing the stream specifically is required to avoid leaking ResponseBodys in addition</span>
    <span class=c1>// to disconnecting the url connection below. See #2352.</span>
    <span class=n>cleanup</span><span class=p>();</span>
    <span class=k>return</span> <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>redirectUrl</span><span class=p>,</span> <span class=n>redirects</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>statusCode</span> <span class=o>==</span> <span class=n>INVALID_STATUS_CODE</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// -1 è¡¨ç¤ºä¸æ˜¯HTTPå“åº”</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>statusCode</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=c1>// å…¶ä»–HTTPé”™è¯¯</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>.</span><span class=na>getResponseMessage</span><span class=p>(),</span> <span class=n>statusCode</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// Referencing constants is less clear than a simple static method.</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isHttpOk</span><span class=p>(</span><span class=kt>int</span> <span class=n>statusCode</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>statusCode</span> <span class=o>/</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>2</span><span class=p>;</span>
<span class=p>}</span>

<span class=c1>// Referencing constants is less clear than a simple static method.</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isHttpRedirect</span><span class=p>(</span><span class=kt>int</span> <span class=n>statusCode</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>statusCode</span> <span class=o>/</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>3</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ç°åœ¨æˆ‘ä»¬å·²ç»è·å¾—ç½‘ç»œå›¾ç‰‡çš„InputStreamäº†ï¼Œè¯¥èµ„æºä¼šé€šè¿‡å›è°ƒç»è¿‡<code>MultiFetcher</code>åˆ°è¾¾<code>SourceGenerator</code>ä¸­ã€‚ </p> <p>ä¸‹é¢æ˜¯<code>DataCallback</code>å›è°ƒåœ¨<code>SourceGenerator</code>ä¸­çš„å®ç°ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
    <span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
        <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>originalKey</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherFailed</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>());</span>
<span class=p>}</span>
</code></pre></div> <p><code>onLoadFailed</code>å¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨<code>DecodeJob.onDataFetcherFailed</code>æ–¹æ³•ã€‚<code>onDataReady</code>æ–¹æ³•ä¼šé¦–å…ˆåˆ¤dataèƒ½ä¸èƒ½ç¼“å­˜ï¼Œè‹¥èƒ½ç¼“å­˜åˆ™ç¼“å­˜èµ·æ¥ï¼Œç„¶åè°ƒç”¨<code>DataCacheGenerator</code>è¿›è¡ŒåŠ è½½ç¼“å­˜ï¼›è‹¥ä¸èƒ½ç¼“å­˜ï¼Œåˆ™ç›´æ¥è°ƒç”¨<code>DecodeJob.onDataFetcherReady</code>æ–¹æ³•é€šçŸ¥å¤–ç•Œdataå·²ç»å‡†å¤‡å¥½äº†ã€‚</p> <p>æˆ‘ä»¬è§£è¯»ä¸€ä¸‹<code>onDataReady</code>é‡Œé¢çš„ä»£ç ã€‚é¦–å…ˆï¼Œè·å–<code>DiskCacheStrategy</code>åˆ¤æ–­èƒ½ä¸èƒ½è¢«ç¼“å­˜ï¼Œè¿™é‡Œçš„åˆ¤æ–­ä»£ç åœ¨<code>SourceGenerator.startNext()</code>ä¸­å‡ºç°è¿‡ï¼Œæ˜¾ç„¶æ˜¯å¯ä»¥çš„ã€‚ç„¶åå°†dataä¿å­˜åˆ°<code>dataToCache</code>ï¼Œå¹¶è°ƒç”¨<code>cb.reschedule()</code>ã€‚<br> <code>cb.reschedule()</code>æˆ‘ä»¬åœ¨å‰é¢åˆ†æè¿‡ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†<code>DecodeJob</code>æäº¤åˆ°Glideçš„sourceçº¿ç¨‹æ± ä¸­ã€‚ç„¶åæ‰§è¡Œ<code>DecodeJob.run()</code>æ–¹æ³•ï¼Œç»è¿‡<code>runWrapped()</code>ã€ <code>runGenerators()</code>æ–¹æ³•åï¼Œåˆå›åˆ°äº†<code>SourceGenerator.startNext()</code>æ–¹æ³•ã€‚</p> <p>åœ¨æ–¹æ³•çš„å¼€å¤´ï¼Œä¼šåˆ¤æ–­<code>dataToCache</code>æ˜¯å¦ä¸ºç©ºï¼Œæ­¤æ—¶æ˜¾ç„¶ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>cacheData(Object)</code>æ–¹æ³•è¿›è¡Œdataçš„ç¼“å­˜å¤„ç†ã€‚ç¼“å­˜å®Œæ¯•åï¼Œä¼šä¸ºè¯¥ç¼“å­˜æ–‡ä»¶ç”Ÿæˆä¸€ä¸ª<code>SourceCacheGenerator</code>ã€‚ç„¶ååœ¨<code>startNext()</code>æ–¹æ³•ä¸­ä¼šç›´æ¥è°ƒç”¨è¯¥å˜é‡è¿›è¡ŒåŠ è½½ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>cacheData</span><span class=p>(</span><span class=n>Object</span> <span class=n>dataToCache</span><span class=p>)</span> <span class=p>{</span>
  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>encoder</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSourceEncoder</span><span class=p>(</span><span class=n>dataToCache</span><span class=p>);</span>
    <span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>writer</span> <span class=o>=</span>
        <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span> <span class=n>dataToCache</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
    <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
    <span class=c1>// ç¼“å­˜data</span>
    <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span> <span class=n>writer</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Finished encoding source to cache&quot;</span>
          <span class=o>+</span> <span class=s>&quot;, key: &quot;</span> <span class=o>+</span> <span class=n>originalKey</span>
          <span class=o>+</span> <span class=s>&quot;, data: &quot;</span> <span class=o>+</span> <span class=n>dataToCache</span>
          <span class=o>+</span> <span class=s>&quot;, encoder: &quot;</span> <span class=o>+</span> <span class=n>encoder</span>
          <span class=o>+</span> <span class=s>&quot;, duration: &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=n>sourceCacheGenerator</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>),</span> <span class=n>helper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>ç”±äºåœ¨æ„é€ <code>DataCacheGenerator</code>æ—¶ï¼ŒæŒ‡å®šäº†<code>FetcherReadyCallback</code>ä¸ºè‡ªå·±ï¼Œæ‰€ä»¥<code>DataCacheGenerator</code>åŠ è½½ç»“æœä¼šç”±<code>SourceGenerator</code>è½¬å‘ç»™<code>DecodeJob</code>ã€‚<br> ç”±äºèµ„æºä¼šç”±<code>DataCacheGenerator</code>è§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­çœ‹åˆ°ï¼Œè¿”å›çš„data sourceæ˜¯<code>DataSource.DATA_DISK_CACHE</code>ã€‚</p> <h3 id=39-decodejobfetcherreadycallback>3.9 DecodeJob.FetcherReadyCallback<a class=headerlink href=#39-decodejobfetcherreadycallback title="Permanent link">&para;</a></h3> <p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹fetchå¤±è´¥æ—¶å¹²äº†ä»€ä¹ˆï¼Œç„¶ååœ¨çœ‹æˆåŠŸçš„æ—¶å€™ã€‚å› ä¸ºå¤±è´¥çš„ä»£ç æ¯”è¾ƒç®€å•ã€‚</p> <p><code>onDataFetcherFailed</code>ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherFailed</span><span class=p>(</span><span class=n>Key</span> <span class=n>attemptedKey</span><span class=p>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span>
    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
  <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Fetching data failed&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
  <span class=n>exception</span><span class=p>.</span><span class=na>setLoggingDetails</span><span class=p>(</span><span class=n>attemptedKey</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>());</span>
  <span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=p>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=p>;</span>
    <span class=n>callback</span><span class=p>.</span><span class=na>reschedule</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>runGenerators</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æ˜¾ç„¶ï¼Œå¦‚æœfetchå¤±è´¥äº†ï¼Œå¦‚æœä¸åœ¨sourceçº¿ç¨‹æ± ä¸­å°±ä¼šåˆ‡æ¢åˆ°sourceçº¿ç¨‹ï¼Œç„¶åé‡æ–°è°ƒç”¨<code>runGenerators()</code>æ–¹æ³•å°è¯•ä½¿ç”¨ä¸‹ä¸€ä¸ª<code>DataFetcherGenerator</code>è¿›è¡ŒåŠ è½½ï¼Œä¸€ç›´åˆ°æ²¡æœ‰ä¸€ä¸ªå¯ä»¥åŠ è½½ï¼Œè¿™æ—¶ä¼šè°ƒç”¨<code>notifyFailed()</code>æ–¹æ³•ï¼Œæ­£å¼å®£å‘ŠåŠ è½½å¤±è´¥ã€‚</p> <p>ç„¶ååœ¨çœ‹æˆåŠŸçš„æ—¶å€™ï¼š<code>onDataFetcherReady</code>æ–¹æ³•ä¼šä¿å­˜ä¼ å…¥çš„å‚æ•°ï¼Œç„¶åç¡®è®¤æ‰§è¡Œçº¿ç¨‹åè°ƒç”¨<code>decodeFromRetrievedData()</code>æ–¹æ³•è¿›è¡Œè§£ç ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherReady</span><span class=p>(</span><span class=n>Key</span> <span class=n>sourceKey</span><span class=p>,</span> <span class=n>Object</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span>
    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>Key</span> <span class=n>attemptedKey</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>this</span><span class=p>.</span><span class=na>currentSourceKey</span> <span class=o>=</span> <span class=n>sourceKey</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>currentData</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>currentFetcher</span> <span class=o>=</span> <span class=n>fetcher</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>currentDataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>currentAttemptingKey</span> <span class=o>=</span> <span class=n>attemptedKey</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=p>.</span><span class=na>DECODE_DATA</span><span class=p>;</span>
    <span class=n>callback</span><span class=p>.</span><span class=na>reschedule</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=s>&quot;DecodeJob.decodeFromRetrievedData&quot;</span><span class=p>);</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>decodeFromRetrievedData</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>decodeFromRetrievedData()</code>æ–¹æ³•ä¼šå…ˆè°ƒç”¨<code>decodeFromData</code>æ–¹æ³•è¿›è¡Œè§£ç ï¼Œç„¶åè°ƒç”¨<code>notifyEncodeAndRelease</code>æ–¹æ³•è¿›è¡Œç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿä¼šé€šçŸ¥<code>EngineJob</code>èµ„æºå·²ç»å‡†å¤‡å¥½äº†ã€‚</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>decodeFromRetrievedData</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Retrieved data&quot;</span><span class=p>,</span> <span class=n>startFetchTime</span><span class=p>,</span>
        <span class=s>&quot;data: &quot;</span> <span class=o>+</span> <span class=n>currentData</span>
            <span class=o>+</span> <span class=s>&quot;, cache key: &quot;</span> <span class=o>+</span> <span class=n>currentSourceKey</span>
            <span class=o>+</span> <span class=s>&quot;, fetcher: &quot;</span> <span class=o>+</span> <span class=n>currentFetcher</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>resource</span> <span class=o>=</span> <span class=n>decodeFromData</span><span class=p>(</span><span class=n>currentFetcher</span><span class=p>,</span> <span class=n>currentData</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>e</span><span class=p>.</span><span class=na>setLoggingDetails</span><span class=p>(</span><span class=n>currentAttemptingKey</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
    <span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>runGenerators</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å…ˆçœ‹çœ‹decodeç›¸å…³çš„ä»£ç ï¼Œ<code>decodeFromData</code>ç›¸å…³çš„ä»£ç æœ‰ä¸€äº›ï¼Œæˆ‘ä»¬ç›´æ¥åˆ—å‡ºè¿™äº›ä»£ç ã€‚<code>decodeFromData</code>æ–¹æ³•å†…éƒ¨åˆä¼šè°ƒç”¨<code>decodeFromFetcher</code>æ–¹æ³•å¹²æ´»ã€‚åœ¨<code>decodeFromFetcher</code>æ–¹æ³•ä¸­é¦–å…ˆä¼šè·å–LoadPathã€‚ç„¶åè°ƒç”¨<code>runLoadPath</code>æ–¹æ³•è§£ææˆèµ„æºã€‚ </p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromData</span><span class=p>(</span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span> <span class=n>Data</span> <span class=n>data</span><span class=p>,</span>
    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
    <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>decodeFromFetcher</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Decoded result &quot;</span> <span class=o>+</span> <span class=n>result</span><span class=p>,</span> <span class=n>startTime</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromFetcher</span><span class=p>(</span><span class=n>Data</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span>
    <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=o>?</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getLoadPath</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>data</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
  <span class=k>return</span> <span class=n>runLoadPath</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>runLoadPath</span><span class=p>(</span><span class=n>Data</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
    <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=n>getOptionsWithHardwareConfig</span><span class=p>(</span><span class=n>dataSource</span><span class=p>);</span>
  <span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span> <span class=o>=</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getRewinder</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=c1>// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
    <span class=k>return</span> <span class=n>path</span><span class=p>.</span><span class=na>load</span><span class=p>(</span>
        <span class=n>rewinder</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=k>new</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>dataSource</span><span class=p>));</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>rewinder</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æ³¨æ„<code>runLoadPath</code>æ–¹æ³•ä½¿ç”¨åˆ°äº†<code>DataRewinder</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå°†æ•°æ®æµé‡Œé¢çš„æŒ‡é’ˆé‡æ–°æŒ‡å‘å¼€å¤´çš„ç±»ï¼Œåœ¨è°ƒç”¨<code>ResourceDecoder</code>å¯¹dataè¿›è¡Œç¼–ç æ—¶ä¼šå°è¯•å¾ˆå¤šä¸ªç¼–ç å™¨ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡å°è¯•åéƒ½éœ€è¦é‡ç½®ç´¢å¼•ã€‚<br> åœ¨Glideåˆå§‹åŒ–çš„æ—¶å€™é»˜è®¤æ³¨å…¥äº†<code>ByteBufferRewinder</code>å’Œ<code>InputStreamRewinder</code>è¿™ä¸¤ä¸ªç±»çš„å·¥å‚ã€‚è¿™æ ·å°±ä¸º<code>ByteBuffer</code>å’Œ<code>InputStream</code>çš„é‡å®šå‘æä¾›äº†å®ç°ã€‚ </p> <p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>path.load(rewinder, options, width, height, new DecodeCallback&lt;ResourceType&gt;(dataSource))</code>è¿™è¡Œä»£ç ä¸­ï¼Œæœ€åä¼ å…¥äº†ä¸€ä¸ª<code>DecodeCallback</code>å›è°ƒï¼Œè¯¥ç±»çš„å›è°ƒæ–¹æ³•ä¼šå›è°ƒç»™<code>DecodeJob</code>å¯¹åº”çš„æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=p>{</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>;</span>

  <span class=nd>@Synthetic</span>
  <span class=n>DecodeCallback</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@NonNull</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>DecodeJob</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>dataSource</span><span class=p>,</span> <span class=n>decoded</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>LoadPath.load</code>æ–¹æ³•çš„å®ç°ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>throwables</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>loadWithExceptionList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>decodeCallback</span><span class=p>,</span> <span class=n>throwables</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>listPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>throwables</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>ummmmï¼Œè¿™é‡Œè°ƒç”¨äº†<code>loadWithExceptionList</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>loadWithExceptionList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=p>,</span>
    <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>result</span> <span class=o>=</span> <span class=n>path</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>decodeCallback</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>exceptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>å¯¹äºæ¯æ¡DecodePathï¼Œéƒ½è°ƒç”¨å…¶<code>decode</code>æ–¹æ³•ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªDecodePathå¯ä»¥decodeå‡ºèµ„æºã€‚<br> é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­çœ‹çœ‹<code>DecodePath.decode</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoded</span> <span class=o>=</span> <span class=n>decodeResource</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>decoded</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>transcoder</span><span class=p>.</span><span class=na>transcode</span><span class=p>(</span><span class=n>transformed</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>æ˜¾è€Œæ˜“è§ï¼Œè¿™é‡Œæœ‰3æ­¥ï¼š</p> <ol> <li>ä½¿ç”¨ResourceDecoder Listè¿›è¡Œdecode</li> <li>å°†decodedçš„èµ„æºè¿›è¡Œtransform</li> <li>å°†transformedçš„èµ„æºè¿›è¡Œtranscode</li> </ol> <p>åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œç¬¬äºŒæ¡DecodePath(<code>DecodePath{ dataClass=class java.nio.DirectByteBuffer, decoders=[ByteBufferBitmapDecoder@1ca5fe14], transcoder=BitmapDrawableTranscoder@1d8f76bd}</code>)å¯ä»¥æˆåŠŸå¤„ç†ï¼Œå¹¶è¿”å›çš„æ˜¯ä¸€ä¸ª<code>LazyBitmapDrawableResource</code>å¯¹è±¡ã€‚</p> <p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™é‡Œé¢çš„æ“ä½œè¿‡ç¨‹ï¼Œé¦–å…ˆæ˜¯<code>decodeResource</code>çš„è¿‡ç¨‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResource</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>decodeResourceWithList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>exceptions</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>listPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>exceptions</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@NonNull</span>
<span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResourceWithList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// decodersåªæœ‰ä¸€æ¡ï¼Œå°±æ˜¯ByteBufferBitmapDecoder</span>
    <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=p>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoder</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=c1>// rewinderè‡ªç„¶æ˜¯ByteBufferRewind</span>
      <span class=c1>// dataä¸ºByteBuffer</span>
      <span class=n>DataType</span> <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=p>.</span><span class=na>rewindAndGet</span><span class=p>();</span>
      <span class=c1>// ByteBufferBitmapDecoderå†…éƒ¨ä¼šè°ƒç”¨Downsamplerçš„hanldesæ–¹æ³•</span>
      <span class=c1>// å®ƒå¯¹ä»»æ„çš„InputStreamå’ŒByteBufferéƒ½è¿”å›true</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>decoder</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>options</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// è°ƒç”¨ByteBuffer.position(0)å¤ä½</span>
        <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=p>.</span><span class=na>rewindAndGet</span><span class=p>();</span>
        <span class=c1>// å¼€å§‹è§£ç </span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>decoder</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=c1>// Some decoders throw unexpectedly. If they do, we shouldn&#39;t fail the entire load path, but</span>
      <span class=c1>// instead log and continue. See #2406 for an example.</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>RuntimeException</span> <span class=o>|</span> <span class=n>OutOfMemoryError</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to decode data for &quot;</span> <span class=o>+</span> <span class=n>decoder</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=n>exceptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>break</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p><code>ByteBufferBitmapDecoder.decode</code>æ–¹æ³•ä¼šå…ˆå°†<code>ByteBuffer</code>è½¬æ¢æˆ<code>InputStream</code>ï¼Œç„¶ååœ¨è°ƒç”¨<code>Downsampler.decode</code>æ–¹æ³•è¿›è¡Œè§£ç ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=n>source</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span>
    <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
  <span class=n>InputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=n>ByteBufferUtil</span><span class=p>.</span><span class=na>toStream</span><span class=p>(</span><span class=n>source</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>downsampler</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>is</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œé¢ä½¿ç”¨çš„æŠ€å·§ä¹Ÿä¸»è¦æ˜¯ä½¿ç”¨çš„<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#1-bitmap>Bitmapçš„åŠ è½½</a>ä¸­æåˆ°çš„æŠ€å·§ã€‚<br> ä¸è¿‡åœ¨Glideä¸­ï¼Œé™¤äº†è®¾ç½®äº†<code>BitmapFactory.Options</code>çš„<code>inJustDecodeBounds</code>å’Œ<code>inSampleSize</code>å±æ€§å¤–ï¼Œè¿˜ä¼šè®¾ç½®<code>inTargetDensity</code>ã€<code>inDensity</code>ã€<code>inScale</code>ã€<code>inPreferredConfig</code>ã€<code>inBitmap</code>å±æ€§ã€‚</p> <blockquote> <p>åœ¨è®¡ç®—å„ç§å€¼çš„æ—¶å€™ï¼Œç”¨åˆ°äº†Mathé‡Œé¢ceilã€floorã€roundå‡½æ•°ã€‚<br> <code>ceil(x)</code>è¡¨ç¤ºä¸å°äºxçš„æœ€å°æ•´æ•°<br> <code>floor(x)</code>è¡¨ç¤ºä¸å¤§äºxçš„æœ€å¤§æ•´æ•°<br> <code>round(x)</code>è¡¨ç¤ºè¡¨ç¤ºå››èˆäº”å…¥ï¼Œç†è§£ä¸ºfloor(x + 0.5) </p> <p><figcaption>ceilã€floorã€roundç¤ºä¾‹</figcaption> </p> <table> <thead> <tr> <th align=center>x</th> <th align=center>ceil</th> <th align=center>floor</th> <th align=center>round</th> </tr> </thead> <tbody> <tr> <td align=center>1.4</td> <td align=center>2.0</td> <td align=center>1.0</td> <td align=center>1</td> </tr> <tr> <td align=center>1.5</td> <td align=center>2.0</td> <td align=center>1.0</td> <td align=center>2</td> </tr> <tr> <td align=center>1.6</td> <td align=center>2.0</td> <td align=center>1.0</td> <td align=center>2</td> </tr> <tr> <td align=center>-1.4</td> <td align=center>-1.0</td> <td align=center>-2.0</td> <td align=center>-1</td> </tr> <tr> <td align=center>-1.5</td> <td align=center>-1.0</td> <td align=center>-2.0</td> <td align=center>-1</td> </tr> <tr> <td align=center>-1.6</td> <td align=center>-1.0</td> <td align=center>-2.0</td> <td align=center>-2</td> </tr> </tbody> </table> <p><figure style="width: 66%" class=align-center> <img src=/assets/images/android/math-floor-ceil.png> <figcaption>flootã€ceilå–å€¼èµ°å‘ç¤ºæ„å›¾</figcaption> </figure></p> </blockquote> <p>è¿™é‡Œæ‰§è¡Œå®Œæ¯•ï¼Œä¼šå°†decodeå‡ºæ¥çš„<code>Bitmap</code>åŒ…è£…æˆä¸ºä¸€ä¸ª<code>BitmapResource</code>å¯¹è±¡ã€‚ç„¶åå°±ä¸€ç›´å¾€ä¸Šè¿”å›ï¼Œè¿”å›åˆ°<code>DecodePath.decode</code>æ–¹æ³•ä¸­ã€‚æ¥ä¸‹æ¥æ‰§è¡Œï¼š</p> <div class=highlight><pre><span></span><code><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>decoded</span><span class=p>);</span>
</code></pre></div> <p>è¿™é‡Œçš„<code>callback</code>æˆ‘ä»¬åœ¨å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¼šè°ƒç”¨<code>DecodeJob.onResourceDecoded(DataSource, Resource&lt;Z&gt;)</code>æ–¹æ³•ã€‚</p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span>
<span class=nd>@NonNull</span>
<span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=p>)</span> <span class=p>{</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>decoded</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>();</span><span class=c1>// Bitmap.class</span>
  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=p>;</span>
  <span class=c1>// dataSourceä¸ºDATA_DISK_CACHEï¼Œæ‰€ä»¥æ»¡è¶³æ¡ä»¶</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// åœ¨2.2èŠ‚ä¸­ç»™å‡ºäº†ä¸€ä¸ªã€ŒoptionalFitCenter()è¿‡ç¨‹ä¿å­˜çš„KVè¡¨ã€ï¼ŒæŸ¥é˜…å¾—çŸ¥Bitmap.classå¯¹åº”çš„æ­£æ˜¯FitCenter()</span>
    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceSubClass</span><span class=p>);</span>
    <span class=c1>// å¯¹decodedèµ„æºè¿›è¡Œtransform</span>
    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>glideContext</span><span class=p>,</span> <span class=n>decoded</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// TODO: Make this the responsibility of the Transformation.</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>decoded</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>decoded</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=kd>final</span> <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=p>;</span>
  <span class=kd>final</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>;</span>
  <span class=c1>// Bitmapæœ‰æ³¨å†Œå¯¹åº”çš„BitmapEncoderï¼Œæ‰€ä»¥æ˜¯availableçš„</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isResourceEncoderAvailable</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
    <span class=c1>// encoderå°±æ˜¯BitmapEncoder</span>
    <span class=n>encoder</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getResultEncoder</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
    <span class=c1>// encodeStrategyä¸ºEncodeStrategy.TRANSFORMED</span>
    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>.</span><span class=na>getEncodeStrategy</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>;</span>
  <span class=c1>// isSourceKeyæ˜¾ç„¶ä¸ºtrueï¼Œæ‰€ä»¥isFromAlternateCacheKeyä¸ºfalseï¼Œæ‰€ä»¥å°±è¿”å›äº†</span>
  <span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span> <span class=o>=</span> <span class=o>!</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isSourceKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>);</span>
  <span class=c1>// diskCacheStrategyä¸ºAUTOMATICï¼Œè¯¥æ–¹æ³•è¿”å›false</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isResourceCacheable</span><span class=p>(</span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span>
      <span class=n>encodeStrategy</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>encoder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>Registry</span><span class=p>.</span><span class=na>NoResultEncoderAvailableException</span><span class=p>(</span><span class=n>transformed</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>encodeStrategy</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
        <span class=n>key</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>,</span> <span class=n>signature</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>TRANSFORMED</span><span class=p>:</span>
        <span class=n>key</span> <span class=o>=</span>
            <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span>
                <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
                <span class=n>currentSourceKey</span><span class=p>,</span>
                <span class=n>signature</span><span class=p>,</span>
                <span class=n>width</span><span class=p>,</span>
                <span class=n>height</span><span class=p>,</span>
                <span class=n>appliedTransformation</span><span class=p>,</span>
                <span class=n>resourceSubClass</span><span class=p>,</span>
                <span class=n>options</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>default</span><span class=p>:</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unknown strategy: &quot;</span> <span class=o>+</span> <span class=n>encodeStrategy</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>lockedResult</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
    <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>encoder</span><span class=p>,</span> <span class=n>lockedResult</span><span class=p>);</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResult</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ç„¶åå°±å›åˆ°<code>DecodePath.decode</code>æ–¹æ³•çš„ç¬¬ä¸‰è¡Œäº†ï¼š</p> <div class=highlight><pre><span></span><code><span class=k>return</span> <span class=n>transcoder</span><span class=p>.</span><span class=na>transcode</span><span class=p>(</span><span class=n>transformed</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
</code></pre></div> <p>è¿™é‡Œçš„transcoderå°±æ˜¯<code>BitmapDrawableTranscoder</code>ï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code>LazyBitmapDrawableResource</code>ã€‚</p> <p>è‡³æ­¤ï¼Œresourceå·²ç»decodeå®Œæ¯•ã€‚ä¸‹é¢ä¸€ç›´è¿”å›åˆ°<code>DecodeJob.decodeFromRetrievedData()</code>æ–¹æ³•ä¸­ã€‚ä¸‹é¢ä¼šè°ƒç”¨<code>notifyEncodeAndRelease</code>æ–¹æ³•å®Œæˆåé¢çš„äº‹å®œã€‚</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// resourceæ˜¯BitmapResourceç±»å‹ï¼Œå®ç°äº†Initializableæ¥å£</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Initializable</span><span class=p>)</span> <span class=p>{</span>
    <span class=c1>// initializeæ–¹æ³•è°ƒç”¨äº†bitmap.prepareToDraw()</span>
    <span class=p>((</span><span class=n>Initializable</span><span class=p>)</span> <span class=n>resource</span><span class=p>).</span><span class=na>initialize</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
  <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>lockedResource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=c1>// ç”±äºåœ¨DecodeJob.onResourceDecodedæ–¹æ³•ä¸­diskCacheStrategy.isResourceCacheableè¿”å›false</span>
  <span class=c1>// æ‰€ä»¥æ²¡æœ‰è°ƒç”¨deferredEncodeManager.initæ–¹æ³•ï¼Œå› æ­¤æ­¤å¤„ä¸ºfalse</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>lockedResource</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResource</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// é€šçŸ¥å›è°ƒï¼Œèµ„æºå·²ç»å°±ç»ª</span>
  <span class=n>notifyComplete</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>

  <span class=n>stage</span> <span class=o>=</span> <span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=c1>// æ­¤å¤„ä¸ºfalse, skip</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=c1>// lockedResourceä¸ºnull, skip</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>lockedResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>lockedResource</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process</span>
  <span class=c1>// throws.</span>
  <span class=c1>// è¿›è¡Œæ¸…ç†å·¥ä½œ</span>
  <span class=n>onEncodeComplete</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™æ®µä»£ç é‡ç‚¹åœ¨äº<code>notifyComplete</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨<code>callback.onResourceReady(resource, dataSource)</code>å°†ç»“æœä¼ é€’ç»™å›è°ƒï¼Œè¿™é‡Œçš„å›è°ƒæ˜¯<code>EngineJob</code>ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// EngineJob.java</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>notifyCallbacksOfResult</span><span class=p>();</span>
<span class=p>}</span>

<span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=p>()</span> <span class=p>{</span>
  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=p>;</span>
  <span class=n>Key</span> <span class=n>localKey</span><span class=p>;</span>
  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// TODO: Seems like we might as well put this in the memory cache instead of just recycling</span>
      <span class=c1>// it since we&#39;ve gotten this far...</span>
      <span class=n>resource</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
      <span class=n>release</span><span class=p>();</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Received a resource without any callbacks to notify&quot;</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>hasResource</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already have resource&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=c1>// engineResourceFactoryé»˜è®¤ä¸ºEngineResourceFactory</span>
    <span class=c1>// å…¶buildæ–¹æ³•å°±æ˜¯newä¸€ä¸ªå¯¹åº”çš„èµ„æº</span>
    <span class=c1>// new EngineResource&lt;&gt;(resource, isMemoryCacheable, /*isRecyclable=*/ true)</span>
    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>isCacheable</span><span class=p>);</span>
    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the</span>
    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under</span>
    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section</span>
    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.</span>
    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span>
    <span class=n>incrementPendingCallbacks</span><span class=p>(</span><span class=n>copy</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// listenerå°±æ˜¯Engineï¼Œè¯¥æ–¹æ³•ä¼šè®²èµ„æºä¿å­˜åˆ°activeResourcesä¸­</span>
  <span class=n>listener</span><span class=p>.</span><span class=na>onEngineJobComplete</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>localKey</span><span class=p>,</span> <span class=n>localResource</span><span class=p>);</span>

  <span class=c1>// è¿™é‡Œçš„ResourceCallbackAndExecutorå°±æ˜¯æˆ‘ä»¬åœ¨3.3èŠ‚ä¸­åˆ›å»ºEngineJobå’ŒDecodeJob</span>
  <span class=c1>// å¹¶åœ¨æ‰§è¡ŒDecodeJobä¹‹å‰æ·»åŠ çš„å›è°ƒ</span>
  <span class=c1>// entry.executorå°±æ˜¯Glide.with.load.intoä¸­å‡ºç°çš„Executors.mainThreadExecutor()</span>
  <span class=c1>// entry.cbå°±æ˜¯SingleRequest</span>
  <span class=k>for</span> <span class=p>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>entry</span><span class=p>.</span><span class=na>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>cb</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p><code>listener.onEngineJobComplete</code>çš„ä»£ç å¾ˆç®€å•ã€‚é¦–å…ˆä¼šè®¾ç½®èµ„æºçš„å›è°ƒä¸ºè‡ªå·±ï¼Œè¿™æ ·åœ¨èµ„æºé‡Šæ”¾æ—¶ä¼šé€šçŸ¥è‡ªå·±çš„å›è°ƒæ–¹æ³•ï¼Œå°†èµ„æºä»activeçŠ¶æ€å˜ä¸ºcacheçŠ¶æ€ï¼Œå¦‚<code>onResourceReleased</code>æ–¹æ³•ï¼›ç„¶åå°†èµ„æºæ”¾å…¥activeResourcesä¸­ï¼Œèµ„æºå˜ä¸ºactiveçŠ¶æ€ï¼›æœ€åå°†engineJobä»Jobsä¸­ç§»é™¤ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=p>(</span>
    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=p>,</span> <span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>resource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=n>jobs</span><span class=p>.</span><span class=na>removeIfCurrent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>activeResources</span><span class=p>.</span><span class=na>deactivate</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>resourceRecycler</span><span class=p>.</span><span class=na>recycle</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>ç„¶åçœ‹ä¸‹<code>entry.executor.execute(new CallResourceReady(entry.cb));</code>çš„å®ç°ï¼Œ<code>Executors.mainThreadExecutor()</code>çš„å®ç°ä¹‹å‰è¯´è¿‡ï¼Œå°±æ˜¯ä¸€ä¸ªä½¿ç”¨MainLooperçš„Handlerï¼Œåœ¨execute Runnableæ—¶ä½¿ç”¨æ­¤Handler postå‡ºå»ã€‚æ‰€ä»¥æˆ‘ä»¬çš„å…³æ³¨ç‚¹å°±åœ¨<code>CallResourceReady</code>ä¸Šé¢äº†ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>class</span> <span class=nc>CallResourceReady</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>

    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>;</span>

    <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
      <span class=kd>synchronized</span> <span class=p>(</span><span class=n>EngineJob</span><span class=p>.</span><span class=na>this</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>cb</span><span class=p>))</span> <span class=p>{</span>
          <span class=c1>// Acquire for this particular callback.</span>
          <span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
          <span class=n>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
          <span class=n>removeCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></div> <p>ummmmï¼ŒæŠ›å¼€åŒæ­¥æ“ä½œä¸è°ˆï¼Œé¦–å…ˆè°ƒç”¨<code>callCallbackOnResourceReady(cb)</code>è°ƒç”¨callbackï¼Œç„¶åè°ƒç”¨<code>removeCallback(cb)</code>ç§»é™¤callbackã€‚çœ‹çœ‹<code>callCallbackOnResourceReady(cb)</code>ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span>
  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=c1>// This is overly broad, some Glide code is actually called here, but it&#39;s much</span>
      <span class=c1>// simpler to encapsulate here than to do so at the actual call point in the</span>
      <span class=c1>// Request implementation.</span>
      <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>engineResource</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>CallbackException</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œå°±è°ƒç”¨äº†<code>cb.onResourceReady</code>ï¼Œè¿™é‡Œè¯´åˆ°è¿‡entry.cbå°±æ˜¯SingleRequestã€‚æ‰€ä»¥ç»§ç»­çœ‹çœ‹<code>SingleRequest.onResourceReady</code>æ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶<code>onResourceReady(Resource&lt;?&gt;, DataSource)</code>éƒ½åœ¨åšsanity checkï¼Œæœ€åè°ƒç”¨äº†<code>onResourceReady(Resource&lt;?&gt;, R, DataSource)</code>ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
  <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Expected to receive a Resource&lt;R&gt; with an &quot;</span>
        <span class=o>+</span> <span class=s>&quot;object of &quot;</span> <span class=o>+</span> <span class=n>transcodeClass</span> <span class=o>+</span> <span class=s>&quot; inside, but instead got null.&quot;</span><span class=p>);</span>
    <span class=n>onLoadFailed</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>Object</span> <span class=n>received</span> <span class=o>=</span> <span class=n>resource</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>received</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transcodeClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>received</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>releaseResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
    <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Expected to receive an object of &quot;</span>
        <span class=o>+</span> <span class=n>transcodeClass</span> <span class=o>+</span> <span class=s>&quot; but instead&quot;</span> <span class=o>+</span> <span class=s>&quot; got &quot;</span>
        <span class=o>+</span> <span class=p>(</span><span class=n>received</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>received</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span> <span class=p>:</span> <span class=s>&quot;&quot;</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot;{&quot;</span> <span class=o>+</span> <span class=n>received</span> <span class=o>+</span> <span class=s>&quot;} inside&quot;</span> <span class=o>+</span> <span class=s>&quot; &quot;</span>
        <span class=o>+</span> <span class=s>&quot;Resource{&quot;</span> <span class=o>+</span> <span class=n>resource</span> <span class=o>+</span> <span class=s>&quot;}.&quot;</span>
        <span class=o>+</span> <span class=p>(</span><span class=n>received</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=s>&quot;&quot;</span> <span class=p>:</span> <span class=s>&quot; &quot;</span> <span class=o>+</span> <span class=s>&quot;To indicate failure return a null Resource &quot;</span>
        <span class=o>+</span> <span class=s>&quot;object, rather than a Resource object containing null data.&quot;</span><span class=p>));</span>
    <span class=n>onLoadFailed</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>canSetResource</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>releaseResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
    <span class=c1>// We can&#39;t put the status to complete before asking canSetResource().</span>
    <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>;</span>
    <span class=k>return</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>onResourceReady</span><span class=p>((</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>resource</span><span class=p>,</span> <span class=p>(</span><span class=n>R</span><span class=p>)</span> <span class=n>received</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p><code>onResourceReady(Resource&lt;?&gt;, R, DataSource)</code>æ–¹æ³•å¦‚ä¸‹ï¼Œå…¶å¤„ç†è¿‡ç¨‹å’Œ<code>onLoadFailed</code>æ–¹æ³•éå¸¸ç±»ä¼¼ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>R</span> <span class=n>result</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// We must call isFirstReadyResource before setting status.</span>
  <span class=c1>// ç”±äºrequestCoordinatorä¸ºnullï¼Œæ‰€ä»¥è¿”å›true</span>
  <span class=kt>boolean</span> <span class=n>isFirstResource</span> <span class=o>=</span> <span class=n>isFirstReadyResource</span><span class=p>();</span>
  <span class=c1>// å°†statusçŠ¶æ€è®¾ç½®ä¸ºCOMPLETE</span>
  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>;</span>
  <span class=k>this</span><span class=p>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>glideContext</span><span class=p>.</span><span class=na>getLogLevel</span><span class=p>()</span> <span class=o>&lt;=</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>,</span> <span class=s>&quot;Finished loading &quot;</span> <span class=o>+</span> <span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot; from &quot;</span>
        <span class=o>+</span> <span class=n>dataSource</span> <span class=o>+</span> <span class=s>&quot; for &quot;</span> <span class=o>+</span> <span class=n>model</span> <span class=o>+</span> <span class=s>&quot; with size [&quot;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&quot;x&quot;</span> <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&quot;] in &quot;</span>
        <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot; ms&quot;</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
     <span class=c1>// å°è¯•è°ƒç”¨å„ä¸ªlistenerçš„onResourceReadyå›è°ƒè¿›è¡Œå¤„ç†</span>
    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=p>:</span> <span class=n>requestListeners</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
            <span class=n>listener</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>isFirstResource</span><span class=p>);</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>isFirstResource</span><span class=p>);</span>

    <span class=c1>// å¦‚æœæ²¡æœ‰ä¸€ä¸ªå›è°ƒèƒ½å¤Ÿå¤„ç†ï¼Œé‚£ä¹ˆè‡ªå·±å¤„ç†</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// animationFactoryé»˜è®¤ä¸ºNoTransition.getFactory()ï¼Œç”Ÿæˆçš„animationä¸ºNO_ANIMATION</span>
      <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>animation</span> <span class=o>=</span>
          <span class=n>animationFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>dataSource</span><span class=p>,</span> <span class=n>isFirstResource</span><span class=p>);</span>
      <span class=c1>// targetä¸ºDrawableImageViewTarget</span>
      <span class=n>target</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>animation</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=c1>// é€šçŸ¥requestCoordinator</span>
  <span class=n>notifyLoadSuccess</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p><code>DrawableImageViewTarget</code>çš„åŸºç±»<code>ImageViewTarget</code>å®ç°äº†æ­¤æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// ImageViewTarget.java</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// NO_ANIMATION.transitionè¿”å›falseï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨setResourceInternalæ–¹æ³•</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>transition</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transition</span><span class=p>.</span><span class=na>transition</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=k>this</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>setResourceInternal</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>setResourceInternal</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Order matters here. Set the resource first to make sure that the Drawable has a valid and</span>
  <span class=c1>// non-null Callback before starting it.</span>
  <span class=c1>// å…ˆè®¾ç½®å›¾ç‰‡</span>
  <span class=n>setResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
  <span class=c1>// ç„¶åå¦‚æœæ˜¯åŠ¨ç”»ï¼Œä¼šæ‰§è¡ŒåŠ¨ç”»</span>
  <span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>maybeUpdateAnimatable</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// BitmapDrawableæ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªAnimatableå¯¹è±¡ï¼Œæ‰€ä»¥èµ°elseåˆ†æ”¯</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Animatable</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>animatable</span> <span class=o>=</span> <span class=p>(</span><span class=n>Animatable</span><span class=p>)</span> <span class=n>resource</span><span class=p>;</span>
    <span class=n>animatable</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>animatable</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// DrawableImageViewTarget</span>
<span class=nd>@Override</span>
<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>setResource</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>view</span><span class=p>.</span><span class=na>setImageDrawable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>OKï¼Œè‡³æ­¤ç½‘ç»œå›¾ç‰‡å·²ç»é€šè¿‡<code>view.setImageDrawable(resource)</code>åŠ è½½å®Œæ¯•ã€‚å®Œç»“æ’’èŠ±ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ </p> <p>Butï¼Œæ•´ä¸ªæµç¨‹çœ‹çš„è„‘é˜”ç–¼ã€‚è¿™ç¯‡æ–‡ç« ä»4æœˆ25å·åˆ°ä»Šå¤©5æœˆ5å·ç»å†äº†10å¤©ï¼ŒæŠ›å¼€ä¸­é—´51çš„4å¤©å‡ï¼Œå·®ä¸å¤šä¹Ÿæœ‰ä¸€å‘¨ä¹‹ä¹…ï¼Œæ—¶æ–­æ—¶ç»­ï¼Œä¸€éæ‹ä¸‹æ¥æˆ‘è‡ªå·±ä¹Ÿæ˜¯åŠæ‡µçš„ï¼Œæ‰€ä»¥åº”è¯¥å¾—æœ‰ä¸ªæ€»ç»“å§ã€‚ä¸ç„¶æ¯æ¬¡æ¸©ä¹ ä¸€éï¼Œä¸€éå°±å¾—æ¸©ä¹ å‡ å¤©ã€‚<br> æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ï¼Œæ¯ç¯‡éƒ½ä¼šé€‰å–ä¸€ä¸ªæ–¹é¢è¿›è¡Œæ€»ç»“ã€‚æ­¤å¤–ï¼Œæœ¬æ–‡çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <figure style="width: 95%" class=align-center> <img src=/assets/images/android/glide-overview.png> <figcaption>Glideæ•´ä½“æµç¨‹å›¾</figcaption> </figure> <hr> <div class=md-source-date> <small> æœ€åæ›´æ–°: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2020å¹´5æœˆ16æ—¥</span> </small> </div> <h2 id=__comments>è¯„è®º</h2> <div id=disqus_thread></div> <script>var disqus_config=function(){this.page.url="https://blog.yorek.xyz/about-me/android/3rd-library/glide2/",this.page.identifier="/android/3rd-library/glide2/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//yorekliu.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../glide1/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> ä¸Šä¸€é¡µ </span> Glide v4 æºç è§£æï¼ˆä¸€ï¼‰ </div> </div> </a> <a href=../glide3/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> ä¸‹ä¸€é¡µ </span> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2021 Yorek </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/YorekLiu target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/></svg> </a> <a href=lyytogether@gmail.com target=_blank rel=noopener title class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 8l-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/vendor.93c04032.min.js></script> <script src=../../../assets/javascripts/bundle.83e5331e.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../..",
          features: ['navigation.tabs', 'navigation.instant'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
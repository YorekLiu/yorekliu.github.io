<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An Android Developer."><meta name=author content="Yorek Liu"><link href=https://blog.yorek.xyz/about-me/android/3rd-library/glide3/ rel=canonical><link rel="shortcut icon" href=../../../assets/images/favicon.webp><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.2.5"><title>Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ - Yorek's</title><link rel=stylesheet href=../../../assets/stylesheets/main.15aa0b43.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.75751829.min.css><meta name=theme-color content=#ffffff><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=manifest href=../../../manifest.webmanifest crossorigin=use-credentials><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-155096376-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=white data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-glide class=md-skip> è·³è½¬è‡³ </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-header-nav__button md-logo" aria-label="Yorek's"> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <div class=md-header-nav__topic> <span class=md-ellipsis> Yorek's </span> </div> <div class=md-header-nav__topic> <span class=md-ellipsis> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </span> </div> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=æœç´¢ placeholder=æœç´¢ autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> æ­£åœ¨åˆå§‹åŒ–æœç´¢å¼•æ“ </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://blog.yorek.xyz/about-me title="Yorek's" class="md-nav__button md-logo" aria-label="Yorek's"> <img src=../../../assets/images/favicon.webp alt=logo> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1 type=checkbox id=nav-1 checked> <label class=md-nav__link for=nav-1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=nav-1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-1 type=checkbox id=nav-1-1 checked> <label class=md-nav__link for=nav-1-1> ä¸‰æ–¹åº“æºç è§£æ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ä¸‰æ–¹åº“æºç è§£æ data-md-level=2> <label class=md-nav__title for=nav-1-1> <span class="md-nav__icon md-icon"></span> ä¸‰æ–¹åº“æºç è§£æ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ class=md-nav__link> Androidä¸‰æ–¹åº“æºç åˆ†æ </a> </li> <li class=md-nav__item> <a href=../matrix/ class=md-nav__link> å¾®ä¿¡APM Matrixè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ class=md-nav__link> Matrix-TraceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-io/ class=md-nav__link> Matrix-IOCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ class=md-nav__link> Matrix-ResourceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLintè§£æ </a> </li> <li class=md-nav__item> <a href=../okhttp/ class=md-nav__link> OkHttp3æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../retrofit/ class=md-nav__link> Retrofit2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../rxjava%26rxandroid/ class=md-nav__link> RxJavaæºç è§£æåŠä½¿ç”¨å®ä¾‹ </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJavaæ“ä½œç¬¦å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../glide1/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸€ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide2/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </a> <nav class="md-nav md-nav--secondary" aria-label=ç›®å½•> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> ç›®å½• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-glide class=md-nav__link> 1. Glideç¼“å­˜æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=#2-memorycache class=md-nav__link> 2. memoryCacheä»‹ç» </a> </li> <li class=md-nav__item> <a href=#3-diskcachefactory class=md-nav__link> 3. diskCacheFactoryä»‹ç» </a> </li> <li class=md-nav__item> <a href=#4-activeresources class=md-nav__link> 4. ActiveResources </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> 5. ç¼“å­˜åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹ </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide4/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå››ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide5/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆäº”ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide6/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå…­ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide7/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸ƒï¼‰ </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ class=md-nav__link> æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ class=md-nav__link> EventBusæºç è§£æ </a> </li> <li class=md-nav__item> <a href=../leakcanary/ class=md-nav__link> LeakCanary2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ class=md-nav__link> PermissionDispatcheræºç è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayoutä½¿ç”¨å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> åˆå­¦è€…çš„Dagger2æ•™ç¨‹ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-2 type=checkbox id=nav-1-2> <label class=md-nav__link for=nav-1-2> Androidå¼€å‘é«˜æ‰‹è¯¾ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Androidå¼€å‘é«˜æ‰‹è¯¾ data-md-level=2> <label class=md-nav__title for=nav-1-2> <span class="md-nav__icon md-icon"></span> Androidå¼€å‘é«˜æ‰‹è¯¾ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ class=md-nav__link> Androidå¼€å‘é«˜æ‰‹è¯¾ </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | å´©æºƒä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå…³äºâ€œå´©æºƒâ€é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | å´©æºƒä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šåº”ç”¨å´©æºƒäº†ï¼Œä½ åº”è¯¥å¦‚ä½•å»åˆ†æï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼š4GBå†…å­˜æ—¶ä»£ï¼Œå†è°ˆå†…å­˜ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå†…å­˜ä¼˜åŒ–è¿™ä»¶äº‹ï¼Œåº”è¯¥ä»å“ªé‡Œç€æ‰‹ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä½ è¦æŒæ¡çš„å¡é¡¿åˆ†ææ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§åº”ç”¨å¡é¡¿ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06è¡¥å……ç¯‡ | å¡é¡¿ä¼˜åŒ–ï¼šå¡é¡¿ç°åœºä¸å¡é¡¿åˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»å¯åŠ¨è¿‡ç¨‹çœ‹å¯åŠ¨é€Ÿåº¦ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šä¼˜åŒ–å¯åŠ¨é€Ÿåº¦çš„è¿›é˜¶æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/Oä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„I/Oä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/Oä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šä¸åŒI/Oæ–¹å¼çš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/Oä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§çº¿ä¸ŠI/Oæ“ä½œï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¸¸è§çš„æ•°æ®å­˜å‚¨æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ–æ•°æ®å­˜å‚¨ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šæ•°æ®åº“SQLiteçš„ä½¿ç”¨å’Œä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šç§»åŠ¨å¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„ç½‘ç»œä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¤æ‚å¤šå˜çš„ç§»åŠ¨ç½‘ç»œè¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¤§æ•°æ®ä¸‹ç½‘ç»œè¯¥å¦‚ä½•ç›‘æ§ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | è€—ç”µä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»ç”µé‡ä¼˜åŒ–çš„æ¼”è¿›çœ‹è€—ç”µåˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | è€—ç”µä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šè€—ç”µçš„ä¼˜åŒ–æ–¹æ³•ä¸çº¿ä¸Šç›‘æ§ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šUI æ¸²æŸ“çš„å‡ ä¸ªå…³é”®æ¦‚å¿µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ– UI æ¸²æŸ“ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å‡å°‘å®‰è£…åŒ…å¤§å°ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šèµ„æºä¼˜åŒ–çš„è¿›é˜¶å®è·µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | å…³äºç¼–è¯‘ï¼Œä½ éœ€è¦äº†è§£ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | ç¼–è¯‘æ’æ¡©çš„ä¸‰ç§æ–¹æ³•ï¼šAspectJã€ASMã€ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook æŠ€æœ¯ï¼Œå¤©ä½¿è¿˜æ˜¯é­”é¬¼ï¼Ÿ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-3 type=checkbox id=nav-1-3> <label class=md-nav__link for=nav-1-3> Frameworkç³»åˆ— <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Frameworkç³»åˆ— data-md-level=2> <label class=md-nav__title for=nav-1-3> <span class="md-nav__icon md-icon"></span> Frameworkç³»åˆ— </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providersä¸Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPCæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> Viewçš„äº‹ä»¶ä½“ç³» </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> Viewçš„ç»˜åˆ¶åŸç† </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> Androidä¸­çš„Drawableèµ„æº </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> AndroidåŠ¨ç”» </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Windowä¸WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> å››å¤§ç»„ä»¶å¯åŠ¨è¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Androidæ¶ˆæ¯æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Androidçº¿ç¨‹ä¸çº¿ç¨‹æ±  </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmapçš„ç¼“å­˜ä¸åŠ è½½ </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNIä¸NDKç¼–ç¨‹ç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Androidæ€§èƒ½ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ä»¥MediaServiceä¸ºä¾‹ </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ç½—è€å¸ˆç³»åˆ— </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4 type=checkbox id=nav-1-4> <label class=md-nav__link for=nav-1-4> ä»˜è´¹çŸ¥è¯†å½’æ¡£ <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ä»˜è´¹çŸ¥è¯†å½’æ¡£ data-md-level=2> <label class=md-nav__title for=nav-1-4> <span class="md-nav__icon md-icon"></span> ä»˜è´¹çŸ¥è¯†å½’æ¡£ </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-4-1 type=checkbox id=nav-1-4-1> <label class=md-nav__link for=nav-1-4-1> æŸåœˆé—®é¢˜ç´¢å¼• <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=æŸåœˆé—®é¢˜ç´¢å¼• data-md-level=3> <label class=md-nav__title for=nav-1-4-1> <span class="md-nav__icon md-icon"></span> æŸåœˆé—®é¢˜ç´¢å¼• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/zsxq_index/ class=md-nav__link> æŸåœˆé—®é¢˜ç´¢å¼• </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> ç†è§£Javaä¸­synchronizedå…³é”®è¯ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> ç†è§£Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> ç†è§£Activityçš„å¯åŠ¨æ¨¡å¼ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> å…³äºstartActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> å…³äºViewçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> å…³äºGradleçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> å…³äºåºåˆ—åŒ–çš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Androidä¸­çš„ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binderç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttpå’ŒRetrofitçš„ä½œç”¨ä»¥åŠä¸¤è€…ä¹‹é—´çš„è”ç³» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVMä¸­åƒåœ¾å›æ”¶ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> è¿›ç¨‹ä¿æ´» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> å››å¤§ç»„ä»¶çš„ä½œç”¨ä»¥åŠå¤šè¿›ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> ç½‘ç»œåè®® </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVCã€MVPå’ŒMVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio buildè¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> å¤§å°ºå¯¸å›¾ç‰‡åŠ è½½é—®é¢˜ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-1-5 type=checkbox id=nav-1-5> <label class=md-nav__link for=nav-1-5> æ—¥å¸¸è®°å½• <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=æ—¥å¸¸è®°å½• data-md-level=2> <label class=md-nav__title for=nav-1-5> <span class="md-nav__icon md-icon"></span> æ—¥å¸¸è®°å½• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> æ³¨è§£çš„å®šä¹‰åŠè§£æ </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> è¿™å¯èƒ½æ˜¯MVVMä¸­æœ€ä¼˜é›…çš„æŒ‰é”®é˜²æŠ–æ–¹æ¡ˆ </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> æ™®é€šAndroidç¨‹åºä½¿ç”¨SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListViewã€RecyclerViewç¼“å­˜ç­–ç•¥è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerViewçš„ä¸€äº›ä½¿ç”¨ç»†èŠ‚ </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”æ‹–æ‹½æ’åºä»¥åŠæ»‘åŠ¨åˆ é™¤ </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButtonä¸Šæ»‘éšè—ä¸‹æ»‘æ˜¾ç¤º </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrollingæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> ä½¿ç”¨Porter-Duffåˆæˆæ•°å­—å›¾åƒ </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Androidé©¬ç”²åŒ…çš„é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Androidç¥å…µåˆ©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Androidåˆ¤æ–­è™šæ‹ŸæŒ‰é”®(å¯¼èˆªæ )æ˜¾ç¤ºä¸å¦ã€é«˜åº¦ä»¥åŠè·å–å±å¹•å®é™…é«˜åº¦ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Androidå›¾ç‰‡é€‰æ‹©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> AndroidåŸç”Ÿåº•éƒ¨å¯¼èˆªæ  </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Androidæœç´¢æ çš„å®ç° </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Androidæš‚åœé…·ç‹—ã€ç½‘æ˜“äº‘éŸ³ä¹ç­‰éŸ³ä¹æ’­æ”¾å™¨çš„æ’­æ”¾ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Androidæ»‘åŠ¨è¿”å›å®è·µ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOSä¸‹Androidç¨‹åºåç¼–è¯‘ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Androidé€šè®¯å½•å¿«é€Ÿè¯»å– </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> Appå†…è‡ªå®šä¹‰è½¯é”®ç›˜ </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> è…¾è®¯TBS X5æµè§ˆå™¨å†…æ ¸å…¥å‘æŒ‡å— </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> çç¢çŸ¥è¯†ç‚¹ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-2 type=checkbox id=nav-2> <label class=md-nav__link for=nav-2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=nav-2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-3 type=checkbox id=nav-3> <label class=md-nav__link for=nav-3> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=nav-3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ class=md-nav__link> ç®—æ³•ç›®å½• </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> æ•°æ®ç»“æ„ã€ç®—æ³•å’Œæ•°æ®æ“ä½œ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> é«˜è´¨é‡çš„ä»£ç  </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> è§£å†³é—®é¢˜çš„æ€è·¯ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> ä¼˜åŒ–æ—¶é—´å’Œç©ºé—´æ•ˆç‡ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> é¢è¯•ä¸­çš„å„é¡¹èƒ½åŠ› </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4> <label class=md-nav__link for=nav-4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-1 type=checkbox id=nav-4-1> <label class=md-nav__link for=nav-4-1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=nav-4-1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> è®¾è®¡æ¨¡å¼æ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™ </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> å•ä¾‹æ¨¡å¼(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> å»ºé€ è€…æ¨¡å¼(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> åŸå‹æ¨¡å¼(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> å·¥å‚æ–¹æ³•æ¨¡å¼(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> æŠ½è±¡å·¥å‚æ¨¡å¼(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> ä»£ç†æ¨¡å¼(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> ç»„åˆæ¨¡å¼(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> é€‚é…å™¨æ¨¡å¼(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> è£…é¥°æ¨¡å¼(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> äº«å…ƒæ¨¡å¼(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> å¤–è§‚æ¨¡å¼(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> æ¡¥æ¥æ¨¡å¼(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> ç­–ç•¥æ¨¡å¼(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> çŠ¶æ€æ¨¡å¼(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> è´£ä»»é“¾æ¨¡å¼(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> è§£é‡Šå™¨æ¨¡å¼(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> å‘½ä»¤æ¨¡å¼(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> è§‚å¯Ÿè€…æ¨¡å¼(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> å¤‡å¿˜å½•æ¨¡å¼(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> è¿­ä»£å™¨æ¨¡å¼(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> è®¿é—®è€…æ¨¡å¼(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> ä¸­ä»‹è€…æ¨¡å¼(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> æ˜“æ··æ·†çš„è®¾è®¡æ¨¡å¼ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-2 type=checkbox id=nav-4-2> <label class=md-nav__link for=nav-4-2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=nav-4-2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Javaæ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> ç±»å’Œæ¥å£ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-3 type=checkbox id=nav-4-3> <label class=md-nav__link for=nav-4-3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=nav-4-3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸ </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> ç±»æ–‡ä»¶ç»“æ„ </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-4 type=checkbox id=nav-4-4> <label class=md-nav__link for=nav-4-4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=nav-4-4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlinåœ¨æ³›å‹æ–¹é¢çš„åŒºåˆ« </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Javaé›†åˆæ€»ç»“ </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Javaå¸¸è§æ¦‚å¿µ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-5 type=checkbox id=nav-4-5> <label class=md-nav__link for=nav-4-5> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=nav-4-5> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> é‡æ„ï¼šæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=ç›®å½•> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> ç›®å½• </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#1-glide class=md-nav__link> 1. Glideç¼“å­˜æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=#2-memorycache class=md-nav__link> 2. memoryCacheä»‹ç» </a> </li> <li class=md-nav__item> <a href=#3-diskcachefactory class=md-nav__link> 3. diskCacheFactoryä»‹ç» </a> </li> <li class=md-nav__item> <a href=#4-activeresources class=md-nav__link> 4. ActiveResources </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> 5. ç¼“å­˜åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹ </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1>Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>æœ¬ç³»åˆ—æ–‡ç« å‚è€ƒ3.7.0ç‰ˆæœ¬çš„<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glideæœ€å…¨è§£æ</a>ï¼Œå¹¶æŒ‰æ­¤æ€è·¯ç»“åˆ4.9.0ç‰ˆæœ¬æºç ä»¥åŠä½¿ç”¨æ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚<br> âŸ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> âŸ <a href=https://muyangmin.github.io/glide-docs-cn/ >ä¸­æ–‡æ–‡æ¡£</a><br> âŸ <a href=https://bumptech.github.io/glide/ >è‹±æ–‡æ–‡æ¡£</a>ğŸš€ğŸš€ </p> </div> <div class="admonition note"> <p class=admonition-title>Glideç³»åˆ—æ–‡ç« ç›®å½•</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1â€”â€”Glide v4 çš„åŸºæœ¬ä½¿ç”¨</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2â€”â€”ä»æºç çš„è§’åº¦ç†è§£Glideä¸‰æ­¥çš„æ‰§è¡Œæµç¨‹</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3â€”â€”æ·±å…¥æ¢ç©¶Glideç¼“å­˜æœºåˆ¶</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4â€”â€”RequestBuilderä¸­é«˜çº§ç‚¹çš„APIä»¥åŠTarget</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5â€”â€”Glideå†…ç½®çš„transformä»¥åŠè‡ªå®šä¹‰BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6â€”â€”Glideåˆ©ç”¨AppGlideModuleã€LibraryGlideModuleæ›´æ”¹é»˜è®¤é…ç½®ã€æ‰©å±•GlideåŠŸèƒ½ï¼›GlideAppä¸Glideçš„åŒºåˆ«åœ¨å“ªï¼Ÿ</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7â€”â€”åˆ©ç”¨OkHttpã€è‡ªå®šä¹‰Drawableã€è‡ªå®šä¹‰ViewTargetå®ç°å¸¦è¿›åº¦çš„å›¾ç‰‡åŠ è½½åŠŸèƒ½</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide</a></li> </ul> </div> <hr> <h2 id=1-glide>1. Glideç¼“å­˜æœºåˆ¶<a class=headerlink href=#1-glide title="Permanent link">&para;</a></h2> <p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æ¯”è¾ƒè¯¦ç»†åœ°ä»‹ç»äº†<code>Glide.with(xx).load(xx).into(xx)</code>ä¸­çš„å¾ˆå¤šè¿‡ç¨‹ï¼Œè™½ç„¶çœ‹å®Œä¹‹åç†å¾—ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šã€‚ä½†æ˜¯æ²¡å…³ç³»ï¼Œè¿™ç¯‡æ–‡ç« å¼€å§‹ä¼šä¸€ä¸ªæ–¹é¢ä¸€ä¸ªæ–¹é¢åœ°è¿›è¡Œæ€»ç»“ã€‚ </p> <p>æœ¬ç¯‡æ–‡ç« ä¸»è¦è®¨è®ºçš„å°±æ˜¯Glideä¸­çš„ç¼“å­˜é—®é¢˜ã€‚Glideç¼“å­˜æœºåˆ¶çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <figure style="width: 100%" class=align-center> <img src=/assets/images/android/glide-cache-flow-chart.png> <figcaption>Glideç¼“å­˜æµç¨‹å›¾</figcaption> </figure> <p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒGlideçš„èµ„æºçŠ¶æ€å¯ä»¥åˆ†ä¸ºå››ç§ï¼š</p> <ol> <li> <p>activeçŠ¶æ€èµ„æº </p> <blockquote> <p><code>Engine.load</code>æ–¹æ³•ä¸Šçš„æ³¨é‡Šå†™åˆ°ï¼šActive resources are those that have been provided to at least one request and have not yet been released. Once all consumers of a resource have released that resource, the resource then goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to the active resources. If the resource is evicted from the cache, its resources are recycled and re-used if possible and the resource is discarded. There is no strict requirement that consumers release their resources so active resources are held weakly.</p> </blockquote> </li> <li> <p>å†…å­˜ç¼“å­˜</p> </li> <li>dataç£ç›˜ç¼“å­˜ï¼šåŸå§‹çš„æ²¡æœ‰ä¿®æ”¹è¿‡çš„æ•°æ®ç¼“å­˜</li> <li>resourceç£ç›˜èµ„æºï¼šç»è¿‡è§£ç ã€transformedåçš„ç¼“å­˜</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>åœ¨<a href=https://muyangmin.github.io/glide-docs-cn/doc/caching.html>Glideä½¿ç”¨æ–‡æ¡£-ç¼“å­˜éƒ¨åˆ†</a>ä¸­æœ‰å¯¹Glideçš„æ•´ä¸ªç¼“å­˜ä½“ç³»åšå‡ºä¸€ä¸ªæ€»ç»“ï¼Œå‰å¾€äº†è§£ä¸€ä¸‹è¿˜æ˜¯éå¸¸å¥½çš„ã€‚ </p> </div> <p>åœ¨æ–‡æ¡£ä¸­æœ‰Glideçš„ç¼“å­˜ä½“ç³»çš„æ•´ä½“æè¿°ï¼Œæ–‡å­—æ‘˜æŠ„å¦‚ä¸‹ï¼š </p> <blockquote> <p>By default, Glide checks multiple layers of caches before starting a new request for an image:<br> 1. Active resources - Is this image displayed in another View right now? 2. Memory cache - Was this image recently loaded and still in memory? 3. Resource - Has this image been decoded, transformed, and written to the disk cache before? 4. Data - Was the data this image was obtained from written to the disk cache before? </p> <p>The first two steps check to see if the resource is in memory and if so, return the image immediately. The second two steps check to see if the image is on disk and return quickly, but asynchronously. </p> <p>If all four steps fail to find the image, then Glide will go back to the original source to retrieve the data (the original File, Uri, Url etc).<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#caching-in-glide>Caching in Glide</a></cite> </p> </blockquote> <p>ä¸‹é¢å¼€å§‹ä¸€è¾¹è¿‡æºç ï¼Œä¸€éå°è¯ä¸Šé¢çš„å›¾å’Œæ¦‚è¦ã€‚</p> <p>Glideçš„memory cacheå’Œdisk cacheåœ¨Glideåˆ›å»ºçš„æ—¶å€™å°±ç¡®å®šäº†ã€‚ä»£ç åœ¨<code>GlideBuilder.build(Context)</code>æ–¹æ³•é‡Œé¢ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒGlideæ˜¯å•ä¾‹å®ç°çš„ï¼Œåœ¨ä¸Šä¸€ç«  <a href=/android/3rd-library/glide2/#11-getretrievercontext>1.1èŠ‚ getRetriever(Context)</a> ä¸­æˆ‘ä»¬åˆ†ææ—¶è´´äº†å¯¹åº”çš„ä»£ç ã€‚</p> <p>memory cacheå’Œdisk cacheåœ¨Glideåˆ›å»ºæ—¶ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <p><strong>GlideBuilder.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span>
<span class=n>Glide</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>engine</span> <span class=o>=</span>
        <span class=k>new</span> <span class=n>Engine</span><span class=p>(</span>
            <span class=n>memoryCache</span><span class=p>,</span>
            <span class=n>diskCacheFactory</span><span class=p>,</span>
            <span class=p>...);</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=p>(</span>
      <span class=p>...</span>
      <span class=n>memoryCache</span><span class=p>,</span>
      <span class=p>...);</span>
<span class=p>}</span>
</code></pre></div> <p>memoryCacheå’ŒdiskCacheFactoryå¦‚æœæ²¡æœ‰æ²¡æœ‰åœ¨ä»»ä½•<code>GlideMode</code>ä¸­è¿›è¡Œè®¾ç½®çš„è¯ï¼Œä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªé»˜è®¤å®ç°å°±å¾ˆå¥½äº†ã€‚ </p> <h2 id=2-memorycache>2. memoryCacheä»‹ç»<a class=headerlink href=#2-memorycache title="Permanent link">&para;</a></h2> <p>memoryCacheå‘ç”Ÿå­˜å–æ“ä½œæ˜¯åœ¨Engineä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°memoryCacheè¿˜è¢«æ”¾å…¥äº†Glideå®ä¾‹ä¸­ã€‚è¿™æ˜¯å› ä¸ºGlideå®ç°äº†<code>ComponentCallbacks2</code>æ¥å£ï¼Œåœ¨Glideåˆ›å»ºå®Œæˆåï¼Œå®ä¾‹å°±æ³¨å†Œäº†è¯¥æ¥å£ã€‚è¿™æ ·åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™ï¼Œå¯ä»¥é€šçŸ¥memoryCacheé‡Šæ”¾å†…å­˜ã€‚</p> <p><strong>Glide.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onTrimMemory</span><span class=p>(</span><span class=kt>int</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=p>(</span><span class=kt>int</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Engine asserts this anyway when removing resources, fail faster and consistently</span>
  <span class=n>Util</span><span class=p>.</span><span class=na>assertMainThread</span><span class=p>();</span>
  <span class=c1>// memory cache needs to be trimmed before bitmap pool to trim re-pooled Bitmaps too. See #687.</span>
  <span class=n>memoryCache</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
  <span class=n>bitmapPool</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
  <span class=n>arrayPool</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>memoryCacheæ˜¯ä¸€ä¸ªä½¿ç”¨LRU(least recently used)ç®—æ³•å®ç°çš„å†…å­˜ç¼“å­˜ç±»<code>LruResourceCache</code>ï¼Œç»§æ‰¿è‡³<code>LruCache</code>ç±»ï¼Œå®ç°äº†<code>MemoryCache</code>æ¥å£ã€‚<br> <code>LruCache</code>å®šä¹‰äº†LRUç›¸å…³çš„æ“ä½œï¼Œè€Œ<code>MemoryCache</code>å®šä¹‰çš„æ˜¯å†…å­˜ç¼“å­˜ç›¸å…³çš„æ“ä½œã€‚<code>LruResourceCache</code>å…¶ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruResourceCache</span> <span class=kd>extends</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span> <span class=n>Resource</span><span class=o>&lt;?&gt;&gt;</span> <span class=kd>implements</span> <span class=n>MemoryCache</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=nd>@Override</span>
  <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>item</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>item</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>item</span><span class=p>.</span><span class=na>getSize</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;InlinedApi&quot;</span><span class=p>)</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=p>(</span><span class=kt>int</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_BACKGROUND</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// Entering list of cached background apps</span>
      <span class=c1>// Evict our entire bitmap cache</span>
      <span class=n>clearMemory</span><span class=p>();</span>
    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_UI_HIDDEN</span>
        <span class=o>||</span> <span class=n>level</span> <span class=o>==</span> <span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_RUNNING_CRITICAL</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// The app&#39;s UI is no longer visible, or app is in the foreground but system is running</span>
      <span class=c1>// critically low on memory</span>
      <span class=c1>// Evict oldest half of our bitmap cache</span>
      <span class=n>trimToSize</span><span class=p>(</span><span class=n>getMaxSize</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>LruCache</code>çš„å®ç°ä¸»è¦é <code>LinkedHashMap</code>çš„ä¸€ä¸ªæ„é€ å‚æ•°ï¼š<code>accessOrder</code>ã€‚<br> å½“è¯¥å‚æ•°ä¸ºtrueæ—¶ï¼Œæ¯æ¬¡è°ƒç”¨<code>LinkedHashMap</code>çš„<code>get(key)</code>æˆ–<code>getOrDefault(key, defaultValue)</code>æ–¹æ³•éƒ½ä¼šè§¦å‘<code>afterNodeAccess(Object)</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šå°†å¯¹åº”çš„nodeç§»åŠ¨åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ä¹Ÿå°±æ˜¯è¯´<code>LinkedHashMap</code>æœ«å°¾çš„æ•°æ®æ˜¯æœ€è¿‘â€œæœ€å¤šâ€ä½¿ç”¨çš„ã€‚<br> è€Œ<code>LruCache</code>æ¸…é™¤å†…å­˜æ—¶éƒ½ä¼šè°ƒç”¨<code>trimToSize(size)</code>æ–¹æ³•æ—¶ï¼Œä¼šä»å¤´åˆ°å°¾è¿›è¡Œæ¸…ç†ï¼Œè¿™æ ·LRUçš„ç‰¹ç‚¹å°±ä½“ç°å‡ºæ¥äº†ã€‚ </p> <p>ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <p><strong>LruCache.java</strong> </p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruCache</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=n>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mf>0.75f</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
  <span class=p>...</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clearMemory</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>trimToSize</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>protected</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>trimToSize</span><span class=p>(</span><span class=kt>long</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=n>last</span><span class=p>;</span>
    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>cacheIterator</span><span class=p>;</span>
    <span class=k>while</span> <span class=p>(</span><span class=n>currentSize</span> <span class=o>&gt;</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
      <span class=c1>// ğŸ‘ğŸ‘ğŸ‘ æœç„¶æ˜¯ä»å¤´åˆ°å°¾è¿›è¡Œéå†çš„</span>
      <span class=n>cacheIterator</span>  <span class=o>=</span> <span class=n>cache</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span>
      <span class=n>last</span> <span class=o>=</span> <span class=n>cacheIterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
      <span class=kd>final</span> <span class=n>Y</span> <span class=n>toRemove</span> <span class=o>=</span> <span class=n>last</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
      <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>getSize</span><span class=p>(</span><span class=n>toRemove</span><span class=p>);</span>
      <span class=kd>final</span> <span class=n>T</span> <span class=n>key</span> <span class=o>=</span> <span class=n>last</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
      <span class=n>cacheIterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
      <span class=n>onItemEvicted</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>toRemove</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>evict</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>trimToSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><strong>LinkedHashMap.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span>
    <span class=kd>extends</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span>
    <span class=kd>implements</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span>
<span class=p>{</span>
    <span class=kd>public</span> <span class=nf>LinkedHashMap</span><span class=p>(</span><span class=kt>int</span> <span class=n>initialCapacity</span><span class=p>,</span>
                         <span class=kt>float</span> <span class=n>loadFactor</span><span class=p>,</span>
                         <span class=kt>boolean</span> <span class=n>accessOrder</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>super</span><span class=p>(</span><span class=n>initialCapacity</span><span class=p>,</span> <span class=n>loadFactor</span><span class=p>);</span>
        <span class=k>this</span><span class=p>.</span><span class=na>accessOrder</span> <span class=o>=</span> <span class=n>accessOrder</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kd>public</span> <span class=n>V</span> <span class=nf>get</span><span class=p>(</span><span class=n>Object</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>key</span><span class=p>))</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>accessOrder</span><span class=p>)</span>
            <span class=n>afterNodeAccess</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
        <span class=k>return</span> <span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=cm>/**</span>
<span class=cm>     * {@inheritDoc}</span>
<span class=cm>     */</span>
    <span class=kd>public</span> <span class=n>V</span> <span class=nf>getOrDefault</span><span class=p>(</span><span class=n>Object</span> <span class=n>key</span><span class=p>,</span> <span class=n>V</span> <span class=n>defaultValue</span><span class=p>)</span> <span class=p>{</span>
       <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=p>;</span>
       <span class=k>if</span> <span class=p>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>key</span><span class=p>))</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
           <span class=k>return</span> <span class=n>defaultValue</span><span class=p>;</span>
       <span class=k>if</span> <span class=p>(</span><span class=n>accessOrder</span><span class=p>)</span>
           <span class=n>afterNodeAccess</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
       <span class=k>return</span> <span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kt>void</span> <span class=nf>afterNodeAccess</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// move node to last</span>
        <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>last</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>accessOrder</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>last</span> <span class=o>=</span> <span class=n>tail</span><span class=p>)</span> <span class=o>!=</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>=</span>
                <span class=p>(</span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>e</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=na>before</span><span class=p>,</span> <span class=n>a</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=na>after</span><span class=p>;</span>
            <span class=n>p</span><span class=p>.</span><span class=na>after</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>b</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
                <span class=n>head</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span>
            <span class=k>else</span>
                <span class=n>b</span><span class=p>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span>
                <span class=n>a</span><span class=p>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
            <span class=k>else</span>
                <span class=n>last</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
            <span class=k>if</span> <span class=p>(</span><span class=n>last</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
                <span class=n>head</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
            <span class=k>else</span> <span class=p>{</span>
                <span class=n>p</span><span class=p>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>last</span><span class=p>;</span>
                <span class=n>last</span><span class=p>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
            <span class=p>}</span>
            <span class=n>tail</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
            <span class=o>++</span><span class=n>modCount</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <h2 id=3-diskcachefactory>3. diskCacheFactoryä»‹ç»<a class=headerlink href=#3-diskcachefactory title="Permanent link">&para;</a></h2> <p>diskCacheFactoryé¡¾åæ€ä¹‰å°±æ˜¯åˆ›å»ºDiskCacheçš„Factoryï¼Œè¯¥æ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š</p> <p><strong>DiskCache.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DiskCache</span> <span class=p>{</span>

  <span class=kd>interface</span> <span class=nc>Factory</span> <span class=p>{</span>
    <span class=cm>/** 250 MB of cache. */</span>
    <span class=kt>int</span> <span class=n>DEFAULT_DISK_CACHE_SIZE</span> <span class=o>=</span> <span class=mi>250</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>;</span>
    <span class=n>String</span> <span class=n>DEFAULT_DISK_CACHE_DIR</span> <span class=o>=</span> <span class=s>&quot;image_manager_disk_cache&quot;</span><span class=p>;</span>

    <span class=n>DiskCache</span> <span class=nf>build</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=kd>interface</span> <span class=nc>Writer</span> <span class=p>{</span>
    <span class=kt>boolean</span> <span class=nf>write</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>File</span> <span class=n>file</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>File</span> <span class=nf>get</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>);</span>

  <span class=kt>void</span> <span class=nf>put</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>Writer</span> <span class=n>writer</span><span class=p>);</span>

  <span class=kt>void</span> <span class=nf>delete</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>);</span>

  <span class=kt>void</span> <span class=nf>clear</span><span class=p>();</span>
<span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹å‡º<code>DiskCache.Factory</code>çš„<code>build()</code>æ–¹æ³•ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæˆ‘ä»¬éœ€è¦çš„<code>DiskCache</code>ã€‚<br> æ‰€ä»¥ï¼Œæˆ‘ä»¬è·Ÿç€Glideé»˜è®¤å®ç°çš„<code>InternalCacheDiskCacheFactory</code>ç±»çœ‹ä¸€ä¸‹åˆ›å»ºå‡ºäº†ä»€ä¹ˆæ ·çš„<code>DiskCache</code>ï¼š</p> <p><strong>InternalCacheDiskCacheFactory.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>InternalCacheDiskCacheFactory</span> <span class=kd>extends</span> <span class=n>DiskLruCacheFactory</span> <span class=p>{</span>

  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=p>,</span>
        <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_SIZE</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=p>,</span> <span class=n>diskCacheSize</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheName</span><span class=p>,</span>
                                       <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>(</span><span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=p>()</span> <span class=p>{</span>
      <span class=nd>@Override</span>
      <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=p>()</span> <span class=p>{</span>
        <span class=n>File</span> <span class=n>cacheDirectory</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getCacheDir</span><span class=p>();</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>cacheDirectory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheName</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>cacheDirectory</span><span class=p>,</span> <span class=n>diskCacheName</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>return</span> <span class=n>cacheDirectory</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>},</span> <span class=n>diskCacheSize</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æ˜¾ç„¶ï¼Œæ ¹æ®ä¸Šé¢æ¥å£ä¸­çš„å®šä¹‰ä»¥åŠæ­¤å¤„ç¬¬ä¸‰ä¸ªæ„é€ å™¨ä¸­çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªä½äº250Må¤§å°çš„è·¯å¾„ä¸º<code>/data/data/{package}/cache/image_manager_disk_cache/</code>çš„ç¼“å­˜ç›®å½•ã€‚</p> <p>ä¸‹é¢æ¥ç€<code>InternalCacheDiskCacheFactory</code>çš„çˆ¶ç±»<code>DiskLruCacheFactory</code>çš„ç›¸å…³ä»£ç ï¼š</p> <p><strong>DiskLruCacheFactory.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheFactory</span> <span class=kd>implements</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=p>;</span>

  <span class=cm>/**</span>
<span class=cm>   * Interface called out of UI thread to get the cache folder.</span>
<span class=cm>   */</span>
  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>CacheDirectoryGetter</span> <span class=p>{</span>
    <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=p>();</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=p>(</span><span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=p>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>diskCacheSize</span> <span class=o>=</span> <span class=n>diskCacheSize</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>cacheDirectoryGetter</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>build</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>File</span> <span class=n>cacheDir</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=p>.</span><span class=na>getCacheDirectory</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>cacheDir</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>mkdirs</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>exists</span><span class=p>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>isDirectory</span><span class=p>()))</span> <span class=p>{</span>
      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>DiskLruCacheWrapper</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>cacheDir</span><span class=p>,</span> <span class=n>diskCacheSize</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>DiskLruCacheFactory.build()</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª<code>DiskLruCacheWrapper</code>ç±»çš„å®ä¾‹ï¼Œä»å‘½åæ¥çœ‹ç£ç›˜ç¼“å­˜ä¹Ÿç¡®å®æ˜¯LRUç®—æ³•çš„ã€‚æˆ‘ä»¬çœ¼è§ä¸ºå®ï¼š</p> <p><strong>DiskLruCacheWrapper.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheWrapper</span> <span class=kd>implements</span> <span class=n>DiskCache</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&quot;DiskLruCacheWrapper&quot;</span><span class=p>;</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>APP_VERSION</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>VALUE_COUNT</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>static</span> <span class=n>DiskLruCacheWrapper</span> <span class=n>wrapper</span><span class=p>;</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SafeKeyGenerator</span> <span class=n>safeKeyGenerator</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>File</span> <span class=n>directory</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCacheWriteLocker</span> <span class=n>writeLocker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheWriteLocker</span><span class=p>();</span>
  <span class=kd>private</span> <span class=n>DiskLruCache</span> <span class=n>diskLruCache</span><span class=p>;</span>

  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
  <span class=kd>public</span> <span class=kd>static</span> <span class=n>DiskCache</span> <span class=nf>create</span><span class=p>(</span><span class=n>File</span> <span class=n>directory</span><span class=p>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>DiskLruCacheWrapper</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>maxSize</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=nd>@Deprecated</span>
  <span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>,</span> <span class=s>&quot;DeprecatedIsStillUsed&quot;</span><span class=p>})</span>
  <span class=kd>protected</span> <span class=nf>DiskLruCacheWrapper</span><span class=p>(</span><span class=n>File</span> <span class=n>directory</span><span class=p>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>directory</span> <span class=o>=</span> <span class=n>directory</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>safeKeyGenerator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SafeKeyGenerator</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>DiskLruCache</span> <span class=nf>getDiskCache</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>diskLruCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>diskLruCache</span> <span class=o>=</span> <span class=n>DiskLruCache</span><span class=p>.</span><span class=na>open</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>APP_VERSION</span><span class=p>,</span> <span class=n>VALUE_COUNT</span><span class=p>,</span> <span class=n>maxSize</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>diskLruCache</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=p>.</span><span class=na>getSafeKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
    <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>safeKey</span><span class=p>);</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=p>.</span><span class=na>getFile</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
      <span class=p>}</span>
    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
      <span class=p>...</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>
</code></pre></div> <p>é‡Œé¢æœç„¶wrapäº†ä¸€ä¸ª<code>DiskLruCache</code>ï¼Œè¯¥ç±»ä¸»è¦æ˜¯ä¸º<code>DiskLruCache</code>æä¾›äº†ä¸€ä¸ªæ ¹æ®<code>Key</code>ç”Ÿæˆkeyçš„<code>SafeKeyGenerator</code>ä»¥åŠå†™é”<code>DiskCacheWriteLocker</code>ã€‚ </p> <p>!!!! warning <strong>æ³¨æ„</strong>ï¼šGlideä¸­ä½¿ç”¨çš„LruCacheä¸<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#21-lrucache>Bitmapçš„ç¼“å­˜ä¸åŠ è½½</a>ä¸€æ–‡ä¸­æåˆ°çš„ä¸ä¸€æ ·ï¼›Glideä½¿ç”¨çš„DiskLruCacheè™½ç„¶ä¸æ–‡ç« ä¸­æåˆ°çš„DiskLruCacheæœ‰ä¸€å®šçš„æ¸Šæºï¼Œä½†ä¸ç­‰åŒã€‚</p> <p>OKï¼Œç°åœ¨DiskCacheçš„å®ç°éƒ½å‡†å¤‡å¥½äº†ï¼Œç°åœ¨çœ‹çœ‹ä¼šåœ¨å“ªé‡Œè°ƒç”¨factoryçš„<code>build()</code>æ–¹æ³•äº†ã€‚<br> åœ¨æœ¬æ–‡çš„å¼€å¤´ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†<code>diskCacheFactory</code>åªä¼šä¼ å…¥<code>Engine</code>ä¸­ã€‚åœ¨<code>Engine</code>çš„æ„é€ æ–¹æ³•ä¸­ä¼šè¢«åŒ…è£…æˆä¸ºä¸€ä¸ª<code>LazyDiskCacheProvider</code>ï¼Œåœ¨è¢«éœ€è¦çš„æ—¶å€™è°ƒç”¨<code>getDiskCache()</code>æ–¹æ³•ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨factoryçš„<code>build()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>DiskCache</code>äº†ã€‚</p> <p><strong>Engine.LazyDiskCacheProvider</strong></p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>LazyDiskCacheProvider</span> <span class=kd>implements</span> <span class=n>DecodeJob</span><span class=p>.</span><span class=na>DiskCacheProvider</span> <span class=p>{</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>DiskCache</span> <span class=n>diskCache</span><span class=p>;</span>

  <span class=n>LazyDiskCacheProvider</span><span class=p>(</span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>getDiskCache</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>diskCache</span> <span class=o>=</span> <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>diskCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheAdapter</span><span class=p>();</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>diskCache</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>è€Œ<code>LazyDiskCacheProvider</code>åˆä¼šåœ¨<code>Engine</code>åé¢çš„åˆå§‹åŒ–æµç¨‹ä¸­ä¼ å…¥<code>DecodeJobFactory</code>ã€‚åœ¨<code>DecodeJobFactory</code>åˆ›å»º<code>DecodeJob</code>æ—¶ä¼šä¼ è¿›å»ã€‚<br> <code>DecodeJob</code>è‡ªèº«ä¼šä¿å­˜èµ·æ¥ï¼Œåœ¨èµ„æºåŠ è½½å®Œæ¯•å¹¶å±•ç¤ºåï¼Œä¼šè¿›è¡Œç¼“å­˜çš„å­˜æ”¾ã€‚åŒæ—¶ï¼Œ<code>DecodeJob</code>ä¹Ÿä¼šåœ¨<code>DecodeHelper</code>åˆå§‹åŒ–æ—¶ï¼Œè®¾ç½®è¿›å»ï¼Œä¾›<code>ResourceCacheGenerator</code>ã€<code>DataCacheGenerator</code>è¯»å–ç¼“å­˜ï¼Œä¾›<code>SourceGenerator</code>å†™å…¥ç¼“å­˜ã€‚</p> <h2 id=4-activeresources>4. ActiveResources<a class=headerlink href=#4-activeresources title="Permanent link">&para;</a></h2> <p>åœ¨æ­£å¼å¼€å§‹è®¨è®ºç¼“å­˜æµç¨‹æ—¶ï¼Œè¿˜æ˜¯è¦å…ˆä»‹ç»ä¸€ä¸‹<code>ActiveResources</code>çš„ä¸€äº›æºç ã€‚<br> <code>ActiveResources</code>åœ¨<code>Engine</code>çš„æ„é€ å™¨ä¸­è¢«åˆ›å»ºã€‚<code>ActiveResources</code>æ„å»ºå®Œæˆåï¼Œä¼šå¯åŠ¨ä¸€ä¸ªåå°ä¼˜å…ˆçº§çº§åˆ«ï¼ˆ<code>THREAD_PRIORITY_BACKGROUND</code>ï¼‰çš„çº¿ç¨‹ï¼Œåœ¨è¯¥çº¿ç¨‹ä¸­ä¼šè°ƒç”¨<code>cleanReferenceQueue()</code>æ–¹æ³•ä¸€ç›´å¾ªç¯æ¸…é™¤ReferenceQueueä¸­çš„å°†è¦è¢«GCçš„Resourceã€‚</p> <p><strong>ActiveResources.java</strong> </p> <div class=highlight><pre><span></span><code><span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActiveResources</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=p>;</span>
  <span class=nd>@VisibleForTesting</span>
  <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span> <span class=n>ResourceWeakReference</span><span class=o>&gt;</span> <span class=n>activeEngineResources</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceReferenceQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReferenceQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span>

  <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>isShutdown</span><span class=p>;</span>

  <span class=n>ActiveResources</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>(</span>
        <span class=n>isActiveResourceRetentionAllowed</span><span class=p>,</span>
        <span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>Executors</span><span class=p>.</span><span class=na>newSingleThreadExecutor</span><span class=p>(</span>
            <span class=k>new</span> <span class=n>ThreadFactory</span><span class=p>()</span> <span class=p>{</span>
              <span class=nd>@Override</span>
              <span class=kd>public</span> <span class=n>Thread</span> <span class=nf>newThread</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
                <span class=k>return</span> <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span>
                    <span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
                      <span class=nd>@Override</span>
                      <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
                        <span class=n>Process</span><span class=p>.</span><span class=na>setThreadPriority</span><span class=p>(</span><span class=n>Process</span><span class=p>.</span><span class=na>THREAD_PRIORITY_BACKGROUND</span><span class=p>);</span>
                        <span class=n>r</span><span class=p>.</span><span class=na>run</span><span class=p>();</span>
                      <span class=p>}</span>
                    <span class=p>},</span>
                    <span class=s>&quot;glide-active-resources&quot;</span><span class=p>);</span>
              <span class=p>}</span>
            <span class=p>}));</span>
  <span class=p>}</span>

  <span class=nd>@VisibleForTesting</span>
  <span class=n>ActiveResources</span><span class=p>(</span>
      <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>,</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>isActiveResourceRetentionAllowed</span> <span class=o>=</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>monitorClearedResourcesExecutor</span> <span class=o>=</span> <span class=n>monitorClearedResourcesExecutor</span><span class=p>;</span>

    <span class=n>monitorClearedResourcesExecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span>
        <span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
          <span class=nd>@Override</span>
          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
            <span class=n>cleanReferenceQueue</span><span class=p>();</span>
          <span class=p>}</span>
        <span class=p>});</span>
  <span class=p>}</span>

  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span>
  <span class=nd>@Synthetic</span> <span class=kt>void</span> <span class=nf>cleanReferenceQueue</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isShutdown</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>try</span> <span class=p>{</span>
        <span class=n>ResourceWeakReference</span> <span class=n>ref</span> <span class=o>=</span> <span class=p>(</span><span class=n>ResourceWeakReference</span><span class=p>)</span> <span class=n>resourceReferenceQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
        <span class=n>cleanupActiveReference</span><span class=p>(</span><span class=n>ref</span><span class=p>);</span>

        <span class=c1>// This section for testing only.</span>
        <span class=n>DequeuedResourceCallback</span> <span class=n>current</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>current</span><span class=p>.</span><span class=na>onResourceDequeued</span><span class=p>();</span>
        <span class=p>}</span>
        <span class=c1>// End for testing only.</span>
      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>cleanupActiveReference</code>æ–¹æ³•é©¬ä¸Šä¼šè¯´ã€‚ç°åœ¨å…ˆæ¥çœ‹çœ‹<code>ActiveResources</code>çš„ä¿å­˜ã€åˆ é™¤çš„æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯<code>activate</code>ã€<code>deactivate</code>ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å®ç°éƒ½å¾ˆç®€å•ã€‚<code>activate</code>æ–¹æ³•ä¼šå°†å‚æ•°å°è£…æˆä¸ºä¸€ä¸ª<code>ResourceWeakReference</code>ï¼Œç„¶åæ”¾å…¥mapä¸­ï¼Œå¦‚æœå¯¹åº”çš„keyä¹‹å‰æœ‰å€¼ï¼Œé‚£ä¹ˆè°ƒç”¨ä¹‹å‰å€¼çš„<code>reset</code>æ–¹æ³•è¿›è¡Œæ¸…é™¤ã€‚<code>deactivate</code>æ–¹æ³•å…ˆåœ¨mapä¸­ç§»é™¤ï¼Œç„¶åè°ƒç”¨resourceçš„<code>reset</code>æ–¹æ³•è¿›è¡Œæ¸…é™¤ã€‚</p> <div class=highlight><pre><span></span><code><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>activate</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>ResourceWeakReference</span> <span class=n>toPut</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>ResourceWeakReference</span><span class=p>(</span>
          <span class=n>key</span><span class=p>,</span> <span class=n>resource</span><span class=p>,</span> <span class=n>resourceReferenceQueue</span><span class=p>,</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>);</span>

  <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>toPut</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>removed</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>deactivate</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>removed</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>ResourceWeakReference</code>ç»§æ‰¿è‡³<code>WeakReference</code>ï¼Œåªæ˜¯ä¿å­˜äº†Resourceçš„ä¸€äº›å±æ€§ï¼Œæ­¤å¤–æ·»åŠ äº†ä¸€ä¸ª<code>reset</code>æ–¹æ³•ç”¨æ¥æ¸…ç†èµ„æºï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@VisibleForTesting</span>
<span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ResourceWeakReference</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=p>{</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span> <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span> <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isCacheable</span><span class=p>;</span>

  <span class=nd>@Nullable</span> <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span> <span class=nd>@Synthetic</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>;</span>

  <span class=nd>@Synthetic</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span>
  <span class=n>ResourceWeakReference</span><span class=p>(</span>
      <span class=nd>@NonNull</span> <span class=n>Key</span> <span class=n>key</span><span class=p>,</span>
      <span class=nd>@NonNull</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>referent</span><span class=p>,</span>
      <span class=nd>@NonNull</span> <span class=n>ReferenceQueue</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>queue</span><span class=p>,</span>
      <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>super</span><span class=p>(</span><span class=n>referent</span><span class=p>,</span> <span class=n>queue</span><span class=p>);</span>
    <span class=k>this</span><span class=p>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
    <span class=k>this</span><span class=p>.</span><span class=na>resource</span> <span class=o>=</span>
        <span class=n>referent</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>isActiveResourceRetentionAllowed</span>
            <span class=o>?</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>referent</span><span class=p>.</span><span class=na>getResource</span><span class=p>())</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>isCacheable</span> <span class=o>=</span> <span class=n>referent</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=kt>void</span> <span class=nf>reset</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>clear</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>super(referent, queue)</code>ã€‚è¿™æ ·å¦‚æœreferentå°†è¦è¢«GCï¼Œå°±ä¼šè¢«æ”¾å…¥queueä¸­ã€‚è€Œ<code>ActiveResources.cleanReferenceQueue()</code>æ–¹æ³•ä¼šä¸€ç›´å°è¯•ä»queueä¸­è·å–å°†è¦è¢«GCçš„resourceï¼Œç„¶åè°ƒç”¨å…¶<code>cleanupActiveReference</code>æ–¹æ³•ã€‚<br> è¯¥æ–¹æ³•é™¤äº†åœ¨æ­¤æ—¶è¢«è°ƒç”¨å¤–ï¼Œè¿˜åœ¨<code>ActiveResources.get(key)</code>æ–¹æ³•ä¸­ä¹Ÿå¯èƒ½ä¼šå› ä¸ºè·å–åˆ°çš„resourceä¸ºnullè€Œè¢«è°ƒç”¨ã€‚<code>cleanupActiveReference</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span>
<span class=kt>void</span> <span class=nf>cleanupActiveReference</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ResourceWeakReference</span> <span class=n>ref</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// Fixes a deadlock where we normally acquire the Engine lock and then the ActiveResources lock</span>
  <span class=c1>// but reverse that order in this one particular test. This is definitely a bit of a hack...</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>listener</span><span class=p>)</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>activeEngineResources</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>);</span>
      <span class=c1>// å¦‚æœæ˜¯GCåè°ƒç”¨ï¼Œæ­¤æ—¶ref.resourceè‚¯å®šä¸ºnull</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ref</span><span class=p>.</span><span class=na>isCacheable</span> <span class=o>||</span> <span class=n>ref</span><span class=p>.</span><span class=na>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=c1>// èµ°åˆ°è¿™ï¼Œè¡¨ç¤ºæ˜¯åœ¨getæ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ä¼šæ¢å¤åŸæ¥çš„resource</span>
      <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>newResource</span> <span class=o>=</span>
          <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>resource</span><span class=p>,</span> <span class=cm>/*isCacheable=*/</span> <span class=kc>true</span><span class=p>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>false</span><span class=p>);</span>
      <span class=n>newResource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>,</span> <span class=n>listener</span><span class=p>);</span>
      <span class=c1>// å›è°ƒEngineçš„onResourceReleasedæ–¹æ³•</span>
      <span class=c1>// è¿™ä¼šå¯¼è‡´æ­¤èµ„æºä»activeå˜æˆmemory cacheçŠ¶æ€</span>
      <span class=n>listener</span><span class=p>.</span><span class=na>onResourceReleased</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>,</span> <span class=n>newResource</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <h2 id=5>5. ç¼“å­˜åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹<a class=headerlink href=#5 title="Permanent link">&para;</a></h2> <p>åœ¨äº†è§£å®Œä¸Šé¢ä¸‰ç§ç¼“å­˜çŠ¶æ€èµ„æºå¯¹åº”çš„ç±»åï¼Œæˆ‘ä»¬ç°åœ¨çœ‹ä¸€ä¸‹ç¼“å­˜åŠ è½½ã€å­˜æ”¾çš„è¿‡ç¨‹ã€‚ç”±äºç¼“å­˜ç­–ç•¥é»˜è®¤ä¸º<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œæ‰€ä»¥åŠ è½½æŸä¸€ç§æ ¼å¼çš„å›¾ç‰‡ä¸è¶³ä»¥è¦†ç›–æ‰€æœ‰çš„æƒ…å†µï¼Œä¸‹é¢ä¼šä»¥ç½‘ç»œå›¾ç‰‡URLä»¥åŠæœ¬åœ°å›¾ç‰‡Fileè¿™ä¸¤ç§å¸¸ç”¨çš„æ–¹å¼æ¥è®²è§£ç¼“å­˜çš„åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹ã€‚</p> <p>é¦–å…ˆï¼Œæ•´ä¸ªåŠ è½½çš„è¿‡ç¨‹ä½“ç°åœ¨<code>Engine.load</code>æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•æ³¨é‡Šå’Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm>  * Starts a load for the given arguments.</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;Must be called on the main thread.</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;The flow for any request is as follows:</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;ul&gt;</span>
<span class=cm>  *   &lt;li&gt;Check the current set of actively used resources, return the active resource if present,</span>
<span class=cm>  *       and move any newly inactive resources into the memory cache.</span>
<span class=cm>  *   &lt;li&gt;Check the memory cache and provide the cached resource if present.</span>
<span class=cm>  *   &lt;li&gt;Check the current set of in progress loads and add the cb to the in progress load if one</span>
<span class=cm>  *       is present.</span>
<span class=cm>  *   &lt;li&gt;Start a new load.</span>
<span class=cm>  * &lt;/ul&gt;</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;Active resources are those that have been provided to at least one request and have not yet</span>
<span class=cm>  * been released. Once all consumers of a resource have released that resource, the resource then</span>
<span class=cm>  * goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to</span>
<span class=cm>  * the active resources. If the resource is evicted from the cache, its resources are recycled and</span>
<span class=cm>  * re-used if possible and the resource is discarded. There is no strict requirement that</span>
<span class=cm>  * consumers release their resources so active resources are held weakly.</span>
<span class=cm>  *</span>
<span class=cm>  * @param width The target width in pixels of the desired resource.</span>
<span class=cm>  * @param height The target height in pixels of the desired resource.</span>
<span class=cm>  * @param cb The callback that will be called when the load completes.</span>
<span class=cm>  */</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>load</span><span class=p>(...)</span> <span class=p>{</span>
  <span class=n>EngineKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>keyFactory</span><span class=p>.</span><span class=na>buildKey</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>transformations</span><span class=p>,</span>
      <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>

  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>current</span> <span class=o>=</span> <span class=n>jobs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>current</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
    <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
      <span class=n>engineJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(...);</span>

  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
      <span class=n>decodeJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(...);</span>

  <span class=n>jobs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>

  <span class=n>engineJob</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
  <span class=n>engineJob</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>

  <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨å‰ä¸€ç¯‡æ–‡ç« è®²è§£æ•´ä½“æµç¨‹æ—¶è°ˆåˆ°è¿‡ï¼Œé“¾æ¥å¦‚ä¸‹<a href=/android/3rd-library/glide2/#33-engineload>Glide2-3.3-Engine.load</a>ã€‚<br> ä»æ³¨é‡Šå’Œä»£ç ä¸­æˆ‘ä»¬çŸ¥é“äº†ç¼“å­˜é¦–å…ˆä¼šåˆ¤æ–­activeçŠ¶æ€çš„resourceï¼Œç„¶åæ˜¯memory cacheï¼Œæœ€åå°±äº¤ç»™äº†jobã€‚é‚£ä¹ˆæ¯«æ— ç–‘é—®ï¼Œjobä¸­ä¼šè¿›è¡Œdisk cacheçš„è¯»æ“ä½œã€‚ </p> <p>åªè¦æ˜¯ç¼“å­˜ï¼Œå°±ç¦»ä¸å¼€Keyï¼Œæ‰€ä»¥å…ˆçœ‹çœ‹ä»active resourceå’Œmemory cacheä¸­å–ç¼“å­˜æ—¶çš„Keyâ€”â€”<code>EngineKey</code>çš„ç»„æˆæˆåˆ†ï¼š</p> <p><strong>EngineKey.java</strong></p> <figcaption>EngineKeyçš„ç»„æˆ</figcaption> <table> <thead> <tr> <th>ç»„æˆ</th> <th>æ³¨é‡Š</th> </tr> </thead> <tbody> <tr> <td>model</td> <td>loadçš„å‚æ•°</td> </tr> <tr> <td>signature</td> <td><code>BaseRequestOptions</code>çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯<code>EmptySignature.obtain()</code><br>åœ¨åŠ è½½æœ¬åœ°resourceèµ„æºæ—¶ä¼šå˜æˆ<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> <tr> <td>width<br>height</td> <td>å¦‚æœæ²¡æœ‰æŒ‡å®š<code>override(int size)</code>ï¼Œé‚£ä¹ˆå°†å¾—åˆ°viewçš„size</td> </tr> <tr> <td>transformations</td> <td>é»˜è®¤ä¼šåŸºäº<code>ImageView</code>çš„scaleTypeè®¾ç½®å¯¹åº”çš„å››ä¸ª<code>Transformation</code>ï¼›<br>å¦‚æœæŒ‡å®šäº†<code>transform</code>ï¼Œé‚£ä¹ˆå°±åŸºäºè¯¥å€¼è¿›è¡Œè®¾ç½®ï¼›<br>è¯¦è§<code>BaseRequestOptions.transform(Transformation, boolean)</code></td> </tr> <tr> <td>resourceClass</td> <td>è§£ç åçš„èµ„æºï¼Œå¦‚æœæ²¡æœ‰<code>asBitmap</code>ã€<code>asGif</code>ï¼Œä¸€èˆ¬ä¼šæ˜¯<code>Object</code></td> </tr> <tr> <td>transcodeClass</td> <td>æœ€ç»ˆè¦è½¬æ¢æˆçš„æ•°æ®ç±»å‹ï¼Œæ ¹æ®<code>as</code>æ–¹æ³•ç¡®å®šï¼ŒåŠ è½½æœ¬åœ°resæˆ–è€…ç½‘ç»œURLï¼Œéƒ½ä¼šè°ƒç”¨<code>asDrawable</code>ï¼Œæ‰€ä»¥ä¸º<code>Drawable</code></td> </tr> <tr> <td>options</td> <td>å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡<code>transform</code>ï¼Œæ­¤å¤„ä¼šæ ¹æ®ImageViewçš„scaleTypeé»˜è®¤æŒ‡å®šä¸€ä¸ªKVï¼Œè¯¦è§ä¸Šä¸€æ–‡2.2èŠ‚</td> </tr> </tbody> </table> <p>æ˜¾ç„¶ï¼Œåœ¨å¤šæ¬¡åŠ è½½åŒä¸€ä¸ªmodelçš„è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰ç¨è®¸æ”¹åŠ¨ï¼ˆæ¯”å¦‚Viewå®½é«˜ç­‰ï¼‰ï¼ŒGlideéƒ½ä¸ä¼šè®¤ä¸ºè¿™æ˜¯åŒä¸€ä¸ªKeyã€‚æ­¤å¤–ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ­¤Keyä»¥åŠå…¶ä»–çš„Keyè¦†ç›–<code>equals</code>ã€<code>hashCode()</code>ã€<code>toString()</code>æ–¹æ³•çš„å†™æ³•éå¸¸è§„èŒƒï¼Œè¯¦ç»†å¯è§<a href=/effective-java/chapter2/ >Effective-Java-ç¬¬8ã€9ã€10æ¡</a>ã€‚</p> <p>å›åˆ°<code>Engine.load</code>æ–¹æ³•ä¸­ï¼ŒactiveçŠ¶æ€çš„resourceå’Œmemory cacheçŠ¶æ€çš„èµ„æºå…¶å®éƒ½æ˜¯<code>DataSource.MEMORY_CACHE</code>çŠ¶æ€ï¼Œä»ç¼“å­˜åŠ è½½æˆåŠŸåçš„å›è°ƒä¸­å¯ä»¥çœ‹åˆ°ã€‚è€Œä¸”ï¼ŒåŠ è½½å‡ºæ¥çš„èµ„æºéƒ½æ˜¯<code>EngineResource</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ç®¡ç†ç­–ç•¥é‡‡ç”¨äº†<a href=/jvm/java-gc/#321>å¼•ç”¨è®¡æ•°ç®—æ³•</a>ã€‚è¯¥ç®—æ³•çš„ç‰¹ç‚¹æ˜¯å®ç°ç®€å•ï¼Œåˆ¤å®šæ•ˆç‡ä¹Ÿå¾ˆé«˜ã€‚</p> <p><code>EngineResource</code>ç±»çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>class</span> <span class=nc>EngineResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isCacheable</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isRecyclable</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>;</span>

  <span class=kd>private</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=p>;</span>
  <span class=kd>private</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kt>int</span> <span class=n>acquired</span><span class=p>;</span>
  <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>isRecycled</span><span class=p>;</span>

  <span class=kd>interface</span> <span class=nc>ResourceListener</span> <span class=p>{</span>
    <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setResourceListener</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>isRecycled</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Cannot acquire a recycled resource&quot;</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=o>++</span><span class=n>acquired</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;SynchronizeOnNonFinalField&quot;</span><span class=p>)</span>
  <span class=kt>void</span> <span class=nf>release</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>listener</span><span class=p>)</span> <span class=p>{</span>
      <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>acquired</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
          <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Cannot release a recycled or not yet acquired resource&quot;</span><span class=p>);</span>
        <span class=p>}</span>
        <span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>acquired</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>listener</span><span class=p>.</span><span class=na>onResourceReleased</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
        <span class=p>}</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨<code>release</code>åï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>listener.onResourceReleased(key, this)</code>æ–¹æ³•é€šçŸ¥å¤–ç•Œæ­¤èµ„æºå·²ç»é‡Šæ”¾äº†ã€‚å®é™…ä¸Šï¼Œæ‰€æœ‰çš„listeneréƒ½æ˜¯<code>Engine</code>å¯¹è±¡ï¼Œåœ¨<code>Engine.onResourceReleased</code>æ–¹æ³•ä¸­ä¼šå°†æ­¤èµ„æºæ”¾å…¥memory cacheä¸­ï¼Œå¦‚æœå¯ä»¥è¢«ç¼“å­˜çš„è¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>activeResources</span><span class=p>.</span><span class=na>deactivate</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>resourceRecycler</span><span class=p>.</span><span class=na>recycle</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>äº†è§£äº†<code>EngineResource</code>ä¹‹åï¼Œåœ¨å›åˆ°<code>Engine.load</code>æ–¹æ³•ä¸­å¼€å§‹åˆ†æã€‚é¦–å…ˆæ˜¯ä»active resourceå’Œmemory cacheä¸­è¿›è¡ŒåŠ è½½çš„æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><span class=nd>@Nullable</span>
<span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// âš ï¸</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeResources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>active</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=k>return</span> <span class=n>active</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// âš ï¸</span>
    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>getEngineResourceFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cached</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
    <span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>cached</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>cached</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œä¼šé¦–å…ˆåˆ¤æ–­<code>skipMemoryCache(true)</code>æ˜¯å¦è¿›è¡Œè¿‡è®¾ç½®ã€‚å¦‚æœè®¾ç½®è¿‡ï¼Œé‚£ä¹ˆä¸Šé¢çš„<code>isMemoryCacheable</code>å¯¹åº”å°±ä¼šä¸ºfalseï¼Œè¿›è€Œè¿™ä¸¤ä¸ªæ–¹æ³•ç›´æ¥ä¼šè¿”å›nullã€‚å¦åˆ™ï¼Œä¼šä»ç¼“å­˜ä¸­å°è¯•è¿›è¡ŒåŠ è½½ã€‚<br> åªè¦å‘½ä¸­äº†ç¼“å­˜ï¼Œé‚£ä¹ˆè¯¥èµ„æºçš„å¼•ç”¨è®¡æ•°å°±ä¼šåŠ ä¸€ã€‚è€Œä¸”ï¼Œå¦‚æœå‘½ä¸­çš„æ˜¯memory cacheï¼Œé‚£ä¹ˆæ­¤èµ„æºä¼šè¢«æé«˜åˆ°activeçŠ¶æ€ä¸­ã€‚<br> æ˜¾ç„¶ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™æ˜¯æ²¡æœ‰ä»»ä½•å†…å­˜ç¼“å­˜çš„ï¼Œç°åœ¨æ¥åˆ°äº†<code>DecodeJob</code>å’Œ<code>EngineJob</code>è¿™é‡Œã€‚è¿˜æ˜¯åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æåˆ°è¿‡ï¼Œ<code>DecoceJob</code>å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œç„¶åä¼šè¢«<code>EngineJob.start</code>æ–¹æ³•æäº¤åˆ°å¯¹åº”çš„çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚ </p> <p>æ‰€ä»¥ï¼Œç›´æ¥çœ‹<code>DecodeJob.run</code>æ–¹æ³•å’¯ï¼Œè¯¥æ–¹æ³•çœŸæ­£å®ç°æ˜¯<code>runWrapped</code>æ–¹æ³•ã€‚åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œç”±äº<code>runReason</code>æ­¤æ—¶åˆå§‹åŒ–äº†ä¸ºäº†<code>RunReason.INITIALIZE</code>ï¼ŒåˆdiskCacheStrategyä¸ºé»˜è®¤ä¸º<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œä¸”æ²¡æœ‰è®¾ç½®è¿‡<code>onlyRetrieveFromCache(true)</code>ã€‚æ‰€ä»¥ï¼Œdecode dataçš„çŠ¶æ€ä¾æ¬¡ä¸º<code>INITIALIZE</code> -&gt; <code>RESOURCE_CACHE</code> -&gt; <code>DATA_CACHE</code> -&gt; <code>SOURCE</code> -&gt; <code>FINISHED</code>ã€‚å¯¹åº”çš„<code>DataFectcherGenerator</code>çš„listä¾æ¬¡ä¸º<code>ResourceCacheGenerator</code> -&gt; <code>DataCacheGenerator</code> -&gt; <code>SourceGenerator</code>ã€‚</p> <p><strong>DecodeJob.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>private</span> <span class=n>Stage</span> <span class=nf>getNextStage</span><span class=p>(</span><span class=n>Stage</span> <span class=n>current</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedResource</span><span class=p>()</span>
          <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedData</span><span class=p>()</span>
          <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=p>:</span>
      <span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
      <span class=k>return</span> <span class=n>onlyRetrieveFromCache</span> <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=p>:</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>;</span>
    <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
    <span class=k>case</span> <span class=n>FINISHED</span><span class=p>:</span>
      <span class=k>return</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=p>;</span>
    <span class=k>default</span><span class=p>:</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=n>DataFetcherGenerator</span> <span class=nf>getNextGenerator</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>switch</span> <span class=p>(</span><span class=n>stage</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
      <span class=k>return</span> <span class=k>new</span> <span class=n>ResourceCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=p>:</span>
      <span class=k>return</span> <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
      <span class=k>return</span> <span class=k>new</span> <span class=n>SourceGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
    <span class=k>case</span> <span class=n>FINISHED</span><span class=p>:</span>
      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
    <span class=k>default</span><span class=p>:</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span> <span class=o>+</span> <span class=n>stage</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=p>()</span> <span class=p>{</span>
  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span> <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>reschedule</span><span class=p>();</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
  <span class=k>if</span> <span class=p>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>notifyFailed</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
  <span class=c1>// onDataFetcherReady.</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨å‰æ–‡ä¸­æˆ‘ä»¬çœ‹åˆ°è¿‡<code>ResourceCacheGenerator</code>å’Œ<code>DataCacheGenerator</code>çš„æºç ï¼ŒçŸ¥é“äº†å‰è€…è´Ÿè´£åœ¨cacheä¸­æŸ¥æ‰¾resourceèµ„æºï¼Œè€Œåè€…è´Ÿè´£dataèµ„æºã€‚<br> å½“åœ¨ä¸¤ä¸ªcache generatorä¸­éƒ½æ‰¾ä¸åˆ°æ—¶ï¼Œä¼šäº¤ç»™<code>SourceGenerator</code>ä»sourceä¸­è¿›è¡ŒåŠ è½½ã€‚æ­¤æ—¶ï¼Œå¯¹äºä¸€ä¸ªç½‘ç»œå›¾ç‰‡èµ„æºæ¥è¯´ï¼Œå°±æ˜¯åŠ è½½ç½‘ç»œå›¾ç‰‡ï¼›å¯¹äºæœ¬åœ°èµ„æºæ¥è¯´ï¼Œå°±æ˜¯åŠ è½½æœ¬åœ°èµ„æºã€‚</p> <p>é‚£ä¹ˆï¼Œresourceèµ„æºå’Œdataèµ„æºéƒ½æ˜¯ç£ç›˜ç¼“å­˜ä¸­çš„èµ„æºï¼Œå…¶åŒºåˆ«åœ¨å¼€å¤´çš„é‚£æ®µå®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¯´åˆ°ï¼Œåœ¨ä¸‹é¢çš„åˆ†æä¸­æˆ‘ä»¬ä¼šçœ‹åˆ°çš„ã€‚</p> <p>å…ˆçœ‹çœ‹<code>ResourceCacheGenerator</code>ä¸­æŸ¥æ‰¾ç¼“å­˜æ—¶keyçš„ç»„æˆéƒ¨åˆ†ï¼š</p> <p><strong>ResourceCacheGenerator.java</strong> </p> <div class=highlight><pre><span></span><code><span class=n>currentKey</span> <span class=o>=</span>
    <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span>
        <span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
        <span class=n>sourceId</span><span class=p>,</span>
        <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
        <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
        <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
        <span class=n>transformation</span><span class=p>,</span>
        <span class=n>resourceClass</span><span class=p>,</span>
        <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</code></pre></div> <figcaption>ResourceCacheGeneratorä¸­keyçš„ç»„æˆ</figcaption> <table> <thead> <tr> <th>ç»„æˆ</th> <th>æ³¨é‡Š</th> </tr> </thead> <tbody> <tr> <td>helper.getArrayPool()</td> <td><code>GlideBuilder.build</code>æ—¶åˆå§‹åŒ–ï¼Œé»˜è®¤ä¸º<code>LruArrayPool</code>ï¼›<em>ä½†ä¸å‚ä¸keyçš„<code>equals</code>æ–¹æ³•</em></td> </tr> <tr> <td>sourceId</td> <td>å¦‚æœè¯·æ±‚çš„æ˜¯URLï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ä¸€ä¸ª<code>GlideUrl</code></td> </tr> <tr> <td>helper.getSignature()</td> <td><code>BaseRequestOptions</code>çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯<code>EmptySignature.obtain()</code><br>åœ¨åŠ è½½æœ¬åœ°resourceèµ„æºæ—¶ä¼šå˜æˆ<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> <tr> <td>helper.getWidth()<br>helper.getHeight()</td> <td>å¦‚æœæ²¡æœ‰æŒ‡å®š<code>override(int size)</code>ï¼Œé‚£ä¹ˆå°†å¾—åˆ°viewçš„size</td> </tr> <tr> <td>transformation</td> <td>é»˜è®¤ä¼šæ ¹æ®<code>ImageView</code>çš„scaleTypeè®¾ç½®å¯¹åº”çš„<code>BitmapTransformation</code>ï¼›<br>å¦‚æœæŒ‡å®šäº†<code>transform</code>ï¼Œé‚£ä¹ˆå°±ä¼šæ˜¯æŒ‡å®šçš„å€¼</td> </tr> <tr> <td>resourceClass</td> <td>å¯ä»¥è¢«ç¼–ç æˆçš„èµ„æºç±»å‹ï¼Œæ¯”å¦‚<code>BitmapDrawable</code>ç­‰</td> </tr> <tr> <td>helper.getOptions()</td> <td>å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡<code>transform</code>ï¼Œæ­¤å¤„ä¼šæ ¹æ®ImageViewçš„scaleTypeé»˜è®¤æŒ‡å®šä¸€ä¸ªKVï¼Œè¯¦è§ä¸Šä¸€æ–‡2.2èŠ‚</td> </tr> </tbody> </table> <p>åœ¨<code>ResourceCacheKey</code>ä¸­ï¼Œ<code>arrayPool</code>å¹¶æ²¡æœ‰å‚ä¸<code>equals</code>æ–¹æ³•ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸¤ä¸ª<code>ResourceCacheKey</code>æ˜¯å¦ç›¸ç­‰åªéœ€è¦å…¶ä»–7ä¸ªå‚æ•°ã€‚</p> <p>ç„¶åçœ‹çœ‹<code>DataCacheGenerator</code>ä¸­Keyçš„ç»„æˆéƒ¨åˆ†ï¼š</p> <p><strong>DataCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=n>Key</span> <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>sourceId</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
</code></pre></div> <figcaption>DataCacheGeneratorä¸­keyçš„ç»„æˆ</figcaption> <table> <thead> <tr> <th>ç»„æˆ</th> <th>æ³¨é‡Š</th> </tr> </thead> <tbody> <tr> <td>sourceId</td> <td>å¦‚æœè¯·æ±‚çš„æ˜¯URLï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ä¸€ä¸ª<code>GlideUrl</code></td> </tr> <tr> <td>helper.getSignature()</td> <td><code>BaseRequestOptions</code>çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯<code>EmptySignature.obtain()</code><br>åœ¨åŠ è½½æœ¬åœ°resourceèµ„æºæ—¶ä¼šå˜æˆ<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> </tbody> </table> <p>åœ¨<code>DataCacheKey</code>ä¸­ï¼Œä»…æœ‰çš„ä¸¤ä¸ªå˜é‡éƒ½å‚ä¸äº†<code>equals</code>æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªå˜é‡å°±æ˜¯ä¸Šé¢<code>ResourceCacheKey</code>ä¸­çš„ä¸¤ä¸ªå˜é‡ã€‚ </p> <p>æ˜¾ç„¶ï¼Œdata cacheå°±æ˜¯æ¯”è¾ƒåŸå§‹çš„æ•°æ®æ„æˆçš„ç¼“å­˜ï¼Œè€Œresource cacheæ˜¯è¢«è§£ç ã€è½¬æ¢åçš„data cacheï¼Œè¿™å°±å°è¯äº†æ–‡ç« å¼€å¤´çš„é‚£æ®µæ–‡æ¡£ã€‚ </p> <p>æ­¤å¤–ï¼Œæ–‡æ¡£ä¸­ç¼“å­˜ç¯‡è¿˜æœ‰å¾ˆå¤šå†…å®¹ï¼Œä¸‹é¢åœ¨ä¸Šä¸€ä»½å…³äºç¼“å­˜Keyçš„æè¿°ï¼Œè¿™å¯¹åº”æˆ‘ä»¬åœ¨ä¸Šé¢åˆ—è¿‡è¡¨æ ¼çš„<code>EngineKey</code>ã€<code>ResourceCacheKey</code>ä»¥åŠ<code>DataCacheKey</code>ã€‚</p> <blockquote> <p>In Glide 4, all cache keys contain at least two elements:<br> 1. The model the load is requested for (File, Uri, Url). If you are using a custom model, it needs to correctly implements hashCode() and equals() 2. An optional Signature </p> <p>In fact, the cache keys for steps 1-3 (Active resources, memory cache, resource disk cache) also include a number of other pieces of data including: 1. The width and height 2. The optional Transformation 3. Any added Options 4. The requested data type (Bitmap, GIF, etc)</p> <p>The keys used for active resources and the memory cache also differ slightly from those used from the resource disk cache to accomodate in memory Options like those that affect the configuration of the Bitmap or other decode time only parameters.<br> To generate the name of disk cache keys on disk, the individual elements of the keys are hashed to create a single String key, which is then used as the file name in the disk cache.<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#cache-keys>Cache Keys</a></cite> </p> </blockquote> <p>çœ‹å®Œäº†ï¼Œå›åˆ°<code>ResourceCacheGenerator</code>ä¸­ï¼Œè¿™é‡Œä¼šç”¨<code>ResourceCacheKey</code>åœ¨ç£ç›˜ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚éš¾é“æˆ‘ä»¬ç”¨<code>ResourceCacheKey</code>çš„<code>toString()</code>æ–¹æ³•ä½œä¸ºkeyå—ï¼Ÿè‚¯å®šä¸æ˜¯ï¼Œå› ä¸ºè¿™æ ·ä¸å¤ŸSafeï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹çœ‹æºç ä¸­çš„SafeKeyæ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚ä»£ç åœ¨<code>DiskLruCacheWrapper</code>ä¸­ï¼Œå°†åŸå§‹çš„Keyè½¬æ¢ä¸ºSafeKeyæ˜¯è¿™ä¸ªwrapperç±»çš„é‡è¦ä½œç”¨ä¹‹ä¸€ã€‚</p> <p><strong>DiskLruCacheWrapper.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=p>.</span><span class=na>getSafeKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
  <span class=p>...</span>
  <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=c1>// It is possible that the there will be a put in between these two gets. If so that shouldn&#39;t</span>
    <span class=c1>// be a problem because we will always put the same value at the same key so our input streams</span>
    <span class=c1>// will still represent the same data.</span>
    <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>safeKey</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=p>.</span><span class=na>getFile</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œè°ƒç”¨<code>SafeKeyGenerator</code>ç”Ÿæˆäº†ä¸€ä¸ªStringç±»å‹çš„SafeKeyï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹åŸå§‹keyä¸­æ¯ä¸ªå­—æ®µéƒ½ä½¿ç”¨SHA-256åŠ å¯†ï¼Œç„¶åå°†å¾—åˆ°çš„å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º16è¿›åˆ¶çš„å­—ç¬¦ä¸²ã€‚<code>SafeKeyGenerator</code>çš„ä»£ç å¾ˆç®€å•ï¼Œä¸ºäº†æ•ˆç‡è¿˜æ˜¯ä½¿ç”¨äº†ç¼“å­˜ä»¥åŠå¯¹è±¡æ± ğŸ‘ğŸ‘ğŸ‘ã€‚</p> <p><strong>SafeKeyGenerator.java</strong> </p> <div class=highlight><pre><span></span><code><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SafeKeyGenerator</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>loadIdToSafeHash</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruCache</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pools</span><span class=p>.</span><span class=na>Pool</span><span class=o>&lt;</span><span class=n>PoolableDigestContainer</span><span class=o>&gt;</span> <span class=n>digestPool</span> <span class=o>=</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>threadSafe</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span>
      <span class=k>new</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>Factory</span><span class=o>&lt;</span><span class=n>PoolableDigestContainer</span><span class=o>&gt;</span><span class=p>()</span> <span class=p>{</span>
        <span class=nd>@Override</span>
        <span class=kd>public</span> <span class=n>PoolableDigestContainer</span> <span class=nf>create</span><span class=p>()</span> <span class=p>{</span>
          <span class=k>try</span> <span class=p>{</span>
            <span class=k>return</span> <span class=k>new</span> <span class=n>PoolableDigestContainer</span><span class=p>(</span><span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&quot;SHA-256&quot;</span><span class=p>));</span>
          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchAlgorithmException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
          <span class=p>}</span>
        <span class=p>}</span>
      <span class=p>});</span>

  <span class=kd>public</span> <span class=n>String</span> <span class=nf>getSafeKey</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>String</span> <span class=n>safeKey</span><span class=p>;</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>loadIdToSafeHash</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>safeKey</span> <span class=o>=</span> <span class=n>loadIdToSafeHash</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>safeKey</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>safeKey</span> <span class=o>=</span> <span class=n>calculateHexStringDigest</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>loadIdToSafeHash</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>loadIdToSafeHash</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>safeKey</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=n>safeKey</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=n>String</span> <span class=nf>calculateHexStringDigest</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>PoolableDigestContainer</span> <span class=n>container</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>digestPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>key</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>container</span><span class=p>.</span><span class=na>messageDigest</span><span class=p>);</span>
      <span class=c1>// calling digest() will automatically reset()</span>
      <span class=k>return</span> <span class=n>Util</span><span class=p>.</span><span class=na>sha256BytesToHex</span><span class=p>(</span><span class=n>container</span><span class=p>.</span><span class=na>messageDigest</span><span class=p>.</span><span class=na>digest</span><span class=p>());</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=n>digestPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>container</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>PoolableDigestContainer</span> <span class=kd>implements</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>Poolable</span> <span class=p>{</span>

    <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=p>;</span>
    <span class=kd>private</span> <span class=kd>final</span> <span class=n>StateVerifier</span> <span class=n>stateVerifier</span> <span class=o>=</span> <span class=n>StateVerifier</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span>

    <span class=n>PoolableDigestContainer</span><span class=p>(</span><span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>this</span><span class=p>.</span><span class=na>messageDigest</span> <span class=o>=</span> <span class=n>messageDigest</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=nd>@NonNull</span>
    <span class=nd>@Override</span>
    <span class=kd>public</span> <span class=n>StateVerifier</span> <span class=nf>getVerifier</span><span class=p>()</span> <span class=p>{</span>
      <span class=k>return</span> <span class=n>stateVerifier</span><span class=p>;</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ç±»çš„ä¸»è¦åŠŸèƒ½è½åœ¨äº†<code>calculateHexStringDigest</code>æ–¹æ³•ä¸Šï¼Œé¦–å…ˆä»å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦å®¹å™¨<code>PoolableDigestContainer</code>ï¼Œç„¶åè°ƒç”¨<code>Key.updateDiskCacheKey(MessageDigest)</code>ç”Ÿæˆæ¶ˆæ¯æ‘˜è¦ï¼Œæœ€åè°ƒç”¨<code>Util.sha256BytesToHex</code>å°†å°†å¾—åˆ°çš„å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º16è¿›åˆ¶çš„å­—ç¬¦ä¸²ã€‚ </p> <p>è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>ResourceCacheKey</code>çš„æ¶ˆæ¯æ‘˜è¦ç”Ÿæˆè¿‡ç¨‹ï¼Œå…¶ä¸­å…·ä½“å†…å®¹ä¸å±•å¼€äº†ï¼š</p> <p><strong>ResourceCacheKey.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=p>)</span> <span class=p>{</span>
    <span class=kt>byte</span><span class=o>[]</span> <span class=n>dimensions</span> <span class=o>=</span> <span class=n>arrayPool</span><span class=p>.</span><span class=na>getExact</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
    <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>dimensions</span><span class=p>).</span><span class=na>putInt</span><span class=p>(</span><span class=n>width</span><span class=p>).</span><span class=na>putInt</span><span class=p>(</span><span class=n>height</span><span class=p>).</span><span class=na>array</span><span class=p>();</span>
    <span class=n>signature</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
    <span class=n>sourceKey</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
    <span class=n>messageDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>dimensions</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>transformation</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>transformation</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>options</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
    <span class=n>messageDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>getResourceClassBytes</span><span class=p>());</span>
    <span class=n>arrayPool</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>dimensions</span><span class=p>);</span>
  <span class=p>}</span>
</code></pre></div> <p>å›æƒ³ä¸€ä¸‹è¡¨æ ¼------<em>ResourceCacheGeneratorä¸­keyçš„ç»„æˆ</em>ï¼Œè¡¨æ ¼ä¸­çš„å‚ä¸<code>equals</code>è¿ç®—çš„7ä¸ªéƒ¨åˆ†éƒ½å‚ä¸äº†æ¶ˆæ¯æ‘˜è¦çš„ç”Ÿæˆã€‚</p> <p>åœ¨è¿›ä¸€æ­¥å¤„ç†åï¼Œå¾—åˆ°äº†ä»¥æ¶ˆæ¯æ‘˜è¦çš„å­—ç¬¦ä¸²ä½œä¸ºkeyçš„SafeKeyï¼Œå¹¶ä»¥æ­¤åœ¨Disk Cacheä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœä»¥<code>Value</code>å®ä½“è¿”å›å‡ºæ¥ï¼Œæœ€åä»<code>Value</code>ä¸­è·å–å¯¹åº”æ–‡ä»¶ï¼ŒDisk Cacheçš„getæ“ä½œå°±æ˜¯è¿™ä¹ˆä¸€ä¸ªæµç¨‹ã€‚</p> <p>å›åˆ°<code>ResourceCacheGenerator</code>ä¸­ï¼Œå¦‚æœç¡®å®æœ‰ç¼“å­˜ï¼Œé‚£ä¹ˆä¼šåŠ è½½è¯¥ç¼“å­˜æ–‡ä»¶ã€‚åœ¨å‰æ–‡çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹äºURLæ¥è¯´ï¼Œè°ƒç”¨äº†<code>ByteBufferFetcher</code>è¿›è¡Œç¼“å­˜æ–‡ä»¶çš„åŠ è½½ï¼ŒåŠ è½½æˆåŠŸäº†è¿”å›äº†ä¸€ä¸ª<code>ByteBuffer</code>ï¼Œå¹¶è°ƒç”¨äº†callbackä¹Ÿå°±æ˜¯<code>ResourceCacheGenerator</code>çš„<code>onDataReady</code>æ–¹æ³•ã€‚ç„¶å<code>ResourceCacheGenerator</code>åˆä¼šå›è°ƒ<code>DecodeJob</code>çš„<code>onDataFetcherReady</code>æ–¹æ³•è¿›è¡Œåç»­çš„è§£ç æ“ä½œã€‚</p> <p><strong>ResourceCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>,</span>
      <span class=n>currentKey</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œå› ä¸ºåé¢<code>DataCacheGenerator</code>å’Œ<code>SourceGenerator</code>çš„æˆåŠŸå›è°ƒéƒ½ä¼šåˆ°è¿™é‡Œæ¥ã€‚æˆ‘ä»¬æš‚æ—¶åªéœ€è¦çœ‹ä¸€ä¸‹ä¸Šé¢å›è°ƒæ–¹æ³•çš„ä¸€äº›å‚æ•°å³å¯ã€‚</p> <p>å¦‚æœ<code>ResourceCacheGenerator</code>æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ï¼Œé‚£ä¹ˆå°±ä¼šäº¤ç»™<code>DataCacheGenerator</code>äº†ã€‚è¯¥ç±»å¤§ä½“æµç¨‹å’Œ<code>ResourceCacheGenerator</code>ä¸€æ ·ï¼Œæœ‰ç‚¹ä¸åŒçš„æ˜¯ï¼Œ<code>DataCacheGenerator</code>çš„æ„é€ å™¨æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œå…¶ä¸­çš„<code>DataCacheGenerator(List&lt;Key&gt;, DecodeHelper&lt;?&gt;, FetcherReadyCallback)</code>æ„é€ å™¨æ˜¯ç»™<code>SourceGenerator</code>å‡†å¤‡çš„ã€‚å› ä¸ºå¦‚æœæ²¡æœ‰ç£ç›˜ç¼“å­˜ï¼Œé‚£ä¹ˆä»æºå¤´åŠ è½½åï¼Œè‚¯å®šéœ€è¦è¿›è¡Œç£ç›˜ç¼“å­˜æ“ä½œçš„ã€‚æ‰€ä»¥ï¼Œ<code>SourceGenerator</code>ä¼šå°†åŠ è½½åçš„èµ„æºä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œç„¶åè½¬äº¤ç»™<code>DataCacheGenerator</code>ä»ç£ç›˜ä¸­å–å‡ºæ¥ã€‚ </p> <p><strong>DataCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>DATA_DISK_CACHE</span><span class=p>,</span> <span class=n>sourceKey</span><span class=p>);</span>
</code></pre></div> <p>å¦‚æœ<code>DataCacheGenerator</code>æ²¡æœ‰å–åˆ°ç¼“å­˜ï¼Œé‚£ä¹ˆä¼šäº¤ç»™<code>SourceGenerator</code>ä»æºå¤´åŠ è½½ã€‚åŠ è½½çš„è¿‡ç¨‹åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿè¯´åˆ°è¿‡ï¼Œæˆ‘ä»¬ç›´æ¥ç•¥è¿‡ã€‚ç°åœ¨æ¥åˆ°äº†æˆåŠŸå›è°ƒ<code>onDataReady()</code>æ–¹æ³•ï¼š</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
    <span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
        <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>originalKey</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œé¦–å…ˆçœ‹ä¼šè·å–åˆ°çš„æ•°æ®æ˜¯å¦éœ€è¦è¿›è¡Œç£ç›˜ç¼“å­˜ï¼šå¦‚æœéœ€è¦ç£ç›˜ç¼“å­˜ï¼Œåˆ™ç»è¿‡<code>DecodeJob</code>ã€<code>EngineJob</code>çš„è°ƒåº¦ï¼Œé‡æ–°è°ƒç”¨<code>SourceGenerator.startNext</code>æ–¹æ³•ï¼Œè¿›è¡Œç£ç›˜ç¼“å­˜çš„å†™å…¥ï¼Œå¹¶è½¬äº¤ç»™<code>DataCacheGenerator</code>å®Œæˆåç»­çš„å¤„ç†ï¼›å¦åˆ™å°±é€šçŸ¥<code>DecodeJob</code>å·²ç»åŠ è½½æˆåŠŸäº†ã€‚ä¸¤ä¸ªè·¯å¾„è¿”å›ç»™<code>DecodeJob</code>çš„å›è°ƒä¸­ï¼ŒdataSourceéƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œéƒ½æ˜¯æºå¤´çš„dataSourceã€‚</p> <p>ä¸¤ç§ä¸åŒè·¯å¾„çš„å›è°ƒå¦‚ä¸‹ï¼š</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=c1>// ä¸éœ€è¦ç£ç›˜ç¼“å­˜çš„è·¯å¾„</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
    <span class=p>...</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
        <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>originalKey</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=c1>// éœ€è¦ç£ç›˜ç¼“å­˜çš„è·¯å¾„</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherReady</span><span class=p>(</span><span class=n>Key</span> <span class=n>sourceKey</span><span class=p>,</span> <span class=n>Object</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span>
    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>Key</span> <span class=n>attemptedKey</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// This data fetcher will be loading from a File and provide the wrong data source, so override</span>
  <span class=c1>// with the data source of the original fetcher</span>
  <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>fetcher</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>sourceKey</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>ç£ç›˜ç¼“å­˜ç­–ç•¥é»˜è®¤æ˜¯<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œå…¶dataèµ„æºç¼“å­˜ç­–ç•¥åªç¼“å­˜è¿œç¨‹èµ„æºï¼Œä¹Ÿå°±æ˜¯URLè¿™ç§ï¼š</p> <p><strong>DiskCacheStrategy.AUTOMATIC</strong> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDataCacheable</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>return</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div></p> <p>åœ¨åŠ è½½çš„å°±æ˜¯URLçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç£ç›˜ç¼“å­˜å†™å…¥è¿‡ç¨‹çš„æµç¨‹ã€‚<br> é¦–å…ˆç»è¿‡<code>DecodeJob.reschedule()</code>è¿›è¡Œçº¿ç¨‹çš„è°ƒæ•´åï¼Œåˆå¼€å§‹äº†<code>startNext()</code>æ–¹æ³•ã€‚ç”±äºdataToCacheä¿å­˜äº†è·å–çš„åŸå§‹æ•°æ®ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>cacheData</code>æ–¹æ³•è¿›è¡Œç¼“å­˜ã€‚<code>cacheData</code>æ–¹æ³•å…ˆæ„å»ºäº†ä¸€ä¸ª<code>DataCacheKey</code>å°†dataå†™å…¥äº†ç£ç›˜ï¼Œç„¶ånewäº†ä¸€ä¸ª<code>DataCacheGenerator</code>ã€‚å›åˆ°<code>startNext()</code>æ–¹æ³•ï¼Œæ­¤æ—¶sourceCacheGeneratorä¸ä¸ºç©ºï¼Œå°±è°ƒç”¨å…¶<code>startNext()</code>æ–¹æ³•ä»çƒ­ä¹çš„ç£ç›˜ç¼“å­˜ä¸­è¿›è¡ŒåŠ è½½ï¼Œå¹¶è¿”å›äº†trueè®©<code>DecodeJob</code>åœæ­¢å°è¯•ã€‚</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span> <span class=p>{</span>
    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
    <span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
    <span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=p>...</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
  <span class=p>}</span>

  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span> <span class=p>{</span>
    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=p>...</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kt>void</span> <span class=nf>cacheData</span><span class=p>(</span><span class=n>Object</span> <span class=n>dataToCache</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>encoder</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSourceEncoder</span><span class=p>(</span><span class=n>dataToCache</span><span class=p>);</span>
    <span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>writer</span> <span class=o>=</span>
        <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span> <span class=n>dataToCache</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
    <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
    <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span> <span class=n>writer</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=n>sourceCacheGenerator</span> <span class=o>=</span>
      <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>),</span> <span class=n>helper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>æ— è®ºä¸Šé¢ä¸‰ä¸ª<code>DataFetcherGenerator</code>ä¹‹é—´æ€ä¹ˆæŠ˜è…¾ï¼Œç°åœ¨ç»ˆäºæˆåŠŸåŠ è½½åˆ°äº†æ•°æ®ã€‚æ‰€æœ‰ç¼“å­˜çš„è¯»ç¼“å­˜æ“ä½œä¹Ÿå·²ç»å®Œæˆï¼Œå‰©ä¸‹çš„éƒ½æ˜¯å†™ç¼“å­˜äº†ã€‚ </p> <p>ç»“ä¸‹æ¥è¡¨è¡¨ä¸Šé¢æŒ‰ä¸‹ä¸è¡¨çš„å†…å®¹ï¼Œå³<code>DecodeJob.onDataFetcherReady</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•å®Œæˆä¸¤ä¸ªäº‹æƒ…ï¼š</p> <ol> <li>å°†æ¯”è¾ƒåŸå§‹çš„dataæ•°æ®è½¬å˜ä¸ºå¯ä»¥ä¾›ImageViewæ˜¾ç¤ºçš„resourceæ•°æ®</li> <li>å°†resourceæ•°æ®æ˜¾ç¤ºå‡ºæ¥</li> </ol> <p>è¿™é‡Œé¢çš„æ¯è¡Œä»£ç çš„åˆ†æéƒ½åœ¨<a href=/android/3rd-library/glide2/#39-decodejobfetcherreadycallback>Glide2-3.9-DecodeJob.FetcherReadyCallback</a>ä¸­ï¼Œè¿™é‡Œåªè¯´ä¸€ä¸‹æ¶‰åŠåˆ°ç¼“å­˜çš„ä½ç½®ã€‚<br> åœ¨è¿‡ç¨‹1ä¸­ï¼Œå°†åŸå§‹data encodeæˆresourceæ•°æ®åï¼Œä¼šè°ƒç”¨<code>DecodeJob.onResourceDecoded</code>å¯¹resourceæ•°æ®è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚<code>DecodeJob.onResourceDecoded</code>é¦–å…ˆä¼šå¯¹resourceè¿›è¡Œtransformï¼Œç„¶åå¯èƒ½ä¼šè¿›è¡Œç£ç›˜ç¼“å­˜ã€‚</p> <p><strong>DecodeJob.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span>
<span class=nd>@NonNull</span>
<span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=p>)</span> <span class=p>{</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>decoded</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>();</span>
  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceSubClass</span><span class=p>);</span>
    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>glideContext</span><span class=p>,</span> <span class=n>decoded</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=c1>// TODO: Make this the responsibility of the Transformation.</span>
  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>decoded</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>decoded</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=kd>final</span> <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=p>;</span>
  <span class=kd>final</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isResourceEncoderAvailable</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
    <span class=n>encoder</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getResultEncoder</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>.</span><span class=na>getEncodeStrategy</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>;</span>
  <span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span> <span class=o>=</span> <span class=o>!</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isSourceKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isResourceCacheable</span><span class=p>(</span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span>
      <span class=n>encodeStrategy</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>encoder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>throw</span> <span class=k>new</span> <span class=n>Registry</span><span class=p>.</span><span class=na>NoResultEncoderAvailableException</span><span class=p>(</span><span class=n>transformed</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>());</span>
    <span class=p>}</span>
    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
    <span class=k>switch</span> <span class=p>(</span><span class=n>encodeStrategy</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
        <span class=n>key</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>,</span> <span class=n>signature</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>case</span> <span class=n>TRANSFORMED</span><span class=p>:</span>
        <span class=n>key</span> <span class=o>=</span>
            <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span>
                <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
                <span class=n>currentSourceKey</span><span class=p>,</span>
                <span class=n>signature</span><span class=p>,</span>
                <span class=n>width</span><span class=p>,</span>
                <span class=n>height</span><span class=p>,</span>
                <span class=n>appliedTransformation</span><span class=p>,</span>
                <span class=n>resourceSubClass</span><span class=p>,</span>
                <span class=n>options</span><span class=p>);</span>
        <span class=k>break</span><span class=p>;</span>
      <span class=k>default</span><span class=p>:</span>
        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unknown strategy: &quot;</span> <span class=o>+</span> <span class=n>encodeStrategy</span><span class=p>);</span>
    <span class=p>}</span>

    <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>lockedResult</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
    <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>encoder</span><span class=p>,</span> <span class=n>lockedResult</span><span class=p>);</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResult</span><span class=p>;</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div> <p>ä»ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“<code>dataSource != DataSource.RESOURCE_DISK_CACHE</code>æ—¶ä¼šè¿›è¡Œtransformã€‚å“¦ï½ï¼Œè¿™æ˜¯å› ä¸ºresource cacheè‚¯å®šå·²ç»ç»å†è¿‡transformäº†ï¼Œæ‰€ä»¥å°±ä¸ç”¨é‡æ–°æ¥ä¸€éäº†ã€‚ </p> <p>ç„¶åæ˜¯æ­¤è¿‡ç¨‹ä¸­çš„ç£ç›˜ç¼“å­˜è¿‡ç¨‹ï¼Œå½±å“çš„å› ç´ æœ‰<code>encodeStrategy</code>ã€<code>DiskCacheStrategy.isResourceCacheable</code>ï¼š</p> <ol> <li>encodeStrategy<br> æ ¹æ®resourceæ•°æ®çš„ç±»å‹æ¥åˆ¤æ–­ï¼Œå¦‚æœæ˜¯<code>Bitmap</code>æˆ–<code>BitmapDrawable</code>ï¼Œé‚£ä¹ˆå°±æ˜¯<code>TRANSFORMED</code>ï¼›<br> å¦‚æœæ˜¯<code>GifDrawable</code>ï¼Œé‚£ä¹ˆå°±æ˜¯<code>SOURCE</code>ã€‚<br> è¯¦ç»†è¯·çœ‹<code>BitmapEncoder</code>ã€<code>BitmapDrawableEncoder</code>å’Œ<code>GifDrawableEncoder</code>ç±»</li> <li>DiskCacheStrategy.isResourceCacheable<br> <code>isFromAlternateCacheKey</code>æœäº†ä¸€éæºç ï¼Œåªæœ‰ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨è¿‡çš„ç±»<code>BaseGlideUrlLoader</code>ä¸­å‘ç°äº†ç—•è¿¹ï¼Œè¿˜æ˜¯ä¸€ä¸ªç©ºé›†åˆå®ç°ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•ä½ç½®åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æ­¤å¤„å¯ä»¥ç®€å•ç†è§£çš„è¯¥å‚æ•°ä¸€ç›´ä¸ºfalseã€‚<br> ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰dataSourceä¸º<code>DataSource.LOCAL</code>ä¸”encodeStrategyä¸º<code>EncodeStrategy.TRANSFORMED</code>æ—¶ï¼Œæ‰å…è®¸ç¼“å­˜ã€‚æ¢å¥è¯è¯´ï¼Œåªæœ‰æœ¬åœ°çš„resourceæ•°æ®ä¸º<code>Bitmap</code>æˆ–<code>BitmapDrawable</code>çš„èµ„æºæ‰å¯ä»¥ç¼“å­˜ã€‚ <div class=highlight><pre><span></span><code> <span class=nd>@Override</span>
 <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isResourceCacheable</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
     <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=p>)</span> <span class=p>{</span>
   <span class=k>return</span> <span class=p>((</span><span class=n>isFromAlternateCacheKey</span> <span class=o>&amp;&amp;</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>DATA_DISK_CACHE</span><span class=p>)</span>
       <span class=o>||</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>LOCAL</span><span class=p>)</span>
       <span class=o>&amp;&amp;</span> <span class=n>encodeStrategy</span> <span class=o>==</span> <span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>TRANSFORMED</span><span class=p>;</span>
 <span class=p>}</span>
</code></pre></div></li> </ol> <p>æœ€åï¼Œå¦‚æœå¯ä»¥ç¼“å­˜ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ª<code>deferredEncodeManager</code>ï¼Œåœ¨å±•ç¤ºresourceèµ„æºåä¼šè°ƒç”¨æ­¤å¯¹è±¡è¿›è¡Œç£ç›˜ç¼“å­˜çš„å†™å…¥ã€‚å†™å…¥çš„ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><span class=c1>// DecodeJob.java</span>
<span class=c1>//</span>
<span class=c1>// deferredEncodeManager.init(key, encoder, LockedResource.obtain(transformed));</span>
<span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Initializable</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>((</span><span class=n>Initializable</span><span class=p>)</span> <span class=n>resource</span><span class=p>).</span><span class=na>initialize</span><span class=p>();</span>
  <span class=p>}</span>

  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
  <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>lockedResource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
    <span class=n>lockedResource</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResource</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>notifyComplete</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>

  <span class=n>stage</span> <span class=o>=</span> <span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>;</span>
  <span class=k>try</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>lockedResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>lockedResource</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process</span>
  <span class=c1>// throws.</span>
  <span class=n>onEncodeComplete</span><span class=p>();</span>
<span class=p>}</span>

<span class=c1>// DecodeJob#DeferredEncodeManager</span>
<span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DeferredEncodeManager</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=p>{</span>
  <span class=kd>private</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
  <span class=kd>private</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>;</span>
  <span class=kd>private</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=p>;</span>

  <span class=nd>@Synthetic</span>
  <span class=n>DeferredEncodeManager</span><span class=p>()</span> <span class=p>{</span> <span class=p>}</span>

  <span class=c1>// We just need the encoder and resource type to match, which this will enforce.</span>
  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
  <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>init</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>,</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>encoder</span> <span class=o>=</span> <span class=p>(</span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>encoder</span><span class=p>;</span>
    <span class=k>this</span><span class=p>.</span><span class=na>toEncode</span> <span class=o>=</span> <span class=p>(</span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>toEncode</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kt>void</span> <span class=nf>encode</span><span class=p>(</span><span class=n>DiskCacheProvider</span> <span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=s>&quot;DecodeJob.encode&quot;</span><span class=p>);</span>
    <span class=k>try</span> <span class=p>{</span>
      <span class=n>diskCacheProvider</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span>
          <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span> <span class=n>toEncode</span><span class=p>,</span> <span class=n>options</span><span class=p>));</span>
    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
      <span class=n>toEncode</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
      <span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=kt>boolean</span> <span class=nf>hasResourceToEncode</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>return</span> <span class=n>toEncode</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=kt>void</span> <span class=nf>clear</span><span class=p>()</span> <span class=p>{</span>
    <span class=n>key</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
    <span class=n>toEncode</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p><code>DiskLruCacheWrapper</code>åœ¨å†™å…¥çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°å†™é”<code>DiskCacheWriteLocker</code>ï¼Œé”å¯¹è±¡ç”±å¯¹è±¡æ± åˆ›å»ºï¼ˆGlideä¸­å¯¹è±¡æ± å’Œç¼“å­˜çœŸçš„æ˜¯æ— æ‰€ä¸åœ¨ğŸ‘ğŸ‘ğŸ‘ï¼‰ï¼Œå†™é”<code>WriteLock</code>å®ç°æ˜¯ä¸€ä¸ªé‡å…¥é”<code>ReentrantLock</code>ï¼Œè¯¥é”é»˜è®¤æ˜¯ä¸€ä¸ªä¸å…¬å¹³é”ã€‚<br> åœ¨ç¼“å­˜å†™å…¥å‰ï¼Œä¼šåˆ¤æ–­keyå¯¹åº”çš„valueå­˜ä¸å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™æ”¾å¼ƒå†™å…¥ã€‚ç¼“å­˜çš„çœŸæ­£å†™å…¥ä¼šç”±<code>DataCacheWriter</code>äº¤ç»™<code>ByteBufferEncoder</code>å’Œ<code>StreamEncoder</code>ä¸¤ä¸ªå…·ä½“ç±»æ¥å†™å…¥ï¼Œå‰è€…è´Ÿè´£å°†ByteBufferå†™å…¥åˆ°æ–‡ä»¶ï¼Œåè€…è´Ÿè´£å°†InputStreamå†™å…¥åˆ°æ–‡ä»¶ã€‚</p> <p>è‡³æ­¤ï¼Œç£ç›˜ç¼“å­˜çš„è¯»å†™éƒ½å·²ç»å®Œæ¯•ï¼Œå‰©ä¸‹çš„å°±æ˜¯å†…å­˜ç¼“å­˜çš„ä¸¤ä¸ªå±‚æ¬¡äº†ã€‚æˆ‘ä»¬å›åˆ°<code>DecodeJob.notifyEncodeAndRelease</code>æ–¹æ³•ä¸­ï¼Œç»è¿‡<code>notifyComplete</code>ã€<code>EngineJob.onResourceReady</code>ã€<code>notifyCallbacksOfResult</code>æ–¹æ³•ä¸­ã€‚<br> åœ¨è¯¥æ–¹æ³•ä¸­ä¸€æ–¹é¢ä¼šå°†åŸå§‹çš„resourceåŒ…è£…æˆä¸€ä¸ª<code>EngineResource</code>ï¼Œç„¶åé€šè¿‡å›è°ƒä¼ ç»™<code>Engine.onEngineJobComplete</code>ï¼Œåœ¨è¿™é‡Œä¼šå°†èµ„æºä¿æŒåœ¨active resourceä¸­ï¼š</p> <p><strong>Engine.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=p>(</span>
    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=p>,</span> <span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>resource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>

    <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
      <span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
    <span class=p>}</span>
  <span class=p>}</span>

  <span class=n>jobs</span><span class=p>.</span><span class=na>removeIfCurrent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>å¦ä¸€æ–¹é¢ä¼šä½¿ç”¨<code>Executors.mainThreadExecutor()</code>è°ƒç”¨<code>SingleRequest.onResourceReady</code>å›è°ƒè¿›è¡Œèµ„æºçš„æ˜¾ç¤ºã€‚<br> åœ¨è§¦å‘å›è°ƒå‰åå„æœ‰ä¸€ä¸ªåœ°æ–¹ä¼šå¯¹<code>engineResource</code>è¿›è¡Œ<code>acquire()</code>å’Œ<code>release()</code>æ“ä½œã€‚è¯¥è¿‡ç¨‹å‘ç”Ÿåœ¨<code>notifyCallbacksOfResult()</code>æ–¹æ³•çš„<code>incrementPendingCallbacks</code>ã€<code>decrementPendingCallbacks()</code>è°ƒç”¨ä¸­ã€‚è¿™ä¸€é¡¿æ“ä½œä¸‹æ¥ï¼ŒengineResourceçš„å¼•ç”¨è®¡æ•°åº”è¯¥æ˜¯1ï¼š</p> <p><strong>EngineJob.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span>
<span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=p>()</span> <span class=p>{</span>
  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=p>;</span>
  <span class=n>Key</span> <span class=n>localKey</span><span class=p>;</span>
  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=p>;</span>
  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>...</span>
    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>isCacheable</span><span class=p>);</span>
    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the</span>
    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under</span>
    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section</span>
    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.</span>
    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span>
    <span class=n>incrementPendingCallbacks</span><span class=p>(</span><span class=n>copy</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>

    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=n>listener</span><span class=p>.</span><span class=na>onEngineJobComplete</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>localKey</span><span class=p>,</span> <span class=n>localResource</span><span class=p>);</span>

  <span class=k>for</span> <span class=p>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>entry</span><span class=p>.</span><span class=na>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>cb</span><span class=p>));</span>
  <span class=p>}</span>
  <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
<span class=p>}</span>

<span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>incrementPendingCallbacks</span><span class=p>(</span><span class=kt>int</span> <span class=n>count</span><span class=p>)</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>pendingCallbacks</span><span class=p>.</span><span class=na>getAndAdd</span><span class=p>(</span><span class=n>count</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>decrementPendingCallbacks</span><span class=p>()</span> <span class=p>{</span>
  <span class=p>...</span>
  <span class=kt>int</span> <span class=n>decremented</span> <span class=o>=</span> <span class=n>pendingCallbacks</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>decremented</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>engineResource</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=n>release</span><span class=p>();</span>
  <span class=p>}</span>
<span class=p>}</span>

<span class=kd>private</span> <span class=kd>class</span> <span class=nc>CallResourceReady</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>

  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>;</span>

  <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
  <span class=p>}</span>

  <span class=nd>@Override</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>EngineJob</span><span class=p>.</span><span class=na>this</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>cb</span><span class=p>))</span> <span class=p>{</span>
        <span class=c1>// Acquire for this particular callback.</span>
        <span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
        <span class=n>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
        <span class=n>removeCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
      <span class=p>}</span>
      <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
    <span class=p>}</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>engineResourceçš„å¼•ç”¨è®¡æ•°ä¼šåœ¨<code>RequestManager.onDestory</code>æ–¹æ³•ä¸­ç»è¿‡<code>clear</code>ã€<code>untrackOrDelegate</code>ã€<code>untrack</code>ã€<code>RequestTracker.clearRemoveAndRecycle</code>ã€<code>clearRemoveAndMaybeRecycle</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>SingleRequest.clear()</code>æ–¹æ³•ç»è¿‡<code>releaseResource()</code>ã€<code>Engine.release</code>ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚è¿™æ ·å¼•ç”¨è®¡æ•°å°±ä¸º0äº†ã€‚</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Tips: å¯ä»¥åœ¨æ‰“æ–­ç‚¹çš„æ—¶å€™åœ¨<code>Evaluate Expression</code>åŠŸèƒ½ä¸­è°ƒç”¨<code>Log.x(String, String, Throwable)</code>æ–¹æ³•æ‰“å°å‡ºè°ƒç”¨æ ˆ</p> </div> <p>å‰é¢åœ¨çœ‹<code>EngineResource</code>çš„ä»£ç æ—¶æˆ‘ä»¬çŸ¥é“ï¼Œä¸€æ—¦å¼•ç”¨è®¡æ•°ä¸º0ï¼Œå°±ä¼šé€šçŸ¥<code>Engine</code>å°†æ­¤èµ„æºä»activeçŠ¶æ€å˜æˆmemory cacheçŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬å†æ¬¡åŠ è½½èµ„æºæ—¶å¯ä»¥ä»memory cacheä¸­åŠ è½½ï¼Œé‚£ä¹ˆèµ„æºåˆä¼šä»memory cacheçŠ¶æ€å˜æˆactiveçŠ¶æ€ã€‚</p> <p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨èµ„æºç¬¬ä¸€æ¬¡æ˜¾ç¤ºåï¼Œæˆ‘ä»¬å…³é—­é¡µé¢ï¼Œèµ„æºä¼šç”±activeå˜æˆmemory cacheï¼›ç„¶åæˆ‘ä»¬å†æ¬¡è¿›å…¥é¡µé¢ï¼ŒåŠ è½½æ—¶ä¼šå‘½ä¸­memory cacheï¼Œä»è€Œåˆå˜æˆactiveçŠ¶æ€ã€‚</p> <p>æœ¬ç« Glideç¼“å­˜æœºåˆ¶çš„æºç å†…å®¹åˆ°æ­¤ä¸ºæ­¢äº†ï¼Œç°åœ¨çœ‹çœ‹æ–‡ç« æœ€å¼€å§‹çš„æµç¨‹å›¾ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç‚¹ç‚¹ç†Ÿæ‚‰çš„å‘³é“ã€‚</p> <p>æœ€åï¼Œæ‘˜æŠ„ä¸€ä¸‹Glideå®˜æ–¹æ–‡æ¡£å¯¹äºç¼“å­˜æ›´æ–°çš„è¯´æ˜ï¼š</p> <blockquote> <p>Because disk cache are hashed keys, there is no good way to simply delete all of the cached files on disk that correspond to a particular url or file path. The problem would be simpler if you were only ever allowed to load or cache the original image, but since Glide also caches thumbnails and provides various transformations, each of which will result in a new File in the cache, tracking down and deleting every cached version of an image is difficult. </p> <p>In practice, the best way to invalidate a cache file is to change your identifier when the content changes (url, uri, file path etc) when possible. </p> <p>Since itâ€™s often difficult or impossible to change identifiers, Glide also offers the <code>signature()</code> API to mix in additional data that you control into your cache key. Signatures work well for media store content, as well as any content you can maintain some versioning metadata for.<br> - Media store content - For media store content, you can use Glideâ€™s <code>MediaStoreSignature</code> class as your signature. MediaStoreSignature allows you to mix the date modified time, mime type, and orientation of a media store item into the cache key. These three attributes reliably catch edits and updates allowing you to cache media store thumbs. - Files - You can use <code>ObjectKey</code> to mix in the Fileâ€™s date modified time. - Urls - Although the best way to invalidate urls is to make sure the server changes the url and updates the client when the content at the url changes, you can also use <code>ObjectKey</code> to mix in arbitrary metadata (such as a version number) instead. </p> <p>If all else fails and you can neither change your identifier nor keep track of any reasonable version metadata, you can also disable disk caching entirely using <code>diskCacheStrategy()</code> and <code>DiskCacheStrategy.NONE</code>.<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#cache-invalidation>Cache Invalidation</a></cite></p> </blockquote> <hr> <div class=md-source-date> <small> æœ€åæ›´æ–°: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2020å¹´5æœˆ16æ—¥</span> </small> </div> <h2 id=__comments>è¯„è®º</h2> <div id=disqus_thread></div> <script>var disqus_config=function(){this.page.url="https://blog.yorek.xyz/about-me/android/3rd-library/glide3/",this.page.identifier="/android/3rd-library/glide3/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//yorekliu.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../glide2/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> ä¸Šä¸€é¡µ </span> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </div> </div> </a> <a href=../glide4/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> ä¸‹ä¸€é¡µ </span> Glide v4 æºç è§£æï¼ˆå››ï¼‰ </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> &copy; 2021 Yorek </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/YorekLiu target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 002 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0012 2z"/></svg> </a> <a href=lyytogether@gmail.com target=_blank rel=noopener title class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 8l-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h16a2 2 0 002-2V6a2 2 0 00-2-2z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../../assets/javascripts/vendor.93c04032.min.js></script> <script src=../../../assets/javascripts/bundle.83e5331e.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../../..",
          features: ['navigation.tabs', 'navigation.instant'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
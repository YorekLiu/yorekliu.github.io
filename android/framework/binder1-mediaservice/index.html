<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An Android Developer."><meta name=author content="Yorek Liu"><link href=https://blog.yorek.xyz/android/framework/binder1-mediaservice/ rel=canonical><link rel=icon href=../../../assets/images/favicon.webp><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.3.2"><title>Binder深入理解——以MediaService为例 - Yorek's</title><link rel=stylesheet href=../../../assets/stylesheets/main.5d38496d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans SC";--md-code-font:"JetBrains Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-processstate class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="Yorek's" class="md-header__button md-logo" aria-label="Yorek's" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Yorek's </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Binder深入理解——以MediaService为例 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Yorek's" class="md-nav__button md-logo" aria-label="Yorek's" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_1 type=checkbox id=__nav_1_1> <label class=md-nav__link for=__nav_1_1> 三方库系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=三方库系列 data-md-level=2> <label class=md-nav__title for=__nav_1_1> <span class="md-nav__icon md-icon"></span> 三方库系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace-plugin/ class=md-nav__link> Matrix-ASM插桩插件解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-apk-checker/ class=md-nav__link> Matrix-ApkChecker：安装包分析检测工具 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/andresguard/ class=md-nav__link> AndResGuard资源混淆原理浅析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/hprof-shrink/ class=md-nav__link> 剖析hprof文件的两种主要裁剪流派 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava%26rxandroid/ class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> 初学者的Dagger2教程 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/hotfix/ class=md-nav__link> Hotfix方案初探 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2 checked> <label class=md-nav__link for=__nav_1_2> framework系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=framework系列 data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../Drawable/ class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../Window%E4%B8%8EWindowManager/ class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../JNI%E4%B8%8ENDK/ class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Android性能优化 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Binder深入理解——以MediaService为例 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Binder深入理解——以MediaService为例 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-processstate class=md-nav__link> 1 ProcessState </a> </li> <li class=md-nav__item> <a href=#2-defaultservicemanager class=md-nav__link> 2 defaultServiceManager </a> </li> <li class=md-nav__item> <a href=#3-bpbinder class=md-nav__link> 3 BpBinder </a> </li> <li class=md-nav__item> <a href=#4-interface_cast class=md-nav__link> 4 interface_cast </a> </li> <li class=md-nav__item> <a href=#5-bpservicemanager class=md-nav__link> 5 BpServiceManager </a> </li> <li class=md-nav__item> <a href=#6-mediaplayerservice class=md-nav__link> 6 MediaPlayerService </a> </li> <li class=md-nav__item> <a href=#7-bpserviewmanageraddservice class=md-nav__link> 7 BpServiewManager#addService </a> </li> <li class=md-nav__item> <a href=#8-bnservicemanager class=md-nav__link> 8 BnServiceManager </a> </li> <li class=md-nav__item> <a href=#9-servicemanager class=md-nav__link> 9 ServiceManager存在的意义 </a> </li> <li class=md-nav__item> <a href=#10-mediaservice class=md-nav__link> 10 MediaService的运行 </a> </li> <li class=md-nav__item> <a href=#11 class=md-nav__link> 11 小结 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../binder2/ class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 type=checkbox id=__nav_1_3> <label class=md-nav__link for=__nav_1_3> 杂记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=杂记 data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> 杂记 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/commands/ class=md-nav__link> Android开发常见命令 </a> </li> <li class=md-nav__item> <a href=../../other/android-tv/ class=md-nav__link> Android TV 专项 </a> </li> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> 琐碎知识点 </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> 琐碎知识点2 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 type=checkbox id=__nav_1_4> <label class=md-nav__link for=__nav_1_4> 基础知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础知识 data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> 大尺寸图片加载问题 </a> </li> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_5 type=checkbox id=__nav_1_5> <label class=md-nav__link for=__nav_1_5> Android开发高手课 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android开发高手课 data-md-level=2> <label class=md-nav__title for=__nav_1_5> <span class="md-nav__icon md-icon"></span> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-processstate class=md-nav__link> 1 ProcessState </a> </li> <li class=md-nav__item> <a href=#2-defaultservicemanager class=md-nav__link> 2 defaultServiceManager </a> </li> <li class=md-nav__item> <a href=#3-bpbinder class=md-nav__link> 3 BpBinder </a> </li> <li class=md-nav__item> <a href=#4-interface_cast class=md-nav__link> 4 interface_cast </a> </li> <li class=md-nav__item> <a href=#5-bpservicemanager class=md-nav__link> 5 BpServiceManager </a> </li> <li class=md-nav__item> <a href=#6-mediaplayerservice class=md-nav__link> 6 MediaPlayerService </a> </li> <li class=md-nav__item> <a href=#7-bpserviewmanageraddservice class=md-nav__link> 7 BpServiewManager#addService </a> </li> <li class=md-nav__item> <a href=#8-bnservicemanager class=md-nav__link> 8 BnServiceManager </a> </li> <li class=md-nav__item> <a href=#9-servicemanager class=md-nav__link> 9 ServiceManager存在的意义 </a> </li> <li class=md-nav__item> <a href=#10-mediaservice class=md-nav__link> 10 MediaService的运行 </a> </li> <li class=md-nav__item> <a href=#11 class=md-nav__link> 11 小结 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>Binder深入理解——以MediaService为例</h1> <p>本博客Binder系列：</p> <ol> <li><a href=/android/paid/zsxq/week11-binder/ >Binder简介</a></li> <li><a href=/android/framework/binder1-mediaservice/ >Binder深入理解——以MediaService为例</a>，基于<a href=http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html>Android深入浅出之Binder机制</a></li> <li><a href=/android/framework/binder2/ >Binder深入理解——罗老师系列</a>，基于<a href=https://blog.csdn.net/luoshengyang/article/details/6618363>Android进程间通信（IPC）机制Binder简要介绍和学习计划</a></li> </ol> <hr> <blockquote> <p>本节内容源于<a href=http://www.cnblogs.com/innost/archive/2011/01/09/1931456.html>参考文献1——Android深入浅出之Binder机制</a>，代码版本为<a href=http://androidxref.com/2.3.6/ >2.3.6</a>，摘抄部分代码略有删减。</p> </blockquote> <p>MediaService的<code>main</code>函数如下：<br> <strong>frameworks/base/media/mediaserver/main_mediaserver.cpp</strong></p> <div class=highlight><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=o>**</span><span class=w> </span><span class=n>argv</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// 获得一个ProcessState实例</span>
<span class=w>    </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>ProcessState</span><span class=o>&gt;</span><span class=w> </span><span class=n>proc</span><span class=p>(</span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=c1>// 得到一个ServiceManager对象</span>
<span class=w>    </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>sm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>defaultServiceManager</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=c1>// 初始化MediaPlayerService服务等</span>
<span class=w>    </span><span class=n>AudioFlinger</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>MediaPlayerService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>CameraService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>AudioPolicyService</span><span class=o>::</span><span class=n>instantiate</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=c1>// 启动Process的线程池?</span>
<span class=w>    </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>startThreadPool</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=c1>// 将自己加入到刚才的线程池?</span>
<span class=w>    </span><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>joinThreadPool</span><span class=p>();</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>正式开始分析之前，我们先看看sp是个什么。<br> sp是一个定义在RefBase.h文件中的模板类，意思是strong pointer，这么做是为了方便C/C++程序员管理指针的分配和释放。与之对应的还有一个wp，也就是weak pointer。该文件位于frameworks/base/include/utils/RefBase.h。<br> 可以简单地将sp<t>理解为T*。</p> <h2 id=1-processstate>1 ProcessState<a class=headerlink href=#1-processstate title="Permanent link">&para;</a></h2> <p>第一个调用的函数是<code>ProcessState::self()</code>，然后赋值给了proc这个变量，由于sp的特性，程序执行完之后系统会自动释放proc指向的资源。</p> <p><code>ProcessState::self()</code>的相关代码如下：<br> <strong>frameworks/base/libs/binder/ProcessState.cpp</strong> </p> <div class=highlight><pre><span></span><code><span class=c1>// 创建一个ProcessState对象</span>
<span class=n>sp</span><span class=o>&lt;</span><span class=n>ProcessState</span><span class=o>&gt;</span><span class=w> </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gProcess</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>gProcess</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>AutoMutex</span><span class=w> </span><span class=nf>_l</span><span class=p>(</span><span class=n>gProcessMutex</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gProcess</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=n>gProcess</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>ProcessState</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>gProcess</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>ProcessState</span><span class=o>::</span><span class=n>ProcessState</span><span class=p>()</span><span class=w></span>
<span class=o>:</span><span class=w> </span><span class=n>mDriverFD</span><span class=p>(</span><span class=n>open_driver</span><span class=p>())</span><span class=w> </span><span class=c1>// 创建ProcessState时调用了关键函数open_driver</span>
<span class=p>,</span><span class=w> </span><span class=n>mVMStart</span><span class=p>(</span><span class=n>MAP_FAILED</span><span class=p>)</span><span class=w>     </span><span class=c1>// 映射内存的起始地址</span>
<span class=p>,</span><span class=w> </span><span class=n>mManagesContexts</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mBinderContextCheckFunc</span><span class=p>(</span><span class=nb>NULL</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mBinderContextUserData</span><span class=p>(</span><span class=nb>NULL</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mThreadPoolStarted</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mThreadPoolSeq</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDriverFD</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// mmap the binder, providing a chunk of virtual address space to receive transactions.</span>
<span class=w>        </span><span class=c1>// #define BINDER_VM_SIZE ((1*1024*1024) - (4096 *2)) 也就是1M-4*2K</span>
<span class=w>        </span><span class=c1>// mmap系统调用使得进程之间通过映射同一个普通文件实现共享内存。</span>
<span class=w>        </span><span class=c1>// 普通文件被映射到进程地址空间后，进程可以像访问普通内存一样对文件进行访问，不必再调用rw等操作</span>
<span class=w>        </span><span class=n>mVMStart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_VM_SIZE</span><span class=p>,</span><span class=w> </span><span class=n>PROT_READ</span><span class=p>,</span><span class=w> </span><span class=n>MAP_PRIVATE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MAP_NORESERVE</span><span class=p>,</span><span class=w> </span><span class=n>mDriverFD</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mVMStart</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_FAILED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// *sigh*</span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Using /dev/binder failed: unable to mmap transaction memory.</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>mDriverFD</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>mDriverFD</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// open_driver就是打开/dev/binder设备</span>
<span class=c1>// 该设备就是在内核中一个专门用于完成进程间通讯而设置的一个虚拟的设备</span>
<span class=c1>// BTW，说白了就是内核的提供的一个机制，这个和我们用socket加NET_LINK方式和内核通讯是一个道理。</span>
<span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>open_driver</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gSingleProcess</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>open</span><span class=p>(</span><span class=s>&quot;/dev/binder&quot;</span><span class=p>,</span><span class=w> </span><span class=n>O_RDWR</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>fcntl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>F_SETFD</span><span class=p>,</span><span class=w> </span><span class=n>FD_CLOEXEC</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=c1>// 检查binder的状态</span>
<span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>vers</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>status_t</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_VERSION</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>vers</span><span class=p>);</span><span class=w></span>

<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Binder ioctl to obtain version failed: %s&quot;</span><span class=p>,</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>vers</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>BINDER_CURRENT_PROTOCOL_VERSION</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Binder driver protocol does not match user space protocol!&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=c1>// 通过ioctl方式告诉内核，这个fd支持最大线程数是15个。</span>
<span class=w>        </span><span class=kt>size_t</span><span class=w> </span><span class=n>maxThreads</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>15</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_SET_MAX_THREADS</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>maxThreads</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>-1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;Binder ioctl to set max threads failed: %s&quot;</span><span class=p>,</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>LOGW</span><span class=p>(</span><span class=s>&quot;Opening &#39;/dev/binder&#39; failed: %s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>通过以上分析，我们可以看出<code>ProcessState::self()</code>实际上就是open binder，然后将得到的fd mmap到内存。</p> <h2 id=2-defaultservicemanager>2 defaultServiceManager<a class=headerlink href=#2-defaultservicemanager title="Permanent link">&para;</a></h2> <p>该方法的实现在IServiceManager.cpp中：<br> <strong>frameworks/base/include/binder/IServiceManager.cpp</strong></p> <div class=highlight><pre><span></span><code><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>defaultServiceManager</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gDefaultServiceManager</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>gDefaultServiceManager</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>AutoMutex</span><span class=w> </span><span class=nf>_l</span><span class=p>(</span><span class=n>gDefaultServiceManagerLock</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gDefaultServiceManager</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>gDefaultServiceManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>interface_cast</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=p>(</span><span class=w></span>
<span class=w>                </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getContextObject</span><span class=p>(</span><span class=nb>NULL</span><span class=p>));</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>gDefaultServiceManager</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>这也是一个单例模式的实现，我们注意到创建<code>IServiceManager</code>时的语句：<br> <code>interface_cast&lt;IServiceManager&gt;(ProcessState::self()-&gt;getContextObject(NULL))</code>。<br> <code>ProcessState::self()</code>就是上一步中创建的gProcess，然后调用了其<code>getContextObject(NULL)</code>方法。</p> <p>我们跟踪一下调用过程：</p> <div class=highlight><pre><span></span><code><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span><span class=w> </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>getContextObject</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>caller</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>supportsProcesses</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// mDriverFD肯定是&gt;=0的，所以满足条件</span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getStrongProxyForHandle</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getContextObject</span><span class=p>(</span><span class=n>String16</span><span class=p>(</span><span class=s>&quot;default&quot;</span><span class=p>),</span><span class=w> </span><span class=n>caller</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kt>bool</span><span class=w> </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>supportsProcesses</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mDriverFD</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// handle在MFC中接触过，中文名为句柄，是对资源的一种标示。此处传入的值为0</span>
<span class=c1>// handle可以理解为某个数据结构在其数组中的索引。</span>
<span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span><span class=w> </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>getStrongProxyForHandle</span><span class=p>(</span><span class=kt>int32_t</span><span class=w> </span><span class=n>handle</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>AutoMutex</span><span class=w> </span><span class=nf>_l</span><span class=p>(</span><span class=n>mLock</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// lookupHandleLocked会在一个Vector中查找或插入handle</span>
<span class=w>    </span><span class=c1>// 当插入时，其binder和refs都置为NULL，见下面贴出来的函数代码</span>
<span class=w>    </span><span class=c1>// struct handle_entry {</span>
<span class=w>    </span><span class=c1>//     IBinder* binder;</span>
<span class=w>    </span><span class=c1>//     RefBase::weakref_type* refs;</span>
<span class=w>    </span><span class=c1>// };</span>
<span class=w>    </span><span class=n>handle_entry</span><span class=o>*</span><span class=w> </span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lookupHandleLocked</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// We need to create a new BpBinder if there isn&#39;t currently one, OR we</span>
<span class=w>        </span><span class=c1>// are unable to acquire a weak reference on this current one.  See comment</span>
<span class=w>        </span><span class=c1>// in getWeakProxyForHandle() for more info about this.</span>
<span class=w>        </span><span class=n>IBinder</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>binder</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>refs</span><span class=o>-&gt;</span><span class=n>attemptIncWeak</span><span class=p>(</span><span class=n>this</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// 由于handle值为0，所以N &lt;= (size_t)handle肯定成立，因此b肯定为null</span>
<span class=w>            </span><span class=c1>// 这里创建了一个BpBinder对象</span>
<span class=w>            </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>BpBinder</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>binder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>refs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>getWeakRefs</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// This little bit of nastyness is to allow us to add a primary</span>
<span class=w>            </span><span class=c1>// reference to the remote proxy when this team doesn&#39;t have one</span>
<span class=w>            </span><span class=c1>// but another team is sending the handle to us.</span>
<span class=w>            </span><span class=n>result</span><span class=p>.</span><span class=n>force_set</span><span class=p>(</span><span class=n>b</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>e</span><span class=o>-&gt;</span><span class=n>refs</span><span class=o>-&gt;</span><span class=n>decWeak</span><span class=p>(</span><span class=n>this</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// 返回上面创建的BpBinder</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>ProcessState</span><span class=o>::</span><span class=n>handle_entry</span><span class=o>*</span><span class=w> </span><span class=n>ProcessState</span><span class=o>::</span><span class=n>lookupHandleLocked</span><span class=p>(</span><span class=kt>int32_t</span><span class=w> </span><span class=n>handle</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>N</span><span class=o>=</span><span class=n>mHandleToObject</span><span class=p>.</span><span class=n>size</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>N</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=n>handle</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// 在上面的分析中，由于handle值为0，所以N &lt;= (size_t)handle肯定成立</span>
<span class=w>        </span><span class=n>handle_entry</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=n>binder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=n>refs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>status_t</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mHandleToObject</span><span class=p>.</span><span class=n>insertAt</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>N</span><span class=p>,</span><span class=w> </span><span class=n>handle</span><span class=o>+</span><span class=mi>1</span><span class=o>-</span><span class=n>N</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>mHandleToObject</span><span class=p>.</span><span class=n>editItemAt</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在上面的调用过程之后，我们发现<code>ProcessState::self()-&gt;getContextObject(NULL)</code>实际上就等价于<code>new BpBinder(0)</code>;<br> 于是，开始的代码就变成了<code>gDefaultServiceManager = interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code>。</p> <p>那么BpBinder又是个什么呢？</p> <h2 id=3-bpbinder>3 BpBinder<a class=headerlink href=#3-bpbinder title="Permanent link">&para;</a></h2> <p><strong>frameworks/base/libs/binder/BpBinder.cpp</strong></p> <div class=highlight><pre><span></span><code><span class=n>BpBinder</span><span class=o>::</span><span class=n>BpBinder</span><span class=p>(</span><span class=kt>int32_t</span><span class=w> </span><span class=n>handle</span><span class=p>)</span><span class=w>    </span><span class=c1>// 接上面分析，这里的handle值为0</span>
<span class=o>:</span><span class=w> </span><span class=n>mHandle</span><span class=p>(</span><span class=n>handle</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mAlive</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mObitsSent</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=p>,</span><span class=w> </span><span class=n>mObituaries</span><span class=p>(</span><span class=nb>NULL</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;Creating BpBinder %p handle %d</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>this</span><span class=p>,</span><span class=w> </span><span class=n>mHandle</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>extendObjectLifetime</span><span class=p>(</span><span class=n>OBJECT_LIFETIME_WEAK</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>incWeakHandle</span><span class=p>(</span><span class=n>handle</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>我们来到了IPCThreadState类。<br> <strong>frameworks/base/include/binder/IPCThreadState.cpp</strong></p> <div class=highlight><pre><span></span><code><span class=k>static</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>gHaveTLS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w></span>
<span class=n>IPCThreadState</span><span class=o>*</span><span class=w> </span><span class=nf>IPCThreadState::self</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// 初始值为false，所有先走if后面的代码，然后goto进来</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gHaveTLS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=nl>restart</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>const</span><span class=w> </span><span class=n>pthread_key_t</span><span class=w> </span><span class=n>k</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gTLS</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=c1>// TLS是Thread Local Storage，Java中也有这个概念，对应ThreadLocal</span>
<span class=w>        </span><span class=c1>// 从线程本地存储空间中获得保存在其中的IPCThreadState对象</span>
<span class=w>        </span><span class=c1>// 这里是pthread_getspecific，那么肯定有对应的pthread_setspecific</span>
<span class=w>        </span><span class=n>IPCThreadState</span><span class=o>*</span><span class=w> </span><span class=n>st</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>IPCThreadState</span><span class=o>*</span><span class=p>)</span><span class=n>pthread_getspecific</span><span class=p>(</span><span class=n>k</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>st</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>st</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>IPCThreadState</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gShutdown</span><span class=p>)</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLSMutex</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>gHaveTLS</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pthread_key_create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLS</span><span class=p>,</span><span class=w> </span><span class=n>threadDestructor</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLSMutex</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=k>return</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=n>gHaveTLS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>gTLSMutex</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>goto</span><span class=w> </span><span class=n>restart</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><a href=/android/framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/#21-threadlocal>→Java层ThreadLocal的工作原理</a></p> <p>我们找一下<code>pthread_setspecific</code>的地方，在构造函数中</p> <div class=highlight><pre><span></span><code><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>IPCThreadState</span><span class=p>()</span><span class=w></span>
<span class=o>:</span><span class=w> </span><span class=n>mProcess</span><span class=p>(</span><span class=n>ProcessState</span><span class=o>::</span><span class=n>self</span><span class=p>()),</span><span class=w> </span><span class=n>mMyThreadId</span><span class=p>(</span><span class=n>androidGetTid</span><span class=p>())</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>pthread_setspecific</span><span class=p>(</span><span class=n>gTLS</span><span class=p>,</span><span class=w> </span><span class=n>this</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>clearCaller</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=c1>// in、out理解为命令的buffer</span>
<span class=w>    </span><span class=n>mIn</span><span class=p>.</span><span class=n>setDataCapacity</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>mOut</span><span class=p>.</span><span class=n>setDataCapacity</span><span class=p>(</span><span class=mi>256</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>由上可知，在new BpBinder的过程中创建了一个<code>IPCThreadState</code>。</p> <p>我们回到defaultServiceManager的创建过程，接下来是<code>interface_cast</code>。</p> <h2 id=4-interface_cast>4 interface_cast<a class=headerlink href=#4-interface_cast title="Permanent link">&para;</a></h2> <p><code>interface_cast</code>定义在IInterface.h文件中 </p> <p><strong>frameworks/base/include/binder/IInterface.h</strong></p> <div class=highlight><pre><span></span><code><span class=n>template</span><span class=o>&lt;</span><span class=n>typename</span><span class=w> </span><span class=n>INTERFACE</span><span class=o>&gt;</span><span class=w></span>
<span class=kr>inline</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>INTERFACE</span><span class=o>&gt;</span><span class=w> </span><span class=n>interface_cast</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>INTERFACE</span><span class=o>::</span><span class=n>asInterface</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>看来还是要看<code>IServiceManager::asInterface</code>的定义以及实现 </p> <p><strong>frameworks/base/include/binder/IServiceManager.h</strong></p> <div class=highlight><pre><span></span><code><span class=n>class</span><span class=w> </span><span class=n>IServiceManager</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>IInterface</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=n>public</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=n>DECLARE_META_INTERFACE</span><span class=p>(</span><span class=n>ServiceManager</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=p>};</span><span class=w></span>
</code></pre></div> <p>上面这个<code>DECLARE_META_INTERFACE</code>是个好东西，与之对应的是宏<code>IMPLEMENT_META_INTERFACE</code>。<br> 这两个宏定义在IInterface.h文件中</p> <p><strong>frameworks/base/include/binder/IInterface.h</strong></p> <div class=highlight><pre><span></span><code><span class=cp>#define DECLARE_META_INTERFACE(INTERFACE)                               \</span>
<span class=cp>    static const String16 descriptor;                                   \</span>
<span class=cp>    static sp&lt;I##INTERFACE&gt; asInterface(const sp&lt;IBinder&gt;&amp; obj);        \</span>
<span class=cp>    virtual const String16&amp; getInterfaceDescriptor() const;             \</span>
<span class=cp>    I##INTERFACE();                                                     \</span>
<span class=cp>    virtual ~I##INTERFACE();                                            \</span>


<span class=cp>#define IMPLEMENT_META_INTERFACE(INTERFACE, NAME)                       \</span>
<span class=cp>    const String16 I##INTERFACE::descriptor(NAME);                      \</span>
<span class=cp>    const String16&amp; I##INTERFACE::getInterfaceDescriptor() const {      \</span>
<span class=cp>        return I##INTERFACE::descriptor;                                \</span>
<span class=cp>    }                                                                   \</span>
<span class=cp>    sp&lt;I##INTERFACE&gt; I##INTERFACE::asInterface(const sp&lt;IBinder&gt;&amp; obj)  \</span>
<span class=cp>    {                                                                   \</span>
<span class=cp>        sp&lt;I##INTERFACE&gt; intr;                                          \</span>
<span class=cp>        if (obj != NULL) {                                              \</span>
<span class=cp>            intr = static_cast&lt;I##INTERFACE*&gt;(                          \</span>
<span class=cp>                obj-&gt;queryLocalInterface(                               \</span>
<span class=cp>                    I##INTERFACE::descriptor).get());               \</span>
<span class=cp>            if (intr == NULL) {                                         \</span>
<span class=cp>                intr = new Bp##INTERFACE(obj);                          \</span>
<span class=cp>            }                                                           \</span>
<span class=cp>        }                                                               \</span>
<span class=cp>        return intr;                                                    \</span>
<span class=cp>    }                                                                   \</span>
<span class=cp>    I##INTERFACE::I##INTERFACE() { }                                    \</span>
<span class=cp>    I##INTERFACE::~I##INTERFACE() { }                                   \</span>
</code></pre></div> <p>在上面的代码中，把INTERFACE换成ServiceManager理解就行了。这就是这两个宏为IServiceManager类声明、实现了一些变量和函数。</p> <p>也就是说<code>IServiceManager::asInterface</code>等于下面这段代码：</p> <div class=highlight><pre><span></span><code><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>IServiceManager</span><span class=o>::</span><span class=n>asInterface</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>obj</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>intr</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>obj</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>intr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>static_cast</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>*&gt;</span><span class=p>(</span><span class=w></span>
<span class=w>            </span><span class=n>obj</span><span class=o>-&gt;</span><span class=n>queryLocalInterface</span><span class=p>(</span><span class=w></span>
<span class=w>                </span><span class=n>IServiceManager</span><span class=o>::</span><span class=n>descriptor</span><span class=p>).</span><span class=n>get</span><span class=p>());</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>intr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>intr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>BpServiceManager</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>intr</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>所以<code>interface_cast&lt;IServiceManager&gt;(new BpBinder(0))</code>等于<code>new BpServiceManager(new BpBinder(0))</code>。 </p> <p>这里又是一个Bp...</p> <h2 id=5-bpservicemanager>5 BpServiceManager<a class=headerlink href=#5-bpservicemanager title="Permanent link">&para;</a></h2> <p>啥是Bp？？这里的p就是proxy的意思，Bp就是BinderProxy，BpServiceManager，就是ServiceManager的Binder代理。<br> BpServiceManager就在IServiceManager.cpp中 </p> <div class=highlight><pre><span></span><code><span class=n>class</span><span class=w> </span><span class=n>BpServiceManager</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>BpInterface</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=n>public</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=c1>// 这个传入的impl就是BpBinder(0)</span>
<span class=w>    </span><span class=n>BpServiceManager</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>impl</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>BpInterface</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=p>(</span><span class=n>impl</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// 见后续</span>
<span class=w>    </span><span class=n>virtual</span><span class=w> </span><span class=n>status_t</span><span class=w> </span><span class=n>addService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String16</span><span class=o>&amp;</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>service</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>};</span><span class=w></span>

<span class=n>IMPLEMENT_META_INTERFACE</span><span class=p>(</span><span class=n>ServiceManager</span><span class=p>,</span><span class=w> </span><span class=s>&quot;android.os.IServiceManager&quot;</span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>接着看一下BpInterface<iservicemanager>(impl)干了什么。 </p> <div class=highlight><pre><span></span><code><span class=n>template</span><span class=o>&lt;</span><span class=n>typename</span><span class=w> </span><span class=n>INTERFACE</span><span class=o>&gt;</span><span class=w></span>
<span class=kr>inline</span><span class=w> </span><span class=n>BpInterface</span><span class=o>&lt;</span><span class=n>INTERFACE</span><span class=o>&gt;::</span><span class=n>BpInterface</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>remote</span><span class=p>)</span><span class=w></span>
<span class=o>:</span><span class=w> </span><span class=n>BpRefBase</span><span class=p>(</span><span class=n>remote</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>BpRefBase</span><span class=o>::</span><span class=n>BpRefBase</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w></span>
<span class=o>:</span><span class=w> </span><span class=n>mRemote</span><span class=p>(</span><span class=n>o</span><span class=p>.</span><span class=n>get</span><span class=p>()),</span><span class=w> </span><span class=n>mRefs</span><span class=p>(</span><span class=nb>NULL</span><span class=p>),</span><span class=w> </span><span class=n>mState</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>extendObjectLifetime</span><span class=p>(</span><span class=n>OBJECT_LIFETIME_WEAK</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=c1>// 这里的mRemote就是BpBinder(0)</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mRemote</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>mRemote</span><span class=o>-&gt;</span><span class=n>incStrong</span><span class=p>(</span><span class=n>this</span><span class=p>);</span><span class=w>           </span><span class=c1>// Removed on first IncStrong().</span>
<span class=w>        </span><span class=n>mRefs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mRemote</span><span class=o>-&gt;</span><span class=n>createWeak</span><span class=p>(</span><span class=n>this</span><span class=p>);</span><span class=w>  </span><span class=c1>// Held for our entire lifetime.</span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>因此，我们知道了创建<code>BpServiceManager</code>时的<code>BpBinder(0)</code>就存在其<code>mRemote</code>字段中。</p> <p>重新回到<code>main</code>函数，现在我们打开了binder设备，并且创建了一个<code>BpServiceManager</code>对象。我们接下来看看<code>MediaPlayerService::instantiate();</code>操作。 </p> <h2 id=6-mediaplayerservice>6 MediaPlayerService<a class=headerlink href=#6-mediaplayerservice title="Permanent link">&para;</a></h2> <p><strong>frameworks/base/media/libmediaplayerservice/MediaPlayerService.cpp</strong> </p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>MediaPlayerService::instantiate</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// 调用BpServiceManager的addService方法，</span>
<span class=w>    </span><span class=c1>// 传入服务的名字以及服务</span>
<span class=w>    </span><span class=n>defaultServiceManager</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>addService</span><span class=p>(</span><span class=w></span>
<span class=w>                                        </span><span class=n>String16</span><span class=p>(</span><span class=s>&quot;media.player&quot;</span><span class=p>),</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>MediaPlayerService</span><span class=p>());</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>MediaPlayerService</span><span class=o>::</span><span class=n>MediaPlayerService</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;MediaPlayerService created&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>mNextConnId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>从头文件可以看出，<code>MediaPlayerService</code>是从<code>BnMediaPlayerService</code>派生出来的。 </p> <div class=highlight><pre><span></span><code><span class=n>class</span><span class=w> </span><span class=n>MediaPlayerService</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>BnMediaPlayerService</span><span class=w></span>
</code></pre></div> <p><strong>Bn是Binder Native的意思，与Bp相对应。</strong><br> 到目前为止，我们已经构造出来了<code>BpServiceManager</code>和<code>BnMediaPlayerService</code>。但这俩不是对应的两端，因为Bp/Bn后面的名称不相同。</p> <h2 id=7-bpserviewmanageraddservice>7 BpServiewManager#addService<a class=headerlink href=#7-bpserviewmanageraddservice title="Permanent link">&para;</a></h2> <p>再回头看一下<code>BpServiewManager#addService</code>方法的实现。</p> <div class=highlight><pre><span></span><code><span class=n>virtual</span><span class=w> </span><span class=n>status_t</span><span class=w> </span><span class=n>addService</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String16</span><span class=o>&amp;</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>service</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// data是发送到BnServiceManager的命令包  </span>
<span class=w>    </span><span class=c1>// reply是收到的答复</span>
<span class=w>    </span><span class=n>Parcel</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>reply</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// IServiceManager::getInterfaceDescriptor()就是包名:android.os.IServiceManager</span>
<span class=w>    </span><span class=n>data</span><span class=p>.</span><span class=n>writeInterfaceToken</span><span class=p>(</span><span class=n>IServiceManager</span><span class=o>::</span><span class=n>getInterfaceDescriptor</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=c1>// 写入Service的名字以及引用</span>
<span class=w>    </span><span class=n>data</span><span class=p>.</span><span class=n>writeString16</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>data</span><span class=p>.</span><span class=n>writeStrongBinder</span><span class=p>(</span><span class=n>service</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=c1>// 调用BpBinder的transact函数</span>
<span class=w>    </span><span class=n>status_t</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>remote</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=n>ADD_SERVICE_TRANSACTION</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>reply</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NO_ERROR</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>reply</span><span class=p>.</span><span class=n>readInt32</span><span class=p>()</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>接着看<code>BpBinder#transact</code>函数 </p> <div class=highlight><pre><span></span><code><span class=n>status_t</span><span class=w> </span><span class=nf>BpBinder::transact</span><span class=p>(</span><span class=w></span>
<span class=w>                            </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Parcel</span><span class=o>&amp;</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>Parcel</span><span class=o>*</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// Once a binder has died, it will never come back to life.</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAlive</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// 调用了IPCThreadState的transact函数</span>
<span class=w>        </span><span class=c1>// mHandle=0, code=ADD_SERVICE_TRANSACTION, data、reply同上, flags默认为0</span>
<span class=w>        </span><span class=n>status_t</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=w></span>
<span class=w>                                                            </span><span class=n>mHandle</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>DEAD_OBJECT</span><span class=p>)</span><span class=w> </span><span class=n>mAlive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>status</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>DEAD_OBJECT</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>IPCThreadState在创建BpBinder的时候就创建了，再看看<code>IPCThreadState#transact</code>函数 </p> <div class=highlight><pre><span></span><code><span class=n>status_t</span><span class=w> </span><span class=nf>IPCThreadState::transact</span><span class=p>(</span><span class=kt>int32_t</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=w></span>
<span class=w>                                    </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Parcel</span><span class=o>&amp;</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w></span>
<span class=w>                                    </span><span class=n>Parcel</span><span class=o>*</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>status_t</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>errorCheck</span><span class=p>();</span><span class=w></span>

<span class=w>    </span><span class=n>flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>TF_ACCEPT_FDS</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>         </span><span class=c1>// 调用writeTransactionData函数发送数据</span>
<span class=w>        </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>writeTransactionData</span><span class=p>(</span><span class=n>BC_TRANSACTION</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reply</span><span class=p>)</span><span class=w> </span><span class=n>reply</span><span class=o>-&gt;</span><span class=n>setError</span><span class=p>(</span><span class=n>err</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>mLastError</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>err</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// TF_ONE_WAY = 0x01</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>TF_ONE_WAY</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reply</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// 应该走这个</span>
<span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitForResponse</span><span class=p>(</span><span class=n>reply</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>Parcel</span><span class=w> </span><span class=n>fakeReply</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitForResponse</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fakeReply</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>waitForResponse</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// 写数据到mOut中</span>
<span class=n>status_t</span><span class=w> </span><span class=nf>IPCThreadState::writeTransactionData</span><span class=p>(</span><span class=kt>int32_t</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>binderFlags</span><span class=p>,</span><span class=w></span>
<span class=w>                                                </span><span class=kt>int32_t</span><span class=w> </span><span class=n>handle</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Parcel</span><span class=o>&amp;</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>status_t</span><span class=o>*</span><span class=w> </span><span class=n>statusBuffer</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>binder_transaction_data</span><span class=w> </span><span class=n>tr</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>tr</span><span class=p>.</span><span class=n>target</span><span class=p>.</span><span class=n>handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>handle</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>tr</span><span class=p>.</span><span class=n>code</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>code</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>tr</span><span class=p>.</span><span class=n>flags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>binderFlags</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>status_t</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>errorCheck</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>data_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>ipcDataSize</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>ipcData</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>offsets_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>ipcObjectsCount</span><span class=p>()</span><span class=o>*</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>size_t</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>offsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=n>ipcObjects</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>statusBuffer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>TF_STATUS_CODE</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=o>*</span><span class=n>statusBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>data_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>status_t</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>statusBuffer</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>offsets_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>offsets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>NULL</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>mLastError</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>err</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// 上面把命令数据封装成binder_transaction_data，然后</span>
<span class=w>    </span><span class=c1>// 写到mOut中，mOut是命令的缓冲区，也是一个Parcel</span>
<span class=w>    </span><span class=n>mOut</span><span class=p>.</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>mOut</span><span class=p>.</span><span class=n>write</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tr</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>tr</span><span class=p>));</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>status_t</span><span class=w> </span><span class=nf>IPCThreadState::waitForResponse</span><span class=p>(</span><span class=n>Parcel</span><span class=w> </span><span class=o>*</span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=n>status_t</span><span class=w> </span><span class=o>*</span><span class=n>acquireResult</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>cmd</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>int32_t</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// talkWithDriver，挺关键的</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>err</span><span class=o>=</span><span class=n>talkWithDriver</span><span class=p>())</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mIn</span><span class=p>.</span><span class=n>errorCheck</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mIn</span><span class=p>.</span><span class=n>dataAvail</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>continue</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=c1>// talkWithDriver中应该把mOut发出去，然后接受数据到mIn中</span>
<span class=w>        </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mIn</span><span class=p>.</span><span class=n>readInt32</span><span class=p>();</span><span class=w></span>

<span class=w>        </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>case</span><span class=w> </span><span class=no>BR_TRANSACTION_COMPLETE</span><span class=p>:</span><span class=w></span>
<span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>reply</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>acquireResult</span><span class=p>)</span><span class=w> </span><span class=k>goto</span><span class=w> </span><span class=n>finish</span><span class=p>;</span><span class=w></span>
<span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>                </span><span class=p>...</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=nl>finish</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>status_t</span><span class=w> </span><span class=nf>IPCThreadState::talkWithDriver</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>doReceive</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>binder_write_read</span><span class=w> </span><span class=n>bwr</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=c1>// ...省略一堆判断</span>
<span class=w>    </span><span class=n>status_t</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// ioctl来对binder进行读写</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ioctl</span><span class=p>(</span><span class=n>mProcess</span><span class=o>-&gt;</span><span class=n>mDriverFD</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_WRITE_READ</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>bwr</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>else</span><span class=w></span>
<span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>errno</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=n>EINTR</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>err</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=p>(</span><span class=kt>ssize_t</span><span class=p>)</span><span class=n>mOut</span><span class=p>.</span><span class=n>dataSize</span><span class=p>())</span><span class=w></span>
<span class=w>                </span><span class=n>mOut</span><span class=p>.</span><span class=n>remove</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w></span>
<span class=w>                </span><span class=n>mOut</span><span class=p>.</span><span class=n>setDataSize</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=c1>// 回复数据会写入mIn中</span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>mIn</span><span class=p>.</span><span class=n>setDataSize</span><span class=p>(</span><span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>mIn</span><span class=p>.</span><span class=n>setDataPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>至此，<code>BpServiceManager</code>发送<code>addService</code>消息，然后收到了回复。 </p> <p>说道<code>BpServiceManager</code>，顺便先说说<code>BnServiceManager</code>。</p> <h2 id=8-bnservicemanager>8 BnServiceManager<a class=headerlink href=#8-bnservicemanager title="Permanent link">&para;</a></h2> <p><code>defaultServiceManager</code>返回的是一个<code>BpServiceManager</code>，通过它可以把命令请求发送到binder设备，而且handle的值为0。<br> 那么，系统的另外一端肯定有个接收命令的。虽然<code>BnServiceManager</code>接收到了命令，但是并没有完成它应该干的的工作。<code>service_manager.c</code>干了这份工作，我们看看它就好了。 </p> <p>关于Service Manager更详细的内容，可以看2.2节。</p> <p><strong>frameworks/base/cmds/servicemanager/service_manager.c</strong></p> <div class=highlight><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>**</span><span class=n>argv</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>bs</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>svcmgr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BINDER_SERVICE_MANAGER</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// 打开binder设备</span>
<span class=w>    </span><span class=n>bs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>binder_open</span><span class=p>(</span><span class=mi>128</span><span class=o>*</span><span class=mi>1024</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// 成为manager</span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>binder_become_context_manager</span><span class=p>(</span><span class=n>bs</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;cannot become context manager (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>svcmgr_handle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>svcmgr</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// 不断循环，处理BpServiceManager发过来的命令</span>
<span class=w>    </span><span class=n>binder_loop</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=n>svcmgr_handler</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><strong>frameworks/base/cmds/servicemanager/binder.c</strong></p> <div class=highlight><pre><span></span><code><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>binder_open</span><span class=p>(</span><span class=kt>unsigned</span><span class=w> </span><span class=n>mapsize</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>bs</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>bs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>bs</span><span class=p>));</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>bs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ENOMEM</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// 打开binder设备</span>
<span class=w>    </span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>open</span><span class=p>(</span><span class=s>&quot;/dev/binder&quot;</span><span class=p>,</span><span class=w> </span><span class=n>O_RDWR</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&quot;binder: cannot open device (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>fail_open</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>mapsize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mapsize</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>mapped</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mmap</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>mapsize</span><span class=p>,</span><span class=w> </span><span class=n>PROT_READ</span><span class=p>,</span><span class=w> </span><span class=n>MAP_PRIVATE</span><span class=p>,</span><span class=w> </span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>mapped</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_FAILED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=s>&quot;binder: cannot map device (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>fail_map</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=cm>/* TODO: check version */</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>bs</span><span class=p>;</span><span class=w></span>

<span class=nl>fail_map</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=n>close</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>);</span><span class=w></span>
<span class=nl>fail_open</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=n>free</span><span class=p>(</span><span class=n>bs</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>返回来看看<code>binder_become_context_manager</code>和<code>binder_loop</code>函数 </p> <div class=highlight><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=nf>binder_become_context_manager</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>bs</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// 通过ioctl，使自己成为manager</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ioctl</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_SET_CONTEXT_MGR</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kt>void</span><span class=w> </span><span class=nf>binder_loop</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=n>binder_handler</span><span class=w> </span><span class=n>func</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>binder_write_read</span><span class=w> </span><span class=n>bwr</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>readbuf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span><span class=w></span>

<span class=w>    </span><span class=n>bwr</span><span class=p>.</span><span class=n>write_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>bwr</span><span class=p>.</span><span class=n>write_consumed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>bwr</span><span class=p>.</span><span class=n>write_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>readbuf</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BC_ENTER_LOOPER</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>binder_write</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=n>readbuf</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>unsigned</span><span class=p>));</span><span class=w></span>

<span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(;;)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// 循环读写binder</span>
<span class=w>        </span><span class=n>bwr</span><span class=p>.</span><span class=n>read_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>readbuf</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>bwr</span><span class=p>.</span><span class=n>read_buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>unsigned</span><span class=p>)</span><span class=w> </span><span class=n>readbuf</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ioctl</span><span class=p>(</span><span class=n>bs</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_WRITE_READ</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>bwr</span><span class=p>);</span><span class=w></span>

<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;binder_loop: ioctl failed (%s)</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=c1>// 调用func解析收到的命令</span>
<span class=w>        </span><span class=c1>// func就是svcmgr_handler</span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>binder_parse</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>readbuf</span><span class=p>,</span><span class=w> </span><span class=n>bwr</span><span class=p>.</span><span class=n>read_consumed</span><span class=p>,</span><span class=w> </span><span class=n>func</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;binder_loop: unexpected reply?!</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;binder_loop: io error %d %s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>res</span><span class=p>,</span><span class=w> </span><span class=n>strerror</span><span class=p>(</span><span class=n>errno</span><span class=p>));</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kt>int</span><span class=w> </span><span class=nf>svcmgr_handler</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>bs</span><span class=p>,</span><span class=w></span>
<span class=w>                   </span><span class=k>struct</span><span class=w> </span><span class=nc>binder_txn</span><span class=w> </span><span class=o>*</span><span class=n>txn</span><span class=p>,</span><span class=w></span>
<span class=w>                   </span><span class=k>struct</span><span class=w> </span><span class=nc>binder_io</span><span class=w> </span><span class=o>*</span><span class=n>msg</span><span class=p>,</span><span class=w></span>
<span class=w>                   </span><span class=k>struct</span><span class=w> </span><span class=nc>binder_io</span><span class=w> </span><span class=o>*</span><span class=n>reply</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>svcinfo</span><span class=w> </span><span class=o>*</span><span class=n>si</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>uint16_t</span><span class=w> </span><span class=o>*</span><span class=n>s</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>unsigned</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>len</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>switch</span><span class=p>(</span><span class=n>txn</span><span class=o>-&gt;</span><span class=n>code</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>SVC_MGR_ADD_SERVICE</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bio_get_string16</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>len</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>bio_get_ref</span><span class=p>(</span><span class=n>msg</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=c1>// 此方法就是真正添加BnMediaService的函数</span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>do_add_service</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>,</span><span class=w> </span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=n>txn</span><span class=o>-&gt;</span><span class=n>sender_euid</span><span class=p>))</span><span class=w></span>
<span class=w>                </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>bio_put_uint32</span><span class=p>(</span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// do_add_service是真正添加BnMediaService的函数</span>
<span class=kt>int</span><span class=w> </span><span class=nf>do_add_service</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>binder_state</span><span class=w> </span><span class=o>*</span><span class=n>bs</span><span class=p>,</span><span class=w></span>
<span class=w>                   </span><span class=kt>uint16_t</span><span class=w> </span><span class=o>*</span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=n>len</span><span class=p>,</span><span class=w></span>
<span class=w>                   </span><span class=kt>void</span><span class=w> </span><span class=o>*</span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=n>uid</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>svcinfo</span><span class=w> </span><span class=o>*</span><span class=n>si</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>));</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>si</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>LOGE</span><span class=p>(</span><span class=s>&quot;add_service(&#39;%s&#39;,%p) uid=%d - OUT OF MEMORY</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>str8</span><span class=p>(</span><span class=n>s</span><span class=p>),</span><span class=w> </span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=n>uid</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=o>-&gt;</span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ptr</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=o>-&gt;</span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>len</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>memcpy</span><span class=p>(</span><span class=n>si</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>uint16_t</span><span class=p>));</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>[</span><span class=n>len</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sc>&#39;\0&#39;</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=o>-&gt;</span><span class=n>death</span><span class=p>.</span><span class=n>func</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>svcinfo_death</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=o>-&gt;</span><span class=n>death</span><span class=p>.</span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>si</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>si</span><span class=o>-&gt;</span><span class=n>next</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>svclist</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=c1>// struct svcinfo</span>
<span class=w>    </span><span class=c1>// {</span>
<span class=w>    </span><span class=c1>//     struct svcinfo *next;</span>
<span class=w>    </span><span class=c1>//     void *ptr;</span>
<span class=w>    </span><span class=c1>//     struct binder_death death;</span>
<span class=w>    </span><span class=c1>//     unsigned len;</span>
<span class=w>    </span><span class=c1>//     uint16_t name[0];</span>
<span class=w>    </span><span class=c1>// };</span>
<span class=w>    </span><span class=c1>// struct svcinfo *svclist = 0;</span>
<span class=w>    </span><span class=c1>//</span>
<span class=w>    </span><span class=c1>// svclist是一个链表，将si插入到链表的头部</span>
<span class=w>    </span><span class=c1>// 这样就保存了当前注册到ServiceManager中的信息</span>
<span class=w>    </span><span class=n>svclist</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>si</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>binder_acquire</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=n>ptr</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>binder_link_to_death</span><span class=p>(</span><span class=n>bs</span><span class=p>,</span><span class=w> </span><span class=n>ptr</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>si</span><span class=o>-&gt;</span><span class=n>death</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在上面的过程中，我们已经看到了<code>MediaPlayerService</code>是如何注册到<code>ServiceManager</code>中的。</p> <h2 id=9-servicemanager>9 ServiceManager存在的意义<a class=headerlink href=#9-servicemanager title="Permanent link">&para;</a></h2> <p><strong>Service Manager是一个守护进程，用来管理Server，并向Client提供查询Server接口的能力</strong>。Android系统中Service信息都是先add到ServiceManager中，由ServiceManager来集中管理，这样就可以查询当前系统有哪些服务。而且，Android系统中某个服务例如MediaPlayerService的客户端想要和MediaPlayerService通讯的话，必须先向ServiceManager查询MediaPlayerService的信息，然后通过ServiceManager返回的东西再来和MediaPlayerService交互。</p> <p>毕竟，要是MediaPlayerService身体不好，老是挂掉的话，客户的代码就麻烦了，就不知道后续新生的MediaPlayerService的信息了，所以只能这样：</p> <ul> <li>MediaPlayerService向ServiceManager注册</li> <li>MediaPlayerClient查询当前注册在ServiceManager中的MediaPlayerService的信息</li> <li>根据这个信息，MediaPlayerClient和MediaPlayerService交互</li> </ul> <p>另外，ServiceManager的handle标示是0，所以只要往handle是0的服务发送消息了，最终都会被传递到ServiceManager中去。</p> <h2 id=10-mediaservice>10 MediaService的运行<a class=headerlink href=#10-mediaservice title="Permanent link">&para;</a></h2> <p>在上一节的分析中，我们知道了：<code>defaultServiceManager()</code>得到了一个<code>BpServiceManager</code>，然后在<code>MediaPlayerService::instantiate()</code>的过程中会进行<code>addService</code>的操作。<br> 然后service_manager会进行<code>binder_looper</code>，专门等着从binder中接收请求。虽然service_manager没有从<code>BnServiceManager</code>中派生，但是它肯定完成了<code>BnServiceManager</code>的功能。</p> <p>同样，我们在上面已经看到了创建<code>MediaPlayerService</code>的过程，它继承至<code>BnMediaPlayerService</code>。那么，它也应该打开binder，然后进入loop状态。</p> <p>在<a href=#1-processstate>ProcessState</a>中，我们看到这里已经打开了binder。一个进程只需要打开binder一次就行了，接下来看看哪里有loop。</p> <p>在<code>main_mediaserver.cpp</code>文件中还有最后的两行代码没有分析，我们接着往下面分析。 </p> <p>首先看<code>ProcessState::self()-&gt;startThreadPool();</code><br> <strong>frameworks/base/libs/binder/ProcessState.cpp</strong> </p> <div class=highlight><pre><span></span><code><span class=kt>void</span><span class=w> </span><span class=nf>ProcessState::startThreadPool</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>AutoMutex</span><span class=w> </span><span class=n>_l</span><span class=p>(</span><span class=n>mLock</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mThreadPoolStarted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>mThreadPoolStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>spawnPooledThread</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kt>void</span><span class=w> </span><span class=nf>ProcessState::spawnPooledThread</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>isMain</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mThreadPoolStarted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kt>int32_t</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>android_atomic_add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mThreadPoolSeq</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=mi>32</span><span class=p>];</span><span class=w></span>
<span class=w>        </span><span class=n>sprintf</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Binder Thread #%d&quot;</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;Spawning new pooled thread, name=%s</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=c1>// 创建一个PoolThread，isMain为true，然后run起来</span>
<span class=w>        </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>PoolThread</span><span class=p>(</span><span class=n>isMain</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>t</span><span class=o>-&gt;</span><span class=n>run</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>接着看一下<code>ThreadPool</code>和<code>Thread</code>的构造函数 </p> <div class=highlight><pre><span></span><code><span class=c1>// PoolThread继承至Thread</span>
<span class=n>class</span><span class=w> </span><span class=n>PoolThread</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>Thread</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=n>public</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=n>PoolThread</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>isMain</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>mIsMain</span><span class=p>(</span><span class=n>isMain</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=n>protected</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=p>};</span><span class=w></span>


<span class=c1>// frameworks/base/include/utils/threads.h</span>
<span class=n>class</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>virtual</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>RefBase</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=n>public</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=c1>// Create a Thread object, but doesn&#39;t create or start the associated</span>
<span class=w>    </span><span class=c1>// thread. See the run() method.</span>
<span class=w>                        </span><span class=n>Thread</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>canCallJava</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>

<span class=w>    </span><span class=c1>// Start the thread in threadLoop() which needs to be implemented.</span>
<span class=w>    </span><span class=n>virtual</span><span class=w> </span><span class=n>status_t</span><span class=w>    </span><span class=n>run</span><span class=p>(</span><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<span class=w>                                </span><span class=kt>int32_t</span><span class=w> </span><span class=n>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PRIORITY_DEFAULT</span><span class=p>,</span><span class=w></span>
<span class=w>                                </span><span class=kt>size_t</span><span class=w> </span><span class=n>stack</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=p>};</span><span class=w></span>

<span class=c1>// frameworks/base/libs/utils/Threads.cpp</span>
<span class=c1>//</span>
<span class=c1>// canCallJava从声明来看默认是true</span>
<span class=n>Thread</span><span class=o>::</span><span class=n>Thread</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>canCallJava</span><span class=p>)</span><span class=w></span>
<span class=w>    </span><span class=o>:</span><span class=w>   </span><span class=n>mCanCallJava</span><span class=p>(</span><span class=n>canCallJava</span><span class=p>),</span><span class=w></span>
<span class=w>        </span><span class=n>mThread</span><span class=p>(</span><span class=n>thread_id_t</span><span class=p>(</span><span class=mi>-1</span><span class=p>)),</span><span class=w></span>
<span class=w>        </span><span class=n>mLock</span><span class=p>(</span><span class=s>&quot;Thread::mLock&quot;</span><span class=p>),</span><span class=w></span>
<span class=w>        </span><span class=n>mStatus</span><span class=p>(</span><span class=n>NO_ERROR</span><span class=p>),</span><span class=w></span>
<span class=w>        </span><span class=n>mExitPending</span><span class=p>(</span><span class=nb>false</span><span class=p>),</span><span class=w> </span><span class=n>mRunning</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// new PoolThread(isMain);  t-&gt;run(buf);</span>
<span class=c1>// 实际上调用的是基类也就是下面的run方法</span>
<span class=c1>// priority默认是PRIORITY_DEFAULT， stack默认为0</span>
<span class=n>status_t</span><span class=w> </span><span class=n>Thread</span><span class=o>::</span><span class=n>run</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>int32_t</span><span class=w> </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>stack</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Mutex</span><span class=o>::</span><span class=n>Autolock</span><span class=w> </span><span class=nf>_l</span><span class=p>(</span><span class=n>mLock</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mRunning</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// thread already started</span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>INVALID_OPERATION</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// reset status and exitPending to their default value, so we can</span>
<span class=w>    </span><span class=c1>// try again after an error happened (either below, or in readyToRun())</span>
<span class=w>    </span><span class=n>mStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>mExitPending</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>mThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread_id_t</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=c1>// hold a strong reference on ourself</span>
<span class=w>    </span><span class=n>mHoldSelf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>this</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>mRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mCanCallJava</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// Create thread with lots of parameters</span>
<span class=w>        </span><span class=c1>// mCanCallJava默认是true，entryFunction是_threadLoop</span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createThreadEtc</span><span class=p>(</span><span class=n>_threadLoop</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>this</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>stack</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mThread</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>androidCreateRawThreadEtc</span><span class=p>(</span><span class=n>_threadLoop</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>this</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>stack</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>mThread</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>res</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>false</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>mStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>UNKNOWN_ERROR</span><span class=p>;</span><span class=w>   </span><span class=c1>// something happened!</span>
<span class=w>        </span><span class=n>mRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=n>mThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread_id_t</span><span class=p>(</span><span class=mi>-1</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>mHoldSelf</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w>  </span><span class=c1>// &quot;this&quot; may have gone away after this.</span>

<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UNKNOWN_ERROR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=c1>// Do not refer to mStatus here: The thread is already running (may, in fact</span>
<span class=w>    </span><span class=c1>// already have exited with a valid mStatus result). The NO_ERROR indication</span>
<span class=w>    </span><span class=c1>// here merely indicates successfully starting the thread and does not</span>
<span class=w>    </span><span class=c1>// imply successful termination/execution.</span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在<code>createThreadEtc(_threadLoop, this, name, priority, stack, &amp;mThread)</code>函数中开始创建了线程，并在过程中会调用<code>_threadLoop</code>函数。<br> 我们看看<code>_threadLoop</code>里面干了啥： </p> <div class=highlight><pre><span></span><code><span class=kt>int</span><span class=w> </span><span class=nf>Thread::_threadLoop</span><span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>user</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Thread</span><span class=o>*</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>self</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>static_cast</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>user</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>strong</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mHoldSelf</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>wp</span><span class=o>&lt;</span><span class=n>Thread</span><span class=o>&gt;</span><span class=w> </span><span class=n>weak</span><span class=p>(</span><span class=n>strong</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mHoldSelf</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w></span>

<span class=w>    </span><span class=c1>// this is very useful for debugging with gdb</span>
<span class=w>    </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mTid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>gettid</span><span class=p>();</span><span class=w></span>

<span class=w>    </span><span class=kt>bool</span><span class=w> </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kt>bool</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>first</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>first</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>readyToRun</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mStatus</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>);</span><span class=w></span>

<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mExitPending</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=c1>// Binder threads (and maybe others) rely on threadLoop</span>
<span class=w>                </span><span class=c1>// running at least once after a successful ::readyToRun()</span>
<span class=w>                </span><span class=c1>// (unless, of course, the thread has already been asked to exit</span>
<span class=w>                </span><span class=c1>// at that point).</span>
<span class=w>                </span><span class=c1>// This is because threads are essentially used like this:</span>
<span class=w>                </span><span class=c1>//   (new ThreadSubclass())-&gt;run();</span>
<span class=w>                </span><span class=c1>// The caller therefore does not retain a strong reference to</span>
<span class=w>                </span><span class=c1>// the thread and the thread would simply disappear after the</span>
<span class=w>                </span><span class=c1>// successful ::readyToRun() call instead of entering the</span>
<span class=w>                </span><span class=c1>// threadLoop at least once.</span>
<span class=w>                </span><span class=c1>//</span>
<span class=w>                </span><span class=c1>// 调用自己的threadLoop</span>
<span class=w>                </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>threadLoop</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// 调用自己的threadLoop</span>
<span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>threadLoop</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>false</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mExitPending</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mExitPending</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mLock</span><span class=p>.</span><span class=n>lock</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mRunning</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mThreadExitedCondition</span><span class=p>.</span><span class=n>broadcast</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=n>self</span><span class=o>-&gt;</span><span class=n>mLock</span><span class=p>.</span><span class=n>unlock</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=c1>// Release our strong reference, to let a chance to the thread</span>
<span class=w>        </span><span class=c1>// to die a peaceful death.</span>
<span class=w>        </span><span class=n>strong</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=c1>// And immediately, re-acquire a strong reference for the next loop</span>
<span class=w>        </span><span class=n>strong</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>weak</span><span class=p>.</span><span class=n>promote</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=n>strong</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>virtual</span><span class=w> </span><span class=kt>bool</span><span class=w> </span><span class=n>threadLoop</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// mIsMain为true。</span>
<span class=w>    </span><span class=c1>// 而且注意，这是一个新的线程，所以必然会创建一个</span>
<span class=w>    </span><span class=c1>// 新的IPCThreadState对象（TLS）</span>
<span class=w>    </span><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>self</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>joinThreadPool</span><span class=p>(</span><span class=n>mIsMain</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>主线程和Binder工作线程都调用了<code>IPCThreadState::joinThreadPool();</code>方法，看看干了什么 </p> <div class=highlight><pre><span></span><code><span class=c1>// frameworks/base/include/binder/IPCThreadState.h</span>
<span class=n>class</span><span class=w> </span><span class=n>IPCThreadState</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=n>public</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=k>static</span><span class=w>  </span><span class=n>IPCThreadState</span><span class=o>*</span><span class=w>     </span><span class=n>self</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=kt>void</span><span class=w>                </span><span class=n>joinThreadPool</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>isMain</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>true</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// frameworks/base/include/binder/IPCThreadState.cpp</span>
<span class=kt>void</span><span class=w> </span><span class=n>IPCThreadState</span><span class=o>::</span><span class=n>joinThreadPool</span><span class=p>(</span><span class=kt>bool</span><span class=w> </span><span class=n>isMain</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>mOut</span><span class=p>.</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>isMain</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>BC_ENTER_LOOPER</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>BC_REGISTER_LOOPER</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=n>status_t</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=c1>// 这个do-while循环就完成了loop的事情</span>
<span class=w>    </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kt>int32_t</span><span class=w> </span><span class=n>cmd</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>        </span><span class=c1>// now get the next command to be processed, waiting if necessary</span>
<span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>talkWithDriver</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=p>...</span><span class=w></span>
<span class=w>            </span><span class=n>cmd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mIn</span><span class=p>.</span><span class=n>readInt32</span><span class=p>();</span><span class=w></span>
<span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>executeCommand</span><span class=p>(</span><span class=n>cmd</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=p>...</span><span class=w></span>

<span class=w>        </span><span class=c1>// Let this thread exit the thread pool if it is no longer</span>
<span class=w>        </span><span class=c1>// needed and it is not the main process thread.</span>
<span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>TIMED_OUT</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isMain</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=o>-</span><span class=n>ECONNREFUSED</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=o>-</span><span class=n>EBADF</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=p>...</span><span class=w></span>

<span class=w>    </span><span class=n>mOut</span><span class=p>.</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>BC_EXIT_LOOPER</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>talkWithDriver</span><span class=p>(</span><span class=nb>false</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在上面我们终于看到了loop的操作，接下来看一下里面的<code>executeCommand</code>函数干了什么： </p> <div class=highlight><pre><span></span><code><span class=n>status_t</span><span class=w> </span><span class=nf>IPCThreadState::executeCommand</span><span class=p>(</span><span class=kt>int32_t</span><span class=w> </span><span class=n>cmd</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>BBinder</span><span class=o>*</span><span class=w> </span><span class=n>obj</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>RefBase</span><span class=o>::</span><span class=n>weakref_type</span><span class=o>*</span><span class=w> </span><span class=n>refs</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>status_t</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>BR_TRANSACTION</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// 来了一个BR_TRANSACTION命令，解析成binder_transaction_data结构</span>
<span class=w>            </span><span class=n>binder_transaction_data</span><span class=w> </span><span class=n>tr</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mIn</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=o>&amp;</span><span class=n>tr</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>tr</span><span class=p>));</span><span class=w></span>
<span class=w>            </span><span class=n>LOG_ASSERT</span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>,</span><span class=w></span>
<span class=w>                        </span><span class=s>&quot;Not enough command data for brTRANSACTION&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w></span>

<span class=w>            </span><span class=n>Parcel</span><span class=w> </span><span class=n>buffer</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>buffer</span><span class=p>.</span><span class=n>ipcSetDataReference</span><span class=p>(</span><span class=w></span>
<span class=w>                                           </span><span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=kt>uint8_t</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>buffer</span><span class=p>),</span><span class=w></span>
<span class=w>                                           </span><span class=n>tr</span><span class=p>.</span><span class=n>data_size</span><span class=p>,</span><span class=w></span>
<span class=w>                                           </span><span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=k>const</span><span class=w> </span><span class=kt>size_t</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>data</span><span class=p>.</span><span class=n>ptr</span><span class=p>.</span><span class=n>offsets</span><span class=p>),</span><span class=w></span>
<span class=w>                                           </span><span class=n>tr</span><span class=p>.</span><span class=n>offsets_size</span><span class=o>/</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>size_t</span><span class=p>),</span><span class=w> </span><span class=n>freeBuffer</span><span class=p>,</span><span class=w> </span><span class=n>this</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>...</span><span class=w></span>
<span class=w>            </span><span class=n>Parcel</span><span class=w> </span><span class=n>reply</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=p>...</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>target</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=c1>// 这里调用了BBinder的transact函数</span>
<span class=w>                </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>BBinder</span><span class=o>&gt;</span><span class=w> </span><span class=n>b</span><span class=p>((</span><span class=n>BBinder</span><span class=o>*</span><span class=p>)</span><span class=n>tr</span><span class=p>.</span><span class=n>cookie</span><span class=p>);</span><span class=w></span>
<span class=w>                </span><span class=k>const</span><span class=w> </span><span class=n>status_t</span><span class=w> </span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>error</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=n>reply</span><span class=p>.</span><span class=n>setError</span><span class=p>(</span><span class=n>error</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=k>const</span><span class=w> </span><span class=n>status_t</span><span class=w> </span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>the_context_object</span><span class=o>-&gt;</span><span class=n>transact</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>error</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=n>reply</span><span class=p>.</span><span class=n>setError</span><span class=p>(</span><span class=n>error</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>

<span class=w>            </span><span class=c1>//LOGI(&quot;&lt;&lt;&lt;&lt; TRANSACT from pid %d restore pid %d uid %d\n&quot;,</span>
<span class=w>            </span><span class=c1>//     mCallingPid, origPid, origUid);</span>

<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>tr</span><span class=p>.</span><span class=n>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>TF_ONE_WAY</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>LOG_ONEWAY</span><span class=p>(</span><span class=s>&quot;Sending reply to %d!&quot;</span><span class=p>,</span><span class=w> </span><span class=n>mCallingPid</span><span class=p>);</span><span class=w></span>
<span class=w>                </span><span class=n>sendReply</span><span class=p>(</span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>LOG_ONEWAY</span><span class=p>(</span><span class=s>&quot;NOT sending reply to %d!&quot;</span><span class=p>,</span><span class=w> </span><span class=n>mCallingPid</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=p>...</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>mLastError</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在上面的代码中，发现了一个<code>BBinder</code>类，<strong>实际上理解为<code>BnBinder</code>更好</strong>。<br> 在创建<code>MediaPlayerService</code>时，其继承至<code>BnMediaPlayerService</code>；而<code>BnMediaPlayerService</code>的定义如下</p> <div class=highlight><pre><span></span><code><span class=n>class</span><span class=w> </span><span class=n>BnMediaPlayerService</span><span class=o>:</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>BnInterface</span><span class=o>&lt;</span><span class=n>IMediaPlayerService</span><span class=o>&gt;</span><span class=w></span>
</code></pre></div> <p><code>BnInterface</code>是一个类模板：</p> <div class=highlight><pre><span></span><code><span class=n>template</span><span class=o>&lt;</span><span class=n>typename</span><span class=w> </span><span class=n>INTERFACE</span><span class=o>&gt;</span><span class=w></span>
<span class=n>class</span><span class=w> </span><span class=n>BnInterface</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>INTERFACE</span><span class=p>,</span><span class=w> </span><span class=n>public</span><span class=w> </span><span class=n>BBinder</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=n>public</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=n>virtual</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IInterface</span><span class=o>&gt;</span><span class=w>      </span><span class=n>queryLocalInterface</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>String16</span><span class=o>&amp;</span><span class=w> </span><span class=n>_descriptor</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>virtual</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>String16</span><span class=o>&amp;</span><span class=w>     </span><span class=n>getInterfaceDescriptor</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=p>;</span><span class=w></span>

<span class=n>protected</span><span class=o>:</span><span class=w></span>
<span class=w>    </span><span class=n>virtual</span><span class=w> </span><span class=n>IBinder</span><span class=o>*</span><span class=w>            </span><span class=n>onAsBinder</span><span class=p>();</span><span class=w></span>
<span class=p>};</span><span class=w></span>
</code></pre></div> <p><code>BBinder#transit</code>函数调用了自身的<code>onTransit</code>函数，也就是说最后还是调用了<code>BnMediaPlayerService::onTransact</code>：</p> <div class=highlight><pre><span></span><code><span class=n>status_t</span><span class=w> </span><span class=nf>BBinder::transact</span><span class=p>(</span><span class=w></span>
<span class=w>                            </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Parcel</span><span class=o>&amp;</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>Parcel</span><span class=o>*</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>data</span><span class=p>.</span><span class=n>setDataPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>status_t</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>code</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>PING_TRANSACTION</span><span class=p>:</span><span class=w></span>
<span class=w>            </span><span class=n>reply</span><span class=o>-&gt;</span><span class=n>writeInt32</span><span class=p>(</span><span class=n>pingBinder</span><span class=p>());</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>default</span><span class=o>:</span><span class=w></span>
<span class=w>            </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>onTransact</span><span class=p>(</span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>reply</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>reply</span><span class=o>-&gt;</span><span class=n>setDataPosition</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>err</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=n>status_t</span><span class=w> </span><span class=nf>BnMediaPlayerService::onTransact</span><span class=p>(</span><span class=w></span>
<span class=w>    </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>Parcel</span><span class=o>&amp;</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>Parcel</span><span class=o>*</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=kt>uint32_t</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// BnMediaPlayerService从BBinder和IMediaPlayerService派生</span>
<span class=w>    </span><span class=c1>// 所有IMediaPlayerService提供的函数都通过命令类型来区分</span>
<span class=w>    </span><span class=k>switch</span><span class=p>(</span><span class=n>code</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>case</span><span class=w> </span><span class=no>CREATE_URL</span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>CHECK_INTERFACE</span><span class=p>(</span><span class=n>IMediaPlayerService</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>reply</span><span class=p>);</span><span class=w></span>
<span class=w>            </span><span class=p>...</span><span class=w></span>

<span class=w>            </span><span class=c1>// create是一个由MediaPlayerService实现的虚函数</span>
<span class=w>            </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IMediaPlayer</span><span class=o>&gt;</span><span class=w> </span><span class=n>player</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>create</span><span class=p>(</span><span class=w></span>
<span class=w>                    </span><span class=n>pid</span><span class=p>,</span><span class=w> </span><span class=n>client</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>numHeaders</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=o>&amp;</span><span class=n>headers</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w></span>

<span class=w>            </span><span class=n>reply</span><span class=o>-&gt;</span><span class=n>writeStrongBinder</span><span class=p>(</span><span class=n>player</span><span class=o>-&gt;</span><span class=n>asBinder</span><span class=p>());</span><span class=w></span>
<span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>NO_ERROR</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>...</span><span class=w></span>
<span class=w>        </span><span class=k>default</span><span class=o>:</span><span class=w></span>
<span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>BBinder</span><span class=o>::</span><span class=n>onTransact</span><span class=p>(</span><span class=n>code</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>reply</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>看到上面我们就知道了，其实<code>BnXxx::onTransact</code>函数接收命令，然后转发到派生类的函数<code>IXxx</code>，由他们完成实际的工作。</p> <p><strong>说明</strong>：这里有点特殊，<code>startThreadPool</code>和<code>joinThreadPool</code>完后确实有两个线程：主线程和工作线程，而且都在做消息循环。<br> 为什么要这么做呢？他们参数isMain都是true。不知道google搞什么。难道是怕一个线程工作量太多，所以搞两个线程来工作？这种解释应该也是合理的。<br> 网上有人测试过把最后一句屏蔽掉，也能正常工作。但是难道主线程提出了，程序还能不退出吗？这个...管它的，反正知道有两个线程在那处理就行了。</p> <p><strong>此外，看看<code>MediaPlayerClient</code>如何与<code>MediaPlayerService</code>进行交互。</strong> <br> 使用<code>MediaPlayerService</code>时，要先创建它的<code>BpMediaPlayerService</code>： </p> <p><strong>frameworks/base/media/libmedia/IMediaDeathNotifier.cpp</strong><br> <div class=highlight><pre><span></span><code><span class=c1>// establish binder interface to MediaPlayerService</span>
<span class=cm>/*static*/</span><span class=k>const</span><span class=w> </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IMediaPlayerService</span><span class=o>&gt;&amp;</span><span class=w></span>
<span class=n>IMediaDeathNotifier</span><span class=o>::</span><span class=n>getMediaPlayerService</span><span class=p>()</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>LOGV</span><span class=p>(</span><span class=s>&quot;getMediaPlayerService&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>Mutex</span><span class=o>::</span><span class=n>Autolock</span><span class=w> </span><span class=nf>_l</span><span class=p>(</span><span class=n>sServiceLock</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sMediaPlayerService</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IServiceManager</span><span class=o>&gt;</span><span class=w> </span><span class=n>sm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>defaultServiceManager</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>sp</span><span class=o>&lt;</span><span class=n>IBinder</span><span class=o>&gt;</span><span class=w> </span><span class=n>binder</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=c1>// 向ServiceManager查询对应服务的信息，返回binder</span>
<span class=w>            </span><span class=n>binder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sm</span><span class=o>-&gt;</span><span class=n>getService</span><span class=p>(</span><span class=n>String16</span><span class=p>(</span><span class=s>&quot;media.player&quot;</span><span class=p>));</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>binder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>             </span><span class=p>}</span><span class=w></span>
<span class=w>             </span><span class=n>LOGW</span><span class=p>(</span><span class=s>&quot;Media player service not published, waiting...&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>             </span><span class=n>usleep</span><span class=p>(</span><span class=mi>500000</span><span class=p>);</span><span class=w> </span><span class=c1>// 0.5 s</span>
<span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=p>(</span><span class=nb>true</span><span class=p>);</span><span class=w></span>

<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sDeathNotifier</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=nb>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>sDeathNotifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>new</span><span class=w> </span><span class=n>DeathNotifier</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>binder</span><span class=o>-&gt;</span><span class=n>linkToDeath</span><span class=p>(</span><span class=n>sDeathNotifier</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=c1>// 通过interface_cast，将这个binder转化成BpMediaPlayerService</span>
<span class=w>    </span><span class=c1>// 注意，此处的binder只是用来和binder设备进行通讯</span>
<span class=w>    </span><span class=c1>// 实际上和IMediaPlayerService的功能一点关系都没有</span>
<span class=w>    </span><span class=c1>// BpMediaPlayerService用这个binder和BnMediaPlayerService通讯</span>
<span class=w>    </span><span class=n>sMediaPlayerService</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>interface_cast</span><span class=o>&lt;</span><span class=n>IMediaPlayerService</span><span class=o>&gt;</span><span class=p>(</span><span class=n>binder</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>LOGE_IF</span><span class=p>(</span><span class=n>sMediaPlayerService</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=s>&quot;no media player service!?&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sMediaPlayerService</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></p> <p>Binder其实就是一个和binder设备打交道的接口，而上层IMediaPlayerService只不过把它当做一个类似socket使用罢了。 </p> <h2 id=11>11 小结<a class=headerlink href=#11 title="Permanent link">&para;</a></h2> <p><img alt=ServiceManager的UML类图 src=/assets/images/android/binder_service_manager_uml.png></p> <p>整个MediaServer流程的简单描述如下图：</p> <p><a href=/assets/images/android/binder_mediaserver_progress.png><img alt=MediaServer流程的简单描述 src=/assets/images/android/binder_mediaserver_progress.png></a></p> <ul> <li>client调用service</li> <li>client调用<code>defaultServiceManager-&gt;getService</code>获得一个binder，然后通过<code>interface_cast&lt;IXxxService&gt;(binder)</code>转换成对应的<code>BpXxxService</code></li> <li>调用<code>BpXxxService#foo</code>函数，将需要的参数写入一个<code>Parcel</code>，然后调用<code>remote()-&gt;transact(FOO_CODE_TRANSACTION, data, &amp;reply)</code>函数（可参考BpServiceManager中addService等方法的写法）</li> <li><code>remote()</code>其实就是一个<code>BpBinder</code>对象，其<code>transact</code>函数会调用<code>IPCThreadState::self()-&gt;transact</code>发送数据</li> <li>service回调client</li> <li>在<code>IPCThreadState#joinThreadPool</code>的loop过程中收到了client的请求，会调用<code>BBinder#transact</code>函数</li> <li>该函数会调用<code>BBinder#onTransact</code>虚拟函数，其实现部分由<code>BnXxxService</code>实现</li> <li>在<code>BnXxxService#onTransact</code>函数中会经过code判断是哪种命令，然后解析client数据，执行<code>foo</code>函数的实现部分，最后将结果写入reply中</li> </ul> <hr> <div class=md-source-file> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 8, 2021</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-top--hidden md-icon" data-md-component=top> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class="md-footer__link md-footer__link--prev" aria-label="上一页: Android性能优化" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> Android性能优化 </div> </div> </a> <a href=../binder2/ class="md-footer__link md-footer__link--next" aria-label="下一页: Binder深入理解——罗老师系列" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> Binder深入理解——罗老师系列 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2022 Yorek </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/YorekLiu target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </a> <a href=lyytogether@gmail.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top"], "search": "../../../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.7f366e99.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
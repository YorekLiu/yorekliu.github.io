<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An Android Developer."><meta name=author content="Yorek Liu"><link href=https://blog.yorek.xyz/android/3rd-library/glide2/ rel=canonical><link href=../glide1/ rel=prev><link href=../glide3/ rel=next><link rel=icon href=../../../assets/images/favicon.webp><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.5.3"><title>Glide v4 源码解析（二） - Yorek's Blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.50c56a3b.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans SC";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../../css/timeago.css><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","UA-155096376-1"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","UA-155096376-1",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=UA-155096376-1",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-glidewith class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="Yorek's Blog" class="md-header__button md-logo" aria-label="Yorek's Blog" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Yorek's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Glide v4 源码解析（二） </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../3rd-library-source-code/ class=md-tabs__link> Android </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Yorek's Blog" class="md-nav__button md-logo" aria-label="Yorek's Blog" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> Yorek's Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Android </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class=md-ellipsis> 三方库系列 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 三方库系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ class=md-nav__link> <span class=md-ellipsis> Android三方库源码分析 </span> </a> </li> <li class=md-nav__item> <a href=../matrix/ class=md-nav__link> <span class=md-ellipsis> 微信APM Matrix解析 </span> </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ class=md-nav__link> <span class=md-ellipsis> Matrix-TraceCanary解析 </span> </a> </li> <li class=md-nav__item> <a href=../matrix-trace-plugin/ class=md-nav__link> <span class=md-ellipsis> Matrix-ASM插桩插件解析 </span> </a> </li> <li class=md-nav__item> <a href=../matrix-io/ class=md-nav__link> <span class=md-ellipsis> Matrix-IOCanary解析 </span> </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ class=md-nav__link> <span class=md-ellipsis> Matrix-ResourceCanary解析 </span> </a> </li> <li class=md-nav__item> <a href=../matrix-apk-checker/ class=md-nav__link> <span class=md-ellipsis> Matrix-ApkChecker：安装包分析检测工具 </span> </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ class=md-nav__link> <span class=md-ellipsis> Matrix-SQLiteLint解析 </span> </a> </li> <li class=md-nav__item> <a href=../xhook/ class=md-nav__link> <span class=md-ellipsis> 最常用的PLT Hook框架：xHook </span> </a> </li> <li class=md-nav__item> <a href=../andresguard/ class=md-nav__link> <span class=md-ellipsis> AndResGuard资源混淆原理浅析 </span> </a> </li> <li class=md-nav__item> <a href=../hprof-shrink/ class=md-nav__link> <span class=md-ellipsis> 剖析hprof文件的两种主要裁剪流派 </span> </a> </li> <li class=md-nav__item> <a href=../okhttp/ class=md-nav__link> <span class=md-ellipsis> OkHttp3源码解析 </span> </a> </li> <li class=md-nav__item> <a href=../retrofit/ class=md-nav__link> <span class=md-ellipsis> Retrofit2源码解析 </span> </a> </li> <li class=md-nav__item> <a href=../rxjava%26rxandroid/ class=md-nav__link> <span class=md-ellipsis> RxJava源码解析及使用实例 </span> </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> <span class=md-ellipsis> RxJava操作符大全 </span> </a> </li> <li class=md-nav__item> <a href=../glide1/ class=md-nav__link> <span class=md-ellipsis> Glide v4 源码解析（一） </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Glide v4 源码解析（二） </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Glide v4 源码解析（二） </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-glidewith class=md-nav__link> <span class=md-ellipsis> 1. Glide.with </span> </a> <nav class=md-nav aria-label="1. Glide.with"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-getretrievercontext class=md-nav__link> <span class=md-ellipsis> 1.1 getRetriever(Context) </span> </a> </li> <li class=md-nav__item> <a href=#12-requestmanagerretrieverget class=md-nav__link> <span class=md-ellipsis> 1.2 RequestManagerRetriever.get </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-requestmanagerload class=md-nav__link> <span class=md-ellipsis> 2. RequestManager.load </span> </a> <nav class=md-nav aria-label="2. RequestManager.load"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-requestmanagerasxxx class=md-nav__link> <span class=md-ellipsis> 2.1 RequestManager.asXxx </span> </a> </li> <li class=md-nav__item> <a href=#22-requestbuilderload class=md-nav__link> <span class=md-ellipsis> 2.2 RequestBuilder.load </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-requestbuilderinto class=md-nav__link> <span class=md-ellipsis> 3. RequestBuilder.into </span> </a> <nav class=md-nav aria-label="3. RequestBuilder.into"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-buildrequest class=md-nav__link> <span class=md-ellipsis> 3.1 buildRequest </span> </a> </li> <li class=md-nav__item> <a href=#32-requestmanagertrack class=md-nav__link> <span class=md-ellipsis> 3.2 RequestManager.track </span> </a> </li> <li class=md-nav__item> <a href=#33-engineload class=md-nav__link> <span class=md-ellipsis> 3.3 Engine.load </span> </a> </li> <li class=md-nav__item> <a href=#34-decodejobrun class=md-nav__link> <span class=md-ellipsis> 3.4 DecodeJob.run </span> </a> </li> <li class=md-nav__item> <a href=#35-registry class=md-nav__link> <span class=md-ellipsis> 3.5 Registry </span> </a> </li> <li class=md-nav__item> <a href=#36-resourcecachegenerator class=md-nav__link> <span class=md-ellipsis> 3.6 ResourceCacheGenerator </span> </a> <nav class=md-nav aria-label="3.6 ResourceCacheGenerator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#361-helpergetcachekeys class=md-nav__link> <span class=md-ellipsis> 3.6.1 helper.getCacheKeys </span> </a> </li> <li class=md-nav__item> <a href=#362-dhgetregisteredresourceclasses class=md-nav__link> <span class=md-ellipsis> 3.6.2 DH.getRegisteredResourceClasses </span> </a> </li> <li class=md-nav__item> <a href=#363 class=md-nav__link> <span class=md-ellipsis> 3.6.3 寻找缓存文件并加载 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#37-datacachegenerator class=md-nav__link> <span class=md-ellipsis> 3.7 DataCacheGenerator </span> </a> </li> <li class=md-nav__item> <a href=#38-sourcegenerator class=md-nav__link> <span class=md-ellipsis> 3.8 SourceGenerator </span> </a> </li> <li class=md-nav__item> <a href=#39-decodejobfetcherreadycallback class=md-nav__link> <span class=md-ellipsis> 3.9 DecodeJob.FetcherReadyCallback </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide3/ class=md-nav__link> <span class=md-ellipsis> Glide v4 源码解析（三） </span> </a> </li> <li class=md-nav__item> <a href=../glide4/ class=md-nav__link> <span class=md-ellipsis> Glide v4 源码解析（四） </span> </a> </li> <li class=md-nav__item> <a href=../glide5/ class=md-nav__link> <span class=md-ellipsis> Glide v4 源码解析（五） </span> </a> </li> <li class=md-nav__item> <a href=../glide6/ class=md-nav__link> <span class=md-ellipsis> Glide v4 源码解析（六） </span> </a> </li> <li class=md-nav__item> <a href=../glide7/ class=md-nav__link> <span class=md-ellipsis> Glide v4 源码解析（七） </span> </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ class=md-nav__link> <span class=md-ellipsis> 杂记：从Picasso迁移至Glide </span> </a> </li> <li class=md-nav__item> <a href=../eventbus/ class=md-nav__link> <span class=md-ellipsis> EventBus源码解析 </span> </a> </li> <li class=md-nav__item> <a href=../leakcanary/ class=md-nav__link> <span class=md-ellipsis> LeakCanary2源码解析 </span> </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ class=md-nav__link> <span class=md-ellipsis> PermissionDispatcher源码解析 </span> </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> <span class=md-ellipsis> ConstraintLayout使用大全 </span> </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> <span class=md-ellipsis> 初学者的Dagger2教程 </span> </a> </li> <li class=md-nav__item> <a href=../hotfix/ class=md-nav__link> <span class=md-ellipsis> Hotfix方案初探 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_2> <label class=md-nav__link for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class=md-ellipsis> 自研 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 自研 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../library/apm-sample/ class=md-nav__link> <span class=md-ellipsis> APM示例 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_3> <label class=md-nav__link for=__nav_2_3 id=__nav_2_3_label tabindex=0> <span class=md-ellipsis> framework系列 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_3_label aria-expanded=false> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> <span class=md-ellipsis> Activity </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> <span class=md-ellipsis> Service </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> <span class=md-ellipsis> Broadcasts </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> <span class=md-ellipsis> Content Providers与Fragment </span> </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> IPC机制 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> <span class=md-ellipsis> View的事件体系 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> <span class=md-ellipsis> View的绘制原理以及自定义View </span> </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> <span class=md-ellipsis> RemoteViews </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> <span class=md-ellipsis> Android中的Drawable资源 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> <span class=md-ellipsis> Android动画 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> <span class=md-ellipsis> Window与WindowManager </span> </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> <span class=md-ellipsis> 四大组件启动过程 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> <span class=md-ellipsis> Android消息机制 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> <span class=md-ellipsis> Android线程与线程池 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> <span class=md-ellipsis> Bitmap的缓存与加载 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> <span class=md-ellipsis> JNI与NDK编程简介 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> <span class=md-ellipsis> Android性能优化 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> <span class=md-ellipsis> Binder深入理解——以MediaService为例 </span> </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> <span class=md-ellipsis> Binder深入理解——罗老师系列 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_4> <label class=md-nav__link for=__nav_2_4 id=__nav_2_4_label tabindex=0> <span class=md-ellipsis> 杂记 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_4_label aria-expanded=false> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 杂记 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/commands/ class=md-nav__link> <span class=md-ellipsis> Android开发常见命令 </span> </a> </li> <li class=md-nav__item> <a href=../../other/android-tv/ class=md-nav__link> <span class=md-ellipsis> Android TV 专项 </span> </a> </li> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> <span class=md-ellipsis> 注解的定义及解析 </span> </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> <span class=md-ellipsis> 这可能是MVVM中最优雅的按键防抖方案 </span> </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> <span class=md-ellipsis> Jenkins for android </span> </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> <span class=md-ellipsis> 普通Android程序使用SystemProrities </span> </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> <span class=md-ellipsis> ListView、RecyclerView缓存策略解析 </span> </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> <span class=md-ellipsis> RecyclerView高级特性——ItemDecoration </span> </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> <span class=md-ellipsis> RecyclerView的一些使用细节 </span> </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> <span class=md-ellipsis> RecyclerView高级特性——拖拽排序以及滑动删除 </span> </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> <span class=md-ellipsis> FloatingActionButton上滑隐藏下滑显示 </span> </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> <span class=md-ellipsis> NestedScrolling机制 </span> </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> <span class=md-ellipsis> 使用Porter-Duff合成数字图像 </span> </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> <span class=md-ellipsis> Android Runtime </span> </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> <span class=md-ellipsis> Android马甲包的那些事儿 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> <span class=md-ellipsis> Android神兵利器 </span> </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> <span class=md-ellipsis> FileProvider </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> <span class=md-ellipsis> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> <span class=md-ellipsis> Android图片选择器 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> <span class=md-ellipsis> Android原生底部导航栏 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> <span class=md-ellipsis> Android搜索栏的实现 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> <span class=md-ellipsis> Android暂停酷狗、网易云音乐等音乐播放器的播放 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> <span class=md-ellipsis> Android滑动返回实践 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> <span class=md-ellipsis> MacOS下Android程序反编译 </span> </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> <span class=md-ellipsis> Android通讯录快速读取 </span> </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> <span class=md-ellipsis> App内自定义软键盘 </span> </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> <span class=md-ellipsis> 腾讯TBS X5浏览器内核入坑指南 </span> </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> <span class=md-ellipsis> 琐碎知识点 </span> </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> <span class=md-ellipsis> 琐碎知识点2 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_5> <label class=md-nav__link for=__nav_2_5 id=__nav_2_5_label tabindex=0> <span class=md-ellipsis> 基础知识 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_5_label aria-expanded=false> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> <span class=md-ellipsis> 理解Java中synchronized关键词 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> <span class=md-ellipsis> 理解Service </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> <span class=md-ellipsis> 理解Activity的启动模式 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> <span class=md-ellipsis> 关于startActivityForResult </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> <span class=md-ellipsis> 关于View的知识 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> <span class=md-ellipsis> 关于Gradle的知识 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> <span class=md-ellipsis> 关于序列化的知识 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> <span class=md-ellipsis> Android中的ClassLoader </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> <span class=md-ellipsis> Binder简介 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> <span class=md-ellipsis> OkHttp和Retrofit的作用以及两者之间的联系 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> <span class=md-ellipsis> JVM中垃圾回收策略 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> <span class=md-ellipsis> 进程保活 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> <span class=md-ellipsis> 四大组件的作用以及多进程 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> <span class=md-ellipsis> 网络协议 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> <span class=md-ellipsis> MVC、MVP和MVVM </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> <span class=md-ellipsis> Android Studio build过程 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> <span class=md-ellipsis> 大尺寸图片加载问题 </span> </a> </li> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> <span class=md-ellipsis> Java&Kotlin在泛型方面的区别 </span> </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> <span class=md-ellipsis> Java集合总结 </span> </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> <span class=md-ellipsis> Java常见概念 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_2_6> <label class=md-nav__link for=__nav_2_6 id=__nav_2_6_label tabindex=0> <span class=md-ellipsis> Android开发高手课 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_6_label aria-expanded=false> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ class=md-nav__link> <span class=md-ellipsis> Android开发高手课 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> <span class=md-ellipsis> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> <span class=md-ellipsis> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> <span class=md-ellipsis> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> <span class=md-ellipsis> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> <span class=md-ellipsis> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> <span class=md-ellipsis> 06 | 卡顿优化（下）：如何监控应用卡顿？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> <span class=md-ellipsis> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> <span class=md-ellipsis> 07 | 启动优化（上）：从启动过程看启动速度优化 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> <span class=md-ellipsis> 08 | 启动优化（下）：优化启动速度的进阶方法 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> <span class=md-ellipsis> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> <span class=md-ellipsis> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> <span class=md-ellipsis> 11 | I/O优化（下）：如何监控线上I/O操作？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> <span class=md-ellipsis> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> <span class=md-ellipsis> 13 | 存储优化（中）：如何优化数据存储？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> <span class=md-ellipsis> 14 | 存储优化（下）：数据库SQLite的使用和优化 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> <span class=md-ellipsis> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> <span class=md-ellipsis> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> <span class=md-ellipsis> 17 | 网络优化（下）：大数据下网络该如何监控？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> <span class=md-ellipsis> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> <span class=md-ellipsis> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> <span class=md-ellipsis> 20 | UI 优化（上）：UI 渲染的几个关键概念 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> <span class=md-ellipsis> 21 | UI 优化（下）：如何优化 UI 渲染？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> <span class=md-ellipsis> 22 | 包体积优化（上）：如何减少安装包大小？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> <span class=md-ellipsis> 23 | 包体积优化（下）：资源优化的进阶实践 </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> <span class=md-ellipsis> 26 | 关于编译，你需要了解什么？ </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> <span class=md-ellipsis> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </span> </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> <span class=md-ellipsis> 35 | Native Hook 技术，天使还是魔鬼？ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Books </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_1> <label class=md-nav__link for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class=md-ellipsis> Design Pattern </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> <span class=md-ellipsis> 设计模式概述 </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> <span class=md-ellipsis> 面向对象的六大原则 </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> <span class=md-ellipsis> 单例模式(Singleton) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> <span class=md-ellipsis> 建造者模式(Builder) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> <span class=md-ellipsis> 原型模式(Prototype) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> <span class=md-ellipsis> 工厂方法模式(Factory method) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> <span class=md-ellipsis> 抽象工厂模式(Abstract factory) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> <span class=md-ellipsis> 代理模式(Proxy) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> <span class=md-ellipsis> 组合模式(Composite) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> <span class=md-ellipsis> 适配器模式(Adapter) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> <span class=md-ellipsis> 装饰模式(Decorator) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> <span class=md-ellipsis> 享元模式(Flyweight) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> <span class=md-ellipsis> 外观模式(Facade) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> <span class=md-ellipsis> 桥接模式(Bridge) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> <span class=md-ellipsis> 策略模式(Strategy) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> <span class=md-ellipsis> 状态模式(State) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> <span class=md-ellipsis> 责任链模式(Chain of responsibility) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> <span class=md-ellipsis> 解释器模式(Interpreter) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> <span class=md-ellipsis> 命令模式(Command) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> <span class=md-ellipsis> 观察者模式(Observer) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> <span class=md-ellipsis> 备忘录模式(Memento) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> <span class=md-ellipsis> 迭代器模式(Iterator) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> <span class=md-ellipsis> 模版方法模式(Template method) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> <span class=md-ellipsis> 访问者模式(Visitor) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> <span class=md-ellipsis> 中介者模式(Mediator) </span> </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> <span class=md-ellipsis> 易混淆的设计模式 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> Effective Java </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> <span class=md-ellipsis> Effective Java概述 </span> </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> <span class=md-ellipsis> 创建和销毁对象 </span> </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> <span class=md-ellipsis> 对于所有对象都通用的方法 </span> </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> <span class=md-ellipsis> 类和接口 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_3> <label class=md-nav__link for=__nav_3_3 id=__nav_3_3_label tabindex=0> <span class=md-ellipsis> JVM </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> <span class=md-ellipsis> 深入理解Java虚拟机 </span> </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> <span class=md-ellipsis> Java内存区域与内存溢出异常 </span> </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> <span class=md-ellipsis> 垃圾收集器与内存分配策略 </span> </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> <span class=md-ellipsis> 类文件结构 </span> </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> <span class=md-ellipsis> 虚拟机类加载机制 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3_4> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> Refactoring </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> <span class=md-ellipsis> 重构：改善既有代码的设计 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> LeetCode </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ class=md-nav__link> <span class=md-ellipsis> 算法目录 </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> <span class=md-ellipsis> 数据结构、算法和数据操作 </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> <span class=md-ellipsis> 高质量的代码 </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> <span class=md-ellipsis> 解决问题的思路 </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> <span class=md-ellipsis> 优化时间和空间效率 </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> <span class=md-ellipsis> 面试中的各项能力 </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> <span class=md-ellipsis> Array </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> <span class=md-ellipsis> LeetCode(1-10) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> <span class=md-ellipsis> LeetCode(11-20) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> <span class=md-ellipsis> LeetCode(21-30) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> <span class=md-ellipsis> LeetCode(31-40) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> <span class=md-ellipsis> LeetCode(41-50) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> <span class=md-ellipsis> LeetCode(51-60) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> <span class=md-ellipsis> LeetCode(61-70) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> <span class=md-ellipsis> LeetCode(71-80) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> <span class=md-ellipsis> LeetCode(81-90) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> <span class=md-ellipsis> LeetCode(91-100) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> <span class=md-ellipsis> LeetCode(101-110) </span> </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> <span class=md-ellipsis> LeetCode(111-120) </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Flutter </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> <span class=md-ellipsis> 年轻人的第一个Flutter程序(1) </span> </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> <span class=md-ellipsis> 年轻人的第一个Flutter程序(2) </span> </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> <span class=md-ellipsis> 年轻人的第一个Flutter程序(3) </span> </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> <span class=md-ellipsis> 年轻人的第一个Flutter程序(4) </span> </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_provider/ class=md-nav__link> <span class=md-ellipsis> Flutter状态管理——Provider </span> </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_rich_text/ class=md-nav__link> <span class=md-ellipsis> Flutter 文本编辑器——记自研 Markdown 编辑器 MooD </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-glidewith class=md-nav__link> <span class=md-ellipsis> 1. Glide.with </span> </a> <nav class=md-nav aria-label="1. Glide.with"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-getretrievercontext class=md-nav__link> <span class=md-ellipsis> 1.1 getRetriever(Context) </span> </a> </li> <li class=md-nav__item> <a href=#12-requestmanagerretrieverget class=md-nav__link> <span class=md-ellipsis> 1.2 RequestManagerRetriever.get </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-requestmanagerload class=md-nav__link> <span class=md-ellipsis> 2. RequestManager.load </span> </a> <nav class=md-nav aria-label="2. RequestManager.load"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-requestmanagerasxxx class=md-nav__link> <span class=md-ellipsis> 2.1 RequestManager.asXxx </span> </a> </li> <li class=md-nav__item> <a href=#22-requestbuilderload class=md-nav__link> <span class=md-ellipsis> 2.2 RequestBuilder.load </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-requestbuilderinto class=md-nav__link> <span class=md-ellipsis> 3. RequestBuilder.into </span> </a> <nav class=md-nav aria-label="3. RequestBuilder.into"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-buildrequest class=md-nav__link> <span class=md-ellipsis> 3.1 buildRequest </span> </a> </li> <li class=md-nav__item> <a href=#32-requestmanagertrack class=md-nav__link> <span class=md-ellipsis> 3.2 RequestManager.track </span> </a> </li> <li class=md-nav__item> <a href=#33-engineload class=md-nav__link> <span class=md-ellipsis> 3.3 Engine.load </span> </a> </li> <li class=md-nav__item> <a href=#34-decodejobrun class=md-nav__link> <span class=md-ellipsis> 3.4 DecodeJob.run </span> </a> </li> <li class=md-nav__item> <a href=#35-registry class=md-nav__link> <span class=md-ellipsis> 3.5 Registry </span> </a> </li> <li class=md-nav__item> <a href=#36-resourcecachegenerator class=md-nav__link> <span class=md-ellipsis> 3.6 ResourceCacheGenerator </span> </a> <nav class=md-nav aria-label="3.6 ResourceCacheGenerator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#361-helpergetcachekeys class=md-nav__link> <span class=md-ellipsis> 3.6.1 helper.getCacheKeys </span> </a> </li> <li class=md-nav__item> <a href=#362-dhgetregisteredresourceclasses class=md-nav__link> <span class=md-ellipsis> 3.6.2 DH.getRegisteredResourceClasses </span> </a> </li> <li class=md-nav__item> <a href=#363 class=md-nav__link> <span class=md-ellipsis> 3.6.3 寻找缓存文件并加载 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#37-datacachegenerator class=md-nav__link> <span class=md-ellipsis> 3.7 DataCacheGenerator </span> </a> </li> <li class=md-nav__item> <a href=#38-sourcegenerator class=md-nav__link> <span class=md-ellipsis> 3.8 SourceGenerator </span> </a> </li> <li class=md-nav__item> <a href=#39-decodejobfetcherreadycallback class=md-nav__link> <span class=md-ellipsis> 3.9 DecodeJob.FetcherReadyCallback </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../tags/#glide class=md-tag>glide</a> </nav> <h1>Glide v4 源码解析（二）</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>本系列文章参考3.7.0版本的<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glide最全解析</a>，并按此思路结合4.9.0版本源码以及使用文档进行更新。<br> ➟ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> ➟ <a href=https://muyangmin.github.io/glide-docs-cn/ >中文文档</a><br> ➟ <a href=https://bumptech.github.io/glide/ >英文文档</a>🚀🚀 </p> </div> <div class="admonition note"> <p class=admonition-title>Glide系列文章目录</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1——Glide v4 的基本使用</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2——从源码的角度理解Glide三步的执行流程</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3——深入探究Glide缓存机制</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4——RequestBuilder中高级点的API以及Target</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5——Glide内置的transform以及自定义BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6——Glide利用AppGlideModule、LibraryGlideModule更改默认配置、扩展Glide功能；GlideApp与Glide的区别在哪？</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7——利用OkHttp、自定义Drawable、自定义ViewTarget实现带进度的图片加载功能</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >杂记：从Picasso迁移至Glide</a></li> </ul> </div> <hr> <p>本章主要内容为从源码的角度理解Glide三步的执行流程。</p> <p>由于上一章中我们已经导入了Glide库，所以可以直接在Android Studio中查看Glide的源码。相比clone GitHub上的源码，使用Android Studio查看Glide源码的好处是，这是只读的，防止我们误操作。而且还能直接上在源码对应的上断点，真是太方便了。</p> <p>还是以<code>Glide.with(this).load(URL).into(ivGlide)</code>为例，看看这背后隐藏了什么秘密。</p> <h2 id=1-glidewith>1. Glide.with<a class=headerlink href=#1-glidewith title="Permanent link">&para;</a></h2> <p><code>Glide.with</code>有很多重载方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Glide</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ComponentCallbacks2</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getRetriever</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getRetriever</span><span class=p>(</span><span class=n>activity</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>FragmentActivity</span><span class=w> </span><span class=n>activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getRetriever</span><span class=p>(</span><span class=n>activity</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Fragment</span><span class=w> </span><span class=n>fragment</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getRetriever</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=w>    </span><span class=nd>@Deprecated</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>Fragment</span><span class=w> </span><span class=n>fragment</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getRetriever</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>getRetriever</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a><span class=p>}</span>
</span></code></pre></div> <p>可以看到，每个重载方法内部都首先调用<code>getRetriever(@Nullable Context context)</code>方法获取一个<code>RequestManagerRetriever</code>对象，然后调用其<code>get</code>方法来返回<code>RequestManager</code>。<br> 传入<code>getRetriever</code>的参数都是<code>Context</code>，而<code>RequestManagerRetriever.get</code>方法传入的参数各不相同，所以生命周期的绑定肯定发生在<code>get</code>方法中。</p> <p>我们把<code>Glide.with</code>方法里面的代码分成两部分来分析。</p> <h3 id=11-getretrievercontext>1.1 getRetriever(Context)<a class=headerlink href=#11-getretrievercontext title="Permanent link">&para;</a></h3> <p><code>getRetriever(Context)</code>方法会根据<code>@GlideModule</code>注解的类以及<code>AndroidManifest.xml</code>文件中meta-data配置的<code>GlideModule</code>来创建一个<code>Glide</code>实例，然后返回该实例的<code>requestManagerRetriever</code>。 </p> <p>我们跟着源码过一边，首先从<code>getRetriever(Context)</code>开始：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=nd>@NonNull</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestManagerRetriever</span><span class=w> </span><span class=nf>getRetriever</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>  </span><span class=c1>// Context could be null for other reasons (ie the user passes in null), but in practice it will</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>  </span><span class=c1>// only occur due to errors with the Fragment lifecycle.</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>      </span><span class=n>context</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>      </span><span class=s>&quot;You cannot start a load on a not yet attached View or a Fragment where getActivity() &quot;</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;returns null (which usually occurs when getActivity() is called before the Fragment &quot;</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;is attached or after the Fragment is destroyed).&quot;</span><span class=p>);</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>getRequestManagerRetriever</span><span class=p>();</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=p>}</span>
</span></code></pre></div> <p>因入参<code>context</code>为<code>fragment.getActivity()</code>时，<code>context</code>可能为空，所以这里进行了一次判断。然后就调用了<code>Glide.get(context)</code>创建了一个Glide，最后将<code>requestManagerRetriever</code>返回即可。 </p> <p>我们看一下<code>Glide</code>的创建过程：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=nd>@NonNull</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Glide</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>glide</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>Glide</span><span class=p>.</span><span class=na>class</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>glide</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>        </span><span class=n>checkAndInitializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>glide</span><span class=p>;</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=p>}</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>checkAndInitializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>  </span><span class=c1>// In the thread running initGlide(), one or more classes may call Glide.get(context).</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>  </span><span class=c1>// Without this check, those calls could trigger infinite recursion.</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isInitializing</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;You cannot call Glide.get() in registerComponents(),&quot;</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=s>&quot; use the provided Glide instance instead&quot;</span><span class=p>);</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=w>  </span><span class=n>isInitializing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=w>  </span><span class=n>initializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=w>  </span><span class=n>isInitializing</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=p>}</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=w>  </span><span class=n>initializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideBuilder</span><span class=p>());</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=p>}</span>
</span></code></pre></div> <p>上面这段代码没有什么可说的，下面看看<code>initializeGlide</code>时如何创建<code>Glide</code>实例的。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>GlideBuilder</span><span class=w> </span><span class=n>builder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>  </span><span class=n>Context</span><span class=w> </span><span class=n>applicationContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>  </span><span class=c1>// 如果有配置@GlideModule注解，那么会反射构造kapt生成的GeneratedAppGlideModuleImpl类</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>  </span><span class=n>GeneratedAppGlideModule</span><span class=w> </span><span class=n>annotationGeneratedModule</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getAnnotationGeneratedGlideModules</span><span class=p>();</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>  </span><span class=c1>// 如果Impl存在，且允许解析manifest文件</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>  </span><span class=c1>// 则遍历manifest中的meta-data，解析出所有的GlideModule类</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>  </span><span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span><span class=w> </span><span class=n>manifestModules</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>annotationGeneratedModule</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>isManifestParsingEnabled</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>    </span><span class=n>manifestModules</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ManifestParser</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>).</span><span class=na>parse</span><span class=p>();</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=w>  </span><span class=c1>// 根据Impl的黑名单，剔除manifest中的GlideModule类</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>annotationGeneratedModule</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=w>    </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>excludedModuleClasses</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a><span class=w>        </span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>();</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a><span class=w>    </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span><span class=w> </span><span class=n>iterator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>manifestModules</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a><span class=w>      </span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>excludedModuleClasses</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=w>        </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;AppGlideModule excludes manifest GlideModule: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>current</span><span class=p>);</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a><span class=w>      </span><span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=w> </span><span class=n>glideModule</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>manifestModules</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a><span class=w>      </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Discovered GlideModule from manifest: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>glideModule</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
</span><span id=__span-3-34><a id=__codelineno-3-34 name=__codelineno-3-34 href=#__codelineno-3-34></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-3-35><a id=__codelineno-3-35 name=__codelineno-3-35 href=#__codelineno-3-35></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-36><a id=__codelineno-3-36 name=__codelineno-3-36 href=#__codelineno-3-36></a>
</span><span id=__span-3-37><a id=__codelineno-3-37 name=__codelineno-3-37 href=#__codelineno-3-37></a><span class=w>  </span><span class=c1>// 如果Impl存在，那么设置为该类的RequestManagerFactory； 否则，设置为null</span>
</span><span id=__span-3-38><a id=__codelineno-3-38 name=__codelineno-3-38 href=#__codelineno-3-38></a><span class=w>  </span><span class=n>RequestManagerRetriever</span><span class=p>.</span><span class=na>RequestManagerFactory</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-3-39><a id=__codelineno-3-39 name=__codelineno-3-39 href=#__codelineno-3-39></a><span class=w>      </span><span class=n>annotationGeneratedModule</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-3-40><a id=__codelineno-3-40 name=__codelineno-3-40 href=#__codelineno-3-40></a><span class=w>          </span><span class=o>?</span><span class=w> </span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getRequestManagerFactory</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-3-41><a id=__codelineno-3-41 name=__codelineno-3-41 href=#__codelineno-3-41></a><span class=w>  </span><span class=n>builder</span><span class=p>.</span><span class=na>setRequestManagerFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-3-42><a id=__codelineno-3-42 name=__codelineno-3-42 href=#__codelineno-3-42></a><span class=w>  </span><span class=c1>// 依次调用manifest中GlideModule类的applyOptions方法，将配置写到builder里</span>
</span><span id=__span-3-43><a id=__codelineno-3-43 name=__codelineno-3-43 href=#__codelineno-3-43></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=w> </span><span class=n>module</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>manifestModules</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-44><a id=__codelineno-3-44 name=__codelineno-3-44 href=#__codelineno-3-44></a><span class=w>    </span><span class=n>module</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span><span class=w> </span><span class=n>builder</span><span class=p>);</span>
</span><span id=__span-3-45><a id=__codelineno-3-45 name=__codelineno-3-45 href=#__codelineno-3-45></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-46><a id=__codelineno-3-46 name=__codelineno-3-46 href=#__codelineno-3-46></a><span class=w>  </span><span class=c1>// 写入Impl的配置</span>
</span><span id=__span-3-47><a id=__codelineno-3-47 name=__codelineno-3-47 href=#__codelineno-3-47></a><span class=w>  </span><span class=c1>// 也就是说Impl配置的优先级更高，如果有冲突的话</span>
</span><span id=__span-3-48><a id=__codelineno-3-48 name=__codelineno-3-48 href=#__codelineno-3-48></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>annotationGeneratedModule</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-49><a id=__codelineno-3-49 name=__codelineno-3-49 href=#__codelineno-3-49></a><span class=w>    </span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span><span class=w> </span><span class=n>builder</span><span class=p>);</span>
</span><span id=__span-3-50><a id=__codelineno-3-50 name=__codelineno-3-50 href=#__codelineno-3-50></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-51><a id=__codelineno-3-51 name=__codelineno-3-51 href=#__codelineno-3-51></a><span class=w>  </span><span class=c1>// 🔥🔥🔥调用GlideBuilder.build方法创建Glide</span>
</span><span id=__span-3-52><a id=__codelineno-3-52 name=__codelineno-3-52 href=#__codelineno-3-52></a><span class=w>  </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
</span><span id=__span-3-53><a id=__codelineno-3-53 name=__codelineno-3-53 href=#__codelineno-3-53></a><span class=w>  </span><span class=c1>// 依次调用manifest中GlideModule类的registerComponents方法，来替换Glide的默认配置</span>
</span><span id=__span-3-54><a id=__codelineno-3-54 name=__codelineno-3-54 href=#__codelineno-3-54></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=w> </span><span class=n>module</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>manifestModules</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-55><a id=__codelineno-3-55 name=__codelineno-3-55 href=#__codelineno-3-55></a><span class=w>    </span><span class=n>module</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span><span class=w> </span><span class=n>glide</span><span class=p>,</span><span class=w> </span><span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
</span><span id=__span-3-56><a id=__codelineno-3-56 name=__codelineno-3-56 href=#__codelineno-3-56></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-57><a id=__codelineno-3-57 name=__codelineno-3-57 href=#__codelineno-3-57></a><span class=w>  </span><span class=c1>// 调用Impl中替换Glide配置的方法</span>
</span><span id=__span-3-58><a id=__codelineno-3-58 name=__codelineno-3-58 href=#__codelineno-3-58></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>annotationGeneratedModule</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-3-59><a id=__codelineno-3-59 name=__codelineno-3-59 href=#__codelineno-3-59></a><span class=w>    </span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span><span class=w> </span><span class=n>glide</span><span class=p>,</span><span class=w> </span><span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
</span><span id=__span-3-60><a id=__codelineno-3-60 name=__codelineno-3-60 href=#__codelineno-3-60></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-3-61><a id=__codelineno-3-61 name=__codelineno-3-61 href=#__codelineno-3-61></a><span class=w>  </span><span class=c1>// 注册内存管理的回调，因为Glide实现了ComponentCallbacks2接口</span>
</span><span id=__span-3-62><a id=__codelineno-3-62 name=__codelineno-3-62 href=#__codelineno-3-62></a><span class=w>  </span><span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
</span><span id=__span-3-63><a id=__codelineno-3-63 name=__codelineno-3-63 href=#__codelineno-3-63></a><span class=w>  </span><span class=c1>// 保存glide实例到静态变量中</span>
</span><span id=__span-3-64><a id=__codelineno-3-64 name=__codelineno-3-64 href=#__codelineno-3-64></a><span class=w>  </span><span class=n>Glide</span><span class=p>.</span><span class=na>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glide</span><span class=p>;</span>
</span><span id=__span-3-65><a id=__codelineno-3-65 name=__codelineno-3-65 href=#__codelineno-3-65></a><span class=p>}</span>
</span></code></pre></div> <blockquote> <p><code>applyOptions</code>、<code>registerComponents</code>这两个方法后面会详细讨论，这里只是简单说明一下。</p> </blockquote> <p>在我们本节的例子中，我们<code>AndroidManifest</code>和<code>@GlideModule</code>注解中都没有进行过配置，所以上面的代码可以简化为：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>GlideBuilder</span><span class=w> </span><span class=n>builder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>  </span><span class=n>Context</span><span class=w> </span><span class=n>applicationContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>  </span><span class=c1>// 🔥🔥🔥调用GlideBuilder.build方法创建Glide</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>  </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>  </span><span class=c1>// 注册内存管理的回调，因为Glide实现了ComponentCallbacks2接口</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>  </span><span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>  </span><span class=c1>// 保存glide实例到静态变量中</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>  </span><span class=n>Glide</span><span class=p>.</span><span class=na>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glide</span><span class=p>;</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=p>}</span>
</span></code></pre></div> <p>🔥🔥🔥我们看一下<code>GlideBuilder.build</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=nd>@NonNull</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=n>Glide</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>  </span><span class=n>RequestManagerRetriever</span><span class=w> </span><span class=n>requestManagerRetriever</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>RequestManagerRetriever</span><span class=p>(</span><span class=n>requestManagerFactory</span><span class=p>);</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Glide</span><span class=p>(</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=w>      </span><span class=n>context</span><span class=p>,</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>      </span><span class=n>engine</span><span class=p>,</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>      </span><span class=n>memoryCache</span><span class=p>,</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>      </span><span class=n>bitmapPool</span><span class=p>,</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=w>      </span><span class=n>arrayPool</span><span class=p>,</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>      </span><span class=n>requestManagerRetriever</span><span class=p>,</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>      </span><span class=n>connectivityMonitorFactory</span><span class=p>,</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>      </span><span class=n>logLevel</span><span class=p>,</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>      </span><span class=n>defaultRequestOptions</span><span class=p>.</span><span class=na>lock</span><span class=p>(),</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>      </span><span class=n>defaultTransitionOptions</span><span class=p>,</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=w>      </span><span class=n>defaultRequestListeners</span><span class=p>,</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>      </span><span class=n>isLoggingRequestOriginsEnabled</span><span class=p>);</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=p>}</span>
</span></code></pre></div> <p>这里的<code>requestManagerRetriever</code>直接调用了构造器，且传入参数实际上为null，在<code>RequestManagerRetriever</code>的构造器方法中会为此创建一个默认的<code>DEFAULT_FACTORY</code>：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>RequestManagerRetriever</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Handler</span><span class=p>.</span><span class=na>Callback</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Handler</span><span class=w> </span><span class=n>handler</span><span class=p>;</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RequestManagerFactory</span><span class=w> </span><span class=n>factory</span><span class=p>;</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>RequestManagerRetriever</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestManagerFactory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>factory</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>DEFAULT_FACTORY</span><span class=p>;</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=w> </span><span class=cm>/* Callback */</span><span class=p>);</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>  </span><span class=cm>/**</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=cm>   * Used internally to create {@link RequestManager}s.</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=cm>   */</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>RequestManagerFactory</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>    </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>build</span><span class=p>(</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>        </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=p>,</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>        </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Lifecycle</span><span class=w> </span><span class=n>lifecycle</span><span class=p>,</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>        </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>RequestManagerTreeNode</span><span class=w> </span><span class=n>requestManagerTreeNode</span><span class=p>,</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>        </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RequestManagerFactory</span><span class=w> </span><span class=n>DEFAULT_FACTORY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestManagerFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>    </span><span class=nd>@NonNull</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Lifecycle</span><span class=w> </span><span class=n>lifecycle</span><span class=p>,</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>        </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>RequestManagerTreeNode</span><span class=w> </span><span class=n>requestManagerTreeNode</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span><span class=w> </span><span class=n>lifecycle</span><span class=p>,</span><span class=w> </span><span class=n>requestManagerTreeNode</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>  </span><span class=p>};</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=p>}</span>
</span></code></pre></div> <p>目前为止，<code>Glide</code><strong>单例已经被创建出来了</strong>，其<code>requestManagerRetriever</code>会作为<code>getRetriever(Context)</code>的返回值返回。</p> <p>接下来回到<code>Glide.with</code>方法中，接着执行的是<code>RequestManagerRetriever.get</code>方法，该方法根据入参是对生命周期可感的。</p> <h3 id=12-requestmanagerretrieverget>1.2 RequestManagerRetriever.get<a class=headerlink href=#12-requestmanagerretrieverget title="Permanent link">&para;</a></h3> <p><code>RequestManagerRetriever.get</code>方法与<code>Glide.with</code>一样，也有很多重载方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=nd>@NonNull</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=kd>private</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>getApplicationManager</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=w>  </span><span class=c1>// Either an application context or we&#39;re on a background thread.</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>applicationManager</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>applicationManager</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=w>        </span><span class=c1>// Normally pause/resume is taken care of by the fragment we add to the fragment or</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=w>        </span><span class=c1>// activity. However, in this case since the manager attached to the application will not</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=w>        </span><span class=c1>// receive lifecycle events, we must force the manager to start resumed using</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=w>        </span><span class=c1>// ApplicationLifecycle.</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=w>        </span><span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.</span>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=w>        </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=w>        </span><span class=n>applicationManager</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=w>            </span><span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=w>                </span><span class=n>glide</span><span class=p>,</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>ApplicationLifecycle</span><span class=p>(),</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=w>                </span><span class=k>new</span><span class=w> </span><span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=w>                </span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>applicationManager</span><span class=p>;</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a><span class=p>}</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a><span class=nd>@NonNull</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a><span class=kd>public</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;You cannot start a load on a null Context&quot;</span><span class=p>);</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnMainThread</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Application</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>FragmentActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>((</span><span class=n>FragmentActivity</span><span class=p>)</span><span class=w> </span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>((</span><span class=n>Activity</span><span class=p>)</span><span class=w> </span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>context</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>ContextWrapper</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(((</span><span class=n>ContextWrapper</span><span class=p>)</span><span class=w> </span><span class=n>context</span><span class=p>).</span><span class=na>getBaseContext</span><span class=p>());</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>getApplicationManager</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=p>}</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=nd>@NonNull</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a><span class=kd>public</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>FragmentActivity</span><span class=w> </span><span class=n>activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a><span class=w>    </span><span class=n>assertNotDestroyed</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a><span class=w>    </span><span class=n>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getSupportFragmentManager</span><span class=p>();</span>
</span><span id=__span-7-51><a id=__codelineno-7-51 name=__codelineno-7-51 href=#__codelineno-7-51></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>supportFragmentGet</span><span class=p>(</span>
</span><span id=__span-7-52><a id=__codelineno-7-52 name=__codelineno-7-52 href=#__codelineno-7-52></a><span class=w>        </span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=cm>/*parentHint=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
</span><span id=__span-7-53><a id=__codelineno-7-53 name=__codelineno-7-53 href=#__codelineno-7-53></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-54><a id=__codelineno-7-54 name=__codelineno-7-54 href=#__codelineno-7-54></a><span class=p>}</span>
</span><span id=__span-7-55><a id=__codelineno-7-55 name=__codelineno-7-55 href=#__codelineno-7-55></a>
</span><span id=__span-7-56><a id=__codelineno-7-56 name=__codelineno-7-56 href=#__codelineno-7-56></a><span class=nd>@NonNull</span>
</span><span id=__span-7-57><a id=__codelineno-7-57 name=__codelineno-7-57 href=#__codelineno-7-57></a><span class=kd>public</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Fragment</span><span class=w> </span><span class=n>fragment</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-58><a id=__codelineno-7-58 name=__codelineno-7-58 href=#__codelineno-7-58></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span>
</span><span id=__span-7-59><a id=__codelineno-7-59 name=__codelineno-7-59 href=#__codelineno-7-59></a><span class=w>        </span><span class=s>&quot;You cannot start a load on a fragment before it is attached or after it is destroyed&quot;</span><span class=p>);</span>
</span><span id=__span-7-60><a id=__codelineno-7-60 name=__codelineno-7-60 href=#__codelineno-7-60></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-61><a id=__codelineno-7-61 name=__codelineno-7-61 href=#__codelineno-7-61></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-62><a id=__codelineno-7-62 name=__codelineno-7-62 href=#__codelineno-7-62></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-63><a id=__codelineno-7-63 name=__codelineno-7-63 href=#__codelineno-7-63></a><span class=w>    </span><span class=n>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fragment</span><span class=p>.</span><span class=na>getChildFragmentManager</span><span class=p>();</span>
</span><span id=__span-7-64><a id=__codelineno-7-64 name=__codelineno-7-64 href=#__codelineno-7-64></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span><span class=w> </span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=n>fragment</span><span class=p>,</span><span class=w> </span><span class=n>fragment</span><span class=p>.</span><span class=na>isVisible</span><span class=p>());</span>
</span><span id=__span-7-65><a id=__codelineno-7-65 name=__codelineno-7-65 href=#__codelineno-7-65></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-66><a id=__codelineno-7-66 name=__codelineno-7-66 href=#__codelineno-7-66></a><span class=p>}</span>
</span><span id=__span-7-67><a id=__codelineno-7-67 name=__codelineno-7-67 href=#__codelineno-7-67></a>
</span><span id=__span-7-68><a id=__codelineno-7-68 name=__codelineno-7-68 href=#__codelineno-7-68></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-7-69><a id=__codelineno-7-69 name=__codelineno-7-69 href=#__codelineno-7-69></a><span class=nd>@NonNull</span>
</span><span id=__span-7-70><a id=__codelineno-7-70 name=__codelineno-7-70 href=#__codelineno-7-70></a><span class=kd>public</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-71><a id=__codelineno-7-71 name=__codelineno-7-71 href=#__codelineno-7-71></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-72><a id=__codelineno-7-72 name=__codelineno-7-72 href=#__codelineno-7-72></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-73><a id=__codelineno-7-73 name=__codelineno-7-73 href=#__codelineno-7-73></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-74><a id=__codelineno-7-74 name=__codelineno-7-74 href=#__codelineno-7-74></a><span class=w>    </span><span class=n>assertNotDestroyed</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-7-75><a id=__codelineno-7-75 name=__codelineno-7-75 href=#__codelineno-7-75></a><span class=w>    </span><span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getFragmentManager</span><span class=p>();</span>
</span><span id=__span-7-76><a id=__codelineno-7-76 name=__codelineno-7-76 href=#__codelineno-7-76></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fragmentGet</span><span class=p>(</span>
</span><span id=__span-7-77><a id=__codelineno-7-77 name=__codelineno-7-77 href=#__codelineno-7-77></a><span class=w>        </span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=cm>/*parentHint=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
</span><span id=__span-7-78><a id=__codelineno-7-78 name=__codelineno-7-78 href=#__codelineno-7-78></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-79><a id=__codelineno-7-79 name=__codelineno-7-79 href=#__codelineno-7-79></a><span class=p>}</span>
</span><span id=__span-7-80><a id=__codelineno-7-80 name=__codelineno-7-80 href=#__codelineno-7-80></a>
</span><span id=__span-7-81><a id=__codelineno-7-81 name=__codelineno-7-81 href=#__codelineno-7-81></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-7-82><a id=__codelineno-7-82 name=__codelineno-7-82 href=#__codelineno-7-82></a><span class=nd>@NonNull</span>
</span><span id=__span-7-83><a id=__codelineno-7-83 name=__codelineno-7-83 href=#__codelineno-7-83></a><span class=kd>public</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>View</span><span class=w> </span><span class=n>view</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-84><a id=__codelineno-7-84 name=__codelineno-7-84 href=#__codelineno-7-84></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-85><a id=__codelineno-7-85 name=__codelineno-7-85 href=#__codelineno-7-85></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-86><a id=__codelineno-7-86 name=__codelineno-7-86 href=#__codelineno-7-86></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-87><a id=__codelineno-7-87 name=__codelineno-7-87 href=#__codelineno-7-87></a>
</span><span id=__span-7-88><a id=__codelineno-7-88 name=__codelineno-7-88 href=#__codelineno-7-88></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
</span><span id=__span-7-89><a id=__codelineno-7-89 name=__codelineno-7-89 href=#__codelineno-7-89></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span>
</span><span id=__span-7-90><a id=__codelineno-7-90 name=__codelineno-7-90 href=#__codelineno-7-90></a><span class=w>      </span><span class=s>&quot;Unable to obtain a request manager for a view without a Context&quot;</span><span class=p>);</span>
</span><span id=__span-7-91><a id=__codelineno-7-91 name=__codelineno-7-91 href=#__codelineno-7-91></a><span class=w>  </span><span class=n>Activity</span><span class=w> </span><span class=n>activity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findActivity</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>());</span>
</span><span id=__span-7-92><a id=__codelineno-7-92 name=__codelineno-7-92 href=#__codelineno-7-92></a><span class=w>  </span><span class=c1>// The view might be somewhere else, like a service.</span>
</span><span id=__span-7-93><a id=__codelineno-7-93 name=__codelineno-7-93 href=#__codelineno-7-93></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-94><a id=__codelineno-7-94 name=__codelineno-7-94 href=#__codelineno-7-94></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-7-95><a id=__codelineno-7-95 name=__codelineno-7-95 href=#__codelineno-7-95></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-96><a id=__codelineno-7-96 name=__codelineno-7-96 href=#__codelineno-7-96></a>
</span><span id=__span-7-97><a id=__codelineno-7-97 name=__codelineno-7-97 href=#__codelineno-7-97></a><span class=w>  </span><span class=c1>// Support Fragments.</span>
</span><span id=__span-7-98><a id=__codelineno-7-98 name=__codelineno-7-98 href=#__codelineno-7-98></a><span class=w>  </span><span class=c1>// Although the user might have non-support Fragments attached to FragmentActivity, searching</span>
</span><span id=__span-7-99><a id=__codelineno-7-99 name=__codelineno-7-99 href=#__codelineno-7-99></a><span class=w>  </span><span class=c1>// for non-support Fragments is so expensive pre O and that should be rare enough that we</span>
</span><span id=__span-7-100><a id=__codelineno-7-100 name=__codelineno-7-100 href=#__codelineno-7-100></a><span class=w>  </span><span class=c1>// prefer to just fall back to the Activity directly.</span>
</span><span id=__span-7-101><a id=__codelineno-7-101 name=__codelineno-7-101 href=#__codelineno-7-101></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>activity</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>FragmentActivity</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-102><a id=__codelineno-7-102 name=__codelineno-7-102 href=#__codelineno-7-102></a><span class=w>    </span><span class=n>Fragment</span><span class=w> </span><span class=n>fragment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findSupportFragment</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>FragmentActivity</span><span class=p>)</span><span class=w> </span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-7-103><a id=__codelineno-7-103 name=__codelineno-7-103 href=#__codelineno-7-103></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fragment</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-7-104><a id=__codelineno-7-104 name=__codelineno-7-104 href=#__codelineno-7-104></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-105><a id=__codelineno-7-105 name=__codelineno-7-105 href=#__codelineno-7-105></a>
</span><span id=__span-7-106><a id=__codelineno-7-106 name=__codelineno-7-106 href=#__codelineno-7-106></a><span class=w>  </span><span class=c1>// Standard Fragments.</span>
</span><span id=__span-7-107><a id=__codelineno-7-107 name=__codelineno-7-107 href=#__codelineno-7-107></a><span class=w>  </span><span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>Fragment</span><span class=w> </span><span class=n>fragment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findFragment</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-7-108><a id=__codelineno-7-108 name=__codelineno-7-108 href=#__codelineno-7-108></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fragment</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-7-109><a id=__codelineno-7-109 name=__codelineno-7-109 href=#__codelineno-7-109></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
</span><span id=__span-7-110><a id=__codelineno-7-110 name=__codelineno-7-110 href=#__codelineno-7-110></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-7-111><a id=__codelineno-7-111 name=__codelineno-7-111 href=#__codelineno-7-111></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
</span><span id=__span-7-112><a id=__codelineno-7-112 name=__codelineno-7-112 href=#__codelineno-7-112></a><span class=p>}</span>
</span></code></pre></div> <p>在这些<code>get</code>方法中，<strong>首先判断当前线程是不是后台线程</strong>，如果是后台线程那么就会调用<code>getApplicationManager</code>方法返回一个<code>RequestManager</code>：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=n>applicationManager</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=w>    </span><span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=w>        </span><span class=n>glide</span><span class=p>,</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>ApplicationLifecycle</span><span class=p>(),</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span></code></pre></div> <p>由于此处<code>factory</code>是<code>DEFAULT_FACTORY</code>，所以<code>RequestManager</code>就是下面的值：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>ApplicationLifecycle</span><span class=p>(),</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>        </span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</span></code></pre></div> <p><strong>如果当前线程不是后台线程</strong>，<code>get(View)</code>和<code>get(Context)</code>会根据情况调用<code>get(Fragment)</code>或<code>get(FragmentActivity)</code>。其中<code>get(View)</code>为了找到一个合适的<code>Fragment</code>或fallback <code>Activity</code>，内部操作比较多，开销比较大，不要轻易使用。</p> <p><code>get(Fragment)</code>和<code>get(FragmentActivity)</code>方法都会调用<code>supportFragmentGet</code>方法，只是传入参数不同：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=c1>// FragmentActivity activity</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=n>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activity</span><span class=p>.</span><span class=na>getSupportFragmentManager</span><span class=p>();</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span><span class=w> </span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=cm>/*parentHint=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=c1>// Fragment fragment</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=n>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fragment</span><span class=p>.</span><span class=na>getChildFragmentManager</span><span class=p>();</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span><span class=w> </span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=n>fragment</span><span class=p>,</span><span class=w> </span><span class=n>fragment</span><span class=p>.</span><span class=na>isVisible</span><span class=p>());</span>
</span></code></pre></div> <blockquote> <p>Glide会使用一个加载目标所在的宿主Activity或Fragment的子<code>Fragment</code>来安全保存一个<code>RequestManager</code>，而<code>RequestManager</code>被Glide用来开始、停止、管理Glide请求。</p> </blockquote> <p>而<code>supportFragmentGet</code>就是创建/获取这个<code>SupportRequestManagerFragment</code>，并返回其持有的<code>RequestManager</code>的方法。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=nd>@NonNull</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=kd>private</span><span class=w> </span><span class=n>RequestManager</span><span class=w> </span><span class=nf>supportFragmentGet</span><span class=p>(</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Fragment</span><span class=w> </span><span class=n>parentHint</span><span class=p>,</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isParentVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a><span class=w>  </span><span class=c1>// 🐟🐟🐟获取一个SupportRequestManagerFragment</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a><span class=w>  </span><span class=n>SupportRequestManagerFragment</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a><span class=w>      </span><span class=n>getSupportRequestManagerFragment</span><span class=p>(</span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=n>parentHint</span><span class=p>,</span><span class=w> </span><span class=n>isParentVisible</span><span class=p>);</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a><span class=w>  </span><span class=c1>// 获取里面的RequestManager对象</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=w>  </span><span class=n>RequestManager</span><span class=w> </span><span class=n>requestManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>current</span><span class=p>.</span><span class=na>getRequestManager</span><span class=p>();</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=w>  </span><span class=c1>// 若没有，则创建一个</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestManager</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=w>    </span><span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.</span>
</span><span id=__span-11-15><a id=__codelineno-11-15 name=__codelineno-11-15 href=#__codelineno-11-15></a><span class=w>    </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-11-16><a id=__codelineno-11-16 name=__codelineno-11-16 href=#__codelineno-11-16></a><span class=w>    </span><span class=c1>// 🔥🔥🔥</span>
</span><span id=__span-11-17><a id=__codelineno-11-17 name=__codelineno-11-17 href=#__codelineno-11-17></a><span class=w>    </span><span class=n>requestManager</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-11-18><a id=__codelineno-11-18 name=__codelineno-11-18 href=#__codelineno-11-18></a><span class=w>        </span><span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
</span><span id=__span-11-19><a id=__codelineno-11-19 name=__codelineno-11-19 href=#__codelineno-11-19></a><span class=w>            </span><span class=n>glide</span><span class=p>,</span><span class=w> </span><span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>(),</span><span class=w> </span><span class=n>current</span><span class=p>.</span><span class=na>getRequestManagerTreeNode</span><span class=p>(),</span><span class=w> </span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-11-20><a id=__codelineno-11-20 name=__codelineno-11-20 href=#__codelineno-11-20></a><span class=w>    </span><span class=c1>// 设置到SupportRequestManagerFragment里面，下次就不需要创建了</span>
</span><span id=__span-11-21><a id=__codelineno-11-21 name=__codelineno-11-21 href=#__codelineno-11-21></a><span class=w>    </span><span class=n>current</span><span class=p>.</span><span class=na>setRequestManager</span><span class=p>(</span><span class=n>requestManager</span><span class=p>);</span>
</span><span id=__span-11-22><a id=__codelineno-11-22 name=__codelineno-11-22 href=#__codelineno-11-22></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-11-23><a id=__codelineno-11-23 name=__codelineno-11-23 href=#__codelineno-11-23></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>requestManager</span><span class=p>;</span>
</span><span id=__span-11-24><a id=__codelineno-11-24 name=__codelineno-11-24 href=#__codelineno-11-24></a><span class=p>}</span>
</span><span id=__span-11-25><a id=__codelineno-11-25 name=__codelineno-11-25 href=#__codelineno-11-25></a>
</span><span id=__span-11-26><a id=__codelineno-11-26 name=__codelineno-11-26 href=#__codelineno-11-26></a><span class=c1>// 🐟🐟🐟看看Fragment怎么才能高效</span>
</span><span id=__span-11-27><a id=__codelineno-11-27 name=__codelineno-11-27 href=#__codelineno-11-27></a><span class=nd>@NonNull</span>
</span><span id=__span-11-28><a id=__codelineno-11-28 name=__codelineno-11-28 href=#__codelineno-11-28></a><span class=kd>private</span><span class=w> </span><span class=n>SupportRequestManagerFragment</span><span class=w> </span><span class=nf>getSupportRequestManagerFragment</span><span class=p>(</span>
</span><span id=__span-11-29><a id=__codelineno-11-29 name=__codelineno-11-29 href=#__codelineno-11-29></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>FragmentManager</span><span class=w> </span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Fragment</span><span class=w> </span><span class=n>parentHint</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isParentVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>      </span>
</span><span id=__span-11-30><a id=__codelineno-11-30 name=__codelineno-11-30 href=#__codelineno-11-30></a><span class=w>  </span><span class=c1>// 已经添加过了，可以直接返回</span>
</span><span id=__span-11-31><a id=__codelineno-11-31 name=__codelineno-11-31 href=#__codelineno-11-31></a><span class=w>  </span><span class=n>SupportRequestManagerFragment</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-11-32><a id=__codelineno-11-32 name=__codelineno-11-32 href=#__codelineno-11-32></a><span class=w>      </span><span class=p>(</span><span class=n>SupportRequestManagerFragment</span><span class=p>)</span><span class=w> </span><span class=n>fm</span><span class=p>.</span><span class=na>findFragmentByTag</span><span class=p>(</span><span class=n>FRAGMENT_TAG</span><span class=p>);</span>
</span><span id=__span-11-33><a id=__codelineno-11-33 name=__codelineno-11-33 href=#__codelineno-11-33></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-34><a id=__codelineno-11-34 name=__codelineno-11-34 href=#__codelineno-11-34></a><span class=w>    </span><span class=c1>// 从map中获取，取到也可以返回了</span>
</span><span id=__span-11-35><a id=__codelineno-11-35 name=__codelineno-11-35 href=#__codelineno-11-35></a><span class=w>    </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pendingSupportRequestManagerFragments</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>fm</span><span class=p>);</span>
</span><span id=__span-11-36><a id=__codelineno-11-36 name=__codelineno-11-36 href=#__codelineno-11-36></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-37><a id=__codelineno-11-37 name=__codelineno-11-37 href=#__codelineno-11-37></a><span class=w>      </span><span class=c1>// 都没有，那么就创建一个，此时lifecycle默认为ActivityFragmentLifecycle</span>
</span><span id=__span-11-38><a id=__codelineno-11-38 name=__codelineno-11-38 href=#__codelineno-11-38></a><span class=w>      </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SupportRequestManagerFragment</span><span class=p>();</span>
</span><span id=__span-11-39><a id=__codelineno-11-39 name=__codelineno-11-39 href=#__codelineno-11-39></a><span class=w>      </span><span class=c1>// 对于fragment来说，此方法会以Activity为host创建另外一个SupportRequestManagerFragment</span>
</span><span id=__span-11-40><a id=__codelineno-11-40 name=__codelineno-11-40 href=#__codelineno-11-40></a><span class=w>      </span><span class=c1>// 作为rootRequestManagerFragment</span>
</span><span id=__span-11-41><a id=__codelineno-11-41 name=__codelineno-11-41 href=#__codelineno-11-41></a><span class=w>      </span><span class=c1>// 并会将current加入到rootRequestManagerFragment的childRequestManagerFragments中</span>
</span><span id=__span-11-42><a id=__codelineno-11-42 name=__codelineno-11-42 href=#__codelineno-11-42></a><span class=w>      </span><span class=c1>// 在RequestManager递归管理请求时会使用到</span>
</span><span id=__span-11-43><a id=__codelineno-11-43 name=__codelineno-11-43 href=#__codelineno-11-43></a><span class=w>      </span><span class=n>current</span><span class=p>.</span><span class=na>setParentFragmentHint</span><span class=p>(</span><span class=n>parentHint</span><span class=p>);</span>
</span><span id=__span-11-44><a id=__codelineno-11-44 name=__codelineno-11-44 href=#__codelineno-11-44></a><span class=w>      </span><span class=c1>// 如果当前页面是可见的，那么调用其lifecycle的onStart方法</span>
</span><span id=__span-11-45><a id=__codelineno-11-45 name=__codelineno-11-45 href=#__codelineno-11-45></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isParentVisible</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-11-46><a id=__codelineno-11-46 name=__codelineno-11-46 href=#__codelineno-11-46></a><span class=w>        </span><span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>().</span><span class=na>onStart</span><span class=p>();</span>
</span><span id=__span-11-47><a id=__codelineno-11-47 name=__codelineno-11-47 href=#__codelineno-11-47></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-11-48><a id=__codelineno-11-48 name=__codelineno-11-48 href=#__codelineno-11-48></a><span class=w>      </span><span class=c1>// 将刚创建的fragment缓存起来</span>
</span><span id=__span-11-49><a id=__codelineno-11-49 name=__codelineno-11-49 href=#__codelineno-11-49></a><span class=w>      </span><span class=n>pendingSupportRequestManagerFragments</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>fm</span><span class=p>,</span><span class=w> </span><span class=n>current</span><span class=p>);</span>
</span><span id=__span-11-50><a id=__codelineno-11-50 name=__codelineno-11-50 href=#__codelineno-11-50></a><span class=w>      </span><span class=c1>// 将fragment添加到页面中</span>
</span><span id=__span-11-51><a id=__codelineno-11-51 name=__codelineno-11-51 href=#__codelineno-11-51></a><span class=w>      </span><span class=n>fm</span><span class=p>.</span><span class=na>beginTransaction</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=n>current</span><span class=p>,</span><span class=w> </span><span class=n>FRAGMENT_TAG</span><span class=p>).</span><span class=na>commitAllowingStateLoss</span><span class=p>();</span>
</span><span id=__span-11-52><a id=__codelineno-11-52 name=__codelineno-11-52 href=#__codelineno-11-52></a><span class=w>      </span><span class=c1>// 以fm为key从pendingSupportRequestManagerFragments中删除</span>
</span><span id=__span-11-53><a id=__codelineno-11-53 name=__codelineno-11-53 href=#__codelineno-11-53></a><span class=w>      </span><span class=n>handler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=p>,</span><span class=w> </span><span class=n>fm</span><span class=p>).</span><span class=na>sendToTarget</span><span class=p>();</span>
</span><span id=__span-11-54><a id=__codelineno-11-54 name=__codelineno-11-54 href=#__codelineno-11-54></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-11-55><a id=__codelineno-11-55 name=__codelineno-11-55 href=#__codelineno-11-55></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-11-56><a id=__codelineno-11-56 name=__codelineno-11-56 href=#__codelineno-11-56></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>current</span><span class=p>;</span>
</span><span id=__span-11-57><a id=__codelineno-11-57 name=__codelineno-11-57 href=#__codelineno-11-57></a><span class=p>}</span>
</span></code></pre></div> <p>🔥🔥🔥在上面的<code>supportFragmentGet</code>方法中，成功创建了一个<code>RequestManager</code>对象，由于<code>factory</code>是<code>DEFAULT_FACTORY</code>，所以就是下面的值：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>  </span><span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>(),</span><span class=w>          </span><span class=c1>// ActivityFragmentLifecycle()</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>  </span><span class=n>current</span><span class=p>.</span><span class=na>getRequestManagerTreeNode</span><span class=p>(),</span><span class=w>  </span><span class=c1>// SupportFragmentRequestManagerTreeNode()</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>  </span><span class=n>context</span><span class=p>);</span>
</span></code></pre></div> <p>好👏👏👏，在上一步中<code>Glide</code>单例完成了初始化，这一步中成功的创建并返回了一个<code>RequestManager</code>。<code>Glide.with</code>已经分析完毕。</p> <h2 id=2-requestmanagerload>2. RequestManager.load<a class=headerlink href=#2-requestmanagerload title="Permanent link">&para;</a></h2> <p><code>RequestManager.load</code>方法的重载也很多，但该方法只是设置了一些值而已，并没有做一些很重的工作。</p> <p>因为这里涉及到类有点绕，所以在正式探索之前，我们看一下相关的类的UML图：</p> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/glide-request-options-uml.png> <figcaption>RequestOptions相关UML图</figcaption> </figure> <p>这里我们可以看出来<code>RequestBuilder</code>和<code>RequestOptions</code>都派生自抽象类<code>BaseRequestOptions</code>。</p> <p>下面我们看一下<code>RequestManager</code>的一些方法，先看<code>load</code>的一些重载方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=nd>@NonNull</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=nd>@Override</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=n>bitmap</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>bitmap</span><span class=p>);</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a><span class=p>}</span>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=nd>@NonNull</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=nd>@Override</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>drawable</span><span class=p>);</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a><span class=p>}</span>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a><span class=nd>@NonNull</span>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a><span class=nd>@Override</span>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>string</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=p>}</span>
</span><span id=__span-13-21><a id=__codelineno-13-21 name=__codelineno-13-21 href=#__codelineno-13-21></a>
</span><span id=__span-13-22><a id=__codelineno-13-22 name=__codelineno-13-22 href=#__codelineno-13-22></a><span class=nd>@NonNull</span>
</span><span id=__span-13-23><a id=__codelineno-13-23 name=__codelineno-13-23 href=#__codelineno-13-23></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-24><a id=__codelineno-13-24 name=__codelineno-13-24 href=#__codelineno-13-24></a><span class=nd>@Override</span>
</span><span id=__span-13-25><a id=__codelineno-13-25 name=__codelineno-13-25 href=#__codelineno-13-25></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-26><a id=__codelineno-13-26 name=__codelineno-13-26 href=#__codelineno-13-26></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
</span><span id=__span-13-27><a id=__codelineno-13-27 name=__codelineno-13-27 href=#__codelineno-13-27></a><span class=p>}</span>
</span><span id=__span-13-28><a id=__codelineno-13-28 name=__codelineno-13-28 href=#__codelineno-13-28></a>
</span><span id=__span-13-29><a id=__codelineno-13-29 name=__codelineno-13-29 href=#__codelineno-13-29></a><span class=nd>@NonNull</span>
</span><span id=__span-13-30><a id=__codelineno-13-30 name=__codelineno-13-30 href=#__codelineno-13-30></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-31><a id=__codelineno-13-31 name=__codelineno-13-31 href=#__codelineno-13-31></a><span class=nd>@Override</span>
</span><span id=__span-13-32><a id=__codelineno-13-32 name=__codelineno-13-32 href=#__codelineno-13-32></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-33><a id=__codelineno-13-33 name=__codelineno-13-33 href=#__codelineno-13-33></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span><span id=__span-13-34><a id=__codelineno-13-34 name=__codelineno-13-34 href=#__codelineno-13-34></a><span class=p>}</span>
</span><span id=__span-13-35><a id=__codelineno-13-35 name=__codelineno-13-35 href=#__codelineno-13-35></a>
</span><span id=__span-13-36><a id=__codelineno-13-36 name=__codelineno-13-36 href=#__codelineno-13-36></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-13-37><a id=__codelineno-13-37 name=__codelineno-13-37 href=#__codelineno-13-37></a><span class=nd>@NonNull</span>
</span><span id=__span-13-38><a id=__codelineno-13-38 name=__codelineno-13-38 href=#__codelineno-13-38></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-39><a id=__codelineno-13-39 name=__codelineno-13-39 href=#__codelineno-13-39></a><span class=nd>@Override</span>
</span><span id=__span-13-40><a id=__codelineno-13-40 name=__codelineno-13-40 href=#__codelineno-13-40></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@RawRes</span><span class=w> </span><span class=nd>@DrawableRes</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>resourceId</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-41><a id=__codelineno-13-41 name=__codelineno-13-41 href=#__codelineno-13-41></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>resourceId</span><span class=p>);</span>
</span><span id=__span-13-42><a id=__codelineno-13-42 name=__codelineno-13-42 href=#__codelineno-13-42></a><span class=p>}</span>
</span><span id=__span-13-43><a id=__codelineno-13-43 name=__codelineno-13-43 href=#__codelineno-13-43></a>
</span><span id=__span-13-44><a id=__codelineno-13-44 name=__codelineno-13-44 href=#__codelineno-13-44></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
</span><span id=__span-13-45><a id=__codelineno-13-45 name=__codelineno-13-45 href=#__codelineno-13-45></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-46><a id=__codelineno-13-46 name=__codelineno-13-46 href=#__codelineno-13-46></a><span class=nd>@Override</span>
</span><span id=__span-13-47><a id=__codelineno-13-47 name=__codelineno-13-47 href=#__codelineno-13-47></a><span class=nd>@Deprecated</span>
</span><span id=__span-13-48><a id=__codelineno-13-48 name=__codelineno-13-48 href=#__codelineno-13-48></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-49><a id=__codelineno-13-49 name=__codelineno-13-49 href=#__codelineno-13-49></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
</span><span id=__span-13-50><a id=__codelineno-13-50 name=__codelineno-13-50 href=#__codelineno-13-50></a><span class=p>}</span>
</span><span id=__span-13-51><a id=__codelineno-13-51 name=__codelineno-13-51 href=#__codelineno-13-51></a>
</span><span id=__span-13-52><a id=__codelineno-13-52 name=__codelineno-13-52 href=#__codelineno-13-52></a><span class=nd>@NonNull</span>
</span><span id=__span-13-53><a id=__codelineno-13-53 name=__codelineno-13-53 href=#__codelineno-13-53></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-54><a id=__codelineno-13-54 name=__codelineno-13-54 href=#__codelineno-13-54></a><span class=nd>@Override</span>
</span><span id=__span-13-55><a id=__codelineno-13-55 name=__codelineno-13-55 href=#__codelineno-13-55></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-56><a id=__codelineno-13-56 name=__codelineno-13-56 href=#__codelineno-13-56></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-13-57><a id=__codelineno-13-57 name=__codelineno-13-57 href=#__codelineno-13-57></a><span class=p>}</span>
</span><span id=__span-13-58><a id=__codelineno-13-58 name=__codelineno-13-58 href=#__codelineno-13-58></a>
</span><span id=__span-13-59><a id=__codelineno-13-59 name=__codelineno-13-59 href=#__codelineno-13-59></a><span class=nd>@NonNull</span>
</span><span id=__span-13-60><a id=__codelineno-13-60 name=__codelineno-13-60 href=#__codelineno-13-60></a><span class=nd>@CheckResult</span>
</span><span id=__span-13-61><a id=__codelineno-13-61 name=__codelineno-13-61 href=#__codelineno-13-61></a><span class=nd>@Override</span>
</span><span id=__span-13-62><a id=__codelineno-13-62 name=__codelineno-13-62 href=#__codelineno-13-62></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-13-63><a id=__codelineno-13-63 name=__codelineno-13-63 href=#__codelineno-13-63></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-13-64><a id=__codelineno-13-64 name=__codelineno-13-64 href=#__codelineno-13-64></a><span class=p>}</span>
</span></code></pre></div> <p>在所有的<code>RequestManager.load</code>方法中都会先调用<code>asDrawable()</code>方法得到一个<code>RequestBuilder</code>对象，然后再调用<code>RequestBuilder.load</code>方法。 </p> <h3 id=21-requestmanagerasxxx>2.1 RequestManager.asXxx<a class=headerlink href=#21-requestmanagerasxxx title="Permanent link">&para;</a></h3> <p><code>asDrawable</code>方法同其他as方法（<code>asGif</code>、<code>asBitmap</code>、<code>asFile</code>）一样，都会先调用<code>RequestManager.as</code>方法生成一个<code>RequestBuilder&lt;ResourceType&gt;</code>对象，然后各个as方法会附加一些不同的options：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=nd>@NonNull</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=nd>@CheckResult</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=w> </span><span class=nf>asBitmap</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>as</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_BITMAP</span><span class=p>);</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=p>}</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
</span><span id=__span-14-7><a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=nd>@NonNull</span>
</span><span id=__span-14-8><a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=nd>@CheckResult</span>
</span><span id=__span-14-9><a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>asGif</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-10><a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>);</span>
</span><span id=__span-14-11><a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=p>}</span><span class=w>  </span>
</span><span id=__span-14-12><a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a>
</span><span id=__span-14-13><a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=nd>@NonNull</span>
</span><span id=__span-14-14><a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=nd>@CheckResult</span>
</span><span id=__span-14-15><a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>asDrawable</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-16><a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>as</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
</span><span id=__span-14-17><a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=p>}</span>
</span><span id=__span-14-18><a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a>
</span><span id=__span-14-19><a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=nd>@NonNull</span>
</span><span id=__span-14-20><a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=nd>@CheckResult</span>
</span><span id=__span-14-21><a id=__codelineno-14-21 name=__codelineno-14-21 href=#__codelineno-14-21></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span><span class=w> </span><span class=nf>asFile</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-22><a id=__codelineno-14-22 name=__codelineno-14-22 href=#__codelineno-14-22></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>as</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span>
</span><span id=__span-14-23><a id=__codelineno-14-23 name=__codelineno-14-23 href=#__codelineno-14-23></a><span class=p>}</span>
</span><span id=__span-14-24><a id=__codelineno-14-24 name=__codelineno-14-24 href=#__codelineno-14-24></a>
</span><span id=__span-14-25><a id=__codelineno-14-25 name=__codelineno-14-25 href=#__codelineno-14-25></a><span class=nd>@NonNull</span>
</span><span id=__span-14-26><a id=__codelineno-14-26 name=__codelineno-14-26 href=#__codelineno-14-26></a><span class=nd>@CheckResult</span>
</span><span id=__span-14-27><a id=__codelineno-14-27 name=__codelineno-14-27 href=#__codelineno-14-27></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>as</span><span class=p>(</span>
</span><span id=__span-14-28><a id=__codelineno-14-28 name=__codelineno-14-28 href=#__codelineno-14-28></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-14-29><a id=__codelineno-14-29 name=__codelineno-14-29 href=#__codelineno-14-29></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-14-30><a id=__codelineno-14-30 name=__codelineno-14-30 href=#__codelineno-14-30></a><span class=p>}</span>
</span></code></pre></div> <p>在<code>RequestBuilder</code>的构造器方法方法中将<code>Drawable.class</code>这样的入参保存到了<code>transcodeClass</code>变量中：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;CheckResult&quot;</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.ConstructorCallsOverridableMethod&quot;</span><span class=p>)</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=kd>protected</span><span class=w> </span><span class=nf>RequestBuilder</span><span class=p>(</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Glide</span><span class=w> </span><span class=n>glide</span><span class=p>,</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=w>    </span><span class=n>RequestManager</span><span class=w> </span><span class=n>requestManager</span><span class=p>,</span>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=w>    </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a><span class=w>    </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>glide</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glide</span><span class=p>;</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>requestManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestManager</span><span class=p>;</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>transcodeClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>;</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>context</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>;</span>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>transitionOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultTransitionOptions</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>glideContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glide</span><span class=p>.</span><span class=na>getGlideContext</span><span class=p>();</span>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=w>  </span><span class=n>initRequestListeners</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultRequestListeners</span><span class=p>());</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=w>  </span><span class=n>apply</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultRequestOptions</span><span class=p>());</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a><span class=p>}</span>
</span></code></pre></div> <p>然后回到之前的<code>asGif</code>方法中，看看<code>apply(DECODE_TYPE_BITMAP)</code>干了些什么：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// RequestManager</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>RequestOptions</span><span class=w> </span><span class=n>DECODE_TYPE_GIF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RequestOptions</span><span class=p>.</span><span class=na>decodeTypeOf</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>lock</span><span class=p>();</span>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=nd>@NonNull</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=nd>@CheckResult</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span><span class=w> </span><span class=nf>asGif</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>);</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=p>}</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=c1>// RequestOptions</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=nd>@NonNull</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=nd>@CheckResult</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>RequestOptions</span><span class=w> </span><span class=nf>decodeTypeOf</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RequestOptions</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=p>}</span>
</span><span id=__span-16-16><a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a>
</span><span id=__span-16-17><a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=c1>// BaseRequestOptions</span>
</span><span id=__span-16-18><a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=nd>@NonNull</span>
</span><span id=__span-16-19><a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=nd>@CheckResult</span>
</span><span id=__span-16-20><a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>decode</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-21><a id=__codelineno-16-21 name=__codelineno-16-21 href=#__codelineno-16-21></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-22><a id=__codelineno-16-22 name=__codelineno-16-22 href=#__codelineno-16-22></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>clone</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-16-23><a id=__codelineno-16-23 name=__codelineno-16-23 href=#__codelineno-16-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-24><a id=__codelineno-16-24 name=__codelineno-16-24 href=#__codelineno-16-24></a>
</span><span id=__span-16-25><a id=__codelineno-16-25 name=__codelineno-16-25 href=#__codelineno-16-25></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-16-26><a id=__codelineno-16-26 name=__codelineno-16-26 href=#__codelineno-16-26></a><span class=w>  </span><span class=n>fields</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>RESOURCE_CLASS</span><span class=p>;</span>
</span><span id=__span-16-27><a id=__codelineno-16-27 name=__codelineno-16-27 href=#__codelineno-16-27></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span><span id=__span-16-28><a id=__codelineno-16-28 name=__codelineno-16-28 href=#__codelineno-16-28></a><span class=p>}</span>
</span><span id=__span-16-29><a id=__codelineno-16-29 name=__codelineno-16-29 href=#__codelineno-16-29></a>
</span><span id=__span-16-30><a id=__codelineno-16-30 name=__codelineno-16-30 href=#__codelineno-16-30></a><span class=nd>@NonNull</span>
</span><span id=__span-16-31><a id=__codelineno-16-31 name=__codelineno-16-31 href=#__codelineno-16-31></a><span class=nd>@CheckResult</span>
</span><span id=__span-16-32><a id=__codelineno-16-32 name=__codelineno-16-32 href=#__codelineno-16-32></a><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>o</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-33><a id=__codelineno-16-33 name=__codelineno-16-33 href=#__codelineno-16-33></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-34><a id=__codelineno-16-34 name=__codelineno-16-34 href=#__codelineno-16-34></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>clone</span><span class=p>().</span><span class=na>apply</span><span class=p>(</span><span class=n>o</span><span class=p>);</span>
</span><span id=__span-16-35><a id=__codelineno-16-35 name=__codelineno-16-35 href=#__codelineno-16-35></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-36><a id=__codelineno-16-36 name=__codelineno-16-36 href=#__codelineno-16-36></a><span class=w>  </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>other</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>o</span><span class=p>;</span>
</span><span id=__span-16-37><a id=__codelineno-16-37 name=__codelineno-16-37 href=#__codelineno-16-37></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-16-38><a id=__codelineno-16-38 name=__codelineno-16-38 href=#__codelineno-16-38></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isSet</span><span class=p>(</span><span class=n>other</span><span class=p>.</span><span class=na>fields</span><span class=p>,</span><span class=w> </span><span class=n>RESOURCE_CLASS</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-39><a id=__codelineno-16-39 name=__codelineno-16-39 href=#__codelineno-16-39></a><span class=w>    </span><span class=n>resourceClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>other</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>;</span>
</span><span id=__span-16-40><a id=__codelineno-16-40 name=__codelineno-16-40 href=#__codelineno-16-40></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-16-41><a id=__codelineno-16-41 name=__codelineno-16-41 href=#__codelineno-16-41></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-16-42><a id=__codelineno-16-42 name=__codelineno-16-42 href=#__codelineno-16-42></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span><span id=__span-16-43><a id=__codelineno-16-43 name=__codelineno-16-43 href=#__codelineno-16-43></a><span class=p>}</span>
</span><span id=__span-16-44><a id=__codelineno-16-44 name=__codelineno-16-44 href=#__codelineno-16-44></a>
</span><span id=__span-16-45><a id=__codelineno-16-45 name=__codelineno-16-45 href=#__codelineno-16-45></a><span class=c1>// RequestBuilder</span>
</span><span id=__span-16-46><a id=__codelineno-16-46 name=__codelineno-16-46 href=#__codelineno-16-46></a><span class=nd>@NonNull</span>
</span><span id=__span-16-47><a id=__codelineno-16-47 name=__codelineno-16-47 href=#__codelineno-16-47></a><span class=nd>@CheckResult</span>
</span><span id=__span-16-48><a id=__codelineno-16-48 name=__codelineno-16-48 href=#__codelineno-16-48></a><span class=nd>@Override</span>
</span><span id=__span-16-49><a id=__codelineno-16-49 name=__codelineno-16-49 href=#__codelineno-16-49></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>apply</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>requestOptions</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-16-50><a id=__codelineno-16-50 name=__codelineno-16-50 href=#__codelineno-16-50></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>requestOptions</span><span class=p>);</span>
</span><span id=__span-16-51><a id=__codelineno-16-51 name=__codelineno-16-51 href=#__codelineno-16-51></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>requestOptions</span><span class=p>);</span>
</span><span id=__span-16-52><a id=__codelineno-16-52 name=__codelineno-16-52 href=#__codelineno-16-52></a><span class=p>}</span>
</span></code></pre></div> <p>不难发现，<code>apply(DECODE_TYPE_BITMAP)</code>就是将<code>BaseRequestOptions.resourceClass</code>设置为了<code>GifDrawable.class</code>；对于<code>asBitmap()</code>来说，<code>resourceClass</code>为<code>Bitmap.class</code>；而对于<code>asDrawable()</code>和<code>asFile()</code>来说，<code>resourceClass</code>没有进行过设置，所以为默认值<code>Object.class</code>。</p> <p>现在<code>RequestBuilder</code>已经由as系列方法生成，现在接着会调用<code>RequestBuilder.load</code>方法</p> <h3 id=22-requestbuilderload>2.2 RequestBuilder.load<a class=headerlink href=#22-requestbuilderload title="Permanent link">&para;</a></h3> <p><code>RequestManager.load</code>方法都会调用对应的<code>RequestBuilder.load</code>重载方法；<code>RequestBuilder.load</code>的各个方法基本上都会直接转发给<code>loadGeneric</code>方法，只有少数的方法才会apply额外的options。</p> <p><code>loadGeneric</code>方法也只是保存一下参数而已：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=nd>@NonNull</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=nd>@Override</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=p>}</span>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>
</span><span id=__span-17-9><a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=nd>@NonNull</span>
</span><span id=__span-17-10><a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-11><a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=nd>@Override</span>
</span><span id=__span-17-12><a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Bitmap</span><span class=w> </span><span class=n>bitmap</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-13><a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>bitmap</span><span class=p>)</span>
</span><span id=__span-17-14><a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>      </span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
</span><span id=__span-17-15><a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=p>}</span>
</span><span id=__span-17-16><a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a>
</span><span id=__span-17-17><a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=nd>@NonNull</span>
</span><span id=__span-17-18><a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-19><a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=nd>@Override</span>
</span><span id=__span-17-20><a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-21><a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>drawable</span><span class=p>)</span>
</span><span id=__span-17-22><a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=w>      </span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
</span><span id=__span-17-23><a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=p>}</span>
</span><span id=__span-17-24><a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a>
</span><span id=__span-17-25><a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=nd>@NonNull</span>
</span><span id=__span-17-26><a id=__codelineno-17-26 name=__codelineno-17-26 href=#__codelineno-17-26></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-27><a id=__codelineno-17-27 name=__codelineno-17-27 href=#__codelineno-17-27></a><span class=nd>@Override</span>
</span><span id=__span-17-28><a id=__codelineno-17-28 name=__codelineno-17-28 href=#__codelineno-17-28></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-29><a id=__codelineno-17-29 name=__codelineno-17-29 href=#__codelineno-17-29></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
</span><span id=__span-17-30><a id=__codelineno-17-30 name=__codelineno-17-30 href=#__codelineno-17-30></a><span class=p>}</span>
</span><span id=__span-17-31><a id=__codelineno-17-31 name=__codelineno-17-31 href=#__codelineno-17-31></a>
</span><span id=__span-17-32><a id=__codelineno-17-32 name=__codelineno-17-32 href=#__codelineno-17-32></a><span class=nd>@NonNull</span>
</span><span id=__span-17-33><a id=__codelineno-17-33 name=__codelineno-17-33 href=#__codelineno-17-33></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-34><a id=__codelineno-17-34 name=__codelineno-17-34 href=#__codelineno-17-34></a><span class=nd>@Override</span>
</span><span id=__span-17-35><a id=__codelineno-17-35 name=__codelineno-17-35 href=#__codelineno-17-35></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-36><a id=__codelineno-17-36 name=__codelineno-17-36 href=#__codelineno-17-36></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span><span id=__span-17-37><a id=__codelineno-17-37 name=__codelineno-17-37 href=#__codelineno-17-37></a><span class=p>}</span>
</span><span id=__span-17-38><a id=__codelineno-17-38 name=__codelineno-17-38 href=#__codelineno-17-38></a>
</span><span id=__span-17-39><a id=__codelineno-17-39 name=__codelineno-17-39 href=#__codelineno-17-39></a><span class=nd>@NonNull</span>
</span><span id=__span-17-40><a id=__codelineno-17-40 name=__codelineno-17-40 href=#__codelineno-17-40></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-41><a id=__codelineno-17-41 name=__codelineno-17-41 href=#__codelineno-17-41></a><span class=nd>@Override</span>
</span><span id=__span-17-42><a id=__codelineno-17-42 name=__codelineno-17-42 href=#__codelineno-17-42></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@RawRes</span><span class=w> </span><span class=nd>@DrawableRes</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Integer</span><span class=w> </span><span class=n>resourceId</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-43><a id=__codelineno-17-43 name=__codelineno-17-43 href=#__codelineno-17-43></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>resourceId</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>signatureOf</span><span class=p>(</span><span class=n>ApplicationVersionSignature</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>context</span><span class=p>)));</span>
</span><span id=__span-17-44><a id=__codelineno-17-44 name=__codelineno-17-44 href=#__codelineno-17-44></a><span class=p>}</span>
</span><span id=__span-17-45><a id=__codelineno-17-45 name=__codelineno-17-45 href=#__codelineno-17-45></a>
</span><span id=__span-17-46><a id=__codelineno-17-46 name=__codelineno-17-46 href=#__codelineno-17-46></a><span class=nd>@Deprecated</span>
</span><span id=__span-17-47><a id=__codelineno-17-47 name=__codelineno-17-47 href=#__codelineno-17-47></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-48><a id=__codelineno-17-48 name=__codelineno-17-48 href=#__codelineno-17-48></a><span class=nd>@Override</span>
</span><span id=__span-17-49><a id=__codelineno-17-49 name=__codelineno-17-49 href=#__codelineno-17-49></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=n>url</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-50><a id=__codelineno-17-50 name=__codelineno-17-50 href=#__codelineno-17-50></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
</span><span id=__span-17-51><a id=__codelineno-17-51 name=__codelineno-17-51 href=#__codelineno-17-51></a><span class=p>}</span>
</span><span id=__span-17-52><a id=__codelineno-17-52 name=__codelineno-17-52 href=#__codelineno-17-52></a>
</span><span id=__span-17-53><a id=__codelineno-17-53 name=__codelineno-17-53 href=#__codelineno-17-53></a><span class=nd>@NonNull</span>
</span><span id=__span-17-54><a id=__codelineno-17-54 name=__codelineno-17-54 href=#__codelineno-17-54></a><span class=nd>@CheckResult</span>
</span><span id=__span-17-55><a id=__codelineno-17-55 name=__codelineno-17-55 href=#__codelineno-17-55></a><span class=nd>@Override</span>
</span><span id=__span-17-56><a id=__codelineno-17-56 name=__codelineno-17-56 href=#__codelineno-17-56></a><span class=kd>public</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-57><a id=__codelineno-17-57 name=__codelineno-17-57 href=#__codelineno-17-57></a><span class=w>  </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadGeneric</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-17-58><a id=__codelineno-17-58 name=__codelineno-17-58 href=#__codelineno-17-58></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isDiskCacheStrategySet</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-59><a id=__codelineno-17-59 name=__codelineno-17-59 href=#__codelineno-17-59></a><span class=w>      </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
</span><span id=__span-17-60><a id=__codelineno-17-60 name=__codelineno-17-60 href=#__codelineno-17-60></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-17-61><a id=__codelineno-17-61 name=__codelineno-17-61 href=#__codelineno-17-61></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isSkipMemoryCacheSet</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-62><a id=__codelineno-17-62 name=__codelineno-17-62 href=#__codelineno-17-62></a><span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/*skipMemoryCache*/</span><span class=p>));</span>
</span><span id=__span-17-63><a id=__codelineno-17-63 name=__codelineno-17-63 href=#__codelineno-17-63></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-17-64><a id=__codelineno-17-64 name=__codelineno-17-64 href=#__codelineno-17-64></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-17-65><a id=__codelineno-17-65 name=__codelineno-17-65 href=#__codelineno-17-65></a><span class=p>}</span>
</span><span id=__span-17-66><a id=__codelineno-17-66 name=__codelineno-17-66 href=#__codelineno-17-66></a>
</span><span id=__span-17-67><a id=__codelineno-17-67 name=__codelineno-17-67 href=#__codelineno-17-67></a><span class=nd>@NonNull</span>
</span><span id=__span-17-68><a id=__codelineno-17-68 name=__codelineno-17-68 href=#__codelineno-17-68></a><span class=kd>private</span><span class=w> </span><span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>loadGeneric</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-17-69><a id=__codelineno-17-69 name=__codelineno-17-69 href=#__codelineno-17-69></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>model</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>model</span><span class=p>;</span>
</span><span id=__span-17-70><a id=__codelineno-17-70 name=__codelineno-17-70 href=#__codelineno-17-70></a><span class=w>  </span><span class=n>isModelSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-17-71><a id=__codelineno-17-71 name=__codelineno-17-71 href=#__codelineno-17-71></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-17-72><a id=__codelineno-17-72 name=__codelineno-17-72 href=#__codelineno-17-72></a><span class=p>}</span>
</span></code></pre></div> <p>如上面最后的方法<code>loadGeneric</code>，这里只是将参数保存在<code>model</code>中并设置<code>isModelSet=true</code>就完了，看来Glide进行图片加载的最核心的步骤应该就是<code>RequestBuilder.into</code>方法了。</p> <h2 id=3-requestbuilderinto>3. RequestBuilder.into<a class=headerlink href=#3-requestbuilderinto title="Permanent link">&para;</a></h2> <p>Glide三步中前两步还是比较简单的，真正令人头大的位置就是本节要深入探索的<code>into</code>方法了。因为Glide各种配置相当多，各种分支全部列出来还是相当繁琐的，而且一次性全部看完也是不可能的。所以此处只探索最基本的源码。</p> <p><code>RequestBuilder.into</code>有四个重载方法，最终都调用了参数最多的一个：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=nd>@NonNull</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Y</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=nf>into</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>into</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=cm>/*targetListener=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=p>}</span>
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a><span class=nd>@NonNull</span>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=nd>@Synthetic</span>
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a><span class=o>&lt;</span><span class=n>Y</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=nf>into</span><span class=p>(</span>
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-18-11><a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-12><a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>into</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span><span class=w> </span><span class=cm>/*options=*/</span><span class=w> </span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-18-13><a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a><span class=p>}</span>
</span><span id=__span-18-14><a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>
</span><span id=__span-18-15><a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Y</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=nf>into</span><span class=p>(</span>
</span><span id=__span-18-16><a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-18-17><a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-18-18><a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a><span class=w>    </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>options</span><span class=p>,</span>
</span><span id=__span-18-19><a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-20><a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a><span class=w>  </span><span class=p>...</span><span class=w> </span><span class=c1>//见后文分解</span>
</span><span id=__span-18-21><a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a><span class=p>}</span>
</span><span id=__span-18-22><a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a>
</span><span id=__span-18-23><a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a><span class=c1>// 🤚🤚🤚 这是我们最常用的一个重载</span>
</span><span id=__span-18-24><a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a><span class=nd>@NonNull</span>
</span><span id=__span-18-25><a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a><span class=kd>public</span><span class=w> </span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span><span class=w> </span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>into</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ImageView</span><span class=w> </span><span class=n>view</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-26><a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a><span class=w>  </span><span class=c1>// sanity check</span>
</span><span id=__span-18-27><a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a><span class=w>  </span><span class=n>Util</span><span class=p>.</span><span class=na>assertMainThread</span><span class=p>();</span>
</span><span id=__span-18-28><a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
</span><span id=__span-18-29><a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a>
</span><span id=__span-18-30><a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a><span class=w>  </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>requestOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-18-31><a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a><span class=w>  </span><span class=c1>// 若没有指定transform，isTransformationSet()为false</span>
</span><span id=__span-18-32><a id=__codelineno-18-32 name=__codelineno-18-32 href=#__codelineno-18-32></a><span class=w>  </span><span class=c1>// isTransformationAllowed()一般为true，除非主动调用了dontTransform()方法</span>
</span><span id=__span-18-33><a id=__codelineno-18-33 name=__codelineno-18-33 href=#__codelineno-18-33></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationSet</span><span class=p>()</span>
</span><span id=__span-18-34><a id=__codelineno-18-34 name=__codelineno-18-34 href=#__codelineno-18-34></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationAllowed</span><span class=p>()</span>
</span><span id=__span-18-35><a id=__codelineno-18-35 name=__codelineno-18-35 href=#__codelineno-18-35></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>view</span><span class=p>.</span><span class=na>getScaleType</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-36><a id=__codelineno-18-36 name=__codelineno-18-36 href=#__codelineno-18-36></a><span class=w>    </span><span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then</span>
</span><span id=__span-18-37><a id=__codelineno-18-37 name=__codelineno-18-37 href=#__codelineno-18-37></a><span class=w>    </span><span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous</span>
</span><span id=__span-18-38><a id=__codelineno-18-38 name=__codelineno-18-38 href=#__codelineno-18-38></a><span class=w>    </span><span class=c1>// View&#39;s scale type.</span>
</span><span id=__span-18-39><a id=__codelineno-18-39 name=__codelineno-18-39 href=#__codelineno-18-39></a><span class=w>    </span><span class=c1>//</span>
</span><span id=__span-18-40><a id=__codelineno-18-40 name=__codelineno-18-40 href=#__codelineno-18-40></a><span class=w>    </span><span class=c1>// 根据ImageView的ScaleType设置不同的down sample和transform选项</span>
</span><span id=__span-18-41><a id=__codelineno-18-41 name=__codelineno-18-41 href=#__codelineno-18-41></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getScaleType</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-18-42><a id=__codelineno-18-42 name=__codelineno-18-42 href=#__codelineno-18-42></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>CENTER_CROP</span><span class=p>:</span>
</span><span id=__span-18-43><a id=__codelineno-18-43 name=__codelineno-18-43 href=#__codelineno-18-43></a><span class=w>        </span><span class=n>requestOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterCrop</span><span class=p>();</span>
</span><span id=__span-18-44><a id=__codelineno-18-44 name=__codelineno-18-44 href=#__codelineno-18-44></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-18-45><a id=__codelineno-18-45 name=__codelineno-18-45 href=#__codelineno-18-45></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>CENTER_INSIDE</span><span class=p>:</span>
</span><span id=__span-18-46><a id=__codelineno-18-46 name=__codelineno-18-46 href=#__codelineno-18-46></a><span class=w>        </span><span class=n>requestOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterInside</span><span class=p>();</span>
</span><span id=__span-18-47><a id=__codelineno-18-47 name=__codelineno-18-47 href=#__codelineno-18-47></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-18-48><a id=__codelineno-18-48 name=__codelineno-18-48 href=#__codelineno-18-48></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>FIT_CENTER</span><span class=p>:</span><span class=w>  </span><span class=c1>// 默认值</span>
</span><span id=__span-18-49><a id=__codelineno-18-49 name=__codelineno-18-49 href=#__codelineno-18-49></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>FIT_START</span><span class=p>:</span>
</span><span id=__span-18-50><a id=__codelineno-18-50 name=__codelineno-18-50 href=#__codelineno-18-50></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>FIT_END</span><span class=p>:</span>
</span><span id=__span-18-51><a id=__codelineno-18-51 name=__codelineno-18-51 href=#__codelineno-18-51></a><span class=w>        </span><span class=n>requestOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalFitCenter</span><span class=p>();</span>
</span><span id=__span-18-52><a id=__codelineno-18-52 name=__codelineno-18-52 href=#__codelineno-18-52></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-18-53><a id=__codelineno-18-53 name=__codelineno-18-53 href=#__codelineno-18-53></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>FIT_XY</span><span class=p>:</span>
</span><span id=__span-18-54><a id=__codelineno-18-54 name=__codelineno-18-54 href=#__codelineno-18-54></a><span class=w>        </span><span class=n>requestOptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterInside</span><span class=p>();</span>
</span><span id=__span-18-55><a id=__codelineno-18-55 name=__codelineno-18-55 href=#__codelineno-18-55></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-18-56><a id=__codelineno-18-56 name=__codelineno-18-56 href=#__codelineno-18-56></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>CENTER</span><span class=p>:</span>
</span><span id=__span-18-57><a id=__codelineno-18-57 name=__codelineno-18-57 href=#__codelineno-18-57></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>MATRIX</span><span class=p>:</span>
</span><span id=__span-18-58><a id=__codelineno-18-58 name=__codelineno-18-58 href=#__codelineno-18-58></a><span class=w>      </span><span class=k>default</span><span class=p>:</span>
</span><span id=__span-18-59><a id=__codelineno-18-59 name=__codelineno-18-59 href=#__codelineno-18-59></a><span class=w>        </span><span class=c1>// Do nothing.</span>
</span><span id=__span-18-60><a id=__codelineno-18-60 name=__codelineno-18-60 href=#__codelineno-18-60></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-18-61><a id=__codelineno-18-61 name=__codelineno-18-61 href=#__codelineno-18-61></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-18-62><a id=__codelineno-18-62 name=__codelineno-18-62 href=#__codelineno-18-62></a>
</span><span id=__span-18-63><a id=__codelineno-18-63 name=__codelineno-18-63 href=#__codelineno-18-63></a><span class=w>  </span><span class=c1>// 调用上面的重载方法</span>
</span><span id=__span-18-64><a id=__codelineno-18-64 name=__codelineno-18-64 href=#__codelineno-18-64></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>into</span><span class=p>(</span>
</span><span id=__span-18-65><a id=__codelineno-18-65 name=__codelineno-18-65 href=#__codelineno-18-65></a><span class=w>      </span><span class=n>glideContext</span><span class=p>.</span><span class=na>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>),</span>
</span><span id=__span-18-66><a id=__codelineno-18-66 name=__codelineno-18-66 href=#__codelineno-18-66></a><span class=w>      </span><span class=cm>/*targetListener=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-18-67><a id=__codelineno-18-67 name=__codelineno-18-67 href=#__codelineno-18-67></a><span class=w>      </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-18-68><a id=__codelineno-18-68 name=__codelineno-18-68 href=#__codelineno-18-68></a><span class=w>      </span><span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
</span><span id=__span-18-69><a id=__codelineno-18-69 name=__codelineno-18-69 href=#__codelineno-18-69></a><span class=p>}</span>
</span></code></pre></div> <p>我们看看<code>into(ImageView)</code>方法的实现，里面会先判断需不需要对图片进行裁切，然后调用别的<code>into</code>重载方法。重载方法我们稍后在说，先看看case为默认值<code>FIT_CENTER</code>时的情况：</p> <p>首先会调用<code>requestOptions.clone()</code>对原始的RequestOptions进行复制，其目的源码中写了：当使用此RequestOptions加载到一个View，然后加载到另外一个目标时，不要保留基于上一个View的scale type所产生的transformation。 </p> <p>复制完成之后，然后会接着调用<code>optionalFitCenter()</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=nd>@NonNull</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=nd>@CheckResult</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>optionalFitCenter</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>optionalScaleOnlyTransform</span><span class=p>(</span><span class=n>DownsampleStrategy</span><span class=p>.</span><span class=na>FIT_CENTER</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FitCenter</span><span class=p>());</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=p>}</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=nd>@NonNull</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a><span class=kd>private</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>optionalScaleOnlyTransform</span><span class=p>(</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DownsampleStrategy</span><span class=w> </span><span class=n>strategy</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformation</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>scaleOnlyTransform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=w> </span><span class=cm>/*isTransformationRequired*/</span><span class=p>);</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a><span class=p>}</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a><span class=nd>@NonNull</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a><span class=kd>private</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>scaleOnlyTransform</span><span class=p>(</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DownsampleStrategy</span><span class=w> </span><span class=n>strategy</span><span class=p>,</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformation</span><span class=p>,</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isTransformationRequired</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-19><a id=__codelineno-19-19 name=__codelineno-19-19 href=#__codelineno-19-19></a><span class=w>  </span><span class=n>BaseRequestOptions</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isTransformationRequired</span>
</span><span id=__span-19-20><a id=__codelineno-19-20 name=__codelineno-19-20 href=#__codelineno-19-20></a><span class=w>        </span><span class=o>?</span><span class=w> </span><span class=n>transform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>)</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>optionalTransform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>);</span>
</span><span id=__span-19-21><a id=__codelineno-19-21 name=__codelineno-19-21 href=#__codelineno-19-21></a><span class=w>  </span><span class=n>result</span><span class=p>.</span><span class=na>isScaleOnlyOrNoTransform</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-19-22><a id=__codelineno-19-22 name=__codelineno-19-22 href=#__codelineno-19-22></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-19-23><a id=__codelineno-19-23 name=__codelineno-19-23 href=#__codelineno-19-23></a><span class=p>}</span>
</span><span id=__span-19-24><a id=__codelineno-19-24 name=__codelineno-19-24 href=#__codelineno-19-24></a>
</span><span id=__span-19-25><a id=__codelineno-19-25 name=__codelineno-19-25 href=#__codelineno-19-25></a><span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;CheckResult&quot;</span><span class=p>})</span>
</span><span id=__span-19-26><a id=__codelineno-19-26 name=__codelineno-19-26 href=#__codelineno-19-26></a><span class=nd>@NonNull</span>
</span><span id=__span-19-27><a id=__codelineno-19-27 name=__codelineno-19-27 href=#__codelineno-19-27></a><span class=kd>final</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>optionalTransform</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DownsampleStrategy</span><span class=w> </span><span class=n>downsampleStrategy</span><span class=p>,</span>
</span><span id=__span-19-28><a id=__codelineno-19-28 name=__codelineno-19-28 href=#__codelineno-19-28></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformation</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-29><a id=__codelineno-19-29 name=__codelineno-19-29 href=#__codelineno-19-29></a><span class=w>  </span><span class=c1>// isAutoCloneEnabled默认为false，只有在主动调用了autoClone()方法之后才会为true</span>
</span><span id=__span-19-30><a id=__codelineno-19-30 name=__codelineno-19-30 href=#__codelineno-19-30></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-31><a id=__codelineno-19-31 name=__codelineno-19-31 href=#__codelineno-19-31></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>clone</span><span class=p>().</span><span class=na>optionalTransform</span><span class=p>(</span><span class=n>downsampleStrategy</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>);</span>
</span><span id=__span-19-32><a id=__codelineno-19-32 name=__codelineno-19-32 href=#__codelineno-19-32></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-33><a id=__codelineno-19-33 name=__codelineno-19-33 href=#__codelineno-19-33></a>
</span><span id=__span-19-34><a id=__codelineno-19-34 name=__codelineno-19-34 href=#__codelineno-19-34></a><span class=w>  </span><span class=n>downsample</span><span class=p>(</span><span class=n>downsampleStrategy</span><span class=p>);</span>
</span><span id=__span-19-35><a id=__codelineno-19-35 name=__codelineno-19-35 href=#__codelineno-19-35></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>transform</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=cm>/*isRequired=*/</span><span class=w> </span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-19-36><a id=__codelineno-19-36 name=__codelineno-19-36 href=#__codelineno-19-36></a><span class=p>}</span>
</span><span id=__span-19-37><a id=__codelineno-19-37 name=__codelineno-19-37 href=#__codelineno-19-37></a>
</span><span id=__span-19-38><a id=__codelineno-19-38 name=__codelineno-19-38 href=#__codelineno-19-38></a><span class=nd>@NonNull</span>
</span><span id=__span-19-39><a id=__codelineno-19-39 name=__codelineno-19-39 href=#__codelineno-19-39></a><span class=nd>@CheckResult</span>
</span><span id=__span-19-40><a id=__codelineno-19-40 name=__codelineno-19-40 href=#__codelineno-19-40></a><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>downsample</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DownsampleStrategy</span><span class=w> </span><span class=n>strategy</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-41><a id=__codelineno-19-41 name=__codelineno-19-41 href=#__codelineno-19-41></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>set</span><span class=p>(</span><span class=n>DownsampleStrategy</span><span class=p>.</span><span class=na>OPTION</span><span class=p>,</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>strategy</span><span class=p>));</span>
</span><span id=__span-19-42><a id=__codelineno-19-42 name=__codelineno-19-42 href=#__codelineno-19-42></a><span class=p>}</span>
</span><span id=__span-19-43><a id=__codelineno-19-43 name=__codelineno-19-43 href=#__codelineno-19-43></a>
</span><span id=__span-19-44><a id=__codelineno-19-44 name=__codelineno-19-44 href=#__codelineno-19-44></a><span class=nd>@NonNull</span>
</span><span id=__span-19-45><a id=__codelineno-19-45 name=__codelineno-19-45 href=#__codelineno-19-45></a><span class=nd>@CheckResult</span>
</span><span id=__span-19-46><a id=__codelineno-19-46 name=__codelineno-19-46 href=#__codelineno-19-46></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>set</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Option</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>option</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=n>value</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-47><a id=__codelineno-19-47 name=__codelineno-19-47 href=#__codelineno-19-47></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-48><a id=__codelineno-19-48 name=__codelineno-19-48 href=#__codelineno-19-48></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>clone</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>option</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span>
</span><span id=__span-19-49><a id=__codelineno-19-49 name=__codelineno-19-49 href=#__codelineno-19-49></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-50><a id=__codelineno-19-50 name=__codelineno-19-50 href=#__codelineno-19-50></a>
</span><span id=__span-19-51><a id=__codelineno-19-51 name=__codelineno-19-51 href=#__codelineno-19-51></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>option</span><span class=p>);</span>
</span><span id=__span-19-52><a id=__codelineno-19-52 name=__codelineno-19-52 href=#__codelineno-19-52></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
</span><span id=__span-19-53><a id=__codelineno-19-53 name=__codelineno-19-53 href=#__codelineno-19-53></a><span class=w>  </span><span class=n>options</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>option</span><span class=p>,</span><span class=w> </span><span class=n>value</span><span class=p>);</span>
</span><span id=__span-19-54><a id=__codelineno-19-54 name=__codelineno-19-54 href=#__codelineno-19-54></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span><span id=__span-19-55><a id=__codelineno-19-55 name=__codelineno-19-55 href=#__codelineno-19-55></a><span class=p>}</span>
</span><span id=__span-19-56><a id=__codelineno-19-56 name=__codelineno-19-56 href=#__codelineno-19-56></a>
</span><span id=__span-19-57><a id=__codelineno-19-57 name=__codelineno-19-57 href=#__codelineno-19-57></a><span class=nd>@NonNull</span>
</span><span id=__span-19-58><a id=__codelineno-19-58 name=__codelineno-19-58 href=#__codelineno-19-58></a><span class=n>T</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span>
</span><span id=__span-19-59><a id=__codelineno-19-59 name=__codelineno-19-59 href=#__codelineno-19-59></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isRequired</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-60><a id=__codelineno-19-60 name=__codelineno-19-60 href=#__codelineno-19-60></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-61><a id=__codelineno-19-61 name=__codelineno-19-61 href=#__codelineno-19-61></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>clone</span><span class=p>().</span><span class=na>transform</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-62><a id=__codelineno-19-62 name=__codelineno-19-62 href=#__codelineno-19-62></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-63><a id=__codelineno-19-63 name=__codelineno-19-63 href=#__codelineno-19-63></a>
</span><span id=__span-19-64><a id=__codelineno-19-64 name=__codelineno-19-64 href=#__codelineno-19-64></a><span class=w>  </span><span class=n>DrawableTransformation</span><span class=w> </span><span class=n>drawableTransformation</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-19-65><a id=__codelineno-19-65 name=__codelineno-19-65 href=#__codelineno-19-65></a><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>DrawableTransformation</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-66><a id=__codelineno-19-66 name=__codelineno-19-66 href=#__codelineno-19-66></a><span class=w>  </span><span class=n>transform</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-67><a id=__codelineno-19-67 name=__codelineno-19-67 href=#__codelineno-19-67></a><span class=w>  </span><span class=n>transform</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>drawableTransformation</span><span class=p>,</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-68><a id=__codelineno-19-68 name=__codelineno-19-68 href=#__codelineno-19-68></a><span class=w>  </span><span class=c1>// TODO: remove BitmapDrawable decoder and this transformation.</span>
</span><span id=__span-19-69><a id=__codelineno-19-69 name=__codelineno-19-69 href=#__codelineno-19-69></a><span class=w>  </span><span class=c1>// Registering as BitmapDrawable is simply an optimization to avoid some iteration and</span>
</span><span id=__span-19-70><a id=__codelineno-19-70 name=__codelineno-19-70 href=#__codelineno-19-70></a><span class=w>  </span><span class=c1>// isAssignableFrom checks when obtaining the transformation later on. It can be removed without</span>
</span><span id=__span-19-71><a id=__codelineno-19-71 name=__codelineno-19-71 href=#__codelineno-19-71></a><span class=w>  </span><span class=c1>// affecting the functionality.</span>
</span><span id=__span-19-72><a id=__codelineno-19-72 name=__codelineno-19-72 href=#__codelineno-19-72></a><span class=w>  </span><span class=n>transform</span><span class=p>(</span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>drawableTransformation</span><span class=p>.</span><span class=na>asBitmapDrawable</span><span class=p>(),</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-73><a id=__codelineno-19-73 name=__codelineno-19-73 href=#__codelineno-19-73></a><span class=w>  </span><span class=n>transform</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GifDrawableTransformation</span><span class=p>(</span><span class=n>transformation</span><span class=p>),</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-74><a id=__codelineno-19-74 name=__codelineno-19-74 href=#__codelineno-19-74></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span><span id=__span-19-75><a id=__codelineno-19-75 name=__codelineno-19-75 href=#__codelineno-19-75></a><span class=p>}</span>
</span><span id=__span-19-76><a id=__codelineno-19-76 name=__codelineno-19-76 href=#__codelineno-19-76></a>
</span><span id=__span-19-77><a id=__codelineno-19-77 name=__codelineno-19-77 href=#__codelineno-19-77></a><span class=nd>@NonNull</span>
</span><span id=__span-19-78><a id=__codelineno-19-78 name=__codelineno-19-78 href=#__codelineno-19-78></a><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>transform</span><span class=p>(</span>
</span><span id=__span-19-79><a id=__codelineno-19-79 name=__codelineno-19-79 href=#__codelineno-19-79></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-19-80><a id=__codelineno-19-80 name=__codelineno-19-80 href=#__codelineno-19-80></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformation</span><span class=p>,</span>
</span><span id=__span-19-81><a id=__codelineno-19-81 name=__codelineno-19-81 href=#__codelineno-19-81></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isRequired</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-82><a id=__codelineno-19-82 name=__codelineno-19-82 href=#__codelineno-19-82></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-83><a id=__codelineno-19-83 name=__codelineno-19-83 href=#__codelineno-19-83></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>clone</span><span class=p>().</span><span class=na>transform</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>,</span><span class=w> </span><span class=n>isRequired</span><span class=p>);</span>
</span><span id=__span-19-84><a id=__codelineno-19-84 name=__codelineno-19-84 href=#__codelineno-19-84></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-85><a id=__codelineno-19-85 name=__codelineno-19-85 href=#__codelineno-19-85></a>
</span><span id=__span-19-86><a id=__codelineno-19-86 name=__codelineno-19-86 href=#__codelineno-19-86></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-19-87><a id=__codelineno-19-87 name=__codelineno-19-87 href=#__codelineno-19-87></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>transformation</span><span class=p>);</span>
</span><span id=__span-19-88><a id=__codelineno-19-88 name=__codelineno-19-88 href=#__codelineno-19-88></a><span class=w>  </span><span class=n>transformations</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transformation</span><span class=p>);</span>
</span><span id=__span-19-89><a id=__codelineno-19-89 name=__codelineno-19-89 href=#__codelineno-19-89></a><span class=w>  </span><span class=n>fields</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>TRANSFORMATION</span><span class=p>;</span>
</span><span id=__span-19-90><a id=__codelineno-19-90 name=__codelineno-19-90 href=#__codelineno-19-90></a><span class=w>  </span><span class=n>isTransformationAllowed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-19-91><a id=__codelineno-19-91 name=__codelineno-19-91 href=#__codelineno-19-91></a><span class=w>  </span><span class=n>fields</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>TRANSFORMATION_ALLOWED</span><span class=p>;</span>
</span><span id=__span-19-92><a id=__codelineno-19-92 name=__codelineno-19-92 href=#__codelineno-19-92></a><span class=w>  </span><span class=c1>// Always set to false here. Known scale only transformations will call this method and then</span>
</span><span id=__span-19-93><a id=__codelineno-19-93 name=__codelineno-19-93 href=#__codelineno-19-93></a><span class=w>  </span><span class=c1>// set isScaleOnlyOrNoTransform to true immediately after.</span>
</span><span id=__span-19-94><a id=__codelineno-19-94 name=__codelineno-19-94 href=#__codelineno-19-94></a><span class=w>  </span><span class=n>isScaleOnlyOrNoTransform</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-19-95><a id=__codelineno-19-95 name=__codelineno-19-95 href=#__codelineno-19-95></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isRequired</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-19-96><a id=__codelineno-19-96 name=__codelineno-19-96 href=#__codelineno-19-96></a><span class=w>    </span><span class=n>fields</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>TRANSFORMATION_REQUIRED</span><span class=p>;</span>
</span><span id=__span-19-97><a id=__codelineno-19-97 name=__codelineno-19-97 href=#__codelineno-19-97></a><span class=w>    </span><span class=n>isTransformationRequired</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-19-98><a id=__codelineno-19-98 name=__codelineno-19-98 href=#__codelineno-19-98></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-19-99><a id=__codelineno-19-99 name=__codelineno-19-99 href=#__codelineno-19-99></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
</span><span id=__span-19-100><a id=__codelineno-19-100 name=__codelineno-19-100 href=#__codelineno-19-100></a><span class=p>}</span>
</span></code></pre></div> <p>上面这些操作实际上只是几个值保存到<code>BaseRequestOptions</code>内部的两个<code>CachedHashCodeArrayMap</code>里面，其中键值对以及保存到的位置如下：</p> <figcaption>optionalFitCenter()过程保存的KV</figcaption> <table> <thead> <tr> <th>保存的位置</th> <th>K</th> <th>V</th> </tr> </thead> <tbody> <tr> <td>Options.values</td> <td>DownsampleStrategy.OPTION</td> <td>DownsampleStrategy.FitCenter()</td> </tr> <tr> <td>transformations</td> <td>Bitmap.class</td> <td>FitCenter()</td> </tr> <tr> <td>transformations</td> <td>Drawable.class</td> <td>DrawableTransformation(FitCenter(), false)</td> </tr> <tr> <td>transformations</td> <td>BitmapDrawable.class</td> <td>DrawableTransformation(FitCenter(), false).asBitmapDrawable()</td> </tr> <tr> <td>transformations</td> <td>GifDrawable.class</td> <td>GifDrawableTransformation(FitCenter())</td> </tr> </tbody> </table> <p>将KV保存好了之后，就准备调用最终的<code>into</code>方法了，我们看一下入参：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=n>into</span><span class=p>(</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=w>    </span><span class=n>glideContext</span><span class=p>.</span><span class=na>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>),</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=w>    </span><span class=cm>/*targetListener=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a><span class=w>    </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a><span class=w>    </span><span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
</span></code></pre></div> <p>第一个参数等于<code>(ViewTarget&lt;ImageView, Drawable&gt;) new DrawableImageViewTarget(view)</code>：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=c1>// GlideContext</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=nd>@NonNull</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span><span class=w> </span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span><span class=w> </span><span class=n>X</span><span class=o>&gt;</span><span class=w> </span><span class=nf>buildImageViewTarget</span><span class=p>(</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ImageView</span><span class=w> </span><span class=n>imageView</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=w>  </span><span class=c1>// imageViewTargetFactory是ImageViewTargetFactory的一个实例</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=w>  </span><span class=c1>// transcodeClass在RequestManager.load方法中确定了，就是Drawable.class</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>imageViewTargetFactory</span><span class=p>.</span><span class=na>buildTarget</span><span class=p>(</span><span class=n>imageView</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=p>}</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=c1>// ImageViewTargetFactory</span>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=nd>@NonNull</span>
</span><span id=__span-21-12><a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-21-13><a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span><span class=w> </span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=nf>buildTarget</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ImageView</span><span class=w> </span><span class=n>view</span><span class=p>,</span>
</span><span id=__span-21-14><a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>clazz</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-15><a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>clazz</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-16><a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span><span class=w> </span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
</span><span id=__span-21-17><a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>clazz</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-18><a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=w>    </span><span class=c1>// 返回的是(ViewTarget&lt;ImageView, Drawable&gt;) new DrawableImageViewTarget(view);</span>
</span><span id=__span-21-19><a id=__codelineno-21-19 name=__codelineno-21-19 href=#__codelineno-21-19></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span><span class=w> </span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DrawableImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
</span><span id=__span-21-20><a id=__codelineno-21-20 name=__codelineno-21-20 href=#__codelineno-21-20></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-21-21><a id=__codelineno-21-21 name=__codelineno-21-21 href=#__codelineno-21-21></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span>
</span><span id=__span-21-22><a id=__codelineno-21-22 name=__codelineno-21-22 href=#__codelineno-21-22></a><span class=w>        </span><span class=s>&quot;Unhandled class: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>clazz</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;</span><span class=p>);</span>
</span><span id=__span-21-23><a id=__codelineno-21-23 name=__codelineno-21-23 href=#__codelineno-21-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-21-24><a id=__codelineno-21-24 name=__codelineno-21-24 href=#__codelineno-21-24></a><span class=p>}</span>
</span></code></pre></div> <p><code>Executors.mainThreadExecutor()</code>就是一个使用MainLooper的Handler，在execute Runnable时使用此Handler post出去。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=w>  </span><span class=cm>/** Posts executions to the main thread. */</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=nf>mainThreadExecutor</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>MAIN_THREAD_EXECUTOR</span><span class=p>;</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-22-5><a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>
</span><span id=__span-22-6><a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=n>MAIN_THREAD_EXECUTOR</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-22-7><a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>Executor</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-8><a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Handler</span><span class=w> </span><span class=n>handler</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>());</span>
</span><span id=__span-22-9><a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>
</span><span id=__span-22-10><a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-22-11><a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-22-12><a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a><span class=w>          </span><span class=n>handler</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
</span><span id=__span-22-13><a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-22-14><a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a><span class=w>      </span><span class=p>};</span>
</span></code></pre></div> <p>现在我们终于回到了最终的<code>load</code>重载方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Y</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=nf>into</span><span class=p>(</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a><span class=w>    </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>options</span><span class=p>,</span>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=w>  </span><span class=c1>// sanity check</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=w>  </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isModelSet</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;You must call #load() before calling #into()&quot;</span><span class=p>);</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a><span class=w>  </span><span class=c1>// 创建了一个SingleRequest，见后面️⛰️⛰️⛰️</span>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=w>  </span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>buildRequest</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=w>  </span><span class=c1>// 这里会判断需不需要重新开始任务</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a><span class=w>  </span><span class=c1>// 如果当前request和target上之前的request previous相等</span>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=w>  </span><span class=c1>// 且设置了忽略内存缓存或previous还没有完成</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a><span class=w>  </span><span class=c1>// 那么会进入if分支，无需进行一些相关设置，这是一个很好的优化</span>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=w>  </span><span class=n>Request</span><span class=w> </span><span class=n>previous</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>target</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isEquivalentTo</span><span class=p>(</span><span class=n>previous</span><span class=p>)</span>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isSkipMemoryCacheWithCompletePreviousRequest</span><span class=p>(</span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>previous</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a><span class=w>    </span><span class=n>request</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a><span class=w>    </span><span class=c1>// If the request is completed, beginning again will ensure the result is re-delivered,</span>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a><span class=w>    </span><span class=c1>// triggering RequestListeners and Targets. If the request is failed, beginning again will</span>
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25 href=#__codelineno-23-25></a><span class=w>    </span><span class=c1>// restart the request, giving it another chance to complete. If the request is already</span>
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26 href=#__codelineno-23-26></a><span class=w>    </span><span class=c1>// running, we can let it continue running without interruption.</span>
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27 href=#__codelineno-23-27></a><span class=w>    </span><span class=c1>// 如果正在运行，就不管它；如果已经失败了，就重新开始</span>
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28 href=#__codelineno-23-28></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>previous</span><span class=p>).</span><span class=na>isRunning</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-23-29><a id=__codelineno-23-29 name=__codelineno-23-29 href=#__codelineno-23-29></a><span class=w>      </span><span class=c1>// Use the previous request rather than the new one to allow for optimizations like skipping</span>
</span><span id=__span-23-30><a id=__codelineno-23-30 name=__codelineno-23-30 href=#__codelineno-23-30></a><span class=w>      </span><span class=c1>// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions</span>
</span><span id=__span-23-31><a id=__codelineno-23-31 name=__codelineno-23-31 href=#__codelineno-23-31></a><span class=w>      </span><span class=c1>// that are done in the individual Request.</span>
</span><span id=__span-23-32><a id=__codelineno-23-32 name=__codelineno-23-32 href=#__codelineno-23-32></a><span class=w>      </span><span class=n>previous</span><span class=p>.</span><span class=na>begin</span><span class=p>();</span>
</span><span id=__span-23-33><a id=__codelineno-23-33 name=__codelineno-23-33 href=#__codelineno-23-33></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-23-34><a id=__codelineno-23-34 name=__codelineno-23-34 href=#__codelineno-23-34></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>target</span><span class=p>;</span>
</span><span id=__span-23-35><a id=__codelineno-23-35 name=__codelineno-23-35 href=#__codelineno-23-35></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-23-36><a id=__codelineno-23-36 name=__codelineno-23-36 href=#__codelineno-23-36></a>
</span><span id=__span-23-37><a id=__codelineno-23-37 name=__codelineno-23-37 href=#__codelineno-23-37></a><span class=w>  </span><span class=c1>// 如果不能复用previous</span>
</span><span id=__span-23-38><a id=__codelineno-23-38 name=__codelineno-23-38 href=#__codelineno-23-38></a><span class=w>  </span><span class=c1>// 先清除target上之前的Request</span>
</span><span id=__span-23-39><a id=__codelineno-23-39 name=__codelineno-23-39 href=#__codelineno-23-39></a><span class=w>  </span><span class=n>requestManager</span><span class=p>.</span><span class=na>clear</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
</span><span id=__span-23-40><a id=__codelineno-23-40 name=__codelineno-23-40 href=#__codelineno-23-40></a><span class=w>  </span><span class=c1>// 将Request作为tag设置到view中</span>
</span><span id=__span-23-41><a id=__codelineno-23-41 name=__codelineno-23-41 href=#__codelineno-23-41></a><span class=w>  </span><span class=n>target</span><span class=p>.</span><span class=na>setRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-23-42><a id=__codelineno-23-42 name=__codelineno-23-42 href=#__codelineno-23-42></a><span class=w>  </span><span class=c1>// 😷😷😷 真正开始网络图片的加载</span>
</span><span id=__span-23-43><a id=__codelineno-23-43 name=__codelineno-23-43 href=#__codelineno-23-43></a><span class=w>  </span><span class=n>requestManager</span><span class=p>.</span><span class=na>track</span><span class=p>(</span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-23-44><a id=__codelineno-23-44 name=__codelineno-23-44 href=#__codelineno-23-44></a>
</span><span id=__span-23-45><a id=__codelineno-23-45 name=__codelineno-23-45 href=#__codelineno-23-45></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>target</span><span class=p>;</span>
</span><span id=__span-23-46><a id=__codelineno-23-46 name=__codelineno-23-46 href=#__codelineno-23-46></a><span class=p>}</span>
</span></code></pre></div> <h3 id=31-buildrequest>3.1 buildRequest<a class=headerlink href=#31-buildrequest title="Permanent link">&para;</a></h3> <p>⛰️⛰️⛰️ 这里跟踪一下<code>buildRequest</code>的流程，看看是如何创建出<code>SingleRequest</code>的。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=kd>private</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=nf>buildRequest</span><span class=p>(</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=w>    </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=w>    </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>buildRequestRecursive</span><span class=p>(</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=w>      </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=w>      </span><span class=n>targetListener</span><span class=p>,</span><span class=w>                       </span><span class=c1>// null</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=w>      </span><span class=cm>/*parentCoordinator=*/</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=w>      </span><span class=n>transitionOptions</span><span class=p>,</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=w>      </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span><span class=w>         </span><span class=c1>// Priority.NORMAL</span>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=w>      </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getOverrideWidth</span><span class=p>(),</span><span class=w>    </span><span class=c1>// UNSET</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=w>      </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getOverrideHeight</span><span class=p>(),</span><span class=w>   </span><span class=c1>// UNSET</span>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=w>      </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=w>      </span><span class=n>callbackExecutor</span><span class=p>);</span><span class=w>                    </span><span class=c1>// Executors.mainThreadExecutor()</span>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=p>}</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=kd>private</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=nf>buildRequestRecursive</span><span class=p>(</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=w>    </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestCoordinator</span><span class=w> </span><span class=n>parentCoordinator</span><span class=p>,</span>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=w>    </span><span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>transitionOptions</span><span class=p>,</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=w>    </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>overrideWidth</span><span class=p>,</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>,</span>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=w>    </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a><span class=w>  </span><span class=c1>// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a><span class=w>  </span><span class=n>ErrorRequestCoordinator</span><span class=w> </span><span class=n>errorRequestCoordinator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-24-31><a id=__codelineno-24-31 name=__codelineno-24-31 href=#__codelineno-24-31></a><span class=w>  </span><span class=c1>// errorBuilder为null, skip</span>
</span><span id=__span-24-32><a id=__codelineno-24-32 name=__codelineno-24-32 href=#__codelineno-24-32></a><span class=w>  </span><span class=c1>// 因此errorRequestCoordinator为null</span>
</span><span id=__span-24-33><a id=__codelineno-24-33 name=__codelineno-24-33 href=#__codelineno-24-33></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>errorBuilder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-34><a id=__codelineno-24-34 name=__codelineno-24-34 href=#__codelineno-24-34></a><span class=w>    </span><span class=n>errorRequestCoordinator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ErrorRequestCoordinator</span><span class=p>(</span><span class=n>parentCoordinator</span><span class=p>);</span>
</span><span id=__span-24-35><a id=__codelineno-24-35 name=__codelineno-24-35 href=#__codelineno-24-35></a><span class=w>    </span><span class=n>parentCoordinator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errorRequestCoordinator</span><span class=p>;</span>
</span><span id=__span-24-36><a id=__codelineno-24-36 name=__codelineno-24-36 href=#__codelineno-24-36></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-24-37><a id=__codelineno-24-37 name=__codelineno-24-37 href=#__codelineno-24-37></a>
</span><span id=__span-24-38><a id=__codelineno-24-38 name=__codelineno-24-38 href=#__codelineno-24-38></a><span class=w>  </span><span class=c1>// 如何获得SingleRequest</span>
</span><span id=__span-24-39><a id=__codelineno-24-39 name=__codelineno-24-39 href=#__codelineno-24-39></a><span class=w>  </span><span class=n>Request</span><span class=w> </span><span class=n>mainRequest</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-24-40><a id=__codelineno-24-40 name=__codelineno-24-40 href=#__codelineno-24-40></a><span class=w>      </span><span class=n>buildThumbnailRequestRecursive</span><span class=p>(</span>
</span><span id=__span-24-41><a id=__codelineno-24-41 name=__codelineno-24-41 href=#__codelineno-24-41></a><span class=w>          </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-42><a id=__codelineno-24-42 name=__codelineno-24-42 href=#__codelineno-24-42></a><span class=w>          </span><span class=n>targetListener</span><span class=p>,</span><span class=w>       </span><span class=c1>// null</span>
</span><span id=__span-24-43><a id=__codelineno-24-43 name=__codelineno-24-43 href=#__codelineno-24-43></a><span class=w>          </span><span class=n>parentCoordinator</span><span class=p>,</span><span class=w>    </span><span class=c1>// null</span>
</span><span id=__span-24-44><a id=__codelineno-24-44 name=__codelineno-24-44 href=#__codelineno-24-44></a><span class=w>          </span><span class=n>transitionOptions</span><span class=p>,</span>
</span><span id=__span-24-45><a id=__codelineno-24-45 name=__codelineno-24-45 href=#__codelineno-24-45></a><span class=w>          </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-24-46><a id=__codelineno-24-46 name=__codelineno-24-46 href=#__codelineno-24-46></a><span class=w>          </span><span class=n>overrideWidth</span><span class=p>,</span>
</span><span id=__span-24-47><a id=__codelineno-24-47 name=__codelineno-24-47 href=#__codelineno-24-47></a><span class=w>          </span><span class=n>overrideHeight</span><span class=p>,</span>
</span><span id=__span-24-48><a id=__codelineno-24-48 name=__codelineno-24-48 href=#__codelineno-24-48></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-49><a id=__codelineno-24-49 name=__codelineno-24-49 href=#__codelineno-24-49></a><span class=w>          </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-24-50><a id=__codelineno-24-50 name=__codelineno-24-50 href=#__codelineno-24-50></a>
</span><span id=__span-24-51><a id=__codelineno-24-51 name=__codelineno-24-51 href=#__codelineno-24-51></a><span class=w>  </span><span class=c1>// errorRequestCoordinator为null</span>
</span><span id=__span-24-52><a id=__codelineno-24-52 name=__codelineno-24-52 href=#__codelineno-24-52></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>errorRequestCoordinator</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-53><a id=__codelineno-24-53 name=__codelineno-24-53 href=#__codelineno-24-53></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>mainRequest</span><span class=p>;</span>
</span><span id=__span-24-54><a id=__codelineno-24-54 name=__codelineno-24-54 href=#__codelineno-24-54></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-24-55><a id=__codelineno-24-55 name=__codelineno-24-55 href=#__codelineno-24-55></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-24-56><a id=__codelineno-24-56 name=__codelineno-24-56 href=#__codelineno-24-56></a><span class=p>}</span>
</span><span id=__span-24-57><a id=__codelineno-24-57 name=__codelineno-24-57 href=#__codelineno-24-57></a>
</span><span id=__span-24-58><a id=__codelineno-24-58 name=__codelineno-24-58 href=#__codelineno-24-58></a><span class=kd>private</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=nf>buildThumbnailRequestRecursive</span><span class=p>(</span>
</span><span id=__span-24-59><a id=__codelineno-24-59 name=__codelineno-24-59 href=#__codelineno-24-59></a><span class=w>    </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-60><a id=__codelineno-24-60 name=__codelineno-24-60 href=#__codelineno-24-60></a><span class=w>    </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-24-61><a id=__codelineno-24-61 name=__codelineno-24-61 href=#__codelineno-24-61></a><span class=w>    </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>RequestCoordinator</span><span class=w> </span><span class=n>parentCoordinator</span><span class=p>,</span>
</span><span id=__span-24-62><a id=__codelineno-24-62 name=__codelineno-24-62 href=#__codelineno-24-62></a><span class=w>    </span><span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>transitionOptions</span><span class=p>,</span>
</span><span id=__span-24-63><a id=__codelineno-24-63 name=__codelineno-24-63 href=#__codelineno-24-63></a><span class=w>    </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-24-64><a id=__codelineno-24-64 name=__codelineno-24-64 href=#__codelineno-24-64></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>overrideWidth</span><span class=p>,</span>
</span><span id=__span-24-65><a id=__codelineno-24-65 name=__codelineno-24-65 href=#__codelineno-24-65></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>,</span>
</span><span id=__span-24-66><a id=__codelineno-24-66 name=__codelineno-24-66 href=#__codelineno-24-66></a><span class=w>    </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-67><a id=__codelineno-24-67 name=__codelineno-24-67 href=#__codelineno-24-67></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-68><a id=__codelineno-24-68 name=__codelineno-24-68 href=#__codelineno-24-68></a><span class=w>  </span><span class=c1>// thumbnail重载方法没有调用过，所以会走最后的else case</span>
</span><span id=__span-24-69><a id=__codelineno-24-69 name=__codelineno-24-69 href=#__codelineno-24-69></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>thumbnailBuilder</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-70><a id=__codelineno-24-70 name=__codelineno-24-70 href=#__codelineno-24-70></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-24-71><a id=__codelineno-24-71 name=__codelineno-24-71 href=#__codelineno-24-71></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>thumbSizeMultiplier</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-72><a id=__codelineno-24-72 name=__codelineno-24-72 href=#__codelineno-24-72></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-24-73><a id=__codelineno-24-73 name=__codelineno-24-73 href=#__codelineno-24-73></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-74><a id=__codelineno-24-74 name=__codelineno-24-74 href=#__codelineno-24-74></a><span class=w>    </span><span class=c1>// Base case: no thumbnail.</span>
</span><span id=__span-24-75><a id=__codelineno-24-75 name=__codelineno-24-75 href=#__codelineno-24-75></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>obtainRequest</span><span class=p>(</span>
</span><span id=__span-24-76><a id=__codelineno-24-76 name=__codelineno-24-76 href=#__codelineno-24-76></a><span class=w>        </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-77><a id=__codelineno-24-77 name=__codelineno-24-77 href=#__codelineno-24-77></a><span class=w>        </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-24-78><a id=__codelineno-24-78 name=__codelineno-24-78 href=#__codelineno-24-78></a><span class=w>        </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-79><a id=__codelineno-24-79 name=__codelineno-24-79 href=#__codelineno-24-79></a><span class=w>        </span><span class=n>parentCoordinator</span><span class=p>,</span>
</span><span id=__span-24-80><a id=__codelineno-24-80 name=__codelineno-24-80 href=#__codelineno-24-80></a><span class=w>        </span><span class=n>transitionOptions</span><span class=p>,</span>
</span><span id=__span-24-81><a id=__codelineno-24-81 name=__codelineno-24-81 href=#__codelineno-24-81></a><span class=w>        </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-24-82><a id=__codelineno-24-82 name=__codelineno-24-82 href=#__codelineno-24-82></a><span class=w>        </span><span class=n>overrideWidth</span><span class=p>,</span>
</span><span id=__span-24-83><a id=__codelineno-24-83 name=__codelineno-24-83 href=#__codelineno-24-83></a><span class=w>        </span><span class=n>overrideHeight</span><span class=p>,</span>
</span><span id=__span-24-84><a id=__codelineno-24-84 name=__codelineno-24-84 href=#__codelineno-24-84></a><span class=w>        </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-24-85><a id=__codelineno-24-85 name=__codelineno-24-85 href=#__codelineno-24-85></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-24-86><a id=__codelineno-24-86 name=__codelineno-24-86 href=#__codelineno-24-86></a><span class=p>}</span>
</span><span id=__span-24-87><a id=__codelineno-24-87 name=__codelineno-24-87 href=#__codelineno-24-87></a>
</span><span id=__span-24-88><a id=__codelineno-24-88 name=__codelineno-24-88 href=#__codelineno-24-88></a><span class=kd>private</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=nf>obtainRequest</span><span class=p>(</span>
</span><span id=__span-24-89><a id=__codelineno-24-89 name=__codelineno-24-89 href=#__codelineno-24-89></a><span class=w>    </span><span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-90><a id=__codelineno-24-90 name=__codelineno-24-90 href=#__codelineno-24-90></a><span class=w>    </span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-24-91><a id=__codelineno-24-91 name=__codelineno-24-91 href=#__codelineno-24-91></a><span class=w>    </span><span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-92><a id=__codelineno-24-92 name=__codelineno-24-92 href=#__codelineno-24-92></a><span class=w>    </span><span class=n>RequestCoordinator</span><span class=w> </span><span class=n>requestCoordinator</span><span class=p>,</span>
</span><span id=__span-24-93><a id=__codelineno-24-93 name=__codelineno-24-93 href=#__codelineno-24-93></a><span class=w>    </span><span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>TranscodeType</span><span class=o>&gt;</span><span class=w> </span><span class=n>transitionOptions</span><span class=p>,</span>
</span><span id=__span-24-94><a id=__codelineno-24-94 name=__codelineno-24-94 href=#__codelineno-24-94></a><span class=w>    </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-24-95><a id=__codelineno-24-95 name=__codelineno-24-95 href=#__codelineno-24-95></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>overrideWidth</span><span class=p>,</span>
</span><span id=__span-24-96><a id=__codelineno-24-96 name=__codelineno-24-96 href=#__codelineno-24-96></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>,</span>
</span><span id=__span-24-97><a id=__codelineno-24-97 name=__codelineno-24-97 href=#__codelineno-24-97></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-24-98><a id=__codelineno-24-98 name=__codelineno-24-98 href=#__codelineno-24-98></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>SingleRequest</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span>
</span><span id=__span-24-99><a id=__codelineno-24-99 name=__codelineno-24-99 href=#__codelineno-24-99></a><span class=w>      </span><span class=n>context</span><span class=p>,</span>
</span><span id=__span-24-100><a id=__codelineno-24-100 name=__codelineno-24-100 href=#__codelineno-24-100></a><span class=w>      </span><span class=n>glideContext</span><span class=p>,</span>
</span><span id=__span-24-101><a id=__codelineno-24-101 name=__codelineno-24-101 href=#__codelineno-24-101></a><span class=w>      </span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-24-102><a id=__codelineno-24-102 name=__codelineno-24-102 href=#__codelineno-24-102></a><span class=w>      </span><span class=n>transcodeClass</span><span class=p>,</span>
</span><span id=__span-24-103><a id=__codelineno-24-103 name=__codelineno-24-103 href=#__codelineno-24-103></a><span class=w>      </span><span class=n>requestOptions</span><span class=p>,</span>
</span><span id=__span-24-104><a id=__codelineno-24-104 name=__codelineno-24-104 href=#__codelineno-24-104></a><span class=w>      </span><span class=n>overrideWidth</span><span class=p>,</span>
</span><span id=__span-24-105><a id=__codelineno-24-105 name=__codelineno-24-105 href=#__codelineno-24-105></a><span class=w>      </span><span class=n>overrideHeight</span><span class=p>,</span>
</span><span id=__span-24-106><a id=__codelineno-24-106 name=__codelineno-24-106 href=#__codelineno-24-106></a><span class=w>      </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-24-107><a id=__codelineno-24-107 name=__codelineno-24-107 href=#__codelineno-24-107></a><span class=w>      </span><span class=n>target</span><span class=p>,</span>
</span><span id=__span-24-108><a id=__codelineno-24-108 name=__codelineno-24-108 href=#__codelineno-24-108></a><span class=w>      </span><span class=n>targetListener</span><span class=p>,</span>
</span><span id=__span-24-109><a id=__codelineno-24-109 name=__codelineno-24-109 href=#__codelineno-24-109></a><span class=w>      </span><span class=n>requestListeners</span><span class=p>,</span>
</span><span id=__span-24-110><a id=__codelineno-24-110 name=__codelineno-24-110 href=#__codelineno-24-110></a><span class=w>      </span><span class=n>requestCoordinator</span><span class=p>,</span>
</span><span id=__span-24-111><a id=__codelineno-24-111 name=__codelineno-24-111 href=#__codelineno-24-111></a><span class=w>      </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getEngine</span><span class=p>(),</span>
</span><span id=__span-24-112><a id=__codelineno-24-112 name=__codelineno-24-112 href=#__codelineno-24-112></a><span class=w>      </span><span class=n>transitionOptions</span><span class=p>.</span><span class=na>getTransitionFactory</span><span class=p>(),</span>
</span><span id=__span-24-113><a id=__codelineno-24-113 name=__codelineno-24-113 href=#__codelineno-24-113></a><span class=w>      </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-24-114><a id=__codelineno-24-114 name=__codelineno-24-114 href=#__codelineno-24-114></a><span class=p>}</span>
</span></code></pre></div> <p><code>SingleRequest</code>的初始状态为<code>Status.PENDING</code>。</p> <h3 id=32-requestmanagertrack>3.2 RequestManager.track<a class=headerlink href=#32-requestmanagertrack title="Permanent link">&para;</a></h3> <p>😷😷😷下面开始分析<code>RequestManager.track</code>的流程</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>track</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Target</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=w>  </span><span class=n>targetTracker</span><span class=p>.</span><span class=na>track</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>  </span><span class=n>requestTracker</span><span class=p>.</span><span class=na>runRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-25-4><a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=p>}</span>
</span></code></pre></div> <p>在这里面，<code>targetTracker</code>成员变量在声明的时候直接初始化为<code>TargetTracker</code>类的无参数实例，该类的作用是保存所有的Target并向它们转发生命周期事件；<code>requestTracker</code>在<code>RequestManager</code>的构造器中传入了<code>new RequestTracker()</code>，该类的作用管理所有状态的请求。</p> <p><code>targetTracker.track(target)</code>将target保存到了内部的<code>targets</code>中：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Target</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>targets</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>    </span><span class=n>Collections</span><span class=p>.</span><span class=na>newSetFromMap</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>WeakHashMap</span><span class=o>&lt;</span><span class=n>Target</span><span class=o>&lt;?&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Boolean</span><span class=o>&gt;</span><span class=p>());</span>
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>track</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Target</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>target</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>  </span><span class=n>targets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=p>}</span>
</span></code></pre></div> <p>下面看看<code>requestTracker.runRequest(request)</code>干了什么：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=cm>/**</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=cm>  * Starts tracking the given request.</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=cm>  */</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>runRequest</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Request</span><span class=w> </span><span class=n>request</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>  </span><span class=n>requests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isPaused</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=w>    </span><span class=n>request</span><span class=p>.</span><span class=na>begin</span><span class=p>();</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>    </span><span class=n>request</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>      </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Paused, delaying request&quot;</span><span class=p>);</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=w>    </span><span class=n>pendingRequests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=p>}</span>
</span></code></pre></div> <p><code>isPaused</code>默认为false，只有调用了<code>RequestTracker.pauseRequests</code>或<code>RequestTracker.pauseAllRequests</code>后才会为true。<br> 因此，下面会执行<code>request.begin()</code>方法。上面说到过，这里的request实际上是<code>SingleRequest</code>对象，我们看一下它的<code>begin()</code>方法。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=nd>@Override</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>begin</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=w>  </span><span class=c1>// sanity check</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=w>  </span><span class=n>assertNotCallingCallbacks</span><span class=p>();</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=w>  </span><span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=w>  </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a><span class=w>  </span><span class=c1>// 如果model为空，会调用监听器的onLoadFailed处理</span>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=w>  </span><span class=c1>// 若无法处理，则展示失败时的占位图</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>model</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isValidDimensions</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=w>      </span><span class=n>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>overrideWidth</span><span class=p>;</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=w>      </span><span class=n>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>;</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-28-14><a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a><span class=w>    </span><span class=c1>// Only log at more verbose log levels if the user has set a fallback drawable, because</span>
</span><span id=__span-28-15><a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a><span class=w>    </span><span class=c1>// fallback Drawables indicate the user expects null models occasionally.</span>
</span><span id=__span-28-16><a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>logLevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getFallbackDrawable</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>WARN</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>;</span>
</span><span id=__span-28-17><a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a><span class=w>    </span><span class=n>onLoadFailed</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Received null model&quot;</span><span class=p>),</span><span class=w> </span><span class=n>logLevel</span><span class=p>);</span>
</span><span id=__span-28-18><a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-28-19><a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-28-20><a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a>
</span><span id=__span-28-21><a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-22><a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Cannot restart a running request&quot;</span><span class=p>);</span>
</span><span id=__span-28-23><a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-28-24><a id=__codelineno-28-24 name=__codelineno-28-24 href=#__codelineno-28-24></a>
</span><span id=__span-28-25><a id=__codelineno-28-25 name=__codelineno-28-25 href=#__codelineno-28-25></a><span class=w>  </span><span class=c1>// If we&#39;re restarted after we&#39;re complete (usually via something like a notifyDataSetChanged</span>
</span><span id=__span-28-26><a id=__codelineno-28-26 name=__codelineno-28-26 href=#__codelineno-28-26></a><span class=w>  </span><span class=c1>// that starts an identical request into the same Target or View), we can simply use the</span>
</span><span id=__span-28-27><a id=__codelineno-28-27 name=__codelineno-28-27 href=#__codelineno-28-27></a><span class=w>  </span><span class=c1>// resource and size we retrieved the last time around and skip obtaining a new size, starting a</span>
</span><span id=__span-28-28><a id=__codelineno-28-28 name=__codelineno-28-28 href=#__codelineno-28-28></a><span class=w>  </span><span class=c1>// new load etc. This does mean that users who want to restart a load because they expect that</span>
</span><span id=__span-28-29><a id=__codelineno-28-29 name=__codelineno-28-29 href=#__codelineno-28-29></a><span class=w>  </span><span class=c1>// the view size has changed will need to explicitly clear the View or Target before starting</span>
</span><span id=__span-28-30><a id=__codelineno-28-30 name=__codelineno-28-30 href=#__codelineno-28-30></a><span class=w>  </span><span class=c1>// the new load.</span>
</span><span id=__span-28-31><a id=__codelineno-28-31 name=__codelineno-28-31 href=#__codelineno-28-31></a><span class=w>  </span><span class=c1>//</span>
</span><span id=__span-28-32><a id=__codelineno-28-32 name=__codelineno-28-32 href=#__codelineno-28-32></a><span class=w>  </span><span class=c1>// 如果我们在请求完成后想重新开始加载，那么就会返回已经加载好的资源</span>
</span><span id=__span-28-33><a id=__codelineno-28-33 name=__codelineno-28-33 href=#__codelineno-28-33></a><span class=w>  </span><span class=c1>// 如果由于view尺寸的改变，我们的确需要重新来加载，此时我们需要明确地清除View或Target</span>
</span><span id=__span-28-34><a id=__codelineno-28-34 name=__codelineno-28-34 href=#__codelineno-28-34></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-35><a id=__codelineno-28-35 name=__codelineno-28-35 href=#__codelineno-28-35></a><span class=w>    </span><span class=n>onResourceReady</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
</span><span id=__span-28-36><a id=__codelineno-28-36 name=__codelineno-28-36 href=#__codelineno-28-36></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-28-37><a id=__codelineno-28-37 name=__codelineno-28-37 href=#__codelineno-28-37></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-28-38><a id=__codelineno-28-38 name=__codelineno-28-38 href=#__codelineno-28-38></a>
</span><span id=__span-28-39><a id=__codelineno-28-39 name=__codelineno-28-39 href=#__codelineno-28-39></a><span class=w>  </span><span class=c1>// Restarts for requests that are neither complete nor running can be treated as new requests</span>
</span><span id=__span-28-40><a id=__codelineno-28-40 name=__codelineno-28-40 href=#__codelineno-28-40></a><span class=w>  </span><span class=c1>// and can run again from the beginning.</span>
</span><span id=__span-28-41><a id=__codelineno-28-41 name=__codelineno-28-41 href=#__codelineno-28-41></a><span class=w>  </span><span class=c1>//</span>
</span><span id=__span-28-42><a id=__codelineno-28-42 name=__codelineno-28-42 href=#__codelineno-28-42></a><span class=w>  </span><span class=c1>// 请求岂没有完成也没有在运行，就当作新请求来对待。此时可以从beginning开始运行</span>
</span><span id=__span-28-43><a id=__codelineno-28-43 name=__codelineno-28-43 href=#__codelineno-28-43></a>
</span><span id=__span-28-44><a id=__codelineno-28-44 name=__codelineno-28-44 href=#__codelineno-28-44></a><span class=w>  </span><span class=c1>// 如果指定了overrideWidth和overrideHeight，那么直接调用onSizeReady方法</span>
</span><span id=__span-28-45><a id=__codelineno-28-45 name=__codelineno-28-45 href=#__codelineno-28-45></a><span class=w>  </span><span class=c1>// 否则会获取ImageView的宽、高，然后调用onSizeReady方法</span>
</span><span id=__span-28-46><a id=__codelineno-28-46 name=__codelineno-28-46 href=#__codelineno-28-46></a><span class=w>  </span><span class=c1>// 在该方法中会创建图片加载的Job并开始执行</span>
</span><span id=__span-28-47><a id=__codelineno-28-47 name=__codelineno-28-47 href=#__codelineno-28-47></a><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>;</span>
</span><span id=__span-28-48><a id=__codelineno-28-48 name=__codelineno-28-48 href=#__codelineno-28-48></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isValidDimensions</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-49><a id=__codelineno-28-49 name=__codelineno-28-49 href=#__codelineno-28-49></a><span class=w>    </span><span class=n>onSizeReady</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span><span class=w> </span><span class=n>overrideHeight</span><span class=p>);</span>
</span><span id=__span-28-50><a id=__codelineno-28-50 name=__codelineno-28-50 href=#__codelineno-28-50></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-51><a id=__codelineno-28-51 name=__codelineno-28-51 href=#__codelineno-28-51></a><span class=w>    </span><span class=n>target</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-28-52><a id=__codelineno-28-52 name=__codelineno-28-52 href=#__codelineno-28-52></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-28-53><a id=__codelineno-28-53 name=__codelineno-28-53 href=#__codelineno-28-53></a>
</span><span id=__span-28-54><a id=__codelineno-28-54 name=__codelineno-28-54 href=#__codelineno-28-54></a><span class=w>  </span><span class=c1>// 显示加载中的占位符</span>
</span><span id=__span-28-55><a id=__codelineno-28-55 name=__codelineno-28-55 href=#__codelineno-28-55></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span>
</span><span id=__span-28-56><a id=__codelineno-28-56 name=__codelineno-28-56 href=#__codelineno-28-56></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>canNotifyStatusChanged</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-57><a id=__codelineno-28-57 name=__codelineno-28-57 href=#__codelineno-28-57></a><span class=w>    </span><span class=n>target</span><span class=p>.</span><span class=na>onLoadStarted</span><span class=p>(</span><span class=n>getPlaceholderDrawable</span><span class=p>());</span>
</span><span id=__span-28-58><a id=__codelineno-28-58 name=__codelineno-28-58 href=#__codelineno-28-58></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-28-59><a id=__codelineno-28-59 name=__codelineno-28-59 href=#__codelineno-28-59></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-28-60><a id=__codelineno-28-60 name=__codelineno-28-60 href=#__codelineno-28-60></a><span class=w>    </span><span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished run method in &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span><span id=__span-28-61><a id=__codelineno-28-61 name=__codelineno-28-61 href=#__codelineno-28-61></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-28-62><a id=__codelineno-28-62 name=__codelineno-28-62 href=#__codelineno-28-62></a><span class=p>}</span>
</span></code></pre></div> <p><code>begin</code>方法可以分为几个大步骤，每个步骤的用途已经在代码中进行注释了。</p> <p>跟着代码，我们先看一下<code>model = null</code>时，<code>onLoadFailed(new GlideException("Received null model"), logLevel);</code>干了什么：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=kd>private</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLoadFailed</span><span class=p>(</span><span class=n>GlideException</span><span class=w> </span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>maxLogLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=w>  </span><span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=w>  </span><span class=n>e</span><span class=p>.</span><span class=na>setOrigin</span><span class=p>(</span><span class=n>requestOrigin</span><span class=p>);</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>logLevel</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getLogLevel</span><span class=p>();</span>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logLevel</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>maxLogLevel</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>    </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Load failed for &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>model</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; with size [&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;x&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;]&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>logLevel</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>INFO</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>      </span><span class=n>e</span><span class=p>.</span><span class=na>logRootCauses</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>);</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=w>  </span><span class=c1>// 设置状态为Status.FAILED</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a><span class=w>  </span><span class=n>loadStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>FAILED</span><span class=p>;</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=w>  </span><span class=n>isCallingCallbacks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=w>    </span><span class=c1>//TODO: what if this is a thumbnail request?</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a><span class=w>    </span><span class=c1>// 尝试调用各个listener的onLoadFailed回调进行处理</span>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>anyListenerHandledUpdatingTarget</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestListeners</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=w>      </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>listener</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>requestListeners</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a><span class=w>        </span><span class=n>anyListenerHandledUpdatingTarget</span><span class=w> </span><span class=o>|=</span>
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=w>            </span><span class=n>listener</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>isFirstReadyResource</span><span class=p>());</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a><span class=w>    </span><span class=n>anyListenerHandledUpdatingTarget</span><span class=w> </span><span class=o>|=</span>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a><span class=w>        </span><span class=n>targetListener</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>targetListener</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>isFirstReadyResource</span><span class=p>());</span>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a>
</span><span id=__span-29-31><a id=__codelineno-29-31 name=__codelineno-29-31 href=#__codelineno-29-31></a><span class=w>    </span><span class=c1>// 如果没有一个回调能够处理，那么显示失败占位符</span>
</span><span id=__span-29-32><a id=__codelineno-29-32 name=__codelineno-29-32 href=#__codelineno-29-32></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-33><a id=__codelineno-29-33 name=__codelineno-29-33 href=#__codelineno-29-33></a><span class=w>      </span><span class=n>setErrorPlaceholder</span><span class=p>();</span>
</span><span id=__span-29-34><a id=__codelineno-29-34 name=__codelineno-29-34 href=#__codelineno-29-34></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-29-35><a id=__codelineno-29-35 name=__codelineno-29-35 href=#__codelineno-29-35></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-36><a id=__codelineno-29-36 name=__codelineno-29-36 href=#__codelineno-29-36></a><span class=w>    </span><span class=n>isCallingCallbacks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-29-37><a id=__codelineno-29-37 name=__codelineno-29-37 href=#__codelineno-29-37></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-29-38><a id=__codelineno-29-38 name=__codelineno-29-38 href=#__codelineno-29-38></a>
</span><span id=__span-29-39><a id=__codelineno-29-39 name=__codelineno-29-39 href=#__codelineno-29-39></a><span class=w>  </span><span class=c1>// 通知requestCoordinator，此请求失败</span>
</span><span id=__span-29-40><a id=__codelineno-29-40 name=__codelineno-29-40 href=#__codelineno-29-40></a><span class=w>  </span><span class=n>notifyLoadFailed</span><span class=p>();</span>
</span><span id=__span-29-41><a id=__codelineno-29-41 name=__codelineno-29-41 href=#__codelineno-29-41></a><span class=p>}</span>
</span><span id=__span-29-42><a id=__codelineno-29-42 name=__codelineno-29-42 href=#__codelineno-29-42></a>
</span><span id=__span-29-43><a id=__codelineno-29-43 name=__codelineno-29-43 href=#__codelineno-29-43></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>notifyLoadFailed</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-44><a id=__codelineno-29-44 name=__codelineno-29-44 href=#__codelineno-29-44></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestCoordinator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-29-45><a id=__codelineno-29-45 name=__codelineno-29-45 href=#__codelineno-29-45></a><span class=w>    </span><span class=n>requestCoordinator</span><span class=p>.</span><span class=na>onRequestFailed</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-29-46><a id=__codelineno-29-46 name=__codelineno-29-46 href=#__codelineno-29-46></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-29-47><a id=__codelineno-29-47 name=__codelineno-29-47 href=#__codelineno-29-47></a><span class=p>}</span>
</span></code></pre></div> <p>看一下<code>setErrorPlaceholder</code>中显示失败占位符的逻辑：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=kd>private</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setErrorPlaceholder</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>canNotifyStatusChanged</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-30-4><a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-5><a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a>
</span><span id=__span-30-6><a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>  </span><span class=n>Drawable</span><span class=w> </span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-30-7><a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>model</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-8><a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>    </span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getFallbackDrawable</span><span class=p>();</span>
</span><span id=__span-30-9><a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-10><a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=w>  </span><span class=c1>// Either the model isn&#39;t null, or there was no fallback drawable set.</span>
</span><span id=__span-30-11><a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>error</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-12><a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>    </span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getErrorDrawable</span><span class=p>();</span>
</span><span id=__span-30-13><a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-14><a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>  </span><span class=c1>// The model isn&#39;t null, no fallback drawable was set or no error drawable was set.</span>
</span><span id=__span-30-15><a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>error</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-30-16><a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>    </span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getPlaceholderDrawable</span><span class=p>();</span>
</span><span id=__span-30-17><a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-30-18><a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a><span class=w>  </span><span class=n>target</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
</span><span id=__span-30-19><a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=p>}</span>
</span></code></pre></div> <p>这里的<code>target</code>是<code>DrawableImageViewTarget</code>类型，<code>onLoadFailed</code>方法的逻辑实现在其父类<code>ImageViewTarget</code>中：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=nd>@Override</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=n>errorDrawable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=w>  </span><span class=kd>super</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>errorDrawable</span><span class=p>);</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=w>  </span><span class=n>setResourceInternal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=w>  </span><span class=n>setDrawable</span><span class=p>(</span><span class=n>errorDrawable</span><span class=p>);</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a><span class=p>}</span>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a><span class=nd>@Override</span>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setDrawable</span><span class=p>(</span><span class=n>Drawable</span><span class=w> </span><span class=n>drawable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a><span class=w>  </span><span class=n>view</span><span class=p>.</span><span class=na>setImageDrawable</span><span class=p>(</span><span class=n>drawable</span><span class=p>);</span>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=p>}</span>
</span></code></pre></div> <p>显而易见，当model为null时，失败占位符的显示逻辑如下：</p> <ol> <li>如果设置了fallback，那么显示fallback</li> <li>否则，如果设置了error，那么显示error</li> <li>否则，如果设置了placeholder，那么显示placeholder</li> </ol> <blockquote> <p>这也证明了<a href=/android/3rd-library/glide1/#21>Glide v4 源码解析（一）--- 占位符</a>中，关于model为null部分的流程是正确的。</p> </blockquote> <p>回到<code>SingleRequest.begin()</code>方法中。<br> 判断完model是否为null后，下面会判断status是否为<code>Status.COMPLETE</code>。如果是，会调用<code>onResourceReady(resource, DataSource.MEMORY_CACHE)</code>并返回。该方法我们后面也会遇到，后面在说。</p> <p>接下来会获取要加载图片的size并调用<code>onSizeReady</code>方法，我们直接看该方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=nd>@Override</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSizeReady</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=w>  </span><span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
</span><span id=__span-32-4><a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-5><a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a><span class=w>    </span><span class=n>logV</span><span class=p>(</span><span class=s>&quot;Got onSizeReady in &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span><span id=__span-32-6><a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-7><a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>
</span><span id=__span-32-8><a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a><span class=w>  </span><span class=c1>// 在SingleRequest.begin方法中已经将status设置为WAITING_FOR_SIZE状态了</span>
</span><span id=__span-32-9><a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-10><a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-32-11><a id=__codelineno-32-11 name=__codelineno-32-11 href=#__codelineno-32-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-12><a id=__codelineno-32-12 name=__codelineno-32-12 href=#__codelineno-32-12></a><span class=w>  </span><span class=c1>// 设置状态为RUNNING</span>
</span><span id=__span-32-13><a id=__codelineno-32-13 name=__codelineno-32-13 href=#__codelineno-32-13></a><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>;</span>
</span><span id=__span-32-14><a id=__codelineno-32-14 name=__codelineno-32-14 href=#__codelineno-32-14></a>
</span><span id=__span-32-15><a id=__codelineno-32-15 name=__codelineno-32-15 href=#__codelineno-32-15></a><span class=w>  </span><span class=c1>// 将原始尺寸与0～1之间的系数相乘，取最接近的整数值，得到新的尺寸</span>
</span><span id=__span-32-16><a id=__codelineno-32-16 name=__codelineno-32-16 href=#__codelineno-32-16></a><span class=w>  </span><span class=kt>float</span><span class=w> </span><span class=n>sizeMultiplier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getSizeMultiplier</span><span class=p>();</span>
</span><span id=__span-32-17><a id=__codelineno-32-17 name=__codelineno-32-17 href=#__codelineno-32-17></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>sizeMultiplier</span><span class=p>);</span>
</span><span id=__span-32-18><a id=__codelineno-32-18 name=__codelineno-32-18 href=#__codelineno-32-18></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>sizeMultiplier</span><span class=p>);</span>
</span><span id=__span-32-19><a id=__codelineno-32-19 name=__codelineno-32-19 href=#__codelineno-32-19></a>
</span><span id=__span-32-20><a id=__codelineno-32-20 name=__codelineno-32-20 href=#__codelineno-32-20></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-21><a id=__codelineno-32-21 name=__codelineno-32-21 href=#__codelineno-32-21></a><span class=w>    </span><span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished setup for calling load in &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span><span id=__span-32-22><a id=__codelineno-32-22 name=__codelineno-32-22 href=#__codelineno-32-22></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-23><a id=__codelineno-32-23 name=__codelineno-32-23 href=#__codelineno-32-23></a><span class=w>  </span><span class=c1>// 🔥🔥🔥 根据load里面的这些参数开始加载</span>
</span><span id=__span-32-24><a id=__codelineno-32-24 name=__codelineno-32-24 href=#__codelineno-32-24></a><span class=w>  </span><span class=n>loadStatus</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-32-25><a id=__codelineno-32-25 name=__codelineno-32-25 href=#__codelineno-32-25></a><span class=w>      </span><span class=n>engine</span><span class=p>.</span><span class=na>load</span><span class=p>(</span>
</span><span id=__span-32-26><a id=__codelineno-32-26 name=__codelineno-32-26 href=#__codelineno-32-26></a><span class=w>          </span><span class=n>glideContext</span><span class=p>,</span>
</span><span id=__span-32-27><a id=__codelineno-32-27 name=__codelineno-32-27 href=#__codelineno-32-27></a><span class=w>          </span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-32-28><a id=__codelineno-32-28 name=__codelineno-32-28 href=#__codelineno-32-28></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
</span><span id=__span-32-29><a id=__codelineno-32-29 name=__codelineno-32-29 href=#__codelineno-32-29></a><span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=na>width</span><span class=p>,</span>
</span><span id=__span-32-30><a id=__codelineno-32-30 name=__codelineno-32-30 href=#__codelineno-32-30></a><span class=w>          </span><span class=k>this</span><span class=p>.</span><span class=na>height</span><span class=p>,</span>
</span><span id=__span-32-31><a id=__codelineno-32-31 name=__codelineno-32-31 href=#__codelineno-32-31></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getResourceClass</span><span class=p>(),</span>
</span><span id=__span-32-32><a id=__codelineno-32-32 name=__codelineno-32-32 href=#__codelineno-32-32></a><span class=w>          </span><span class=n>transcodeClass</span><span class=p>,</span>
</span><span id=__span-32-33><a id=__codelineno-32-33 name=__codelineno-32-33 href=#__codelineno-32-33></a><span class=w>          </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-32-34><a id=__codelineno-32-34 name=__codelineno-32-34 href=#__codelineno-32-34></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>(),</span>
</span><span id=__span-32-35><a id=__codelineno-32-35 name=__codelineno-32-35 href=#__codelineno-32-35></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getTransformations</span><span class=p>(),</span>
</span><span id=__span-32-36><a id=__codelineno-32-36 name=__codelineno-32-36 href=#__codelineno-32-36></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationRequired</span><span class=p>(),</span>
</span><span id=__span-32-37><a id=__codelineno-32-37 name=__codelineno-32-37 href=#__codelineno-32-37></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isScaleOnlyOrNoTransform</span><span class=p>(),</span>
</span><span id=__span-32-38><a id=__codelineno-32-38 name=__codelineno-32-38 href=#__codelineno-32-38></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getOptions</span><span class=p>(),</span>
</span><span id=__span-32-39><a id=__codelineno-32-39 name=__codelineno-32-39 href=#__codelineno-32-39></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isMemoryCacheable</span><span class=p>(),</span>
</span><span id=__span-32-40><a id=__codelineno-32-40 name=__codelineno-32-40 href=#__codelineno-32-40></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getUseUnlimitedSourceGeneratorsPool</span><span class=p>(),</span>
</span><span id=__span-32-41><a id=__codelineno-32-41 name=__codelineno-32-41 href=#__codelineno-32-41></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getUseAnimationPool</span><span class=p>(),</span>
</span><span id=__span-32-42><a id=__codelineno-32-42 name=__codelineno-32-42 href=#__codelineno-32-42></a><span class=w>          </span><span class=n>requestOptions</span><span class=p>.</span><span class=na>getOnlyRetrieveFromCache</span><span class=p>(),</span>
</span><span id=__span-32-43><a id=__codelineno-32-43 name=__codelineno-32-43 href=#__codelineno-32-43></a><span class=w>          </span><span class=k>this</span><span class=p>,</span>
</span><span id=__span-32-44><a id=__codelineno-32-44 name=__codelineno-32-44 href=#__codelineno-32-44></a><span class=w>          </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-32-45><a id=__codelineno-32-45 name=__codelineno-32-45 href=#__codelineno-32-45></a>
</span><span id=__span-32-46><a id=__codelineno-32-46 name=__codelineno-32-46 href=#__codelineno-32-46></a><span class=w>  </span><span class=c1>// This is a hack that&#39;s only useful for testing right now where loads complete synchronously</span>
</span><span id=__span-32-47><a id=__codelineno-32-47 name=__codelineno-32-47 href=#__codelineno-32-47></a><span class=w>  </span><span class=c1>// even though under any executor running on any thread but the main thread, the load would</span>
</span><span id=__span-32-48><a id=__codelineno-32-48 name=__codelineno-32-48 href=#__codelineno-32-48></a><span class=w>  </span><span class=c1>// have completed asynchronously.</span>
</span><span id=__span-32-49><a id=__codelineno-32-49 name=__codelineno-32-49 href=#__codelineno-32-49></a><span class=w>  </span><span class=c1>//</span>
</span><span id=__span-32-50><a id=__codelineno-32-50 name=__codelineno-32-50 href=#__codelineno-32-50></a><span class=w>  </span><span class=c1>// status目前显然是RUNNING状态，所以不会将loadStatus设置为null</span>
</span><span id=__span-32-51><a id=__codelineno-32-51 name=__codelineno-32-51 href=#__codelineno-32-51></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>status</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-52><a id=__codelineno-32-52 name=__codelineno-32-52 href=#__codelineno-32-52></a><span class=w>    </span><span class=n>loadStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-32-53><a id=__codelineno-32-53 name=__codelineno-32-53 href=#__codelineno-32-53></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-54><a id=__codelineno-32-54 name=__codelineno-32-54 href=#__codelineno-32-54></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-32-55><a id=__codelineno-32-55 name=__codelineno-32-55 href=#__codelineno-32-55></a><span class=w>    </span><span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished onSizeReady in &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span><span id=__span-32-56><a id=__codelineno-32-56 name=__codelineno-32-56 href=#__codelineno-32-56></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-32-57><a id=__codelineno-32-57 name=__codelineno-32-57 href=#__codelineno-32-57></a><span class=p>}</span>
</span></code></pre></div> <h3 id=33-engineload>3.3 Engine.load<a class=headerlink href=#33-engineload title="Permanent link">&para;</a></h3> <p>🔥🔥🔥目前看来，<code>engine.load</code>就是开始请求的关键代码了。<code>Engine</code>是负责开始加载，管理active、cached状态资源的类。在<code>GlideBuilder.build</code>中创建<code>Glide</code>时，若没有主动设置engine，会使用下面的参数进行创建：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceExecutor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=w>  </span><span class=n>sourceExecutor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newSourceExecutor</span><span class=p>();</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=p>}</span>
</span><span id=__span-33-4><a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a>
</span><span id=__span-33-5><a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCacheExecutor</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-6><a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a><span class=w>  </span><span class=n>diskCacheExecutor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newDiskCacheExecutor</span><span class=p>();</span>
</span><span id=__span-33-7><a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a><span class=p>}</span>
</span><span id=__span-33-8><a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a>
</span><span id=__span-33-9><a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>memoryCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-10><a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a><span class=w>  </span><span class=n>memoryCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span>
</span><span id=__span-33-11><a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a><span class=p>}</span>
</span><span id=__span-33-12><a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a>
</span><span id=__span-33-13><a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCacheFactory</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-14><a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a><span class=w>  </span><span class=n>diskCacheFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span><span id=__span-33-15><a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a><span class=p>}</span>
</span><span id=__span-33-16><a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a>
</span><span id=__span-33-17><a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>engine</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-33-18><a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a><span class=w>  </span><span class=n>engine</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-33-19><a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>Engine</span><span class=p>(</span>
</span><span id=__span-33-20><a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a><span class=w>          </span><span class=n>memoryCache</span><span class=p>,</span>
</span><span id=__span-33-21><a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a><span class=w>          </span><span class=n>diskCacheFactory</span><span class=p>,</span>
</span><span id=__span-33-22><a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a><span class=w>          </span><span class=n>diskCacheExecutor</span><span class=p>,</span>
</span><span id=__span-33-23><a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a><span class=w>          </span><span class=n>sourceExecutor</span><span class=p>,</span>
</span><span id=__span-33-24><a id=__codelineno-33-24 name=__codelineno-33-24 href=#__codelineno-33-24></a><span class=w>          </span><span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newUnlimitedSourceExecutor</span><span class=p>(),</span>
</span><span id=__span-33-25><a id=__codelineno-33-25 name=__codelineno-33-25 href=#__codelineno-33-25></a><span class=w>          </span><span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newAnimationExecutor</span><span class=p>(),</span>
</span><span id=__span-33-26><a id=__codelineno-33-26 name=__codelineno-33-26 href=#__codelineno-33-26></a><span class=w>          </span><span class=n>isActiveResourceRetentionAllowed</span><span class=w> </span><span class=cm>/* 默认为false */</span><span class=p>);</span>
</span><span id=__span-33-27><a id=__codelineno-33-27 name=__codelineno-33-27 href=#__codelineno-33-27></a><span class=p>}</span>
</span></code></pre></div> <p><code>Engine.load</code>方法中会以一些参数作为key，依次从active状态、cached状态和进行中的load里寻找。若没有找到，则会创建对应的job并开始执行。<br> 提供给一个或以上请求且没有被释放的资源被称为active资源。一旦所有的消费者都释放了该资源，该资源就会被放入cache中。如果有请求将资源从cache中取出，它会被重新添加到active资源中。如果一个资源从cache中移除，其本身会被discard，其内部拥有的资源将会回收或者在可能的情况下重用。并没有严格要求消费者一定要释放它们的资源，所以active资源会以弱引用的方式保持。 </p> <p>注意方法的注释，里面有上面两方面的说明：请求遵守的流程以及active状态资源的说明。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=cm>/**</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=cm>  * Starts a load for the given arguments.</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=cm>  *</span>
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=cm>  * &lt;p&gt;Must be called on the main thread.</span>
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=cm>  *</span>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a><span class=cm>  * &lt;p&gt;The flow for any request is as follows:</span>
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=cm>  *</span>
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=cm>  * &lt;ul&gt;</span>
</span><span id=__span-34-9><a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=cm>  *   &lt;li&gt;Check the current set of actively used resources, return the active resource if present,</span>
</span><span id=__span-34-10><a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=cm>  *       and move any newly inactive resources into the memory cache.</span>
</span><span id=__span-34-11><a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a><span class=cm>  *   &lt;li&gt;Check the memory cache and provide the cached resource if present.</span>
</span><span id=__span-34-12><a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=cm>  *   &lt;li&gt;Check the current set of in progress loads and add the cb to the in progress load if one</span>
</span><span id=__span-34-13><a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=cm>  *       is present.</span>
</span><span id=__span-34-14><a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=cm>  *   &lt;li&gt;Start a new load.</span>
</span><span id=__span-34-15><a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=cm>  * &lt;/ul&gt;</span>
</span><span id=__span-34-16><a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=cm>  *</span>
</span><span id=__span-34-17><a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=cm>  * &lt;p&gt;Active resources are those that have been provided to at least one request and have not yet</span>
</span><span id=__span-34-18><a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=cm>  * been released. Once all consumers of a resource have released that resource, the resource then</span>
</span><span id=__span-34-19><a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=cm>  * goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to</span>
</span><span id=__span-34-20><a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=cm>  * the active resources. If the resource is evicted from the cache, its resources are recycled and</span>
</span><span id=__span-34-21><a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=cm>  * re-used if possible and the resource is discarded. There is no strict requirement that</span>
</span><span id=__span-34-22><a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=cm>  * consumers release their resources so active resources are held weakly.</span>
</span><span id=__span-34-23><a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=cm>  *</span>
</span><span id=__span-34-24><a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=cm>  * @param width The target width in pixels of the desired resource.</span>
</span><span id=__span-34-25><a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=cm>  * @param height The target height in pixels of the desired resource.</span>
</span><span id=__span-34-26><a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=cm>  * @param cb The callback that will be called when the load completes.</span>
</span><span id=__span-34-27><a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=cm>  */</span>
</span><span id=__span-34-28><a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>LoadStatus</span><span class=w> </span><span class=nf>load</span><span class=p>(</span>
</span><span id=__span-34-29><a id=__codelineno-34-29 name=__codelineno-34-29 href=#__codelineno-34-29></a><span class=w>    </span><span class=n>GlideContext</span><span class=w> </span><span class=n>glideContext</span><span class=p>,</span>
</span><span id=__span-34-30><a id=__codelineno-34-30 name=__codelineno-34-30 href=#__codelineno-34-30></a><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-34-31><a id=__codelineno-34-31 name=__codelineno-34-31 href=#__codelineno-34-31></a><span class=w>    </span><span class=n>Key</span><span class=w> </span><span class=n>signature</span><span class=p>,</span>
</span><span id=__span-34-32><a id=__codelineno-34-32 name=__codelineno-34-32 href=#__codelineno-34-32></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span>
</span><span id=__span-34-33><a id=__codelineno-34-33 name=__codelineno-34-33 href=#__codelineno-34-33></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-34-34><a id=__codelineno-34-34 name=__codelineno-34-34 href=#__codelineno-34-34></a><span class=w>    </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-34-35><a id=__codelineno-34-35 name=__codelineno-34-35 href=#__codelineno-34-35></a><span class=w>    </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span>
</span><span id=__span-34-36><a id=__codelineno-34-36 name=__codelineno-34-36 href=#__codelineno-34-36></a><span class=w>    </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-34-37><a id=__codelineno-34-37 name=__codelineno-34-37 href=#__codelineno-34-37></a><span class=w>    </span><span class=n>DiskCacheStrategy</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>,</span>
</span><span id=__span-34-38><a id=__codelineno-34-38 name=__codelineno-34-38 href=#__codelineno-34-38></a><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>transformations</span><span class=p>,</span>
</span><span id=__span-34-39><a id=__codelineno-34-39 name=__codelineno-34-39 href=#__codelineno-34-39></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isTransformationRequired</span><span class=p>,</span>
</span><span id=__span-34-40><a id=__codelineno-34-40 name=__codelineno-34-40 href=#__codelineno-34-40></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
</span><span id=__span-34-41><a id=__codelineno-34-41 name=__codelineno-34-41 href=#__codelineno-34-41></a><span class=w>    </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>,</span>
</span><span id=__span-34-42><a id=__codelineno-34-42 name=__codelineno-34-42 href=#__codelineno-34-42></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>,</span>
</span><span id=__span-34-43><a id=__codelineno-34-43 name=__codelineno-34-43 href=#__codelineno-34-43></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
</span><span id=__span-34-44><a id=__codelineno-34-44 name=__codelineno-34-44 href=#__codelineno-34-44></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>useAnimationPool</span><span class=p>,</span>
</span><span id=__span-34-45><a id=__codelineno-34-45 name=__codelineno-34-45 href=#__codelineno-34-45></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
</span><span id=__span-34-46><a id=__codelineno-34-46 name=__codelineno-34-46 href=#__codelineno-34-46></a><span class=w>    </span><span class=n>ResourceCallback</span><span class=w> </span><span class=n>cb</span><span class=p>,</span>
</span><span id=__span-34-47><a id=__codelineno-34-47 name=__codelineno-34-47 href=#__codelineno-34-47></a><span class=w>    </span><span class=n>Executor</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-48><a id=__codelineno-34-48 name=__codelineno-34-48 href=#__codelineno-34-48></a><span class=w>  </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-34-49><a id=__codelineno-34-49 name=__codelineno-34-49 href=#__codelineno-34-49></a>
</span><span id=__span-34-50><a id=__codelineno-34-50 name=__codelineno-34-50 href=#__codelineno-34-50></a><span class=w>  </span><span class=c1>// EngineKey以传入的8个参数作为key</span>
</span><span id=__span-34-51><a id=__codelineno-34-51 name=__codelineno-34-51 href=#__codelineno-34-51></a><span class=w>  </span><span class=n>EngineKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keyFactory</span><span class=p>.</span><span class=na>buildKey</span><span class=p>(</span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>signature</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>transformations</span><span class=p>,</span>
</span><span id=__span-34-52><a id=__codelineno-34-52 name=__codelineno-34-52 href=#__codelineno-34-52></a><span class=w>      </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-34-53><a id=__codelineno-34-53 name=__codelineno-34-53 href=#__codelineno-34-53></a>
</span><span id=__span-34-54><a id=__codelineno-34-54 name=__codelineno-34-54 href=#__codelineno-34-54></a><span class=w>  </span><span class=c1>// 从active资源中进行加载，第一次显然取不到</span>
</span><span id=__span-34-55><a id=__codelineno-34-55 name=__codelineno-34-55 href=#__codelineno-34-55></a><span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>active</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>);</span>
</span><span id=__span-34-56><a id=__codelineno-34-56 name=__codelineno-34-56 href=#__codelineno-34-56></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>active</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-57><a id=__codelineno-34-57 name=__codelineno-34-57 href=#__codelineno-34-57></a><span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
</span><span id=__span-34-58><a id=__codelineno-34-58 name=__codelineno-34-58 href=#__codelineno-34-58></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-59><a id=__codelineno-34-59 name=__codelineno-34-59 href=#__codelineno-34-59></a><span class=w>      </span><span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Loaded resource from active resources&quot;</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-34-60><a id=__codelineno-34-60 name=__codelineno-34-60 href=#__codelineno-34-60></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-61><a id=__codelineno-34-61 name=__codelineno-34-61 href=#__codelineno-34-61></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-34-62><a id=__codelineno-34-62 name=__codelineno-34-62 href=#__codelineno-34-62></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-63><a id=__codelineno-34-63 name=__codelineno-34-63 href=#__codelineno-34-63></a>
</span><span id=__span-34-64><a id=__codelineno-34-64 name=__codelineno-34-64 href=#__codelineno-34-64></a><span class=w>  </span><span class=c1>// 从内存cache资源中进行加载，第一次显然取不到</span>
</span><span id=__span-34-65><a id=__codelineno-34-65 name=__codelineno-34-65 href=#__codelineno-34-65></a><span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>cached</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>);</span>
</span><span id=__span-34-66><a id=__codelineno-34-66 name=__codelineno-34-66 href=#__codelineno-34-66></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cached</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-67><a id=__codelineno-34-67 name=__codelineno-34-67 href=#__codelineno-34-67></a><span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
</span><span id=__span-34-68><a id=__codelineno-34-68 name=__codelineno-34-68 href=#__codelineno-34-68></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-69><a id=__codelineno-34-69 name=__codelineno-34-69 href=#__codelineno-34-69></a><span class=w>      </span><span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Loaded resource from cache&quot;</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-34-70><a id=__codelineno-34-70 name=__codelineno-34-70 href=#__codelineno-34-70></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-71><a id=__codelineno-34-71 name=__codelineno-34-71 href=#__codelineno-34-71></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-34-72><a id=__codelineno-34-72 name=__codelineno-34-72 href=#__codelineno-34-72></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-73><a id=__codelineno-34-73 name=__codelineno-34-73 href=#__codelineno-34-73></a>
</span><span id=__span-34-74><a id=__codelineno-34-74 name=__codelineno-34-74 href=#__codelineno-34-74></a><span class=w>  </span><span class=c1>// 从正在进行的jobs中进行加载，第一次显然取不到</span>
</span><span id=__span-34-75><a id=__codelineno-34-75 name=__codelineno-34-75 href=#__codelineno-34-75></a><span class=w>  </span><span class=n>EngineJob</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
</span><span id=__span-34-76><a id=__codelineno-34-76 name=__codelineno-34-76 href=#__codelineno-34-76></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-77><a id=__codelineno-34-77 name=__codelineno-34-77 href=#__codelineno-34-77></a><span class=w>    </span><span class=n>current</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-34-78><a id=__codelineno-34-78 name=__codelineno-34-78 href=#__codelineno-34-78></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-79><a id=__codelineno-34-79 name=__codelineno-34-79 href=#__codelineno-34-79></a><span class=w>      </span><span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Added to existing load&quot;</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-34-80><a id=__codelineno-34-80 name=__codelineno-34-80 href=#__codelineno-34-80></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-34-81><a id=__codelineno-34-81 name=__codelineno-34-81 href=#__codelineno-34-81></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>current</span><span class=p>);</span>
</span><span id=__span-34-82><a id=__codelineno-34-82 name=__codelineno-34-82 href=#__codelineno-34-82></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-83><a id=__codelineno-34-83 name=__codelineno-34-83 href=#__codelineno-34-83></a>
</span><span id=__span-34-84><a id=__codelineno-34-84 name=__codelineno-34-84 href=#__codelineno-34-84></a><span class=w>  </span><span class=c1>// 构建出一个EngineJob</span>
</span><span id=__span-34-85><a id=__codelineno-34-85 name=__codelineno-34-85 href=#__codelineno-34-85></a><span class=w>  </span><span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>engineJob</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-34-86><a id=__codelineno-34-86 name=__codelineno-34-86 href=#__codelineno-34-86></a><span class=w>      </span><span class=n>engineJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
</span><span id=__span-34-87><a id=__codelineno-34-87 name=__codelineno-34-87 href=#__codelineno-34-87></a><span class=w>          </span><span class=n>key</span><span class=p>,</span>
</span><span id=__span-34-88><a id=__codelineno-34-88 name=__codelineno-34-88 href=#__codelineno-34-88></a><span class=w>          </span><span class=n>isMemoryCacheable</span><span class=p>,</span>
</span><span id=__span-34-89><a id=__codelineno-34-89 name=__codelineno-34-89 href=#__codelineno-34-89></a><span class=w>          </span><span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
</span><span id=__span-34-90><a id=__codelineno-34-90 name=__codelineno-34-90 href=#__codelineno-34-90></a><span class=w>          </span><span class=n>useAnimationPool</span><span class=p>,</span>
</span><span id=__span-34-91><a id=__codelineno-34-91 name=__codelineno-34-91 href=#__codelineno-34-91></a><span class=w>          </span><span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
</span><span id=__span-34-92><a id=__codelineno-34-92 name=__codelineno-34-92 href=#__codelineno-34-92></a>
</span><span id=__span-34-93><a id=__codelineno-34-93 name=__codelineno-34-93 href=#__codelineno-34-93></a><span class=w>  </span><span class=c1>// 构建出一个DecodeJob，该类实现了Runnable接口</span>
</span><span id=__span-34-94><a id=__codelineno-34-94 name=__codelineno-34-94 href=#__codelineno-34-94></a><span class=w>  </span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>decodeJob</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-34-95><a id=__codelineno-34-95 name=__codelineno-34-95 href=#__codelineno-34-95></a><span class=w>      </span><span class=n>decodeJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
</span><span id=__span-34-96><a id=__codelineno-34-96 name=__codelineno-34-96 href=#__codelineno-34-96></a><span class=w>          </span><span class=n>glideContext</span><span class=p>,</span>
</span><span id=__span-34-97><a id=__codelineno-34-97 name=__codelineno-34-97 href=#__codelineno-34-97></a><span class=w>          </span><span class=n>model</span><span class=p>,</span>
</span><span id=__span-34-98><a id=__codelineno-34-98 name=__codelineno-34-98 href=#__codelineno-34-98></a><span class=w>          </span><span class=n>key</span><span class=p>,</span>
</span><span id=__span-34-99><a id=__codelineno-34-99 name=__codelineno-34-99 href=#__codelineno-34-99></a><span class=w>          </span><span class=n>signature</span><span class=p>,</span>
</span><span id=__span-34-100><a id=__codelineno-34-100 name=__codelineno-34-100 href=#__codelineno-34-100></a><span class=w>          </span><span class=n>width</span><span class=p>,</span>
</span><span id=__span-34-101><a id=__codelineno-34-101 name=__codelineno-34-101 href=#__codelineno-34-101></a><span class=w>          </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-34-102><a id=__codelineno-34-102 name=__codelineno-34-102 href=#__codelineno-34-102></a><span class=w>          </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-34-103><a id=__codelineno-34-103 name=__codelineno-34-103 href=#__codelineno-34-103></a><span class=w>          </span><span class=n>transcodeClass</span><span class=p>,</span>
</span><span id=__span-34-104><a id=__codelineno-34-104 name=__codelineno-34-104 href=#__codelineno-34-104></a><span class=w>          </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-34-105><a id=__codelineno-34-105 name=__codelineno-34-105 href=#__codelineno-34-105></a><span class=w>          </span><span class=n>diskCacheStrategy</span><span class=p>,</span>
</span><span id=__span-34-106><a id=__codelineno-34-106 name=__codelineno-34-106 href=#__codelineno-34-106></a><span class=w>          </span><span class=n>transformations</span><span class=p>,</span>
</span><span id=__span-34-107><a id=__codelineno-34-107 name=__codelineno-34-107 href=#__codelineno-34-107></a><span class=w>          </span><span class=n>isTransformationRequired</span><span class=p>,</span>
</span><span id=__span-34-108><a id=__codelineno-34-108 name=__codelineno-34-108 href=#__codelineno-34-108></a><span class=w>          </span><span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
</span><span id=__span-34-109><a id=__codelineno-34-109 name=__codelineno-34-109 href=#__codelineno-34-109></a><span class=w>          </span><span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
</span><span id=__span-34-110><a id=__codelineno-34-110 name=__codelineno-34-110 href=#__codelineno-34-110></a><span class=w>          </span><span class=n>options</span><span class=p>,</span>
</span><span id=__span-34-111><a id=__codelineno-34-111 name=__codelineno-34-111 href=#__codelineno-34-111></a><span class=w>          </span><span class=n>engineJob</span><span class=p>);</span>
</span><span id=__span-34-112><a id=__codelineno-34-112 name=__codelineno-34-112 href=#__codelineno-34-112></a>
</span><span id=__span-34-113><a id=__codelineno-34-113 name=__codelineno-34-113 href=#__codelineno-34-113></a><span class=w>  </span><span class=c1>// 根据engineJob.onlyRetrieveFromCache的值是否为true</span>
</span><span id=__span-34-114><a id=__codelineno-34-114 name=__codelineno-34-114 href=#__codelineno-34-114></a><span class=w>  </span><span class=c1>// 将engineJob保存到onlyCacheJobs或者jobs HashMap中</span>
</span><span id=__span-34-115><a id=__codelineno-34-115 name=__codelineno-34-115 href=#__codelineno-34-115></a><span class=w>  </span><span class=n>jobs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>engineJob</span><span class=p>);</span>
</span><span id=__span-34-116><a id=__codelineno-34-116 name=__codelineno-34-116 href=#__codelineno-34-116></a>
</span><span id=__span-34-117><a id=__codelineno-34-117 name=__codelineno-34-117 href=#__codelineno-34-117></a><span class=w>  </span><span class=c1>// 添加资源加载状态回调，参数会包装成ResourceCallbackAndExecutor类型</span>
</span><span id=__span-34-118><a id=__codelineno-34-118 name=__codelineno-34-118 href=#__codelineno-34-118></a><span class=w>  </span><span class=c1>// 并保存到ResourceCallbacksAndExecutors.callbacksAndExecutors中</span>
</span><span id=__span-34-119><a id=__codelineno-34-119 name=__codelineno-34-119 href=#__codelineno-34-119></a><span class=w>  </span><span class=n>engineJob</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>);</span>
</span><span id=__span-34-120><a id=__codelineno-34-120 name=__codelineno-34-120 href=#__codelineno-34-120></a><span class=w>  </span><span class=c1>// 🔥🔥🔥开始执行decodeJob任务</span>
</span><span id=__span-34-121><a id=__codelineno-34-121 name=__codelineno-34-121 href=#__codelineno-34-121></a><span class=w>  </span><span class=n>engineJob</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
</span><span id=__span-34-122><a id=__codelineno-34-122 name=__codelineno-34-122 href=#__codelineno-34-122></a>
</span><span id=__span-34-123><a id=__codelineno-34-123 name=__codelineno-34-123 href=#__codelineno-34-123></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-34-124><a id=__codelineno-34-124 name=__codelineno-34-124 href=#__codelineno-34-124></a><span class=w>    </span><span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Started new load&quot;</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=p>);</span>
</span><span id=__span-34-125><a id=__codelineno-34-125 name=__codelineno-34-125 href=#__codelineno-34-125></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-34-126><a id=__codelineno-34-126 name=__codelineno-34-126 href=#__codelineno-34-126></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>engineJob</span><span class=p>);</span>
</span><span id=__span-34-127><a id=__codelineno-34-127 name=__codelineno-34-127 href=#__codelineno-34-127></a><span class=p>}</span>
</span></code></pre></div> <p>在上面的这段代码中，从各个位置取资源是比较简单的，这里不多说了。<br> <code>engineJobFactory</code>与<code>decodeJobFactory</code>两个Factory存在的意义在于里面使用了对象池Pools.Pool。以<code>DecodeJobFactory</code>为例：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=nd>@VisibleForTesting</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>DecodeJobFactory</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>  </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Pools</span><span class=p>.</span><span class=na>Pool</span><span class=o>&lt;</span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>pool</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a><span class=w>      </span><span class=n>FactoryPools</span><span class=p>.</span><span class=na>threadSafe</span><span class=p>(</span><span class=n>JOB_POOL_SIZE</span><span class=p>,</span>
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a><span class=w>          </span><span class=k>new</span><span class=w> </span><span class=n>FactoryPools</span><span class=p>.</span><span class=na>Factory</span><span class=o>&lt;</span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>create</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a><span class=w>          </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DecodeJob</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span><span class=w> </span><span class=n>pool</span><span class=p>);</span>
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a><span class=w>      </span><span class=p>});</span>
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a><span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a><span class=w>  </span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=nf>build</span><span class=p>(...)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a><span class=w>    </span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>((</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>init</span><span class=p>(...);</span>
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-18><a id=__codelineno-35-18 name=__codelineno-35-18 href=#__codelineno-35-18></a><span class=p>}</span>
</span><span id=__span-35-19><a id=__codelineno-35-19 name=__codelineno-35-19 href=#__codelineno-35-19></a>
</span><span id=__span-35-20><a id=__codelineno-35-20 name=__codelineno-35-20 href=#__codelineno-35-20></a><span class=c1>// FactoryPools.java</span>
</span><span id=__span-35-21><a id=__codelineno-35-21 name=__codelineno-35-21 href=#__codelineno-35-21></a><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>FactoryPools</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-22><a id=__codelineno-35-22 name=__codelineno-35-22 href=#__codelineno-35-22></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-35-23><a id=__codelineno-35-23 name=__codelineno-35-23 href=#__codelineno-35-23></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Poolable</span><span class=o>&gt;</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>threadSafe</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-24><a id=__codelineno-35-24 name=__codelineno-35-24 href=#__codelineno-35-24></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>build</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>SynchronizedPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>size</span><span class=p>),</span><span class=w> </span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-35-25><a id=__codelineno-35-25 name=__codelineno-35-25 href=#__codelineno-35-25></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-26><a id=__codelineno-35-26 name=__codelineno-35-26 href=#__codelineno-35-26></a>
</span><span id=__span-35-27><a id=__codelineno-35-27 name=__codelineno-35-27 href=#__codelineno-35-27></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-35-28><a id=__codelineno-35-28 name=__codelineno-35-28 href=#__codelineno-35-28></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Poolable</span><span class=o>&gt;</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>pool</span><span class=p>,</span>
</span><span id=__span-35-29><a id=__codelineno-35-29 name=__codelineno-35-29 href=#__codelineno-35-29></a><span class=w>      </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-30><a id=__codelineno-35-30 name=__codelineno-35-30 href=#__codelineno-35-30></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>build</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>,</span><span class=w> </span><span class=n>FactoryPools</span><span class=p>.</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=n>emptyResetter</span><span class=p>());</span>
</span><span id=__span-35-31><a id=__codelineno-35-31 name=__codelineno-35-31 href=#__codelineno-35-31></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-32><a id=__codelineno-35-32 name=__codelineno-35-32 href=#__codelineno-35-32></a>
</span><span id=__span-35-33><a id=__codelineno-35-33 name=__codelineno-35-33 href=#__codelineno-35-33></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-35-34><a id=__codelineno-35-34 name=__codelineno-35-34 href=#__codelineno-35-34></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>pool</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>,</span>
</span><span id=__span-35-35><a id=__codelineno-35-35 name=__codelineno-35-35 href=#__codelineno-35-35></a><span class=w>      </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>resetter</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-36><a id=__codelineno-35-36 name=__codelineno-35-36 href=#__codelineno-35-36></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FactoryPool</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>,</span><span class=w> </span><span class=n>resetter</span><span class=p>);</span>
</span><span id=__span-35-37><a id=__codelineno-35-37 name=__codelineno-35-37 href=#__codelineno-35-37></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-38><a id=__codelineno-35-38 name=__codelineno-35-38 href=#__codelineno-35-38></a>
</span><span id=__span-35-39><a id=__codelineno-35-39 name=__codelineno-35-39 href=#__codelineno-35-39></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>FactoryPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-40><a id=__codelineno-35-40 name=__codelineno-35-40 href=#__codelineno-35-40></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>;</span>
</span><span id=__span-35-41><a id=__codelineno-35-41 name=__codelineno-35-41 href=#__codelineno-35-41></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>resetter</span><span class=p>;</span>
</span><span id=__span-35-42><a id=__codelineno-35-42 name=__codelineno-35-42 href=#__codelineno-35-42></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>pool</span><span class=p>;</span>
</span><span id=__span-35-43><a id=__codelineno-35-43 name=__codelineno-35-43 href=#__codelineno-35-43></a>
</span><span id=__span-35-44><a id=__codelineno-35-44 name=__codelineno-35-44 href=#__codelineno-35-44></a><span class=w>    </span><span class=n>FactoryPool</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>pool</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>resetter</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-45><a id=__codelineno-35-45 name=__codelineno-35-45 href=#__codelineno-35-45></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>pool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>;</span>
</span><span id=__span-35-46><a id=__codelineno-35-46 name=__codelineno-35-46 href=#__codelineno-35-46></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>;</span>
</span><span id=__span-35-47><a id=__codelineno-35-47 name=__codelineno-35-47 href=#__codelineno-35-47></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>resetter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resetter</span><span class=p>;</span>
</span><span id=__span-35-48><a id=__codelineno-35-48 name=__codelineno-35-48 href=#__codelineno-35-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-49><a id=__codelineno-35-49 name=__codelineno-35-49 href=#__codelineno-35-49></a>
</span><span id=__span-35-50><a id=__codelineno-35-50 name=__codelineno-35-50 href=#__codelineno-35-50></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-35-51><a id=__codelineno-35-51 name=__codelineno-35-51 href=#__codelineno-35-51></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>acquire</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-52><a id=__codelineno-35-52 name=__codelineno-35-52 href=#__codelineno-35-52></a><span class=w>      </span><span class=n>T</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
</span><span id=__span-35-53><a id=__codelineno-35-53 name=__codelineno-35-53 href=#__codelineno-35-53></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-54><a id=__codelineno-35-54 name=__codelineno-35-54 href=#__codelineno-35-54></a><span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>create</span><span class=p>();</span>
</span><span id=__span-35-55><a id=__codelineno-35-55 name=__codelineno-35-55 href=#__codelineno-35-55></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-56><a id=__codelineno-35-56 name=__codelineno-35-56 href=#__codelineno-35-56></a><span class=w>          </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Created new &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
</span><span id=__span-35-57><a id=__codelineno-35-57 name=__codelineno-35-57 href=#__codelineno-35-57></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-58><a id=__codelineno-35-58 name=__codelineno-35-58 href=#__codelineno-35-58></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-35-59><a id=__codelineno-35-59 name=__codelineno-35-59 href=#__codelineno-35-59></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Poolable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-60><a id=__codelineno-35-60 name=__codelineno-35-60 href=#__codelineno-35-60></a><span class=w>        </span><span class=p>((</span><span class=n>Poolable</span><span class=p>)</span><span class=w> </span><span class=n>result</span><span class=p>).</span><span class=na>getVerifier</span><span class=p>().</span><span class=na>setRecycled</span><span class=p>(</span><span class=kc>false</span><span class=w> </span><span class=cm>/*isRecycled*/</span><span class=p>);</span>
</span><span id=__span-35-61><a id=__codelineno-35-61 name=__codelineno-35-61 href=#__codelineno-35-61></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-35-62><a id=__codelineno-35-62 name=__codelineno-35-62 href=#__codelineno-35-62></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-35-63><a id=__codelineno-35-63 name=__codelineno-35-63 href=#__codelineno-35-63></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-64><a id=__codelineno-35-64 name=__codelineno-35-64 href=#__codelineno-35-64></a>
</span><span id=__span-35-65><a id=__codelineno-35-65 name=__codelineno-35-65 href=#__codelineno-35-65></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-35-66><a id=__codelineno-35-66 name=__codelineno-35-66 href=#__codelineno-35-66></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>instance</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-67><a id=__codelineno-35-67 name=__codelineno-35-67 href=#__codelineno-35-67></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>instance</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Poolable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-68><a id=__codelineno-35-68 name=__codelineno-35-68 href=#__codelineno-35-68></a><span class=w>        </span><span class=p>((</span><span class=n>Poolable</span><span class=p>)</span><span class=w> </span><span class=n>instance</span><span class=p>).</span><span class=na>getVerifier</span><span class=p>().</span><span class=na>setRecycled</span><span class=p>(</span><span class=kc>true</span><span class=w> </span><span class=cm>/*isRecycled*/</span><span class=p>);</span>
</span><span id=__span-35-69><a id=__codelineno-35-69 name=__codelineno-35-69 href=#__codelineno-35-69></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-35-70><a id=__codelineno-35-70 name=__codelineno-35-70 href=#__codelineno-35-70></a><span class=w>      </span><span class=n>resetter</span><span class=p>.</span><span class=na>reset</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
</span><span id=__span-35-71><a id=__codelineno-35-71 name=__codelineno-35-71 href=#__codelineno-35-71></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>pool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
</span><span id=__span-35-72><a id=__codelineno-35-72 name=__codelineno-35-72 href=#__codelineno-35-72></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-73><a id=__codelineno-35-73 name=__codelineno-35-73 href=#__codelineno-35-73></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-35-74><a id=__codelineno-35-74 name=__codelineno-35-74 href=#__codelineno-35-74></a><span class=p>}</span>
</span><span id=__span-35-75><a id=__codelineno-35-75 name=__codelineno-35-75 href=#__codelineno-35-75></a>
</span><span id=__span-35-76><a id=__codelineno-35-76 name=__codelineno-35-76 href=#__codelineno-35-76></a><span class=c1>// Pools</span>
</span><span id=__span-35-77><a id=__codelineno-35-77 name=__codelineno-35-77 href=#__codelineno-35-77></a><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Pools</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-78><a id=__codelineno-35-78 name=__codelineno-35-78 href=#__codelineno-35-78></a>
</span><span id=__span-35-79><a id=__codelineno-35-79 name=__codelineno-35-79 href=#__codelineno-35-79></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-35-80><a id=__codelineno-35-80 name=__codelineno-35-80 href=#__codelineno-35-80></a><span class=cm>     * Interface for managing a pool of objects.</span>
</span><span id=__span-35-81><a id=__codelineno-35-81 name=__codelineno-35-81 href=#__codelineno-35-81></a><span class=cm>     *</span>
</span><span id=__span-35-82><a id=__codelineno-35-82 name=__codelineno-35-82 href=#__codelineno-35-82></a><span class=cm>     * @param &lt;T&gt; The pooled type.</span>
</span><span id=__span-35-83><a id=__codelineno-35-83 name=__codelineno-35-83 href=#__codelineno-35-83></a><span class=cm>     */</span>
</span><span id=__span-35-84><a id=__codelineno-35-84 name=__codelineno-35-84 href=#__codelineno-35-84></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-85><a id=__codelineno-35-85 name=__codelineno-35-85 href=#__codelineno-35-85></a>
</span><span id=__span-35-86><a id=__codelineno-35-86 name=__codelineno-35-86 href=#__codelineno-35-86></a><span class=w>        </span><span class=cm>/**</span>
</span><span id=__span-35-87><a id=__codelineno-35-87 name=__codelineno-35-87 href=#__codelineno-35-87></a><span class=cm>         * @return An instance from the pool if such, null otherwise.</span>
</span><span id=__span-35-88><a id=__codelineno-35-88 name=__codelineno-35-88 href=#__codelineno-35-88></a><span class=cm>         */</span>
</span><span id=__span-35-89><a id=__codelineno-35-89 name=__codelineno-35-89 href=#__codelineno-35-89></a><span class=w>        </span><span class=nd>@Nullable</span>
</span><span id=__span-35-90><a id=__codelineno-35-90 name=__codelineno-35-90 href=#__codelineno-35-90></a><span class=w>        </span><span class=n>T</span><span class=w> </span><span class=nf>acquire</span><span class=p>();</span>
</span><span id=__span-35-91><a id=__codelineno-35-91 name=__codelineno-35-91 href=#__codelineno-35-91></a>
</span><span id=__span-35-92><a id=__codelineno-35-92 name=__codelineno-35-92 href=#__codelineno-35-92></a><span class=w>        </span><span class=cm>/**</span>
</span><span id=__span-35-93><a id=__codelineno-35-93 name=__codelineno-35-93 href=#__codelineno-35-93></a><span class=cm>         * Release an instance to the pool.</span>
</span><span id=__span-35-94><a id=__codelineno-35-94 name=__codelineno-35-94 href=#__codelineno-35-94></a><span class=cm>         *</span>
</span><span id=__span-35-95><a id=__codelineno-35-95 name=__codelineno-35-95 href=#__codelineno-35-95></a><span class=cm>         * @param instance The instance to release.</span>
</span><span id=__span-35-96><a id=__codelineno-35-96 name=__codelineno-35-96 href=#__codelineno-35-96></a><span class=cm>         * @return Whether the instance was put in the pool.</span>
</span><span id=__span-35-97><a id=__codelineno-35-97 name=__codelineno-35-97 href=#__codelineno-35-97></a><span class=cm>         *</span>
</span><span id=__span-35-98><a id=__codelineno-35-98 name=__codelineno-35-98 href=#__codelineno-35-98></a><span class=cm>         * @throws IllegalStateException If the instance is already in the pool.</span>
</span><span id=__span-35-99><a id=__codelineno-35-99 name=__codelineno-35-99 href=#__codelineno-35-99></a><span class=cm>         */</span>
</span><span id=__span-35-100><a id=__codelineno-35-100 name=__codelineno-35-100 href=#__codelineno-35-100></a><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>instance</span><span class=p>);</span>
</span><span id=__span-35-101><a id=__codelineno-35-101 name=__codelineno-35-101 href=#__codelineno-35-101></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-102><a id=__codelineno-35-102 name=__codelineno-35-102 href=#__codelineno-35-102></a>
</span><span id=__span-35-103><a id=__codelineno-35-103 name=__codelineno-35-103 href=#__codelineno-35-103></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=nf>Pools</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-104><a id=__codelineno-35-104 name=__codelineno-35-104 href=#__codelineno-35-104></a><span class=w>        </span><span class=cm>/* do nothing - hiding constructor */</span>
</span><span id=__span-35-105><a id=__codelineno-35-105 name=__codelineno-35-105 href=#__codelineno-35-105></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-106><a id=__codelineno-35-106 name=__codelineno-35-106 href=#__codelineno-35-106></a>
</span><span id=__span-35-107><a id=__codelineno-35-107 name=__codelineno-35-107 href=#__codelineno-35-107></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-35-108><a id=__codelineno-35-108 name=__codelineno-35-108 href=#__codelineno-35-108></a><span class=cm>     * Simple (non-synchronized) pool of objects.</span>
</span><span id=__span-35-109><a id=__codelineno-35-109 name=__codelineno-35-109 href=#__codelineno-35-109></a><span class=cm>     *</span>
</span><span id=__span-35-110><a id=__codelineno-35-110 name=__codelineno-35-110 href=#__codelineno-35-110></a><span class=cm>     * @param &lt;T&gt; The pooled type.</span>
</span><span id=__span-35-111><a id=__codelineno-35-111 name=__codelineno-35-111 href=#__codelineno-35-111></a><span class=cm>     */</span>
</span><span id=__span-35-112><a id=__codelineno-35-112 name=__codelineno-35-112 href=#__codelineno-35-112></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>SimplePool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-113><a id=__codelineno-35-113 name=__codelineno-35-113 href=#__codelineno-35-113></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=o>[]</span><span class=w> </span><span class=n>mPool</span><span class=p>;</span>
</span><span id=__span-35-114><a id=__codelineno-35-114 name=__codelineno-35-114 href=#__codelineno-35-114></a>
</span><span id=__span-35-115><a id=__codelineno-35-115 name=__codelineno-35-115 href=#__codelineno-35-115></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>mPoolSize</span><span class=p>;</span>
</span><span id=__span-35-116><a id=__codelineno-35-116 name=__codelineno-35-116 href=#__codelineno-35-116></a>
</span><span id=__span-35-117><a id=__codelineno-35-117 name=__codelineno-35-117 href=#__codelineno-35-117></a><span class=w>        </span><span class=cm>/**</span>
</span><span id=__span-35-118><a id=__codelineno-35-118 name=__codelineno-35-118 href=#__codelineno-35-118></a><span class=cm>         * Creates a new instance.</span>
</span><span id=__span-35-119><a id=__codelineno-35-119 name=__codelineno-35-119 href=#__codelineno-35-119></a><span class=cm>         *</span>
</span><span id=__span-35-120><a id=__codelineno-35-120 name=__codelineno-35-120 href=#__codelineno-35-120></a><span class=cm>         * @param maxPoolSize The max pool size.</span>
</span><span id=__span-35-121><a id=__codelineno-35-121 name=__codelineno-35-121 href=#__codelineno-35-121></a><span class=cm>         *</span>
</span><span id=__span-35-122><a id=__codelineno-35-122 name=__codelineno-35-122 href=#__codelineno-35-122></a><span class=cm>         * @throws IllegalArgumentException If the max pool size is less than zero.</span>
</span><span id=__span-35-123><a id=__codelineno-35-123 name=__codelineno-35-123 href=#__codelineno-35-123></a><span class=cm>         */</span>
</span><span id=__span-35-124><a id=__codelineno-35-124 name=__codelineno-35-124 href=#__codelineno-35-124></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>SimplePool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>maxPoolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-125><a id=__codelineno-35-125 name=__codelineno-35-125 href=#__codelineno-35-125></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>maxPoolSize</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-126><a id=__codelineno-35-126 name=__codelineno-35-126 href=#__codelineno-35-126></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;The max pool size must be &gt; 0&quot;</span><span class=p>);</span>
</span><span id=__span-35-127><a id=__codelineno-35-127 name=__codelineno-35-127 href=#__codelineno-35-127></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-128><a id=__codelineno-35-128 name=__codelineno-35-128 href=#__codelineno-35-128></a><span class=w>            </span><span class=n>mPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>maxPoolSize</span><span class=o>]</span><span class=p>;</span>
</span><span id=__span-35-129><a id=__codelineno-35-129 name=__codelineno-35-129 href=#__codelineno-35-129></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-130><a id=__codelineno-35-130 name=__codelineno-35-130 href=#__codelineno-35-130></a>
</span><span id=__span-35-131><a id=__codelineno-35-131 name=__codelineno-35-131 href=#__codelineno-35-131></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-35-132><a id=__codelineno-35-132 name=__codelineno-35-132 href=#__codelineno-35-132></a><span class=w>        </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-35-133><a id=__codelineno-35-133 name=__codelineno-35-133 href=#__codelineno-35-133></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>acquire</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-134><a id=__codelineno-35-134 name=__codelineno-35-134 href=#__codelineno-35-134></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPoolSize</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-135><a id=__codelineno-35-135 name=__codelineno-35-135 href=#__codelineno-35-135></a><span class=w>                </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>lastPooledIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPoolSize</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-35-136><a id=__codelineno-35-136 name=__codelineno-35-136 href=#__codelineno-35-136></a><span class=w>                </span><span class=n>T</span><span class=w> </span><span class=n>instance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>T</span><span class=p>)</span><span class=w> </span><span class=n>mPool</span><span class=o>[</span><span class=n>lastPooledIndex</span><span class=o>]</span><span class=p>;</span>
</span><span id=__span-35-137><a id=__codelineno-35-137 name=__codelineno-35-137 href=#__codelineno-35-137></a><span class=w>                </span><span class=n>mPool</span><span class=o>[</span><span class=n>lastPooledIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-35-138><a id=__codelineno-35-138 name=__codelineno-35-138 href=#__codelineno-35-138></a><span class=w>                </span><span class=n>mPoolSize</span><span class=o>--</span><span class=p>;</span>
</span><span id=__span-35-139><a id=__codelineno-35-139 name=__codelineno-35-139 href=#__codelineno-35-139></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>instance</span><span class=p>;</span>
</span><span id=__span-35-140><a id=__codelineno-35-140 name=__codelineno-35-140 href=#__codelineno-35-140></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-141><a id=__codelineno-35-141 name=__codelineno-35-141 href=#__codelineno-35-141></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-35-142><a id=__codelineno-35-142 name=__codelineno-35-142 href=#__codelineno-35-142></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-143><a id=__codelineno-35-143 name=__codelineno-35-143 href=#__codelineno-35-143></a>
</span><span id=__span-35-144><a id=__codelineno-35-144 name=__codelineno-35-144 href=#__codelineno-35-144></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-35-145><a id=__codelineno-35-145 name=__codelineno-35-145 href=#__codelineno-35-145></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>instance</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-146><a id=__codelineno-35-146 name=__codelineno-35-146 href=#__codelineno-35-146></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isInPool</span><span class=p>(</span><span class=n>instance</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-147><a id=__codelineno-35-147 name=__codelineno-35-147 href=#__codelineno-35-147></a><span class=w>                </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already in the pool!&quot;</span><span class=p>);</span>
</span><span id=__span-35-148><a id=__codelineno-35-148 name=__codelineno-35-148 href=#__codelineno-35-148></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-149><a id=__codelineno-35-149 name=__codelineno-35-149 href=#__codelineno-35-149></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPoolSize</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>mPool</span><span class=p>.</span><span class=na>length</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-150><a id=__codelineno-35-150 name=__codelineno-35-150 href=#__codelineno-35-150></a><span class=w>                </span><span class=n>mPool</span><span class=o>[</span><span class=n>mPoolSize</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>instance</span><span class=p>;</span>
</span><span id=__span-35-151><a id=__codelineno-35-151 name=__codelineno-35-151 href=#__codelineno-35-151></a><span class=w>                </span><span class=n>mPoolSize</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-35-152><a id=__codelineno-35-152 name=__codelineno-35-152 href=#__codelineno-35-152></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-35-153><a id=__codelineno-35-153 name=__codelineno-35-153 href=#__codelineno-35-153></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-154><a id=__codelineno-35-154 name=__codelineno-35-154 href=#__codelineno-35-154></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-35-155><a id=__codelineno-35-155 name=__codelineno-35-155 href=#__codelineno-35-155></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-156><a id=__codelineno-35-156 name=__codelineno-35-156 href=#__codelineno-35-156></a>
</span><span id=__span-35-157><a id=__codelineno-35-157 name=__codelineno-35-157 href=#__codelineno-35-157></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isInPool</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>instance</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-158><a id=__codelineno-35-158 name=__codelineno-35-158 href=#__codelineno-35-158></a><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>mPoolSize</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-159><a id=__codelineno-35-159 name=__codelineno-35-159 href=#__codelineno-35-159></a><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mPool</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>instance</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-160><a id=__codelineno-35-160 name=__codelineno-35-160 href=#__codelineno-35-160></a><span class=w>                    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-35-161><a id=__codelineno-35-161 name=__codelineno-35-161 href=#__codelineno-35-161></a><span class=w>                </span><span class=p>}</span>
</span><span id=__span-35-162><a id=__codelineno-35-162 name=__codelineno-35-162 href=#__codelineno-35-162></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-163><a id=__codelineno-35-163 name=__codelineno-35-163 href=#__codelineno-35-163></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-35-164><a id=__codelineno-35-164 name=__codelineno-35-164 href=#__codelineno-35-164></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-165><a id=__codelineno-35-165 name=__codelineno-35-165 href=#__codelineno-35-165></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-166><a id=__codelineno-35-166 name=__codelineno-35-166 href=#__codelineno-35-166></a>
</span><span id=__span-35-167><a id=__codelineno-35-167 name=__codelineno-35-167 href=#__codelineno-35-167></a><span class=w>    </span><span class=cm>/**</span>
</span><span id=__span-35-168><a id=__codelineno-35-168 name=__codelineno-35-168 href=#__codelineno-35-168></a><span class=cm>     * Synchronized) pool of objects.</span>
</span><span id=__span-35-169><a id=__codelineno-35-169 name=__codelineno-35-169 href=#__codelineno-35-169></a><span class=cm>     *</span>
</span><span id=__span-35-170><a id=__codelineno-35-170 name=__codelineno-35-170 href=#__codelineno-35-170></a><span class=cm>     * @param &lt;T&gt; The pooled type.</span>
</span><span id=__span-35-171><a id=__codelineno-35-171 name=__codelineno-35-171 href=#__codelineno-35-171></a><span class=cm>     */</span>
</span><span id=__span-35-172><a id=__codelineno-35-172 name=__codelineno-35-172 href=#__codelineno-35-172></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>SynchronizedPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>SimplePool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-173><a id=__codelineno-35-173 name=__codelineno-35-173 href=#__codelineno-35-173></a><span class=w>        </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>mLock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=p>();</span>
</span><span id=__span-35-174><a id=__codelineno-35-174 name=__codelineno-35-174 href=#__codelineno-35-174></a>
</span><span id=__span-35-175><a id=__codelineno-35-175 name=__codelineno-35-175 href=#__codelineno-35-175></a><span class=w>        </span><span class=cm>/**</span>
</span><span id=__span-35-176><a id=__codelineno-35-176 name=__codelineno-35-176 href=#__codelineno-35-176></a><span class=cm>         * Creates a new instance.</span>
</span><span id=__span-35-177><a id=__codelineno-35-177 name=__codelineno-35-177 href=#__codelineno-35-177></a><span class=cm>         *</span>
</span><span id=__span-35-178><a id=__codelineno-35-178 name=__codelineno-35-178 href=#__codelineno-35-178></a><span class=cm>         * @param maxPoolSize The max pool size.</span>
</span><span id=__span-35-179><a id=__codelineno-35-179 name=__codelineno-35-179 href=#__codelineno-35-179></a><span class=cm>         *</span>
</span><span id=__span-35-180><a id=__codelineno-35-180 name=__codelineno-35-180 href=#__codelineno-35-180></a><span class=cm>         * @throws IllegalArgumentException If the max pool size is less than zero.</span>
</span><span id=__span-35-181><a id=__codelineno-35-181 name=__codelineno-35-181 href=#__codelineno-35-181></a><span class=cm>         */</span>
</span><span id=__span-35-182><a id=__codelineno-35-182 name=__codelineno-35-182 href=#__codelineno-35-182></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=nf>SynchronizedPool</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>maxPoolSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-183><a id=__codelineno-35-183 name=__codelineno-35-183 href=#__codelineno-35-183></a><span class=w>            </span><span class=kd>super</span><span class=p>(</span><span class=n>maxPoolSize</span><span class=p>);</span>
</span><span id=__span-35-184><a id=__codelineno-35-184 name=__codelineno-35-184 href=#__codelineno-35-184></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-185><a id=__codelineno-35-185 name=__codelineno-35-185 href=#__codelineno-35-185></a>
</span><span id=__span-35-186><a id=__codelineno-35-186 name=__codelineno-35-186 href=#__codelineno-35-186></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-35-187><a id=__codelineno-35-187 name=__codelineno-35-187 href=#__codelineno-35-187></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=nf>acquire</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-188><a id=__codelineno-35-188 name=__codelineno-35-188 href=#__codelineno-35-188></a><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-189><a id=__codelineno-35-189 name=__codelineno-35-189 href=#__codelineno-35-189></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
</span><span id=__span-35-190><a id=__codelineno-35-190 name=__codelineno-35-190 href=#__codelineno-35-190></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-191><a id=__codelineno-35-191 name=__codelineno-35-191 href=#__codelineno-35-191></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-192><a id=__codelineno-35-192 name=__codelineno-35-192 href=#__codelineno-35-192></a>
</span><span id=__span-35-193><a id=__codelineno-35-193 name=__codelineno-35-193 href=#__codelineno-35-193></a><span class=w>        </span><span class=nd>@Override</span>
</span><span id=__span-35-194><a id=__codelineno-35-194 name=__codelineno-35-194 href=#__codelineno-35-194></a><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>element</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-195><a id=__codelineno-35-195 name=__codelineno-35-195 href=#__codelineno-35-195></a><span class=w>            </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mLock</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-35-196><a id=__codelineno-35-196 name=__codelineno-35-196 href=#__codelineno-35-196></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>element</span><span class=p>);</span>
</span><span id=__span-35-197><a id=__codelineno-35-197 name=__codelineno-35-197 href=#__codelineno-35-197></a><span class=w>            </span><span class=p>}</span>
</span><span id=__span-35-198><a id=__codelineno-35-198 name=__codelineno-35-198 href=#__codelineno-35-198></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-35-199><a id=__codelineno-35-199 name=__codelineno-35-199 href=#__codelineno-35-199></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-35-200><a id=__codelineno-35-200 name=__codelineno-35-200 href=#__codelineno-35-200></a><span class=p>}</span>
</span></code></pre></div> <p>接着看看<code>engineJob.start(decodeJob)</code>这句代码：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=c1>// EngineJob</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>decodeJob</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>decodeJob</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeJob</span><span class=p>;</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=w>  </span><span class=c1>// decodeJob.willDecodeFromCache()返回true</span>
</span><span id=__span-36-5><a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a><span class=w>  </span><span class=n>GlideExecutor</span><span class=w> </span><span class=n>executor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeJob</span><span class=p>.</span><span class=na>willDecodeFromCache</span><span class=p>()</span>
</span><span id=__span-36-6><a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a><span class=w>      </span><span class=o>?</span><span class=w> </span><span class=n>diskCacheExecutor</span>
</span><span id=__span-36-7><a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a><span class=w>      </span><span class=p>:</span><span class=w> </span><span class=n>getActiveSourceExecutor</span><span class=p>();</span>
</span><span id=__span-36-8><a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a><span class=w>  </span><span class=n>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
</span><span id=__span-36-9><a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a><span class=p>}</span>
</span><span id=__span-36-10><a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>
</span><span id=__span-36-11><a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a><span class=c1>// DecodeJob</span>
</span><span id=__span-36-12><a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a><span class=cm>/**</span>
</span><span id=__span-36-13><a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a><span class=cm>  * Returns true if this job will attempt to decode a resource from the disk cache, and false if it</span>
</span><span id=__span-36-14><a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a><span class=cm>  * will always decode from source.</span>
</span><span id=__span-36-15><a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a><span class=cm>  */</span>
</span><span id=__span-36-16><a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a><span class=kt>boolean</span><span class=w> </span><span class=nf>willDecodeFromCache</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-17><a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a><span class=w>  </span><span class=c1>// 返回值为Stage.RESOURCE_CACHE</span>
</span><span id=__span-36-18><a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a><span class=w>  </span><span class=n>Stage</span><span class=w> </span><span class=n>firstStage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>INITIALIZE</span><span class=p>);</span>
</span><span id=__span-36-19><a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>firstStage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>firstStage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>;</span>
</span><span id=__span-36-20><a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a><span class=p>}</span>
</span><span id=__span-36-21><a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a>
</span><span id=__span-36-22><a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a><span class=kd>private</span><span class=w> </span><span class=n>Stage</span><span class=w> </span><span class=nf>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-23><a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a><span class=w>    </span><span class=c1>// diskCacheStrategy为DiskCacheStrategy.AUTOMATIC</span>
</span><span id=__span-36-24><a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a><span class=w>    </span><span class=c1>// decodeCachedResource()为true</span>
</span><span id=__span-36-25><a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-36-26><a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>INITIALIZE</span><span class=p>:</span>
</span><span id=__span-36-27><a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedResource</span><span class=p>()</span>
</span><span id=__span-36-28><a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a><span class=w>            </span><span class=o>?</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=p>);</span>
</span><span id=__span-36-29><a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>RESOURCE_CACHE</span><span class=p>:</span>
</span><span id=__span-36-30><a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedData</span><span class=p>()</span>
</span><span id=__span-36-31><a id=__codelineno-36-31 name=__codelineno-36-31 href=#__codelineno-36-31></a><span class=w>            </span><span class=o>?</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>);</span>
</span><span id=__span-36-32><a id=__codelineno-36-32 name=__codelineno-36-32 href=#__codelineno-36-32></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>DATA_CACHE</span><span class=p>:</span>
</span><span id=__span-36-33><a id=__codelineno-36-33 name=__codelineno-36-33 href=#__codelineno-36-33></a><span class=w>        </span><span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
</span><span id=__span-36-34><a id=__codelineno-36-34 name=__codelineno-36-34 href=#__codelineno-36-34></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>onlyRetrieveFromCache</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>;</span>
</span><span id=__span-36-35><a id=__codelineno-36-35 name=__codelineno-36-35 href=#__codelineno-36-35></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>SOURCE</span><span class=p>:</span>
</span><span id=__span-36-36><a id=__codelineno-36-36 name=__codelineno-36-36 href=#__codelineno-36-36></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>FINISHED</span><span class=p>:</span>
</span><span id=__span-36-37><a id=__codelineno-36-37 name=__codelineno-36-37 href=#__codelineno-36-37></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=p>;</span>
</span><span id=__span-36-38><a id=__codelineno-36-38 name=__codelineno-36-38 href=#__codelineno-36-38></a><span class=w>      </span><span class=k>default</span><span class=p>:</span>
</span><span id=__span-36-39><a id=__codelineno-36-39 name=__codelineno-36-39 href=#__codelineno-36-39></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>current</span><span class=p>);</span>
</span><span id=__span-36-40><a id=__codelineno-36-40 name=__codelineno-36-40 href=#__codelineno-36-40></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-36-41><a id=__codelineno-36-41 name=__codelineno-36-41 href=#__codelineno-36-41></a><span class=w>  </span><span class=p>}</span>
</span></code></pre></div> <p>此状态机的所有状态如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=cm>/**</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=cm>  * Where we&#39;re trying to decode data from.</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=cm>  */</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=kd>private</span><span class=w> </span><span class=kd>enum</span><span class=w> </span><span class=n>Stage</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=w>  </span><span class=cm>/** The initial stage. */</span>
</span><span id=__span-37-6><a id=__codelineno-37-6 name=__codelineno-37-6 href=#__codelineno-37-6></a><span class=w>  </span><span class=n>INITIALIZE</span><span class=p>,</span>
</span><span id=__span-37-7><a id=__codelineno-37-7 name=__codelineno-37-7 href=#__codelineno-37-7></a><span class=w>  </span><span class=cm>/** Decode from a cached resource. */</span>
</span><span id=__span-37-8><a id=__codelineno-37-8 name=__codelineno-37-8 href=#__codelineno-37-8></a><span class=w>  </span><span class=n>RESOURCE_CACHE</span><span class=p>,</span>
</span><span id=__span-37-9><a id=__codelineno-37-9 name=__codelineno-37-9 href=#__codelineno-37-9></a><span class=w>  </span><span class=cm>/** Decode from cached source data. */</span>
</span><span id=__span-37-10><a id=__codelineno-37-10 name=__codelineno-37-10 href=#__codelineno-37-10></a><span class=w>  </span><span class=n>DATA_CACHE</span><span class=p>,</span>
</span><span id=__span-37-11><a id=__codelineno-37-11 name=__codelineno-37-11 href=#__codelineno-37-11></a><span class=w>  </span><span class=cm>/** Decode from retrieved source. */</span>
</span><span id=__span-37-12><a id=__codelineno-37-12 name=__codelineno-37-12 href=#__codelineno-37-12></a><span class=w>  </span><span class=n>SOURCE</span><span class=p>,</span>
</span><span id=__span-37-13><a id=__codelineno-37-13 name=__codelineno-37-13 href=#__codelineno-37-13></a><span class=w>  </span><span class=cm>/** Encoding transformed resources after a successful load. */</span>
</span><span id=__span-37-14><a id=__codelineno-37-14 name=__codelineno-37-14 href=#__codelineno-37-14></a><span class=w>  </span><span class=n>ENCODE</span><span class=p>,</span>
</span><span id=__span-37-15><a id=__codelineno-37-15 name=__codelineno-37-15 href=#__codelineno-37-15></a><span class=w>  </span><span class=cm>/** No more viable stages. */</span>
</span><span id=__span-37-16><a id=__codelineno-37-16 name=__codelineno-37-16 href=#__codelineno-37-16></a><span class=w>  </span><span class=n>FINISHED</span><span class=p>,</span>
</span><span id=__span-37-17><a id=__codelineno-37-17 name=__codelineno-37-17 href=#__codelineno-37-17></a><span class=p>}</span>
</span></code></pre></div> <p>回到<code>EngineJob.start</code>方法中，由于<code>decodeJob.willDecodeFromCache()</code>为true，那么就使用<code>diskCacheExecutor</code>来执行decodeJob。<br> <code>diskCacheExecutor</code>默认值为<code>GlideExecutor.newDiskCacheExecutor()</code>，这是类似于一个<code>SingleThreadExecutor</code>的线程池，这里使用了设计模式中的代理模式：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=cm>/**</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=cm> * A prioritized {@link ThreadPoolExecutor} for running jobs in Glide.</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=cm> */</span>
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>GlideExecutor</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>DEFAULT_DISK_CACHE_EXECUTOR_NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;disk-cache&quot;</span><span class=p>;</span>
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
</span><span id=__span-38-7><a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a>
</span><span id=__span-38-8><a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ExecutorService</span><span class=w> </span><span class=n>delegate</span><span class=p>;</span>
</span><span id=__span-38-9><a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a>
</span><span id=__span-38-10><a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GlideExecutor</span><span class=w> </span><span class=nf>newDiskCacheExecutor</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-11><a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>newDiskCacheExecutor</span><span class=p>(</span>
</span><span id=__span-38-12><a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=w>        </span><span class=n>DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span><span class=p>,</span>
</span><span id=__span-38-13><a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=w>        </span><span class=n>DEFAULT_DISK_CACHE_EXECUTOR_NAME</span><span class=p>,</span>
</span><span id=__span-38-14><a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>        </span><span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>);</span>
</span><span id=__span-38-15><a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-16><a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a>
</span><span id=__span-38-17><a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GlideExecutor</span><span class=w> </span><span class=nf>newDiskCacheExecutor</span><span class=p>(</span>
</span><span id=__span-38-18><a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=w>      </span><span class=kt>int</span><span class=w> </span><span class=n>threadCount</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>UncaughtThrowableStrategy</span><span class=w> </span><span class=n>uncaughtThrowableStrategy</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-19><a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideExecutor</span><span class=p>(</span>
</span><span id=__span-38-20><a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>ThreadPoolExecutor</span><span class=p>(</span>
</span><span id=__span-38-21><a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=w>            </span><span class=n>threadCount</span><span class=w> </span><span class=cm>/* corePoolSize */</span><span class=p>,</span>
</span><span id=__span-38-22><a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=w>            </span><span class=n>threadCount</span><span class=w> </span><span class=cm>/* maximumPoolSize */</span><span class=p>,</span>
</span><span id=__span-38-23><a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=w>            </span><span class=mi>0</span><span class=w> </span><span class=cm>/* keepAliveTime */</span><span class=p>,</span>
</span><span id=__span-38-24><a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=w>            </span><span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span>
</span><span id=__span-38-25><a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>PriorityBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>(),</span>
</span><span id=__span-38-26><a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>DefaultThreadFactory</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>uncaughtThrowableStrategy</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>)));</span>
</span><span id=__span-38-27><a id=__codelineno-38-27 name=__codelineno-38-27 href=#__codelineno-38-27></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-28><a id=__codelineno-38-28 name=__codelineno-38-28 href=#__codelineno-38-28></a>
</span><span id=__span-38-29><a id=__codelineno-38-29 name=__codelineno-38-29 href=#__codelineno-38-29></a><span class=w>  </span><span class=nd>@VisibleForTesting</span>
</span><span id=__span-38-30><a id=__codelineno-38-30 name=__codelineno-38-30 href=#__codelineno-38-30></a><span class=w>  </span><span class=n>GlideExecutor</span><span class=p>(</span><span class=n>ExecutorService</span><span class=w> </span><span class=n>delegate</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-31><a id=__codelineno-38-31 name=__codelineno-38-31 href=#__codelineno-38-31></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>delegate</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>delegate</span><span class=p>;</span>
</span><span id=__span-38-32><a id=__codelineno-38-32 name=__codelineno-38-32 href=#__codelineno-38-32></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-33><a id=__codelineno-38-33 name=__codelineno-38-33 href=#__codelineno-38-33></a>
</span><span id=__span-38-34><a id=__codelineno-38-34 name=__codelineno-38-34 href=#__codelineno-38-34></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-38-35><a id=__codelineno-38-35 name=__codelineno-38-35 href=#__codelineno-38-35></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>execute</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-36><a id=__codelineno-38-36 name=__codelineno-38-36 href=#__codelineno-38-36></a><span class=w>    </span><span class=n>delegate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
</span><span id=__span-38-37><a id=__codelineno-38-37 name=__codelineno-38-37 href=#__codelineno-38-37></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-38><a id=__codelineno-38-38 name=__codelineno-38-38 href=#__codelineno-38-38></a>
</span><span id=__span-38-39><a id=__codelineno-38-39 name=__codelineno-38-39 href=#__codelineno-38-39></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-38-40><a id=__codelineno-38-40 name=__codelineno-38-40 href=#__codelineno-38-40></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-38-41><a id=__codelineno-38-41 name=__codelineno-38-41 href=#__codelineno-38-41></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>Future</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>submit</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>task</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-38-42><a id=__codelineno-38-42 name=__codelineno-38-42 href=#__codelineno-38-42></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>delegate</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>task</span><span class=p>);</span>
</span><span id=__span-38-43><a id=__codelineno-38-43 name=__codelineno-38-43 href=#__codelineno-38-43></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-38-44><a id=__codelineno-38-44 name=__codelineno-38-44 href=#__codelineno-38-44></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-38-45><a id=__codelineno-38-45 name=__codelineno-38-45 href=#__codelineno-38-45></a><span class=p>}</span>
</span></code></pre></div> <p>现在，<code>decodeJob</code>已经提交到了线程池中，待会儿我们在看子线程中的执行情况。<br> 现在回到主线程的<code>SingleRequest.begin</code>方法中，接下来执行的是：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>status</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=w>    </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>canNotifyStatusChanged</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=w>  </span><span class=n>target</span><span class=p>.</span><span class=na>onLoadStarted</span><span class=p>(</span><span class=n>getPlaceholderDrawable</span><span class=p>());</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=p>}</span>
</span></code></pre></div> <p>由于此时<code>status == Status.RUNNING</code>为true，现在开始展示placeholder。</p> <h3 id=34-decodejobrun>3.4 DecodeJob.run<a class=headerlink href=#34-decodejobrun title="Permanent link">&para;</a></h3> <p>接着，继续看看<code>decodeJob.run</code>方法在线程池中的执行情况：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=nd>@Override</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=w>  </span><span class=c1>// This should be much more fine grained, but since Java&#39;s thread pool implementation silently</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a><span class=w>  </span><span class=c1>// swallows all otherwise fatal exceptions, this will at least make it obvious to developers</span>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=w>  </span><span class=c1>// that something is failing.</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=w>  </span><span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSectionFormat</span><span class=p>(</span><span class=s>&quot;DecodeJob#run(model=%s)&quot;</span><span class=p>,</span><span class=w> </span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a><span class=w>  </span><span class=c1>// Methods in the try statement can invalidate currentFetcher, so set a local variable here to</span>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=w>  </span><span class=c1>// ensure that the fetcher is cleaned up either way.</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a><span class=w>  </span><span class=c1>//</span>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=w>  </span><span class=c1>// currentFetcher目前为null</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a><span class=w>  </span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>localFetcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>currentFetcher</span><span class=p>;</span>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-13><a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-14><a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a><span class=w>      </span><span class=n>notifyFailed</span><span class=p>();</span>
</span><span id=__span-40-15><a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a><span class=w>      </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-40-16><a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-17><a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a><span class=w>    </span><span class=n>runWrapped</span><span class=p>();</span>
</span><span id=__span-40-18><a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>CallbackException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-19><a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a><span class=w>    </span><span class=c1>// If a callback not controlled by Glide throws an exception, we should avoid the Glide</span>
</span><span id=__span-40-20><a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a><span class=w>    </span><span class=c1>// specific debug logic below.</span>
</span><span id=__span-40-21><a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span>
</span><span id=__span-40-22><a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-23><a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a><span class=w>    </span><span class=c1>// Catch Throwable and not Exception to handle OOMs. Throwables are swallowed by our</span>
</span><span id=__span-40-24><a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a><span class=w>    </span><span class=c1>// usage of .submit() in GlideExecutor so we&#39;re not silently hiding crashes by doing this. We</span>
</span><span id=__span-40-25><a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a><span class=w>    </span><span class=c1>// are however ensuring that our callbacks are always notified when a load fails. Without this</span>
</span><span id=__span-40-26><a id=__codelineno-40-26 name=__codelineno-40-26 href=#__codelineno-40-26></a><span class=w>    </span><span class=c1>// notification, uncaught throwables never notify the corresponding callbacks, which can cause</span>
</span><span id=__span-40-27><a id=__codelineno-40-27 name=__codelineno-40-27 href=#__codelineno-40-27></a><span class=w>    </span><span class=c1>// loads to silently hang forever, a case that&#39;s especially bad for users using Futures on</span>
</span><span id=__span-40-28><a id=__codelineno-40-28 name=__codelineno-40-28 href=#__codelineno-40-28></a><span class=w>    </span><span class=c1>// background threads.</span>
</span><span id=__span-40-29><a id=__codelineno-40-29 name=__codelineno-40-29 href=#__codelineno-40-29></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-30><a id=__codelineno-40-30 name=__codelineno-40-30 href=#__codelineno-40-30></a><span class=w>      </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;DecodeJob threw unexpectedly&quot;</span>
</span><span id=__span-40-31><a id=__codelineno-40-31 name=__codelineno-40-31 href=#__codelineno-40-31></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, isCancelled: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>isCancelled</span>
</span><span id=__span-40-32><a id=__codelineno-40-32 name=__codelineno-40-32 href=#__codelineno-40-32></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, stage: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>stage</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span>
</span><span id=__span-40-33><a id=__codelineno-40-33 name=__codelineno-40-33 href=#__codelineno-40-33></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-34><a id=__codelineno-40-34 name=__codelineno-40-34 href=#__codelineno-40-34></a><span class=w>    </span><span class=c1>// When we&#39;re encoding we&#39;ve already notified our callback and it isn&#39;t safe to do so again.</span>
</span><span id=__span-40-35><a id=__codelineno-40-35 name=__codelineno-40-35 href=#__codelineno-40-35></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stage</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-36><a id=__codelineno-40-36 name=__codelineno-40-36 href=#__codelineno-40-36></a><span class=w>      </span><span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
</span><span id=__span-40-37><a id=__codelineno-40-37 name=__codelineno-40-37 href=#__codelineno-40-37></a><span class=w>      </span><span class=n>notifyFailed</span><span class=p>();</span>
</span><span id=__span-40-38><a id=__codelineno-40-38 name=__codelineno-40-38 href=#__codelineno-40-38></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-39><a id=__codelineno-40-39 name=__codelineno-40-39 href=#__codelineno-40-39></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-40><a id=__codelineno-40-40 name=__codelineno-40-40 href=#__codelineno-40-40></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span><span id=__span-40-41><a id=__codelineno-40-41 name=__codelineno-40-41 href=#__codelineno-40-41></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-42><a id=__codelineno-40-42 name=__codelineno-40-42 href=#__codelineno-40-42></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span><span id=__span-40-43><a id=__codelineno-40-43 name=__codelineno-40-43 href=#__codelineno-40-43></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-44><a id=__codelineno-40-44 name=__codelineno-40-44 href=#__codelineno-40-44></a><span class=w>    </span><span class=c1>// Keeping track of the fetcher here and calling cleanup is excessively paranoid, we call</span>
</span><span id=__span-40-45><a id=__codelineno-40-45 name=__codelineno-40-45 href=#__codelineno-40-45></a><span class=w>    </span><span class=c1>// close in all cases anyway.</span>
</span><span id=__span-40-46><a id=__codelineno-40-46 name=__codelineno-40-46 href=#__codelineno-40-46></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>localFetcher</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-40-47><a id=__codelineno-40-47 name=__codelineno-40-47 href=#__codelineno-40-47></a><span class=w>      </span><span class=n>localFetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-40-48><a id=__codelineno-40-48 name=__codelineno-40-48 href=#__codelineno-40-48></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-40-49><a id=__codelineno-40-49 name=__codelineno-40-49 href=#__codelineno-40-49></a><span class=w>    </span><span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
</span><span id=__span-40-50><a id=__codelineno-40-50 name=__codelineno-40-50 href=#__codelineno-40-50></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-40-51><a id=__codelineno-40-51 name=__codelineno-40-51 href=#__codelineno-40-51></a><span class=p>}</span>
</span></code></pre></div> <p>里面真正执行的是<code>runWrapped</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>runWrapped</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=w>  </span><span class=c1>// runReason在DecodeJob.init方法中被初始化为INITIALIZE</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=w>  </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>runReason</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>INITIALIZE</span><span class=p>:</span>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=w>      </span><span class=c1>// INITIALIZE下一个状态显然为RESOURCE_CACHE</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=w>      </span><span class=n>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>INITIALIZE</span><span class=p>);</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a><span class=w>      </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextGenerator</span><span class=p>();</span>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=w>      </span><span class=n>runGenerators</span><span class=p>();</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a><span class=w>      </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=p>}</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a>
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=cm>/**</span>
</span><span id=__span-41-15><a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a><span class=cm> * 返回一个ResourceCacheGenerator</span>
</span><span id=__span-41-16><a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=cm> */</span>
</span><span id=__span-41-17><a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a><span class=kd>private</span><span class=w> </span><span class=n>DataFetcherGenerator</span><span class=w> </span><span class=nf>getNextGenerator</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-18><a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=w>  </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>stage</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-41-19><a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>RESOURCE_CACHE</span><span class=p>:</span>
</span><span id=__span-41-20><a id=__codelineno-41-20 name=__codelineno-41-20 href=#__codelineno-41-20></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-41-21><a id=__codelineno-41-21 name=__codelineno-41-21 href=#__codelineno-41-21></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-41-22><a id=__codelineno-41-22 name=__codelineno-41-22 href=#__codelineno-41-22></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-41-23><a id=__codelineno-41-23 name=__codelineno-41-23 href=#__codelineno-41-23></a><span class=p>}</span>
</span></code></pre></div> <p><code>getNextGenerator()</code>方法返回了一个<code>ResourceCacheGenerator</code>，然后调用<code>runGenerators()</code>方法进行执行。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>runGenerators</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=w>  </span><span class=n>currentThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=w>  </span><span class=n>startFetchTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>isStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>isStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=w>    </span><span class=n>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=w>    </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextGenerator</span><span class=p>();</span>
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a>
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=w>      </span><span class=n>reschedule</span><span class=p>();</span>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=w>      </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=w>  </span><span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isStarted</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=w>    </span><span class=n>notifyFailed</span><span class=p>();</span>
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a>
</span><span id=__span-42-20><a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a><span class=w>  </span><span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
</span><span id=__span-42-21><a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a><span class=w>  </span><span class=c1>// onDataFetcherReady.</span>
</span><span id=__span-42-22><a id=__codelineno-42-22 name=__codelineno-42-22 href=#__codelineno-42-22></a><span class=p>}</span>
</span></code></pre></div> <p>在该方法中会依次调用各个状态生成的<code>DataFetcherGenerator</code>的<code>startNext()</code>尝试fetch数据，直到有某个状态的<code>DataFetcherGenerator.startNext()</code>方法可以胜任。若状态抵达到了<code>Stage.FINISHED</code>或job被取消，且所有状态的<code>DataFetcherGenerator.startNext()</code>都无法满足条件，则调用<code>SingleRequest.onLoadFailed</code>进行错误处理。 </p> <p>这里总共有三个<code>DataFetcherGenerator</code>，依次是：</p> <ol> <li>ResourceCacheGenerator<br> 获取采样后、transformed后资源文件的缓存文件</li> <li>DataCacheGenerator<br> 获取原始的没有修改过的资源文件的缓存文件</li> <li>SourceGenerator<br> 获取原始源数据</li> </ol> <p>这里面fetch数据逻辑有点复杂，因为涉及到<code>Registry</code>类，该类是用来管理Glide注册进来的用来拓展或替代Glide默认加载、解码、编码逻辑的组件。在Glide创建的时候，绝大多数代码都是对<code>Registry</code>的操作。</p> <p>我们先大致说一下<code>Registry</code>类里面各个组件的功能吧。</p> <h3 id=35-registry>3.5 Registry<a class=headerlink href=#35-registry title="Permanent link">&para;</a></h3> <p>Glide在创建时，会向<code>Registry</code>实例中注入相当多的配置，每个配置都会转发给对应的一个专门的类，这些专门的类有7个。<br> 在这7个类中，除了<code>DataRewinderRegistry</code>和<code>ImageHeaderParserRegistry</code>外，其他的Registry都会将注入的配置保存到内部的<code>Entry</code>类中。<code>Entry</code>类的作用就是判断该项配置能够满足条件（<code>handles</code>）。<br> <code>handles</code>方法都是以<code>isAssignableFrom</code>方法判断，但被判断参数有一些差别。</p> <p>在各个Registry中<code>Entry</code>类的<code>hanldes</code>实现前，先理解一下这里面出现的各种class：</p> <ul> <li><code>modelClass</code><br> Glide.with(..).load()中被load参数的类型，在实例中就是String.class</li> <li><code>dataClass</code><br> 比较原始的数据，根据<code>ModelLoaderRegistry</code>中的配置，可以得到所有由<code>modelClass</code>有可能到达的<code>dataClass</code><br> 同时，一起注入的<code>ModelLoaderFactory&lt;Model, Data&gt;</code>是一个可以创建如何从<code>modelClass</code>到<code>dataClass</code>进行转换的<code>ModelLoader&lt;Model, Data&gt;</code>的类的工厂，可以根据<code>modelClass</code>获得</li> <li><code>resourceClass</code><br> 解码后的资源类型，根据<code>ResourceDecoderRegistry</code>中的配置，可以由<code>dataClass</code>和<code>resourceClass</code>获得所有<code>registeredResourceClasses</code><br> 同时，一起注入的<code>ResourceDecoder&lt;Data, Resource&gt;</code>是一个将<code>dataClass</code>解码成<code>resourceClass</code>的类，可以由有可能到达的<code>dataClass</code>以及<code>registeredResourceClass</code>获得</li> <li><code>transcodeClass</code><br> 最终要转换成的数据类型，一般情况下Drawable.class；若Glide加载是指定了asBitmap、asGif、asFile，那么此类型就是Bitmap.class、GifDrawable.class、File.class<br> 若<code>registeredResourceClass</code>不是<code>transcodeClass</code>类型，则通过<code>TranscoderRegistry</code>注入的<code>ResourceTranscoder&lt;Resource, T&gt;</code>可以将<code>resourceClass</code>转为<code>transcodeClass</code></li> </ul> <p>下面是5个在各个Registry中<code>Entry</code>类的<code>hanldes</code>实现：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=c1>// MultiModelLoaderFactory.Entry</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>;</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=w>  </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>;</span>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>);</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a>
</span><span id=__span-43-10><a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-11><a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>modelClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
</span><span id=__span-43-12><a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-43-13><a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=p>}</span>
</span><span id=__span-43-14><a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a>
</span><span id=__span-43-15><a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=c1>// EncoderRegistry.Entry</span>
</span><span id=__span-43-16><a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-17><a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>;</span>
</span><span id=__span-43-18><a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-43-19><a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-20><a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>);</span>
</span><span id=__span-43-21><a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-43-22><a id=__codelineno-43-22 name=__codelineno-43-22 href=#__codelineno-43-22></a><span class=p>}</span>
</span><span id=__span-43-23><a id=__codelineno-43-23 name=__codelineno-43-23 href=#__codelineno-43-23></a>
</span><span id=__span-43-24><a id=__codelineno-43-24 name=__codelineno-43-24 href=#__codelineno-43-24></a><span class=c1>// ResourceEncoderRegistry.Entry</span>
</span><span id=__span-43-25><a id=__codelineno-43-25 name=__codelineno-43-25 href=#__codelineno-43-25></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-26><a id=__codelineno-43-26 name=__codelineno-43-26 href=#__codelineno-43-26></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>;</span>
</span><span id=__span-43-27><a id=__codelineno-43-27 name=__codelineno-43-27 href=#__codelineno-43-27></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-43-28><a id=__codelineno-43-28 name=__codelineno-43-28 href=#__codelineno-43-28></a><span class=w>  </span><span class=nd>@Synthetic</span>
</span><span id=__span-43-29><a id=__codelineno-43-29 name=__codelineno-43-29 href=#__codelineno-43-29></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-30><a id=__codelineno-43-30 name=__codelineno-43-30 href=#__codelineno-43-30></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-43-31><a id=__codelineno-43-31 name=__codelineno-43-31 href=#__codelineno-43-31></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-43-32><a id=__codelineno-43-32 name=__codelineno-43-32 href=#__codelineno-43-32></a><span class=p>}</span>
</span><span id=__span-43-33><a id=__codelineno-43-33 name=__codelineno-43-33 href=#__codelineno-43-33></a>
</span><span id=__span-43-34><a id=__codelineno-43-34 name=__codelineno-43-34 href=#__codelineno-43-34></a><span class=c1>// ResourceDecoderRegistry.Entry</span>
</span><span id=__span-43-35><a id=__codelineno-43-35 name=__codelineno-43-35 href=#__codelineno-43-35></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-36><a id=__codelineno-43-36 name=__codelineno-43-36 href=#__codelineno-43-36></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>;</span>
</span><span id=__span-43-37><a id=__codelineno-43-37 name=__codelineno-43-37 href=#__codelineno-43-37></a><span class=w>  </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>;</span>
</span><span id=__span-43-38><a id=__codelineno-43-38 name=__codelineno-43-38 href=#__codelineno-43-38></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-43-39><a id=__codelineno-43-39 name=__codelineno-43-39 href=#__codelineno-43-39></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-40><a id=__codelineno-43-40 name=__codelineno-43-40 href=#__codelineno-43-40></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>resourceClass</span>
</span><span id=__span-43-41><a id=__codelineno-43-41 name=__codelineno-43-41 href=#__codelineno-43-41></a><span class=w>        </span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>);</span>
</span><span id=__span-43-42><a id=__codelineno-43-42 name=__codelineno-43-42 href=#__codelineno-43-42></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-43-43><a id=__codelineno-43-43 name=__codelineno-43-43 href=#__codelineno-43-43></a><span class=p>}</span>
</span><span id=__span-43-44><a id=__codelineno-43-44 name=__codelineno-43-44 href=#__codelineno-43-44></a>
</span><span id=__span-43-45><a id=__codelineno-43-45 name=__codelineno-43-45 href=#__codelineno-43-45></a><span class=c1>// TranscoderRegistry.Entry</span>
</span><span id=__span-43-46><a id=__codelineno-43-46 name=__codelineno-43-46 href=#__codelineno-43-46></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-47><a id=__codelineno-43-47 name=__codelineno-43-47 href=#__codelineno-43-47></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>fromClass</span><span class=p>;</span>
</span><span id=__span-43-48><a id=__codelineno-43-48 name=__codelineno-43-48 href=#__codelineno-43-48></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>toClass</span><span class=p>;</span>
</span><span id=__span-43-49><a id=__codelineno-43-49 name=__codelineno-43-49 href=#__codelineno-43-49></a><span class=w>  </span><span class=p>...</span>
</span><span id=__span-43-50><a id=__codelineno-43-50 name=__codelineno-43-50 href=#__codelineno-43-50></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>fromClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>toClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-43-51><a id=__codelineno-43-51 name=__codelineno-43-51 href=#__codelineno-43-51></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=na>fromClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>fromClass</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>toClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>toClass</span><span class=p>);</span>
</span><span id=__span-43-52><a id=__codelineno-43-52 name=__codelineno-43-52 href=#__codelineno-43-52></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-43-53><a id=__codelineno-43-53 name=__codelineno-43-53 href=#__codelineno-43-53></a><span class=p>}</span>
</span></code></pre></div> <blockquote> <p><code>isAssignableFrom</code>判断该类是否是某个类的父类，<code>instanceof</code>判断该实例的类是否某个实例的类的子类。</p> </blockquote> <p>这7个Registry类作用如下：</p> <ol> <li>ModelLoaderRegistry<br> 构建<code>modelClass</code>到<code>dataClass</code>的桥梁<br> <em>load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors).</em></li> <li>ResourceDecoderRegistry<br> <code>dataClass</code>到<code>resourceClass</code>的桥梁<br> <em>to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors).</em></li> <li>EncoderRegistry<br> <em>write Data (InputStreams, FileDescriptors) to Glide’s disk cache</em></li> <li>TranscoderRegistry<br> 构建<code>resourceClass</code>到<code>transcodeClass</code>的桥梁<br> <em>convert Resources (BitmapResource) into other types of Resources (DrawableResource)</em></li> <li>ResourceEncoderRegistry<br> <em>write Resources (BitmapResource, DrawableResource) to Glide’s disk cache.</em></li> <li>DataRewinderRegistry<br> 提供对<code>ByteBuffer.class</code>、<code>InputStream.class</code>这两种data进行rewind操作的能力</li> <li>ImageHeaderParserRegistry<br> 提供解析Image头信息的能力</li> </ol> <blockquote> <ol> <li><code>ModelLoaders</code> to load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors). </li> <li><code>ResourceDecoders</code> to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors). </li> <li><code>Encoders</code> to write Data (InputStreams, FileDescriptors) to Glide’s disk cache. </li> <li><code>ResourceTranscoders</code> to convert Resources (BitmapResource) into other types of Resources (DrawableResource). </li> <li><code>ResourceEncoders</code> to write Resources (BitmapResource, DrawableResource) to Glide’s disk cache. </li> </ol> <p><strong>Anatomy of a load</strong><br> The set of registered components, including both those registered by default in Glide and those registered in Modules are used to define a set of load paths. Each load path is a step by step progression from the the Model provided to <code>load()</code> to the Resource type specified by <code>as()</code>. A load path consists (roughly) of the following steps:<br> 1. Model -&gt; Data (handled by <code>ModelLoader</code>s) 2. Data -&gt; Resource (handled by <code>ResourceDecoder</code>s) 3. Resource -&gt; Transcoded Resource (optional, handled by <code>ResourceTranscoder</code>s).</p> <p><code>Encoder</code>s can write Data to Glide’s disk cache cache before step 2.<br> <code>ResourceEncoder</code>s can write Resource’s to Glide’s disk cache before step 3.<br> When a request is started, Glide will attempt all available paths from the Model to the requested Resource type. A request will succeed if any load path succeeds. A request will fail only if all available load paths fail. </p> <p><cite><a href=http://bumptech.github.io/glide/doc/configuration.html#registering-components>Configuration - Registering Components</a></cite> </p> </blockquote> <h3 id=36-resourcecachegenerator>3.6 ResourceCacheGenerator<a class=headerlink href=#36-resourcecachegenerator title="Permanent link">&para;</a></h3> <p>下面我们看看<code>ResourceCacheGenerator.startNext</code>方法，由于方法这里面方法调用层次非常深，所以先直接写上每一步执行的结果，有一个大体上的了解：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=nd>@Override</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startNext</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=w> </span><span class=c1>// list里面只有一个GlideUrl对象</span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span><span class=w> </span><span class=n>sourceIds</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getCacheKeys</span><span class=p>();</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceIds</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=w> </span><span class=c1>// 获得了三个可以到达的registeredResourceClasses</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=w> </span><span class=c1>// GifDrawable、Bitmap、BitmapDrawable</span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>resourceClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>();</span>
</span><span id=__span-44-11><a id=__codelineno-44-11 name=__codelineno-44-11 href=#__codelineno-44-11></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-12><a id=__codelineno-44-12 name=__codelineno-44-12 href=#__codelineno-44-12></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getTranscodeClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-13><a id=__codelineno-44-13 name=__codelineno-44-13 href=#__codelineno-44-13></a><span class=w>     </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-44-14><a id=__codelineno-44-14 name=__codelineno-44-14 href=#__codelineno-44-14></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-44-15><a id=__codelineno-44-15 name=__codelineno-44-15 href=#__codelineno-44-15></a><span class=w>   </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span>
</span><span id=__span-44-16><a id=__codelineno-44-16 name=__codelineno-44-16 href=#__codelineno-44-16></a><span class=w>       </span><span class=s>&quot;Failed to find any load path from &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getModelClass</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; to &quot;</span>
</span><span id=__span-44-17><a id=__codelineno-44-17 name=__codelineno-44-17 href=#__codelineno-44-17></a><span class=w>           </span><span class=o>+</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getTranscodeClass</span><span class=p>());</span>
</span><span id=__span-44-18><a id=__codelineno-44-18 name=__codelineno-44-18 href=#__codelineno-44-18></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-44-19><a id=__codelineno-44-19 name=__codelineno-44-19 href=#__codelineno-44-19></a><span class=w> </span><span class=c1>// 遍历sourceIds中的每一个key、resourceClasses中每一个class，以及其他的一些值组成key</span>
</span><span id=__span-44-20><a id=__codelineno-44-20 name=__codelineno-44-20 href=#__codelineno-44-20></a><span class=w> </span><span class=c1>// 尝试在磁盘缓存中以key找到缓存文件</span>
</span><span id=__span-44-21><a id=__codelineno-44-21 name=__codelineno-44-21 href=#__codelineno-44-21></a><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>modelLoaders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-22><a id=__codelineno-44-22 name=__codelineno-44-22 href=#__codelineno-44-22></a><span class=w>   </span><span class=n>resourceClassIndex</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-44-23><a id=__codelineno-44-23 name=__codelineno-44-23 href=#__codelineno-44-23></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>size</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-24><a id=__codelineno-44-24 name=__codelineno-44-24 href=#__codelineno-44-24></a><span class=w>     </span><span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-44-25><a id=__codelineno-44-25 name=__codelineno-44-25 href=#__codelineno-44-25></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>sourceIds</span><span class=p>.</span><span class=na>size</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-26><a id=__codelineno-44-26 name=__codelineno-44-26 href=#__codelineno-44-26></a><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-44-27><a id=__codelineno-44-27 name=__codelineno-44-27 href=#__codelineno-44-27></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-44-28><a id=__codelineno-44-28 name=__codelineno-44-28 href=#__codelineno-44-28></a><span class=w>     </span><span class=n>resourceClassIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-44-29><a id=__codelineno-44-29 name=__codelineno-44-29 href=#__codelineno-44-29></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-44-30><a id=__codelineno-44-30 name=__codelineno-44-30 href=#__codelineno-44-30></a>
</span><span id=__span-44-31><a id=__codelineno-44-31 name=__codelineno-44-31 href=#__codelineno-44-31></a><span class=w>   </span><span class=n>Key</span><span class=w> </span><span class=n>sourceId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceIds</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
</span><span id=__span-44-32><a id=__codelineno-44-32 name=__codelineno-44-32 href=#__codelineno-44-32></a><span class=w>   </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=p>);</span>
</span><span id=__span-44-33><a id=__codelineno-44-33 name=__codelineno-44-33 href=#__codelineno-44-33></a><span class=w>   </span><span class=n>Transformation</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>transformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-44-34><a id=__codelineno-44-34 name=__codelineno-44-34 href=#__codelineno-44-34></a><span class=w>   </span><span class=c1>// PMD.AvoidInstantiatingObjectsInLoops Each iteration is comparatively expensive anyway,</span>
</span><span id=__span-44-35><a id=__codelineno-44-35 name=__codelineno-44-35 href=#__codelineno-44-35></a><span class=w>   </span><span class=c1>// we only run until the first one succeeds, the loop runs for only a limited</span>
</span><span id=__span-44-36><a id=__codelineno-44-36 name=__codelineno-44-36 href=#__codelineno-44-36></a><span class=w>   </span><span class=c1>// number of iterations on the order of 10-20 in the worst case.</span>
</span><span id=__span-44-37><a id=__codelineno-44-37 name=__codelineno-44-37 href=#__codelineno-44-37></a><span class=w>   </span><span class=n>currentKey</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-44-38><a id=__codelineno-44-38 name=__codelineno-44-38 href=#__codelineno-44-38></a><span class=w>       </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheKey</span><span class=p>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops</span>
</span><span id=__span-44-39><a id=__codelineno-44-39 name=__codelineno-44-39 href=#__codelineno-44-39></a><span class=w>           </span><span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
</span><span id=__span-44-40><a id=__codelineno-44-40 name=__codelineno-44-40 href=#__codelineno-44-40></a><span class=w>           </span><span class=n>sourceId</span><span class=p>,</span>
</span><span id=__span-44-41><a id=__codelineno-44-41 name=__codelineno-44-41 href=#__codelineno-44-41></a><span class=w>           </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
</span><span id=__span-44-42><a id=__codelineno-44-42 name=__codelineno-44-42 href=#__codelineno-44-42></a><span class=w>           </span><span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
</span><span id=__span-44-43><a id=__codelineno-44-43 name=__codelineno-44-43 href=#__codelineno-44-43></a><span class=w>           </span><span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
</span><span id=__span-44-44><a id=__codelineno-44-44 name=__codelineno-44-44 href=#__codelineno-44-44></a><span class=w>           </span><span class=n>transformation</span><span class=p>,</span>
</span><span id=__span-44-45><a id=__codelineno-44-45 name=__codelineno-44-45 href=#__codelineno-44-45></a><span class=w>           </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-44-46><a id=__codelineno-44-46 name=__codelineno-44-46 href=#__codelineno-44-46></a><span class=w>           </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</span><span id=__span-44-47><a id=__codelineno-44-47 name=__codelineno-44-47 href=#__codelineno-44-47></a><span class=w>   </span><span class=n>cacheFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>currentKey</span><span class=p>);</span>
</span><span id=__span-44-48><a id=__codelineno-44-48 name=__codelineno-44-48 href=#__codelineno-44-48></a><span class=w>   </span><span class=c1>// 如果找到了缓存文件，那么循环条件则会为false，也就退出循环了</span>
</span><span id=__span-44-49><a id=__codelineno-44-49 name=__codelineno-44-49 href=#__codelineno-44-49></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cacheFile</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-50><a id=__codelineno-44-50 name=__codelineno-44-50 href=#__codelineno-44-50></a><span class=w>     </span><span class=n>sourceKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceId</span><span class=p>;</span>
</span><span id=__span-44-51><a id=__codelineno-44-51 name=__codelineno-44-51 href=#__codelineno-44-51></a><span class=w>     </span><span class=n>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
</span><span id=__span-44-52><a id=__codelineno-44-52 name=__codelineno-44-52 href=#__codelineno-44-52></a><span class=w>     </span><span class=n>modelLoaderIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-44-53><a id=__codelineno-44-53 name=__codelineno-44-53 href=#__codelineno-44-53></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-44-54><a id=__codelineno-44-54 name=__codelineno-44-54 href=#__codelineno-44-54></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-44-55><a id=__codelineno-44-55 name=__codelineno-44-55 href=#__codelineno-44-55></a>
</span><span id=__span-44-56><a id=__codelineno-44-56 name=__codelineno-44-56 href=#__codelineno-44-56></a><span class=w> </span><span class=c1>// 找没找到缓存文件，都会执行这里的方法</span>
</span><span id=__span-44-57><a id=__codelineno-44-57 name=__codelineno-44-57 href=#__codelineno-44-57></a><span class=w> </span><span class=c1>// 如果找到了，hasNextModelLoader()方法则会为true，可以执行循环</span>
</span><span id=__span-44-58><a id=__codelineno-44-58 name=__codelineno-44-58 href=#__codelineno-44-58></a><span class=w> </span><span class=c1>// 没有找到缓存文件，则不会进入循环，会直接返回false</span>
</span><span id=__span-44-59><a id=__codelineno-44-59 name=__codelineno-44-59 href=#__codelineno-44-59></a><span class=w> </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-44-60><a id=__codelineno-44-60 name=__codelineno-44-60 href=#__codelineno-44-60></a><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-44-61><a id=__codelineno-44-61 name=__codelineno-44-61 href=#__codelineno-44-61></a><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>started</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-62><a id=__codelineno-44-62 name=__codelineno-44-62 href=#__codelineno-44-62></a><span class=w>   </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>modelLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
</span><span id=__span-44-63><a id=__codelineno-44-63 name=__codelineno-44-63 href=#__codelineno-44-63></a><span class=w>   </span><span class=c1>//  在循环中会依次判断某个ModelLoader能不能加载此文件</span>
</span><span id=__span-44-64><a id=__codelineno-44-64 name=__codelineno-44-64 href=#__codelineno-44-64></a><span class=w>   </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span>
</span><span id=__span-44-65><a id=__codelineno-44-65 name=__codelineno-44-65 href=#__codelineno-44-65></a><span class=w>       </span><span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</span><span id=__span-44-66><a id=__codelineno-44-66 name=__codelineno-44-66 href=#__codelineno-44-66></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadData</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-44-67><a id=__codelineno-44-67 name=__codelineno-44-67 href=#__codelineno-44-67></a><span class=w>     </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-44-68><a id=__codelineno-44-68 name=__codelineno-44-68 href=#__codelineno-44-68></a><span class=w>     </span><span class=c1>// 如果某个ModelLoader可以，那么就调用其fetcher进行加载数据</span>
</span><span id=__span-44-69><a id=__codelineno-44-69 name=__codelineno-44-69 href=#__codelineno-44-69></a><span class=w>     </span><span class=c1>// 加载成功或失败会通知自身</span>
</span><span id=__span-44-70><a id=__codelineno-44-70 name=__codelineno-44-70 href=#__codelineno-44-70></a><span class=w>     </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-44-71><a id=__codelineno-44-71 name=__codelineno-44-71 href=#__codelineno-44-71></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-44-72><a id=__codelineno-44-72 name=__codelineno-44-72 href=#__codelineno-44-72></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-44-73><a id=__codelineno-44-73 name=__codelineno-44-73 href=#__codelineno-44-73></a>
</span><span id=__span-44-74><a id=__codelineno-44-74 name=__codelineno-44-74 href=#__codelineno-44-74></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>started</span><span class=p>;</span>
</span><span id=__span-44-75><a id=__codelineno-44-75 name=__codelineno-44-75 href=#__codelineno-44-75></a><span class=p>}</span>
</span></code></pre></div> <h4 id=361-helpergetcachekeys>3.6.1 helper.getCacheKeys<a class=headerlink href=#361-helpergetcachekeys title="Permanent link">&para;</a></h4> <p>我们一行行解析这里面的代码，先看看<code>helper.getCacheKeys()</code>是如何把我们绕晕后，成功的将String转换为GlideUrl的。</p> <p><strong>DecodeHelper.java</strong> <div class="language-java highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getCacheKeys</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a><span class=w> </span><span class=c1>// 这里使用了一个标志位，防止在DataCacheGenerator中重复加载</span>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isCacheKeysSet</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=w>   </span><span class=n>isCacheKeysSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=w>   </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=w>   </span><span class=c1>// 得到可以处理该请求的ModelLoader的LoadData list</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLoadData</span><span class=p>();</span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=w>   </span><span class=c1>// 将每一个loadData里的sourceKey以及每一个alternateKeys添加到cacheKeys中</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=w>   </span><span class=c1>// 在我们的三步例子中sourceKey为一个GlideUrl，alternateKeys为空</span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=w>     </span><span class=n>LoadData</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a><span class=w>       </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>);</span>
</span><span id=__span-45-14><a id=__codelineno-45-14 name=__codelineno-45-14 href=#__codelineno-45-14></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-45-15><a id=__codelineno-45-15 name=__codelineno-45-15 href=#__codelineno-45-15></a><span class=w>     </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-16><a id=__codelineno-45-16 name=__codelineno-45-16 href=#__codelineno-45-16></a><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>)))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-17><a id=__codelineno-45-17 name=__codelineno-45-17 href=#__codelineno-45-17></a><span class=w>         </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>));</span>
</span><span id=__span-45-18><a id=__codelineno-45-18 name=__codelineno-45-18 href=#__codelineno-45-18></a><span class=w>       </span><span class=p>}</span>
</span><span id=__span-45-19><a id=__codelineno-45-19 name=__codelineno-45-19 href=#__codelineno-45-19></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-45-20><a id=__codelineno-45-20 name=__codelineno-45-20 href=#__codelineno-45-20></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-45-21><a id=__codelineno-45-21 name=__codelineno-45-21 href=#__codelineno-45-21></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-45-22><a id=__codelineno-45-22 name=__codelineno-45-22 href=#__codelineno-45-22></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>;</span>
</span><span id=__span-45-23><a id=__codelineno-45-23 name=__codelineno-45-23 href=#__codelineno-45-23></a><span class=p>}</span>
</span><span id=__span-45-24><a id=__codelineno-45-24 name=__codelineno-45-24 href=#__codelineno-45-24></a>
</span><span id=__span-45-25><a id=__codelineno-45-25 name=__codelineno-45-25 href=#__codelineno-45-25></a><span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>getLoadData</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-26><a id=__codelineno-45-26 name=__codelineno-45-26 href=#__codelineno-45-26></a><span class=w> </span><span class=c1>// 这里也使用了一个标志位，防止在重复加载</span>
</span><span id=__span-45-27><a id=__codelineno-45-27 name=__codelineno-45-27 href=#__codelineno-45-27></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isLoadDataSet</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-28><a id=__codelineno-45-28 name=__codelineno-45-28 href=#__codelineno-45-28></a><span class=w>   </span><span class=n>isLoadDataSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-45-29><a id=__codelineno-45-29 name=__codelineno-45-29 href=#__codelineno-45-29></a><span class=w>   </span><span class=n>loadData</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-45-30><a id=__codelineno-45-30 name=__codelineno-45-30 href=#__codelineno-45-30></a><span class=w>   </span><span class=c1>// 获得了注册的3个ModelLoader</span>
</span><span id=__span-45-31><a id=__codelineno-45-31 name=__codelineno-45-31 href=#__codelineno-45-31></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-45-32><a id=__codelineno-45-32 name=__codelineno-45-32 href=#__codelineno-45-32></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-33><a id=__codelineno-45-33 name=__codelineno-45-33 href=#__codelineno-45-33></a><span class=w>     </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>modelLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-45-34><a id=__codelineno-45-34 name=__codelineno-45-34 href=#__codelineno-45-34></a><span class=w>     </span><span class=c1>// 对每个ModelLoader调用buildLoadData，看看其是否可以满足条件</span>
</span><span id=__span-45-35><a id=__codelineno-45-35 name=__codelineno-45-35 href=#__codelineno-45-35></a><span class=w>     </span><span class=c1>// 如果返回不为null，说明是可以处理的，那么添加进来</span>
</span><span id=__span-45-36><a id=__codelineno-45-36 name=__codelineno-45-36 href=#__codelineno-45-36></a><span class=w>     </span><span class=n>LoadData</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-45-37><a id=__codelineno-45-37 name=__codelineno-45-37 href=#__codelineno-45-37></a><span class=w>         </span><span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-45-38><a id=__codelineno-45-38 name=__codelineno-45-38 href=#__codelineno-45-38></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-45-39><a id=__codelineno-45-39 name=__codelineno-45-39 href=#__codelineno-45-39></a><span class=w>       </span><span class=n>loadData</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
</span><span id=__span-45-40><a id=__codelineno-45-40 name=__codelineno-45-40 href=#__codelineno-45-40></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-45-41><a id=__codelineno-45-41 name=__codelineno-45-41 href=#__codelineno-45-41></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-45-42><a id=__codelineno-45-42 name=__codelineno-45-42 href=#__codelineno-45-42></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-45-43><a id=__codelineno-45-43 name=__codelineno-45-43 href=#__codelineno-45-43></a><span class=w> </span><span class=c1>// 返回可以处理该请求的ModelLoader的LoadData列表</span>
</span><span id=__span-45-44><a id=__codelineno-45-44 name=__codelineno-45-44 href=#__codelineno-45-44></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>loadData</span><span class=p>;</span>
</span><span id=__span-45-45><a id=__codelineno-45-45 name=__codelineno-45-45 href=#__codelineno-45-45></a><span class=p>}</span>
</span></code></pre></div></p> <p>上面代码中比较麻烦的部分在<code>glideContext.getRegistry().getModelLoaders(model)</code>，在深入探索该方法的代码之前，我们还是先看看<code>Registry</code>类的相关代码吧。</p> <p><code>Registry</code>类中提供了很多用来拓展、替换默认组件的方法，根据组件功能的不同，会交给内部很多不同的Registry处理：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Registry</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ModelLoaderRegistry</span><span class=w> </span><span class=n>modelLoaderRegistry</span><span class=p>;</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>EncoderRegistry</span><span class=w> </span><span class=n>encoderRegistry</span><span class=p>;</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceDecoderRegistry</span><span class=w> </span><span class=n>decoderRegistry</span><span class=p>;</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceEncoderRegistry</span><span class=w> </span><span class=n>resourceEncoderRegistry</span><span class=p>;</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DataRewinderRegistry</span><span class=w> </span><span class=n>dataRewinderRegistry</span><span class=p>;</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>TranscoderRegistry</span><span class=w> </span><span class=n>transcoderRegistry</span><span class=p>;</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ImageHeaderParserRegistry</span><span class=w> </span><span class=n>imageHeaderParserRegistry</span><span class=p>;</span>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=p>}</span>
</span></code></pre></div> <p>拿马上要遇到的<code>modelLoaderRegistry</code>来说，相关的管理组件的三个方法为：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=nd>@NonNull</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>append</span><span class=p>(</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-47-4><a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-5><a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a><span class=w> </span><span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-47-6><a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-47-7><a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a><span class=p>}</span>
</span><span id=__span-47-8><a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a>
</span><span id=__span-47-9><a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a><span class=nd>@NonNull</span>
</span><span id=__span-47-10><a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>prepend</span><span class=p>(</span>
</span><span id=__span-47-11><a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-47-12><a id=__codelineno-47-12 name=__codelineno-47-12 href=#__codelineno-47-12></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-13><a id=__codelineno-47-13 name=__codelineno-47-13 href=#__codelineno-47-13></a><span class=w> </span><span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-47-14><a id=__codelineno-47-14 name=__codelineno-47-14 href=#__codelineno-47-14></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-47-15><a id=__codelineno-47-15 name=__codelineno-47-15 href=#__codelineno-47-15></a><span class=p>}</span>
</span><span id=__span-47-16><a id=__codelineno-47-16 name=__codelineno-47-16 href=#__codelineno-47-16></a>
</span><span id=__span-47-17><a id=__codelineno-47-17 name=__codelineno-47-17 href=#__codelineno-47-17></a><span class=nd>@NonNull</span>
</span><span id=__span-47-18><a id=__codelineno-47-18 name=__codelineno-47-18 href=#__codelineno-47-18></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>replace</span><span class=p>(</span>
</span><span id=__span-47-19><a id=__codelineno-47-19 name=__codelineno-47-19 href=#__codelineno-47-19></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span>
</span><span id=__span-47-20><a id=__codelineno-47-20 name=__codelineno-47-20 href=#__codelineno-47-20></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-47-21><a id=__codelineno-47-21 name=__codelineno-47-21 href=#__codelineno-47-21></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-47-22><a id=__codelineno-47-22 name=__codelineno-47-22 href=#__codelineno-47-22></a><span class=w> </span><span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-47-23><a id=__codelineno-47-23 name=__codelineno-47-23 href=#__codelineno-47-23></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-47-24><a id=__codelineno-47-24 name=__codelineno-47-24 href=#__codelineno-47-24></a><span class=p>}</span>
</span></code></pre></div> <p>上面这三个方法实际上又会交给<code>MultiModelLoaderFactory</code>来处理，这是一个代理模式：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>append</span><span class=p>(</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-5><a id=__codelineno-48-5 name=__codelineno-48-5 href=#__codelineno-48-5></a><span class=w> </span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-48-6><a id=__codelineno-48-6 name=__codelineno-48-6 href=#__codelineno-48-6></a><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-48-7><a id=__codelineno-48-7 name=__codelineno-48-7 href=#__codelineno-48-7></a><span class=p>}</span>
</span><span id=__span-48-8><a id=__codelineno-48-8 name=__codelineno-48-8 href=#__codelineno-48-8></a>
</span><span id=__span-48-9><a id=__codelineno-48-9 name=__codelineno-48-9 href=#__codelineno-48-9></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>prepend</span><span class=p>(</span>
</span><span id=__span-48-10><a id=__codelineno-48-10 name=__codelineno-48-10 href=#__codelineno-48-10></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span>
</span><span id=__span-48-11><a id=__codelineno-48-11 name=__codelineno-48-11 href=#__codelineno-48-11></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-48-12><a id=__codelineno-48-12 name=__codelineno-48-12 href=#__codelineno-48-12></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-13><a id=__codelineno-48-13 name=__codelineno-48-13 href=#__codelineno-48-13></a><span class=w> </span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>factory</span><span class=p>);</span>
</span><span id=__span-48-14><a id=__codelineno-48-14 name=__codelineno-48-14 href=#__codelineno-48-14></a><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-48-15><a id=__codelineno-48-15 name=__codelineno-48-15 href=#__codelineno-48-15></a><span class=p>}</span>
</span><span id=__span-48-16><a id=__codelineno-48-16 name=__codelineno-48-16 href=#__codelineno-48-16></a>
</span><span id=__span-48-17><a id=__codelineno-48-17 name=__codelineno-48-17 href=#__codelineno-48-17></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>remove</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span>
</span><span id=__span-48-18><a id=__codelineno-48-18 name=__codelineno-48-18 href=#__codelineno-48-18></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-48-19><a id=__codelineno-48-19 name=__codelineno-48-19 href=#__codelineno-48-19></a><span class=w> </span><span class=n>tearDown</span><span class=p>(</span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>));</span>
</span><span id=__span-48-20><a id=__codelineno-48-20 name=__codelineno-48-20 href=#__codelineno-48-20></a><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-48-21><a id=__codelineno-48-21 name=__codelineno-48-21 href=#__codelineno-48-21></a><span class=p>}</span>
</span></code></pre></div> <p><code>MultiModelLoaderFactory</code>中会使用一个<code>entries</code>的list来保存所有注入的内容。</p> <p>前面已经提到过，Glide在构造时会对<code>Registry</code>进行大量的操作。因为我们示例是load的<code>String</code>类型的Url，也就是说，<code>modelClass</code> 为 <code>String.class</code>，所以<code>Registry</code>中符合的注册项只有4个：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=c1>// model可能是一个base64格式的img，经过处理后可以变成InputStream类型(dataClass)的数据</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataUrlLoader</span><span class=p>.</span><span class=na>StreamFactory</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>())</span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=c1>// model可能是一个uri，这种情况下可能性非常多，因为网络图片、assets图片、磁盘图片等等都是一个uri</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringLoader</span><span class=p>.</span><span class=na>StreamFactory</span><span class=p>())</span>
</span><span id=__span-49-5><a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=c1>// model可能是一个本地图片、assets图片，所以可以处理成ParcelFileDescriptor.class类型的数据</span>
</span><span id=__span-49-6><a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringLoader</span><span class=p>.</span><span class=na>FileDescriptorFactory</span><span class=p>())</span>
</span><span id=__span-49-7><a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=c1>// model可能是一个本地图片，所以可以处理成为AssetFileDescriptor.class类型的数据</span>
</span><span id=__span-49-8><a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=p>.</span><span class=na>append</span><span class=p>(</span>
</span><span id=__span-49-9><a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a><span class=w>   </span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>AssetFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringLoader</span><span class=p>.</span><span class=na>AssetFileDescriptorFactory</span><span class=p>())</span>
</span></code></pre></div> <p>了解了这些之后，我们回过头看看<code>Registry.getModelLoaders</code>方法干了啥：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=c1>// Registry.java</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=nd>@NonNull</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>getModelLoaders</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Model</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-50-5><a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-50-6><a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a><span class=w>   </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoModelLoaderAvailableException</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-50-7><a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-50-8><a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-50-9><a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a><span class=p>}</span>
</span></code></pre></div> <p>这里只是调用了<code>modelLoaderRegistry.getModelLoaders(model)</code>，如果返回结果不为空则返回该结果，否则抛出异常。我们继续跟踪一下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=c1>// ModelLoaderRegistry.java</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=c1>// getModelLoaders方法会获取所有声明可以处理String类型的ModelLoader，并调用handles方法过滤掉肯定不能处理的</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=nd>@NonNull</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>getModelLoaders</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>A</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=w> </span><span class=c1>// 返回所有注册过的modelClass为String的ModelLoader，就是上面列出来的四个</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getModelLoadersForClass</span><span class=p>(</span><span class=n>getClass</span><span class=p>(</span><span class=n>model</span><span class=p>));</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isEmpty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>filteredLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=w>   </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>loader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=w>   </span><span class=c1>// 对于每个ModelLoader，看看是否可能处理这种类型的数据</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=w>   </span><span class=c1>// 此处会过滤第一个，因为我们传入的url不以data:image开头</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isEmpty</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a><span class=w>       </span><span class=n>filteredLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=w>       </span><span class=n>isEmpty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a><span class=w>     </span><span class=n>filteredLoaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>loader</span><span class=p>);</span>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>filteredLoaders</span><span class=p>;</span>
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23 href=#__codelineno-51-23></a><span class=p>}</span>
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24 href=#__codelineno-51-24></a>
</span><span id=__span-51-25><a id=__codelineno-51-25 name=__codelineno-51-25 href=#__codelineno-51-25></a><span class=c1>// 返回所有声明可以处理modelClass为String的ModelLoader</span>
</span><span id=__span-51-26><a id=__codelineno-51-26 name=__codelineno-51-26 href=#__codelineno-51-26></a><span class=nd>@NonNull</span>
</span><span id=__span-51-27><a id=__codelineno-51-27 name=__codelineno-51-27 href=#__codelineno-51-27></a><span class=kd>private</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>getModelLoadersForClass</span><span class=p>(</span>
</span><span id=__span-51-28><a id=__codelineno-51-28 name=__codelineno-51-28 href=#__codelineno-51-28></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-29><a id=__codelineno-51-29 name=__codelineno-51-29 href=#__codelineno-51-29></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>loaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
</span><span id=__span-51-30><a id=__codelineno-51-30 name=__codelineno-51-30 href=#__codelineno-51-30></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loaders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-51-31><a id=__codelineno-51-31 name=__codelineno-51-31 href=#__codelineno-51-31></a><span class=w>   </span><span class=n>loaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>modelClass</span><span class=p>));</span>
</span><span id=__span-51-32><a id=__codelineno-51-32 name=__codelineno-51-32 href=#__codelineno-51-32></a><span class=w>   </span><span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>loaders</span><span class=p>);</span>
</span><span id=__span-51-33><a id=__codelineno-51-33 name=__codelineno-51-33 href=#__codelineno-51-33></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-51-34><a id=__codelineno-51-34 name=__codelineno-51-34 href=#__codelineno-51-34></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>loaders</span><span class=p>;</span>
</span><span id=__span-51-35><a id=__codelineno-51-35 name=__codelineno-51-35 href=#__codelineno-51-35></a><span class=p>}</span>
</span></code></pre></div> <p>我们看看<code>multiModelLoaderFactory.build(modelClass)</code>是如何获取所有声明可以处理modelClass的ModelLoader的：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=nd>@NonNull</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>loaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=w>   </span><span class=c1>// 遍历所有注册进来的entry</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>entries</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=w>     </span><span class=c1>// Avoid stack overflow recursively creating model loaders by only creating loaders in</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a><span class=w>     </span><span class=c1>// recursive requests if they haven&#39;t been created earlier in the chain. For example:</span>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=w>     </span><span class=c1>// A Uri loader may translate to another model, which in turn may translate back to a Uri.</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=w>     </span><span class=c1>// The original Uri loader won&#39;t be provided to the intermediate model loader, although</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=w>     </span><span class=c1>// other Uri loaders will be.</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=w>       </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a><span class=w>     </span><span class=c1>// 注册过的entry有很多，但是entry.modelClass是modelClass（即String.class）的同类或父类的却只有四个</span>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-17><a id=__codelineno-52-17 name=__codelineno-52-17 href=#__codelineno-52-17></a><span class=w>       </span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
</span><span id=__span-52-18><a id=__codelineno-52-18 name=__codelineno-52-18 href=#__codelineno-52-18></a><span class=w>       </span><span class=c1>// 对每一个符合条件的entry调用build接口，获取对应的ModelLoader</span>
</span><span id=__span-52-19><a id=__codelineno-52-19 name=__codelineno-52-19 href=#__codelineno-52-19></a><span class=w>       </span><span class=n>loaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=o>&gt;</span><span class=n>build</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
</span><span id=__span-52-20><a id=__codelineno-52-20 name=__codelineno-52-20 href=#__codelineno-52-20></a><span class=w>       </span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
</span><span id=__span-52-21><a id=__codelineno-52-21 name=__codelineno-52-21 href=#__codelineno-52-21></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-52-22><a id=__codelineno-52-22 name=__codelineno-52-22 href=#__codelineno-52-22></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-52-23><a id=__codelineno-52-23 name=__codelineno-52-23 href=#__codelineno-52-23></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>loaders</span><span class=p>;</span>
</span><span id=__span-52-24><a id=__codelineno-52-24 name=__codelineno-52-24 href=#__codelineno-52-24></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-25><a id=__codelineno-52-25 name=__codelineno-52-25 href=#__codelineno-52-25></a><span class=w>   </span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-52-26><a id=__codelineno-52-26 name=__codelineno-52-26 href=#__codelineno-52-26></a><span class=w>   </span><span class=k>throw</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span><span id=__span-52-27><a id=__codelineno-52-27 name=__codelineno-52-27 href=#__codelineno-52-27></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-52-28><a id=__codelineno-52-28 name=__codelineno-52-28 href=#__codelineno-52-28></a><span class=p>}</span>
</span><span id=__span-52-29><a id=__codelineno-52-29 name=__codelineno-52-29 href=#__codelineno-52-29></a>
</span><span id=__span-52-30><a id=__codelineno-52-30 name=__codelineno-52-30 href=#__codelineno-52-30></a><span class=nd>@NonNull</span>
</span><span id=__span-52-31><a id=__codelineno-52-31 name=__codelineno-52-31 href=#__codelineno-52-31></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-52-32><a id=__codelineno-52-32 name=__codelineno-52-32 href=#__codelineno-52-32></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-52-33><a id=__codelineno-52-33 name=__codelineno-52-33 href=#__codelineno-52-33></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=k>this</span><span class=p>));</span>
</span><span id=__span-52-34><a id=__codelineno-52-34 name=__codelineno-52-34 href=#__codelineno-52-34></a><span class=p>}</span>
</span></code></pre></div> <p>这里的entry的数据结构以及保存的值我们在上面提到过，下面我们看看<code>entry.factory.build(this)</code>创建了四个什么样的ModelLoader：</p> <ul> <li><code>append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</code><br> 该Factory会创建一个处理data scheme(<code>data:[mediatype][;base64],encoded_data</code>, e.g. data:image/gif;base64,R0lGO...lBCBMQiB0UjIQA7)类型数据的<code>DataUrlLoader</code><br> <strong>声明可能处理以</strong><code>data:image</code><strong>开头的model</strong></li> <li><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> 该Factory能够从String中加载InputStream<br> <strong>声明可能处理所有类型的model</strong></li> <li><code>.append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> 该Factory能够从String中加载ParcelFileDescriptor<br> <strong>声明可能处理所有类型的model</strong></li> <li><code>.append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> 该Factory能够从String中加载AssetFileDescriptor <br> <strong>声明可能处理所有类型的model</strong></li> </ul> <p>此处的四个ModelLoader中，<code>DataUrlLoader.StreamFactory</code>的逻辑非常清晰明了，其他三个有点麻烦。因为它们都是创建的<code>StringLoader</code>，而<code>StringLoader</code>内部也有一个<code>MultiModelLoader</code>，在Factory中build <code>StringLoader</code>时，会调用<code>multiFactory.build</code>创建一个内部的<code>MultiModelLoader</code>。<br> 因为String可能指向的数据太多了，所以采取<code>MultiModelLoader</code>保存所有可能的<code>ModelLoader</code>，在处理时会遍历list找出所有可以处理的。</p> <p>我们看看<code>StringLoader.StreamFactory()</code>的build过程：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=cm>/**</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=cm> * Factory for loading {@link InputStream}s from Strings.</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=cm> */</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>StreamFactory</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=w> </span><span class=nd>@Override</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=o>&gt;</span><span class=w> </span><span class=nf>build</span><span class=p>(</span>
</span><span id=__span-53-9><a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>MultiModelLoaderFactory</span><span class=w> </span><span class=n>multiFactory</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-53-10><a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StringLoader</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>multiFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
</span><span id=__span-53-11><a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-53-12><a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a>
</span><span id=__span-53-13><a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=w> </span><span class=nd>@Override</span>
</span><span id=__span-53-14><a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>teardown</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-53-15><a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=w>   </span><span class=c1>// Do nothing.</span>
</span><span id=__span-53-16><a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-53-17><a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a><span class=p>}</span>
</span></code></pre></div> <p>这里调用了<code>MultiModelLoaderFactory.build(Class, Class)</code>方法，该方法的重载方法<code>MultiModelLoaderFactory.build(Class)</code>我们在上面遇到过，两个方法有一些差别，不要弄混淆了。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=nd>@NonNull</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=w> </span><span class=cm>/* Uri.class */</span><span class=p>,</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=w> </span><span class=cm>/* InputStream.class */</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>loaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=w>   </span><span class=kt>boolean</span><span class=w> </span><span class=n>ignoredAnyEntries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>entries</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=w>     </span><span class=c1>// Avoid stack overflow recursively creating model loaders by only creating loaders in</span>
</span><span id=__span-54-9><a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=w>     </span><span class=c1>// recursive requests if they haven&#39;t been created earlier in the chain. For example:</span>
</span><span id=__span-54-10><a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a><span class=w>     </span><span class=c1>// A Uri loader may translate to another model, which in turn may translate back to a Uri.</span>
</span><span id=__span-54-11><a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=w>     </span><span class=c1>// The original Uri loader won&#39;t be provided to the intermediate model loader, although</span>
</span><span id=__span-54-12><a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=w>     </span><span class=c1>// other Uri loaders will be.</span>
</span><span id=__span-54-13><a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=w>     </span><span class=c1>//</span>
</span><span id=__span-54-14><a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a><span class=w>     </span><span class=c1>// 防止递归时重复加载到，造成StackOverflow</span>
</span><span id=__span-54-15><a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-16><a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=w>       </span><span class=n>ignoredAnyEntries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-54-17><a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=w>       </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-54-18><a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-54-19><a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a><span class=w>     </span><span class=c1>// ⚡⚡️⚡️ 差别1，这里会检查两个class</span>
</span><span id=__span-54-20><a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-21><a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a><span class=w>       </span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
</span><span id=__span-54-22><a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a><span class=w>       </span><span class=n>loaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=n>build</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
</span><span id=__span-54-23><a id=__codelineno-54-23 name=__codelineno-54-23 href=#__codelineno-54-23></a><span class=w>       </span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
</span><span id=__span-54-24><a id=__codelineno-54-24 name=__codelineno-54-24 href=#__codelineno-54-24></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-54-25><a id=__codelineno-54-25 name=__codelineno-54-25 href=#__codelineno-54-25></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-54-26><a id=__codelineno-54-26 name=__codelineno-54-26 href=#__codelineno-54-26></a><span class=w>   </span><span class=c1>// ⚡⚡️⚡️ 差别2，这里会检查loaders的数量，并做相应的处理</span>
</span><span id=__span-54-27><a id=__codelineno-54-27 name=__codelineno-54-27 href=#__codelineno-54-27></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loaders</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-28><a id=__codelineno-54-28 name=__codelineno-54-28 href=#__codelineno-54-28></a><span class=w>     </span><span class=k>return</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>loaders</span><span class=p>,</span><span class=w> </span><span class=n>throwableListPool</span><span class=p>);</span>
</span><span id=__span-54-29><a id=__codelineno-54-29 name=__codelineno-54-29 href=#__codelineno-54-29></a><span class=w>   </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loaders</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-30><a id=__codelineno-54-30 name=__codelineno-54-30 href=#__codelineno-54-30></a><span class=w>     </span><span class=k>return</span><span class=w> </span><span class=n>loaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span><span id=__span-54-31><a id=__codelineno-54-31 name=__codelineno-54-31 href=#__codelineno-54-31></a><span class=w>   </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-32><a id=__codelineno-54-32 name=__codelineno-54-32 href=#__codelineno-54-32></a><span class=w>     </span><span class=c1>// Avoid crashing if recursion results in no loaders available. The assertion is supposed to</span>
</span><span id=__span-54-33><a id=__codelineno-54-33 name=__codelineno-54-33 href=#__codelineno-54-33></a><span class=w>     </span><span class=c1>// catch completely unhandled types, recursion may mean a subtype isn&#39;t handled somewhere</span>
</span><span id=__span-54-34><a id=__codelineno-54-34 name=__codelineno-54-34 href=#__codelineno-54-34></a><span class=w>     </span><span class=c1>// down the stack, which is often ok.</span>
</span><span id=__span-54-35><a id=__codelineno-54-35 name=__codelineno-54-35 href=#__codelineno-54-35></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ignoredAnyEntries</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-36><a id=__codelineno-54-36 name=__codelineno-54-36 href=#__codelineno-54-36></a><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=n>emptyModelLoader</span><span class=p>();</span>
</span><span id=__span-54-37><a id=__codelineno-54-37 name=__codelineno-54-37 href=#__codelineno-54-37></a><span class=w>     </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-38><a id=__codelineno-54-38 name=__codelineno-54-38 href=#__codelineno-54-38></a><span class=w>       </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>NoModelLoaderAvailableException</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>);</span>
</span><span id=__span-54-39><a id=__codelineno-54-39 name=__codelineno-54-39 href=#__codelineno-54-39></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-54-40><a id=__codelineno-54-40 name=__codelineno-54-40 href=#__codelineno-54-40></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-54-41><a id=__codelineno-54-41 name=__codelineno-54-41 href=#__codelineno-54-41></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-54-42><a id=__codelineno-54-42 name=__codelineno-54-42 href=#__codelineno-54-42></a><span class=w>   </span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-54-43><a id=__codelineno-54-43 name=__codelineno-54-43 href=#__codelineno-54-43></a><span class=w>   </span><span class=k>throw</span><span class=w> </span><span class=n>t</span><span class=p>;</span>
</span><span id=__span-54-44><a id=__codelineno-54-44 name=__codelineno-54-44 href=#__codelineno-54-44></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-54-45><a id=__codelineno-54-45 name=__codelineno-54-45 href=#__codelineno-54-45></a><span class=p>}</span>
</span></code></pre></div> <p>我们看一下四个注册项调用<code>this.&lt;Model, Data&gt;build(entry)</code>后返回的值：</p> <p><code>append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</code> </p> <ul> <li>build &rarr; <code>DataUrlLoader</code></li> </ul> <p><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code> </p> <ul> <li>build &rarr; <code>StringLoader</code> 参数urlLoader = <code>multiFactory.build(Uri.class, InputStream.class)</code><br> 将String当作Uri来处理，下面开始在注册表中找所有modelClass为Uri.class，dataClass为InputStream.class的注册项 <ul> <li><code>append(Uri.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;Uri&gt;())</code> <ul> <li>build &rarr; <code>DataUrlLoader</code></li> </ul> </li> <li><code>append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</code> <ul> <li>build &rarr; <code>HttpUriLoader</code> 参数urlLoader = <code>multiFactory.build(GlideUrl.class, InputStream.class)</code><br> Uri可能是一个GlideUrl，下面开始在注册表中找所有modelClass为GlideUrl.class，dataClass为InputStream.class的注册项<ul> <li><code>.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</code> <ul> <li>build &rarr; <code>HttpGlideUrlLoader</code></li> </ul> </li> </ul> </li> </ul> </li> <li><code>append(Uri.class, InputStream.class, new AssetUriLoader.StreamFactory(context.getAssets()))</code> <ul> <li>build &rarr; <code>AssetUriLoader</code></li> </ul> </li> <li><code>append(Uri.class, InputStream.class, new MediaStoreImageThumbLoader.Factory(context))</code> <ul> <li>build &rarr; <code>MediaStoreImageThumbLoader</code></li> </ul> </li> <li><code>append(Uri.class, InputStream.class, new MediaStoreVideoThumbLoader.Factory(context))</code> <ul> <li>build &rarr; <code>MediaStoreVideoThumbLoader</code></li> </ul> </li> <li><code>append(Uri.class, InputStream.class, new UriLoader.StreamFactory(contentResolver))</code> <ul> <li>build &rarr; <code>UriLoader</code></li> </ul> </li> <li><code>append(Uri.class, InputStream.class, new UrlUriLoader.StreamFactory())</code> <ul> <li>build &rarr; <code>UrlUriLoader</code> 参数urlLoader = <code>multiFactory.build(GlideUrl.class, InputStream.class)</code><br> Uri可能是一个GlideUrl，下面开始在注册表中找所有modelClass为GlideUrl.class，dataClass为InputStream.class的注册项<ul> <li><code>.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</code> <ul> <li>build &rarr; <code>HttpGlideUrlLoader</code></li> </ul> </li> </ul> </li> </ul> </li> <li><code>MultiModelLoader</code></li> </ul> </li> </ul> <p><code>append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code> </p> <ul> <li>build &rarr; <code>StringLoader</code> 参数urlLoader = <code>multiFactory.build(Uri.class, ParcelFileDescriptor.class)</code><br> 将String当作Uri来处理，下面开始在注册表中找所有modelClass为Uri.class，dataClass为ParcelFileDescriptor.class的注册项 <ul> <li><code>append(Uri.class, ParcelFileDescriptor.class, new AssetUriLoader.FileDescriptorFactory(context.getAssets()))</code> <ul> <li>build &rarr; <code>AssetUriLoader</code></li> </ul> </li> <li><code>append(Uri.class, ParcelFileDescriptor.class, new UriLoader.FileDescriptorFactory(contentResolver))</code> <ul> <li>build &rarr; <code>UriLoader</code></li> </ul> </li> <li><code>MultiModelLoader</code></li> </ul> </li> </ul> <p><code>append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code> </p> <ul> <li>build &rarr; <code>StringLoader</code> 参数urlLoader = <code>multiFactory.build(Uri.class, AssetFileDescriptor.class)</code><br> 将String当作Uri来处理，下面开始在注册表中找所有modelClass为Uri.class，dataClass为AssetFileDescriptor.class的注册项 <ul> <li><code>append(Uri.class, AssetFileDescriptor.class, new UriLoader.AssetFileDescriptorFactory(contentResolver))</code> <ul> <li>build &rarr; <code>UriLoader</code></li> </ul> </li> </ul> </li> <li><code>UriLoader</code></li> </ul> <p>上面就是<code>this.&lt;Model, Data&gt;build(entry)</code>获得到的4个loader，然后在<code>modelLoaderRegistry.getModelLoaders(model)</code>方法中被过滤掉第一个，现在就返回3.6.1节刚开始的<code>DecodeHelper.getLoadData</code>方法里面了。</p> <p>在<code>DecodeHelper.getLoadData</code>方法中会遍历每个ModelLoader，并调用其<code>buildLoadData</code>方法，如果不为空则加入到数组中。由于此处的3个ModelLoader都是<code>StringLoader</code>，我们看看<code>StringLoader.buildLoadData</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=nd>@Override</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=kd>public</span><span class=w> </span><span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=nf>buildLoadData</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=w> </span><span class=c1>// 由于我们传入的model是一个网络图片地址，所以uri肯定是正常的</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parseUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=w> </span><span class=c1>// 下面判断uriLoader是否有可能处理</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a><span class=w> </span><span class=c1>// 如果没有可能，那么返回null</span>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>uri</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>uriLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>uri</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a><span class=w> </span><span class=c1>// 否则调用uriLoader的buildLoadData方法</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>uriLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a><span class=p>}</span>
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a>
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a><span class=nd>@Nullable</span>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=nf>parseUri</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-17><a id=__codelineno-55-17 name=__codelineno-55-17 href=#__codelineno-55-17></a><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=n>uri</span><span class=p>;</span>
</span><span id=__span-55-18><a id=__codelineno-55-18 name=__codelineno-55-18 href=#__codelineno-55-18></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>model</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-19><a id=__codelineno-55-19 name=__codelineno-55-19 href=#__codelineno-55-19></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-55-20><a id=__codelineno-55-20 name=__codelineno-55-20 href=#__codelineno-55-20></a><span class=w> </span><span class=c1>// See https://pmd.github.io/pmd-6.0.0/pmd_rules_java_performance.html#simplifystartswith</span>
</span><span id=__span-55-21><a id=__codelineno-55-21 name=__codelineno-55-21 href=#__codelineno-55-21></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=sc>&#39;/&#39;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-22><a id=__codelineno-55-22 name=__codelineno-55-22 href=#__codelineno-55-22></a><span class=w>   </span><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>toFileUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-55-23><a id=__codelineno-55-23 name=__codelineno-55-23 href=#__codelineno-55-23></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-24><a id=__codelineno-55-24 name=__codelineno-55-24 href=#__codelineno-55-24></a><span class=w>   </span><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Uri</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-55-25><a id=__codelineno-55-25 name=__codelineno-55-25 href=#__codelineno-55-25></a><span class=w>   </span><span class=n>String</span><span class=w> </span><span class=n>scheme</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>uri</span><span class=p>.</span><span class=na>getScheme</span><span class=p>();</span>
</span><span id=__span-55-26><a id=__codelineno-55-26 name=__codelineno-55-26 href=#__codelineno-55-26></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>scheme</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-27><a id=__codelineno-55-27 name=__codelineno-55-27 href=#__codelineno-55-27></a><span class=w>     </span><span class=n>uri</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>toFileUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
</span><span id=__span-55-28><a id=__codelineno-55-28 name=__codelineno-55-28 href=#__codelineno-55-28></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-55-29><a id=__codelineno-55-29 name=__codelineno-55-29 href=#__codelineno-55-29></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-55-30><a id=__codelineno-55-30 name=__codelineno-55-30 href=#__codelineno-55-30></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>uri</span><span class=p>;</span>
</span><span id=__span-55-31><a id=__codelineno-55-31 name=__codelineno-55-31 href=#__codelineno-55-31></a><span class=p>}</span>
</span><span id=__span-55-32><a id=__codelineno-55-32 name=__codelineno-55-32 href=#__codelineno-55-32></a>
</span><span id=__span-55-33><a id=__codelineno-55-33 name=__codelineno-55-33 href=#__codelineno-55-33></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Uri</span><span class=w> </span><span class=nf>toFileUri</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-55-34><a id=__codelineno-55-34 name=__codelineno-55-34 href=#__codelineno-55-34></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>Uri</span><span class=p>.</span><span class=na>fromFile</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>path</span><span class=p>));</span>
</span><span id=__span-55-35><a id=__codelineno-55-35 name=__codelineno-55-35 href=#__codelineno-55-35></a><span class=p>}</span>
</span></code></pre></div> <p>所以重点就在于<code>StringLoader.uriLoader</code>了，该参数我们上面分析递归过程的时候分析到了，是一个<code>MultiModelLoader</code>对象：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=kd>class</span> <span class=nc>MultiModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>;</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>exceptionListPool</span><span class=p>;</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=w> </span><span class=n>MultiModelLoader</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>,</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Pool</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>exceptionListPool</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>;</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>exceptionListPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>exceptionListPool</span><span class=p>;</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=w> </span><span class=nd>@Override</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=nf>buildLoadData</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Model</span><span class=w> </span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=w>   </span><span class=n>Key</span><span class=w> </span><span class=n>sourceKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=w>   </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>fetchers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a><span class=w>   </span><span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
</span><span id=__span-56-19><a id=__codelineno-56-19 name=__codelineno-56-19 href=#__codelineno-56-19></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-20><a id=__codelineno-56-20 name=__codelineno-56-20 href=#__codelineno-56-20></a><span class=w>     </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-56-21><a id=__codelineno-56-21 name=__codelineno-56-21 href=#__codelineno-56-21></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>modelLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-22><a id=__codelineno-56-22 name=__codelineno-56-22 href=#__codelineno-56-22></a><span class=w>       </span><span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-56-23><a id=__codelineno-56-23 name=__codelineno-56-23 href=#__codelineno-56-23></a><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadData</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-24><a id=__codelineno-56-24 name=__codelineno-56-24 href=#__codelineno-56-24></a><span class=w>         </span><span class=n>sourceKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>;</span>
</span><span id=__span-56-25><a id=__codelineno-56-25 name=__codelineno-56-25 href=#__codelineno-56-25></a><span class=w>         </span><span class=n>fetchers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>);</span>
</span><span id=__span-56-26><a id=__codelineno-56-26 name=__codelineno-56-26 href=#__codelineno-56-26></a><span class=w>       </span><span class=p>}</span>
</span><span id=__span-56-27><a id=__codelineno-56-27 name=__codelineno-56-27 href=#__codelineno-56-27></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-56-28><a id=__codelineno-56-28 name=__codelineno-56-28 href=#__codelineno-56-28></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-56-29><a id=__codelineno-56-29 name=__codelineno-56-29 href=#__codelineno-56-29></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>fetchers</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceKey</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-56-30><a id=__codelineno-56-30 name=__codelineno-56-30 href=#__codelineno-56-30></a><span class=w>       </span><span class=o>?</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoadData</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MultiFetcher</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>fetchers</span><span class=p>,</span><span class=w> </span><span class=n>exceptionListPool</span><span class=p>))</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-56-31><a id=__codelineno-56-31 name=__codelineno-56-31 href=#__codelineno-56-31></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-56-32><a id=__codelineno-56-32 name=__codelineno-56-32 href=#__codelineno-56-32></a>
</span><span id=__span-56-33><a id=__codelineno-56-33 name=__codelineno-56-33 href=#__codelineno-56-33></a><span class=w> </span><span class=nd>@Override</span>
</span><span id=__span-56-34><a id=__codelineno-56-34 name=__codelineno-56-34 href=#__codelineno-56-34></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Model</span><span class=w> </span><span class=n>model</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-35><a id=__codelineno-56-35 name=__codelineno-56-35 href=#__codelineno-56-35></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelLoader</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-36><a id=__codelineno-56-36 name=__codelineno-56-36 href=#__codelineno-56-36></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>modelLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-56-37><a id=__codelineno-56-37 name=__codelineno-56-37 href=#__codelineno-56-37></a><span class=w>       </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-56-38><a id=__codelineno-56-38 name=__codelineno-56-38 href=#__codelineno-56-38></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-56-39><a id=__codelineno-56-39 name=__codelineno-56-39 href=#__codelineno-56-39></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-56-40><a id=__codelineno-56-40 name=__codelineno-56-40 href=#__codelineno-56-40></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-56-41><a id=__codelineno-56-41 name=__codelineno-56-41 href=#__codelineno-56-41></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-56-42><a id=__codelineno-56-42 name=__codelineno-56-42 href=#__codelineno-56-42></a><span class=p>}</span>
</span></code></pre></div> <p><code>MultiModelLoader</code>类的<code>handles</code>方法和<code>buildLoadData</code>方法都比较清晰明了。 </p> <ul> <li><code>handles</code>方法是只要内部有一个ModelLoader有可能处理，就返回true。 </li> <li><code>buildLoadData</code>方法会先调用<code>hanldes</code>进行第一次筛选，然后在调用ModelLoader的<code>buildLoadData</code>方法，如果不为空则保存起来，最后返回<code>LoadData&lt;&gt;(sourceKey, new MultiFetcher&lt;&gt;(fetchers, exceptionListPool))</code>对象。</li> </ul> <p>我们还是走一下<code>DecodeHelper.getLoadData</code>方法中的流程，遍历一下调用三个<code>StringLoader</code>的<code>buildLoadData</code>方法：</p> <p><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code> </p> <ul> <li>build &rarr; <code>StringLoader</code> 参数urlLoader = <code>MultiModelLoader</code><ul> <li><code>DataUrlLoader</code> 处理data:image资源<br> 1 <em>handles</em>: <strong>false</strong><br> 3 <em>buildLoadData</em>: 跳过 因为*handles* return <strong>false</strong></li> <li><code>HttpUriLoader</code> 处理http、https资源 参数urlLoader = <code>HttpGlideUrlLoader</code><br> 2 <em>handles</em>: <strong>true</strong><br> 4 <em>buildLoadData</em>: <code>HttpGlideUrlLoader.buildLoadData(GlideUrl)</code> &rarr; <code>LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout))</code> ---&gt; <code>fetchers.add(loadData.fetcher)</code></li> <li><code>AssetUriLoader</code> 处理file:///android_asset/资源<br> 5 <em>buildLoadData</em>: 跳过 因为*handles* return <strong>false</strong></li> <li><code>MediaStoreImageThumbLoader</code> 处理content://media/且path segments中不包含video字符串的资源<br> 6 <em>buildLoadData</em>: 跳过 因为*handles* return <strong>false</strong></li> <li><code>MediaStoreVideoThumbLoader</code> 处理content://media/且path segments中包含video字符串的资源<br> 7 <em>buildLoadData</em>: 跳过 因为*handles* return <strong>false</strong></li> <li><code>UriLoader</code> 处理scheme为file、android.resource、content的资源<br> 8 <em>buildLoadData</em>: 跳过 因为*handles* return <strong>false</strong></li> <li><code>UrlUriLoader</code> 处理http、https资源 参数urlLoader = <code>HttpGlideUrlLoader</code><br> 9 <em>buildLoadData</em>: <code>HttpGlideUrlLoader.buildLoadData(GlideUrl)</code> ---&gt; <code>LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout))</code> ---&gt; <code>fetchers.add(loadData.fetcher)</code></li> </ul> </li> <li>得到 <code>LoadData&lt;&gt;(sourceKey, new MultiFetcher&lt;&gt;(fetchers, exceptionListPool))</code></li> </ul> <p><code>append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code> </p> <ul> <li>build &rarr; <code>StringLoader</code> 参数urlLoader = <code>MultiModelLoader</code><ul> <li><code>AssetUriLoader</code> 处理file:///android_asset/资源<br> 1 <em>handles</em>: <strong>false</strong> </li> <li><code>UriLoader</code> 处理scheme为file、android.resource、content的资源<br> 2 <em>handles</em>: <strong>false</strong> </li> </ul> </li> <li>得到 <code>null</code></li> </ul> <p><code>append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code> </p> <ul> <li>build &rarr; <code>StringLoader</code> 参数urlLoader =<ul> <li><code>UriLoader</code> 处理scheme为file、android.resource、content的资源<br> 1 <em>handles</em>: <strong>false</strong> </li> </ul> </li> <li>得到 <code>null</code></li> </ul> <p>由于<code>DecodeHelper.getLoadData</code>只添加不为null的<code>LoadData</code>，所以只返回了一个<code>StringLoader.StreamFactory()</code>生成的<code>LoadData</code>。 </p> <p>返回到上一个方法<code>DecodeHelper.getCacheKeys</code>中：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getCacheKeys</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isCacheKeysSet</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=w>   </span><span class=n>isCacheKeysSet</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=w>   </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getLoadData</span><span class=p>();</span>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=w>   </span><span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a><span class=w>     </span><span class=n>LoadData</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a><span class=w>       </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>);</span>
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a><span class=w>     </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=n>j</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>j</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a><span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>)))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-57-14><a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a><span class=w>         </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>));</span>
</span><span id=__span-57-15><a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a><span class=w>       </span><span class=p>}</span>
</span><span id=__span-57-16><a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-57-17><a id=__codelineno-57-17 name=__codelineno-57-17 href=#__codelineno-57-17></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-57-18><a id=__codelineno-57-18 name=__codelineno-57-18 href=#__codelineno-57-18></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-57-19><a id=__codelineno-57-19 name=__codelineno-57-19 href=#__codelineno-57-19></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>;</span>
</span><span id=__span-57-20><a id=__codelineno-57-20 name=__codelineno-57-20 href=#__codelineno-57-20></a><span class=p>}</span>
</span></code></pre></div> <p>很显然，返回的list中只有一个key：上面的<code>LoadData</code>的<code>sourceKey</code>，即<code>GlideUrl</code>。</p> <h4 id=362-dhgetregisteredresourceclasses>3.6.2 DH.getRegisteredResourceClasses<a class=headerlink href=#362-dhgetregisteredresourceclasses title="Permanent link">&para;</a></h4> <p>接着返回到上一个方法，也就是本小节的第一个方法<code>ResourceCacheGenerator.startNext</code>中。<br> 接下来要执行的代码是：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=c1>// ResourceCacheGenerator.startNext</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>resourceClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>();</span>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a><span class=c1>// DecodeHelper</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>getRegisteredResourceClasses</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>()</span>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a><span class=w>     </span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a><span class=p>}</span>
</span></code></pre></div> <p>这里又回到了<code>Registry</code>类中，头疼。但还是要分析。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=nd>@NonNull</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>getRegisteredResourceClasses</span><span class=p>(</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span><span class=w> </span><span class=n>modelClass</span><span class=p>,</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=w> </span><span class=c1>// modelClass = String.class</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a><span class=w> </span><span class=c1>// resourceClass 默认为 Object.class</span>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=w> </span><span class=c1>// transcodeClass = Drawable.class</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a><span class=w> </span><span class=c1>//</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=w> </span><span class=c1>// 首先取缓存</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=w>     </span><span class=n>modelToResourceClassCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a><span class=w> </span><span class=c1>// 有缓存就返回缓存，没有就加载，然后放入缓存</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a><span class=w>   </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-59-17><a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a><span class=w>   </span><span class=c1>// 从modelLoaderRegistry中寻找所有modelClass为String或父类的entry，并返回其dataClass</span>
</span><span id=__span-59-18><a id=__codelineno-59-18 name=__codelineno-59-18 href=#__codelineno-59-18></a><span class=w>   </span><span class=c1>// 此处得到的dataClasses为[InputStream.class, ParcelFileDescriptor.class, AssetFileDescriptor.class]  </span>
</span><span id=__span-59-19><a id=__codelineno-59-19 name=__codelineno-59-19 href=#__codelineno-59-19></a><span class=w>   </span><span class=c1>// 因为四个注册项中，前两个dataClass都为InputStream.class，去重时肯定会去掉一个</span>
</span><span id=__span-59-20><a id=__codelineno-59-20 name=__codelineno-59-20 href=#__codelineno-59-20></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>dataClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>getDataClasses</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
</span><span id=__span-59-21><a id=__codelineno-59-21 name=__codelineno-59-21 href=#__codelineno-59-21></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>dataClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-59-22><a id=__codelineno-59-22 name=__codelineno-59-22 href=#__codelineno-59-22></a><span class=w>       </span><span class=c1>// 🔥🔥🔥 看不懂了，先看看对应的ResourceDecoderRegistry数据结构吧</span>
</span><span id=__span-59-23><a id=__codelineno-59-23 name=__codelineno-59-23 href=#__codelineno-59-23></a><span class=w>       </span><span class=n>List</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>registeredResourceClasses</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-59-24><a id=__codelineno-59-24 name=__codelineno-59-24 href=#__codelineno-59-24></a><span class=w>           </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-59-25><a id=__codelineno-59-25 name=__codelineno-59-25 href=#__codelineno-59-25></a><span class=w>       </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>registeredResourceClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>registeredResourceClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-59-26><a id=__codelineno-59-26 name=__codelineno-59-26 href=#__codelineno-59-26></a><span class=w>         </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>registeredTranscodeClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transcoderRegistry</span>
</span><span id=__span-59-27><a id=__codelineno-59-27 name=__codelineno-59-27 href=#__codelineno-59-27></a><span class=w>             </span><span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-59-28><a id=__codelineno-59-28 name=__codelineno-59-28 href=#__codelineno-59-28></a><span class=w>         </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>registeredTranscodeClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-59-29><a id=__codelineno-59-29 name=__codelineno-59-29 href=#__codelineno-59-29></a><span class=w>           </span><span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>);</span>
</span><span id=__span-59-30><a id=__codelineno-59-30 name=__codelineno-59-30 href=#__codelineno-59-30></a><span class=w>         </span><span class=p>}</span>
</span><span id=__span-59-31><a id=__codelineno-59-31 name=__codelineno-59-31 href=#__codelineno-59-31></a><span class=w>       </span><span class=p>}</span>
</span><span id=__span-59-32><a id=__codelineno-59-32 name=__codelineno-59-32 href=#__codelineno-59-32></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-59-33><a id=__codelineno-59-33 name=__codelineno-59-33 href=#__codelineno-59-33></a><span class=w>   </span><span class=n>modelToResourceClassCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span>
</span><span id=__span-59-34><a id=__codelineno-59-34 name=__codelineno-59-34 href=#__codelineno-59-34></a><span class=w>       </span><span class=n>modelClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span><span class=w> </span><span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>result</span><span class=p>));</span>
</span><span id=__span-59-35><a id=__codelineno-59-35 name=__codelineno-59-35 href=#__codelineno-59-35></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-59-36><a id=__codelineno-59-36 name=__codelineno-59-36 href=#__codelineno-59-36></a>
</span><span id=__span-59-37><a id=__codelineno-59-37 name=__codelineno-59-37 href=#__codelineno-59-37></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-59-38><a id=__codelineno-59-38 name=__codelineno-59-38 href=#__codelineno-59-38></a><span class=p>}</span>
</span></code></pre></div> <p>🔥🔥🔥 获取完dataClasses后，下面要对每一个dataClass调用<code>decoderRegistry.getResourceClasses</code>方法。 </p> <p>这里涉及到了<code>ResourceDecoderRegistry</code>类，同样该类中的数据也是Glide创建时注入的，我们看一下相关的代码。</p> <div class="language-java highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-60-1>  1</a></span>
<span class=normal><a href=#__codelineno-60-2>  2</a></span>
<span class=normal><a href=#__codelineno-60-3>  3</a></span>
<span class=normal><a href=#__codelineno-60-4>  4</a></span>
<span class=normal><a href=#__codelineno-60-5>  5</a></span>
<span class=normal><a href=#__codelineno-60-6>  6</a></span>
<span class=normal><a href=#__codelineno-60-7>  7</a></span>
<span class=normal><a href=#__codelineno-60-8>  8</a></span>
<span class=normal><a href=#__codelineno-60-9>  9</a></span>
<span class=normal><a href=#__codelineno-60-10> 10</a></span>
<span class=normal><a href=#__codelineno-60-11> 11</a></span>
<span class=normal><a href=#__codelineno-60-12> 12</a></span>
<span class=normal><a href=#__codelineno-60-13> 13</a></span>
<span class=normal><a href=#__codelineno-60-14> 14</a></span>
<span class=normal><a href=#__codelineno-60-15> 15</a></span>
<span class=normal><a href=#__codelineno-60-16> 16</a></span>
<span class=normal><a href=#__codelineno-60-17> 17</a></span>
<span class=normal><a href=#__codelineno-60-18> 18</a></span>
<span class=normal><a href=#__codelineno-60-19> 19</a></span>
<span class=normal><a href=#__codelineno-60-20> 20</a></span>
<span class=normal><a href=#__codelineno-60-21> 21</a></span>
<span class=normal><a href=#__codelineno-60-22> 22</a></span>
<span class=normal><a href=#__codelineno-60-23> 23</a></span>
<span class=normal><a href=#__codelineno-60-24> 24</a></span>
<span class=normal><a href=#__codelineno-60-25> 25</a></span>
<span class=normal><a href=#__codelineno-60-26> 26</a></span>
<span class=normal><a href=#__codelineno-60-27> 27</a></span>
<span class=normal><a href=#__codelineno-60-28> 28</a></span>
<span class=normal><a href=#__codelineno-60-29> 29</a></span>
<span class=normal><a href=#__codelineno-60-30> 30</a></span>
<span class=normal><a href=#__codelineno-60-31> 31</a></span>
<span class=normal><a href=#__codelineno-60-32> 32</a></span>
<span class=normal><a href=#__codelineno-60-33> 33</a></span>
<span class=normal><a href=#__codelineno-60-34> 34</a></span>
<span class=normal><a href=#__codelineno-60-35> 35</a></span>
<span class=normal><a href=#__codelineno-60-36> 36</a></span>
<span class=normal><a href=#__codelineno-60-37> 37</a></span>
<span class=normal><a href=#__codelineno-60-38> 38</a></span>
<span class=normal><a href=#__codelineno-60-39> 39</a></span>
<span class=normal><a href=#__codelineno-60-40> 40</a></span>
<span class=normal><a href=#__codelineno-60-41> 41</a></span>
<span class=normal><a href=#__codelineno-60-42> 42</a></span>
<span class=normal><a href=#__codelineno-60-43> 43</a></span>
<span class=normal><a href=#__codelineno-60-44> 44</a></span>
<span class=normal><a href=#__codelineno-60-45> 45</a></span>
<span class=normal><a href=#__codelineno-60-46> 46</a></span>
<span class=normal><a href=#__codelineno-60-47> 47</a></span>
<span class=normal><a href=#__codelineno-60-48> 48</a></span>
<span class=normal><a href=#__codelineno-60-49> 49</a></span>
<span class=normal><a href=#__codelineno-60-50> 50</a></span>
<span class=normal><a href=#__codelineno-60-51> 51</a></span>
<span class=normal><a href=#__codelineno-60-52> 52</a></span>
<span class=normal><a href=#__codelineno-60-53> 53</a></span>
<span class=normal><a href=#__codelineno-60-54> 54</a></span>
<span class=normal><a href=#__codelineno-60-55> 55</a></span>
<span class=normal><a href=#__codelineno-60-56> 56</a></span>
<span class=normal><a href=#__codelineno-60-57> 57</a></span>
<span class=normal><a href=#__codelineno-60-58> 58</a></span>
<span class=normal><a href=#__codelineno-60-59> 59</a></span>
<span class=normal><a href=#__codelineno-60-60> 60</a></span>
<span class=normal><a href=#__codelineno-60-61> 61</a></span>
<span class=normal><a href=#__codelineno-60-62> 62</a></span>
<span class=normal><a href=#__codelineno-60-63> 63</a></span>
<span class=normal><a href=#__codelineno-60-64> 64</a></span>
<span class=normal><a href=#__codelineno-60-65> 65</a></span>
<span class=normal><a href=#__codelineno-60-66> 66</a></span>
<span class=normal><a href=#__codelineno-60-67> 67</a></span>
<span class=normal><a href=#__codelineno-60-68> 68</a></span>
<span class=normal><a href=#__codelineno-60-69> 69</a></span>
<span class=normal><a href=#__codelineno-60-70> 70</a></span>
<span class=normal><a href=#__codelineno-60-71> 71</a></span>
<span class=normal><a href=#__codelineno-60-72> 72</a></span>
<span class=normal><a href=#__codelineno-60-73> 73</a></span>
<span class=normal><a href=#__codelineno-60-74> 74</a></span>
<span class=normal><a href=#__codelineno-60-75> 75</a></span>
<span class=normal><a href=#__codelineno-60-76> 76</a></span>
<span class=normal><a href=#__codelineno-60-77> 77</a></span>
<span class=normal><a href=#__codelineno-60-78> 78</a></span>
<span class=normal><a href=#__codelineno-60-79> 79</a></span>
<span class=normal><a href=#__codelineno-60-80> 80</a></span>
<span class=normal><a href=#__codelineno-60-81> 81</a></span>
<span class=normal><a href=#__codelineno-60-82> 82</a></span>
<span class=normal><a href=#__codelineno-60-83> 83</a></span>
<span class=normal><a href=#__codelineno-60-84> 84</a></span>
<span class=normal><a href=#__codelineno-60-85> 85</a></span>
<span class=normal><a href=#__codelineno-60-86> 86</a></span>
<span class=normal><a href=#__codelineno-60-87> 87</a></span>
<span class=normal><a href=#__codelineno-60-88> 88</a></span>
<span class=normal><a href=#__codelineno-60-89> 89</a></span>
<span class=normal><a href=#__codelineno-60-90> 90</a></span>
<span class=normal><a href=#__codelineno-60-91> 91</a></span>
<span class=normal><a href=#__codelineno-60-92> 92</a></span>
<span class=normal><a href=#__codelineno-60-93> 93</a></span>
<span class=normal><a href=#__codelineno-60-94> 94</a></span>
<span class=normal><a href=#__codelineno-60-95> 95</a></span>
<span class=normal><a href=#__codelineno-60-96> 96</a></span>
<span class=normal><a href=#__codelineno-60-97> 97</a></span>
<span class=normal><a href=#__codelineno-60-98> 98</a></span>
<span class=normal><a href=#__codelineno-60-99> 99</a></span>
<span class=normal><a href=#__codelineno-60-100>100</a></span>
<span class=normal><a href=#__codelineno-60-101>101</a></span>
<span class=normal><a href=#__codelineno-60-102>102</a></span>
<span class=normal><a href=#__codelineno-60-103>103</a></span>
<span class=normal><a href=#__codelineno-60-104>104</a></span>
<span class=normal><a href=#__codelineno-60-105>105</a></span>
<span class=normal><a href=#__codelineno-60-106>106</a></span>
<span class=normal><a href=#__codelineno-60-107>107</a></span>
<span class=normal><a href=#__codelineno-60-108>108</a></span>
<span class=normal><a href=#__codelineno-60-109>109</a></span>
<span class=normal><a href=#__codelineno-60-110>110</a></span>
<span class=normal><a href=#__codelineno-60-111>111</a></span>
<span class=normal><a href=#__codelineno-60-112>112</a></span>
<span class=normal><a href=#__codelineno-60-113>113</a></span>
<span class=normal><a href=#__codelineno-60-114>114</a></span>
<span class=normal><a href=#__codelineno-60-115>115</a></span>
<span class=normal><a href=#__codelineno-60-116>116</a></span>
<span class=normal><a href=#__codelineno-60-117>117</a></span>
<span class=normal><a href=#__codelineno-60-118>118</a></span>
<span class=normal><a href=#__codelineno-60-119>119</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1></a><span class=c1>// Glide</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>byteBufferBitmapDecoder</span><span class=p>)</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>streamBitmapDecoder</span><span class=p>)</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5></a><span class=n>parcelFileDescriptorVideoDecoder</span><span class=p>)</span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>AssetFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>VideoDecoder</span><span class=p>.</span><span class=na>asset</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>))</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnitBitmapDecoder</span><span class=p>())</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span><span class=w> </span><span class=n>byteBufferBitmapDecoder</span><span class=p>))</span>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span><span class=w> </span><span class=n>streamBitmapDecoder</span><span class=p>))</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span><span class=w> </span><span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span><span class=w> </span><span class=n>parcelFileDescriptorVideoDecoder</span><span class=p>))</span>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_GIF</span><span class=p>,</span><span class=w> </span><span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StreamGifDecoder</span><span class=p>(</span><span class=n>imageHeaderParsers</span><span class=p>,</span><span class=w> </span><span class=n>byteBufferGifDecoder</span><span class=p>,</span><span class=w> </span><span class=n>arrayPool</span><span class=p>))</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_GIF</span><span class=p>,</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>byteBufferGifDecoder</span><span class=p>)</span>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>GifDecoder</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GifFrameResourceDecoder</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>))</span>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>resourceDrawableDecoder</span><span class=p>)</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResourceBitmapDecoder</span><span class=p>(</span><span class=n>resourceDrawableDecoder</span><span class=p>,</span><span class=w> </span><span class=n>bitmapPool</span><span class=p>))</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileDecoder</span><span class=p>())</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>UnitDrawableDecoder</span><span class=p>())</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18></a>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19></a><span class=c1>// Registry</span>
</span><span id=__span-60-20><a id=__codelineno-60-20 name=__codelineno-60-20></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Registry</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-21><a id=__codelineno-60-21 name=__codelineno-60-21></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BUCKET_GIF</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Gif&quot;</span><span class=p>;</span>
</span><span id=__span-60-22><a id=__codelineno-60-22 name=__codelineno-60-22></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BUCKET_BITMAP</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Bitmap&quot;</span><span class=p>;</span>
</span><span id=__span-60-23><a id=__codelineno-60-23 name=__codelineno-60-23></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BUCKET_BITMAP_DRAWABLE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;BitmapDrawable&quot;</span><span class=p>;</span>
</span><span id=__span-60-24><a id=__codelineno-60-24 name=__codelineno-60-24></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BUCKET_PREPEND_ALL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;legacy_prepend_all&quot;</span><span class=p>;</span>
</span><span id=__span-60-25><a id=__codelineno-60-25 name=__codelineno-60-25></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>BUCKET_APPEND_ALL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;legacy_append&quot;</span><span class=p>;</span>
</span><span id=__span-60-26><a id=__codelineno-60-26 name=__codelineno-60-26></a>
</span><span id=__span-60-27><a id=__codelineno-60-27 name=__codelineno-60-27></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceDecoderRegistry</span><span class=w> </span><span class=n>decoderRegistry</span><span class=p>;</span>
</span><span id=__span-60-28><a id=__codelineno-60-28 name=__codelineno-60-28></a>
</span><span id=__span-60-29><a id=__codelineno-60-29 name=__codelineno-60-29></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=nf>Registry</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-30><a id=__codelineno-60-30 name=__codelineno-60-30></a><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>decoderRegistry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResourceDecoderRegistry</span><span class=p>();</span>
</span><span id=__span-60-31><a id=__codelineno-60-31 name=__codelineno-60-31></a><span class=w>   </span><span class=n>setResourceDecoderBucketPriorityList</span><span class=p>(</span>
</span><span id=__span-60-32><a id=__codelineno-60-32 name=__codelineno-60-32></a><span class=w>       </span><span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>BUCKET_GIF</span><span class=p>,</span><span class=w> </span><span class=n>BUCKET_BITMAP</span><span class=p>,</span><span class=w> </span><span class=n>BUCKET_BITMAP_DRAWABLE</span><span class=p>));</span>
</span><span id=__span-60-33><a id=__codelineno-60-33 name=__codelineno-60-33></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-34><a id=__codelineno-60-34 name=__codelineno-60-34></a>
</span><span id=__span-60-35><a id=__codelineno-60-35 name=__codelineno-60-35></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-60-36><a id=__codelineno-60-36 name=__codelineno-60-36></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>setResourceDecoderBucketPriorityList</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>buckets</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-37><a id=__codelineno-60-37 name=__codelineno-60-37></a><span class=w>   </span><span class=c1>// See #3296 and https://bugs.openjdk.java.net/browse/JDK-6260652.</span>
</span><span id=__span-60-38><a id=__codelineno-60-38 name=__codelineno-60-38></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>modifiedBuckets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>buckets</span><span class=p>.</span><span class=na>size</span><span class=p>());</span>
</span><span id=__span-60-39><a id=__codelineno-60-39 name=__codelineno-60-39></a><span class=w>   </span><span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buckets</span><span class=p>);</span>
</span><span id=__span-60-40><a id=__codelineno-60-40 name=__codelineno-60-40></a><span class=w>   </span><span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>BUCKET_PREPEND_ALL</span><span class=p>);</span>
</span><span id=__span-60-41><a id=__codelineno-60-41 name=__codelineno-60-41></a><span class=w>   </span><span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>BUCKET_APPEND_ALL</span><span class=p>);</span>
</span><span id=__span-60-42><a id=__codelineno-60-42 name=__codelineno-60-42></a><span class=w>   </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>setBucketPriorityList</span><span class=p>(</span><span class=n>modifiedBuckets</span><span class=p>);</span>
</span><span id=__span-60-43><a id=__codelineno-60-43 name=__codelineno-60-43></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-60-44><a id=__codelineno-60-44 name=__codelineno-60-44></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-45><a id=__codelineno-60-45 name=__codelineno-60-45></a>
</span><span id=__span-60-46><a id=__codelineno-60-46 name=__codelineno-60-46></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-60-47><a id=__codelineno-60-47 name=__codelineno-60-47></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>append</span><span class=p>(</span>
</span><span id=__span-60-48><a id=__codelineno-60-48 name=__codelineno-60-48></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-60-49><a id=__codelineno-60-49 name=__codelineno-60-49></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-60-50><a id=__codelineno-60-50 name=__codelineno-60-50></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-51><a id=__codelineno-60-51 name=__codelineno-60-51></a><span class=w>   </span><span class=n>append</span><span class=p>(</span><span class=n>BUCKET_APPEND_ALL</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>decoder</span><span class=p>);</span>
</span><span id=__span-60-52><a id=__codelineno-60-52 name=__codelineno-60-52></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-60-53><a id=__codelineno-60-53 name=__codelineno-60-53></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-54><a id=__codelineno-60-54 name=__codelineno-60-54></a>
</span><span id=__span-60-55><a id=__codelineno-60-55 name=__codelineno-60-55></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-60-56><a id=__codelineno-60-56 name=__codelineno-60-56></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>append</span><span class=p>(</span>
</span><span id=__span-60-57><a id=__codelineno-60-57 name=__codelineno-60-57></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=p>,</span>
</span><span id=__span-60-58><a id=__codelineno-60-58 name=__codelineno-60-58></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-60-59><a id=__codelineno-60-59 name=__codelineno-60-59></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-60-60><a id=__codelineno-60-60 name=__codelineno-60-60></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-61><a id=__codelineno-60-61 name=__codelineno-60-61></a><span class=w>   </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span><span class=w> </span><span class=n>decoder</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-60-62><a id=__codelineno-60-62 name=__codelineno-60-62></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-60-63><a id=__codelineno-60-63 name=__codelineno-60-63></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-64><a id=__codelineno-60-64 name=__codelineno-60-64></a>
</span><span id=__span-60-65><a id=__codelineno-60-65 name=__codelineno-60-65></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-60-66><a id=__codelineno-60-66 name=__codelineno-60-66></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>prepend</span><span class=p>(</span>
</span><span id=__span-60-67><a id=__codelineno-60-67 name=__codelineno-60-67></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=p>,</span>
</span><span id=__span-60-68><a id=__codelineno-60-68 name=__codelineno-60-68></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-60-69><a id=__codelineno-60-69 name=__codelineno-60-69></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-60-70><a id=__codelineno-60-70 name=__codelineno-60-70></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-71><a id=__codelineno-60-71 name=__codelineno-60-71></a><span class=w>   </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span><span class=w> </span><span class=n>decoder</span><span class=p>,</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-60-72><a id=__codelineno-60-72 name=__codelineno-60-72></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-60-73><a id=__codelineno-60-73 name=__codelineno-60-73></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-74><a id=__codelineno-60-74 name=__codelineno-60-74></a><span class=p>}</span>
</span><span id=__span-60-75><a id=__codelineno-60-75 name=__codelineno-60-75></a>
</span><span id=__span-60-76><a id=__codelineno-60-76 name=__codelineno-60-76></a><span class=c1>// ResourceDecoderRegistry</span>
</span><span id=__span-60-77><a id=__codelineno-60-77 name=__codelineno-60-77></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>ResourceDecoderRegistry</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-78><a id=__codelineno-60-78 name=__codelineno-60-78></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>bucketPriorityList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-60-79><a id=__codelineno-60-79 name=__codelineno-60-79></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;&gt;</span><span class=w> </span><span class=n>decoders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-60-80><a id=__codelineno-60-80 name=__codelineno-60-80></a>
</span><span id=__span-60-81><a id=__codelineno-60-81 name=__codelineno-60-81></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setBucketPriorityList</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>buckets</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-82><a id=__codelineno-60-82 name=__codelineno-60-82></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>previousBuckets</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>bucketPriorityList</span><span class=p>);</span>
</span><span id=__span-60-83><a id=__codelineno-60-83 name=__codelineno-60-83></a><span class=w>   </span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
</span><span id=__span-60-84><a id=__codelineno-60-84 name=__codelineno-60-84></a><span class=w>   </span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buckets</span><span class=p>);</span>
</span><span id=__span-60-85><a id=__codelineno-60-85 name=__codelineno-60-85></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>previousBucket</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>previousBuckets</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-86><a id=__codelineno-60-86 name=__codelineno-60-86></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>buckets</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>previousBucket</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-87><a id=__codelineno-60-87 name=__codelineno-60-87></a><span class=w>       </span><span class=c1>// Keep any buckets from the previous list that aren&#39;t included here, but but them at the</span>
</span><span id=__span-60-88><a id=__codelineno-60-88 name=__codelineno-60-88></a><span class=w>       </span><span class=c1>// end.</span>
</span><span id=__span-60-89><a id=__codelineno-60-89 name=__codelineno-60-89></a><span class=w>       </span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>previousBucket</span><span class=p>);</span>
</span><span id=__span-60-90><a id=__codelineno-60-90 name=__codelineno-60-90></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-60-91><a id=__codelineno-60-91 name=__codelineno-60-91></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-60-92><a id=__codelineno-60-92 name=__codelineno-60-92></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-93><a id=__codelineno-60-93 name=__codelineno-60-93></a>
</span><span id=__span-60-94><a id=__codelineno-60-94 name=__codelineno-60-94></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>append</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=p>,</span>
</span><span id=__span-60-95><a id=__codelineno-60-95 name=__codelineno-60-95></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoder</span><span class=p>,</span>
</span><span id=__span-60-96><a id=__codelineno-60-96 name=__codelineno-60-96></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-97><a id=__codelineno-60-97 name=__codelineno-60-97></a><span class=w>   </span><span class=n>getOrAddEntryList</span><span class=p>(</span><span class=n>bucket</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>decoder</span><span class=p>));</span>
</span><span id=__span-60-98><a id=__codelineno-60-98 name=__codelineno-60-98></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-99><a id=__codelineno-60-99 name=__codelineno-60-99></a>
</span><span id=__span-60-100><a id=__codelineno-60-100 name=__codelineno-60-100></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>prepend</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=p>,</span>
</span><span id=__span-60-101><a id=__codelineno-60-101 name=__codelineno-60-101></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoder</span><span class=p>,</span>
</span><span id=__span-60-102><a id=__codelineno-60-102 name=__codelineno-60-102></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-103><a id=__codelineno-60-103 name=__codelineno-60-103></a><span class=w>   </span><span class=n>getOrAddEntryList</span><span class=p>(</span><span class=n>bucket</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>decoder</span><span class=p>));</span>
</span><span id=__span-60-104><a id=__codelineno-60-104 name=__codelineno-60-104></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-105><a id=__codelineno-60-105 name=__codelineno-60-105></a>
</span><span id=__span-60-106><a id=__codelineno-60-106 name=__codelineno-60-106></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-60-107><a id=__codelineno-60-107 name=__codelineno-60-107></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>getOrAddEntryList</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-108><a id=__codelineno-60-108 name=__codelineno-60-108></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>bucket</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-109><a id=__codelineno-60-109 name=__codelineno-60-109></a><span class=w>     </span><span class=c1>// Add this unspecified bucket as a low priority bucket.</span>
</span><span id=__span-60-110><a id=__codelineno-60-110 name=__codelineno-60-110></a><span class=w>     </span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
</span><span id=__span-60-111><a id=__codelineno-60-111 name=__codelineno-60-111></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-60-112><a id=__codelineno-60-112 name=__codelineno-60-112></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
</span><span id=__span-60-113><a id=__codelineno-60-113 name=__codelineno-60-113></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entries</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-60-114><a id=__codelineno-60-114 name=__codelineno-60-114></a><span class=w>     </span><span class=n>entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-60-115><a id=__codelineno-60-115 name=__codelineno-60-115></a><span class=w>     </span><span class=n>decoders</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span><span class=w> </span><span class=n>entries</span><span class=p>);</span>
</span><span id=__span-60-116><a id=__codelineno-60-116 name=__codelineno-60-116></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-60-117><a id=__codelineno-60-117 name=__codelineno-60-117></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>entries</span><span class=p>;</span>
</span><span id=__span-60-118><a id=__codelineno-60-118 name=__codelineno-60-118></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-60-119><a id=__codelineno-60-119 name=__codelineno-60-119></a><span class=p>}</span>
</span></code></pre></div></td></tr></table></div> <p><code>ResourceDecoderRegistry</code>内部维持着一个具有优先级 bucket 的 list，优先级顺序由BUCKET在<code>bucketPriorityList</code>中的顺序决定。<br> 在<code>Registry</code>的构造器中，创建<code>ResourceDecoderRegistry</code>后，就调用<code>setResourceDecoderBucketPriorityList</code>方法调整了其优先级，优先级别为：<br> BUCKET_PREPEND_ALL, BUCKET_GIF, BUCKET_BITMAP, BUCKET_BITMAP_DRAWABLE, BUCKET_APPEND_ALL。 </p> <p><code>ResourceDecoderRegistry</code>的<code>append</code>方法和<code>prepend</code>方法就是向对应的桶中将entry插入到尾部或头部。</p> <p>下面就是<code>ResourceDecoderRegistry</code>里面数据的图，decoders里面的数字表示的Entry与上面注册代码中行数相对应：</p> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/glide-resource-decoder-registry-content.png> <figcaption>ResourceDecoderRegistry内部数据模型</figcaption> </figure> <p>了解完了<code>ResourceDecoderRegistry</code>之后，我们在回到🔥🔥🔥原来的位置继续看看<code>decoderRegistry.getResourceClasses</code>方法干了什么：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=nd>@NonNull</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getResourceClasses</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>bucketPriorityList</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entries</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=w>     </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>entries</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=w>         </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-61-14><a id=__codelineno-61-14 name=__codelineno-61-14 href=#__codelineno-61-14></a><span class=w>       </span><span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>);</span>
</span><span id=__span-61-15><a id=__codelineno-61-15 name=__codelineno-61-15 href=#__codelineno-61-15></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-61-16><a id=__codelineno-61-16 name=__codelineno-61-16 href=#__codelineno-61-16></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-61-17><a id=__codelineno-61-17 name=__codelineno-61-17 href=#__codelineno-61-17></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-61-18><a id=__codelineno-61-18 name=__codelineno-61-18 href=#__codelineno-61-18></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-61-19><a id=__codelineno-61-19 name=__codelineno-61-19 href=#__codelineno-61-19></a><span class=p>}</span>
</span></code></pre></div> <p>那么，该方法的作用就是根据传入的dataClass以及resourceClass在桶中依次按顺序查找映射关系，如果可以找到就返回这条映射关系的resourceClass。</p> <p>这里的入参<code>dataClass in　[InputStream.class, ParcelFileDescriptor.class, AssetFileDescriptor.class]</code>, <code>resourceClass = Object.class</code>。 </p> <p>上面的方法会运行三次，每一次的结果如下：</p> <ol> <li>InputStream.class &amp; Object.class<br> 注册表第11、3、9行所对应的resourceClass 即<code>GifDrawable.class</code>、<code>Bitmap.class</code>、<code>BitmapDrawable.class</code></li> <li>ParcelFileDescriptor.class &amp; Object.class<br> 注册表第4、10行所对应的resourceClass 即<code>Bitmap.class</code>、<code>BitmapDrawable.class</code></li> <li>AssetFileDescriptor.class &amp; Object.class<br> 注册表第6行所对应的resourceClass 即<code>Bitmap.class</code></li> </ol> <p>OK，离看完这个部分的代码更近了一步，我的眼睛已经受不了了:( </p> <p>回到<code>Registry.getRegisteredResourceClasses</code>方法中，下面将会对每次运行返回的resourceClasses数组进行遍历，并调用了<code>transcoderRegistry.getTranscodeClasses</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=c1>// Registry.getRegisteredResourceClasses</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>dataClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=w> </span><span class=c1>// 我们刚才分析了这个方法，返回值看上面的分析</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=w> </span><span class=n>List</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>registeredResourceClasses</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=w>     </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>registeredResourceClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>registeredResourceClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=w>   </span><span class=c1>// 🔥🔥🔥 现在分析这个方法</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>registeredTranscodeClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transcoderRegistry</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=w>       </span><span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>registeredTranscodeClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=w>     </span><span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>);</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=p>}</span>
</span></code></pre></div> <p>🔥🔥🔥 现在分析一下<code>transcoderRegistry.getTranscodeClasses</code>方法。</p> <p>和上面分析过的两个Registry一样，<code>TranscoderRegistry</code>也同样是在Glide构建的时候注册进来的，相关代码如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=c1>// Glide</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>BitmapDrawableTranscoder</span><span class=p>(</span><span class=n>resources</span><span class=p>))</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>bitmapBytesTranscoder</span><span class=p>)</span>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DrawableBytesTranscoder</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>,</span><span class=w> </span><span class=n>bitmapBytesTranscoder</span><span class=p>,</span><span class=w> </span><span class=n>gifDrawableBytesTranscoder</span><span class=p>))</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span><span class=w> </span><span class=n>gifDrawableBytesTranscoder</span><span class=p>);</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=c1>// Registry</span>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Registry</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>TranscoderRegistry</span><span class=w> </span><span class=n>transcoderRegistry</span><span class=p>;</span>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=nf>Registry</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=w>   </span><span class=k>this</span><span class=p>.</span><span class=na>transcoderRegistry</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TranscoderRegistry</span><span class=p>();</span>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-63-14><a id=__codelineno-63-14 name=__codelineno-63-14 href=#__codelineno-63-14></a>
</span><span id=__span-63-15><a id=__codelineno-63-15 name=__codelineno-63-15 href=#__codelineno-63-15></a><span class=w> </span><span class=nd>@NonNull</span>
</span><span id=__span-63-16><a id=__codelineno-63-16 name=__codelineno-63-16 href=#__codelineno-63-16></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>Registry</span><span class=w> </span><span class=nf>register</span><span class=p>(</span>
</span><span id=__span-63-17><a id=__codelineno-63-17 name=__codelineno-63-17 href=#__codelineno-63-17></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span>
</span><span id=__span-63-18><a id=__codelineno-63-18 name=__codelineno-63-18 href=#__codelineno-63-18></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcoder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-63-19><a id=__codelineno-63-19 name=__codelineno-63-19 href=#__codelineno-63-19></a><span class=w>   </span><span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span><span class=w> </span><span class=n>transcoder</span><span class=p>);</span>
</span><span id=__span-63-20><a id=__codelineno-63-20 name=__codelineno-63-20 href=#__codelineno-63-20></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=k>this</span><span class=p>;</span>
</span><span id=__span-63-21><a id=__codelineno-63-21 name=__codelineno-63-21 href=#__codelineno-63-21></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-63-22><a id=__codelineno-63-22 name=__codelineno-63-22 href=#__codelineno-63-22></a><span class=p>}</span>
</span><span id=__span-63-23><a id=__codelineno-63-23 name=__codelineno-63-23 href=#__codelineno-63-23></a>
</span><span id=__span-63-24><a id=__codelineno-63-24 name=__codelineno-63-24 href=#__codelineno-63-24></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>TranscoderRegistry</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-63-25><a id=__codelineno-63-25 name=__codelineno-63-25 href=#__codelineno-63-25></a><span class=w> </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>transcoders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-63-26><a id=__codelineno-63-26 name=__codelineno-63-26 href=#__codelineno-63-26></a>
</span><span id=__span-63-27><a id=__codelineno-63-27 name=__codelineno-63-27 href=#__codelineno-63-27></a><span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>register</span><span class=p>(</span>
</span><span id=__span-63-28><a id=__codelineno-63-28 name=__codelineno-63-28 href=#__codelineno-63-28></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>decodedClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodedClass</span><span class=p>,</span>
</span><span id=__span-63-29><a id=__codelineno-63-29 name=__codelineno-63-29 href=#__codelineno-63-29></a><span class=w>     </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcoder</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-63-30><a id=__codelineno-63-30 name=__codelineno-63-30 href=#__codelineno-63-30></a><span class=w>   </span><span class=n>transcoders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>decodedClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodedClass</span><span class=p>,</span><span class=w> </span><span class=n>transcoder</span><span class=p>));</span>
</span><span id=__span-63-31><a id=__codelineno-63-31 name=__codelineno-63-31 href=#__codelineno-63-31></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-63-32><a id=__codelineno-63-32 name=__codelineno-63-32 href=#__codelineno-63-32></a><span class=p>}</span>
</span></code></pre></div> <p>注册代码很简单，就是保存到list中就完事了。看看<code>TranscoderRegistry.getTranscodeClasses</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=nd>@NonNull</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getTranscodeClasses</span><span class=p>(</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>transcodeClasses</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=w> </span><span class=c1>// GifDrawable -&gt; Drawable is just the UnitTranscoder, as is GifDrawable -&gt; GifDrawable.</span>
</span><span id=__span-64-6><a id=__codelineno-64-6 name=__codelineno-64-6 href=#__codelineno-64-6></a><span class=w> </span><span class=c1>// 🔥路径1</span>
</span><span id=__span-64-7><a id=__codelineno-64-7 name=__codelineno-64-7 href=#__codelineno-64-7></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-64-8><a id=__codelineno-64-8 name=__codelineno-64-8 href=#__codelineno-64-8></a><span class=w>   </span><span class=n>transcodeClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-64-9><a id=__codelineno-64-9 name=__codelineno-64-9 href=#__codelineno-64-9></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=n>transcodeClasses</span><span class=p>;</span>
</span><span id=__span-64-10><a id=__codelineno-64-10 name=__codelineno-64-10 href=#__codelineno-64-10></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-64-11><a id=__codelineno-64-11 name=__codelineno-64-11 href=#__codelineno-64-11></a>
</span><span id=__span-64-12><a id=__codelineno-64-12 name=__codelineno-64-12 href=#__codelineno-64-12></a><span class=w> </span><span class=c1>// 🔥路径2</span>
</span><span id=__span-64-13><a id=__codelineno-64-13 name=__codelineno-64-13 href=#__codelineno-64-13></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>transcoders</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-64-14><a id=__codelineno-64-14 name=__codelineno-64-14 href=#__codelineno-64-14></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-64-15><a id=__codelineno-64-15 name=__codelineno-64-15 href=#__codelineno-64-15></a><span class=w>     </span><span class=n>transcodeClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-64-16><a id=__codelineno-64-16 name=__codelineno-64-16 href=#__codelineno-64-16></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-64-17><a id=__codelineno-64-17 name=__codelineno-64-17 href=#__codelineno-64-17></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-64-18><a id=__codelineno-64-18 name=__codelineno-64-18 href=#__codelineno-64-18></a>
</span><span id=__span-64-19><a id=__codelineno-64-19 name=__codelineno-64-19 href=#__codelineno-64-19></a><span class=w> </span><span class=c1>// list添加的都是入参transcodeClass</span>
</span><span id=__span-64-20><a id=__codelineno-64-20 name=__codelineno-64-20 href=#__codelineno-64-20></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>transcodeClasses</span><span class=p>;</span>
</span><span id=__span-64-21><a id=__codelineno-64-21 name=__codelineno-64-21 href=#__codelineno-64-21></a><span class=p>}</span>
</span></code></pre></div> <p>此方法的作用是根据resourceClass和transcodeClass，从自身或者注册表的“map”中找出<code>transcodeClass</code>。</p> <p>回到<code>Registry.getRegisteredResourceClasses</code>方法中的第二层for loop继续分析，下面就是对每个resourceClass得到的registeredTranscodeClasses（transcodeClass为<code>Drawable.class</code>）</p> <ol> <li>InputStream.class &amp; Object.class<br> resourceClass为</li> <li><code>GifDrawable.class</code><br> 路径1 允许添加resourceClass</li> <li><code>Bitmap.class</code><br> 路径2 走Glide注入代码片段的第2行 允许添加resourceClass</li> <li><code>BitmapDrawable.class</code><br> 路径1 允许添加resourceClass</li> <li>ParcelFileDescriptor.class &amp; Object.class<br> resourceClass为</li> <li><code>Bitmap.class</code><br> 路径2 走Glide注入代码片段的第2行 但resourceClass已经添加过</li> <li><code>BitmapDrawable.class</code><br> 路径1 但resourceClass已经添加过</li> <li>AssetFileDescriptor.class &amp; Object.class<br> resourceClass为</li> <li><code>Bitmap.class</code><br> 路径2 走Glide注入代码片段的第2行 但resourceClass已经添加过</li> </ol> <p>因此，<code>Registry.getRegisteredResourceClasses</code>返回了<code>[GifDrawable.class、Bitmap.class、BitmapDrawable.class]</code>数组，该数组会经过<code>DecodeHelper</code>返回到<code>ResourceCacheGenerator.startNext</code>方法的调用中。</p> <h4 id=363>3.6.3 寻找缓存文件并加载<a class=headerlink href=#363 title="Permanent link">&para;</a></h4> <p>继续回到本小节的第一个方法<code>ResourceCacheGenerator.startNext</code>方法中。下面要执行的代码是一个while循环，循环结束的标志是找到了缓存文件：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=c1>// 遍历sourceIds中的每一个key、resourceClasses中每一个class，以及其他的一些值组成key</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a><span class=c1>// 尝试在磁盘缓存中以key找到缓存文件</span>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>modelLoaders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=w> </span><span class=n>resourceClassIndex</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>size</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=w>   </span><span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>sourceIds</span><span class=p>.</span><span class=na>size</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=w>     </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=w>   </span><span class=n>resourceClassIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-65-11><a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-65-12><a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a>
</span><span id=__span-65-13><a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>sourceId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceIds</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
</span><span id=__span-65-14><a id=__codelineno-65-14 name=__codelineno-65-14 href=#__codelineno-65-14></a><span class=w> </span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=p>);</span>
</span><span id=__span-65-15><a id=__codelineno-65-15 name=__codelineno-65-15 href=#__codelineno-65-15></a><span class=w> </span><span class=n>Transformation</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>transformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-65-16><a id=__codelineno-65-16 name=__codelineno-65-16 href=#__codelineno-65-16></a><span class=w> </span><span class=c1>// PMD.AvoidInstantiatingObjectsInLoops Each iteration is comparatively expensive anyway,</span>
</span><span id=__span-65-17><a id=__codelineno-65-17 name=__codelineno-65-17 href=#__codelineno-65-17></a><span class=w> </span><span class=c1>// we only run until the first one succeeds, the loop runs for only a limited</span>
</span><span id=__span-65-18><a id=__codelineno-65-18 name=__codelineno-65-18 href=#__codelineno-65-18></a><span class=w> </span><span class=c1>// number of iterations on the order of 10-20 in the worst case.</span>
</span><span id=__span-65-19><a id=__codelineno-65-19 name=__codelineno-65-19 href=#__codelineno-65-19></a><span class=w> </span><span class=n>currentKey</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-65-20><a id=__codelineno-65-20 name=__codelineno-65-20 href=#__codelineno-65-20></a><span class=w>     </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheKey</span><span class=p>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops</span>
</span><span id=__span-65-21><a id=__codelineno-65-21 name=__codelineno-65-21 href=#__codelineno-65-21></a><span class=w>         </span><span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
</span><span id=__span-65-22><a id=__codelineno-65-22 name=__codelineno-65-22 href=#__codelineno-65-22></a><span class=w>         </span><span class=n>sourceId</span><span class=p>,</span>
</span><span id=__span-65-23><a id=__codelineno-65-23 name=__codelineno-65-23 href=#__codelineno-65-23></a><span class=w>         </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
</span><span id=__span-65-24><a id=__codelineno-65-24 name=__codelineno-65-24 href=#__codelineno-65-24></a><span class=w>         </span><span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
</span><span id=__span-65-25><a id=__codelineno-65-25 name=__codelineno-65-25 href=#__codelineno-65-25></a><span class=w>         </span><span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
</span><span id=__span-65-26><a id=__codelineno-65-26 name=__codelineno-65-26 href=#__codelineno-65-26></a><span class=w>         </span><span class=n>transformation</span><span class=p>,</span>
</span><span id=__span-65-27><a id=__codelineno-65-27 name=__codelineno-65-27 href=#__codelineno-65-27></a><span class=w>         </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-65-28><a id=__codelineno-65-28 name=__codelineno-65-28 href=#__codelineno-65-28></a><span class=w>         </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</span><span id=__span-65-29><a id=__codelineno-65-29 name=__codelineno-65-29 href=#__codelineno-65-29></a><span class=w> </span><span class=n>cacheFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>currentKey</span><span class=p>);</span>
</span><span id=__span-65-30><a id=__codelineno-65-30 name=__codelineno-65-30 href=#__codelineno-65-30></a><span class=w> </span><span class=c1>// 如果找到了缓存文件，那么循环条件则会为false，也就退出循环了</span>
</span><span id=__span-65-31><a id=__codelineno-65-31 name=__codelineno-65-31 href=#__codelineno-65-31></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cacheFile</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-65-32><a id=__codelineno-65-32 name=__codelineno-65-32 href=#__codelineno-65-32></a><span class=w>   </span><span class=n>sourceKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceId</span><span class=p>;</span>
</span><span id=__span-65-33><a id=__codelineno-65-33 name=__codelineno-65-33 href=#__codelineno-65-33></a><span class=w>   </span><span class=n>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
</span><span id=__span-65-34><a id=__codelineno-65-34 name=__codelineno-65-34 href=#__codelineno-65-34></a><span class=w>   </span><span class=n>modelLoaderIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-65-35><a id=__codelineno-65-35 name=__codelineno-65-35 href=#__codelineno-65-35></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-65-36><a id=__codelineno-65-36 name=__codelineno-65-36 href=#__codelineno-65-36></a><span class=p>}</span>
</span></code></pre></div> <p>走到这里，由于是初次加载，所以DiskLruCache里面肯定是没有缓存的。 </p> <p>注意这里的Key的组成，在之前我们描述过<code>ResourceCacheGenerator</code>的作用：获取采样后、transformed后资源文件的缓存文件。在第3节中我们可以看到，DownsampleStrategy和Transformation保存在了<code>BaseRequestOptions</code>里面，前者保存在<code>BaseRequestOptions.Options</code>里，后者保存在<code>transformations</code>里。在这里这两个参数都作为了缓存文件的Key，这也侧面验证了<code>ResourceCacheGenerator</code>的作用。</p> <p>但在加载代码上加上话<code>.diskCacheStrategy(DiskCacheStrategy.RESOURCE)</code>，就可以到了缓存，这样可以接着一次性把后面的方法也分析完，先看看下面的这个方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=n>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
</span></code></pre></div> <p>内部调用了<code>Registry.getModelLoaders</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>getModelLoaders</span><span class=p>(</span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=p>)</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=w>   </span><span class=kd>throws</span><span class=w> </span><span class=n>Registry</span><span class=p>.</span><span class=na>NoModelLoaderAvailableException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=p>}</span>
</span></code></pre></div> <p>该方法我们上面具体分析过，稍加回忆后我们可以写出<code>getModelLoaders(File)</code>方法的过程：</p> <ol> <li>首先找出注入时以<code>File.class</code>为modelClass的注入代码</li> <li>调用所有注入的<code>factory.build</code>方法得到<code>ModelLoader</code></li> <li>过滤掉不可能处理<code>model</code>的<code>ModelLoader</code></li> </ol> <p>这样得到了以下四个ModelLoader</p> <ul> <li><code>.append(File.class, ByteBuffer.class, new ByteBufferFileLoader.Factory())</code></li> <li><code>ByteBufferFileLoader</code></li> <li><code>.append(File.class, InputStream.class, new FileLoader.StreamFactory())</code></li> <li><code>FileLoader</code></li> <li><code>.append(File.class, ParcelFileDescriptor.class, new FileLoader.FileDescriptorFactory())</code></li> <li><code>FileLoader</code></li> <li><code>.append(File.class, File.class, UnitModelLoader.Factory.&lt;File&gt;getInstance())</code></li> <li><code>UnitModelLoader</code></li> </ul> <p>所以此时的modelLoaders值为<code>[ByteBufferFileLoader, FileLoader, FileLoader, UnitModelLoader]</code>。</p> <p>接下来会调用每一个ModelLoader尝试加载数据，直到找到第一个可以处理的ModelLoader：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=kt>boolean</span><span class=w> </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>started</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=w> </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>modelLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a><span class=w> </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a><span class=w>     </span><span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadData</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a><span class=w>   </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a><span class=w>   </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a><span class=p>}</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=k>return</span><span class=w> </span><span class=n>started</span><span class=p>;</span>
</span></code></pre></div> <p>这四个ModelLoader都会调用<code>buildLoadData</code>方法创建<code>LoadData</code>对象，该对象重要的成员变量是<code>DataFetcher</code>；然后调用<code>helper.hasLoadPath</code>根据<code>resourceClass</code>参数和<code>transcodeClass</code>参数判断是否有路径达到<code>DataFetcher.getDataClass</code>，如果有那就调用此fetcher进行loadData，任务执行完毕。</p> <p>例子中符合条件的<code>ModelLoader</code>以及其<code>fetcher</code>如下：</p> <ul> <li><code>ByteBufferFileLoader</code><br> fetcher = <code>ByteBufferFetcher(file)</code><br> fetcher.dataClass = <code>ByteBuffer.class</code></li> <li><code>FileLoader</code><br> fetcher = <code>FileFetcher(model, fileOpener)</code><br> fetcher.dataClass = <code>InputStream.class</code></li> <li><code>FileLoader</code><br> fetcher = <code>FileFetcher(model, fileOpener)</code><br> fetcher.dataClass = <code>ParcelFileDescriptor.class</code></li> <li><code>UnitModelLoader</code><br> fetcher = <code>UnitFetcher&lt;&gt;(model)</code><br> fetcher.dataClass = <code>File.class</code></li> </ul> <p>看一下<code>DecodeHelper.getLoadPath</code>方法是如何判断路径的：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=c1>// DecodeHelper</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getLoadPath</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getLoadPath</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=p>}</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=c1>// Registry</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=nd>@Nullable</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=kd>public</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getLoadPath</span><span class=p>(</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=w> </span><span class=c1>// 先取缓存</span>
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a><span class=w> </span><span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-69-13><a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a><span class=w>     </span><span class=n>loadPathCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-69-14><a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a><span class=w> </span><span class=c1>// 如果取到NO_PATHS_SIGNAL这条LoadPath，那么返回null</span>
</span><span id=__span-69-15><a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadPathCache</span><span class=p>.</span><span class=na>isEmptyLoadPath</span><span class=p>(</span><span class=n>result</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-69-16><a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-69-17><a id=__codelineno-69-17 name=__codelineno-69-17 href=#__codelineno-69-17></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-69-18><a id=__codelineno-69-18 name=__codelineno-69-18 href=#__codelineno-69-18></a><span class=w>   </span><span class=c1>// 取到null，说明还没有获取过</span>
</span><span id=__span-69-19><a id=__codelineno-69-19 name=__codelineno-69-19 href=#__codelineno-69-19></a><span class=w>   </span><span class=c1>// 那么先获取decodePaths，在创建LoadPath对象并存入缓存中</span>
</span><span id=__span-69-20><a id=__codelineno-69-20 name=__codelineno-69-20 href=#__codelineno-69-20></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>decodePaths</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-69-21><a id=__codelineno-69-21 name=__codelineno-69-21 href=#__codelineno-69-21></a><span class=w>       </span><span class=n>getDecodePaths</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-69-22><a id=__codelineno-69-22 name=__codelineno-69-22 href=#__codelineno-69-22></a><span class=w>   </span><span class=c1>// It&#39;s possible there is no way to decode or transcode to the desired types from a given</span>
</span><span id=__span-69-23><a id=__codelineno-69-23 name=__codelineno-69-23 href=#__codelineno-69-23></a><span class=w>   </span><span class=c1>// data class.</span>
</span><span id=__span-69-24><a id=__codelineno-69-24 name=__codelineno-69-24 href=#__codelineno-69-24></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>decodePaths</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-69-25><a id=__codelineno-69-25 name=__codelineno-69-25 href=#__codelineno-69-25></a><span class=w>     </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-69-26><a id=__codelineno-69-26 name=__codelineno-69-26 href=#__codelineno-69-26></a><span class=w>   </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-69-27><a id=__codelineno-69-27 name=__codelineno-69-27 href=#__codelineno-69-27></a><span class=w>     </span><span class=n>result</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-69-28><a id=__codelineno-69-28 name=__codelineno-69-28 href=#__codelineno-69-28></a><span class=w>         </span><span class=k>new</span><span class=w> </span><span class=n>LoadPath</span><span class=o>&lt;&gt;</span><span class=p>(</span>
</span><span id=__span-69-29><a id=__codelineno-69-29 name=__codelineno-69-29 href=#__codelineno-69-29></a><span class=w>             </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span><span class=w> </span><span class=n>decodePaths</span><span class=p>,</span><span class=w> </span><span class=n>throwableListPool</span><span class=p>);</span>
</span><span id=__span-69-30><a id=__codelineno-69-30 name=__codelineno-69-30 href=#__codelineno-69-30></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-69-31><a id=__codelineno-69-31 name=__codelineno-69-31 href=#__codelineno-69-31></a><span class=w>   </span><span class=c1>// 存入缓存</span>
</span><span id=__span-69-32><a id=__codelineno-69-32 name=__codelineno-69-32 href=#__codelineno-69-32></a><span class=w>   </span><span class=n>loadPathCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span><span class=w> </span><span class=n>result</span><span class=p>);</span>
</span><span id=__span-69-33><a id=__codelineno-69-33 name=__codelineno-69-33 href=#__codelineno-69-33></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-69-34><a id=__codelineno-69-34 name=__codelineno-69-34 href=#__codelineno-69-34></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-69-35><a id=__codelineno-69-35 name=__codelineno-69-35 href=#__codelineno-69-35></a><span class=p>}</span>
</span></code></pre></div> <p>可以看出，<code>getLoadPath</code>的关键就是<code>getDecodePaths</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=nd>@NonNull</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getDecodePaths</span><span class=p>(</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>decodePaths</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=w> </span><span class=c1>// 1</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>registeredResourceClasses</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a><span class=w>     </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>);</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span><span class=w> </span><span class=n>registeredResourceClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>registeredResourceClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=w>   </span><span class=c1>// 2</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>registeredTranscodeClasses</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=w>       </span><span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>);</span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>registeredTranscodeClass</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>registeredTranscodeClasses</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=w>     </span><span class=c1>// 3</span>
</span><span id=__span-70-17><a id=__codelineno-70-17 name=__codelineno-70-17 href=#__codelineno-70-17></a><span class=w>     </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>decoders</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-70-18><a id=__codelineno-70-18 name=__codelineno-70-18 href=#__codelineno-70-18></a><span class=w>         </span><span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getDecoders</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>registeredResourceClass</span><span class=p>);</span>
</span><span id=__span-70-19><a id=__codelineno-70-19 name=__codelineno-70-19 href=#__codelineno-70-19></a><span class=w>     </span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcoder</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-70-20><a id=__codelineno-70-20 name=__codelineno-70-20 href=#__codelineno-70-20></a><span class=w>         </span><span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span><span class=w> </span><span class=n>registeredTranscodeClass</span><span class=p>);</span>
</span><span id=__span-70-21><a id=__codelineno-70-21 name=__codelineno-70-21 href=#__codelineno-70-21></a><span class=w>     </span><span class=c1>// 4</span>
</span><span id=__span-70-22><a id=__codelineno-70-22 name=__codelineno-70-22 href=#__codelineno-70-22></a><span class=w>     </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;</span><span class=p>)</span>
</span><span id=__span-70-23><a id=__codelineno-70-23 name=__codelineno-70-23 href=#__codelineno-70-23></a><span class=w>     </span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>TResource</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-70-24><a id=__codelineno-70-24 name=__codelineno-70-24 href=#__codelineno-70-24></a><span class=w>         </span><span class=k>new</span><span class=w> </span><span class=n>DecodePath</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>registeredResourceClass</span><span class=p>,</span><span class=w> </span><span class=n>registeredTranscodeClass</span><span class=p>,</span>
</span><span id=__span-70-25><a id=__codelineno-70-25 name=__codelineno-70-25 href=#__codelineno-70-25></a><span class=w>             </span><span class=n>decoders</span><span class=p>,</span><span class=w> </span><span class=n>transcoder</span><span class=p>,</span><span class=w> </span><span class=n>throwableListPool</span><span class=p>);</span>
</span><span id=__span-70-26><a id=__codelineno-70-26 name=__codelineno-70-26 href=#__codelineno-70-26></a><span class=w>     </span><span class=n>decodePaths</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-70-27><a id=__codelineno-70-27 name=__codelineno-70-27 href=#__codelineno-70-27></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-70-28><a id=__codelineno-70-28 name=__codelineno-70-28 href=#__codelineno-70-28></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-70-29><a id=__codelineno-70-29 name=__codelineno-70-29 href=#__codelineno-70-29></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>decodePaths</span><span class=p>;</span>
</span><span id=__span-70-30><a id=__codelineno-70-30 name=__codelineno-70-30 href=#__codelineno-70-30></a><span class=p>}</span>
</span></code></pre></div> <p>首先就是<code>decoderRegistry.getResourceClasses(dataClass, resourceClass)</code>方法，该方法我们上面分析过，作用就是根据传入的dataClass以及resourceClass在Registry中找映射关系，如果可以找到就返回这条映射关系的resourceClass（该方法中dataClass为传入的fetcher.dataClass，resourceClass值为Object.class）。</p> <p>然后对于每个获取到的registeredResourceClass，调用<code>transcoderRegistry.getTranscodeClasses</code>方法，此方法之前也解析过，其作用是根据resourceClass和transcodeClass，从自身或者注册表的“map”中找出transcodeClass（参数transcodeClass为<code>Drawable.class</code>）。</p> <p>最后，对于每个registeredResourceClass和registeredTranscodeClass，都会获取其<code>ResourceDecoder</code>和<code>ResourceTranscoder</code>，并将这些参数组成一个<code>DecodePath</code>保存到list，最后返回。我们先看一下这些方法的实现，最后在给出每一步的操作结果。</p> <p>所以我们直接看<code>decoderRegistry.getDecoders</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=nd>@NonNull</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>getDecoders</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=n>dataClass</span><span class=p>,</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>bucket</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>bucketPriorityList</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=w>   </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;&gt;</span><span class=w> </span><span class=n>entries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
</span><span id=__span-71-8><a id=__codelineno-71-8 name=__codelineno-71-8 href=#__codelineno-71-8></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entries</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-71-9><a id=__codelineno-71-9 name=__codelineno-71-9 href=#__codelineno-71-9></a><span class=w>     </span><span class=k>continue</span><span class=p>;</span>
</span><span id=__span-71-10><a id=__codelineno-71-10 name=__codelineno-71-10 href=#__codelineno-71-10></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-71-11><a id=__codelineno-71-11 name=__codelineno-71-11 href=#__codelineno-71-11></a><span class=w>   </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>entries</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-71-12><a id=__codelineno-71-12 name=__codelineno-71-12 href=#__codelineno-71-12></a><span class=w>     </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span><span class=w> </span><span class=n>resourceClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-71-13><a id=__codelineno-71-13 name=__codelineno-71-13 href=#__codelineno-71-13></a><span class=w>       </span><span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>((</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>decoder</span><span class=p>);</span>
</span><span id=__span-71-14><a id=__codelineno-71-14 name=__codelineno-71-14 href=#__codelineno-71-14></a><span class=w>     </span><span class=p>}</span>
</span><span id=__span-71-15><a id=__codelineno-71-15 name=__codelineno-71-15 href=#__codelineno-71-15></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-71-16><a id=__codelineno-71-16 name=__codelineno-71-16 href=#__codelineno-71-16></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-71-17><a id=__codelineno-71-17 name=__codelineno-71-17 href=#__codelineno-71-17></a><span class=w> </span><span class=c1>// TODO: cache result list.</span>
</span><span id=__span-71-18><a id=__codelineno-71-18 name=__codelineno-71-18 href=#__codelineno-71-18></a>
</span><span id=__span-71-19><a id=__codelineno-71-19 name=__codelineno-71-19 href=#__codelineno-71-19></a><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-71-20><a id=__codelineno-71-20 name=__codelineno-71-20 href=#__codelineno-71-20></a><span class=p>}</span>
</span></code></pre></div> <p>该方法也非常简单，那就是遍历所有的bucket中的所有entry，找出所有能处理dataClass、resourceClass的entry，保存其decoder。</p> <p>最后看一下<code>transcoderRegistry.get</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=nd>@NonNull</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=nf>get</span><span class=p>(</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>transcodedClass</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=w> </span><span class=c1>// For example, there may be a transcoder that can convert a GifDrawable to a Drawable, which</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=w> </span><span class=c1>// will be caught above. However, if there is no registered transcoder, we can still just use</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a><span class=w> </span><span class=c1>// the UnitTranscoder to return the Drawable because the transcode class (Drawable) is</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a><span class=w> </span><span class=c1>// assignable from the resource class (GifDrawable).</span>
</span><span id=__span-72-9><a id=__codelineno-72-9 name=__codelineno-72-9 href=#__codelineno-72-9></a><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>transcodedClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-72-10><a id=__codelineno-72-10 name=__codelineno-72-10 href=#__codelineno-72-10></a><span class=w>   </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>UnitTranscoder</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
</span><span id=__span-72-11><a id=__codelineno-72-11 name=__codelineno-72-11 href=#__codelineno-72-11></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-72-12><a id=__codelineno-72-12 name=__codelineno-72-12 href=#__codelineno-72-12></a><span class=w> </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>transcoders</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-72-13><a id=__codelineno-72-13 name=__codelineno-72-13 href=#__codelineno-72-13></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodedClass</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-72-14><a id=__codelineno-72-14 name=__codelineno-72-14 href=#__codelineno-72-14></a><span class=w>     </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>entry</span><span class=p>.</span><span class=na>transcoder</span><span class=p>;</span>
</span><span id=__span-72-15><a id=__codelineno-72-15 name=__codelineno-72-15 href=#__codelineno-72-15></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-72-16><a id=__codelineno-72-16 name=__codelineno-72-16 href=#__codelineno-72-16></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-72-17><a id=__codelineno-72-17 name=__codelineno-72-17 href=#__codelineno-72-17></a>
</span><span id=__span-72-18><a id=__codelineno-72-18 name=__codelineno-72-18 href=#__codelineno-72-18></a><span class=w> </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span>
</span><span id=__span-72-19><a id=__codelineno-72-19 name=__codelineno-72-19 href=#__codelineno-72-19></a><span class=w>     </span><span class=s>&quot;No transcoder registered to transcode from &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>resourceClass</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; to &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>transcodedClass</span><span class=p>);</span>
</span><span id=__span-72-20><a id=__codelineno-72-20 name=__codelineno-72-20 href=#__codelineno-72-20></a><span class=p>}</span>
</span></code></pre></div> <p>该方法逻辑和我们之前谈到过的<code>transcoderRegistry.getTranscodeClasses</code>方法类似，只不过返回的是对应的<code>transcoder</code>对象。</p> <p>了解到上面这些方法的作用后，我们列出<code>Registry.getDecodePaths</code>方法执行的步骤以及结果（dataClass为下面的fetcher.dataClass，resourceClass为Object.class，transcodeClass为Drawable.class）：</p> <ul> <li><code>ByteBufferFileLoader</code><br> fetcher = <code>ByteBufferFetcher(file)</code><br> fetcher.dataClass = <code>ByteBuffer.class</code><br> 1 registeredResourceClasses = <code>[GifDrawable.class, Bitmap.class, BitmapDrawable.class]</code><br> 2 registeredTranscodeClasses = <code>[[Drawable.class], [Drawable.class], [Drawable.class]]</code><br> 3 decoders = <code>[[ByteBufferGifDecoder], [ByteBufferBitmapDecoder], [BitmapDrawableDecoder]]</code><br> 4 transcoder = <code>[UnitTranscoder, BitmapDrawableTranscoder, UnitTranscoder]</code><br> 5 decodePaths = <code>[DecodePath(ByteBuffer.class, GifDrawable.class, Drawable.class, [ByteBufferGifDecoder], UnitTranscoder), DecodePath(ByteBuffer.class, Bitmap.class, Drawable.class, [ByteBufferBitmapDecoder], BitmapDrawableTranscoder), DecodePath(ByteBuffer.class, BitmapDrawable.class, Drawable.class, [BitmapDrawableDecoder], UnitTranscoder)]</code><br> 6 loadPath = <code>LoadPath(ByteBuffer.class, Object.class, Drawable.class, decodePaths)</code> </li> </ul> <p>在<code>ByteBufferFileLoader</code>中，我们已经找到一个一条可以加载的路径，那么就调用此<code>fetcher.loadData</code>方法进行加载。同时，该方法<code>ResourceCacheGenerator.startNext</code>返回true，这就意味着<code>DecodeJob</code>无需在尝试另外的<code>DataFetcherGenerator</code>进行加载，整个<code>into</code>过程已经大致完成，剩下的就是等待资源加载完毕后触发回调即可。</p> <p>下面我们接着看看<code>loadData.fetcher.loadData(helper.getPriority(), this)</code>这条语句干了什么，在上面的分析中我们知道，这里的fetcher是<code>ByteBufferFetcher</code>对象，其loadData方法如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=nd>@Override</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a><span class=w>   </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DataCallback</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>ByteBuffer</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=w> </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=w> </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a><span class=w>   </span><span class=c1>// 这里的file就是缓存下来的source file</span>
</span><span id=__span-73-7><a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a><span class=w>   </span><span class=c1>// 路径在demo中为 /data/data/yorek.demoandtest/cache/image_manager_disk_cache/65a6e0855da59221f073aba07dc6c69206834ef83f60c58062bee458fcac7dde.0</span>
</span><span id=__span-73-8><a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a><span class=w>   </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBufferUtil</span><span class=p>.</span><span class=na>fromFile</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
</span><span id=__span-73-9><a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a><span class=w> </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-73-10><a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-73-11><a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a><span class=w>     </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Failed to obtain ByteBuffer for file&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-73-12><a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a><span class=w>   </span><span class=p>}</span>
</span><span id=__span-73-13><a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a><span class=w>   </span><span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-73-14><a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a><span class=w>   </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-73-15><a id=__codelineno-73-15 name=__codelineno-73-15 href=#__codelineno-73-15></a><span class=w> </span><span class=p>}</span>
</span><span id=__span-73-16><a id=__codelineno-73-16 name=__codelineno-73-16 href=#__codelineno-73-16></a>
</span><span id=__span-73-17><a id=__codelineno-73-17 name=__codelineno-73-17 href=#__codelineno-73-17></a><span class=w> </span><span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span><span id=__span-73-18><a id=__codelineno-73-18 name=__codelineno-73-18 href=#__codelineno-73-18></a><span class=p>}</span>
</span></code></pre></div> <p><code>ByteBufferUtil.fromFile</code>使用了<code>RandomAccessFile</code>和<code>FileChannel</code>进行文件操作。如果操作失败，调用<code>callback.onLoadFailed(e)</code>通知<code>ResourceCacheGenerator</code>类，该类会将操作转发给<code>DecodeJob</code>；<code>callback.onDataReady</code>操作类似。这样程序就回到了<code>DecodeJob</code>回调方法中了。</p> <p>我们暂时不继续分析<code>DecodeJob</code>的回调方法，因为在本节中缓存文件本来是没有的，所以会交给下一个<code>DataFetcherGenerator</code>进行尝试处理，所以后面肯定也会遇到<code>DecodeJob</code>的回调方法。 </p> <h3 id=37-datacachegenerator>3.7 DataCacheGenerator<a class=headerlink href=#37-datacachegenerator title="Permanent link">&para;</a></h3> <p>由于<code>Glide-with-load-into</code>三步没有在<code>ResourceCacheGenerator</code>中被fetch，所以回到<code>DecodeJob.runGenerators</code>方法中，继续执行while循环：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>runGenerators</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=w>  </span><span class=n>currentThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=w>  </span><span class=n>startFetchTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>isStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>isStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a><span class=w>    </span><span class=n>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a><span class=w>    </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextGenerator</span><span class=p>();</span>
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a>
</span><span id=__span-74-10><a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-74-11><a id=__codelineno-74-11 name=__codelineno-74-11 href=#__codelineno-74-11></a><span class=w>      </span><span class=n>reschedule</span><span class=p>();</span>
</span><span id=__span-74-12><a id=__codelineno-74-12 name=__codelineno-74-12 href=#__codelineno-74-12></a><span class=w>      </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-74-13><a id=__codelineno-74-13 name=__codelineno-74-13 href=#__codelineno-74-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-74-14><a id=__codelineno-74-14 name=__codelineno-74-14 href=#__codelineno-74-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-74-15><a id=__codelineno-74-15 name=__codelineno-74-15 href=#__codelineno-74-15></a><span class=w>  </span><span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
</span><span id=__span-74-16><a id=__codelineno-74-16 name=__codelineno-74-16 href=#__codelineno-74-16></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isStarted</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-74-17><a id=__codelineno-74-17 name=__codelineno-74-17 href=#__codelineno-74-17></a><span class=w>    </span><span class=n>notifyFailed</span><span class=p>();</span>
</span><span id=__span-74-18><a id=__codelineno-74-18 name=__codelineno-74-18 href=#__codelineno-74-18></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-74-19><a id=__codelineno-74-19 name=__codelineno-74-19 href=#__codelineno-74-19></a>
</span><span id=__span-74-20><a id=__codelineno-74-20 name=__codelineno-74-20 href=#__codelineno-74-20></a><span class=w>  </span><span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
</span><span id=__span-74-21><a id=__codelineno-74-21 name=__codelineno-74-21 href=#__codelineno-74-21></a><span class=w>  </span><span class=c1>// onDataFetcherReady.</span>
</span><span id=__span-74-22><a id=__codelineno-74-22 name=__codelineno-74-22 href=#__codelineno-74-22></a><span class=p>}</span>
</span></code></pre></div> <p>由于<code>diskCacheStrategy</code>默认为<code>DiskCacheStrategy.AUTOMATIC</code>，其<code>decodeCachedData()</code>返回true，所以<code>getNextStage(stage)</code>是<code>Stage.DATA_CACHE</code>。因此<code>getNextGenerator()</code>方法返回了<code>DataCacheGenerator(decodeHelper, this)</code>。然后在while循环中会执行其<code>startNext()</code>方法。</p> <div class="admonition success"> <p class=admonition-title>Success</p> <p>有了在<code>ResourceCacheGenerator</code>中缓存好的大量变量，<code>DataCacheGenerator</code>和<code>SourceGenerator</code>代码就非常简单了。</p> </div> <p><code>ResourceCacheGenerator</code>在构造的时候就将<code>helper.getCacheKeys()</code>保存了起来，我们前面在谈<code>ResourceCacheGenerator</code>的时候提到过，<code>helper.getCacheKeys()</code>采取了防止重复加载的策略。</p> <p>构造器相关代码如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>;</span>
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>helper</span><span class=p>;</span>
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>FetcherReadyCallback</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a>
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>helper</span><span class=p>,</span><span class=w> </span><span class=n>FetcherReadyCallback</span><span class=w> </span><span class=n>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a><span class=w>  </span><span class=k>this</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getCacheKeys</span><span class=p>(),</span><span class=w> </span><span class=n>helper</span><span class=p>,</span><span class=w> </span><span class=n>cb</span><span class=p>);</span>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a><span class=p>}</span>
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a>
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>,</span><span class=w> </span><span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>helper</span><span class=p>,</span><span class=w> </span><span class=n>FetcherReadyCallback</span><span class=w> </span><span class=n>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>cacheKeys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>;</span>
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>helper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>;</span>
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a><span class=p>}</span>
</span></code></pre></div> <p>然后看一下它的<code>startNext()</code>方法，该方法和<code>ResourceCacheGenerator.startNext</code>方法非常相似，由于获取的是原始的源数据，所以这里的key的组成非常简单。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a><span class=nd>@Override</span>
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startNext</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a><span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>modelLoaders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a><span class=w>    </span><span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>size</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-6><a id=__codelineno-76-6 name=__codelineno-76-6 href=#__codelineno-76-6></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-76-7><a id=__codelineno-76-7 name=__codelineno-76-7 href=#__codelineno-76-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-76-8><a id=__codelineno-76-8 name=__codelineno-76-8 href=#__codelineno-76-8></a>
</span><span id=__span-76-9><a id=__codelineno-76-9 name=__codelineno-76-9 href=#__codelineno-76-9></a><span class=w>    </span><span class=n>Key</span><span class=w> </span><span class=n>sourceId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
</span><span id=__span-76-10><a id=__codelineno-76-10 name=__codelineno-76-10 href=#__codelineno-76-10></a><span class=w>    </span><span class=c1>// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times</span>
</span><span id=__span-76-11><a id=__codelineno-76-11 name=__codelineno-76-11 href=#__codelineno-76-11></a><span class=w>    </span><span class=c1>// and the actions it performs are much more expensive than a single allocation.</span>
</span><span id=__span-76-12><a id=__codelineno-76-12 name=__codelineno-76-12 href=#__codelineno-76-12></a><span class=w>    </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;</span><span class=p>)</span>
</span><span id=__span-76-13><a id=__codelineno-76-13 name=__codelineno-76-13 href=#__codelineno-76-13></a><span class=w>    </span><span class=n>Key</span><span class=w> </span><span class=n>originalKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheKey</span><span class=p>(</span><span class=n>sourceId</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
</span><span id=__span-76-14><a id=__codelineno-76-14 name=__codelineno-76-14 href=#__codelineno-76-14></a><span class=w>    </span><span class=n>cacheFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>originalKey</span><span class=p>);</span>
</span><span id=__span-76-15><a id=__codelineno-76-15 name=__codelineno-76-15 href=#__codelineno-76-15></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cacheFile</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-16><a id=__codelineno-76-16 name=__codelineno-76-16 href=#__codelineno-76-16></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>sourceKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceId</span><span class=p>;</span>
</span><span id=__span-76-17><a id=__codelineno-76-17 name=__codelineno-76-17 href=#__codelineno-76-17></a><span class=w>      </span><span class=n>modelLoaders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
</span><span id=__span-76-18><a id=__codelineno-76-18 name=__codelineno-76-18 href=#__codelineno-76-18></a><span class=w>      </span><span class=n>modelLoaderIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span><span id=__span-76-19><a id=__codelineno-76-19 name=__codelineno-76-19 href=#__codelineno-76-19></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-76-20><a id=__codelineno-76-20 name=__codelineno-76-20 href=#__codelineno-76-20></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-76-21><a id=__codelineno-76-21 name=__codelineno-76-21 href=#__codelineno-76-21></a>
</span><span id=__span-76-22><a id=__codelineno-76-22 name=__codelineno-76-22 href=#__codelineno-76-22></a><span class=w>  </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-76-23><a id=__codelineno-76-23 name=__codelineno-76-23 href=#__codelineno-76-23></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-76-24><a id=__codelineno-76-24 name=__codelineno-76-24 href=#__codelineno-76-24></a><span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>started</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-25><a id=__codelineno-76-25 name=__codelineno-76-25 href=#__codelineno-76-25></a><span class=w>    </span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span><span class=w> </span><span class=o>?&gt;</span><span class=w> </span><span class=n>modelLoader</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
</span><span id=__span-76-26><a id=__codelineno-76-26 name=__codelineno-76-26 href=#__codelineno-76-26></a><span class=w>    </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-76-27><a id=__codelineno-76-27 name=__codelineno-76-27 href=#__codelineno-76-27></a><span class=w>        </span><span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
</span><span id=__span-76-28><a id=__codelineno-76-28 name=__codelineno-76-28 href=#__codelineno-76-28></a><span class=w>            </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</span><span id=__span-76-29><a id=__codelineno-76-29 name=__codelineno-76-29 href=#__codelineno-76-29></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadData</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-30><a id=__codelineno-76-30 name=__codelineno-76-30 href=#__codelineno-76-30></a><span class=w>      </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-76-31><a id=__codelineno-76-31 name=__codelineno-76-31 href=#__codelineno-76-31></a><span class=w>      </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-76-32><a id=__codelineno-76-32 name=__codelineno-76-32 href=#__codelineno-76-32></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-76-33><a id=__codelineno-76-33 name=__codelineno-76-33 href=#__codelineno-76-33></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-76-34><a id=__codelineno-76-34 name=__codelineno-76-34 href=#__codelineno-76-34></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>started</span><span class=p>;</span>
</span><span id=__span-76-35><a id=__codelineno-76-35 name=__codelineno-76-35 href=#__codelineno-76-35></a><span class=p>}</span>
</span><span id=__span-76-36><a id=__codelineno-76-36 name=__codelineno-76-36 href=#__codelineno-76-36></a>
</span><span id=__span-76-37><a id=__codelineno-76-37 name=__codelineno-76-37 href=#__codelineno-76-37></a><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>hasNextModelLoader</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-76-38><a id=__codelineno-76-38 name=__codelineno-76-38 href=#__codelineno-76-38></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>modelLoaderIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
</span><span id=__span-76-39><a id=__codelineno-76-39 name=__codelineno-76-39 href=#__codelineno-76-39></a><span class=p>}</span>
</span></code></pre></div> <p>由于我们第一次加载，本地缓存文件肯定是没有的。我们接着看最后一个<code>SourceGenerator</code>，看看它是如何获取数据的。</p> <h3 id=38-sourcegenerator>3.8 SourceGenerator<a class=headerlink href=#38-sourcegenerator title="Permanent link">&para;</a></h3> <p>在这之前我们需要注意，如果Glide在加载时指定了<code>.onlyRetrieveFromCache(true)</code>，那么在<code>DecodeJob.getNextStage(Stage)</code>方法中就会跳过<code>Stage.SOURCE</code>直接到达<code>Stage.FINISHED</code>。<br> 且当为<code>Stage.SOURCE</code>时，<code>DecodeJob.runGenerators()</code>方法会调用<code>reschedule()</code>方法，这将会导致<code>DecodeJob</code>重新被提交到<code>sourceExecutor</code>这个线程池中，同时runReason被赋值为<code>RunReason.SWITCH_TO_SOURCE_SERVICE</code>。该线程池默认实现为<code>GlideExecutor.newSourceExecutor()</code>:</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>MAXIMUM_AUTOMATIC_THREAD_COUNT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>DEFAULT_SOURCE_EXECUTOR_NAME</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;source&quot;</span><span class=p>;</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>GlideExecutor</span><span class=w> </span><span class=nf>newSourceExecutor</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>newSourceExecutor</span><span class=p>(</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a><span class=w>      </span><span class=n>calculateBestThreadCount</span><span class=p>(),</span>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=w>      </span><span class=n>DEFAULT_SOURCE_EXECUTOR_NAME</span><span class=p>,</span>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=w>      </span><span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>);</span>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a><span class=p>}</span>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>calculateBestThreadCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bestThreadCount</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-77-13><a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a><span class=w>    </span><span class=n>bestThreadCount</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-77-14><a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=w>        </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>MAXIMUM_AUTOMATIC_THREAD_COUNT</span><span class=p>,</span><span class=w> </span><span class=n>RuntimeCompat</span><span class=p>.</span><span class=na>availableProcessors</span><span class=p>());</span>
</span><span id=__span-77-15><a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-77-16><a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>bestThreadCount</span><span class=p>;</span>
</span><span id=__span-77-17><a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a><span class=p>}</span>
</span></code></pre></div> <p>由于<code>DecodeJob</code>实现了<code>Runnable</code>接口，那么直接看<code>run()</code>方法里面的真正实现<code>runWrapped()</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>runWrapped</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a><span class=w>  </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>runReason</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a><span class=w>    </span><span class=p>...</span>
</span><span id=__span-78-4><a id=__codelineno-78-4 name=__codelineno-78-4 href=#__codelineno-78-4></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>SWITCH_TO_SOURCE_SERVICE</span><span class=p>:</span>
</span><span id=__span-78-5><a id=__codelineno-78-5 name=__codelineno-78-5 href=#__codelineno-78-5></a><span class=w>      </span><span class=n>runGenerators</span><span class=p>();</span>
</span><span id=__span-78-6><a id=__codelineno-78-6 name=__codelineno-78-6 href=#__codelineno-78-6></a><span class=w>      </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-78-7><a id=__codelineno-78-7 name=__codelineno-78-7 href=#__codelineno-78-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-78-8><a id=__codelineno-78-8 name=__codelineno-78-8 href=#__codelineno-78-8></a><span class=p>}</span>
</span></code></pre></div> <p>这里还是执行了<code>runGenerators()</code>方法。该方法我们已经很熟悉了，在这里会执行<code>SourceGenerator.startNext()</code>方法。 </p> <div class="language-java highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>loadDataListIndex</span><span class=p>;</span>
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a>
</span><span id=__span-79-3><a id=__codelineno-79-3 name=__codelineno-79-3 href=#__codelineno-79-3></a><span class=nd>@Override</span>
</span><span id=__span-79-4><a id=__codelineno-79-4 name=__codelineno-79-4 href=#__codelineno-79-4></a><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startNext</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-79-5><a id=__codelineno-79-5 name=__codelineno-79-5 href=#__codelineno-79-5></a><span class=w>  </span><span class=c1>// 首次运行dataToCache为null</span>
</span><span id=__span-79-6><a id=__codelineno-79-6 name=__codelineno-79-6 href=#__codelineno-79-6></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataToCache</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-79-7><a id=__codelineno-79-7 name=__codelineno-79-7 href=#__codelineno-79-7></a><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataToCache</span><span class=p>;</span>
</span><span id=__span-79-8><a id=__codelineno-79-8 name=__codelineno-79-8 href=#__codelineno-79-8></a><span class=w>    </span><span class=n>dataToCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-79-9><a id=__codelineno-79-9 name=__codelineno-79-9 href=#__codelineno-79-9></a><span class=w>    </span><span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-79-10><a id=__codelineno-79-10 name=__codelineno-79-10 href=#__codelineno-79-10></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-79-11><a id=__codelineno-79-11 name=__codelineno-79-11 href=#__codelineno-79-11></a>
</span><span id=__span-79-12><a id=__codelineno-79-12 name=__codelineno-79-12 href=#__codelineno-79-12></a><span class=w>  </span><span class=c1>// 首次运行sourceCacheGenerator为null</span>
</span><span id=__span-79-13><a id=__codelineno-79-13 name=__codelineno-79-13 href=#__codelineno-79-13></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-79-14><a id=__codelineno-79-14 name=__codelineno-79-14 href=#__codelineno-79-14></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-79-15><a id=__codelineno-79-15 name=__codelineno-79-15 href=#__codelineno-79-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-79-16><a id=__codelineno-79-16 name=__codelineno-79-16 href=#__codelineno-79-16></a><span class=w>  </span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-79-17><a id=__codelineno-79-17 name=__codelineno-79-17 href=#__codelineno-79-17></a>
</span><span id=__span-79-18><a id=__codelineno-79-18 name=__codelineno-79-18 href=#__codelineno-79-18></a><span class=w>  </span><span class=c1>// 准备加载数据</span>
</span><span id=__span-79-19><a id=__codelineno-79-19 name=__codelineno-79-19 href=#__codelineno-79-19></a><span class=w>  </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-79-20><a id=__codelineno-79-20 name=__codelineno-79-20 href=#__codelineno-79-20></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-79-21><a id=__codelineno-79-21 name=__codelineno-79-21 href=#__codelineno-79-21></a><span class=w>  </span><span class=c1>// 这里直接调用了DecodeHelper.getLoadData()方法</span>
</span><span id=__span-79-22><a id=__codelineno-79-22 name=__codelineno-79-22 href=#__codelineno-79-22></a><span class=w>  </span><span class=c1>// 该方法在前面在ResourceCacheGenerator中被调用过，且被缓存了下来</span>
</span><span id=__span-79-23><a id=__codelineno-79-23 name=__codelineno-79-23 href=#__codelineno-79-23></a><span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>started</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>hasNextModelLoader</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-79-24><a id=__codelineno-79-24 name=__codelineno-79-24 href=#__codelineno-79-24></a><span class=w>    </span><span class=n>loadData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getLoadData</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>loadDataListIndex</span><span class=o>++</span><span class=p>);</span>
</span><span id=__span-79-25><a id=__codelineno-79-25 name=__codelineno-79-25 href=#__codelineno-79-25></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>loadData</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-79-26><a id=__codelineno-79-26 name=__codelineno-79-26 href=#__codelineno-79-26></a><span class=w>        </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>().</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>())</span>
</span><span id=__span-79-27><a id=__codelineno-79-27 name=__codelineno-79-27 href=#__codelineno-79-27></a><span class=w>        </span><span class=o>||</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>())))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-79-28><a id=__codelineno-79-28 name=__codelineno-79-28 href=#__codelineno-79-28></a><span class=w>      </span><span class=n>started</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-79-29><a id=__codelineno-79-29 name=__codelineno-79-29 href=#__codelineno-79-29></a><span class=w>      </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-79-30><a id=__codelineno-79-30 name=__codelineno-79-30 href=#__codelineno-79-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-79-31><a id=__codelineno-79-31 name=__codelineno-79-31 href=#__codelineno-79-31></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-79-32><a id=__codelineno-79-32 name=__codelineno-79-32 href=#__codelineno-79-32></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>started</span><span class=p>;</span>
</span><span id=__span-79-33><a id=__codelineno-79-33 name=__codelineno-79-33 href=#__codelineno-79-33></a><span class=p>}</span>
</span><span id=__span-79-34><a id=__codelineno-79-34 name=__codelineno-79-34 href=#__codelineno-79-34></a>
</span><span id=__span-79-35><a id=__codelineno-79-35 name=__codelineno-79-35 href=#__codelineno-79-35></a><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>hasNextModelLoader</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-79-36><a id=__codelineno-79-36 name=__codelineno-79-36 href=#__codelineno-79-36></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>loadDataListIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getLoadData</span><span class=p>().</span><span class=na>size</span><span class=p>();</span>
</span><span id=__span-79-37><a id=__codelineno-79-37 name=__codelineno-79-37 href=#__codelineno-79-37></a><span class=p>}</span>
</span></code></pre></div> <p><code>helper.getLoadData()</code>的值在<code>ResourceCacheGenerator</code>中就已经被获取并缓存下来了，这是一个<code>MultiModelLoader</code>对象生成的<code>LoadData</code>对象，<code>LoadData</code>对象里面有两个fetcher。详见<a href=/android/3rd-library/glide2/#361-helpergetcachekeys>第3.6.1节的末尾部分</a></p> <p>在上面的方法中，我们会遍历LoadData list，找出符合条件的LoadData，然后调用<code>loadData.fetcher.loadData</code>加载数据。<br> 在loadData不为空的前提下，会判断Glide的缓存策略是否可以缓存此数据源，或者是否有加载路径。 </p> <p>我们知道，默认情况下Glide的缓存策略是<code>DiskCacheStrategy.AUTOMATIC</code>，其<code>isDataCacheable</code>实现如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a><span class=nd>@Override</span>
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isDataCacheable</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a><span class=p>}</span>
</span></code></pre></div> <p>所以，我们看一下<code>loadData.fetcher.getDataSource()</code>返回了什么：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>getDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fetchers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getDataSource</span><span class=p>();</span>
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a><span class=p>}</span>
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a><span class=c1>// MultiFetcher中fetchers数组保存的两个DataFetcher都是HttpUrlFetcher</span>
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>HttpUrlFetcher</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-81-12><a id=__codelineno-81-12 name=__codelineno-81-12 href=#__codelineno-81-12></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-81-13><a id=__codelineno-81-13 name=__codelineno-81-13 href=#__codelineno-81-13></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=nf>getDataSource</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-81-14><a id=__codelineno-81-14 name=__codelineno-81-14 href=#__codelineno-81-14></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
</span><span id=__span-81-15><a id=__codelineno-81-15 name=__codelineno-81-15 href=#__codelineno-81-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-81-16><a id=__codelineno-81-16 name=__codelineno-81-16 href=#__codelineno-81-16></a><span class=p>}</span>
</span></code></pre></div> <p>显然，Glide的缓存策略是可以缓存此数据源的。所以会进行数据的加载。接着看看<code>MultiFetcher.loadData</code>方法。<br> 这里首先会调用内部的第0个DataFetcher进行加载，同时设置回调为自己。当这一个DataFetcher加载失败时，会尝试调用下一个DataFetcher进行加载，如果没有所有的DataFetcher都加载失败了，就把错误抛给上一层；当有DataFetcher加载成功时，也会把获取到的数据转交给上一层。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>,</span><span class=w> </span><span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a>
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>fetchers</span><span class=p>;</span>
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>currentIndex</span><span class=p>;</span>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>;</span>
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>DataCallback</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>;</span>
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>loadData</span><span class=p>(</span>
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a><span class=w>      </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DataCallback</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-11><a id=__codelineno-82-11 name=__codelineno-82-11 href=#__codelineno-82-11></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>priority</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>priority</span><span class=p>;</span>
</span><span id=__span-82-12><a id=__codelineno-82-12 name=__codelineno-82-12 href=#__codelineno-82-12></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>callback</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callback</span><span class=p>;</span>
</span><span id=__span-82-13><a id=__codelineno-82-13 name=__codelineno-82-13 href=#__codelineno-82-13></a><span class=w>    </span><span class=n>exceptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>throwableListPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
</span><span id=__span-82-14><a id=__codelineno-82-14 name=__codelineno-82-14 href=#__codelineno-82-14></a><span class=w>    </span><span class=n>fetchers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>currentIndex</span><span class=p>).</span><span class=na>loadData</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-82-15><a id=__codelineno-82-15 name=__codelineno-82-15 href=#__codelineno-82-15></a>
</span><span id=__span-82-16><a id=__codelineno-82-16 name=__codelineno-82-16 href=#__codelineno-82-16></a><span class=w>    </span><span class=c1>// If a race occurred where we cancelled the fetcher in cancel() and then called loadData here</span>
</span><span id=__span-82-17><a id=__codelineno-82-17 name=__codelineno-82-17 href=#__codelineno-82-17></a><span class=w>    </span><span class=c1>// immediately after, make sure that we cancel the newly started fetcher. We don&#39;t bother</span>
</span><span id=__span-82-18><a id=__codelineno-82-18 name=__codelineno-82-18 href=#__codelineno-82-18></a><span class=w>    </span><span class=c1>// checking cancelled before loadData because it&#39;s not required for correctness and would</span>
</span><span id=__span-82-19><a id=__codelineno-82-19 name=__codelineno-82-19 href=#__codelineno-82-19></a><span class=w>    </span><span class=c1>// require an unlikely race to be useful.</span>
</span><span id=__span-82-20><a id=__codelineno-82-20 name=__codelineno-82-20 href=#__codelineno-82-20></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-21><a id=__codelineno-82-21 name=__codelineno-82-21 href=#__codelineno-82-21></a><span class=w>      </span><span class=n>cancel</span><span class=p>();</span>
</span><span id=__span-82-22><a id=__codelineno-82-22 name=__codelineno-82-22 href=#__codelineno-82-22></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-82-23><a id=__codelineno-82-23 name=__codelineno-82-23 href=#__codelineno-82-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-82-24><a id=__codelineno-82-24 name=__codelineno-82-24 href=#__codelineno-82-24></a>
</span><span id=__span-82-25><a id=__codelineno-82-25 name=__codelineno-82-25 href=#__codelineno-82-25></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-82-26><a id=__codelineno-82-26 name=__codelineno-82-26 href=#__codelineno-82-26></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataReady</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Data</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-27><a id=__codelineno-82-27 name=__codelineno-82-27 href=#__codelineno-82-27></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>data</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-28><a id=__codelineno-82-28 name=__codelineno-82-28 href=#__codelineno-82-28></a><span class=w>      </span><span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-82-29><a id=__codelineno-82-29 name=__codelineno-82-29 href=#__codelineno-82-29></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-30><a id=__codelineno-82-30 name=__codelineno-82-30 href=#__codelineno-82-30></a><span class=w>      </span><span class=n>startNextOrFail</span><span class=p>();</span>
</span><span id=__span-82-31><a id=__codelineno-82-31 name=__codelineno-82-31 href=#__codelineno-82-31></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-82-32><a id=__codelineno-82-32 name=__codelineno-82-32 href=#__codelineno-82-32></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-82-33><a id=__codelineno-82-33 name=__codelineno-82-33 href=#__codelineno-82-33></a>
</span><span id=__span-82-34><a id=__codelineno-82-34 name=__codelineno-82-34 href=#__codelineno-82-34></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-82-35><a id=__codelineno-82-35 name=__codelineno-82-35 href=#__codelineno-82-35></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-36><a id=__codelineno-82-36 name=__codelineno-82-36 href=#__codelineno-82-36></a><span class=w>    </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>exceptions</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-82-37><a id=__codelineno-82-37 name=__codelineno-82-37 href=#__codelineno-82-37></a><span class=w>    </span><span class=n>startNextOrFail</span><span class=p>();</span>
</span><span id=__span-82-38><a id=__codelineno-82-38 name=__codelineno-82-38 href=#__codelineno-82-38></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-82-39><a id=__codelineno-82-39 name=__codelineno-82-39 href=#__codelineno-82-39></a>
</span><span id=__span-82-40><a id=__codelineno-82-40 name=__codelineno-82-40 href=#__codelineno-82-40></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startNextOrFail</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-41><a id=__codelineno-82-41 name=__codelineno-82-41 href=#__codelineno-82-41></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-42><a id=__codelineno-82-42 name=__codelineno-82-42 href=#__codelineno-82-42></a><span class=w>      </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-82-43><a id=__codelineno-82-43 name=__codelineno-82-43 href=#__codelineno-82-43></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-82-44><a id=__codelineno-82-44 name=__codelineno-82-44 href=#__codelineno-82-44></a>
</span><span id=__span-82-45><a id=__codelineno-82-45 name=__codelineno-82-45 href=#__codelineno-82-45></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>currentIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>fetchers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-46><a id=__codelineno-82-46 name=__codelineno-82-46 href=#__codelineno-82-46></a><span class=w>      </span><span class=n>currentIndex</span><span class=o>++</span><span class=p>;</span>
</span><span id=__span-82-47><a id=__codelineno-82-47 name=__codelineno-82-47 href=#__codelineno-82-47></a><span class=w>      </span><span class=n>loadData</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span><span class=w> </span><span class=n>callback</span><span class=p>);</span>
</span><span id=__span-82-48><a id=__codelineno-82-48 name=__codelineno-82-48 href=#__codelineno-82-48></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-82-49><a id=__codelineno-82-49 name=__codelineno-82-49 href=#__codelineno-82-49></a><span class=w>      </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>exceptions</span><span class=p>);</span>
</span><span id=__span-82-50><a id=__codelineno-82-50 name=__codelineno-82-50 href=#__codelineno-82-50></a><span class=w>      </span><span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Fetch failed&quot;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>)));</span>
</span><span id=__span-82-51><a id=__codelineno-82-51 name=__codelineno-82-51 href=#__codelineno-82-51></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-82-52><a id=__codelineno-82-52 name=__codelineno-82-52 href=#__codelineno-82-52></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-82-53><a id=__codelineno-82-53 name=__codelineno-82-53 href=#__codelineno-82-53></a><span class=p>}</span>
</span></code></pre></div> <p>这里面两个DataFetcher都是参数相同的<code>HttpUrlFetcher</code>实例，我们直接看里面如何从网络加载图片的。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-83-1><a id=__codelineno-83-1 name=__codelineno-83-1 href=#__codelineno-83-1></a><span class=nd>@Override</span>
</span><span id=__span-83-2><a id=__codelineno-83-2 name=__codelineno-83-2 href=#__codelineno-83-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Priority</span><span class=w> </span><span class=n>priority</span><span class=p>,</span>
</span><span id=__span-83-3><a id=__codelineno-83-3 name=__codelineno-83-3 href=#__codelineno-83-3></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>DataCallback</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>InputStream</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-4><a id=__codelineno-83-4 name=__codelineno-83-4 href=#__codelineno-83-4></a><span class=w>  </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
</span><span id=__span-83-5><a id=__codelineno-83-5 name=__codelineno-83-5 href=#__codelineno-83-5></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-6><a id=__codelineno-83-6 name=__codelineno-83-6 href=#__codelineno-83-6></a><span class=w>    </span><span class=n>InputStream</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>glideUrl</span><span class=p>.</span><span class=na>toURL</span><span class=p>(),</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>,</span><span class=w> </span><span class=n>glideUrl</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>());</span>
</span><span id=__span-83-7><a id=__codelineno-83-7 name=__codelineno-83-7 href=#__codelineno-83-7></a><span class=w>    </span><span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
</span><span id=__span-83-8><a id=__codelineno-83-8 name=__codelineno-83-8 href=#__codelineno-83-8></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-9><a id=__codelineno-83-9 name=__codelineno-83-9 href=#__codelineno-83-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-10><a id=__codelineno-83-10 name=__codelineno-83-10 href=#__codelineno-83-10></a><span class=w>      </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Failed to load data for url&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-83-11><a id=__codelineno-83-11 name=__codelineno-83-11 href=#__codelineno-83-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-83-12><a id=__codelineno-83-12 name=__codelineno-83-12 href=#__codelineno-83-12></a><span class=w>    </span><span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-83-13><a id=__codelineno-83-13 name=__codelineno-83-13 href=#__codelineno-83-13></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-14><a id=__codelineno-83-14 name=__codelineno-83-14 href=#__codelineno-83-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-83-15><a id=__codelineno-83-15 name=__codelineno-83-15 href=#__codelineno-83-15></a><span class=w>      </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Finished http url fetcher fetch in &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span><span id=__span-83-16><a id=__codelineno-83-16 name=__codelineno-83-16 href=#__codelineno-83-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-83-17><a id=__codelineno-83-17 name=__codelineno-83-17 href=#__codelineno-83-17></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-83-18><a id=__codelineno-83-18 name=__codelineno-83-18 href=#__codelineno-83-18></a><span class=p>}</span>
</span></code></pre></div> <p>很显然，这里将请求操作放到了<code>loadDataWithRedirects</code>方法中，然后将请求结果通过回调返回上一层也就是<code>MultiFetcher</code>中。 </p> <p><code>loadDataWithRedirects</code>第二个参数表示重定向的次数，在方法内部限制了重定向发生的次数不能超过<code>MAXIMUM_REDIRECTS=5</code>次。<br> 第三个参数是发生重定向前的原始url，用来与当前url判断，是不是重定向到自身了。而且可以看出，Glide加载网络图片使用的是<code>HttpUrlConnection</code>。<br> 第四个参数headers默认为<code>Headers.DEFAULT</code>，就是一个User-Agent的key-value对。</p> <p>代码如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-84-1><a id=__codelineno-84-1 name=__codelineno-84-1 href=#__codelineno-84-1></a><span class=kd>private</span><span class=w> </span><span class=n>InputStream</span><span class=w> </span><span class=nf>loadDataWithRedirects</span><span class=p>(</span><span class=n>URL</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>redirects</span><span class=p>,</span><span class=w> </span><span class=n>URL</span><span class=w> </span><span class=n>lastUrl</span><span class=p>,</span>
</span><span id=__span-84-2><a id=__codelineno-84-2 name=__codelineno-84-2 href=#__codelineno-84-2></a><span class=w>    </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>headers</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-3><a id=__codelineno-84-3 name=__codelineno-84-3 href=#__codelineno-84-3></a><span class=w>  </span><span class=c1>// 检查重定向次数</span>
</span><span id=__span-84-4><a id=__codelineno-84-4 name=__codelineno-84-4 href=#__codelineno-84-4></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>redirects</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>MAXIMUM_REDIRECTS</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-5><a id=__codelineno-84-5 name=__codelineno-84-5 href=#__codelineno-84-5></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;Too many (&gt; &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MAXIMUM_REDIRECTS</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;) redirects!&quot;</span><span class=p>);</span>
</span><span id=__span-84-6><a id=__codelineno-84-6 name=__codelineno-84-6 href=#__codelineno-84-6></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-7><a id=__codelineno-84-7 name=__codelineno-84-7 href=#__codelineno-84-7></a><span class=w>    </span><span class=c1>// Comparing the URLs using .equals performs additional network I/O and is generally broken.</span>
</span><span id=__span-84-8><a id=__codelineno-84-8 name=__codelineno-84-8 href=#__codelineno-84-8></a><span class=w>    </span><span class=c1>// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.</span>
</span><span id=__span-84-9><a id=__codelineno-84-9 name=__codelineno-84-9 href=#__codelineno-84-9></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-10><a id=__codelineno-84-10 name=__codelineno-84-10 href=#__codelineno-84-10></a><span class=w>      </span><span class=c1>// 检查是不是重定向到自身了</span>
</span><span id=__span-84-11><a id=__codelineno-84-11 name=__codelineno-84-11 href=#__codelineno-84-11></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lastUrl</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>url</span><span class=p>.</span><span class=na>toURI</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>lastUrl</span><span class=p>.</span><span class=na>toURI</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-12><a id=__codelineno-84-12 name=__codelineno-84-12 href=#__codelineno-84-12></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;In re-direct loop&quot;</span><span class=p>);</span>
</span><span id=__span-84-13><a id=__codelineno-84-13 name=__codelineno-84-13 href=#__codelineno-84-13></a>
</span><span id=__span-84-14><a id=__codelineno-84-14 name=__codelineno-84-14 href=#__codelineno-84-14></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-84-15><a id=__codelineno-84-15 name=__codelineno-84-15 href=#__codelineno-84-15></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>URISyntaxException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-16><a id=__codelineno-84-16 name=__codelineno-84-16 href=#__codelineno-84-16></a><span class=w>      </span><span class=c1>// Do nothing, this is best effort.</span>
</span><span id=__span-84-17><a id=__codelineno-84-17 name=__codelineno-84-17 href=#__codelineno-84-17></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-84-18><a id=__codelineno-84-18 name=__codelineno-84-18 href=#__codelineno-84-18></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-84-19><a id=__codelineno-84-19 name=__codelineno-84-19 href=#__codelineno-84-19></a>
</span><span id=__span-84-20><a id=__codelineno-84-20 name=__codelineno-84-20 href=#__codelineno-84-20></a><span class=w>  </span><span class=c1>// connectionFactory默认是DefaultHttpUrlConnectionFactory</span>
</span><span id=__span-84-21><a id=__codelineno-84-21 name=__codelineno-84-21 href=#__codelineno-84-21></a><span class=w>  </span><span class=c1>// 其build方法就是调用了url.openConnection()</span>
</span><span id=__span-84-22><a id=__codelineno-84-22 name=__codelineno-84-22 href=#__codelineno-84-22></a><span class=w>  </span><span class=n>urlConnection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connectionFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
</span><span id=__span-84-23><a id=__codelineno-84-23 name=__codelineno-84-23 href=#__codelineno-84-23></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>headerEntry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>headers</span><span class=p>.</span><span class=na>entrySet</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-24><a id=__codelineno-84-24 name=__codelineno-84-24 href=#__codelineno-84-24></a><span class=w>    </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>addRequestProperty</span><span class=p>(</span><span class=n>headerEntry</span><span class=p>.</span><span class=na>getKey</span><span class=p>(),</span><span class=w> </span><span class=n>headerEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>());</span>
</span><span id=__span-84-25><a id=__codelineno-84-25 name=__codelineno-84-25 href=#__codelineno-84-25></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-84-26><a id=__codelineno-84-26 name=__codelineno-84-26 href=#__codelineno-84-26></a><span class=w>  </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>setConnectTimeout</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-84-27><a id=__codelineno-84-27 name=__codelineno-84-27 href=#__codelineno-84-27></a><span class=w>  </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>setReadTimeout</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
</span><span id=__span-84-28><a id=__codelineno-84-28 name=__codelineno-84-28 href=#__codelineno-84-28></a><span class=w>  </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>setUseCaches</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-84-29><a id=__codelineno-84-29 name=__codelineno-84-29 href=#__codelineno-84-29></a><span class=w>  </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>setDoInput</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
</span><span id=__span-84-30><a id=__codelineno-84-30 name=__codelineno-84-30 href=#__codelineno-84-30></a>
</span><span id=__span-84-31><a id=__codelineno-84-31 name=__codelineno-84-31 href=#__codelineno-84-31></a><span class=w>  </span><span class=c1>// Stop the urlConnection instance of HttpUrlConnection from following redirects so that</span>
</span><span id=__span-84-32><a id=__codelineno-84-32 name=__codelineno-84-32 href=#__codelineno-84-32></a><span class=w>  </span><span class=c1>// redirects will be handled by recursive calls to this method, loadDataWithRedirects.</span>
</span><span id=__span-84-33><a id=__codelineno-84-33 name=__codelineno-84-33 href=#__codelineno-84-33></a><span class=w>  </span><span class=c1>// 禁止HttpUrlConnection自动重定向，重定向功能由本方法自己实现</span>
</span><span id=__span-84-34><a id=__codelineno-84-34 name=__codelineno-84-34 href=#__codelineno-84-34></a><span class=w>  </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>setInstanceFollowRedirects</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
</span><span id=__span-84-35><a id=__codelineno-84-35 name=__codelineno-84-35 href=#__codelineno-84-35></a>
</span><span id=__span-84-36><a id=__codelineno-84-36 name=__codelineno-84-36 href=#__codelineno-84-36></a><span class=w>  </span><span class=c1>// Connect explicitly to avoid errors in decoders if connection fails.</span>
</span><span id=__span-84-37><a id=__codelineno-84-37 name=__codelineno-84-37 href=#__codelineno-84-37></a><span class=w>  </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>connect</span><span class=p>();</span>
</span><span id=__span-84-38><a id=__codelineno-84-38 name=__codelineno-84-38 href=#__codelineno-84-38></a><span class=w>  </span><span class=c1>// Set the stream so that it&#39;s closed in cleanup to avoid resource leaks. See #2352.</span>
</span><span id=__span-84-39><a id=__codelineno-84-39 name=__codelineno-84-39 href=#__codelineno-84-39></a><span class=w>  </span><span class=n>stream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>();</span>
</span><span id=__span-84-40><a id=__codelineno-84-40 name=__codelineno-84-40 href=#__codelineno-84-40></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-41><a id=__codelineno-84-41 name=__codelineno-84-41 href=#__codelineno-84-41></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-84-42><a id=__codelineno-84-42 name=__codelineno-84-42 href=#__codelineno-84-42></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-84-43><a id=__codelineno-84-43 name=__codelineno-84-43 href=#__codelineno-84-43></a><span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>statusCode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>getResponseCode</span><span class=p>();</span>
</span><span id=__span-84-44><a id=__codelineno-84-44 name=__codelineno-84-44 href=#__codelineno-84-44></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isHttpOk</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-45><a id=__codelineno-84-45 name=__codelineno-84-45 href=#__codelineno-84-45></a><span class=w>    </span><span class=c1>// statusCode=2xx，请求成功</span>
</span><span id=__span-84-46><a id=__codelineno-84-46 name=__codelineno-84-46 href=#__codelineno-84-46></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>getStreamForSuccessfulRequest</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>);</span>
</span><span id=__span-84-47><a id=__codelineno-84-47 name=__codelineno-84-47 href=#__codelineno-84-47></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isHttpRedirect</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-48><a id=__codelineno-84-48 name=__codelineno-84-48 href=#__codelineno-84-48></a><span class=w>    </span><span class=c1>// statusCode=3xx，需要重定向</span>
</span><span id=__span-84-49><a id=__codelineno-84-49 name=__codelineno-84-49 href=#__codelineno-84-49></a><span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>redirectUrlString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>urlConnection</span><span class=p>.</span><span class=na>getHeaderField</span><span class=p>(</span><span class=s>&quot;Location&quot;</span><span class=p>);</span>
</span><span id=__span-84-50><a id=__codelineno-84-50 name=__codelineno-84-50 href=#__codelineno-84-50></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>redirectUrlString</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-51><a id=__codelineno-84-51 name=__codelineno-84-51 href=#__codelineno-84-51></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;Received empty or null redirect url&quot;</span><span class=p>);</span>
</span><span id=__span-84-52><a id=__codelineno-84-52 name=__codelineno-84-52 href=#__codelineno-84-52></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-84-53><a id=__codelineno-84-53 name=__codelineno-84-53 href=#__codelineno-84-53></a><span class=w>    </span><span class=n>URL</span><span class=w> </span><span class=n>redirectUrl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>URL</span><span class=p>(</span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>redirectUrlString</span><span class=p>);</span>
</span><span id=__span-84-54><a id=__codelineno-84-54 name=__codelineno-84-54 href=#__codelineno-84-54></a><span class=w>    </span><span class=c1>// Closing the stream specifically is required to avoid leaking ResponseBodys in addition</span>
</span><span id=__span-84-55><a id=__codelineno-84-55 name=__codelineno-84-55 href=#__codelineno-84-55></a><span class=w>    </span><span class=c1>// to disconnecting the url connection below. See #2352.</span>
</span><span id=__span-84-56><a id=__codelineno-84-56 name=__codelineno-84-56 href=#__codelineno-84-56></a><span class=w>    </span><span class=n>cleanup</span><span class=p>();</span>
</span><span id=__span-84-57><a id=__codelineno-84-57 name=__codelineno-84-57 href=#__codelineno-84-57></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>redirectUrl</span><span class=p>,</span><span class=w> </span><span class=n>redirects</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>url</span><span class=p>,</span><span class=w> </span><span class=n>headers</span><span class=p>);</span>
</span><span id=__span-84-58><a id=__codelineno-84-58 name=__codelineno-84-58 href=#__codelineno-84-58></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>statusCode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>INVALID_STATUS_CODE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-59><a id=__codelineno-84-59 name=__codelineno-84-59 href=#__codelineno-84-59></a><span class=w>    </span><span class=c1>// -1 表示不是HTTP响应</span>
</span><span id=__span-84-60><a id=__codelineno-84-60 name=__codelineno-84-60 href=#__codelineno-84-60></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpException</span><span class=p>(</span><span class=n>statusCode</span><span class=p>);</span>
</span><span id=__span-84-61><a id=__codelineno-84-61 name=__codelineno-84-61 href=#__codelineno-84-61></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-62><a id=__codelineno-84-62 name=__codelineno-84-62 href=#__codelineno-84-62></a><span class=w>    </span><span class=c1>// 其他HTTP错误</span>
</span><span id=__span-84-63><a id=__codelineno-84-63 name=__codelineno-84-63 href=#__codelineno-84-63></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HttpException</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>.</span><span class=na>getResponseMessage</span><span class=p>(),</span><span class=w> </span><span class=n>statusCode</span><span class=p>);</span>
</span><span id=__span-84-64><a id=__codelineno-84-64 name=__codelineno-84-64 href=#__codelineno-84-64></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-84-65><a id=__codelineno-84-65 name=__codelineno-84-65 href=#__codelineno-84-65></a><span class=p>}</span>
</span><span id=__span-84-66><a id=__codelineno-84-66 name=__codelineno-84-66 href=#__codelineno-84-66></a>
</span><span id=__span-84-67><a id=__codelineno-84-67 name=__codelineno-84-67 href=#__codelineno-84-67></a><span class=c1>// Referencing constants is less clear than a simple static method.</span>
</span><span id=__span-84-68><a id=__codelineno-84-68 name=__codelineno-84-68 href=#__codelineno-84-68></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isHttpOk</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>statusCode</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-69><a id=__codelineno-84-69 name=__codelineno-84-69 href=#__codelineno-84-69></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>statusCode</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span><span id=__span-84-70><a id=__codelineno-84-70 name=__codelineno-84-70 href=#__codelineno-84-70></a><span class=p>}</span>
</span><span id=__span-84-71><a id=__codelineno-84-71 name=__codelineno-84-71 href=#__codelineno-84-71></a>
</span><span id=__span-84-72><a id=__codelineno-84-72 name=__codelineno-84-72 href=#__codelineno-84-72></a><span class=c1>// Referencing constants is less clear than a simple static method.</span>
</span><span id=__span-84-73><a id=__codelineno-84-73 name=__codelineno-84-73 href=#__codelineno-84-73></a><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isHttpRedirect</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>statusCode</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-84-74><a id=__codelineno-84-74 name=__codelineno-84-74 href=#__codelineno-84-74></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>statusCode</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>3</span><span class=p>;</span>
</span><span id=__span-84-75><a id=__codelineno-84-75 name=__codelineno-84-75 href=#__codelineno-84-75></a><span class=p>}</span>
</span></code></pre></div> <p>现在我们已经获得网络图片的InputStream了，该资源会通过回调经过<code>MultiFetcher</code>到达<code>SourceGenerator</code>中。 </p> <p>下面是<code>DataCallback</code>回调在<code>SourceGenerator</code>中的实现。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-85-1><a id=__codelineno-85-1 name=__codelineno-85-1 href=#__codelineno-85-1></a><span class=nd>@Override</span>
</span><span id=__span-85-2><a id=__codelineno-85-2 name=__codelineno-85-2 href=#__codelineno-85-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-85-3><a id=__codelineno-85-3 name=__codelineno-85-3 href=#__codelineno-85-3></a><span class=w>  </span><span class=n>DiskCacheStrategy</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
</span><span id=__span-85-4><a id=__codelineno-85-4 name=__codelineno-85-4 href=#__codelineno-85-4></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>data</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-85-5><a id=__codelineno-85-5 name=__codelineno-85-5 href=#__codelineno-85-5></a><span class=w>    </span><span class=n>dataToCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-85-6><a id=__codelineno-85-6 name=__codelineno-85-6 href=#__codelineno-85-6></a><span class=w>    </span><span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
</span><span id=__span-85-7><a id=__codelineno-85-7 name=__codelineno-85-7 href=#__codelineno-85-7></a><span class=w>    </span><span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
</span><span id=__span-85-8><a id=__codelineno-85-8 name=__codelineno-85-8 href=#__codelineno-85-8></a><span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
</span><span id=__span-85-9><a id=__codelineno-85-9 name=__codelineno-85-9 href=#__codelineno-85-9></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-85-10><a id=__codelineno-85-10 name=__codelineno-85-10 href=#__codelineno-85-10></a><span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
</span><span id=__span-85-11><a id=__codelineno-85-11 name=__codelineno-85-11 href=#__codelineno-85-11></a><span class=w>        </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span><span class=w> </span><span class=n>originalKey</span><span class=p>);</span>
</span><span id=__span-85-12><a id=__codelineno-85-12 name=__codelineno-85-12 href=#__codelineno-85-12></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-85-13><a id=__codelineno-85-13 name=__codelineno-85-13 href=#__codelineno-85-13></a><span class=p>}</span>
</span><span id=__span-85-14><a id=__codelineno-85-14 name=__codelineno-85-14 href=#__codelineno-85-14></a>
</span><span id=__span-85-15><a id=__codelineno-85-15 name=__codelineno-85-15 href=#__codelineno-85-15></a><span class=nd>@Override</span>
</span><span id=__span-85-16><a id=__codelineno-85-16 name=__codelineno-85-16 href=#__codelineno-85-16></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-85-17><a id=__codelineno-85-17 name=__codelineno-85-17 href=#__codelineno-85-17></a><span class=w>  </span><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherFailed</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>());</span>
</span><span id=__span-85-18><a id=__codelineno-85-18 name=__codelineno-85-18 href=#__codelineno-85-18></a><span class=p>}</span>
</span></code></pre></div> <p><code>onLoadFailed</code>很简单，直接调用<code>DecodeJob.onDataFetcherFailed</code>方法。<code>onDataReady</code>方法会首先判data能不能缓存，若能缓存则缓存起来，然后调用<code>DataCacheGenerator</code>进行加载缓存；若不能缓存，则直接调用<code>DecodeJob.onDataFetcherReady</code>方法通知外界data已经准备好了。</p> <p>我们解读一下<code>onDataReady</code>里面的代码。首先，获取<code>DiskCacheStrategy</code>判断能不能被缓存，这里的判断代码在<code>SourceGenerator.startNext()</code>中出现过，显然是可以的。然后将data保存到<code>dataToCache</code>，并调用<code>cb.reschedule()</code>。<br> <code>cb.reschedule()</code>我们在前面分析过，该方法的作用就是将<code>DecodeJob</code>提交到Glide的source线程池中。然后执行<code>DecodeJob.run()</code>方法，经过<code>runWrapped()</code>、 <code>runGenerators()</code>方法后，又回到了<code>SourceGenerator.startNext()</code>方法。</p> <p>在方法的开头，会判断<code>dataToCache</code>是否为空，此时显然不为空，所以会调用<code>cacheData(Object)</code>方法进行data的缓存处理。缓存完毕后，会为该缓存文件生成一个<code>SourceCacheGenerator</code>。然后在<code>startNext()</code>方法中会直接调用该变量进行加载。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-86-1><a id=__codelineno-86-1 name=__codelineno-86-1 href=#__codelineno-86-1></a><span class=nd>@Override</span>
</span><span id=__span-86-2><a id=__codelineno-86-2 name=__codelineno-86-2 href=#__codelineno-86-2></a><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startNext</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-3><a id=__codelineno-86-3 name=__codelineno-86-3 href=#__codelineno-86-3></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataToCache</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-4><a id=__codelineno-86-4 name=__codelineno-86-4 href=#__codelineno-86-4></a><span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataToCache</span><span class=p>;</span>
</span><span id=__span-86-5><a id=__codelineno-86-5 name=__codelineno-86-5 href=#__codelineno-86-5></a><span class=w>    </span><span class=n>dataToCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-86-6><a id=__codelineno-86-6 name=__codelineno-86-6 href=#__codelineno-86-6></a><span class=w>    </span><span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-86-7><a id=__codelineno-86-7 name=__codelineno-86-7 href=#__codelineno-86-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-86-8><a id=__codelineno-86-8 name=__codelineno-86-8 href=#__codelineno-86-8></a>
</span><span id=__span-86-9><a id=__codelineno-86-9 name=__codelineno-86-9 href=#__codelineno-86-9></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-10><a id=__codelineno-86-10 name=__codelineno-86-10 href=#__codelineno-86-10></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-86-11><a id=__codelineno-86-11 name=__codelineno-86-11 href=#__codelineno-86-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-86-12><a id=__codelineno-86-12 name=__codelineno-86-12 href=#__codelineno-86-12></a><span class=w>  </span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-86-13><a id=__codelineno-86-13 name=__codelineno-86-13 href=#__codelineno-86-13></a><span class=p>}</span>
</span><span id=__span-86-14><a id=__codelineno-86-14 name=__codelineno-86-14 href=#__codelineno-86-14></a>
</span><span id=__span-86-15><a id=__codelineno-86-15 name=__codelineno-86-15 href=#__codelineno-86-15></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cacheData</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>dataToCache</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-16><a id=__codelineno-86-16 name=__codelineno-86-16 href=#__codelineno-86-16></a><span class=w>  </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
</span><span id=__span-86-17><a id=__codelineno-86-17 name=__codelineno-86-17 href=#__codelineno-86-17></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-18><a id=__codelineno-86-18 name=__codelineno-86-18 href=#__codelineno-86-18></a><span class=w>    </span><span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getSourceEncoder</span><span class=p>(</span><span class=n>dataToCache</span><span class=p>);</span>
</span><span id=__span-86-19><a id=__codelineno-86-19 name=__codelineno-86-19 href=#__codelineno-86-19></a><span class=w>    </span><span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-86-20><a id=__codelineno-86-20 name=__codelineno-86-20 href=#__codelineno-86-20></a><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span><span class=w> </span><span class=n>dataToCache</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</span><span id=__span-86-21><a id=__codelineno-86-21 name=__codelineno-86-21 href=#__codelineno-86-21></a><span class=w>    </span><span class=n>originalKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheKey</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
</span><span id=__span-86-22><a id=__codelineno-86-22 name=__codelineno-86-22 href=#__codelineno-86-22></a><span class=w>    </span><span class=c1>// 缓存data</span>
</span><span id=__span-86-23><a id=__codelineno-86-23 name=__codelineno-86-23 href=#__codelineno-86-23></a><span class=w>    </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span><span class=w> </span><span class=n>writer</span><span class=p>);</span>
</span><span id=__span-86-24><a id=__codelineno-86-24 name=__codelineno-86-24 href=#__codelineno-86-24></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-25><a id=__codelineno-86-25 name=__codelineno-86-25 href=#__codelineno-86-25></a><span class=w>      </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Finished encoding source to cache&quot;</span>
</span><span id=__span-86-26><a id=__codelineno-86-26 name=__codelineno-86-26 href=#__codelineno-86-26></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, key: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>originalKey</span>
</span><span id=__span-86-27><a id=__codelineno-86-27 name=__codelineno-86-27 href=#__codelineno-86-27></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, data: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>dataToCache</span>
</span><span id=__span-86-28><a id=__codelineno-86-28 name=__codelineno-86-28 href=#__codelineno-86-28></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, encoder: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encoder</span>
</span><span id=__span-86-29><a id=__codelineno-86-29 name=__codelineno-86-29 href=#__codelineno-86-29></a><span class=w>          </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, duration: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
</span><span id=__span-86-30><a id=__codelineno-86-30 name=__codelineno-86-30 href=#__codelineno-86-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-86-31><a id=__codelineno-86-31 name=__codelineno-86-31 href=#__codelineno-86-31></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-86-32><a id=__codelineno-86-32 name=__codelineno-86-32 href=#__codelineno-86-32></a><span class=w>    </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-86-33><a id=__codelineno-86-33 name=__codelineno-86-33 href=#__codelineno-86-33></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-86-34><a id=__codelineno-86-34 name=__codelineno-86-34 href=#__codelineno-86-34></a>
</span><span id=__span-86-35><a id=__codelineno-86-35 name=__codelineno-86-35 href=#__codelineno-86-35></a><span class=w>  </span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-86-36><a id=__codelineno-86-36 name=__codelineno-86-36 href=#__codelineno-86-36></a><span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>),</span><span class=w> </span><span class=n>helper</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-86-37><a id=__codelineno-86-37 name=__codelineno-86-37 href=#__codelineno-86-37></a><span class=p>}</span>
</span></code></pre></div> <p>由于在构造<code>DataCacheGenerator</code>时，指定了<code>FetcherReadyCallback</code>为自己，所以<code>DataCacheGenerator</code>加载结果会由<code>SourceGenerator</code>转发给<code>DecodeJob</code>。<br> 由于资源会由<code>DataCacheGenerator</code>解码，所以我们可以在代码中看到，返回的data source是<code>DataSource.DATA_DISK_CACHE</code>。</p> <h3 id=39-decodejobfetcherreadycallback>3.9 DecodeJob.FetcherReadyCallback<a class=headerlink href=#39-decodejobfetcherreadycallback title="Permanent link">&para;</a></h3> <p>我们先看一下fetch失败时干了什么，然后在看成功的时候。因为失败的代码比较简单。</p> <p><code>onDataFetcherFailed</code>代码如下：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-87-1><a id=__codelineno-87-1 name=__codelineno-87-1 href=#__codelineno-87-1></a><span class=nd>@Override</span>
</span><span id=__span-87-2><a id=__codelineno-87-2 name=__codelineno-87-2 href=#__codelineno-87-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataFetcherFailed</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>attemptedKey</span><span class=p>,</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>fetcher</span><span class=p>,</span>
</span><span id=__span-87-3><a id=__codelineno-87-3 name=__codelineno-87-3 href=#__codelineno-87-3></a><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-87-4><a id=__codelineno-87-4 name=__codelineno-87-4 href=#__codelineno-87-4></a><span class=w>  </span><span class=n>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-87-5><a id=__codelineno-87-5 name=__codelineno-87-5 href=#__codelineno-87-5></a><span class=w>  </span><span class=n>GlideException</span><span class=w> </span><span class=n>exception</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Fetching data failed&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-87-6><a id=__codelineno-87-6 name=__codelineno-87-6 href=#__codelineno-87-6></a><span class=w>  </span><span class=n>exception</span><span class=p>.</span><span class=na>setLoggingDetails</span><span class=p>(</span><span class=n>attemptedKey</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>());</span>
</span><span id=__span-87-7><a id=__codelineno-87-7 name=__codelineno-87-7 href=#__codelineno-87-7></a><span class=w>  </span><span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
</span><span id=__span-87-8><a id=__codelineno-87-8 name=__codelineno-87-8 href=#__codelineno-87-8></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>currentThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-87-9><a id=__codelineno-87-9 name=__codelineno-87-9 href=#__codelineno-87-9></a><span class=w>    </span><span class=n>runReason</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RunReason</span><span class=p>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=p>;</span>
</span><span id=__span-87-10><a id=__codelineno-87-10 name=__codelineno-87-10 href=#__codelineno-87-10></a><span class=w>    </span><span class=n>callback</span><span class=p>.</span><span class=na>reschedule</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-87-11><a id=__codelineno-87-11 name=__codelineno-87-11 href=#__codelineno-87-11></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-87-12><a id=__codelineno-87-12 name=__codelineno-87-12 href=#__codelineno-87-12></a><span class=w>    </span><span class=n>runGenerators</span><span class=p>();</span>
</span><span id=__span-87-13><a id=__codelineno-87-13 name=__codelineno-87-13 href=#__codelineno-87-13></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-87-14><a id=__codelineno-87-14 name=__codelineno-87-14 href=#__codelineno-87-14></a><span class=p>}</span>
</span></code></pre></div> <p>显然，如果fetch失败了，如果不在source线程池中就会切换到source线程，然后重新调用<code>runGenerators()</code>方法尝试使用下一个<code>DataFetcherGenerator</code>进行加载，一直到没有一个可以加载，这时会调用<code>notifyFailed()</code>方法，正式宣告加载失败。</p> <p>然后在看成功的时候：<code>onDataFetcherReady</code>方法会保存传入的参数，然后确认执行线程后调用<code>decodeFromRetrievedData()</code>方法进行解码。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-88-1><a id=__codelineno-88-1 name=__codelineno-88-1 href=#__codelineno-88-1></a><span class=nd>@Override</span>
</span><span id=__span-88-2><a id=__codelineno-88-2 name=__codelineno-88-2 href=#__codelineno-88-2></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataFetcherReady</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>fetcher</span><span class=p>,</span>
</span><span id=__span-88-3><a id=__codelineno-88-3 name=__codelineno-88-3 href=#__codelineno-88-3></a><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>attemptedKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-88-4><a id=__codelineno-88-4 name=__codelineno-88-4 href=#__codelineno-88-4></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>currentSourceKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sourceKey</span><span class=p>;</span>
</span><span id=__span-88-5><a id=__codelineno-88-5 name=__codelineno-88-5 href=#__codelineno-88-5></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>currentData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span>
</span><span id=__span-88-6><a id=__codelineno-88-6 name=__codelineno-88-6 href=#__codelineno-88-6></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>currentFetcher</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fetcher</span><span class=p>;</span>
</span><span id=__span-88-7><a id=__codelineno-88-7 name=__codelineno-88-7 href=#__codelineno-88-7></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>currentDataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span>
</span><span id=__span-88-8><a id=__codelineno-88-8 name=__codelineno-88-8 href=#__codelineno-88-8></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>currentAttemptingKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>attemptedKey</span><span class=p>;</span>
</span><span id=__span-88-9><a id=__codelineno-88-9 name=__codelineno-88-9 href=#__codelineno-88-9></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>currentThread</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-88-10><a id=__codelineno-88-10 name=__codelineno-88-10 href=#__codelineno-88-10></a><span class=w>    </span><span class=n>runReason</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>RunReason</span><span class=p>.</span><span class=na>DECODE_DATA</span><span class=p>;</span>
</span><span id=__span-88-11><a id=__codelineno-88-11 name=__codelineno-88-11 href=#__codelineno-88-11></a><span class=w>    </span><span class=n>callback</span><span class=p>.</span><span class=na>reschedule</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-88-12><a id=__codelineno-88-12 name=__codelineno-88-12 href=#__codelineno-88-12></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-88-13><a id=__codelineno-88-13 name=__codelineno-88-13 href=#__codelineno-88-13></a><span class=w>    </span><span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=s>&quot;DecodeJob.decodeFromRetrievedData&quot;</span><span class=p>);</span>
</span><span id=__span-88-14><a id=__codelineno-88-14 name=__codelineno-88-14 href=#__codelineno-88-14></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-88-15><a id=__codelineno-88-15 name=__codelineno-88-15 href=#__codelineno-88-15></a><span class=w>      </span><span class=n>decodeFromRetrievedData</span><span class=p>();</span>
</span><span id=__span-88-16><a id=__codelineno-88-16 name=__codelineno-88-16 href=#__codelineno-88-16></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-88-17><a id=__codelineno-88-17 name=__codelineno-88-17 href=#__codelineno-88-17></a><span class=w>      </span><span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
</span><span id=__span-88-18><a id=__codelineno-88-18 name=__codelineno-88-18 href=#__codelineno-88-18></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-88-19><a id=__codelineno-88-19 name=__codelineno-88-19 href=#__codelineno-88-19></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-88-20><a id=__codelineno-88-20 name=__codelineno-88-20 href=#__codelineno-88-20></a><span class=p>}</span>
</span></code></pre></div> <p><code>decodeFromRetrievedData()</code>方法会先调用<code>decodeFromData</code>方法进行解码，然后调用<code>notifyEncodeAndRelease</code>方法进行缓存，同时也会通知<code>EngineJob</code>资源已经准备好了。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-89-1><a id=__codelineno-89-1 name=__codelineno-89-1 href=#__codelineno-89-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decodeFromRetrievedData</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-89-2><a id=__codelineno-89-2 name=__codelineno-89-2 href=#__codelineno-89-2></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-89-3><a id=__codelineno-89-3 name=__codelineno-89-3 href=#__codelineno-89-3></a><span class=w>    </span><span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Retrieved data&quot;</span><span class=p>,</span><span class=w> </span><span class=n>startFetchTime</span><span class=p>,</span>
</span><span id=__span-89-4><a id=__codelineno-89-4 name=__codelineno-89-4 href=#__codelineno-89-4></a><span class=w>        </span><span class=s>&quot;data: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>currentData</span>
</span><span id=__span-89-5><a id=__codelineno-89-5 name=__codelineno-89-5 href=#__codelineno-89-5></a><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, cache key: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>currentSourceKey</span>
</span><span id=__span-89-6><a id=__codelineno-89-6 name=__codelineno-89-6 href=#__codelineno-89-6></a><span class=w>            </span><span class=o>+</span><span class=w> </span><span class=s>&quot;, fetcher: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>currentFetcher</span><span class=p>);</span>
</span><span id=__span-89-7><a id=__codelineno-89-7 name=__codelineno-89-7 href=#__codelineno-89-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-89-8><a id=__codelineno-89-8 name=__codelineno-89-8 href=#__codelineno-89-8></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-89-9><a id=__codelineno-89-9 name=__codelineno-89-9 href=#__codelineno-89-9></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-89-10><a id=__codelineno-89-10 name=__codelineno-89-10 href=#__codelineno-89-10></a><span class=w>    </span><span class=n>resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeFromData</span><span class=p>(</span><span class=n>currentFetcher</span><span class=p>,</span><span class=w> </span><span class=n>currentData</span><span class=p>,</span><span class=w> </span><span class=n>currentDataSource</span><span class=p>);</span>
</span><span id=__span-89-11><a id=__codelineno-89-11 name=__codelineno-89-11 href=#__codelineno-89-11></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>GlideException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-89-12><a id=__codelineno-89-12 name=__codelineno-89-12 href=#__codelineno-89-12></a><span class=w>    </span><span class=n>e</span><span class=p>.</span><span class=na>setLoggingDetails</span><span class=p>(</span><span class=n>currentAttemptingKey</span><span class=p>,</span><span class=w> </span><span class=n>currentDataSource</span><span class=p>);</span>
</span><span id=__span-89-13><a id=__codelineno-89-13 name=__codelineno-89-13 href=#__codelineno-89-13></a><span class=w>    </span><span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-89-14><a id=__codelineno-89-14 name=__codelineno-89-14 href=#__codelineno-89-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-89-15><a id=__codelineno-89-15 name=__codelineno-89-15 href=#__codelineno-89-15></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-89-16><a id=__codelineno-89-16 name=__codelineno-89-16 href=#__codelineno-89-16></a><span class=w>    </span><span class=n>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>currentDataSource</span><span class=p>);</span>
</span><span id=__span-89-17><a id=__codelineno-89-17 name=__codelineno-89-17 href=#__codelineno-89-17></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-89-18><a id=__codelineno-89-18 name=__codelineno-89-18 href=#__codelineno-89-18></a><span class=w>    </span><span class=n>runGenerators</span><span class=p>();</span>
</span><span id=__span-89-19><a id=__codelineno-89-19 name=__codelineno-89-19 href=#__codelineno-89-19></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-89-20><a id=__codelineno-89-20 name=__codelineno-89-20 href=#__codelineno-89-20></a><span class=p>}</span>
</span></code></pre></div> <p>先看看decode相关的代码，<code>decodeFromData</code>相关的代码有一些，我们直接列出这些代码。<code>decodeFromData</code>方法内部又会调用<code>decodeFromFetcher</code>方法干活。在<code>decodeFromFetcher</code>方法中首先会获取LoadPath。然后调用<code>runLoadPath</code>方法解析成资源。 </p> <div class="language-java highlight"><pre><span></span><code><span id=__span-90-1><a id=__codelineno-90-1 name=__codelineno-90-1 href=#__codelineno-90-1></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=nf>decodeFromData</span><span class=p>(</span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>fetcher</span><span class=p>,</span><span class=w> </span><span class=n>Data</span><span class=w> </span><span class=n>data</span><span class=p>,</span>
</span><span id=__span-90-2><a id=__codelineno-90-2 name=__codelineno-90-2 href=#__codelineno-90-2></a><span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-3><a id=__codelineno-90-3 name=__codelineno-90-3 href=#__codelineno-90-3></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-4><a id=__codelineno-90-4 name=__codelineno-90-4 href=#__codelineno-90-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>data</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-5><a id=__codelineno-90-5 name=__codelineno-90-5 href=#__codelineno-90-5></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-90-6><a id=__codelineno-90-6 name=__codelineno-90-6 href=#__codelineno-90-6></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-90-7><a id=__codelineno-90-7 name=__codelineno-90-7 href=#__codelineno-90-7></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
</span><span id=__span-90-8><a id=__codelineno-90-8 name=__codelineno-90-8 href=#__codelineno-90-8></a><span class=w>    </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeFromFetcher</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span>
</span><span id=__span-90-9><a id=__codelineno-90-9 name=__codelineno-90-9 href=#__codelineno-90-9></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-10><a id=__codelineno-90-10 name=__codelineno-90-10 href=#__codelineno-90-10></a><span class=w>      </span><span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Decoded result &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>startTime</span><span class=p>);</span>
</span><span id=__span-90-11><a id=__codelineno-90-11 name=__codelineno-90-11 href=#__codelineno-90-11></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-90-12><a id=__codelineno-90-12 name=__codelineno-90-12 href=#__codelineno-90-12></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-90-13><a id=__codelineno-90-13 name=__codelineno-90-13 href=#__codelineno-90-13></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-14><a id=__codelineno-90-14 name=__codelineno-90-14 href=#__codelineno-90-14></a><span class=w>    </span><span class=n>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-90-15><a id=__codelineno-90-15 name=__codelineno-90-15 href=#__codelineno-90-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-90-16><a id=__codelineno-90-16 name=__codelineno-90-16 href=#__codelineno-90-16></a><span class=p>}</span>
</span><span id=__span-90-17><a id=__codelineno-90-17 name=__codelineno-90-17 href=#__codelineno-90-17></a>
</span><span id=__span-90-18><a id=__codelineno-90-18 name=__codelineno-90-18 href=#__codelineno-90-18></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-90-19><a id=__codelineno-90-19 name=__codelineno-90-19 href=#__codelineno-90-19></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=nf>decodeFromFetcher</span><span class=p>(</span><span class=n>Data</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span>
</span><span id=__span-90-20><a id=__codelineno-90-20 name=__codelineno-90-20 href=#__codelineno-90-20></a><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-21><a id=__codelineno-90-21 name=__codelineno-90-21 href=#__codelineno-90-21></a><span class=w>  </span><span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=o>?</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getLoadPath</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
</span><span id=__span-90-22><a id=__codelineno-90-22 name=__codelineno-90-22 href=#__codelineno-90-22></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>runLoadPath</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>);</span>
</span><span id=__span-90-23><a id=__codelineno-90-23 name=__codelineno-90-23 href=#__codelineno-90-23></a><span class=p>}</span>
</span><span id=__span-90-24><a id=__codelineno-90-24 name=__codelineno-90-24 href=#__codelineno-90-24></a>
</span><span id=__span-90-25><a id=__codelineno-90-25 name=__codelineno-90-25 href=#__codelineno-90-25></a><span class=kd>private</span><span class=w> </span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=nf>runLoadPath</span><span class=p>(</span><span class=n>Data</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span>
</span><span id=__span-90-26><a id=__codelineno-90-26 name=__codelineno-90-26 href=#__codelineno-90-26></a><span class=w>    </span><span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>ResourceType</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>path</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-27><a id=__codelineno-90-27 name=__codelineno-90-27 href=#__codelineno-90-27></a><span class=w>  </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getOptionsWithHardwareConfig</span><span class=p>(</span><span class=n>dataSource</span><span class=p>);</span>
</span><span id=__span-90-28><a id=__codelineno-90-28 name=__codelineno-90-28 href=#__codelineno-90-28></a><span class=w>  </span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>rewinder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getRewinder</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
</span><span id=__span-90-29><a id=__codelineno-90-29 name=__codelineno-90-29 href=#__codelineno-90-29></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-30><a id=__codelineno-90-30 name=__codelineno-90-30 href=#__codelineno-90-30></a><span class=w>    </span><span class=c1>// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
</span><span id=__span-90-31><a id=__codelineno-90-31 name=__codelineno-90-31 href=#__codelineno-90-31></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=na>load</span><span class=p>(</span>
</span><span id=__span-90-32><a id=__codelineno-90-32 name=__codelineno-90-32 href=#__codelineno-90-32></a><span class=w>        </span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>dataSource</span><span class=p>));</span>
</span><span id=__span-90-33><a id=__codelineno-90-33 name=__codelineno-90-33 href=#__codelineno-90-33></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-90-34><a id=__codelineno-90-34 name=__codelineno-90-34 href=#__codelineno-90-34></a><span class=w>    </span><span class=n>rewinder</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
</span><span id=__span-90-35><a id=__codelineno-90-35 name=__codelineno-90-35 href=#__codelineno-90-35></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-90-36><a id=__codelineno-90-36 name=__codelineno-90-36 href=#__codelineno-90-36></a><span class=p>}</span>
</span></code></pre></div> <p>注意<code>runLoadPath</code>方法使用到了<code>DataRewinder</code>，这是一个将数据流里面的指针重新指向开头的类，在调用<code>ResourceDecoder</code>对data进行编码时会尝试很多个编码器，所以每一次尝试后都需要重置索引。<br> 在Glide初始化的时候默认注入了<code>ByteBufferRewinder</code>和<code>InputStreamRewinder</code>这两个类的工厂。这样就为<code>ByteBuffer</code>和<code>InputStream</code>的重定向提供了实现。 </p> <p>值得注意的是，在<code>path.load(rewinder, options, width, height, new DecodeCallback&lt;ResourceType&gt;(dataSource))</code>这行代码中，最后传入了一个<code>DecodeCallback</code>回调，该类的回调方法会回调给<code>DecodeJob</code>对应的方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-91-1><a id=__codelineno-91-1 name=__codelineno-91-1 href=#__codelineno-91-1></a><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-91-2><a id=__codelineno-91-2 name=__codelineno-91-2 href=#__codelineno-91-2></a>
</span><span id=__span-91-3><a id=__codelineno-91-3 name=__codelineno-91-3 href=#__codelineno-91-3></a><span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span>
</span><span id=__span-91-4><a id=__codelineno-91-4 name=__codelineno-91-4 href=#__codelineno-91-4></a>
</span><span id=__span-91-5><a id=__codelineno-91-5 name=__codelineno-91-5 href=#__codelineno-91-5></a><span class=w>  </span><span class=nd>@Synthetic</span>
</span><span id=__span-91-6><a id=__codelineno-91-6 name=__codelineno-91-6 href=#__codelineno-91-6></a><span class=w>  </span><span class=n>DecodeCallback</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-91-7><a id=__codelineno-91-7 name=__codelineno-91-7 href=#__codelineno-91-7></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span>
</span><span id=__span-91-8><a id=__codelineno-91-8 name=__codelineno-91-8 href=#__codelineno-91-8></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-91-9><a id=__codelineno-91-9 name=__codelineno-91-9 href=#__codelineno-91-9></a>
</span><span id=__span-91-10><a id=__codelineno-91-10 name=__codelineno-91-10 href=#__codelineno-91-10></a><span class=w>  </span><span class=nd>@NonNull</span>
</span><span id=__span-91-11><a id=__codelineno-91-11 name=__codelineno-91-11 href=#__codelineno-91-11></a><span class=w>  </span><span class=nd>@Override</span>
</span><span id=__span-91-12><a id=__codelineno-91-12 name=__codelineno-91-12 href=#__codelineno-91-12></a><span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=nf>onResourceDecoded</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoded</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-91-13><a id=__codelineno-91-13 name=__codelineno-91-13 href=#__codelineno-91-13></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>DecodeJob</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>decoded</span><span class=p>);</span>
</span><span id=__span-91-14><a id=__codelineno-91-14 name=__codelineno-91-14 href=#__codelineno-91-14></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-91-15><a id=__codelineno-91-15 name=__codelineno-91-15 href=#__codelineno-91-15></a><span class=p>}</span>
</span></code></pre></div> <p>然后我们看一下<code>LoadPath.load</code>方法的实现：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-92-1><a id=__codelineno-92-1 name=__codelineno-92-1 href=#__codelineno-92-1></a><span class=kd>public</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=nf>load</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span>
</span><span id=__span-92-2><a id=__codelineno-92-2 name=__codelineno-92-2 href=#__codelineno-92-2></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>decodeCallback</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-92-3><a id=__codelineno-92-3 name=__codelineno-92-3 href=#__codelineno-92-3></a><span class=w>  </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>throwables</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
</span><span id=__span-92-4><a id=__codelineno-92-4 name=__codelineno-92-4 href=#__codelineno-92-4></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-92-5><a id=__codelineno-92-5 name=__codelineno-92-5 href=#__codelineno-92-5></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>loadWithExceptionList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>decodeCallback</span><span class=p>,</span><span class=w> </span><span class=n>throwables</span><span class=p>);</span>
</span><span id=__span-92-6><a id=__codelineno-92-6 name=__codelineno-92-6 href=#__codelineno-92-6></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-92-7><a id=__codelineno-92-7 name=__codelineno-92-7 href=#__codelineno-92-7></a><span class=w>    </span><span class=n>listPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>throwables</span><span class=p>);</span>
</span><span id=__span-92-8><a id=__codelineno-92-8 name=__codelineno-92-8 href=#__codelineno-92-8></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-92-9><a id=__codelineno-92-9 name=__codelineno-92-9 href=#__codelineno-92-9></a><span class=p>}</span>
</span></code></pre></div> <p>ummmm，这里调用了<code>loadWithExceptionList</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-93-1><a id=__codelineno-93-1 name=__codelineno-93-1 href=#__codelineno-93-1></a><span class=kd>private</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=nf>loadWithExceptionList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=w> </span><span class=n>rewinder</span><span class=p>,</span>
</span><span id=__span-93-2><a id=__codelineno-93-2 name=__codelineno-93-2 href=#__codelineno-93-2></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>,</span>
</span><span id=__span-93-3><a id=__codelineno-93-3 name=__codelineno-93-3 href=#__codelineno-93-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>decodeCallback</span><span class=p>,</span>
</span><span id=__span-93-4><a id=__codelineno-93-4 name=__codelineno-93-4 href=#__codelineno-93-4></a><span class=w>    </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>exceptions</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-5><a id=__codelineno-93-5 name=__codelineno-93-5 href=#__codelineno-93-5></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-93-6><a id=__codelineno-93-6 name=__codelineno-93-6 href=#__codelineno-93-6></a><span class=w>  </span><span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
</span><span id=__span-93-7><a id=__codelineno-93-7 name=__codelineno-93-7 href=#__codelineno-93-7></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodePaths</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-8><a id=__codelineno-93-8 name=__codelineno-93-8 href=#__codelineno-93-8></a><span class=w>    </span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>ResourceType</span><span class=p>,</span><span class=w> </span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=n>path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodePaths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-93-9><a id=__codelineno-93-9 name=__codelineno-93-9 href=#__codelineno-93-9></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-10><a id=__codelineno-93-10 name=__codelineno-93-10 href=#__codelineno-93-10></a><span class=w>      </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>decodeCallback</span><span class=p>);</span>
</span><span id=__span-93-11><a id=__codelineno-93-11 name=__codelineno-93-11 href=#__codelineno-93-11></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>GlideException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-12><a id=__codelineno-93-12 name=__codelineno-93-12 href=#__codelineno-93-12></a><span class=w>      </span><span class=n>exceptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-93-13><a id=__codelineno-93-13 name=__codelineno-93-13 href=#__codelineno-93-13></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-93-14><a id=__codelineno-93-14 name=__codelineno-93-14 href=#__codelineno-93-14></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-15><a id=__codelineno-93-15 name=__codelineno-93-15 href=#__codelineno-93-15></a><span class=w>      </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-93-16><a id=__codelineno-93-16 name=__codelineno-93-16 href=#__codelineno-93-16></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-93-17><a id=__codelineno-93-17 name=__codelineno-93-17 href=#__codelineno-93-17></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-93-18><a id=__codelineno-93-18 name=__codelineno-93-18 href=#__codelineno-93-18></a>
</span><span id=__span-93-19><a id=__codelineno-93-19 name=__codelineno-93-19 href=#__codelineno-93-19></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-93-20><a id=__codelineno-93-20 name=__codelineno-93-20 href=#__codelineno-93-20></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
</span><span id=__span-93-21><a id=__codelineno-93-21 name=__codelineno-93-21 href=#__codelineno-93-21></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-93-22><a id=__codelineno-93-22 name=__codelineno-93-22 href=#__codelineno-93-22></a>
</span><span id=__span-93-23><a id=__codelineno-93-23 name=__codelineno-93-23 href=#__codelineno-93-23></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-93-24><a id=__codelineno-93-24 name=__codelineno-93-24 href=#__codelineno-93-24></a><span class=p>}</span>
</span></code></pre></div> <p>对于每条DecodePath，都调用其<code>decode</code>方法，直到有一个DecodePath可以decode出资源。<br> 那么我们继续看看<code>DecodePath.decode</code>方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-94-1><a id=__codelineno-94-1 name=__codelineno-94-1 href=#__codelineno-94-1></a><span class=kd>public</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span><span class=w> </span><span class=nf>decode</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span><span class=w> </span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-94-2><a id=__codelineno-94-2 name=__codelineno-94-2 href=#__codelineno-94-2></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>callback</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-94-3><a id=__codelineno-94-3 name=__codelineno-94-3 href=#__codelineno-94-3></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoded</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeResource</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-94-4><a id=__codelineno-94-4 name=__codelineno-94-4 href=#__codelineno-94-4></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callback</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>decoded</span><span class=p>);</span>
</span><span id=__span-94-5><a id=__codelineno-94-5 name=__codelineno-94-5 href=#__codelineno-94-5></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>transcoder</span><span class=p>.</span><span class=na>transcode</span><span class=p>(</span><span class=n>transformed</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-94-6><a id=__codelineno-94-6 name=__codelineno-94-6 href=#__codelineno-94-6></a><span class=p>}</span>
</span></code></pre></div> <p>显而易见，这里有3步：</p> <ol> <li>使用ResourceDecoder List进行decode</li> <li>将decoded的资源进行transform</li> <li>将transformed的资源进行transcode</li> </ol> <p>在我们的示例中，第二条DecodePath(<code>DecodePath{ dataClass=class java.nio.DirectByteBuffer, decoders=[ByteBufferBitmapDecoder@1ca5fe14], transcoder=BitmapDrawableTranscoder@1d8f76bd}</code>)可以成功处理，并返回的是一个<code>LazyBitmapDrawableResource</code>对象。</p> <p>我们看一下这里面的操作过程，首先是<code>decodeResource</code>的过程：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-95-1><a id=__codelineno-95-1 name=__codelineno-95-1 href=#__codelineno-95-1></a><span class=nd>@NonNull</span>
</span><span id=__span-95-2><a id=__codelineno-95-2 name=__codelineno-95-2 href=#__codelineno-95-2></a><span class=kd>private</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>decodeResource</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span><span class=w> </span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span>
</span><span id=__span-95-3><a id=__codelineno-95-3 name=__codelineno-95-3 href=#__codelineno-95-3></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-4><a id=__codelineno-95-4 name=__codelineno-95-4 href=#__codelineno-95-4></a><span class=w>  </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>exceptions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
</span><span id=__span-95-5><a id=__codelineno-95-5 name=__codelineno-95-5 href=#__codelineno-95-5></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-6><a id=__codelineno-95-6 name=__codelineno-95-6 href=#__codelineno-95-6></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>decodeResourceWithList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>exceptions</span><span class=p>);</span>
</span><span id=__span-95-7><a id=__codelineno-95-7 name=__codelineno-95-7 href=#__codelineno-95-7></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-8><a id=__codelineno-95-8 name=__codelineno-95-8 href=#__codelineno-95-8></a><span class=w>    </span><span class=n>listPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>exceptions</span><span class=p>);</span>
</span><span id=__span-95-9><a id=__codelineno-95-9 name=__codelineno-95-9 href=#__codelineno-95-9></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-95-10><a id=__codelineno-95-10 name=__codelineno-95-10 href=#__codelineno-95-10></a><span class=p>}</span>
</span><span id=__span-95-11><a id=__codelineno-95-11 name=__codelineno-95-11 href=#__codelineno-95-11></a>
</span><span id=__span-95-12><a id=__codelineno-95-12 name=__codelineno-95-12 href=#__codelineno-95-12></a><span class=nd>@NonNull</span>
</span><span id=__span-95-13><a id=__codelineno-95-13 name=__codelineno-95-13 href=#__codelineno-95-13></a><span class=kd>private</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=nf>decodeResourceWithList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span><span class=w> </span><span class=n>rewinder</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span>
</span><span id=__span-95-14><a id=__codelineno-95-14 name=__codelineno-95-14 href=#__codelineno-95-14></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span><span class=w> </span><span class=n>exceptions</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>GlideException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-15><a id=__codelineno-95-15 name=__codelineno-95-15 href=#__codelineno-95-15></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-95-16><a id=__codelineno-95-16 name=__codelineno-95-16 href=#__codelineno-95-16></a><span class=w>  </span><span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
</span><span id=__span-95-17><a id=__codelineno-95-17 name=__codelineno-95-17 href=#__codelineno-95-17></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-18><a id=__codelineno-95-18 name=__codelineno-95-18 href=#__codelineno-95-18></a><span class=w>    </span><span class=c1>// decoders只有一条，就是ByteBufferBitmapDecoder</span>
</span><span id=__span-95-19><a id=__codelineno-95-19 name=__codelineno-95-19 href=#__codelineno-95-19></a><span class=w>    </span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=p>,</span><span class=w> </span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
</span><span id=__span-95-20><a id=__codelineno-95-20 name=__codelineno-95-20 href=#__codelineno-95-20></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-21><a id=__codelineno-95-21 name=__codelineno-95-21 href=#__codelineno-95-21></a><span class=w>      </span><span class=c1>// rewinder自然是ByteBufferRewind</span>
</span><span id=__span-95-22><a id=__codelineno-95-22 name=__codelineno-95-22 href=#__codelineno-95-22></a><span class=w>      </span><span class=c1>// data为ByteBuffer</span>
</span><span id=__span-95-23><a id=__codelineno-95-23 name=__codelineno-95-23 href=#__codelineno-95-23></a><span class=w>      </span><span class=n>DataType</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rewinder</span><span class=p>.</span><span class=na>rewindAndGet</span><span class=p>();</span>
</span><span id=__span-95-24><a id=__codelineno-95-24 name=__codelineno-95-24 href=#__codelineno-95-24></a><span class=w>      </span><span class=c1>// ByteBufferBitmapDecoder内部会调用Downsampler的hanldes方法</span>
</span><span id=__span-95-25><a id=__codelineno-95-25 name=__codelineno-95-25 href=#__codelineno-95-25></a><span class=w>      </span><span class=c1>// 它对任意的InputStream和ByteBuffer都返回true</span>
</span><span id=__span-95-26><a id=__codelineno-95-26 name=__codelineno-95-26 href=#__codelineno-95-26></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>decoder</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-27><a id=__codelineno-95-27 name=__codelineno-95-27 href=#__codelineno-95-27></a><span class=w>        </span><span class=c1>// 调用ByteBuffer.position(0)复位</span>
</span><span id=__span-95-28><a id=__codelineno-95-28 name=__codelineno-95-28 href=#__codelineno-95-28></a><span class=w>        </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rewinder</span><span class=p>.</span><span class=na>rewindAndGet</span><span class=p>();</span>
</span><span id=__span-95-29><a id=__codelineno-95-29 name=__codelineno-95-29 href=#__codelineno-95-29></a><span class=w>        </span><span class=c1>// 开始解码</span>
</span><span id=__span-95-30><a id=__codelineno-95-30 name=__codelineno-95-30 href=#__codelineno-95-30></a><span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoder</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-95-31><a id=__codelineno-95-31 name=__codelineno-95-31 href=#__codelineno-95-31></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-95-32><a id=__codelineno-95-32 name=__codelineno-95-32 href=#__codelineno-95-32></a><span class=w>      </span><span class=c1>// Some decoders throw unexpectedly. If they do, we shouldn&#39;t fail the entire load path, but</span>
</span><span id=__span-95-33><a id=__codelineno-95-33 name=__codelineno-95-33 href=#__codelineno-95-33></a><span class=w>      </span><span class=c1>// instead log and continue. See #2406 for an example.</span>
</span><span id=__span-95-34><a id=__codelineno-95-34 name=__codelineno-95-34 href=#__codelineno-95-34></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>RuntimeException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>OutOfMemoryError</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-35><a id=__codelineno-95-35 name=__codelineno-95-35 href=#__codelineno-95-35></a><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-36><a id=__codelineno-95-36 name=__codelineno-95-36 href=#__codelineno-95-36></a><span class=w>        </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Failed to decode data for &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>decoder</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-95-37><a id=__codelineno-95-37 name=__codelineno-95-37 href=#__codelineno-95-37></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-95-38><a id=__codelineno-95-38 name=__codelineno-95-38 href=#__codelineno-95-38></a><span class=w>      </span><span class=n>exceptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
</span><span id=__span-95-39><a id=__codelineno-95-39 name=__codelineno-95-39 href=#__codelineno-95-39></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-95-40><a id=__codelineno-95-40 name=__codelineno-95-40 href=#__codelineno-95-40></a>
</span><span id=__span-95-41><a id=__codelineno-95-41 name=__codelineno-95-41 href=#__codelineno-95-41></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-42><a id=__codelineno-95-42 name=__codelineno-95-42 href=#__codelineno-95-42></a><span class=w>      </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-95-43><a id=__codelineno-95-43 name=__codelineno-95-43 href=#__codelineno-95-43></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-95-44><a id=__codelineno-95-44 name=__codelineno-95-44 href=#__codelineno-95-44></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-95-45><a id=__codelineno-95-45 name=__codelineno-95-45 href=#__codelineno-95-45></a>
</span><span id=__span-95-46><a id=__codelineno-95-46 name=__codelineno-95-46 href=#__codelineno-95-46></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-95-47><a id=__codelineno-95-47 name=__codelineno-95-47 href=#__codelineno-95-47></a><span class=w>    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
</span><span id=__span-95-48><a id=__codelineno-95-48 name=__codelineno-95-48 href=#__codelineno-95-48></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-95-49><a id=__codelineno-95-49 name=__codelineno-95-49 href=#__codelineno-95-49></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-95-50><a id=__codelineno-95-50 name=__codelineno-95-50 href=#__codelineno-95-50></a><span class=p>}</span>
</span></code></pre></div> <p><code>ByteBufferBitmapDecoder.decode</code>方法会先将<code>ByteBuffer</code>转换成<code>InputStream</code>，然后在调用<code>Downsampler.decode</code>方法进行解码。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-96-1><a id=__codelineno-96-1 name=__codelineno-96-1 href=#__codelineno-96-1></a><span class=nd>@Override</span>
</span><span id=__span-96-2><a id=__codelineno-96-2 name=__codelineno-96-2 href=#__codelineno-96-2></a><span class=kd>public</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span><span class=w> </span><span class=nf>decode</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>source</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-96-3><a id=__codelineno-96-3 name=__codelineno-96-3 href=#__codelineno-96-3></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>)</span>
</span><span id=__span-96-4><a id=__codelineno-96-4 name=__codelineno-96-4 href=#__codelineno-96-4></a><span class=w>    </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-96-5><a id=__codelineno-96-5 name=__codelineno-96-5 href=#__codelineno-96-5></a><span class=w>  </span><span class=n>InputStream</span><span class=w> </span><span class=n>is</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBufferUtil</span><span class=p>.</span><span class=na>toStream</span><span class=p>(</span><span class=n>source</span><span class=p>);</span>
</span><span id=__span-96-6><a id=__codelineno-96-6 name=__codelineno-96-6 href=#__codelineno-96-6></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>downsampler</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>is</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-96-7><a id=__codelineno-96-7 name=__codelineno-96-7 href=#__codelineno-96-7></a><span class=p>}</span>
</span></code></pre></div> <p>这里面使用的技巧也主要是使用的<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#1-bitmap>Bitmap的加载</a>中提到的技巧。<br> 不过在Glide中，除了设置了<code>BitmapFactory.Options</code>的<code>inJustDecodeBounds</code>和<code>inSampleSize</code>属性外，还会设置<code>inTargetDensity</code>、<code>inDensity</code>、<code>inScale</code>、<code>inPreferredConfig</code>、<code>inBitmap</code>属性。</p> <blockquote> <p>在计算各种值的时候，用到了Math里面ceil、floor、round函数。<br> <code>ceil(x)</code>表示不小于x的最小整数<br> <code>floor(x)</code>表示不大于x的最大整数<br> <code>round(x)</code>表示表示四舍五入，理解为floor(x + 0.5) </p> <p><figcaption>ceil、floor、round示例</figcaption> </p> <table> <thead> <tr> <th style="text-align: center;">x</th> <th style="text-align: center;">ceil</th> <th style="text-align: center;">floor</th> <th style="text-align: center;">round</th> </tr> </thead> <tbody> <tr> <td style="text-align: center;">1.4</td> <td style="text-align: center;">2.0</td> <td style="text-align: center;">1.0</td> <td style="text-align: center;">1</td> </tr> <tr> <td style="text-align: center;">1.5</td> <td style="text-align: center;">2.0</td> <td style="text-align: center;">1.0</td> <td style="text-align: center;">2</td> </tr> <tr> <td style="text-align: center;">1.6</td> <td style="text-align: center;">2.0</td> <td style="text-align: center;">1.0</td> <td style="text-align: center;">2</td> </tr> <tr> <td style="text-align: center;">-1.4</td> <td style="text-align: center;">-1.0</td> <td style="text-align: center;">-2.0</td> <td style="text-align: center;">-1</td> </tr> <tr> <td style="text-align: center;">-1.5</td> <td style="text-align: center;">-1.0</td> <td style="text-align: center;">-2.0</td> <td style="text-align: center;">-1</td> </tr> <tr> <td style="text-align: center;">-1.6</td> <td style="text-align: center;">-1.0</td> <td style="text-align: center;">-2.0</td> <td style="text-align: center;">-2</td> </tr> </tbody> </table> <p><figure style="width: 66%" class=align-center> <img src=/assets/images/android/math-floor-ceil.png> <figcaption>floot、ceil取值走向示意图</figcaption> </figure></p> </blockquote> <p>这里执行完毕，会将decode出来的<code>Bitmap</code>包装成为一个<code>BitmapResource</code>对象。然后就一直往上返回，返回到<code>DecodePath.decode</code>方法中。接下来执行：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-97-1><a id=__codelineno-97-1 name=__codelineno-97-1 href=#__codelineno-97-1></a><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>callback</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>decoded</span><span class=p>);</span>
</span></code></pre></div> <p>这里的<code>callback</code>我们在前面提到过，这会调用<code>DecodeJob.onResourceDecoded(DataSource, Resource&lt;Z&gt;)</code>方法。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-98-1><a id=__codelineno-98-1 name=__codelineno-98-1 href=#__codelineno-98-1></a><span class=nd>@Synthetic</span>
</span><span id=__span-98-2><a id=__codelineno-98-2 name=__codelineno-98-2 href=#__codelineno-98-2></a><span class=nd>@NonNull</span>
</span><span id=__span-98-3><a id=__codelineno-98-3 name=__codelineno-98-3 href=#__codelineno-98-3></a><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=nf>onResourceDecoded</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span>
</span><span id=__span-98-4><a id=__codelineno-98-4 name=__codelineno-98-4 href=#__codelineno-98-4></a><span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoded</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-5><a id=__codelineno-98-5 name=__codelineno-98-5 href=#__codelineno-98-5></a><span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
</span><span id=__span-98-6><a id=__codelineno-98-6 name=__codelineno-98-6 href=#__codelineno-98-6></a><span class=w>  </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceSubClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>decoded</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>();</span><span class=c1>// Bitmap.class</span>
</span><span id=__span-98-7><a id=__codelineno-98-7 name=__codelineno-98-7 href=#__codelineno-98-7></a><span class=w>  </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>appliedTransformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-98-8><a id=__codelineno-98-8 name=__codelineno-98-8 href=#__codelineno-98-8></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoded</span><span class=p>;</span>
</span><span id=__span-98-9><a id=__codelineno-98-9 name=__codelineno-98-9 href=#__codelineno-98-9></a><span class=w>  </span><span class=c1>// dataSource为DATA_DISK_CACHE，所以满足条件</span>
</span><span id=__span-98-10><a id=__codelineno-98-10 name=__codelineno-98-10 href=#__codelineno-98-10></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataSource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-11><a id=__codelineno-98-11 name=__codelineno-98-11 href=#__codelineno-98-11></a><span class=w>    </span><span class=c1>// 在2.2节中给出了一个「optionalFitCenter()过程保存的KV表」，查阅得知Bitmap.class对应的正是FitCenter()</span>
</span><span id=__span-98-12><a id=__codelineno-98-12 name=__codelineno-98-12 href=#__codelineno-98-12></a><span class=w>    </span><span class=n>appliedTransformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceSubClass</span><span class=p>);</span>
</span><span id=__span-98-13><a id=__codelineno-98-13 name=__codelineno-98-13 href=#__codelineno-98-13></a><span class=w>    </span><span class=c1>// 对decoded资源进行transform</span>
</span><span id=__span-98-14><a id=__codelineno-98-14 name=__codelineno-98-14 href=#__codelineno-98-14></a><span class=w>    </span><span class=n>transformed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appliedTransformation</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>glideContext</span><span class=p>,</span><span class=w> </span><span class=n>decoded</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>);</span>
</span><span id=__span-98-15><a id=__codelineno-98-15 name=__codelineno-98-15 href=#__codelineno-98-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-98-16><a id=__codelineno-98-16 name=__codelineno-98-16 href=#__codelineno-98-16></a><span class=w>  </span><span class=c1>// TODO: Make this the responsibility of the Transformation.</span>
</span><span id=__span-98-17><a id=__codelineno-98-17 name=__codelineno-98-17 href=#__codelineno-98-17></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>decoded</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-18><a id=__codelineno-98-18 name=__codelineno-98-18 href=#__codelineno-98-18></a><span class=w>    </span><span class=n>decoded</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
</span><span id=__span-98-19><a id=__codelineno-98-19 name=__codelineno-98-19 href=#__codelineno-98-19></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-98-20><a id=__codelineno-98-20 name=__codelineno-98-20 href=#__codelineno-98-20></a>
</span><span id=__span-98-21><a id=__codelineno-98-21 name=__codelineno-98-21 href=#__codelineno-98-21></a><span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=n>EncodeStrategy</span><span class=w> </span><span class=n>encodeStrategy</span><span class=p>;</span>
</span><span id=__span-98-22><a id=__codelineno-98-22 name=__codelineno-98-22 href=#__codelineno-98-22></a><span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>encoder</span><span class=p>;</span>
</span><span id=__span-98-23><a id=__codelineno-98-23 name=__codelineno-98-23 href=#__codelineno-98-23></a><span class=w>  </span><span class=c1>// Bitmap有注册对应的BitmapEncoder，所以是available的</span>
</span><span id=__span-98-24><a id=__codelineno-98-24 name=__codelineno-98-24 href=#__codelineno-98-24></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isResourceEncoderAvailable</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-25><a id=__codelineno-98-25 name=__codelineno-98-25 href=#__codelineno-98-25></a><span class=w>    </span><span class=c1>// encoder就是BitmapEncoder</span>
</span><span id=__span-98-26><a id=__codelineno-98-26 name=__codelineno-98-26 href=#__codelineno-98-26></a><span class=w>    </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getResultEncoder</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
</span><span id=__span-98-27><a id=__codelineno-98-27 name=__codelineno-98-27 href=#__codelineno-98-27></a><span class=w>    </span><span class=c1>// encodeStrategy为EncodeStrategy.TRANSFORMED</span>
</span><span id=__span-98-28><a id=__codelineno-98-28 name=__codelineno-98-28 href=#__codelineno-98-28></a><span class=w>    </span><span class=n>encodeStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>encoder</span><span class=p>.</span><span class=na>getEncodeStrategy</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-98-29><a id=__codelineno-98-29 name=__codelineno-98-29 href=#__codelineno-98-29></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-30><a id=__codelineno-98-30 name=__codelineno-98-30 href=#__codelineno-98-30></a><span class=w>    </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-98-31><a id=__codelineno-98-31 name=__codelineno-98-31 href=#__codelineno-98-31></a><span class=w>    </span><span class=n>encodeStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>
</span><span id=__span-98-32><a id=__codelineno-98-32 name=__codelineno-98-32 href=#__codelineno-98-32></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-98-33><a id=__codelineno-98-33 name=__codelineno-98-33 href=#__codelineno-98-33></a>
</span><span id=__span-98-34><a id=__codelineno-98-34 name=__codelineno-98-34 href=#__codelineno-98-34></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transformed</span><span class=p>;</span>
</span><span id=__span-98-35><a id=__codelineno-98-35 name=__codelineno-98-35 href=#__codelineno-98-35></a><span class=w>  </span><span class=c1>// isSourceKey显然为true，所以isFromAlternateCacheKey为false，所以就返回了</span>
</span><span id=__span-98-36><a id=__codelineno-98-36 name=__codelineno-98-36 href=#__codelineno-98-36></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>isFromAlternateCacheKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isSourceKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>);</span>
</span><span id=__span-98-37><a id=__codelineno-98-37 name=__codelineno-98-37 href=#__codelineno-98-37></a><span class=w>  </span><span class=c1>// diskCacheStrategy为AUTOMATIC，该方法返回false</span>
</span><span id=__span-98-38><a id=__codelineno-98-38 name=__codelineno-98-38 href=#__codelineno-98-38></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isResourceCacheable</span><span class=p>(</span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span>
</span><span id=__span-98-39><a id=__codelineno-98-39 name=__codelineno-98-39 href=#__codelineno-98-39></a><span class=w>      </span><span class=n>encodeStrategy</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-40><a id=__codelineno-98-40 name=__codelineno-98-40 href=#__codelineno-98-40></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>encoder</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-41><a id=__codelineno-98-41 name=__codelineno-98-41 href=#__codelineno-98-41></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Registry</span><span class=p>.</span><span class=na>NoResultEncoderAvailableException</span><span class=p>(</span><span class=n>transformed</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>());</span>
</span><span id=__span-98-42><a id=__codelineno-98-42 name=__codelineno-98-42 href=#__codelineno-98-42></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-98-43><a id=__codelineno-98-43 name=__codelineno-98-43 href=#__codelineno-98-43></a><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-98-44><a id=__codelineno-98-44 name=__codelineno-98-44 href=#__codelineno-98-44></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>encodeStrategy</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-98-45><a id=__codelineno-98-45 name=__codelineno-98-45 href=#__codelineno-98-45></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>SOURCE</span><span class=p>:</span>
</span><span id=__span-98-46><a id=__codelineno-98-46 name=__codelineno-98-46 href=#__codelineno-98-46></a><span class=w>        </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>,</span><span class=w> </span><span class=n>signature</span><span class=p>);</span>
</span><span id=__span-98-47><a id=__codelineno-98-47 name=__codelineno-98-47 href=#__codelineno-98-47></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-98-48><a id=__codelineno-98-48 name=__codelineno-98-48 href=#__codelineno-98-48></a><span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>TRANSFORMED</span><span class=p>:</span>
</span><span id=__span-98-49><a id=__codelineno-98-49 name=__codelineno-98-49 href=#__codelineno-98-49></a><span class=w>        </span><span class=n>key</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-98-50><a id=__codelineno-98-50 name=__codelineno-98-50 href=#__codelineno-98-50></a><span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheKey</span><span class=p>(</span>
</span><span id=__span-98-51><a id=__codelineno-98-51 name=__codelineno-98-51 href=#__codelineno-98-51></a><span class=w>                </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
</span><span id=__span-98-52><a id=__codelineno-98-52 name=__codelineno-98-52 href=#__codelineno-98-52></a><span class=w>                </span><span class=n>currentSourceKey</span><span class=p>,</span>
</span><span id=__span-98-53><a id=__codelineno-98-53 name=__codelineno-98-53 href=#__codelineno-98-53></a><span class=w>                </span><span class=n>signature</span><span class=p>,</span>
</span><span id=__span-98-54><a id=__codelineno-98-54 name=__codelineno-98-54 href=#__codelineno-98-54></a><span class=w>                </span><span class=n>width</span><span class=p>,</span>
</span><span id=__span-98-55><a id=__codelineno-98-55 name=__codelineno-98-55 href=#__codelineno-98-55></a><span class=w>                </span><span class=n>height</span><span class=p>,</span>
</span><span id=__span-98-56><a id=__codelineno-98-56 name=__codelineno-98-56 href=#__codelineno-98-56></a><span class=w>                </span><span class=n>appliedTransformation</span><span class=p>,</span>
</span><span id=__span-98-57><a id=__codelineno-98-57 name=__codelineno-98-57 href=#__codelineno-98-57></a><span class=w>                </span><span class=n>resourceSubClass</span><span class=p>,</span>
</span><span id=__span-98-58><a id=__codelineno-98-58 name=__codelineno-98-58 href=#__codelineno-98-58></a><span class=w>                </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-98-59><a id=__codelineno-98-59 name=__codelineno-98-59 href=#__codelineno-98-59></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
</span><span id=__span-98-60><a id=__codelineno-98-60 name=__codelineno-98-60 href=#__codelineno-98-60></a><span class=w>      </span><span class=k>default</span><span class=p>:</span>
</span><span id=__span-98-61><a id=__codelineno-98-61 name=__codelineno-98-61 href=#__codelineno-98-61></a><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unknown strategy: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encodeStrategy</span><span class=p>);</span>
</span><span id=__span-98-62><a id=__codelineno-98-62 name=__codelineno-98-62 href=#__codelineno-98-62></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-98-63><a id=__codelineno-98-63 name=__codelineno-98-63 href=#__codelineno-98-63></a>
</span><span id=__span-98-64><a id=__codelineno-98-64 name=__codelineno-98-64 href=#__codelineno-98-64></a><span class=w>    </span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockedResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
</span><span id=__span-98-65><a id=__codelineno-98-65 name=__codelineno-98-65 href=#__codelineno-98-65></a><span class=w>    </span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>encoder</span><span class=p>,</span><span class=w> </span><span class=n>lockedResult</span><span class=p>);</span>
</span><span id=__span-98-66><a id=__codelineno-98-66 name=__codelineno-98-66 href=#__codelineno-98-66></a><span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lockedResult</span><span class=p>;</span>
</span><span id=__span-98-67><a id=__codelineno-98-67 name=__codelineno-98-67 href=#__codelineno-98-67></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-98-68><a id=__codelineno-98-68 name=__codelineno-98-68 href=#__codelineno-98-68></a><span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span>
</span><span id=__span-98-69><a id=__codelineno-98-69 name=__codelineno-98-69 href=#__codelineno-98-69></a><span class=p>}</span>
</span></code></pre></div> <p>然后就回到<code>DecodePath.decode</code>方法的第三行了：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-99-1><a id=__codelineno-99-1 name=__codelineno-99-1 href=#__codelineno-99-1></a><span class=k>return</span><span class=w> </span><span class=n>transcoder</span><span class=p>.</span><span class=na>transcode</span><span class=p>(</span><span class=n>transformed</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span></code></pre></div> <p>这里的transcoder就是<code>BitmapDrawableTranscoder</code>，该方法返回了一个<code>LazyBitmapDrawableResource</code>。</p> <p>至此，resource已经decode完毕。下面一直返回到<code>DecodeJob.decodeFromRetrievedData()</code>方法中。下面会调用<code>notifyEncodeAndRelease</code>方法完成后面的事宜。</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-100-1><a id=__codelineno-100-1 name=__codelineno-100-1 href=#__codelineno-100-1></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-2><a id=__codelineno-100-2 name=__codelineno-100-2 href=#__codelineno-100-2></a><span class=w>  </span><span class=c1>// resource是BitmapResource类型，实现了Initializable接口</span>
</span><span id=__span-100-3><a id=__codelineno-100-3 name=__codelineno-100-3 href=#__codelineno-100-3></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Initializable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-4><a id=__codelineno-100-4 name=__codelineno-100-4 href=#__codelineno-100-4></a><span class=w>    </span><span class=c1>// initialize方法调用了bitmap.prepareToDraw()</span>
</span><span id=__span-100-5><a id=__codelineno-100-5 name=__codelineno-100-5 href=#__codelineno-100-5></a><span class=w>    </span><span class=p>((</span><span class=n>Initializable</span><span class=p>)</span><span class=w> </span><span class=n>resource</span><span class=p>).</span><span class=na>initialize</span><span class=p>();</span>
</span><span id=__span-100-6><a id=__codelineno-100-6 name=__codelineno-100-6 href=#__codelineno-100-6></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-100-7><a id=__codelineno-100-7 name=__codelineno-100-7 href=#__codelineno-100-7></a>
</span><span id=__span-100-8><a id=__codelineno-100-8 name=__codelineno-100-8 href=#__codelineno-100-8></a><span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resource</span><span class=p>;</span>
</span><span id=__span-100-9><a id=__codelineno-100-9 name=__codelineno-100-9 href=#__codelineno-100-9></a><span class=w>  </span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockedResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-100-10><a id=__codelineno-100-10 name=__codelineno-100-10 href=#__codelineno-100-10></a><span class=w>  </span><span class=c1>// 由于在DecodeJob.onResourceDecoded方法中diskCacheStrategy.isResourceCacheable返回false</span>
</span><span id=__span-100-11><a id=__codelineno-100-11 name=__codelineno-100-11 href=#__codelineno-100-11></a><span class=w>  </span><span class=c1>// 所以没有调用deferredEncodeManager.init方法，因此此处为false</span>
</span><span id=__span-100-12><a id=__codelineno-100-12 name=__codelineno-100-12 href=#__codelineno-100-12></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-13><a id=__codelineno-100-13 name=__codelineno-100-13 href=#__codelineno-100-13></a><span class=w>    </span><span class=n>lockedResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-100-14><a id=__codelineno-100-14 name=__codelineno-100-14 href=#__codelineno-100-14></a><span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lockedResource</span><span class=p>;</span>
</span><span id=__span-100-15><a id=__codelineno-100-15 name=__codelineno-100-15 href=#__codelineno-100-15></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-100-16><a id=__codelineno-100-16 name=__codelineno-100-16 href=#__codelineno-100-16></a>
</span><span id=__span-100-17><a id=__codelineno-100-17 name=__codelineno-100-17 href=#__codelineno-100-17></a><span class=w>  </span><span class=c1>// 通知回调，资源已经就绪</span>
</span><span id=__span-100-18><a id=__codelineno-100-18 name=__codelineno-100-18 href=#__codelineno-100-18></a><span class=w>  </span><span class=n>notifyComplete</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span>
</span><span id=__span-100-19><a id=__codelineno-100-19 name=__codelineno-100-19 href=#__codelineno-100-19></a>
</span><span id=__span-100-20><a id=__codelineno-100-20 name=__codelineno-100-20 href=#__codelineno-100-20></a><span class=w>  </span><span class=n>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>;</span>
</span><span id=__span-100-21><a id=__codelineno-100-21 name=__codelineno-100-21 href=#__codelineno-100-21></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-22><a id=__codelineno-100-22 name=__codelineno-100-22 href=#__codelineno-100-22></a><span class=w>    </span><span class=c1>// 此处为false, skip</span>
</span><span id=__span-100-23><a id=__codelineno-100-23 name=__codelineno-100-23 href=#__codelineno-100-23></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-24><a id=__codelineno-100-24 name=__codelineno-100-24 href=#__codelineno-100-24></a><span class=w>      </span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span>
</span><span id=__span-100-25><a id=__codelineno-100-25 name=__codelineno-100-25 href=#__codelineno-100-25></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-100-26><a id=__codelineno-100-26 name=__codelineno-100-26 href=#__codelineno-100-26></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-27><a id=__codelineno-100-27 name=__codelineno-100-27 href=#__codelineno-100-27></a><span class=w>    </span><span class=c1>// lockedResource为null, skip</span>
</span><span id=__span-100-28><a id=__codelineno-100-28 name=__codelineno-100-28 href=#__codelineno-100-28></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lockedResource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-100-29><a id=__codelineno-100-29 name=__codelineno-100-29 href=#__codelineno-100-29></a><span class=w>      </span><span class=n>lockedResource</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
</span><span id=__span-100-30><a id=__codelineno-100-30 name=__codelineno-100-30 href=#__codelineno-100-30></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-100-31><a id=__codelineno-100-31 name=__codelineno-100-31 href=#__codelineno-100-31></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-100-32><a id=__codelineno-100-32 name=__codelineno-100-32 href=#__codelineno-100-32></a><span class=w>  </span><span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process</span>
</span><span id=__span-100-33><a id=__codelineno-100-33 name=__codelineno-100-33 href=#__codelineno-100-33></a><span class=w>  </span><span class=c1>// throws.</span>
</span><span id=__span-100-34><a id=__codelineno-100-34 name=__codelineno-100-34 href=#__codelineno-100-34></a><span class=w>  </span><span class=c1>// 进行清理工作</span>
</span><span id=__span-100-35><a id=__codelineno-100-35 name=__codelineno-100-35 href=#__codelineno-100-35></a><span class=w>  </span><span class=n>onEncodeComplete</span><span class=p>();</span>
</span><span id=__span-100-36><a id=__codelineno-100-36 name=__codelineno-100-36 href=#__codelineno-100-36></a><span class=p>}</span>
</span></code></pre></div> <p>上面这段代码重点在于<code>notifyComplete</code>方法，该方法内部会调用<code>callback.onResourceReady(resource, dataSource)</code>将结果传递给回调，这里的回调是<code>EngineJob</code>：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-101-1><a id=__codelineno-101-1 name=__codelineno-101-1 href=#__codelineno-101-1></a><span class=c1>// EngineJob.java</span>
</span><span id=__span-101-2><a id=__codelineno-101-2 name=__codelineno-101-2 href=#__codelineno-101-2></a><span class=nd>@Override</span>
</span><span id=__span-101-3><a id=__codelineno-101-3 name=__codelineno-101-3 href=#__codelineno-101-3></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-4><a id=__codelineno-101-4 name=__codelineno-101-4 href=#__codelineno-101-4></a><span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-5><a id=__codelineno-101-5 name=__codelineno-101-5 href=#__codelineno-101-5></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resource</span><span class=p>;</span>
</span><span id=__span-101-6><a id=__codelineno-101-6 name=__codelineno-101-6 href=#__codelineno-101-6></a><span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>dataSource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataSource</span><span class=p>;</span>
</span><span id=__span-101-7><a id=__codelineno-101-7 name=__codelineno-101-7 href=#__codelineno-101-7></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-101-8><a id=__codelineno-101-8 name=__codelineno-101-8 href=#__codelineno-101-8></a><span class=w>  </span><span class=n>notifyCallbacksOfResult</span><span class=p>();</span>
</span><span id=__span-101-9><a id=__codelineno-101-9 name=__codelineno-101-9 href=#__codelineno-101-9></a><span class=p>}</span>
</span><span id=__span-101-10><a id=__codelineno-101-10 name=__codelineno-101-10 href=#__codelineno-101-10></a>
</span><span id=__span-101-11><a id=__codelineno-101-11 name=__codelineno-101-11 href=#__codelineno-101-11></a><span class=kt>void</span><span class=w> </span><span class=nf>notifyCallbacksOfResult</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-12><a id=__codelineno-101-12 name=__codelineno-101-12 href=#__codelineno-101-12></a><span class=w>  </span><span class=n>ResourceCallbacksAndExecutors</span><span class=w> </span><span class=n>copy</span><span class=p>;</span>
</span><span id=__span-101-13><a id=__codelineno-101-13 name=__codelineno-101-13 href=#__codelineno-101-13></a><span class=w>  </span><span class=n>Key</span><span class=w> </span><span class=n>localKey</span><span class=p>;</span>
</span><span id=__span-101-14><a id=__codelineno-101-14 name=__codelineno-101-14 href=#__codelineno-101-14></a><span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>localResource</span><span class=p>;</span>
</span><span id=__span-101-15><a id=__codelineno-101-15 name=__codelineno-101-15 href=#__codelineno-101-15></a><span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-16><a id=__codelineno-101-16 name=__codelineno-101-16 href=#__codelineno-101-16></a><span class=w>    </span><span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
</span><span id=__span-101-17><a id=__codelineno-101-17 name=__codelineno-101-17 href=#__codelineno-101-17></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-18><a id=__codelineno-101-18 name=__codelineno-101-18 href=#__codelineno-101-18></a><span class=w>      </span><span class=c1>// TODO: Seems like we might as well put this in the memory cache instead of just recycling</span>
</span><span id=__span-101-19><a id=__codelineno-101-19 name=__codelineno-101-19 href=#__codelineno-101-19></a><span class=w>      </span><span class=c1>// it since we&#39;ve gotten this far...</span>
</span><span id=__span-101-20><a id=__codelineno-101-20 name=__codelineno-101-20 href=#__codelineno-101-20></a><span class=w>      </span><span class=n>resource</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
</span><span id=__span-101-21><a id=__codelineno-101-21 name=__codelineno-101-21 href=#__codelineno-101-21></a><span class=w>      </span><span class=n>release</span><span class=p>();</span>
</span><span id=__span-101-22><a id=__codelineno-101-22 name=__codelineno-101-22 href=#__codelineno-101-22></a><span class=w>      </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-101-23><a id=__codelineno-101-23 name=__codelineno-101-23 href=#__codelineno-101-23></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-24><a id=__codelineno-101-24 name=__codelineno-101-24 href=#__codelineno-101-24></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Received a resource without any callbacks to notify&quot;</span><span class=p>);</span>
</span><span id=__span-101-25><a id=__codelineno-101-25 name=__codelineno-101-25 href=#__codelineno-101-25></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>hasResource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-26><a id=__codelineno-101-26 name=__codelineno-101-26 href=#__codelineno-101-26></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already have resource&quot;</span><span class=p>);</span>
</span><span id=__span-101-27><a id=__codelineno-101-27 name=__codelineno-101-27 href=#__codelineno-101-27></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-101-28><a id=__codelineno-101-28 name=__codelineno-101-28 href=#__codelineno-101-28></a><span class=w>    </span><span class=c1>// engineResourceFactory默认为EngineResourceFactory</span>
</span><span id=__span-101-29><a id=__codelineno-101-29 name=__codelineno-101-29 href=#__codelineno-101-29></a><span class=w>    </span><span class=c1>// 其build方法就是new一个对应的资源</span>
</span><span id=__span-101-30><a id=__codelineno-101-30 name=__codelineno-101-30 href=#__codelineno-101-30></a><span class=w>    </span><span class=c1>// new EngineResource&lt;&gt;(resource, isMemoryCacheable, /*isRecyclable=*/ true)</span>
</span><span id=__span-101-31><a id=__codelineno-101-31 name=__codelineno-101-31 href=#__codelineno-101-31></a><span class=w>    </span><span class=n>engineResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>engineResourceFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>isCacheable</span><span class=p>);</span>
</span><span id=__span-101-32><a id=__codelineno-101-32 name=__codelineno-101-32 href=#__codelineno-101-32></a><span class=w>    </span><span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the</span>
</span><span id=__span-101-33><a id=__codelineno-101-33 name=__codelineno-101-33 href=#__codelineno-101-33></a><span class=w>    </span><span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under</span>
</span><span id=__span-101-34><a id=__codelineno-101-34 name=__codelineno-101-34 href=#__codelineno-101-34></a><span class=w>    </span><span class=c1>// a lock here so that any newly added callback that executes before the next locked section</span>
</span><span id=__span-101-35><a id=__codelineno-101-35 name=__codelineno-101-35 href=#__codelineno-101-35></a><span class=w>    </span><span class=c1>// below can&#39;t recycle the resource before we call the callbacks.</span>
</span><span id=__span-101-36><a id=__codelineno-101-36 name=__codelineno-101-36 href=#__codelineno-101-36></a><span class=w>    </span><span class=n>hasResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-101-37><a id=__codelineno-101-37 name=__codelineno-101-37 href=#__codelineno-101-37></a><span class=w>    </span><span class=n>copy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cbs</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span>
</span><span id=__span-101-38><a id=__codelineno-101-38 name=__codelineno-101-38 href=#__codelineno-101-38></a><span class=w>    </span><span class=n>incrementPendingCallbacks</span><span class=p>(</span><span class=n>copy</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span>
</span><span id=__span-101-39><a id=__codelineno-101-39 name=__codelineno-101-39 href=#__codelineno-101-39></a>
</span><span id=__span-101-40><a id=__codelineno-101-40 name=__codelineno-101-40 href=#__codelineno-101-40></a><span class=w>    </span><span class=n>localKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>;</span>
</span><span id=__span-101-41><a id=__codelineno-101-41 name=__codelineno-101-41 href=#__codelineno-101-41></a><span class=w>    </span><span class=n>localResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>engineResource</span><span class=p>;</span>
</span><span id=__span-101-42><a id=__codelineno-101-42 name=__codelineno-101-42 href=#__codelineno-101-42></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-101-43><a id=__codelineno-101-43 name=__codelineno-101-43 href=#__codelineno-101-43></a>
</span><span id=__span-101-44><a id=__codelineno-101-44 name=__codelineno-101-44 href=#__codelineno-101-44></a><span class=w>  </span><span class=c1>// listener就是Engine，该方法会讲资源保存到activeResources中</span>
</span><span id=__span-101-45><a id=__codelineno-101-45 name=__codelineno-101-45 href=#__codelineno-101-45></a><span class=w>  </span><span class=n>listener</span><span class=p>.</span><span class=na>onEngineJobComplete</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>localKey</span><span class=p>,</span><span class=w> </span><span class=n>localResource</span><span class=p>);</span>
</span><span id=__span-101-46><a id=__codelineno-101-46 name=__codelineno-101-46 href=#__codelineno-101-46></a>
</span><span id=__span-101-47><a id=__codelineno-101-47 name=__codelineno-101-47 href=#__codelineno-101-47></a><span class=w>  </span><span class=c1>// 这里的ResourceCallbackAndExecutor就是我们在3.3节中创建EngineJob和DecodeJob</span>
</span><span id=__span-101-48><a id=__codelineno-101-48 name=__codelineno-101-48 href=#__codelineno-101-48></a><span class=w>  </span><span class=c1>// 并在执行DecodeJob之前添加的回调</span>
</span><span id=__span-101-49><a id=__codelineno-101-49 name=__codelineno-101-49 href=#__codelineno-101-49></a><span class=w>  </span><span class=c1>// entry.executor就是Glide.with.load.into中出现的Executors.mainThreadExecutor()</span>
</span><span id=__span-101-50><a id=__codelineno-101-50 name=__codelineno-101-50 href=#__codelineno-101-50></a><span class=w>  </span><span class=c1>// entry.cb就是SingleRequest</span>
</span><span id=__span-101-51><a id=__codelineno-101-51 name=__codelineno-101-51 href=#__codelineno-101-51></a><span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>ResourceCallbackAndExecutor</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>copy</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-101-52><a id=__codelineno-101-52 name=__codelineno-101-52 href=#__codelineno-101-52></a><span class=w>    </span><span class=n>entry</span><span class=p>.</span><span class=na>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CallResourceReady</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>cb</span><span class=p>));</span>
</span><span id=__span-101-53><a id=__codelineno-101-53 name=__codelineno-101-53 href=#__codelineno-101-53></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-101-54><a id=__codelineno-101-54 name=__codelineno-101-54 href=#__codelineno-101-54></a><span class=w>  </span><span class=n>decrementPendingCallbacks</span><span class=p>();</span>
</span><span id=__span-101-55><a id=__codelineno-101-55 name=__codelineno-101-55 href=#__codelineno-101-55></a><span class=p>}</span>
</span></code></pre></div> <p><code>listener.onEngineJobComplete</code>的代码很简单。首先会设置资源的回调为自己，这样在资源释放时会通知自己的回调方法，将资源从active状态变为cache状态，如<code>onResourceReleased</code>方法；然后将资源放入activeResources中，资源变为active状态；最后将engineJob从Jobs中移除：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-102-1><a id=__codelineno-102-1 name=__codelineno-102-1 href=#__codelineno-102-1></a><span class=nd>@Override</span>
</span><span id=__span-102-2><a id=__codelineno-102-2 name=__codelineno-102-2 href=#__codelineno-102-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onEngineJobComplete</span><span class=p>(</span>
</span><span id=__span-102-3><a id=__codelineno-102-3 name=__codelineno-102-3 href=#__codelineno-102-3></a><span class=w>    </span><span class=n>EngineJob</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>engineJob</span><span class=p>,</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-102-4><a id=__codelineno-102-4 name=__codelineno-102-4 href=#__codelineno-102-4></a><span class=w>  </span><span class=c1>// A null resource indicates that the load failed, usually due to an exception.</span>
</span><span id=__span-102-5><a id=__codelineno-102-5 name=__codelineno-102-5 href=#__codelineno-102-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-102-6><a id=__codelineno-102-6 name=__codelineno-102-6 href=#__codelineno-102-6></a><span class=w>    </span><span class=n>resource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span>
</span><span id=__span-102-7><a id=__codelineno-102-7 name=__codelineno-102-7 href=#__codelineno-102-7></a>
</span><span id=__span-102-8><a id=__codelineno-102-8 name=__codelineno-102-8 href=#__codelineno-102-8></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-102-9><a id=__codelineno-102-9 name=__codelineno-102-9 href=#__codelineno-102-9></a><span class=w>      </span><span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-102-10><a id=__codelineno-102-10 name=__codelineno-102-10 href=#__codelineno-102-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-102-11><a id=__codelineno-102-11 name=__codelineno-102-11 href=#__codelineno-102-11></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-102-12><a id=__codelineno-102-12 name=__codelineno-102-12 href=#__codelineno-102-12></a>
</span><span id=__span-102-13><a id=__codelineno-102-13 name=__codelineno-102-13 href=#__codelineno-102-13></a><span class=w>  </span><span class=n>jobs</span><span class=p>.</span><span class=na>removeIfCurrent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>engineJob</span><span class=p>);</span>
</span><span id=__span-102-14><a id=__codelineno-102-14 name=__codelineno-102-14 href=#__codelineno-102-14></a><span class=p>}</span>
</span><span id=__span-102-15><a id=__codelineno-102-15 name=__codelineno-102-15 href=#__codelineno-102-15></a>
</span><span id=__span-102-16><a id=__codelineno-102-16 name=__codelineno-102-16 href=#__codelineno-102-16></a><span class=nd>@Override</span>
</span><span id=__span-102-17><a id=__codelineno-102-17 name=__codelineno-102-17 href=#__codelineno-102-17></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-102-18><a id=__codelineno-102-18 name=__codelineno-102-18 href=#__codelineno-102-18></a><span class=w>  </span><span class=n>activeResources</span><span class=p>.</span><span class=na>deactivate</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span>
</span><span id=__span-102-19><a id=__codelineno-102-19 name=__codelineno-102-19 href=#__codelineno-102-19></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-102-20><a id=__codelineno-102-20 name=__codelineno-102-20 href=#__codelineno-102-20></a><span class=w>    </span><span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-102-21><a id=__codelineno-102-21 name=__codelineno-102-21 href=#__codelineno-102-21></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-102-22><a id=__codelineno-102-22 name=__codelineno-102-22 href=#__codelineno-102-22></a><span class=w>    </span><span class=n>resourceRecycler</span><span class=p>.</span><span class=na>recycle</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-102-23><a id=__codelineno-102-23 name=__codelineno-102-23 href=#__codelineno-102-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-102-24><a id=__codelineno-102-24 name=__codelineno-102-24 href=#__codelineno-102-24></a><span class=p>}</span>
</span></code></pre></div> <p>然后看下<code>entry.executor.execute(new CallResourceReady(entry.cb));</code>的实现，<code>Executors.mainThreadExecutor()</code>的实现之前说过，就是一个使用MainLooper的Handler，在execute Runnable时使用此Handler post出去。所以我们的关注点就在<code>CallResourceReady</code>上面了：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-103-1><a id=__codelineno-103-1 name=__codelineno-103-1 href=#__codelineno-103-1></a><span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>CallResourceReady</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-103-2><a id=__codelineno-103-2 name=__codelineno-103-2 href=#__codelineno-103-2></a>
</span><span id=__span-103-3><a id=__codelineno-103-3 name=__codelineno-103-3 href=#__codelineno-103-3></a><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceCallback</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-103-4><a id=__codelineno-103-4 name=__codelineno-103-4 href=#__codelineno-103-4></a>
</span><span id=__span-103-5><a id=__codelineno-103-5 name=__codelineno-103-5 href=#__codelineno-103-5></a><span class=w>    </span><span class=n>CallResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span><span class=w> </span><span class=n>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-103-6><a id=__codelineno-103-6 name=__codelineno-103-6 href=#__codelineno-103-6></a><span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span>
</span><span id=__span-103-7><a id=__codelineno-103-7 name=__codelineno-103-7 href=#__codelineno-103-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-103-8><a id=__codelineno-103-8 name=__codelineno-103-8 href=#__codelineno-103-8></a>
</span><span id=__span-103-9><a id=__codelineno-103-9 name=__codelineno-103-9 href=#__codelineno-103-9></a><span class=w>    </span><span class=nd>@Override</span>
</span><span id=__span-103-10><a id=__codelineno-103-10 name=__codelineno-103-10 href=#__codelineno-103-10></a><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-103-11><a id=__codelineno-103-11 name=__codelineno-103-11 href=#__codelineno-103-11></a><span class=w>      </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>EngineJob</span><span class=p>.</span><span class=na>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-103-12><a id=__codelineno-103-12 name=__codelineno-103-12 href=#__codelineno-103-12></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>cb</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-103-13><a id=__codelineno-103-13 name=__codelineno-103-13 href=#__codelineno-103-13></a><span class=w>          </span><span class=c1>// Acquire for this particular callback.</span>
</span><span id=__span-103-14><a id=__codelineno-103-14 name=__codelineno-103-14 href=#__codelineno-103-14></a><span class=w>          </span><span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
</span><span id=__span-103-15><a id=__codelineno-103-15 name=__codelineno-103-15 href=#__codelineno-103-15></a><span class=w>          </span><span class=n>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
</span><span id=__span-103-16><a id=__codelineno-103-16 name=__codelineno-103-16 href=#__codelineno-103-16></a><span class=w>          </span><span class=n>removeCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
</span><span id=__span-103-17><a id=__codelineno-103-17 name=__codelineno-103-17 href=#__codelineno-103-17></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-103-18><a id=__codelineno-103-18 name=__codelineno-103-18 href=#__codelineno-103-18></a><span class=w>        </span><span class=n>decrementPendingCallbacks</span><span class=p>();</span>
</span><span id=__span-103-19><a id=__codelineno-103-19 name=__codelineno-103-19 href=#__codelineno-103-19></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-103-20><a id=__codelineno-103-20 name=__codelineno-103-20 href=#__codelineno-103-20></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-103-21><a id=__codelineno-103-21 name=__codelineno-103-21 href=#__codelineno-103-21></a><span class=w>  </span><span class=p>}</span>
</span></code></pre></div> <p>ummmm，抛开同步操作不谈，首先调用<code>callCallbackOnResourceReady(cb)</code>调用callback，然后调用<code>removeCallback(cb)</code>移除callback。看看<code>callCallbackOnResourceReady(cb)</code>：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-104-1><a id=__codelineno-104-1 name=__codelineno-104-1 href=#__codelineno-104-1></a><span class=nd>@Synthetic</span>
</span><span id=__span-104-2><a id=__codelineno-104-2 name=__codelineno-104-2 href=#__codelineno-104-2></a><span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span><span class=w> </span><span class=n>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-104-3><a id=__codelineno-104-3 name=__codelineno-104-3 href=#__codelineno-104-3></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-104-4><a id=__codelineno-104-4 name=__codelineno-104-4 href=#__codelineno-104-4></a><span class=w>      </span><span class=c1>// This is overly broad, some Glide code is actually called here, but it&#39;s much</span>
</span><span id=__span-104-5><a id=__codelineno-104-5 name=__codelineno-104-5 href=#__codelineno-104-5></a><span class=w>      </span><span class=c1>// simpler to encapsulate here than to do so at the actual call point in the</span>
</span><span id=__span-104-6><a id=__codelineno-104-6 name=__codelineno-104-6 href=#__codelineno-104-6></a><span class=w>      </span><span class=c1>// Request implementation.</span>
</span><span id=__span-104-7><a id=__codelineno-104-7 name=__codelineno-104-7 href=#__codelineno-104-7></a><span class=w>      </span><span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>engineResource</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span>
</span><span id=__span-104-8><a id=__codelineno-104-8 name=__codelineno-104-8 href=#__codelineno-104-8></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-104-9><a id=__codelineno-104-9 name=__codelineno-104-9 href=#__codelineno-104-9></a><span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>CallbackException</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
</span><span id=__span-104-10><a id=__codelineno-104-10 name=__codelineno-104-10 href=#__codelineno-104-10></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-104-11><a id=__codelineno-104-11 name=__codelineno-104-11 href=#__codelineno-104-11></a><span class=w>  </span><span class=p>}</span>
</span></code></pre></div> <p>这里就调用了<code>cb.onResourceReady</code>，这里说到过entry.cb就是SingleRequest。所以继续看看<code>SingleRequest.onResourceReady</code>方法，很显然<code>onResourceReady(Resource&lt;?&gt;, DataSource)</code>都在做sanity check，最后调用了<code>onResourceReady(Resource&lt;?&gt;, R, DataSource)</code>：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-105-1><a id=__codelineno-105-1 name=__codelineno-105-1 href=#__codelineno-105-1></a><span class=nd>@Override</span>
</span><span id=__span-105-2><a id=__codelineno-105-2 name=__codelineno-105-2 href=#__codelineno-105-2></a><span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-105-3><a id=__codelineno-105-3 name=__codelineno-105-3 href=#__codelineno-105-3></a><span class=w>  </span><span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
</span><span id=__span-105-4><a id=__codelineno-105-4 name=__codelineno-105-4 href=#__codelineno-105-4></a><span class=w>  </span><span class=n>loadStatus</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-105-5><a id=__codelineno-105-5 name=__codelineno-105-5 href=#__codelineno-105-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-105-6><a id=__codelineno-105-6 name=__codelineno-105-6 href=#__codelineno-105-6></a><span class=w>    </span><span class=n>GlideException</span><span class=w> </span><span class=n>exception</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Expected to receive a Resource&lt;R&gt; with an &quot;</span>
</span><span id=__span-105-7><a id=__codelineno-105-7 name=__codelineno-105-7 href=#__codelineno-105-7></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=s>&quot;object of &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>transcodeClass</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; inside, but instead got null.&quot;</span><span class=p>);</span>
</span><span id=__span-105-8><a id=__codelineno-105-8 name=__codelineno-105-8 href=#__codelineno-105-8></a><span class=w>    </span><span class=n>onLoadFailed</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
</span><span id=__span-105-9><a id=__codelineno-105-9 name=__codelineno-105-9 href=#__codelineno-105-9></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-105-10><a id=__codelineno-105-10 name=__codelineno-105-10 href=#__codelineno-105-10></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-105-11><a id=__codelineno-105-11 name=__codelineno-105-11 href=#__codelineno-105-11></a>
</span><span id=__span-105-12><a id=__codelineno-105-12 name=__codelineno-105-12 href=#__codelineno-105-12></a><span class=w>  </span><span class=n>Object</span><span class=w> </span><span class=n>received</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resource</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
</span><span id=__span-105-13><a id=__codelineno-105-13 name=__codelineno-105-13 href=#__codelineno-105-13></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>received</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>transcodeClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>received</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-105-14><a id=__codelineno-105-14 name=__codelineno-105-14 href=#__codelineno-105-14></a><span class=w>    </span><span class=n>releaseResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-105-15><a id=__codelineno-105-15 name=__codelineno-105-15 href=#__codelineno-105-15></a><span class=w>    </span><span class=n>GlideException</span><span class=w> </span><span class=n>exception</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Expected to receive an object of &quot;</span>
</span><span id=__span-105-16><a id=__codelineno-105-16 name=__codelineno-105-16 href=#__codelineno-105-16></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=n>transcodeClass</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; but instead&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; got &quot;</span>
</span><span id=__span-105-17><a id=__codelineno-105-17 name=__codelineno-105-17 href=#__codelineno-105-17></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>received</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>received</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;{&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>received</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;} inside&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; &quot;</span>
</span><span id=__span-105-18><a id=__codelineno-105-18 name=__codelineno-105-18 href=#__codelineno-105-18></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=s>&quot;Resource{&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>resource</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;}.&quot;</span>
</span><span id=__span-105-19><a id=__codelineno-105-19 name=__codelineno-105-19 href=#__codelineno-105-19></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>received</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;To indicate failure return a null Resource &quot;</span>
</span><span id=__span-105-20><a id=__codelineno-105-20 name=__codelineno-105-20 href=#__codelineno-105-20></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=s>&quot;object, rather than a Resource object containing null data.&quot;</span><span class=p>));</span>
</span><span id=__span-105-21><a id=__codelineno-105-21 name=__codelineno-105-21 href=#__codelineno-105-21></a><span class=w>    </span><span class=n>onLoadFailed</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
</span><span id=__span-105-22><a id=__codelineno-105-22 name=__codelineno-105-22 href=#__codelineno-105-22></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-105-23><a id=__codelineno-105-23 name=__codelineno-105-23 href=#__codelineno-105-23></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-105-24><a id=__codelineno-105-24 name=__codelineno-105-24 href=#__codelineno-105-24></a>
</span><span id=__span-105-25><a id=__codelineno-105-25 name=__codelineno-105-25 href=#__codelineno-105-25></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>canSetResource</span><span class=p>())</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-105-26><a id=__codelineno-105-26 name=__codelineno-105-26 href=#__codelineno-105-26></a><span class=w>    </span><span class=n>releaseResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-105-27><a id=__codelineno-105-27 name=__codelineno-105-27 href=#__codelineno-105-27></a><span class=w>    </span><span class=c1>// We can&#39;t put the status to complete before asking canSetResource().</span>
</span><span id=__span-105-28><a id=__codelineno-105-28 name=__codelineno-105-28 href=#__codelineno-105-28></a><span class=w>    </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>;</span>
</span><span id=__span-105-29><a id=__codelineno-105-29 name=__codelineno-105-29 href=#__codelineno-105-29></a><span class=w>    </span><span class=k>return</span><span class=p>;</span>
</span><span id=__span-105-30><a id=__codelineno-105-30 name=__codelineno-105-30 href=#__codelineno-105-30></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-105-31><a id=__codelineno-105-31 name=__codelineno-105-31 href=#__codelineno-105-31></a>
</span><span id=__span-105-32><a id=__codelineno-105-32 name=__codelineno-105-32 href=#__codelineno-105-32></a><span class=w>  </span><span class=n>onResourceReady</span><span class=p>((</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=p>(</span><span class=n>R</span><span class=p>)</span><span class=w> </span><span class=n>received</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span>
</span><span id=__span-105-33><a id=__codelineno-105-33 name=__codelineno-105-33 href=#__codelineno-105-33></a><span class=p>}</span>
</span></code></pre></div> <p><code>onResourceReady(Resource&lt;?&gt;, R, DataSource)</code>方法如下，其处理过程和<code>onLoadFailed</code>方法非常类似：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-106-1><a id=__codelineno-106-1 name=__codelineno-106-1 href=#__codelineno-106-1></a><span class=kd>private</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=w> </span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-2><a id=__codelineno-106-2 name=__codelineno-106-2 href=#__codelineno-106-2></a><span class=w>  </span><span class=c1>// We must call isFirstReadyResource before setting status.</span>
</span><span id=__span-106-3><a id=__codelineno-106-3 name=__codelineno-106-3 href=#__codelineno-106-3></a><span class=w>  </span><span class=c1>// 由于requestCoordinator为null，所以返回true</span>
</span><span id=__span-106-4><a id=__codelineno-106-4 name=__codelineno-106-4 href=#__codelineno-106-4></a><span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>isFirstResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isFirstReadyResource</span><span class=p>();</span>
</span><span id=__span-106-5><a id=__codelineno-106-5 name=__codelineno-106-5 href=#__codelineno-106-5></a><span class=w>  </span><span class=c1>// 将status状态设置为COMPLETE</span>
</span><span id=__span-106-6><a id=__codelineno-106-6 name=__codelineno-106-6 href=#__codelineno-106-6></a><span class=w>  </span><span class=n>status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>;</span>
</span><span id=__span-106-7><a id=__codelineno-106-7 name=__codelineno-106-7 href=#__codelineno-106-7></a><span class=w>  </span><span class=k>this</span><span class=p>.</span><span class=na>resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resource</span><span class=p>;</span>
</span><span id=__span-106-8><a id=__codelineno-106-8 name=__codelineno-106-8 href=#__codelineno-106-8></a>
</span><span id=__span-106-9><a id=__codelineno-106-9 name=__codelineno-106-9 href=#__codelineno-106-9></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>glideContext</span><span class=p>.</span><span class=na>getLogLevel</span><span class=p>()</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-10><a id=__codelineno-106-10 name=__codelineno-106-10 href=#__codelineno-106-10></a><span class=w>    </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Finished loading &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; from &quot;</span>
</span><span id=__span-106-11><a id=__codelineno-106-11 name=__codelineno-106-11 href=#__codelineno-106-11></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; for &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>model</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; with size [&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>width</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;x&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>height</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;] in &quot;</span>
</span><span id=__span-106-12><a id=__codelineno-106-12 name=__codelineno-106-12 href=#__codelineno-106-12></a><span class=w>        </span><span class=o>+</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; ms&quot;</span><span class=p>);</span>
</span><span id=__span-106-13><a id=__codelineno-106-13 name=__codelineno-106-13 href=#__codelineno-106-13></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-106-14><a id=__codelineno-106-14 name=__codelineno-106-14 href=#__codelineno-106-14></a>
</span><span id=__span-106-15><a id=__codelineno-106-15 name=__codelineno-106-15 href=#__codelineno-106-15></a><span class=w>  </span><span class=n>isCallingCallbacks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span>
</span><span id=__span-106-16><a id=__codelineno-106-16 name=__codelineno-106-16 href=#__codelineno-106-16></a><span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-17><a id=__codelineno-106-17 name=__codelineno-106-17 href=#__codelineno-106-17></a><span class=w>     </span><span class=c1>// 尝试调用各个listener的onResourceReady回调进行处理</span>
</span><span id=__span-106-18><a id=__codelineno-106-18 name=__codelineno-106-18 href=#__codelineno-106-18></a><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>anyListenerHandledUpdatingTarget</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-106-19><a id=__codelineno-106-19 name=__codelineno-106-19 href=#__codelineno-106-19></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>requestListeners</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-20><a id=__codelineno-106-20 name=__codelineno-106-20 href=#__codelineno-106-20></a><span class=w>      </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>listener</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>requestListeners</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-21><a id=__codelineno-106-21 name=__codelineno-106-21 href=#__codelineno-106-21></a><span class=w>        </span><span class=n>anyListenerHandledUpdatingTarget</span><span class=w> </span><span class=o>|=</span>
</span><span id=__span-106-22><a id=__codelineno-106-22 name=__codelineno-106-22 href=#__codelineno-106-22></a><span class=w>            </span><span class=n>listener</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>isFirstResource</span><span class=p>);</span>
</span><span id=__span-106-23><a id=__codelineno-106-23 name=__codelineno-106-23 href=#__codelineno-106-23></a><span class=w>      </span><span class=p>}</span>
</span><span id=__span-106-24><a id=__codelineno-106-24 name=__codelineno-106-24 href=#__codelineno-106-24></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-106-25><a id=__codelineno-106-25 name=__codelineno-106-25 href=#__codelineno-106-25></a><span class=w>    </span><span class=n>anyListenerHandledUpdatingTarget</span><span class=w> </span><span class=o>|=</span>
</span><span id=__span-106-26><a id=__codelineno-106-26 name=__codelineno-106-26 href=#__codelineno-106-26></a><span class=w>        </span><span class=n>targetListener</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span>
</span><span id=__span-106-27><a id=__codelineno-106-27 name=__codelineno-106-27 href=#__codelineno-106-27></a><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>targetListener</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>target</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>isFirstResource</span><span class=p>);</span>
</span><span id=__span-106-28><a id=__codelineno-106-28 name=__codelineno-106-28 href=#__codelineno-106-28></a>
</span><span id=__span-106-29><a id=__codelineno-106-29 name=__codelineno-106-29 href=#__codelineno-106-29></a><span class=w>    </span><span class=c1>// 如果没有一个回调能够处理，那么自己处理</span>
</span><span id=__span-106-30><a id=__codelineno-106-30 name=__codelineno-106-30 href=#__codelineno-106-30></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-31><a id=__codelineno-106-31 name=__codelineno-106-31 href=#__codelineno-106-31></a><span class=w>      </span><span class=c1>// animationFactory默认为NoTransition.getFactory()，生成的animation为NO_ANIMATION</span>
</span><span id=__span-106-32><a id=__codelineno-106-32 name=__codelineno-106-32 href=#__codelineno-106-32></a><span class=w>      </span><span class=n>Transition</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>animation</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-106-33><a id=__codelineno-106-33 name=__codelineno-106-33 href=#__codelineno-106-33></a><span class=w>          </span><span class=n>animationFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>isFirstResource</span><span class=p>);</span>
</span><span id=__span-106-34><a id=__codelineno-106-34 name=__codelineno-106-34 href=#__codelineno-106-34></a><span class=w>      </span><span class=c1>// target为DrawableImageViewTarget</span>
</span><span id=__span-106-35><a id=__codelineno-106-35 name=__codelineno-106-35 href=#__codelineno-106-35></a><span class=w>      </span><span class=n>target</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>animation</span><span class=p>);</span>
</span><span id=__span-106-36><a id=__codelineno-106-36 name=__codelineno-106-36 href=#__codelineno-106-36></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-106-37><a id=__codelineno-106-37 name=__codelineno-106-37 href=#__codelineno-106-37></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-106-38><a id=__codelineno-106-38 name=__codelineno-106-38 href=#__codelineno-106-38></a><span class=w>    </span><span class=n>isCallingCallbacks</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span>
</span><span id=__span-106-39><a id=__codelineno-106-39 name=__codelineno-106-39 href=#__codelineno-106-39></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-106-40><a id=__codelineno-106-40 name=__codelineno-106-40 href=#__codelineno-106-40></a>
</span><span id=__span-106-41><a id=__codelineno-106-41 name=__codelineno-106-41 href=#__codelineno-106-41></a><span class=w>  </span><span class=c1>// 通知requestCoordinator</span>
</span><span id=__span-106-42><a id=__codelineno-106-42 name=__codelineno-106-42 href=#__codelineno-106-42></a><span class=w>  </span><span class=n>notifyLoadSuccess</span><span class=p>();</span>
</span><span id=__span-106-43><a id=__codelineno-106-43 name=__codelineno-106-43 href=#__codelineno-106-43></a><span class=p>}</span>
</span></code></pre></div> <p><code>DrawableImageViewTarget</code>的基类<code>ImageViewTarget</code>实现了此方法：</p> <div class="language-java highlight"><pre><span></span><code><span id=__span-107-1><a id=__codelineno-107-1 name=__codelineno-107-1 href=#__codelineno-107-1></a><span class=c1>// ImageViewTarget.java</span>
</span><span id=__span-107-2><a id=__codelineno-107-2 name=__codelineno-107-2 href=#__codelineno-107-2></a><span class=nd>@Override</span>
</span><span id=__span-107-3><a id=__codelineno-107-3 name=__codelineno-107-3 href=#__codelineno-107-3></a><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReady</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Z</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Transition</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>transition</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-4><a id=__codelineno-107-4 name=__codelineno-107-4 href=#__codelineno-107-4></a><span class=w>  </span><span class=c1>// NO_ANIMATION.transition返回false，所以直接调用setResourceInternal方法</span>
</span><span id=__span-107-5><a id=__codelineno-107-5 name=__codelineno-107-5 href=#__codelineno-107-5></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>transition</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>transition</span><span class=p>.</span><span class=na>transition</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-6><a id=__codelineno-107-6 name=__codelineno-107-6 href=#__codelineno-107-6></a><span class=w>    </span><span class=n>setResourceInternal</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-107-7><a id=__codelineno-107-7 name=__codelineno-107-7 href=#__codelineno-107-7></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-8><a id=__codelineno-107-8 name=__codelineno-107-8 href=#__codelineno-107-8></a><span class=w>    </span><span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-107-9><a id=__codelineno-107-9 name=__codelineno-107-9 href=#__codelineno-107-9></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-107-10><a id=__codelineno-107-10 name=__codelineno-107-10 href=#__codelineno-107-10></a><span class=p>}</span>
</span><span id=__span-107-11><a id=__codelineno-107-11 name=__codelineno-107-11 href=#__codelineno-107-11></a>
</span><span id=__span-107-12><a id=__codelineno-107-12 name=__codelineno-107-12 href=#__codelineno-107-12></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setResourceInternal</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Z</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-13><a id=__codelineno-107-13 name=__codelineno-107-13 href=#__codelineno-107-13></a><span class=w>  </span><span class=c1>// Order matters here. Set the resource first to make sure that the Drawable has a valid and</span>
</span><span id=__span-107-14><a id=__codelineno-107-14 name=__codelineno-107-14 href=#__codelineno-107-14></a><span class=w>  </span><span class=c1>// non-null Callback before starting it.</span>
</span><span id=__span-107-15><a id=__codelineno-107-15 name=__codelineno-107-15 href=#__codelineno-107-15></a><span class=w>  </span><span class=c1>// 先设置图片</span>
</span><span id=__span-107-16><a id=__codelineno-107-16 name=__codelineno-107-16 href=#__codelineno-107-16></a><span class=w>  </span><span class=n>setResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-107-17><a id=__codelineno-107-17 name=__codelineno-107-17 href=#__codelineno-107-17></a><span class=w>  </span><span class=c1>// 然后如果是动画，会执行动画</span>
</span><span id=__span-107-18><a id=__codelineno-107-18 name=__codelineno-107-18 href=#__codelineno-107-18></a><span class=w>  </span><span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-107-19><a id=__codelineno-107-19 name=__codelineno-107-19 href=#__codelineno-107-19></a><span class=p>}</span>
</span><span id=__span-107-20><a id=__codelineno-107-20 name=__codelineno-107-20 href=#__codelineno-107-20></a>
</span><span id=__span-107-21><a id=__codelineno-107-21 name=__codelineno-107-21 href=#__codelineno-107-21></a><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>maybeUpdateAnimatable</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Z</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-22><a id=__codelineno-107-22 name=__codelineno-107-22 href=#__codelineno-107-22></a><span class=w>  </span><span class=c1>// BitmapDrawable显然不是一个Animatable对象，所以走else分支</span>
</span><span id=__span-107-23><a id=__codelineno-107-23 name=__codelineno-107-23 href=#__codelineno-107-23></a><span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Animatable</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-24><a id=__codelineno-107-24 name=__codelineno-107-24 href=#__codelineno-107-24></a><span class=w>    </span><span class=n>animatable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Animatable</span><span class=p>)</span><span class=w> </span><span class=n>resource</span><span class=p>;</span>
</span><span id=__span-107-25><a id=__codelineno-107-25 name=__codelineno-107-25 href=#__codelineno-107-25></a><span class=w>    </span><span class=n>animatable</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
</span><span id=__span-107-26><a id=__codelineno-107-26 name=__codelineno-107-26 href=#__codelineno-107-26></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-27><a id=__codelineno-107-27 name=__codelineno-107-27 href=#__codelineno-107-27></a><span class=w>    </span><span class=n>animatable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span>
</span><span id=__span-107-28><a id=__codelineno-107-28 name=__codelineno-107-28 href=#__codelineno-107-28></a><span class=w>  </span><span class=p>}</span>
</span><span id=__span-107-29><a id=__codelineno-107-29 name=__codelineno-107-29 href=#__codelineno-107-29></a><span class=p>}</span>
</span><span id=__span-107-30><a id=__codelineno-107-30 name=__codelineno-107-30 href=#__codelineno-107-30></a>
</span><span id=__span-107-31><a id=__codelineno-107-31 name=__codelineno-107-31 href=#__codelineno-107-31></a><span class=c1>// DrawableImageViewTarget</span>
</span><span id=__span-107-32><a id=__codelineno-107-32 name=__codelineno-107-32 href=#__codelineno-107-32></a><span class=nd>@Override</span>
</span><span id=__span-107-33><a id=__codelineno-107-33 name=__codelineno-107-33 href=#__codelineno-107-33></a><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setResource</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Drawable</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-107-34><a id=__codelineno-107-34 name=__codelineno-107-34 href=#__codelineno-107-34></a><span class=w>  </span><span class=n>view</span><span class=p>.</span><span class=na>setImageDrawable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
</span><span id=__span-107-35><a id=__codelineno-107-35 name=__codelineno-107-35 href=#__codelineno-107-35></a><span class=p>}</span>
</span></code></pre></div> <p>OK，至此网络图片已经通过<code>view.setImageDrawable(resource)</code>加载完毕。完结撒花🎉🎉🎉🎉🎉🎉🎉 </p> <p>But，整个流程看的脑阔疼。这篇文章从4月25号到今天5月5号经历了10天，抛开中间51的4天假，差不多也有一周之久，时断时续，一遍捋下来我自己也是半懵的，所以应该得有个总结吧。不然每次温习一遍，一遍就得温习几天。<br> 所以，接下来的几篇文章，每篇都会选取一个方面进行总结。此外，本文的流程图如下：</p> <figure style="width: 95%" class=align-center> <img src=/assets/images/android/glide-overview.png> <figcaption>Glide整体流程图</figcaption> </figure> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2022-08-29T07:13:31+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2022-08-29</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago"><span class=timeago datetime=2019-04-23T08:24:23+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2019-04-23</span> </span> </aside> <!-- Giscus --> <h2 id=__comments>评论</h2> <!-- Replace with generated snippet --> <script src=https://giscus.app/client.js data-repo=YorekLiu/yorekliu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTQwNzYzODQ=" data-category=Announcements data-category-id=DIC_kwDOBsyq4M4CP9fq data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Synchronize Giscus theme with palette --> <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2024 Yorek </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/YorekLiu target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top", "navigation.tracking", "navigation.expand", "search.suggest", "search.highlight", "search.share", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.d7c377c4.min.js></script> <script src=../../../js/timeago.min.js></script> <script src=../../../js/timeago_mkdocs_material.js></script> <script src=../../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>
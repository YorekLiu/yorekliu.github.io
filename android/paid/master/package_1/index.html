<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An Android Developer."><meta name=author content="Yorek Liu"><link href=https://blog.yorek.xyz/android/paid/master/package_1/ rel=canonical><link rel=icon href=../../../../assets/images/favicon.webp><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.3.2"><title>22 | 包体积优化（上）：如何减少安装包大小？ - Yorek's</title><link rel=stylesheet href=../../../../assets/stylesheets/main.5d38496d.min.css><link rel=stylesheet href=../../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans SC";--md-code-font:"JetBrains Mono"}</style><script>__md_scope=new URL("../../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-155096376-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../../.. title="Yorek's" class="md-header__button md-logo" aria-label="Yorek's" data-md-component=logo> <img src=../../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Yorek's </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 22 | 包体积优化（上）：如何减少安装包大小？ </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../../3rd-library/3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../.. title="Yorek's" class="md-nav__button md-logo" aria-label="Yorek's" data-md-component=logo> <img src=../../../../assets/images/favicon.webp alt=logo> </a> Yorek's </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_1 type=checkbox id=__nav_1_1> <label class=md-nav__link for=__nav_1_1> 三方库系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=三方库系列 data-md-level=2> <label class=md-nav__title for=__nav_1_1> <span class="md-nav__icon md-icon"></span> 三方库系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../3rd-library/3rd-library-source-code/ class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix/ class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-trace/ class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-trace-plugin/ class=md-nav__link> Matrix-ASM插桩插件解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-io/ class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-resource/ class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-apk-checker/ class=md-nav__link> Matrix-ApkChecker：安装包分析检测工具 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/andresguard/ class=md-nav__link> AndResGuard资源混淆原理浅析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/hprof-shrink/ class=md-nav__link> 剖析hprof文件的两种主要裁剪流派 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/okhttp/ class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/retrofit/ class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/rxjava%26rxandroid/ class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../../other/RxJava/ class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide1/ class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide2/ class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide3/ class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide4/ class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide5/ class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide6/ class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/glide7/ class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/migrate-to-glide/ class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/eventbus/ class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/leakcanary/ class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/permissiondispatcher/ class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../../other/constraintlayout/ class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../../other/dagger2/ class=md-nav__link> 初学者的Dagger2教程 </a> </li> <li class=md-nav__item> <a href=../../../3rd-library/hotfix/ class=md-nav__link> Hotfix方案初探 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2> <label class=md-nav__link for=__nav_1_2> framework系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=framework系列 data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../../framework/Drawable/ class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder1-mediaservice/ class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../../framework/binder2/ class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 type=checkbox id=__nav_1_3> <label class=md-nav__link for=__nav_1_3> 杂记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=杂记 data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> 杂记 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../other/commands/ class=md-nav__link> Android开发常见命令 </a> </li> <li class=md-nav__item> <a href=../../../other/android-tv/ class=md-nav__link> Android TV 专项 </a> </li> <li class=md-nav__item> <a href=../../../other/annotation/ class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../../other/best_throttle_in_mvvm/ class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../../other/SystemProrities/ class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-cache/ class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../../other/recyclerview-others/ class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../../other/nestedscrolling/ class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../../other/porterduff/ class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../../other/android_alias/ class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../../other/Android-Development-Tool/ class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../../other/soft-keyboard-in-app/ class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> 琐碎知识点 </a> </li> <li class=md-nav__item> <a href=../../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> 琐碎知识点2 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 type=checkbox id=__nav_1_4> <label class=md-nav__link for=__nav_1_4> 基础知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础知识 data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../zsxq/week1-synchronized/ class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week2-service/ class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../zsxq/week3-activity/ class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week4-startActivityForResult/ class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../zsxq/week5-view/ class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week6-gradle/ class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week7-serialization/ class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week10-classloader/ class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../zsxq/week11-binder/ class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week14-jvm-gc/ class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week16-keep-app-alive/ class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week17-android-components/ class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week20-network-protocol/ class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../zsxq/week23-load-large-bitmap/ class=md-nav__link> 大尺寸图片加载问题 </a> </li> <li class=md-nav__item> <a href=../../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-collections/ class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../../java/java-foundation/ class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_5 type=checkbox id=__nav_1_5 checked> <label class=md-nav__link for=__nav_1_5> Android开发高手课 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android开发高手课 data-md-level=2> <label class=md-nav__title for=__nav_1_5> <span class="md-nav__icon md-icon"></span> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../crash_1/ class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../crash_2/ class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../memory_1/ class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../memory_2/ class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../stuck_1/ class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../stuck_2/ class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../stuck_3/ class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../start_1/ class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../start_2/ class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../io_1/ class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../io_2/ class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../io_3/ class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../storage_1/ class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../storage_2/ class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../storage_3/ class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../network_1/ class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../network_2/ class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../network_3/ class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../battery_1/ class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../battery_2/ class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../ui_1/ class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../ui_2/ class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 22 | 包体积优化（上）：如何减少安装包大小？ <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 22 | 包体积优化（上）：如何减少安装包大小？ </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 安装包的背景知识 </a> <nav class=md-nav aria-label=安装包的背景知识> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 为什么要优化包体积 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 包体积与应用性能 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 包体积优化 </a> <nav class=md-nav aria-label=包体积优化> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1_1 class=md-nav__link> 1. 代码 </a> <nav class=md-nav aria-label="1. 代码"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#proguard class=md-nav__link> ProGuard </a> </li> <li class=md-nav__item> <a href=#debug class=md-nav__link> 去掉 Debug 信息或者去掉行号 </a> </li> <li class=md-nav__item> <a href=#dex class=md-nav__link> Dex 分包 </a> </li> <li class=md-nav__item> <a href=#dex_1 class=md-nav__link> Dex 压缩 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-native-library class=md-nav__link> 2. Native Library </a> <nav class=md-nav aria-label="2. Native Library"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#library class=md-nav__link> Library 压缩 </a> </li> <li class=md-nav__item> <a href=#library_1 class=md-nav__link> Library 合并与裁剪 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 包体积监控 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 课后作业 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../package_2/ class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../compile/ class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../bytecode/ class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../native_hook/ class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_1/ class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_2/ class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_3/ class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../../flutter/flutter_first_project_4/ class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../leetcode/ class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_1/ class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_3/ class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_4/ class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_5/ class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/code_interviews_6/ class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../design-pattern/design-pattern/ class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/design-principle/ class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/singleton/ class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/builder/ class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/prototype/ class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/factory-method/ class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/abstract-factory/ class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/proxy/ class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/composite/ class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/adapter/ class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/decorator/ class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/flyweight/ class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/facade/ class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/bridge/ class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/strategy/ class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/state/ class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/chain-of-responsibility/ class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/interpreter/ class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/command/ class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/observer/ class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/memento/ class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/iterator/ class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/template-method/ class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/visitor/ class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/mediator/ class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../../design-pattern/confusing-design-pattern/ class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../effective-java/effective-java/ class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter1/ class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter2/ class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../../effective-java/chapter3/ class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../jvm/jvm-content/ class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-memory-area-oom/ class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/java-gc/ class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/class-struct/ class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../../jvm/load-class/ class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../refactoring/refactoring/ class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 安装包的背景知识 </a> <nav class=md-nav aria-label=安装包的背景知识> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1 class=md-nav__link> 1. 为什么要优化包体积 </a> </li> <li class=md-nav__item> <a href=#2 class=md-nav__link> 2. 包体积与应用性能 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 包体积优化 </a> <nav class=md-nav aria-label=包体积优化> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1_1 class=md-nav__link> 1. 代码 </a> <nav class=md-nav aria-label="1. 代码"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#proguard class=md-nav__link> ProGuard </a> </li> <li class=md-nav__item> <a href=#debug class=md-nav__link> 去掉 Debug 信息或者去掉行号 </a> </li> <li class=md-nav__item> <a href=#dex class=md-nav__link> Dex 分包 </a> </li> <li class=md-nav__item> <a href=#dex_1 class=md-nav__link> Dex 压缩 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-native-library class=md-nav__link> 2. Native Library </a> <nav class=md-nav aria-label="2. Native Library"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#library class=md-nav__link> Library 压缩 </a> </li> <li class=md-nav__item> <a href=#library_1 class=md-nav__link> Library 合并与裁剪 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 包体积监控 </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 总结 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 课后作业 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>22 | 包体积优化（上）：如何减少安装包大小？</h1> <div class="admonition tip"> <p class=admonition-title>极客时间——<a href=https://time.geekbang.org/column/intro/142>Android开发高手课</a></p> <p>本栏目内容源于<a href=https://time.geekbang.org/column/intro/142>Android开发高手课</a>，外加Sample的个人练习小结。本栏目内的内容将会持续混合着博主个人的收集到的知识点。若本栏目内容令人不适，请移步原始课程。 </p> </div> <p>曾经在 15 年的时候，我在 WeMobileDev 公众号就写过一篇文章<a href=https://mp.weixin.qq.com/s/QRIy_apwqAaL2pM8a_lRUQ>《Android 安装包相关知识汇总》</a>，也开源了一个不少同学都使用过的资源混淆工具<a href=https://mp.weixin.qq.com/s/6YUJlGmhf1-Q-5KMvZ_8_Q>AndResGuard</a>。</p> <p>现在再看看这篇 4 年前的文章，就像看到了 4 年前的自己，感触颇多啊。几年过去了，网上随意一搜都有大量安装包优化的文章，那还有哪些“高深”的珍藏秘笈值得分享呢？</p> <p>时至今日，微信包体积也从当年的 30MB 增长到现在的 100MB 了。我们经常会想，现在 WiFi 这么普遍了，而且 5G 都要来了，包体积优化究竟还有没有意义？它对用户和应用的价值在哪里？</p> <h2 id=_1>安装包的背景知识<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>还记得在 2G 时代，我们每个月只有 30MB 流量，那个时候安装包体积确实至关重要。当时我在做“搜狗输入法”的时候，我们就严格要求包体积在 5MB 以内。</p> <p>几年过去了，我们对包体积的看法有什么改变吗？</p> <h3 id=1>1. 为什么要优化包体积<a class=headerlink href=#1 title="Permanent link">&para;</a></h3> <p>在 2018 年的 Google I/O，Google 透露了 Google Play 上安装包体积与下载转化率的关系图。</p> <p><img alt=package_1_1 src=/assets/images/android/master/package_1_1.png></p> <p>从这张图上看，大体来说，安装包越小，转化率越高这个结论依然成立。而包体积对应用的影响，主要有下面几点：</p> <ul> <li><strong>下载转化率</strong>。一个 100MB 的应用，用户即使点了下载，也可能因为网络速度慢、突然反悔下载失败。对于一个 10MB 的应用，用户点了下载之后，在犹豫要不要下的时候已经下载完了。但是正如上图的数据，安装包大小与转化率的关系是非常微妙的。10MB 跟 15MB 可能差距不大，但是 10MB 跟 40MB 的差距还是非常明显的。</li> <li><strong>推广成本</strong>。一般来说，包体积对渠道推广和厂商预装的单价会有非常大的影响。特别是厂商预装，这主要是因为厂商留给预装应用的总空间是有限的。如果你的包体积非常大，那就会影响厂商预装其他应用。</li> <li><strong>应用市场</strong>。苹果的 App Store 强制超过 150MB 的应用只能使用 WiFi 网络下载，Google Play 要求超过 100MB 的应用只能使用<a href=https://developer.android.com/google/play/expansion-files>APK 扩展文件</a>方式上传，由此可见应用包体积对应用市场的服务器带宽成本还是会有一点压力的。</li> </ul> <p>目前成熟的超级 App 越来越多，很多产品也希望自己成为下一个超级 App，希望功能可以包罗万象，满足用户的一切需求。但这同样也导致安装包不断变大，其实很多用户只使用到很少一部分功能。</p> <p>下面我们就来看看微信、QQ、支付宝以及淘宝这几款超级 App 这几年安装包增长的情况。</p> <p><img alt=package_1_2 src=/assets/images/android/master/package_1_2.png></p> <p>我还记得在 15 年的时候，为了让微信 6.2 版本小于 30MB，我使用了各种各样的手段，把体积从 34MB 降到 29.85MB，资源混淆工具 AndResGuard 也就是在那个优化专项中写的。几年过去了，微信包体积已经涨到 100MB 了，淘宝似乎也不容乐观。相比之下，QQ 和支付宝相对还比较节制。</p> <h3 id=2>2. 包体积与应用性能<a class=headerlink href=#2 title="Permanent link">&para;</a></h3> <p>React Native 5MB、Flutter 4MB、浏览器内核 20MB、Chromium 网络库 2MB…现在第三方开发框架和扩展库越来越多，很多的应用包体积都已经几十是 MB 起步了。</p> <p>那包体积除了转化率的影响，它对我们应用性能还有哪些影响呢？</p> <ul> <li><strong>安装时间</strong>。文件拷贝、Library 解压、编译 ODEX、签名校验，特别对于 Android 5.0 和 6.0 系统来说（Android 7.0 之后有了混合编译），微信 13 个 Dex 光是编译 ODEX 的时间可能就要 5 分钟。</li> <li><strong>运行内存</strong>。在内存优化的时候我们就说过，Resource 资源、Library 以及 Dex 类加载这些都会占用不少的内存。</li> <li><strong>ROM 空间</strong>。100MB 的安装包，启动解压之后很有可能就超过 200MB 了。对低端机用户来说，也会有很大的压力。在“I/O 优化”中我们讨论过，如果闪存空间不足，非常容易出现写入放大的情况。</li> </ul> <p>对于大部分一两年前的“千元机”，淘宝和微信都已经玩不转了。“技术短期内被高估，长期会被低估”，特别在业务高速发展的时候，性能往往就被排到后面。</p> <p>包体积对技术人员来说应该是非常重要的技术指标，我们不能放任它的增长，它对我们还有不少意义。</p> <ul> <li><strong>业务梳理</strong>。删除无用或者低价值的业务，永远都是最有效的性能优化方式。我们需要经常回顾过去的业务，不能只顾着往前冲，适时地还一些“技术债务”。</li> <li><strong>开发模式升级</strong>。如果所有的功能都不能移除，那可能需要倒逼开发模式的转变，更多地采用小程序、H5 这样开发模式。</li> </ul> <h2 id=_2>包体积优化<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>国内地开发者都非常羡慕海外的应用，因为海外有统一的 Google Play 市场。它可以根据用户的 ABI、density 和 language 发布，还有在 2018 年最新推出的<a href=https://developer.android.com/platform/technology/app-bundle/ >App Bundle</a>。</p> <p><img alt=package_1_3 src=/assets/images/android/master/package_1_3.png></p> <p>事实上安装包中无非就是 Dex、Resource、Assets、Library 以及签名信息这五部分，接下来我们就来看看对于国内应用来说，还有什么高级“秘籍”。</p> <h3 id=1_1>1. 代码<a class=headerlink href=#1_1 title="Permanent link">&para;</a></h3> <p>对于大部分应用来说，Dex 都是包体积中的大头。看一下上面表格中微信、QQ、支付宝和淘宝的数据，它们的 Dex 数量从 1 个增长到 10 多个，我们的代码量真的增长了那么多倍吗？</p> <p>而且 Dex 的数量对用户安装时间也是一个非常大的挑战，在不砍功能的前提下，我们看看有哪些方法可以减少这部分空间。</p> <h4 id=proguard>ProGuard<a class=headerlink href=#proguard title="Permanent link">&para;</a></h4> <p>“十个 ProGuard 配置九个坑”，特别是各种第三方 SDK。我们需要仔细检查最终合并的 ProGuard 配置文件，是不是存在过度 keep 的现象。</p> <p>你可以通过下面的方法输出 ProGuard 的最终配置，尤其需要注意各种的 keep *，很多情况下我们只需要 keep 其中的某个包、某个方法，或者是类名就可以了。</p> <div class=highlight><pre><span></span><code>-printconfiguration  configuration.txt
</code></pre></div> <p>那还有没有哪些方法可以进一步加大混淆力度呢？这时我们可能要向四大组件和 View 下手了。一般来说，应用都会 keep 住四大组件以及 View 的部分方法，这样是为了在代码以及 XML 布局中可以引用到它们。</p> <div class=highlight><pre><span></span><code>-keep public class * extends android.app.Activity
-keep public class * extends android.app.Application
-keep public class * extends android.app.Service
-keep public class * extends android.content.BroadcastReceiver
-keep public class * extends android.content.ContentProvider
-keep public class * extends android.view.View
</code></pre></div> <p>事实上，我们完全可以把 <strong>非 exported</strong> 的四大组件以及 View 混淆，但是需要完成下面几个工作：</p> <ul> <li><strong>XML 替换</strong>。在代码混淆之后，需要同时修改 AndroidManifest 以及资源 XML 中引用的名称。</li> <li><strong>代码替换</strong>。需要遍历其他已经混淆好的代码，将变量或者方法体中定义的字符串也同时修改。<strong>需要注意的是，代码中不能出现经过运算得到的类名，这种情况会导致替换失败</strong>。<br> <div class=highlight><pre><span></span><code><span class=c1>// 情况一：变量</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>activityName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;com.sample.TestActivity&quot;</span><span class=p>;</span><span class=w></span>
<span class=c1>// 情况二：方法体</span><span class=w></span>
<span class=n>startActivity</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=s>&quot;com.sample.TestActivity&quot;</span><span class=p>));</span><span class=w></span>
<span class=c1>// 情况三：通过运算得到，不支持</span><span class=w></span>
<span class=n>startActivity</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=s>&quot;com.sample&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;.TestActivity&quot;</span><span class=p>));</span><span class=w></span>
</code></pre></div></li> </ul> <p>代码替换的方法，我推荐使用 ASM。不熟悉 ASM 的同学也不用着急，后面我会专门讲它的原理和用法。饿了么曾经开源过一个可以实现四大组件和 View 混淆的组件<a href=https://github.com/eleme/Mess>Mess</a>，不过似乎已经没在维护了，可供你参考。</p> <p>Android Studio 3.0 推出了<a href=https://blog.dreamtobe.cn/android_d8_r8/ >新 Dex 编译器 D8 与新混淆工具 R8</a>，目前 D8 已经正式 Release，大约可以减少 3% 的 Dex 体积。但是计划用于取代 ProGuard 的<a href=https://www.guardsquare.com/en/blog/proguard-and-r8>R8</a>依然处于实验室阶段，期待它在未来能有更好的表现。</p> <h4 id=debug>去掉 Debug 信息或者去掉行号<a class=headerlink href=#debug title="Permanent link">&para;</a></h4> <p>某个应用通过相同的 ProGuard 规则生成一个 Debug 包和 Release 包，其中 Debug 包的大小是 4MB，Release 包只有 3.5MB。</p> <p>既然它们 ProGuard 的混淆与优化的规则是一样的，那它们之间的差异在哪里呢？那就是 DebugItem。</p> <p><img alt=package_1_4 src=/assets/images/android/master/package_1_4.png></p> <p>DebugItem 里面主要包含两种信息：</p> <ul> <li><strong>调试的信息</strong>。函数的参数变量和所有的局部变量。</li> <li><strong>排查问题的信息</strong>。所有的指令集行号和源文件行号的对应关系。</li> </ul> <p>事实上，在 ProGuard 配置中一般我们也会通过下面的方式保留行号信息。</p> <div class=highlight><pre><span></span><code>-keepattributes SourceFile, LineNumberTable
</code></pre></div> <p>对于去除 debuginfo 以及行号信息更详细的分析，推荐你认真看一下支付宝的一篇文章<a href=https://mp.weixin.qq.com/s/_gnT2kjqpfMFs0kqAg4Qig>《Android 包大小极致压缩》</a>。通过这个方法，我们可以实现既保留行号，但是又可以减少大约 5% 的 Dex 体积。</p> <p>事实上，支付宝参考的是 Facebook 的一个开源编译工具<a href=https://github.com/facebook/redex>ReDex</a>。ReDex 除了没有文档之外，绝对是客户端领域非常硬核的一个开源库，非常值得你去认真研究。</p> <p>ReDex 这个库里面的好东西实在是太多了，后面我们还会反复讲到，其中去除 Debug 信息是通过 StripDebugInfoPass 完成。</p> <div class=highlight><pre><span></span><code><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=nt>&quot;redex&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;passes&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;StripDebugInfoPass&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=nt>&quot;StripDebugInfoPass&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_all_dbg_info&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w>     </span><span class=c1>// 去除所有的debug信息，0表示不去除</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_local_variables&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=p>,</span><span class=w>  </span><span class=c1>// 去除所有局部变量，1表示去除</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_line_numbers&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w>     </span><span class=c1>// 去除行号，0表示不去除</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_src_files&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w>        </span>
<span class=w>    </span><span class=nt>&quot;use_whitelist&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;0&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_prologue_end&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_epilogue_begin&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;drop_all_dbg_info_if_empty&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s2>&quot;1&quot;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <h4 id=dex>Dex 分包<a class=headerlink href=#dex title="Permanent link">&para;</a></h4> <p>当我们在 Android Studio 查看一个 APK 的时候，不知道你是否知道下图中“defines 19272 methods”和“references 40229 methods”的区别。</p> <p><img alt=package_1_5 src=/assets/images/android/master/package_1_5.png></p> <p>关于 Dex 的格式以及各个字段的定义，你可以参考<a href=https://www.jianshu.com/p/f7f0a712ddfe>《Dex 文件格式详解》</a>。为了加深对 Dex 格式的理解，推荐你使用 010Editor。</p> <p><img alt=package_1_6 src=/assets/images/android/master/package_1_6.png></p> <p>“define classes and methods”是指真正在这个 Dex 中定义的类以及它们的方法。而“reference methods”指的是 define methods 以及 define methods 引用到的方法。</p> <p>简单来说，如下图所示如果将 Class A 与 Class B 分别编译到不同的 Dex 中，由于 method a 调用了 method b，所以在 classes2.dex 中也需要加上 method b 的 id。</p> <p><img alt=package_1_7 src=/assets/images/android/master/package_1_7.png></p> <p>因为跨 Dex 调用造成的这些冗余信息，它对我们 Dex 的大小会造成哪些影响呢？</p> <ul> <li><strong>method id 爆表</strong>。我们都知道每个 Dex 的 method id 需要小于 65536，因为 method id 的大量冗余导致每个 Dex 真正可以放的 Class 变少，这是造成最终编译的**Dex 数量增多**。</li> <li><strong>信息冗余</strong>。因为我们需要记录跨 Dex 调用的方法的详细信息，所以在 classes2.dex 我们还需要记录 Class B 以及 method b 的定义，造成 string_ids、type_ids、proto_ids 这几部分信息的冗余。</li> </ul> <p>事实上，我自己定义了一个 Dex 信息有效率的指标，希望保证 Dex 有效率应该在 80% 以上。<strong>同时，为了进一步减少 Dex 的数量，我们希望每个 Dex 的方法数都是满的，即分配了 65536 个方法</strong>。</p> <div class=highlight><pre><span></span><code>Dex信息有效率 = define methods数量/reference methods数量
</code></pre></div> <p>那如何实现 Dex 信息有效率提升呢？关键在于我们需要将有调用关系的类和方法分配到同一个 Dex 中，即减少跨 Dex 的调用的情况。但是由于类的调用关系非常复杂，我们不太可能可以计算出最优解，只能得到局部的最优解。</p> <p>为了提高 Dex 信息有效率，我在微信时曾参与写过一个依赖分析的工具 Builder。但在微信最新的 7.0 版本，你可以看到上面表中 Dex 的数量和大小都增大了很多，这是因为他们不小心把这个工具搞失效了。Dex 数量的增多，对于 <strong>Tinker 热修复时间</strong>、用户安装时间都有很大影响。如果把这个问题修复，微信 7.0 版本的 Dex 数量应该可以从 13 个降到 6 个左右，包体积可以减少 10MB 左右。</p> <p>但是我在研究 ReDex 的时候，发现它也提供了这个优化，而且实现得比微信的更好。ReDex 在分析类调用关系后，使用的是贪心算法计算局部最优值，具体算法可查看<a href=https://github.com/facebook/redex/blob/master/opt/interdex/CrossDexRefMinimizer.cpp>CrossDexDefMinimizer</a>。</p> <p>为什么我们不能计算到最优解？因为我们需要在编译速度和效果之间找一个平衡点，在 ReDex 中使用这个优化的配置如下：</p> <div class=highlight><pre><span></span><code><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=nt>&quot;redex&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;passes&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=w></span>
<span class=w>      </span><span class=s2>&quot;InterDexPass&quot;</span><span class=w></span>
<span class=w>    </span><span class=p>]</span><span class=w></span>
<span class=w>  </span><span class=p>},</span><span class=w></span>
<span class=w>  </span><span class=nt>&quot;InterDexPass&quot;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;minimize_cross_dex_refs&quot;</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;minimize_cross_dex_refs_method_ref_weight&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;minimize_cross_dex_refs_field_ref_weight&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>90</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;minimize_cross_dex_refs_type_ref_weight&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nt>&quot;minimize_cross_dex_refs_string_ref_weight&quot;</span><span class=p>:</span><span class=w> </span><span class=mi>90</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>那么通过 Dex 分包可以对包体积优化多少呢？因为 Android 默认的分包方式做得实在不好，如果你的应用有 4 个以上的 Dex，我相信这个优化至少有 10% 的效果。</p> <h4 id=dex_1>Dex 压缩<a class=headerlink href=#dex_1 title="Permanent link">&para;</a></h4> <p>我曾经在逆向 Facebook 的 App 时惊奇地发现，它怎么可能只有一个 700 多 KB 的 Dex。Google Play 是不允许动态下发代码的，那它的代码都放到哪里了呢？</p> <p><img alt=package_1_8 src=/assets/images/android/master/package_1_8.png></p> <p>事实上，Facebook App 的 classes.dex 只是一个壳，真正的代码都放到 assets 下面。它们把所有的 Dex 都合并成同一个 secondary.dex.jar.xzs 文件，并通过 XZ 压缩。</p> <p><img alt=package_1_9 src=/assets/images/android/master/package_1_9.png></p> <p><a href=https://tukaani.org/xz/ >XZ 压缩算法</a>和 7-Zip 一样，内部使用的都是 LZMA 算法。对于 Dex 格式来说，XZ 的压缩率可以比 Zip 高 30% 左右。但是不知道你有没有注意到，这套方案似乎存在一些问题：</p> <ul> <li><strong>首次启动解压</strong>。应用首次启动的时候，需要将 secondary.dex.jar.xzs 解压缩，根据上图的配置信息，应该一共有 11 个 Dex。Facebook 使用多线程解压的方式，这个耗时在高端机是几百毫秒左右，在低端机可能需要 3～5 秒。<strong>这里为什么不采用 Zstandard 或者 Brotli 呢？主要是压缩率与解压速度的权衡</strong>。</li> <li><strong>ODEX 文件生成</strong>。前面我就讲过，当 Dex 非常多的时候会增加应用的安装时间。对于 Facebook 的这个做法，首次生成 ODEX 的时间可能就会达到分钟级别。Facebook 为了解决这个问题，使用了 ReDex 另外一个超级硬核的方法，那就是<a href=https://github.com/facebook/redex/tree/master/tools/oatmeal>oatmeal</a>。</li> </ul> <p>oatmeal 的原理非常简单，就是根据 ODEX 文件的格式，自己生成一个 ODEX 文件。它生成的结果跟解释执行的 ODEX 一样，内部是没有机器码的。</p> <p><img alt=package_1_10 src=/assets/images/android/master/package_1_10.png></p> <p>如上图所示，对于正常的流程，我们需要 fork 进程来生成 dex2oat，这个耗时一般都比较大。通过 oatmeal，我们直接在本进程生成 ODEX 文件。一个 10MB 的 Dex，如果在 Android 5.0 生成一个 ODEX 的耗时大约在 10 秒以上，在 Android 8.0 使用 speed 模式大约在 1 秒左右，而通过 oatmeal 这个耗时大约在 100 毫秒左右。</p> <p>我一直都很想把 oatmeal 引入进 Tinker，但是比较担心兼容性的问题。因为每个版本 ODEX 格式都有一些差异，oatmeal 是需要分版本适配的。</p> <h3 id=2-native-library>2. Native Library<a class=headerlink href=#2-native-library title="Permanent link">&para;</a></h3> <p>现在音视频、美颜、AI、VR 这些功能在应用越来越普遍，但这些库一般都是使用 C 或者 C++ 写的，也就是说，我们的 APK 中 Native Library 的体积越来越大了。</p> <p>对于 Native Library，传统的优化方法可能就是去除 Debug 信息、使用 c++_shared 这些。那我们还有没有更好的优化方法呢？</p> <h4 id=library>Library 压缩<a class=headerlink href=#library title="Permanent link">&para;</a></h4> <details class=success open=open> <summary>效果如何？</summary> <p>经过测试，46M 的so使用 <code>com.tencent.mm:SevenZip:1.2.20</code> 打包之后，压缩包大小为44.2M，效果为44.2/46=0.960869565= <strong>4%</strong> <br> 44.2M 的assets文件 解压出来在Google Pixel 3 上耗时 1s多， OPPO R9s 上耗时 4400ms+。<br> 使用该方式还是得在体积与首次启动时耗时之间找一个平衡，当然 Library 压缩方案还可以在压缩策略、解压策略上进行优化。</p> </details> <p>跟 Dex 压缩一样，Library 优化最有效果的方法也是使用 XZ 或者 7-Zip 压缩。</p> <p><img alt=package_1_11 src=/assets/images/android/master/package_1_11.png></p> <p>在默认的 lib 目录，我们只需要加载少数启动过程相关的 Library，其他的 Library 我们都在首次启动时解压。对于 Library 格式来说，压缩率同样可以比 Zip 高 30% 左右，效果十分惊人。</p> <p>Facebook 有一个 So 加载的开源库<a href=https://github.com/facebook/SoLoader>SoLoader</a>，它可以跟这套方案配合使用。<strong>和 Dex 压缩一样，压缩方案的主要缺点在于首次启动的时间，毕竟对于低端机来说，多线程的意义并不大，因此我们要在包体积和用户体验之间做好平衡</strong>。</p> <h4 id=library_1>Library 合并与裁剪<a class=headerlink href=#library_1 title="Permanent link">&para;</a></h4> <p>对于 Native Library，Facebook 中的编译构建工具<a href=https://buckbuild.com/ >Buck</a>也有两个比较硬核的高科技。当然在官方文档中是完全找不到的，它们都隐藏在<a href=https://github.com/facebook/buck>源码</a>中。</p> <ul> <li><strong>Library 合并</strong>。在 Android 4.3 之前，进程加载的 Library 数量是<a href=https://android.googlesource.com/platform/bionic/+/ba98d9237b0eabc1d8caf2600fd787b988645249%5E%21/ >有限制的</a>。在编译过程，我们可以自动将部分 Library 合并成一个。具体思路你可以参考文章<a href=https://code.fb.com/android/android-native-library-merging/ >《Android native library merging》</a>以及<a href=https://github.com/fbsamples/android-native-library-merging-demo>Demo</a>。</li> <li><strong>Library 裁剪</strong>。Buck 里面有一个<a href=https://github.com/facebook/buck/blob/master/src/com/facebook/buck/android/relinker/NativeRelinker.java>relinker</a>的功能，原理就是分析代码中 JNI 方法以及不同 Library 的方法调用，找到没有无用的导出 symbol，将它们删掉。<strong>这样 linker 在编译的时候也会把对应的无用代码同时删掉</strong>，这个方法相当于实现了 Library 的 ProGuard Shrinking 功能。</li> </ul> <p><img alt=package_1_12 src=/assets/images/android/master/package_1_12.png></p> <h2 id=_3>包体积监控<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <p>关于包体积，如果一直放任不管，几个版本之后就会给你很大的“惊喜”。我了解到一些应用对包体积卡得很紧，任何超过 100KB 的功能都需要审批。</p> <p>对于包体积的监控，通常有下面几种：</p> <ul> <li><strong>大小监控</strong>。这个非常好理解，每个版本跟上一个版本包体积的对比情况。如果某个版本体积增长过大，需要分析具体原因，是否有优化空间。</li> <li><strong>依赖监控</strong>。每一版本我们都需要监控依赖，这里包括新增 JAR 以及 AAR 依赖。这是因为很多开发者非常不细心，经常会不小心把一些超大的开源库引进来。</li> <li><strong>规则监控</strong>。如果发现某个版本包体积增长很大，我们需要分析原因。规则监控也就是将包体积的监控抽象为规则，例如无用资源、大文件、重复文件、R 文件等。比如我在微信的时候，使用<a href=https://mp.weixin.qq.com/s/tP3dtK330oHW8QBUwGUDtA>ApkChecker</a>实现包体积的规则监控。</li> </ul> <p><img alt=package_1_13 src=/assets/images/android/master/package_1_13.png></p> <p>包体积的监控最好可以实现自动化与平台化，作为发布流程的其中一个环节。不然通过人工的方式，很难持续坚持下去。</p> <h2 id=_4>总结<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>今天我们一起分析了实现难度比较大的包体积优化方法，可能有人会想这些方法实现难度那么大，真的有价值吗？根据我的理解，现在我们已经到了移动优化的“深水区”，网上那些千篇一律的文章已经无法满足需求。也就是说，简单的方法我们都掌握了，而且也都已经在做了，需要考虑接下来应该如何进一步优化。</p> <p>这时候就需要静下心来，学会思考与钻研，再往底层走走。我们要去研究 APK 的文件格式，进一步还要研究内部 Dex、Library 以及 Resource 的文件格式。同时思考整个编译流程，才能找到那些可以突破的地方。</p> <p>在实现 AndResGuard 的时候，我就对 resources.arsc 格式以及 Android 加载资源的流程有非常深入的研究。几年过去了，对于资源的优化又有哪些新的秘籍呢？我们下一期就会讨论“资源优化”这个主题。</p> <p>从 Buck 和 ReDex 看出来，Facebook 比国内的研究真的要高深很多，希望他们可以补充一些文档，让我们学习起来更轻松一些。</p> <h2 id=_5>课后作业<a class=headerlink href=#_5 title="Permanent link">&para;</a></h2> <p>今天的练习<a href=https://github.com/AndroidAdvanceWithGeektime/Chapter22>Sample</a>，尝试使用 ReDex 这个项目来优化我们应用的包体积，主要有下面几个小任务：</p> <ul> <li>strip debuginfo</li> <li>分包优化</li> </ul> <blockquote> <p>针对Demo中的实例，确实有不少效果。但是对公司产品的release包使用时，上述两个任务都没有达到效果，甚至包还增大了。</p> </blockquote> <p>回到练习本身，在按照README大体可以完成，但是其中会遇到一些问题：</p> <ol> <li> <p>安装redex后无法进行编译，原因是一些依赖包没有安装，可以参考redex的文档里面的<a href=https://fbredex.com/docs/installation>install教程</a>，整个redex的安装流程如下： <div class=highlight><pre><span></span><code><span class=c1>## clone repo</span>
git clone https://github.com/facebook/redex.git
<span class=nb>cd</span> redex

<span class=c1>## install dependencies, in MacOS</span>
<span class=c1>## xcode command line tools</span>
xcode-select --install
<span class=c1>## install brew</span>
/bin/bash -c <span class=s2>&quot;</span><span class=k>$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh<span class=k>)</span><span class=s2>&quot;</span>
<span class=c1>## install dependencies</span>
brew install autoconf automake libtool python3
brew install boost jsoncpp

<span class=c1>## make &amp; install</span>
autoreconf -ivf <span class=o>&amp;&amp;</span> ./configure <span class=o>&amp;&amp;</span> make -j4
sudo make install
</code></pre></div> 其中编译耗时，在鄙人这台<code>MacBook Pro (13-inch, 2019, Two Thunderbolt 3 ports)</code>这台电脑上，大约耗时50分钟左右，大晚上编译实在是等不了，去睡觉的时候才编译好。</p> </li> <li> <p>在使用redex进行优化时，按照README的命令会出错，找不到zipalign命令，应该与环境变量有关，一般我们的环境变量都是<code>$ANDROID_HOME</code>，这里需要<code>$ANDROID_SDK</code>，所以我们在前面指定<code>ANDROID_SDK=$ANDROID_HOME</code>即可，如下 <div class=highlight><pre><span></span><code><span class=nv>ANDROID_SDK</span><span class=o>=</span><span class=nv>$ANDROID_HOM</span> redex --sign -s ReDexSample/keystore/debug.keystore -a androiddebugkey -p android -c redex-test/stripdebuginfo.config -P ReDexSample/proguard-rules.pro  -o redex-test/strip_output.apk ReDexSample/build/outputs/apk/debug/ReDexSample-debug.apk
</code></pre></div></p> </li> <li> <p>此外，在使用redex进行优化时，还会遇到一个ANDROID_SDK相关的问题，提示<code>com/android/apksigner/ApkSignerTool has been compiled by a more recent version of the Java Runtime (class file version 53.0), this version of the Java Runtime only recognizes class file versions up to 52.0</code>，应该是sdk编译工具版本太高了，不兼容所致，卸载掉了build-tools里面的30+，保留到29的即可。</p> </li> </ol> <hr> <div class=md-source-file> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">October 8, 2021</span> </small> </div> <!-- Giscus --> <h2 id=__comments>评论</h2> <!-- Replace with generated snippet --> <script src=https://giscus.app/client.js data-repo=YorekLiu/yorekliu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTQwNzYzODQ=" data-category=Announcements data-category-id=DIC_kwDOBsyq4M4CP9fq data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Synchronize Giscus theme with palette --> <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> </article> </div> </div> <a href=# class="md-top md-top--hidden md-icon" data-md-component=top> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../ui_2/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 21 | UI 优化（下）：如何优化 UI 渲染？" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> 21 | UI 优化（下）：如何优化 UI 渲染？ </div> </div> </a> <a href=../package_2/ class="md-footer__link md-footer__link--next" aria-label="下一页: 23 | 包体积优化（下）：资源优化的进阶实践" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> 23 | 包体积优化（下）：资源优化的进阶实践 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2022 Yorek </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/YorekLiu target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </a> <a href=lyytogether@gmail.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top"], "search": "../../../../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../../assets/javascripts/bundle.7f366e99.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>
<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="An Android Developer."><meta name=author content="Yorek Liu"><link href=https://blog.yorek.xyz/android/3rd-library/glide3/ rel=canonical><link rel=icon href=../../../assets/images/favicon.webp><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.3.2"><title>Glide v4 源码解析（三） - Yorek's Blog</title><link rel=stylesheet href=../../../assets/stylesheets/main.5d38496d.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Noto Sans SC";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../../stylesheets/extra.css><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-155096376-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){var e;this.value&&(e=document.location.pathname,ga("send","pageview",e+"?q="+this.value))}),"undefined"!=typeof location$&&location$.subscribe(function(e){ga("send","pageview",e.pathname)})})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-glide class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../../.. title="Yorek's Blog" class="md-header__button md-logo" aria-label="Yorek's Blog" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Yorek's Blog </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Glide v4 源码解析（三） </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-orange data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="Yorek's Blog" class="md-nav__button md-logo" aria-label="Yorek's Blog" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> Yorek's Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> Home </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2_1 type=checkbox id=__nav_2_1 checked> <label class=md-nav__link for=__nav_2_1> 三方库系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=三方库系列 data-md-level=2> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 三方库系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../matrix/ class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-trace-plugin/ class=md-nav__link> Matrix-ASM插桩插件解析 </a> </li> <li class=md-nav__item> <a href=../matrix-io/ class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../matrix-apk-checker/ class=md-nav__link> Matrix-ApkChecker：安装包分析检测工具 </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../xhook/ class=md-nav__link> 最常用的PLT Hook框架：xHook </a> </li> <li class=md-nav__item> <a href=../andresguard/ class=md-nav__link> AndResGuard资源混淆原理浅析 </a> </li> <li class=md-nav__item> <a href=../hprof-shrink/ class=md-nav__link> 剖析hprof文件的两种主要裁剪流派 </a> </li> <li class=md-nav__item> <a href=../okhttp/ class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../retrofit/ class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../rxjava%26rxandroid/ class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../glide1/ class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../glide2/ class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Glide v4 源码解析（三） <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Glide v4 源码解析（三） </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-glide class=md-nav__link> 1. Glide缓存机制 </a> </li> <li class=md-nav__item> <a href=#2-memorycache class=md-nav__link> 2. memoryCache介绍 </a> </li> <li class=md-nav__item> <a href=#3-diskcachefactory class=md-nav__link> 3. diskCacheFactory介绍 </a> </li> <li class=md-nav__item> <a href=#4-activeresources class=md-nav__link> 4. ActiveResources </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> 5. 缓存加载、存放过程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide4/ class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../glide5/ class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../glide6/ class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../glide7/ class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../leakcanary/ class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> 初学者的Dagger2教程 </a> </li> <li class=md-nav__item> <a href=../hotfix/ class=md-nav__link> Hotfix方案初探 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_2 type=checkbox id=__nav_2_2 checked> <label class=md-nav__link for=__nav_2_2> 自研 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=自研 data-md-level=2> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 自研 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../library/apm-sample/ class=md-nav__link> APM示例 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_3 type=checkbox id=__nav_2_3 checked> <label class=md-nav__link for=__nav_2_3> framework系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=framework系列 data-md-level=2> <label class=md-nav__title for=__nav_2_3> <span class="md-nav__icon md-icon"></span> framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> View的绘制原理以及自定义View </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_4 type=checkbox id=__nav_2_4 checked> <label class=md-nav__link for=__nav_2_4> 杂记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=杂记 data-md-level=2> <label class=md-nav__title for=__nav_2_4> <span class="md-nav__icon md-icon"></span> 杂记 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/commands/ class=md-nav__link> Android开发常见命令 </a> </li> <li class=md-nav__item> <a href=../../other/android-tv/ class=md-nav__link> Android TV 专项 </a> </li> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> 琐碎知识点 </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> 琐碎知识点2 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_5 type=checkbox id=__nav_2_5 checked> <label class=md-nav__link for=__nav_2_5> 基础知识 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=基础知识 data-md-level=2> <label class=md-nav__title for=__nav_2_5> <span class="md-nav__icon md-icon"></span> 基础知识 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> 大尺寸图片加载问题 </a> </li> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_2_6 type=checkbox id=__nav_2_6 checked> <label class=md-nav__link for=__nav_2_6> Android开发高手课 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android开发高手课 data-md-level=2> <label class=md-nav__title for=__nav_2_6> <span class="md-nav__icon md-icon"></span> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/ class=md-nav__link> Android开发高手课 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_1 type=checkbox id=__nav_3_1 checked> <label class=md-nav__link for=__nav_3_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <label class=md-nav__link for=__nav_3_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <label class=md-nav__link for=__nav_3_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4 checked> <label class=md-nav__link for=__nav_3_4> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> LeetCode <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/ class=md-nav__link> 算法目录 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_5 type=checkbox id=__nav_5 checked> <label class=md-nav__link for=__nav_5> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-glide class=md-nav__link> 1. Glide缓存机制 </a> </li> <li class=md-nav__item> <a href=#2-memorycache class=md-nav__link> 2. memoryCache介绍 </a> </li> <li class=md-nav__item> <a href=#3-diskcachefactory class=md-nav__link> 3. diskCacheFactory介绍 </a> </li> <li class=md-nav__item> <a href=#4-activeresources class=md-nav__link> 4. ActiveResources </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> 5. 缓存加载、存放过程 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../../../tags/#glide class=md-tag> glide </a> </nav> <h1>Glide v4 源码解析（三）</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>本系列文章参考3.7.0版本的<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glide最全解析</a>，并按此思路结合4.9.0版本源码以及使用文档进行更新。<br> ➟ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> ➟ <a href=https://muyangmin.github.io/glide-docs-cn/ >中文文档</a><br> ➟ <a href=https://bumptech.github.io/glide/ >英文文档</a>🚀🚀 </p> </div> <div class="admonition note"> <p class=admonition-title>Glide系列文章目录</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1——Glide v4 的基本使用</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2——从源码的角度理解Glide三步的执行流程</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3——深入探究Glide缓存机制</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4——RequestBuilder中高级点的API以及Target</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5——Glide内置的transform以及自定义BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6——Glide利用AppGlideModule、LibraryGlideModule更改默认配置、扩展Glide功能；GlideApp与Glide的区别在哪？</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7——利用OkHttp、自定义Drawable、自定义ViewTarget实现带进度的图片加载功能</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >杂记：从Picasso迁移至Glide</a></li> </ul> </div> <hr> <h2 id=1-glide>1. Glide缓存机制<a class=headerlink href=#1-glide title="Permanent link">&para;</a></h2> <p>在上一篇文章中比较详细地介绍了<code>Glide.with(xx).load(xx).into(xx)</code>中的很多过程，虽然看完之后理得不是特别清楚。但是没关系，这篇文章开始会一个方面一个方面地进行总结。 </p> <p>本篇文章主要讨论的就是Glide中的缓存问题。Glide缓存机制的流程图如下：</p> <figure style="width: 100%" class=align-center> <img src=/assets/images/android/glide-cache-flow-chart.png> <figcaption>Glide缓存流程图</figcaption> </figure> <p>从图中可以看出，Glide的资源状态可以分为四种：</p> <ol> <li> <p>active状态资源 </p> <blockquote> <p><code>Engine.load</code>方法上的注释写到：Active resources are those that have been provided to at least one request and have not yet been released. Once all consumers of a resource have released that resource, the resource then goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to the active resources. If the resource is evicted from the cache, its resources are recycled and re-used if possible and the resource is discarded. There is no strict requirement that consumers release their resources so active resources are held weakly.</p> </blockquote> </li> <li> <p>内存缓存</p> </li> <li>data磁盘缓存：原始的没有修改过的数据缓存</li> <li>resource磁盘资源：经过解码、transformed后的缓存</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>在<a href=https://muyangmin.github.io/glide-docs-cn/doc/caching.html>Glide使用文档-缓存部分</a>中有对Glide的整个缓存体系做出一个总结，前往了解一下还是非常好的。 </p> </div> <p>在文档中有Glide的缓存体系的整体描述，文字摘抄如下： </p> <blockquote> <p>By default, Glide checks multiple layers of caches before starting a new request for an image:<br> 1. Active resources - Is this image displayed in another View right now? 2. Memory cache - Was this image recently loaded and still in memory? 3. Resource - Has this image been decoded, transformed, and written to the disk cache before? 4. Data - Was the data this image was obtained from written to the disk cache before? </p> <p>The first two steps check to see if the resource is in memory and if so, return the image immediately. The second two steps check to see if the image is on disk and return quickly, but asynchronously. </p> <p>If all four steps fail to find the image, then Glide will go back to the original source to retrieve the data (the original File, Uri, Url etc).<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#caching-in-glide>Caching in Glide</a></cite> </p> </blockquote> <p>下面开始一边过源码，一遍印证上面的图和概要。</p> <p>Glide的memory cache和disk cache在Glide创建的时候就确定了。代码在<code>GlideBuilder.build(Context)</code>方法里面。值得一提的是，Glide是单例实现的，在上一章 <a href=/android/3rd-library/glide2/#11-getretrievercontext>1.1节 getRetriever(Context)</a> 中我们分析时贴了对应的代码。</p> <p>memory cache和disk cache在Glide创建时相关代码如下：</p> <p><strong>GlideBuilder.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@NonNull</span><span class=w></span>
<span class=n>Glide</span><span class=w> </span><span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>memoryCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>memoryCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCacheFactory</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>diskCacheFactory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>engine</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>engine</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Engine</span><span class=p>(</span><span class=w></span>
<span class=w>            </span><span class=n>memoryCache</span><span class=p>,</span><span class=w></span>
<span class=w>            </span><span class=n>diskCacheFactory</span><span class=p>,</span><span class=w></span>
<span class=w>            </span><span class=p>...);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Glide</span><span class=p>(</span><span class=w></span>
<span class=w>      </span><span class=p>...</span><span class=w></span>
<span class=w>      </span><span class=n>memoryCache</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=p>...);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>memoryCache和diskCacheFactory如果没有没有在任何<code>GlideMode</code>中进行设置的话，会有一个默认的实现。大部分情况下，我们使用这个默认实现就很好了。 </p> <h2 id=2-memorycache>2. memoryCache介绍<a class=headerlink href=#2-memorycache title="Permanent link">&para;</a></h2> <p>memoryCache发生存取操作是在Engine中，但是我们看到memoryCache还被放入了Glide实例中。这是因为Glide实现了<code>ComponentCallbacks2</code>接口，在Glide创建完成后，实例就注册了该接口。这样在内存紧张的时候，可以通知memoryCache释放内存。</p> <p><strong>Glide.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onTrimMemory</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>level</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>trimMemory</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>level</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=c1>// Engine asserts this anyway when removing resources, fail faster and consistently</span><span class=w></span>
<span class=w>  </span><span class=n>Util</span><span class=p>.</span><span class=na>assertMainThread</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=c1>// memory cache needs to be trimmed before bitmap pool to trim re-pooled Bitmaps too. See #687.</span><span class=w></span>
<span class=w>  </span><span class=n>memoryCache</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=n>bitmapPool</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=n>arrayPool</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>memoryCache是一个使用LRU(least recently used)算法实现的内存缓存类<code>LruResourceCache</code>，继承至<code>LruCache</code>类，实现了<code>MemoryCache</code>接口。<br> <code>LruCache</code>定义了LRU相关的操作，而<code>MemoryCache</code>定义的是内存缓存相关的操作。<code>LruResourceCache</code>其相关代码如下：</p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LruResourceCache</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>MemoryCache</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>getSize</span><span class=p>(</span><span class=nd>@Nullable</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>item</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>item</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kd>super</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>item</span><span class=p>.</span><span class=na>getSize</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;InlinedApi&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>trimMemory</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>level</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>level</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_BACKGROUND</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=c1>// Entering list of cached background apps</span><span class=w></span>
<span class=w>      </span><span class=c1>// Evict our entire bitmap cache</span><span class=w></span>
<span class=w>      </span><span class=n>clearMemory</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>level</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_UI_HIDDEN</span><span class=w></span>
<span class=w>        </span><span class=o>||</span><span class=w> </span><span class=n>level</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_RUNNING_CRITICAL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=c1>// The app&#39;s UI is no longer visible, or app is in the foreground but system is running</span><span class=w></span>
<span class=w>      </span><span class=c1>// critically low on memory</span><span class=w></span>
<span class=w>      </span><span class=c1>// Evict oldest half of our bitmap cache</span><span class=w></span>
<span class=w>      </span><span class=n>trimToSize</span><span class=p>(</span><span class=n>getMaxSize</span><span class=p>()</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mi>2</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><code>LruCache</code>的实现主要靠<code>LinkedHashMap</code>的一个构造参数：<code>accessOrder</code>。<br> 当该参数为true时，每次调用<code>LinkedHashMap</code>的<code>get(key)</code>或<code>getOrDefault(key, defaultValue)</code>方法都会触发<code>afterNodeAccess(Object)</code>方法，此方法会将对应的node移动到链表的末尾。也就是说<code>LinkedHashMap</code>末尾的数据是最近“最多”使用的。<br> 而<code>LruCache</code>清除内存时都会调用<code>trimToSize(size)</code>方法时，会从头到尾进行清理，这样LRU的特点就体现出来了。 </p> <p>相关代码如下：</p> <p><strong>LruCache.java</strong> </p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LruCache</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>cache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mf>0.75f</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>clearMemory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>trimToSize</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>trimToSize</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Y</span><span class=o>&gt;</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span><span class=w> </span><span class=n>Y</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>cacheIterator</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>currentSize</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=c1>// 👏👏👏 果然是从头到尾进行遍历的</span><span class=w></span>
<span class=w>      </span><span class=n>cacheIterator</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>cache</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cacheIterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=kd>final</span><span class=w> </span><span class=n>Y</span><span class=w> </span><span class=n>toRemove</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=n>currentSize</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>getSize</span><span class=p>(</span><span class=n>toRemove</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=kd>final</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=n>cacheIterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=n>onItemEvicted</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>toRemove</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>evict</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>trimToSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><strong>LinkedHashMap.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w></span>
<span class=w>    </span><span class=kd>extends</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w></span>
<span class=w>    </span><span class=kd>implements</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w></span>
<span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>LinkedHashMap</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>initialCapacity</span><span class=p>,</span><span class=w></span>
<span class=w>                         </span><span class=kt>float</span><span class=w> </span><span class=n>loadFactor</span><span class=p>,</span><span class=w></span>
<span class=w>                         </span><span class=kt>boolean</span><span class=w> </span><span class=n>accessOrder</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=n>initialCapacity</span><span class=p>,</span><span class=w> </span><span class=n>loadFactor</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>this</span><span class=p>.</span><span class=na>accessOrder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>accessOrder</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNode</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span><span class=w> </span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w></span>
<span class=w>            </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>accessOrder</span><span class=p>)</span><span class=w></span>
<span class=w>            </span><span class=n>afterNodeAccess</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=cm>/**</span>
<span class=cm>     * {@inheritDoc}</span>
<span class=cm>     */</span><span class=w></span>
<span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=nf>getOrDefault</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>V</span><span class=w> </span><span class=n>defaultValue</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>       </span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w></span>
<span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>e</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNode</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span><span class=w> </span><span class=n>key</span><span class=p>))</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w></span>
<span class=w>           </span><span class=k>return</span><span class=w> </span><span class=n>defaultValue</span><span class=p>;</span><span class=w></span>
<span class=w>       </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>accessOrder</span><span class=p>)</span><span class=w></span>
<span class=w>           </span><span class=n>afterNodeAccess</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w></span>
<span class=w>       </span><span class=k>return</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>afterNodeAccess</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// move node to last</span><span class=w></span>
<span class=w>        </span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>accessOrder</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>tail</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>                </span><span class=p>(</span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>e</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>before</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=na>after</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=n>p</span><span class=p>.</span><span class=na>after</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>b</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w></span>
<span class=w>                </span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w></span>
<span class=w>                </span><span class=n>b</span><span class=p>.</span><span class=na>after</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w></span>
<span class=w>                </span><span class=n>a</span><span class=p>.</span><span class=na>before</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w></span>
<span class=w>                </span><span class=n>last</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>last</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w></span>
<span class=w>                </span><span class=n>head</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=n>p</span><span class=p>.</span><span class=na>before</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>last</span><span class=p>;</span><span class=w></span>
<span class=w>                </span><span class=n>last</span><span class=p>.</span><span class=na>after</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=n>tail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>;</span><span class=w></span>
<span class=w>            </span><span class=o>++</span><span class=n>modCount</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <h2 id=3-diskcachefactory>3. diskCacheFactory介绍<a class=headerlink href=#3-diskcachefactory title="Permanent link">&para;</a></h2> <p>diskCacheFactory顾名思义就是创建DiskCache的Factory，该接口的定义如下：</p> <p><strong>DiskCache.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>DiskCache</span><span class=w> </span><span class=p>{</span><span class=w></span>

<span class=w>  </span><span class=kd>interface</span> <span class=nc>Factory</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=cm>/** 250 MB of cache. */</span><span class=w></span>
<span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>DEFAULT_DISK_CACHE_SIZE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>250</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1024</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>DEFAULT_DISK_CACHE_DIR</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;image_manager_disk_cache&quot;</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>DiskCache</span><span class=w> </span><span class=nf>build</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>interface</span> <span class=nc>Writer</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=nf>write</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>File</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>put</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>Writer</span><span class=w> </span><span class=n>writer</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>delete</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>clear</span><span class=p>();</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>可以看出<code>DiskCache.Factory</code>的<code>build()</code>方法会创建出一个我们需要的<code>DiskCache</code>。<br> 所以，我们跟着Glide默认实现的<code>InternalCacheDiskCacheFactory</code>类看一下创建出了什么样的<code>DiskCache</code>：</p> <p><strong>InternalCacheDiskCacheFactory.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>InternalCacheDiskCacheFactory</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>DiskLruCacheFactory</span><span class=w> </span><span class=p>{</span><span class=w></span>

<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_SIZE</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=p>,</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Context</span><span class=w> </span><span class=n>context</span><span class=p>,</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>diskCacheName</span><span class=p>,</span><span class=w></span>
<span class=w>                                       </span><span class=kt>long</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>super</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CacheDirectoryGetter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=nd>@Override</span><span class=w></span>
<span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=nf>getCacheDirectory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>File</span><span class=w> </span><span class=n>cacheDirectory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>.</span><span class=na>getCacheDir</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cacheDirectory</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCacheName</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>cacheDirectory</span><span class=p>,</span><span class=w> </span><span class=n>diskCacheName</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>cacheDirectory</span><span class=p>;</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>显然，根据上面接口中的定义以及此处第三个构造器中的代码可以看出，默认会创建一个位于250M大小的路径为<code>/data/data/{package}/cache/image_manager_disk_cache/</code>的缓存目录。</p> <p>下面接着<code>InternalCacheDiskCacheFactory</code>的父类<code>DiskLruCacheFactory</code>的相关代码：</p> <p><strong>DiskLruCacheFactory.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DiskLruCacheFactory</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>CacheDirectoryGetter</span><span class=w> </span><span class=n>cacheDirectoryGetter</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=cm>/**</span>
<span class=cm>   * Interface called out of UI thread to get the cache folder.</span>
<span class=cm>   */</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>interface</span> <span class=nc>CacheDirectoryGetter</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>File</span><span class=w> </span><span class=nf>getCacheDirectory</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=nf>DiskLruCacheFactory</span><span class=p>(</span><span class=n>CacheDirectoryGetter</span><span class=w> </span><span class=n>cacheDirectoryGetter</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>diskCacheSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>cacheDirectoryGetter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cacheDirectoryGetter</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>DiskCache</span><span class=w> </span><span class=nf>build</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>File</span><span class=w> </span><span class=n>cacheDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cacheDirectoryGetter</span><span class=p>.</span><span class=na>getCacheDirectory</span><span class=p>();</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cacheDir</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>mkdirs</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>exists</span><span class=p>()</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>isDirectory</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>DiskLruCacheWrapper</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>cacheDir</span><span class=p>,</span><span class=w> </span><span class=n>diskCacheSize</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><code>DiskLruCacheFactory.build()</code>方法会返回一个<code>DiskLruCacheWrapper</code>类的实例，从命名来看磁盘缓存也确实是LRU算法的。我们眼见为实：</p> <p><strong>DiskLruCacheWrapper.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>DiskLruCacheWrapper</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DiskCache</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>TAG</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;DiskLruCacheWrapper&quot;</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>APP_VERSION</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>VALUE_COUNT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>DiskLruCacheWrapper</span><span class=w> </span><span class=n>wrapper</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SafeKeyGenerator</span><span class=w> </span><span class=n>safeKeyGenerator</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=n>directory</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>maxSize</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DiskCacheWriteLocker</span><span class=w> </span><span class=n>writeLocker</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DiskCacheWriteLocker</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>DiskLruCache</span><span class=w> </span><span class=n>diskLruCache</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>DiskCache</span><span class=w> </span><span class=nf>create</span><span class=p>(</span><span class=n>File</span><span class=w> </span><span class=n>directory</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>maxSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DiskLruCacheWrapper</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span><span class=w> </span><span class=n>maxSize</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@Deprecated</span><span class=w></span>
<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;DeprecatedIsStillUsed&quot;</span><span class=p>})</span><span class=w></span>
<span class=w>  </span><span class=kd>protected</span><span class=w> </span><span class=nf>DiskLruCacheWrapper</span><span class=p>(</span><span class=n>File</span><span class=w> </span><span class=n>directory</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>maxSize</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>directory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>directory</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>maxSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>maxSize</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>safeKeyGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SafeKeyGenerator</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=n>DiskLruCache</span><span class=w> </span><span class=nf>getDiskCache</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskLruCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>diskLruCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>DiskLruCache</span><span class=p>.</span><span class=na>open</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span><span class=w> </span><span class=n>APP_VERSION</span><span class=p>,</span><span class=w> </span><span class=n>VALUE_COUNT</span><span class=p>,</span><span class=w> </span><span class=n>maxSize</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>diskLruCache</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>safeKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>safeKeyGenerator</span><span class=p>.</span><span class=na>getSafeKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>File</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=kd>final</span><span class=w> </span><span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Value</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>safeKey</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>getFile</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>里面果然wrap了一个<code>DiskLruCache</code>，该类主要是为<code>DiskLruCache</code>提供了一个根据<code>Key</code>生成key的<code>SafeKeyGenerator</code>以及写锁<code>DiskCacheWriteLocker</code>。 </p> <p>!!!! warning <strong>注意</strong>：Glide中使用的LruCache与<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#21-lrucache>Bitmap的缓存与加载</a>一文中提到的不一样；Glide使用的DiskLruCache虽然与文章中提到的DiskLruCache有一定的渊源，但不等同。</p> <p>OK，现在DiskCache的实现都准备好了，现在看看会在哪里调用factory的<code>build()</code>方法了。<br> 在本文的开头，我们看到了<code>diskCacheFactory</code>只会传入<code>Engine</code>中。在<code>Engine</code>的构造方法中会被包装成为一个<code>LazyDiskCacheProvider</code>，在被需要的时候调用<code>getDiskCache()</code>方法，这样就会调用factory的<code>build()</code>方法返回一个<code>DiskCache</code>了。</p> <p><strong>Engine.LazyDiskCacheProvider</strong></p> <div class=highlight><pre><span></span><code><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>LazyDiskCacheProvider</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>DecodeJob</span><span class=p>.</span><span class=na>DiskCacheProvider</span><span class=w> </span><span class=p>{</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=n>DiskCache</span><span class=w> </span><span class=n>diskCache</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=n>LazyDiskCacheProvider</span><span class=p>(</span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=w> </span><span class=n>factory</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>factory</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>DiskCache</span><span class=w> </span><span class=nf>getDiskCache</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=n>diskCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCache</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=n>diskCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DiskCacheAdapter</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>diskCache</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>而<code>LazyDiskCacheProvider</code>又会在<code>Engine</code>后面的初始化流程中传入<code>DecodeJobFactory</code>。在<code>DecodeJobFactory</code>创建<code>DecodeJob</code>时会传进去。<br> <code>DecodeJob</code>自身会保存起来，在资源加载完毕并展示后，会进行缓存的存放。同时，<code>DecodeJob</code>也会在<code>DecodeHelper</code>初始化时，设置进去，供<code>ResourceCacheGenerator</code>、<code>DataCacheGenerator</code>读取缓存，供<code>SourceGenerator</code>写入缓存。</p> <h2 id=4-activeresources>4. ActiveResources<a class=headerlink href=#4-activeresources title="Permanent link">&para;</a></h2> <p>在正式开始讨论缓存流程时，还是要先介绍一下<code>ActiveResources</code>的一些源码。<br> <code>ActiveResources</code>在<code>Engine</code>的构造器中被创建。<code>ActiveResources</code>构建完成后，会启动一个后台优先级级别（<code>THREAD_PRIORITY_BACKGROUND</code>）的线程，在该线程中会调用<code>cleanReferenceQueue()</code>方法一直循环清除ReferenceQueue中的将要被GC的Resource。</p> <p><strong>ActiveResources.java</strong> </p> <div class=highlight><pre><span></span><code><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ActiveResources</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=n>monitorClearedResourcesExecutor</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=nd>@VisibleForTesting</span><span class=w></span>
<span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span><span class=w> </span><span class=n>ResourceWeakReference</span><span class=o>&gt;</span><span class=w> </span><span class=n>activeEngineResources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>resourceReferenceQueue</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ReferenceQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>volatile</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isShutdown</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=n>ActiveResources</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>Executors</span><span class=p>.</span><span class=na>newSingleThreadExecutor</span><span class=p>(</span><span class=w></span>
<span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>ThreadFactory</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>              </span><span class=nd>@Override</span><span class=w></span>
<span class=w>              </span><span class=kd>public</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=nf>newThread</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>r</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=w></span>
<span class=w>                    </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                      </span><span class=nd>@Override</span><span class=w></span>
<span class=w>                      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>                        </span><span class=n>Process</span><span class=p>.</span><span class=na>setThreadPriority</span><span class=p>(</span><span class=n>Process</span><span class=p>.</span><span class=na>THREAD_PRIORITY_BACKGROUND</span><span class=p>);</span><span class=w></span>
<span class=w>                        </span><span class=n>r</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w></span>
<span class=w>                      </span><span class=p>}</span><span class=w></span>
<span class=w>                    </span><span class=p>},</span><span class=w></span>
<span class=w>                    </span><span class=s>&quot;glide-active-resources&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>              </span><span class=p>}</span><span class=w></span>
<span class=w>            </span><span class=p>}));</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@VisibleForTesting</span><span class=w></span>
<span class=w>  </span><span class=n>ActiveResources</span><span class=p>(</span><span class=w></span>
<span class=w>      </span><span class=kt>boolean</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>,</span><span class=w> </span><span class=n>Executor</span><span class=w> </span><span class=n>monitorClearedResourcesExecutor</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>isActiveResourceRetentionAllowed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>monitorClearedResourcesExecutor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>monitorClearedResourcesExecutor</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=n>monitorClearedResourcesExecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=nd>@Override</span><span class=w></span>
<span class=w>          </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=n>cleanReferenceQueue</span><span class=p>();</span><span class=w></span>
<span class=w>          </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=p>});</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cleanReferenceQueue</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isShutdown</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>ResourceWeakReference</span><span class=w> </span><span class=n>ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ResourceWeakReference</span><span class=p>)</span><span class=w> </span><span class=n>resourceReferenceQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>cleanupActiveReference</span><span class=p>(</span><span class=n>ref</span><span class=p>);</span><span class=w></span>

<span class=w>        </span><span class=c1>// This section for testing only.</span><span class=w></span>
<span class=w>        </span><span class=n>DequeuedResourceCallback</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=n>current</span><span class=p>.</span><span class=na>onResourceDequeued</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=c1>// End for testing only.</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>InterruptedException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><code>cleanupActiveReference</code>方法马上会说。现在先来看看<code>ActiveResources</code>的保存、删除的方法，这两个方法分别是<code>activate</code>、<code>deactivate</code>。可以看到，这两个方法实现都很简单。<code>activate</code>方法会将参数封装成为一个<code>ResourceWeakReference</code>，然后放入map中，如果对应的key之前有值，那么调用之前值的<code>reset</code>方法进行清除。<code>deactivate</code>方法先在map中移除，然后调用resource的<code>reset</code>方法进行清除。</p> <div class=highlight><pre><span></span><code><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>activate</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>ResourceWeakReference</span><span class=w> </span><span class=n>toPut</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>ResourceWeakReference</span><span class=p>(</span><span class=w></span>
<span class=w>          </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>resourceReferenceQueue</span><span class=p>,</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=n>ResourceWeakReference</span><span class=w> </span><span class=n>removed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activeEngineResources</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>toPut</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>removed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>removed</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>deactivate</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>ResourceWeakReference</span><span class=w> </span><span class=n>removed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activeEngineResources</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>removed</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>removed</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><code>ResourceWeakReference</code>继承至<code>WeakReference</code>，只是保存了Resource的一些属性，此外添加了一个<code>reset</code>方法用来清理资源：</p> <div class=highlight><pre><span></span><code><span class=nd>@VisibleForTesting</span><span class=w></span>
<span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>ResourceWeakReference</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span><span class=w> </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span><span class=w> </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isCacheable</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=nd>@Nullable</span><span class=w> </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span><span class=w> </span><span class=nd>@Synthetic</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=nd>@Synthetic</span><span class=w></span>
<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=n>ResourceWeakReference</span><span class=p>(</span><span class=w></span>
<span class=w>      </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>referent</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ReferenceQueue</span><span class=o>&lt;?</span><span class=w> </span><span class=kd>super</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>queue</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=kt>boolean</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>super</span><span class=p>(</span><span class=n>referent</span><span class=p>,</span><span class=w> </span><span class=n>queue</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>resource</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>        </span><span class=n>referent</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>isActiveResourceRetentionAllowed</span><span class=w></span>
<span class=w>            </span><span class=o>?</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>referent</span><span class=p>.</span><span class=na>getResource</span><span class=p>())</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>isCacheable</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>referent</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>reset</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>resource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>clear</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>值得注意的是，这里的构造方法中调用了<code>super(referent, queue)</code>。这样如果referent将要被GC，就会被放入queue中。而<code>ActiveResources.cleanReferenceQueue()</code>方法会一直尝试从queue中获取将要被GC的resource，然后调用其<code>cleanupActiveReference</code>方法。<br> 该方法除了在此时被调用外，还在<code>ActiveResources.get(key)</code>方法中也可能会因为获取到的resource为null而被调用。<code>cleanupActiveReference</code>方法如下：</p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span><span class=w></span>
<span class=kt>void</span><span class=w> </span><span class=nf>cleanupActiveReference</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>ResourceWeakReference</span><span class=w> </span><span class=n>ref</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=c1>// Fixes a deadlock where we normally acquire the Engine lock and then the ActiveResources lock</span><span class=w></span>
<span class=w>  </span><span class=c1>// but reverse that order in this one particular test. This is definitely a bit of a hack...</span><span class=w></span>
<span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>listener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>activeEngineResources</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=c1>// 如果是GC后调用，此时ref.resource肯定为null</span><span class=w></span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ref</span><span class=p>.</span><span class=na>isCacheable</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>ref</span><span class=p>.</span><span class=na>resource</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>      </span><span class=c1>// 走到这，表示是在get方法中被调用，此时会恢复原来的resource</span><span class=w></span>
<span class=w>      </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>newResource</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>          </span><span class=k>new</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>resource</span><span class=p>,</span><span class=w> </span><span class=cm>/*isCacheable=*/</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=cm>/*isRecyclable=*/</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=n>newResource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>,</span><span class=w> </span><span class=n>listener</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=c1>// 回调Engine的onResourceReleased方法</span><span class=w></span>
<span class=w>      </span><span class=c1>// 这会导致此资源从active变成memory cache状态</span><span class=w></span>
<span class=w>      </span><span class=n>listener</span><span class=p>.</span><span class=na>onResourceReleased</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>,</span><span class=w> </span><span class=n>newResource</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <h2 id=5>5. 缓存加载、存放过程<a class=headerlink href=#5 title="Permanent link">&para;</a></h2> <p>在了解完上面三种缓存状态资源对应的类后，我们现在看一下缓存加载、存放的过程。由于缓存策略默认为<code>DiskCacheStrategy.AUTOMATIC</code>，所以加载某一种格式的图片不足以覆盖所有的情况，下面会以网络图片URL以及本地图片File这两种常用的方式来讲解缓存的加载、存放过程。</p> <p>首先，整个加载的过程体现在<code>Engine.load</code>方法中，该方法注释和代码片段如下：</p> <div class=highlight><pre><span></span><code><span class=cm>/**</span>
<span class=cm>  * Starts a load for the given arguments.</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;Must be called on the main thread.</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;The flow for any request is as follows:</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;ul&gt;</span>
<span class=cm>  *   &lt;li&gt;Check the current set of actively used resources, return the active resource if present,</span>
<span class=cm>  *       and move any newly inactive resources into the memory cache.</span>
<span class=cm>  *   &lt;li&gt;Check the memory cache and provide the cached resource if present.</span>
<span class=cm>  *   &lt;li&gt;Check the current set of in progress loads and add the cb to the in progress load if one</span>
<span class=cm>  *       is present.</span>
<span class=cm>  *   &lt;li&gt;Start a new load.</span>
<span class=cm>  * &lt;/ul&gt;</span>
<span class=cm>  *</span>
<span class=cm>  * &lt;p&gt;Active resources are those that have been provided to at least one request and have not yet</span>
<span class=cm>  * been released. Once all consumers of a resource have released that resource, the resource then</span>
<span class=cm>  * goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to</span>
<span class=cm>  * the active resources. If the resource is evicted from the cache, its resources are recycled and</span>
<span class=cm>  * re-used if possible and the resource is discarded. There is no strict requirement that</span>
<span class=cm>  * consumers release their resources so active resources are held weakly.</span>
<span class=cm>  *</span>
<span class=cm>  * @param width The target width in pixels of the desired resource.</span>
<span class=cm>  * @param height The target height in pixels of the desired resource.</span>
<span class=cm>  * @param cb The callback that will be called when the load completes.</span>
<span class=cm>  */</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>LoadStatus</span><span class=w> </span><span class=nf>load</span><span class=p>(...)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>EngineKey</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>keyFactory</span><span class=p>.</span><span class=na>buildKey</span><span class=p>(</span><span class=n>model</span><span class=p>,</span><span class=w> </span><span class=n>signature</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>transformations</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=n>resourceClass</span><span class=p>,</span><span class=w> </span><span class=n>transcodeClass</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>active</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>active</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>cached</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cached</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>EngineJob</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>current</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jobs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>onlyRetrieveFromCache</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>current</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>current</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>engineJob</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>      </span><span class=n>engineJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(...);</span><span class=w></span>

<span class=w>  </span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>decodeJob</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>      </span><span class=n>decodeJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(...);</span><span class=w></span>

<span class=w>  </span><span class=n>jobs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>engineJob</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=n>engineJob</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>callbackExecutor</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=n>engineJob</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span><span class=w> </span><span class=n>engineJob</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>上面这个方法我们在前一篇文章讲解整体流程时谈到过，链接如下<a href=/android/3rd-library/glide2/#33-engineload>Glide2-3.3-Engine.load</a>。<br> 从注释和代码中我们知道了缓存首先会判断active状态的resource，然后是memory cache，最后就交给了job。那么毫无疑问，job中会进行disk cache的读操作。 </p> <p>只要是缓存，就离不开Key，所以先看看从active resource和memory cache中取缓存时的Key——<code>EngineKey</code>的组成成分：</p> <p><strong>EngineKey.java</strong></p> <figcaption>EngineKey的组成</figcaption> <table> <thead> <tr> <th>组成</th> <th>注释</th> </tr> </thead> <tbody> <tr> <td>model</td> <td>load的参数</td> </tr> <tr> <td>signature</td> <td><code>BaseRequestOptions</code>的成员变量，默认会是<code>EmptySignature.obtain()</code><br>在加载本地resource资源时会变成<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> <tr> <td>width<br>height</td> <td>如果没有指定<code>override(int size)</code>，那么将得到view的size</td> </tr> <tr> <td>transformations</td> <td>默认会基于<code>ImageView</code>的scaleType设置对应的四个<code>Transformation</code>；<br>如果指定了<code>transform</code>，那么就基于该值进行设置；<br>详见<code>BaseRequestOptions.transform(Transformation, boolean)</code></td> </tr> <tr> <td>resourceClass</td> <td>解码后的资源，如果没有<code>asBitmap</code>、<code>asGif</code>，一般会是<code>Object</code></td> </tr> <tr> <td>transcodeClass</td> <td>最终要转换成的数据类型，根据<code>as</code>方法确定，加载本地res或者网络URL，都会调用<code>asDrawable</code>，所以为<code>Drawable</code></td> </tr> <tr> <td>options</td> <td>如果没有设置过<code>transform</code>，此处会根据ImageView的scaleType默认指定一个KV，详见上一文2.2节</td> </tr> </tbody> </table> <p>显然，在多次加载同一个model的过程中，即使有稍许改动（比如View宽高等），Glide都不会认为这是同一个Key。此外，值得一提的是，此Key以及其他的Key覆盖<code>equals</code>、<code>hashCode()</code>、<code>toString()</code>方法的写法非常规范，详细可见<a href=/effective-java/chapter2/ >Effective-Java-第8、9、10条</a>。</p> <p>回到<code>Engine.load</code>方法中，active状态的resource和memory cache状态的资源其实都是<code>DataSource.MEMORY_CACHE</code>状态，从缓存加载成功后的回调中可以看到。而且，加载出来的资源都是<code>EngineResource</code>对象，该对象的管理策略采用了<a href=/jvm/java-gc/#321>引用计数算法</a>。该算法的特点是实现简单，判定效率也很高。</p> <p><code>EngineResource</code>类的关键代码如下：</p> <div class=highlight><pre><span></span><code><span class=kd>class</span> <span class=nc>EngineResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isCacheable</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isRecyclable</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>ResourceListener</span><span class=w> </span><span class=n>listener</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>acquired</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isRecycled</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=kd>interface</span> <span class=nc>ResourceListener</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setResourceListener</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>ResourceListener</span><span class=w> </span><span class=n>listener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>listener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>listener</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>acquire</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isRecycled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Cannot acquire a recycled resource&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=o>++</span><span class=n>acquired</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;SynchronizeOnNonFinalField&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>release</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>listener</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>acquired</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Cannot release a recycled or not yet acquired resource&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>--</span><span class=n>acquired</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=n>listener</span><span class=p>.</span><span class=na>onResourceReleased</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在<code>release</code>后，如果引用计数为0，那么会调用<code>listener.onResourceReleased(key, this)</code>方法通知外界此资源已经释放了。实际上，所有的listener都是<code>Engine</code>对象，在<code>Engine.onResourceReleased</code>方法中会将此资源放入memory cache中，如果可以被缓存的话：</p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>activeResources</span><span class=p>.</span><span class=na>deactivate</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>resourceRecycler</span><span class=p>.</span><span class=na>recycle</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>了解了<code>EngineResource</code>之后，在回到<code>Engine.load</code>方法中开始分析。首先是从active resource和memory cache中进行加载的方法：</p> <div class=highlight><pre><span></span><code><span class=nd>@Nullable</span><span class=w></span>
<span class=kd>private</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isMemoryCacheable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=c1>// ⚠️</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>active</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>activeResources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>active</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>active</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>active</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>private</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>loadFromCache</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isMemoryCacheable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isMemoryCacheable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>  </span><span class=c1>// ⚠️</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>cached</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getEngineResourceFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cached</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>cached</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>cached</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>cached</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>这里会首先判断<code>skipMemoryCache(true)</code>是否进行过设置。如果设置过，那么上面的<code>isMemoryCacheable</code>对应就会为false，进而这两个方法直接会返回null。否则，会从缓存中尝试进行加载。<br> 只要命中了缓存，那么该资源的引用计数就会加一。而且，如果命中的是memory cache，那么此资源会被提高到active状态中。<br> 显然，第一次运行的时候是没有任何内存缓存的，现在来到了<code>DecodeJob</code>和<code>EngineJob</code>这里。还是在前一篇文章中提到过，<code>DecoceJob</code>实现了<code>Runnable</code>接口，然后会被<code>EngineJob.start</code>方法提交到对应的线程池中去执行。 </p> <p>所以，直接看<code>DecodeJob.run</code>方法咯，该方法真正实现是<code>runWrapped</code>方法。在此方法中，由于<code>runReason</code>此时初始化了为了<code>RunReason.INITIALIZE</code>，又diskCacheStrategy为默认为<code>DiskCacheStrategy.AUTOMATIC</code>，且没有设置过<code>onlyRetrieveFromCache(true)</code>。所以，decode data的状态依次为<code>INITIALIZE</code> -&gt; <code>RESOURCE_CACHE</code> -&gt; <code>DATA_CACHE</code> -&gt; <code>SOURCE</code> -&gt; <code>FINISHED</code>。对应的<code>DataFectcherGenerator</code>的list依次为<code>ResourceCacheGenerator</code> -&gt; <code>DataCacheGenerator</code> -&gt; <code>SourceGenerator</code>。</p> <p><strong>DecodeJob.java</strong></p> <div class=highlight><pre><span></span><code><span class=kd>private</span><span class=w> </span><span class=n>Stage</span><span class=w> </span><span class=nf>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=w> </span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>current</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>INITIALIZE</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedResource</span><span class=p>()</span><span class=w></span>
<span class=w>          </span><span class=o>?</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>RESOURCE_CACHE</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedData</span><span class=p>()</span><span class=w></span>
<span class=w>          </span><span class=o>?</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>DATA_CACHE</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>onlyRetrieveFromCache</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>SOURCE</span><span class=p>:</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>FINISHED</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>default</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>current</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>private</span><span class=w> </span><span class=n>DataFetcherGenerator</span><span class=w> </span><span class=nf>getNextGenerator</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>stage</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>RESOURCE_CACHE</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>DATA_CACHE</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>SOURCE</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SourceGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>case</span><span class=w> </span><span class=n>FINISHED</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>default</span><span class=p>:</span><span class=w></span>
<span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>stage</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>runGenerators</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>currentThread</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=n>startFetchTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>isStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w></span>
<span class=w>      </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=p>(</span><span class=n>isStarted</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>currentGenerator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getNextGenerator</span><span class=p>();</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>reschedule</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=c1>// We&#39;ve run out of stages and generators, give up.</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>stage</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>isCancelled</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>isStarted</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>notifyFailed</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span><span class=w></span>
<span class=w>  </span><span class=c1>// onDataFetcherReady.</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>在前文中我们看到过<code>ResourceCacheGenerator</code>和<code>DataCacheGenerator</code>的源码，知道了前者负责在cache中查找resource资源，而后者负责data资源。<br> 当在两个cache generator中都找不到时，会交给<code>SourceGenerator</code>从source中进行加载。此时，对于一个网络图片资源来说，就是加载网络图片；对于本地资源来说，就是加载本地资源。</p> <p>那么，resource资源和data资源都是磁盘缓存中的资源，其区别在开头的那段官方文档中有说到，在下面的分析中我们会看到的。</p> <p>先看看<code>ResourceCacheGenerator</code>中查找缓存时key的组成部分：</p> <p><strong>ResourceCacheGenerator.java</strong> </p> <div class=highlight><pre><span></span><code><span class=n>currentKey</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheKey</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span><span class=w></span>
<span class=w>        </span><span class=n>sourceId</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span><span class=w></span>
<span class=w>        </span><span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span><span class=w></span>
<span class=w>        </span><span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span><span class=w></span>
<span class=w>        </span><span class=n>transformation</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>resourceClass</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span><span class=w></span>
</code></pre></div> <figcaption>ResourceCacheGenerator中key的组成</figcaption> <table> <thead> <tr> <th>组成</th> <th>注释</th> </tr> </thead> <tbody> <tr> <td>helper.getArrayPool()</td> <td><code>GlideBuilder.build</code>时初始化，默认为<code>LruArrayPool</code>；<em>但不参与key的<code>equals</code>方法</em></td> </tr> <tr> <td>sourceId</td> <td>如果请求的是URL，那么此处会是一个<code>GlideUrl</code></td> </tr> <tr> <td>helper.getSignature()</td> <td><code>BaseRequestOptions</code>的成员变量，默认会是<code>EmptySignature.obtain()</code><br>在加载本地resource资源时会变成<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> <tr> <td>helper.getWidth()<br>helper.getHeight()</td> <td>如果没有指定<code>override(int size)</code>，那么将得到view的size</td> </tr> <tr> <td>transformation</td> <td>默认会根据<code>ImageView</code>的scaleType设置对应的<code>BitmapTransformation</code>；<br>如果指定了<code>transform</code>，那么就会是指定的值</td> </tr> <tr> <td>resourceClass</td> <td>可以被编码成的资源类型，比如<code>BitmapDrawable</code>等</td> </tr> <tr> <td>helper.getOptions()</td> <td>如果没有设置过<code>transform</code>，此处会根据ImageView的scaleType默认指定一个KV，详见上一文2.2节</td> </tr> </tbody> </table> <p>在<code>ResourceCacheKey</code>中，<code>arrayPool</code>并没有参与<code>equals</code>方法，所以判断两个<code>ResourceCacheKey</code>是否相等只需要其他7个参数。</p> <p>然后看看<code>DataCacheGenerator</code>中Key的组成部分：</p> <p><strong>DataCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=n>Key</span><span class=w> </span><span class=n>originalKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheKey</span><span class=p>(</span><span class=n>sourceId</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span><span class=w></span>
</code></pre></div> <figcaption>DataCacheGenerator中key的组成</figcaption> <table> <thead> <tr> <th>组成</th> <th>注释</th> </tr> </thead> <tbody> <tr> <td>sourceId</td> <td>如果请求的是URL，那么此处会是一个<code>GlideUrl</code></td> </tr> <tr> <td>helper.getSignature()</td> <td><code>BaseRequestOptions</code>的成员变量，默认会是<code>EmptySignature.obtain()</code><br>在加载本地resource资源时会变成<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> </tbody> </table> <p>在<code>DataCacheKey</code>中，仅有的两个变量都参与了<code>equals</code>方法。这两个变量就是上面<code>ResourceCacheKey</code>中的两个变量。 </p> <p>显然，data cache就是比较原始的数据构成的缓存，而resource cache是被解码、转换后的data cache，这就印证了文章开头的那段文档。 </p> <p>此外，文档中缓存篇还有很多内容，下面在上一份关于缓存Key的描述，这对应我们在上面列过表格的<code>EngineKey</code>、<code>ResourceCacheKey</code>以及<code>DataCacheKey</code>。</p> <blockquote> <p>In Glide 4, all cache keys contain at least two elements:<br> 1. The model the load is requested for (File, Uri, Url). If you are using a custom model, it needs to correctly implements hashCode() and equals() 2. An optional Signature </p> <p>In fact, the cache keys for steps 1-3 (Active resources, memory cache, resource disk cache) also include a number of other pieces of data including: 1. The width and height 2. The optional Transformation 3. Any added Options 4. The requested data type (Bitmap, GIF, etc)</p> <p>The keys used for active resources and the memory cache also differ slightly from those used from the resource disk cache to accomodate in memory Options like those that affect the configuration of the Bitmap or other decode time only parameters.<br> To generate the name of disk cache keys on disk, the individual elements of the keys are hashed to create a single String key, which is then used as the file name in the disk cache.<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#cache-keys>Cache Keys</a></cite> </p> </blockquote> <p>看完了，回到<code>ResourceCacheGenerator</code>中，这里会用<code>ResourceCacheKey</code>在磁盘缓存中进行查找。难道我们用<code>ResourceCacheKey</code>的<code>toString()</code>方法作为key吗？肯定不是，因为这样不够Safe，所以我们看看源码中的SafeKey是如何生成的。代码在<code>DiskLruCacheWrapper</code>中，将原始的Key转换为SafeKey是这个wrapper类的重要作用之一。</p> <p><strong>DiskLruCacheWrapper.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=n>File</span><span class=w> </span><span class=nf>get</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>String</span><span class=w> </span><span class=n>safeKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>safeKeyGenerator</span><span class=p>.</span><span class=na>getSafeKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=n>File</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// It is possible that the there will be a put in between these two gets. If so that shouldn&#39;t</span><span class=w></span>
<span class=w>    </span><span class=c1>// be a problem because we will always put the same value at the same key so our input streams</span><span class=w></span>
<span class=w>    </span><span class=c1>// will still represent the same data.</span><span class=w></span>
<span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Value</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>safeKey</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>.</span><span class=na>getFile</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>这里调用<code>SafeKeyGenerator</code>生成了一个String类型的SafeKey，实际上就是对原始key中每个字段都使用SHA-256加密，然后将得到的字节数组转换为16进制的字符串。<code>SafeKeyGenerator</code>的代码很简单，为了效率还是使用了缓存以及对象池👍👍👍。</p> <p><strong>SafeKeyGenerator.java</strong> </p> <div class=highlight><pre><span></span><code><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>SafeKeyGenerator</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=o>&gt;</span><span class=w> </span><span class=n>loadIdToSafeHash</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LruCache</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>Pools</span><span class=p>.</span><span class=na>Pool</span><span class=o>&lt;</span><span class=n>PoolableDigestContainer</span><span class=o>&gt;</span><span class=w> </span><span class=n>digestPool</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>FactoryPools</span><span class=p>.</span><span class=na>threadSafe</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>FactoryPools</span><span class=p>.</span><span class=na>Factory</span><span class=o>&lt;</span><span class=n>PoolableDigestContainer</span><span class=o>&gt;</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=nd>@Override</span><span class=w></span>
<span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=n>PoolableDigestContainer</span><span class=w> </span><span class=nf>create</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PoolableDigestContainer</span><span class=p>(</span><span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&quot;SHA-256&quot;</span><span class=p>));</span><span class=w></span>
<span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>NoSuchAlgorithmException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span><span class=w></span>
<span class=w>          </span><span class=p>}</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>
<span class=w>      </span><span class=p>});</span><span class=w></span>

<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getSafeKey</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>String</span><span class=w> </span><span class=n>safeKey</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>loadIdToSafeHash</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>safeKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>loadIdToSafeHash</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>safeKey</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>safeKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateHexStringDigest</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>loadIdToSafeHash</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>loadIdToSafeHash</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>safeKey</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>safeKey</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>calculateHexStringDigest</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>PoolableDigestContainer</span><span class=w> </span><span class=n>container</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>digestPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>key</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>container</span><span class=p>.</span><span class=na>messageDigest</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=c1>// calling digest() will automatically reset()</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>Util</span><span class=p>.</span><span class=na>sha256BytesToHex</span><span class=p>(</span><span class=n>container</span><span class=p>.</span><span class=na>messageDigest</span><span class=p>.</span><span class=na>digest</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>digestPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>container</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>PoolableDigestContainer</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>FactoryPools</span><span class=p>.</span><span class=na>Poolable</span><span class=w> </span><span class=p>{</span><span class=w></span>

<span class=w>    </span><span class=nd>@Synthetic</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>MessageDigest</span><span class=w> </span><span class=n>messageDigest</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>StateVerifier</span><span class=w> </span><span class=n>stateVerifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>StateVerifier</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span><span class=w></span>

<span class=w>    </span><span class=n>PoolableDigestContainer</span><span class=p>(</span><span class=n>MessageDigest</span><span class=w> </span><span class=n>messageDigest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>this</span><span class=p>.</span><span class=na>messageDigest</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>messageDigest</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=nd>@NonNull</span><span class=w></span>
<span class=w>    </span><span class=nd>@Override</span><span class=w></span>
<span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>StateVerifier</span><span class=w> </span><span class=nf>getVerifier</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>stateVerifier</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>可以看到，该类的主要功能落在了<code>calculateHexStringDigest</code>方法上，首先从对象池中获取一个消息摘要容器<code>PoolableDigestContainer</code>，然后调用<code>Key.updateDiskCacheKey(MessageDigest)</code>生成消息摘要，最后调用<code>Util.sha256BytesToHex</code>将将得到的字节数组转换为16进制的字符串。 </p> <p>这里我们看一下<code>ResourceCacheKey</code>的消息摘要生成过程，其中具体内容不展开了：</p> <p><strong>ResourceCacheKey.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateDiskCacheKey</span><span class=p>(</span><span class=nd>@NonNull</span><span class=w> </span><span class=n>MessageDigest</span><span class=w> </span><span class=n>messageDigest</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>dimensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arrayPool</span><span class=p>.</span><span class=na>getExact</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>dimensions</span><span class=p>).</span><span class=na>putInt</span><span class=p>(</span><span class=n>width</span><span class=p>).</span><span class=na>putInt</span><span class=p>(</span><span class=n>height</span><span class=p>).</span><span class=na>array</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>signature</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>sourceKey</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>messageDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>dimensions</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>transformation</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>transformation</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=n>options</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>messageDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>getResourceClassBytes</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=n>arrayPool</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>dimensions</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
</code></pre></div> <p>回想一下表格------<em>ResourceCacheGenerator中key的组成</em>，表格中的参与<code>equals</code>运算的7个部分都参与了消息摘要的生成。</p> <p>在进一步处理后，得到了以消息摘要的字符串作为key的SafeKey，并以此在Disk Cache中进行查询，并将查询结果以<code>Value</code>实体返回出来，最后从<code>Value</code>中获取对应文件，Disk Cache的get操作就是这么一个流程。</p> <p>回到<code>ResourceCacheGenerator</code>中，如果确实有缓存，那么会加载该缓存文件。在前文的分析中，我们知道对于URL来说，调用了<code>ByteBufferFetcher</code>进行缓存文件的加载，加载成功了返回了一个<code>ByteBuffer</code>，并调用了callback也就是<code>ResourceCacheGenerator</code>的<code>onDataReady</code>方法。然后<code>ResourceCacheGenerator</code>又会回调<code>DecodeJob</code>的<code>onDataFetcherReady</code>方法进行后续的解码操作。</p> <p><strong>ResourceCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=n>currentKey</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>这里先按下不表，因为后面<code>DataCacheGenerator</code>和<code>SourceGenerator</code>的成功回调都会到这里来。我们暂时只需要看一下上面回调方法的一些参数即可。</p> <p>如果<code>ResourceCacheGenerator</code>没有找到缓存，那么就会交给<code>DataCacheGenerator</code>了。该类大体流程和<code>ResourceCacheGenerator</code>一样，有点不同的是，<code>DataCacheGenerator</code>的构造器有两个构造器，其中的<code>DataCacheGenerator(List&lt;Key&gt;, DecodeHelper&lt;?&gt;, FetcherReadyCallback)</code>构造器是给<code>SourceGenerator</code>准备的。因为如果没有磁盘缓存，那么从源头加载后，肯定需要进行磁盘缓存操作的。所以，<code>SourceGenerator</code>会将加载后的资源保存到磁盘中，然后转交给<code>DataCacheGenerator</code>从磁盘中取出来。 </p> <p><strong>DataCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>DATA_DISK_CACHE</span><span class=p>,</span><span class=w> </span><span class=n>sourceKey</span><span class=p>);</span><span class=w></span>
</code></pre></div> <p>如果<code>DataCacheGenerator</code>没有取到缓存，那么会交给<code>SourceGenerator</code>从源头加载。加载的过程在上一篇文章中也说到过，我们直接略过。现在来到了成功回调<code>onDataReady()</code>方法：</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>DiskCacheStrategy</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>data</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>dataToCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span><span class=w></span>
<span class=w>    </span><span class=c1>// reschedule to get back onto Glide&#39;s thread.</span><span class=w></span>
<span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span><span class=w> </span><span class=n>originalKey</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>这里首先看会获取到的数据是否需要进行磁盘缓存：如果需要磁盘缓存，则经过<code>DecodeJob</code>、<code>EngineJob</code>的调度，重新调用<code>SourceGenerator.startNext</code>方法，进行磁盘缓存的写入，并转交给<code>DataCacheGenerator</code>完成后续的处理；否则就通知<code>DecodeJob</code>已经加载成功了。两个路径返回给<code>DecodeJob</code>的回调中，dataSource都是统一的，都是源头的dataSource。</p> <p>两种不同路径的回调如下：</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=c1>// 不需要磁盘缓存的路径</span><span class=w></span>
<span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(...)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span><span class=w> </span><span class=n>originalKey</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// 需要磁盘缓存的路径</span><span class=w></span>
<span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataFetcherReady</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>fetcher</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>attemptedKey</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=c1>// This data fetcher will be loading from a File and provide the wrong data source, so override</span><span class=w></span>
<span class=w>  </span><span class=c1>// with the data source of the original fetcher</span><span class=w></span>
<span class=w>  </span><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=w> </span><span class=n>fetcher</span><span class=p>,</span><span class=w> </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span><span class=w> </span><span class=n>sourceKey</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>磁盘缓存策略默认是<code>DiskCacheStrategy.AUTOMATIC</code>，其data资源缓存策略只缓存远程资源，也就是URL这种：</p> <p><strong>DiskCacheStrategy.AUTOMATIC</strong> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isDataCacheable</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div></p> <p>在加载的就是URL的情况下，我们看一下磁盘缓存写入过程的流程。<br> 首先经过<code>DecodeJob.reschedule()</code>进行线程的调整后，又开始了<code>startNext()</code>方法。由于dataToCache保存了获取的原始数据，所以会调用<code>cacheData</code>方法进行缓存。<code>cacheData</code>方法先构建了一个<code>DataCacheKey</code>将data写入了磁盘，然后new了一个<code>DataCacheGenerator</code>。回到<code>startNext()</code>方法，此时sourceCacheGenerator不为空，就调用其<code>startNext()</code>方法从热乎的磁盘缓存中进行加载，并返回了true让<code>DecodeJob</code>停止尝试。</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>DiskCacheStrategy</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>data</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>dataToCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span><span class=w></span>
<span class=w>    </span><span class=c1>// reschedule to get back onto Glide&#39;s thread.</span><span class=w></span>
<span class=w>    </span><span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>startNext</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataToCache</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Object</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dataToCache</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>dataToCache</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cacheData</span><span class=p>(</span><span class=n>Object</span><span class=w> </span><span class=n>dataToCache</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getSourceEncoder</span><span class=p>(</span><span class=n>dataToCache</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span><span class=w> </span><span class=n>writer</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span><span class=w> </span><span class=n>dataToCache</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=n>originalKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheKey</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span><span class=w> </span><span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span><span class=w> </span><span class=n>writer</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>sourceCacheGenerator</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>      </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>),</span><span class=w> </span><span class=n>helper</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>无论上面三个<code>DataFetcherGenerator</code>之间怎么折腾，现在终于成功加载到了数据。所有缓存的读缓存操作也已经完成，剩下的都是写缓存了。 </p> <p>结下来表表上面按下不表的内容，即<code>DecodeJob.onDataFetcherReady</code>方法。该方法完成两个事情：</p> <ol> <li>将比较原始的data数据转变为可以供ImageView显示的resource数据</li> <li>将resource数据显示出来</li> </ol> <p>这里面的每行代码的分析都在<a href=/android/3rd-library/glide2/#39-decodejobfetcherreadycallback>Glide2-3.9-DecodeJob.FetcherReadyCallback</a>中，这里只说一下涉及到缓存的位置。<br> 在过程1中，将原始data encode成resource数据后，会调用<code>DecodeJob.onResourceDecoded</code>对resource数据进行进一步的处理。<code>DecodeJob.onResourceDecoded</code>首先会对resource进行transform，然后可能会进行磁盘缓存。</p> <p><strong>DecodeJob.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span><span class=w></span>
<span class=nd>@NonNull</span><span class=w></span>
<span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=nf>onResourceDecoded</span><span class=p>(</span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=nd>@NonNull</span><span class=w> </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>decoded</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>resourceSubClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>decoded</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>appliedTransformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>transformed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decoded</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>dataSource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>appliedTransformation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceSubClass</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>transformed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>appliedTransformation</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>glideContext</span><span class=p>,</span><span class=w> </span><span class=n>decoded</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=c1>// TODO: Make this the responsibility of the Transformation.</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>decoded</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>decoded</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=n>EncodeStrategy</span><span class=w> </span><span class=n>encodeStrategy</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>encoder</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isResourceEncoderAvailable</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getResultEncoder</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>encodeStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>encoder</span><span class=p>.</span><span class=na>getEncodeStrategy</span><span class=p>(</span><span class=n>options</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>encodeStrategy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>transformed</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=n>isFromAlternateCacheKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>!</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isSourceKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>);</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isResourceCacheable</span><span class=p>(</span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w></span>
<span class=w>      </span><span class=n>encodeStrategy</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>encoder</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Registry</span><span class=p>.</span><span class=na>NoResultEncoderAvailableException</span><span class=p>(</span><span class=n>transformed</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>());</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>encodeStrategy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>SOURCE</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>,</span><span class=w> </span><span class=n>signature</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>      </span><span class=k>case</span><span class=w> </span><span class=n>TRANSFORMED</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w></span>
<span class=w>            </span><span class=k>new</span><span class=w> </span><span class=n>ResourceCacheKey</span><span class=p>(</span><span class=w></span>
<span class=w>                </span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span><span class=w></span>
<span class=w>                </span><span class=n>currentSourceKey</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>signature</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>width</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>height</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>appliedTransformation</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>resourceSubClass</span><span class=p>,</span><span class=w></span>
<span class=w>                </span><span class=n>options</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<span class=w>      </span><span class=k>default</span><span class=p>:</span><span class=w></span>
<span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unknown strategy: &quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encodeStrategy</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockedResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>encoder</span><span class=p>,</span><span class=w> </span><span class=n>lockedResult</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lockedResult</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=k>return</span><span class=w> </span><span class=n>result</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>从上面的源码中可以看到，当<code>dataSource != DataSource.RESOURCE_DISK_CACHE</code>时会进行transform。哦～，这是因为resource cache肯定已经经历过transform了，所以就不用重新来一遍了。 </p> <p>然后是此过程中的磁盘缓存过程，影响的因素有<code>encodeStrategy</code>、<code>DiskCacheStrategy.isResourceCacheable</code>：</p> <ol> <li>encodeStrategy<br> 根据resource数据的类型来判断，如果是<code>Bitmap</code>或<code>BitmapDrawable</code>，那么就是<code>TRANSFORMED</code>；<br> 如果是<code>GifDrawable</code>，那么就是<code>SOURCE</code>。<br> 详细请看<code>BitmapEncoder</code>、<code>BitmapDrawableEncoder</code>和<code>GifDrawableEncoder</code>类</li> <li>DiskCacheStrategy.isResourceCacheable<br> <code>isFromAlternateCacheKey</code>搜了一遍源码，只有一个没有使用过的类<code>BaseGlideUrlLoader</code>中发现了痕迹，还是一个空集合实现，没有其他任何位置在使用，所以此处可以简单理解的该参数一直为false。<br> 也就是说，只有dataSource为<code>DataSource.LOCAL</code>且encodeStrategy为<code>EncodeStrategy.TRANSFORMED</code>时，才允许缓存。换句话说，只有本地的resource数据为<code>Bitmap</code>或<code>BitmapDrawable</code>的资源才可以缓存。 <div class=highlight><pre><span></span><code><span class=w> </span><span class=nd>@Override</span><span class=w></span>
<span class=w> </span><span class=kd>public</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>isResourceCacheable</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>,</span><span class=w></span>
<span class=w>     </span><span class=n>EncodeStrategy</span><span class=w> </span><span class=n>encodeStrategy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>   </span><span class=k>return</span><span class=w> </span><span class=p>((</span><span class=n>isFromAlternateCacheKey</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>DATA_DISK_CACHE</span><span class=p>)</span><span class=w></span>
<span class=w>       </span><span class=o>||</span><span class=w> </span><span class=n>dataSource</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>DataSource</span><span class=p>.</span><span class=na>LOCAL</span><span class=p>)</span><span class=w></span>
<span class=w>       </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>encodeStrategy</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>TRANSFORMED</span><span class=p>;</span><span class=w></span>
<span class=w> </span><span class=p>}</span><span class=w></span>
</code></pre></div></li> </ol> <p>最后，如果可以缓存，会初始化一个<code>deferredEncodeManager</code>，在展示resource资源后会调用此对象进行磁盘缓存的写入。写入的代码如下：</p> <div class=highlight><pre><span></span><code><span class=c1>// DecodeJob.java</span><span class=w></span>
<span class=c1>//</span><span class=w></span>
<span class=c1>// deferredEncodeManager.init(key, encoder, LockedResource.obtain(transformed));</span><span class=w></span>
<span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>DataSource</span><span class=w> </span><span class=n>dataSource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Initializable</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>((</span><span class=n>Initializable</span><span class=p>)</span><span class=w> </span><span class=n>resource</span><span class=p>).</span><span class=na>initialize</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resource</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=w> </span><span class=n>lockedResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>lockedResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lockedResource</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>notifyComplete</span><span class=p>(</span><span class=n>result</span><span class=p>,</span><span class=w> </span><span class=n>dataSource</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=n>stage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>lockedResource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>lockedResource</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process</span><span class=w></span>
<span class=w>  </span><span class=c1>// throws.</span><span class=w></span>
<span class=w>  </span><span class=n>onEncodeComplete</span><span class=p>();</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=c1>// DecodeJob#DeferredEncodeManager</span><span class=w></span>
<span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>DeferredEncodeManager</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>encoder</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=w> </span><span class=n>toEncode</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=nd>@Synthetic</span><span class=w></span>
<span class=w>  </span><span class=n>DeferredEncodeManager</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=c1>// We just need the encoder and resource type to match, which this will enforce.</span><span class=w></span>
<span class=w>  </span><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span><span class=w></span>
<span class=w>  </span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>(</span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span><span class=w> </span><span class=n>encoder</span><span class=p>,</span><span class=w> </span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span><span class=w> </span><span class=n>toEncode</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>encoder</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>toEncode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>toEncode</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>encode</span><span class=p>(</span><span class=n>DiskCacheProvider</span><span class=w> </span><span class=n>diskCacheProvider</span><span class=p>,</span><span class=w> </span><span class=n>Options</span><span class=w> </span><span class=n>options</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=s>&quot;DecodeJob.encode&quot;</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>diskCacheProvider</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w></span>
<span class=w>          </span><span class=k>new</span><span class=w> </span><span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span><span class=w> </span><span class=n>toEncode</span><span class=p>,</span><span class=w> </span><span class=n>options</span><span class=p>));</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>toEncode</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span><span class=w></span>
<span class=w>      </span><span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kt>boolean</span><span class=w> </span><span class=nf>hasResourceToEncode</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>toEncode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=nf>clear</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>encoder</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>toEncode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p><code>DiskLruCacheWrapper</code>在写入的时候会使用到写锁<code>DiskCacheWriteLocker</code>，锁对象由对象池创建（Glide中对象池和缓存真的是无所不在👍👍👍），写锁<code>WriteLock</code>实现是一个重入锁<code>ReentrantLock</code>，该锁默认是一个不公平锁。<br> 在缓存写入前，会判断key对应的value存不存在，若存在则放弃写入。缓存的真正写入会由<code>DataCacheWriter</code>交给<code>ByteBufferEncoder</code>和<code>StreamEncoder</code>两个具体类来写入，前者负责将ByteBuffer写入到文件，后者负责将InputStream写入到文件。</p> <p>至此，磁盘缓存的读写都已经完毕，剩下的就是内存缓存的两个层次了。我们回到<code>DecodeJob.notifyEncodeAndRelease</code>方法中，经过<code>notifyComplete</code>、<code>EngineJob.onResourceReady</code>、<code>notifyCallbacksOfResult</code>方法中。<br> 在该方法中一方面会将原始的resource包装成一个<code>EngineResource</code>，然后通过回调传给<code>Engine.onEngineJobComplete</code>，在这里会将资源保持在active resource中：</p> <p><strong>Engine.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Override</span><span class=w></span>
<span class=kd>public</span><span class=w> </span><span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onEngineJobComplete</span><span class=p>(</span><span class=w></span>
<span class=w>    </span><span class=n>EngineJob</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>engineJob</span><span class=p>,</span><span class=w> </span><span class=n>Key</span><span class=w> </span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>resource</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=c1>// A null resource indicates that the load failed, usually due to an exception.</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>resource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>resource</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>jobs</span><span class=p>.</span><span class=na>removeIfCurrent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=w> </span><span class=n>engineJob</span><span class=p>);</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>另一方面会使用<code>Executors.mainThreadExecutor()</code>调用<code>SingleRequest.onResourceReady</code>回调进行资源的显示。<br> 在触发回调前后各有一个地方会对<code>engineResource</code>进行<code>acquire()</code>和<code>release()</code>操作。该过程发生在<code>notifyCallbacksOfResult()</code>方法的<code>incrementPendingCallbacks</code>、<code>decrementPendingCallbacks()</code>调用中。这一顿操作下来，engineResource的引用计数应该是1：</p> <p><strong>EngineJob.java</strong></p> <div class=highlight><pre><span></span><code><span class=nd>@Synthetic</span><span class=w></span>
<span class=kt>void</span><span class=w> </span><span class=nf>notifyCallbacksOfResult</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=n>ResourceCallbacksAndExecutors</span><span class=w> </span><span class=n>copy</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=n>Key</span><span class=w> </span><span class=n>localKey</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=n>EngineResource</span><span class=o>&lt;?&gt;</span><span class=w> </span><span class=n>localResource</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=p>...</span><span class=w></span>
<span class=w>    </span><span class=n>engineResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>engineResourceFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span><span class=w> </span><span class=n>isCacheable</span><span class=p>);</span><span class=w></span>
<span class=w>    </span><span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the</span><span class=w></span>
<span class=w>    </span><span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under</span><span class=w></span>
<span class=w>    </span><span class=c1>// a lock here so that any newly added callback that executes before the next locked section</span><span class=w></span>
<span class=w>    </span><span class=c1>// below can&#39;t recycle the resource before we call the callbacks.</span><span class=w></span>
<span class=w>    </span><span class=n>hasResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>copy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cbs</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=n>incrementPendingCallbacks</span><span class=p>(</span><span class=n>copy</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w></span>

<span class=w>    </span><span class=n>localKey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>key</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=n>localResource</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>engineResource</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=n>listener</span><span class=p>.</span><span class=na>onEngineJobComplete</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>localKey</span><span class=p>,</span><span class=w> </span><span class=n>localResource</span><span class=p>);</span><span class=w></span>

<span class=w>  </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>ResourceCallbackAndExecutor</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>copy</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>entry</span><span class=p>.</span><span class=na>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>CallResourceReady</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>cb</span><span class=p>));</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=n>decrementPendingCallbacks</span><span class=p>();</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>incrementPendingCallbacks</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pendingCallbacks</span><span class=p>.</span><span class=na>getAndAdd</span><span class=p>(</span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>engineResource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>synchronized</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>decrementPendingCallbacks</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>  </span><span class=p>...</span><span class=w></span>
<span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=n>decremented</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pendingCallbacks</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>decremented</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>engineResource</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=n>engineResource</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=n>release</span><span class=p>();</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=kd>private</span><span class=w> </span><span class=kd>class</span> <span class=nc>CallResourceReady</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=p>{</span><span class=w></span>

<span class=w>  </span><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>ResourceCallback</span><span class=w> </span><span class=n>cb</span><span class=p>;</span><span class=w></span>

<span class=w>  </span><span class=n>CallResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span><span class=w> </span><span class=n>cb</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=k>this</span><span class=p>.</span><span class=na>cb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>cb</span><span class=p>;</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>

<span class=w>  </span><span class=nd>@Override</span><span class=w></span>
<span class=w>  </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>EngineJob</span><span class=p>.</span><span class=na>this</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>cb</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=c1>// Acquire for this particular callback.</span><span class=w></span>
<span class=w>        </span><span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span><span class=w></span>
<span class=w>        </span><span class=n>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span><span class=w></span>
<span class=w>        </span><span class=n>removeCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span><span class=w></span>
<span class=w>      </span><span class=p>}</span><span class=w></span>
<span class=w>      </span><span class=n>decrementPendingCallbacks</span><span class=p>();</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=w>  </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>engineResource的引用计数会在<code>RequestManager.onDestory</code>方法中经过<code>clear</code>、<code>untrackOrDelegate</code>、<code>untrack</code>、<code>RequestTracker.clearRemoveAndRecycle</code>、<code>clearRemoveAndMaybeRecycle</code>方法，调用<code>SingleRequest.clear()</code>方法经过<code>releaseResource()</code>、<code>Engine.release</code>，进行释放。这样引用计数就为0了。</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Tips: 可以在打断点的时候在<code>Evaluate Expression</code>功能中调用<code>Log.x(String, String, Throwable)</code>方法打印出调用栈</p> </div> <p>前面在看<code>EngineResource</code>的代码时我们知道，一旦引用计数为0，就会通知<code>Engine</code>将此资源从active状态变成memory cache状态。如果我们再次加载资源时可以从memory cache中加载，那么资源又会从memory cache状态变成active状态。</p> <p>也就是说，在资源第一次显示后，我们关闭页面，资源会由active变成memory cache；然后我们再次进入页面，加载时会命中memory cache，从而又变成active状态。</p> <p>本章Glide缓存机制的源码内容到此为止了，现在看看文章最开始的流程图，是不是有一点点熟悉的味道。</p> <p>最后，摘抄一下Glide官方文档对于缓存更新的说明：</p> <blockquote> <p>Because disk cache are hashed keys, there is no good way to simply delete all of the cached files on disk that correspond to a particular url or file path. The problem would be simpler if you were only ever allowed to load or cache the original image, but since Glide also caches thumbnails and provides various transformations, each of which will result in a new File in the cache, tracking down and deleting every cached version of an image is difficult. </p> <p>In practice, the best way to invalidate a cache file is to change your identifier when the content changes (url, uri, file path etc) when possible. </p> <p>Since it’s often difficult or impossible to change identifiers, Glide also offers the <code>signature()</code> API to mix in additional data that you control into your cache key. Signatures work well for media store content, as well as any content you can maintain some versioning metadata for.<br> - Media store content - For media store content, you can use Glide’s <code>MediaStoreSignature</code> class as your signature. MediaStoreSignature allows you to mix the date modified time, mime type, and orientation of a media store item into the cache key. These three attributes reliably catch edits and updates allowing you to cache media store thumbs. - Files - You can use <code>ObjectKey</code> to mix in the File’s date modified time. - Urls - Although the best way to invalidate urls is to make sure the server changes the url and updates the client when the content at the url changes, you can also use <code>ObjectKey</code> to mix in arbitrary metadata (such as a version number) instead. </p> <p>If all else fails and you can neither change your identifier nor keep track of any reasonable version metadata, you can also disable disk caching entirely using <code>diskCacheStrategy()</code> and <code>DiskCacheStrategy.NONE</code>.<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#cache-invalidation>Cache Invalidation</a></cite></p> </blockquote> <hr> <div class=md-source-file> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">July 20, 2022</span> </small> </div> <!-- Giscus --> <h2 id=__comments>评论</h2> <!-- Replace with generated snippet --> <script src=https://giscus.app/client.js data-repo=YorekLiu/yorekliu.github.io data-repo-id="MDEwOlJlcG9zaXRvcnkxMTQwNzYzODQ=" data-category=Announcements data-category-id=DIC_kwDOBsyq4M4CP9fq data-mapping=title data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Synchronize Giscus theme with palette --> <script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> </article> </div> </div> <a href=# class="md-top md-top--hidden md-icon" data-md-component=top> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../glide2/ class="md-footer__link md-footer__link--prev" aria-label="上一页: Glide v4 源码解析（二）" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> Glide v4 源码解析（二） </div> </div> </a> <a href=../glide4/ class="md-footer__link md-footer__link--next" aria-label="下一页: Glide v4 源码解析（四）" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> Glide v4 源码解析（四） </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> &copy; 2022 Yorek </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/YorekLiu target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.tabs", "navigation.instant", "navigation.top", "navigation.tracking", "navigation.expand", "search.suggest", "search.highlight", "search.share"], "search": "../../../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../../../assets/javascripts/bundle.7f366e99.min.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> </body> </html>